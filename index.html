<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SB 1123 Deal Finder — LA County</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js" onerror="console.warn('esri-leaflet failed to load')"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
// Mobile: skip 25MB comps file, load only listings (already has pre-computed $/SF)
// Desktop: load both
var _isMob = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
if(!_isMob){
  document.write('<script src="data.js?v=4"><\/script>');
}
document.write('<script src="listings.js?v=4"><\/script>');
window.LOADED_COMPS = window.LOADED_COMPS || [];
window.LOADED_LISTINGS = window.LOADED_LISTINGS || [];
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,500;9..40,700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --r1:#2563eb;--r2:#16a34a;--r3:#ea580c;--r4:#9333ea;--land:#b45309;
    --listing:#f43f5e;
    --bg:#0f1117;--surface:#1a1d27;--surface2:#252833;
    --border:#2e3140;--text:#e4e6ed;--text-dim:#8b8fa3;--accent:#60a5fa;
    --green:#22c55e;--red:#ef4444;--yellow:#facc15;--orange:#f97316;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
  body.light-mode{
    --bg:#f5f5f5;--surface:#ffffff;--surface2:#e8e8e8;
    --border:#d0d0d0;--text:#1a1a2e;--text-dim:#666;--accent:#2563eb;
  }
  .mono{font-family:'JetBrains Mono',monospace}

  .app-row{display:flex;flex:1;overflow:hidden}

  /* ── Sidebar ── */
  .sidebar{width:360px;min-width:360px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:1000;overflow-y:auto}
  .sidebar-header{padding:20px 20px 14px;border-bottom:1px solid var(--border)}
  .sidebar-header h1{font-size:17px;font-weight:700;letter-spacing:-0.02em;margin-bottom:2px}
  .sidebar-header h1 span{color:var(--green)}
  .sidebar-header p{font-size:11px;color:var(--text-dim);line-height:1.5}
  .sidebar-header .law-ref{font-size:10px;color:var(--accent);margin-top:4px;opacity:0.7}

  .section{padding:14px 20px;border-bottom:1px solid var(--border)}
  .section-title{font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:6px}
  .section-title .badge{background:var(--green);color:#000;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700;letter-spacing:0.03em}

  /* Stats grid */
  .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .stats-grid.two-col{grid-template-columns:1fr 1fr}
  .stat-card{background:var(--surface2);border-radius:8px;padding:10px 12px}
  .stat-card .stat-value{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;color:var(--accent)}
  .stat-card .stat-value.green{color:var(--green)}
  .stat-card .stat-value.yellow{color:var(--yellow)}
  .stat-card .stat-value.red{color:var(--red)}
  .stat-card .stat-label{font-size:10px;color:var(--text-dim);margin-top:2px}

  /* SB9 mode toggle */
  .mode-toggle{
    display:flex;align-items:center;gap:10px;padding:10px 14px;
    border-radius:8px;cursor:pointer;transition:all 0.2s;
    border:1px solid var(--border);background:transparent;width:100%;
    font-family:inherit;font-size:13px;color:var(--text);
  }
  .mode-toggle:hover{border-color:var(--green);background:rgba(34,197,94,0.04)}
  .mode-toggle.active{border-color:var(--green);background:rgba(34,197,94,0.08)}
  .mode-toggle .toggle-track{
    width:36px;height:20px;border-radius:10px;background:var(--surface2);
    border:1px solid var(--border);position:relative;transition:all 0.2s;flex-shrink:0;
  }
  .mode-toggle.active .toggle-track{background:var(--green);border-color:var(--green)}
  .mode-toggle .toggle-thumb{
    width:16px;height:16px;border-radius:50%;background:#fff;
    position:absolute;top:1px;left:1px;transition:all 0.2s;
  }
  .mode-toggle.active .toggle-thumb{left:17px}
  .mode-toggle .toggle-label{flex:1}
  .mode-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Zone toggles */
  .zone-toggle{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background 0.15s;margin-bottom:2px}
  .zone-toggle:hover{background:var(--surface2)}
  .zone-swatch{width:12px;height:12px;border-radius:3px;flex-shrink:0}
  .zone-toggle input[type="checkbox"]{display:none}
  .zone-toggle .check-box{width:16px;height:16px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
  .zone-toggle input:checked+.check-box{border-color:var(--accent);background:var(--accent)}
  .zone-toggle input:checked+.check-box::after{content:'✓';color:#fff;font-size:10px;font-weight:700}
  .zone-label{font-size:12px;flex:1}
  .zone-label small{color:var(--text-dim);font-size:10px}
  .zone-stat{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim)}
  .data-count{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);background:rgba(96,165,250,0.1);padding:1px 5px;border-radius:3px;margin-left:3px}

  /* Basemap toggle */
  .basemap-group{display:flex;gap:4px}
  .basemap-btn{flex:1;padding:6px 0;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:11px;font-weight:500;transition:all 0.15s}
  .basemap-btn:hover{border-color:var(--accent)}
  .basemap-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.15);color:var(--accent)}

  /* Layer buttons */
  .layer-btn{display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:12px;margin-bottom:4px;transition:all 0.15s}
  .layer-btn:hover{border-color:var(--accent)}
  .layer-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.08)}
  .layer-btn .icon{font-size:14px}
  .layer-btn .layer-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);margin-left:auto}

  /* Range filters */
  .range-filter{margin-top:2px}
  .range-inputs{display:flex;gap:6px;align-items:center;margin-bottom:8px}
  .range-inputs input[type="number"]{
    width:100%;padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;
    outline:none;transition:border 0.15s;
  }
  .range-inputs input[type="number"]:focus{border-color:var(--accent)}
  .range-inputs .separator{color:var(--text-dim);font-size:12px;flex-shrink:0}
  .range-inputs .input-group{flex:1}
  .range-inputs .input-label{font-size:9px;color:var(--text-dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.08em}

  .range-slider-track{position:relative;height:5px;background:var(--surface2);border-radius:3px;margin:0 4px 10px}
  .range-slider-fill{position:absolute;height:100%;background:var(--accent);border-radius:3px;opacity:0.4}
  .range-slider-track input[type="range"]{
    position:absolute;width:100%;height:5px;top:-4px;
    -webkit-appearance:none;appearance:none;background:transparent;pointer-events:none;
  }
  .range-slider-track input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
    background:var(--accent);border:2px solid var(--bg);cursor:pointer;pointer-events:auto;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }

  .filter-count{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);text-align:center;padding:6px 0;background:rgba(96,165,250,0.06);border-radius:6px}
  .reset-btn{
    display:block;width:100%;padding:6px;margin-top:6px;background:transparent;
    border:1px solid var(--border);border-radius:6px;color:var(--text-dim);
    font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;text-align:center;
  }
  .reset-btn:hover{border-color:var(--accent);color:var(--accent)}

  /* Pro forma assumptions */
  .proforma-inputs{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .proforma-group{display:flex;flex-direction:column;gap:2px}
  .proforma-group label{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em}
  .proforma-group input{
    padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;
    outline:none;width:100%;
  }
  .proforma-group input:focus{border-color:var(--accent)}

  /* Quick presets */
  .preset-row{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
  .preset-btn{
    padding:4px 10px;border:1px solid var(--border);border-radius:4px;
    background:transparent;color:var(--text-dim);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;
  }
  .preset-btn:hover{border-color:var(--green);color:var(--green)}
  .preset-btn.active{border-color:var(--green);background:rgba(34,197,94,0.1);color:var(--green)}

  /* Map */
  #map{flex:1;height:100%;z-index:1}

  /* Popups */
  .leaflet-popup-content-wrapper{background:var(--surface)!important;color:var(--text)!important;border-radius:10px!important;border:1px solid var(--border)!important;box-shadow:0 8px 32px rgba(0,0,0,0.5)!important}
  .leaflet-popup-tip{background:var(--surface)!important}
  .leaflet-popup-content{font-family:'DM Sans',sans-serif!important;margin:14px 16px!important;min-width:280px}
  .popup-title{font-weight:700;font-size:14px;margin-bottom:8px;line-height:1.3}
  .popup-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;margin-right:4px}
  .popup-badge.comp{background:rgba(96,165,250,0.15);color:var(--accent)}
  .popup-badge.listing{background:rgba(244,63,94,0.15);color:var(--listing)}
  .popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px 14px}
  .popup-label{font-size:10px;color:var(--text-dim)}
  .popup-value{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600}
  .popup-divider{grid-column:1/-1;border-top:1px solid var(--border);margin:4px 0}
  .popup-section-label{grid-column:1/-1;font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);font-weight:700;margin-top:2px}
  .popup-profit-positive{color:var(--green)}
  .popup-profit-negative{color:var(--red)}

  /* Legend */
  .map-legend{position:absolute;bottom:30px;right:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;z-index:800;font-size:11px;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
  .legend-item{display:flex;align-items:center;gap:8px;margin-bottom:3px}
  .legend-item:last-child{margin-bottom:0}
  .legend-dot{width:10px;height:10px;border-radius:2px}
  .legend-section{font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);margin:6px 0 3px;font-weight:700}

  .sidebar::-webkit-scrollbar{width:6px}
  .sidebar::-webkit-scrollbar-track{background:transparent}
  .sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .loading-banner{padding:10px 20px;background:rgba(96,165,250,0.1);border-bottom:1px solid var(--border);font-size:12px;color:var(--accent);text-align:center;display:none}
  .loading-banner.active{display:block}

  /* ── Listings Table Panel ── */
  .listings-panel{
    position:relative;height:0;min-height:0;background:var(--surface);
    border-top:1px solid var(--border);transition:height 0.3s ease, min-height 0.3s ease;
    overflow:hidden;z-index:900;
  }
  .listings-panel.open{height:360px;min-height:200px}
  .listings-panel-header{
    display:flex;align-items:center;gap:10px;padding:8px 20px;
    border-bottom:1px solid var(--border);background:var(--surface);
    position:sticky;top:0;z-index:2;
  }
  .listings-panel-header h2{font-size:13px;font-weight:700;letter-spacing:-0.01em}
  .listings-panel-header h2 span{color:var(--green)}
  .listings-panel-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);background:rgba(96,165,250,0.1);padding:2px 6px;border-radius:4px}
  .listings-panel-close{margin-left:auto;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:4px 8px;border-radius:4px;transition:all 0.15s}
  .listings-panel-close:hover{color:var(--text);background:var(--surface2)}
  .listings-panel-resize{position:absolute;top:0;left:0;right:0;height:5px;cursor:ns-resize;z-index:3}
  .listings-panel-resize:hover{background:var(--accent);opacity:0.3}
  .listings-table-wrap{overflow:auto;height:calc(100% - 41px)}
  .listings-table-wrap::-webkit-scrollbar{width:6px;height:6px}
  .listings-table-wrap::-webkit-scrollbar-track{background:transparent}
  .listings-table-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .listings-table{width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed;min-width:1300px}
  .listings-table thead{position:sticky;top:0;z-index:1}
  .listings-table th{
    background:var(--surface2);padding:7px 10px;text-align:left;font-size:9px;
    text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-weight:700;
    cursor:pointer;white-space:nowrap;border-bottom:1px solid var(--border);
    user-select:none;transition:color 0.15s;position:relative;
  }
  .listings-table th:hover{color:var(--accent)}
  .listings-table th.sorted{color:var(--accent)}
  .listings-table th .sort-arrow{display:inline-block;margin-left:3px;font-size:8px;opacity:0;transition:opacity 0.15s}
  .listings-table th.sorted .sort-arrow{opacity:1}
  .listings-table th:hover .sort-arrow{opacity:0.5}
  .listings-table td{padding:6px 10px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .listings-table tr{transition:background 0.1s}
  .listings-table tbody tr:hover{background:var(--surface2);cursor:pointer}

  .listings-table .col-addr{width:230px}
  .listings-table .col-zone{width:50px}
  .listings-table .col-price{width:95px}
  .listings-table .col-lot{width:75px}
  .listings-table .col-units{width:55px}
  .listings-table .col-hood{width:80px}
  .listings-table .col-sale{width:90px}
  .listings-table .col-ppu{width:90px}
  .listings-table .col-profit{width:90px}
  .listings-table .col-margin{width:65px}
  .listings-table .col-slope{width:60px}
  .listings-table .col-dom{width:45px}
  .listings-table .col-link{width:45px}

  .listings-table .zone-pill{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:0.03em}
  .listings-table .redfin-link{color:var(--accent);text-decoration:none;font-size:10px}
  .listings-table .redfin-link:hover{text-decoration:underline}
  .listings-table .profit-pos{color:var(--green)}
  .listings-table .profit-neg{color:var(--red)}

  /* Panel toggle in sidebar */
  .panel-toggle{
    display:flex;align-items:center;justify-content:space-between;width:100%;
    padding:10px 12px;border:1px solid var(--green);border-radius:8px;
    background:rgba(34,197,94,0.06);color:var(--text);cursor:pointer;
    font-family:inherit;font-size:13px;transition:all 0.15s;
  }
  .panel-toggle:hover{background:rgba(34,197,94,0.12)}
  .panel-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Collapsible sections */
  .section.collapsed .section-content{display:none}
  .section-title{cursor:pointer}
  .section-title .chevron{transition:transform 0.2s;font-size:10px;margin-left:auto;color:var(--text-dim)}
  .section.collapsed .section-title .chevron{transform:rotate(-90deg)}

  /* Export button */
  .export-btn{
    display:block;width:100%;padding:8px;margin-top:6px;
    background:rgba(96,165,250,0.1);border:1px solid var(--accent);border-radius:6px;
    color:var(--accent);font-family:inherit;font-size:11px;cursor:pointer;
    transition:all 0.15s;text-align:center;
  }
  .export-btn:hover{background:rgba(96,165,250,0.2)}
  .refresh-btn{
    padding:4px 10px;background:rgba(34,197,94,0.1);border:1px solid var(--green);
    border-radius:4px;color:var(--green);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;white-space:nowrap;
  }
  .refresh-btn:hover{background:rgba(34,197,94,0.2)}

  /* Favorites */
  .listings-table .col-fav{width:32px;text-align:center;cursor:pointer}
  .fav-star{font-size:14px;cursor:pointer;opacity:0.3;transition:all 0.15s;user-select:none}
  .fav-star:hover{opacity:0.7;transform:scale(1.2)}
  .fav-star.active{opacity:1;color:#facc15}
  .fav-toggle{
    display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;
    background:var(--surface2);border:1px solid var(--border);border-radius:6px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .fav-toggle:hover{border-color:var(--accent)}
  .fav-toggle.active{border-color:#facc15;background:rgba(250,204,21,0.08)}
  .fav-toggle .fav-count{margin-left:auto;font-family:'JetBrains Mono',monospace;color:#facc15;font-size:10px}
  .popup-notes{width:100%;margin-top:8px;padding:6px 8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:11px;resize:vertical;min-height:40px;max-height:100px}
  .popup-notes::placeholder{color:var(--text-dim)}
  .popup-fav-btn{
    display:inline-flex;align-items:center;gap:4px;padding:4px 10px;margin-top:6px;
    background:var(--surface2);border:1px solid var(--border);border-radius:4px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .popup-fav-btn:hover{border-color:#facc15}
  .popup-fav-btn.active{border-color:#facc15;background:rgba(250,204,21,0.1);color:#facc15}
  .comp-psf-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:#e2e8f0;text-shadow:0 0 3px rgba(0,0,0,0.9),0 0 6px rgba(0,0,0,0.7);white-space:nowrap;text-align:center;pointer-events:none}

  /* ── Mobile: Bottom Sheet + Cards ── */
  @media (max-width: 768px) {
    html, body { height: 100vh; height: 100dvh; overflow-x: hidden; max-width: 100vw; }
    .app-row { position: relative; max-width: 100vw; overflow-x: hidden; }
    #map { width: 100% !important; }

    /* Sidebar → Bottom sheet */
    .sidebar {
      position: fixed !important; bottom: 0; left: 0; right: 0;
      width: 100% !important; min-width: 0 !important;
      height: 56px; max-height: 85vh;
      border-right: none !important; border-top: 1px solid var(--border);
      border-radius: 16px 16px 0 0;
      z-index: 1100; transition: height 0.3s ease;
      overflow: hidden;
    }
    .sidebar.sheet-half { height: 40vh; overflow-y: auto; }
    .sidebar.sheet-full { height: 85vh; overflow-y: auto; }

    /* Sheet handle */
    .sheet-handle {
      display: flex; flex-direction: column; align-items: center;
      padding: 10px 16px 6px; cursor: grab;
      position: sticky; top: 0; z-index: 10; background: var(--surface);
      border-radius: 16px 16px 0 0;
    }
    .sheet-handle .handle-bar {
      width: 40px; height: 4px; background: var(--text-dim); border-radius: 2px;
      margin-bottom: 8px; opacity: 0.5;
    }
    .sheet-handle .peek-stats {
      display: flex; gap: 16px; font-size: 13px; font-weight: 500;
      width: 100%; justify-content: center;
    }
    .sheet-handle .peek-stats .peek-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--green);
    }

    /* Floating filter button */
    .mobile-filter-btn {
      display: flex !important; position: fixed; top: 12px; left: 12px; z-index: 1050;
      padding: 10px 16px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-family: inherit; font-size: 13px;
      font-weight: 600; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      align-items: center; gap: 8px;
    }

    .sidebar-header .refresh-btn { display: none; }

    /* Stats grid: 2 columns */
    .stats-grid { grid-template-columns: 1fr 1fr; }

    /* Pro forma: 1 column */
    .proforma-inputs { grid-template-columns: 1fr; }

    /* Range slider: bigger touch targets */
    .range-slider-track input[type="range"]::-webkit-slider-thumb {
      width: 24px; height: 24px;
    }
    .range-slider-track input[type="range"] { height: 24px; top: -12px; }

    /* Buttons: min 44px touch target */
    .mode-toggle, .layer-btn, .panel-toggle, .fav-toggle,
    .reset-btn, .export-btn { min-height: 44px; }
    .preset-btn, .basemap-btn { min-height: 40px; }

    /* Legend: hide on mobile */
    .map-legend { display: none; }

    /* Popup: mobile-friendly */
    .leaflet-popup-content { min-width: unset !important; }
    .leaflet-popup-content-wrapper {
      max-height: 50vh; overflow-y: auto !important;
      max-width: calc(100vw - 40px) !important;
    }

    /* Listings panel: full-screen overlay */
    .listings-panel {
      position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
      height: 0; min-height: 0; z-index: 1200; border-top: none;
      max-width: 100vw; overflow-x: hidden;
    }
    .listings-panel.open { height: 100% !important; min-height: 100% !important; }
    .listings-panel-resize { display: none; }
    .listings-panel-close {
      font-size: 24px; min-width: 44px; min-height: 44px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Hide desktop table, show mobile cards */
    .listings-table-wrap { display: none; }
    .mobile-cards {
      display: block; padding: 10px 6px; overflow-y: auto; overflow-x: hidden;
      height: calc(100% - 45px); -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }

    /* Mobile card styling */
    .mobile-card {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 10px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.15s;
      min-width: 0; overflow: hidden; max-width: 100%;
    }
    .mobile-card:active { border-color: var(--accent); }
    .mobile-card .card-addr {
      font-weight: 600; font-size: 13px; margin-bottom: 8px; line-height: 1.3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .mobile-card .card-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px; font-size: 12px;
      min-width: 0;
    }
    .mobile-card .card-row {
      display: flex; justify-content: space-between; gap: 4px; min-width: 0;
    }
    .mobile-card .card-label { color: var(--text-dim); font-size: 11px; }
    .mobile-card .card-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .mobile-card .card-margin-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border);
    }
    .mobile-card .card-margin {
      font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700;
    }
    .mobile-card .card-profit {
      font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600;
    }

    /* Font scaling */
    .section-title { font-size: 11px; }
    .stat-card .stat-value { font-size: 18px; }
  }

  /* Desktop: hide mobile-only elements */
  @media (min-width: 769px) {
    .sheet-handle { display: none; }
    .mobile-filter-btn { display: none !important; }
    .mobile-cards { display: none !important; }
  }
</style>
</head>
<body class="light-mode">

<div class="app-row">
<aside class="sidebar">
  <div class="sheet-handle" id="sheetHandle">
    <div class="handle-bar"></div>
    <div class="peek-stats">
      <div class="peek-stat"><span class="peek-value" id="peekEligible">0</span> eligible</div>
      <div class="peek-stat"><span class="peek-value" id="peekMargin">0%</span> avg margin</div>
    </div>
  </div>
  <div class="sidebar-header">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h1><span>SB 1123</span> Deal Finder</h1>
      <button class="refresh-btn" onclick="copyRefreshCmd()" title="Copy refresh command to clipboard">&#8635; Refresh</button>
    </div>
    <p>Find townhome subdivision sites in LA County<br>10K-25K SF lots that split into up to 10 contiguous units</p>
    <div class="law-ref">CA SB 1123 (eff. Jul 2025) · Up to 10 parcels · No owner-occupancy · 60-day approval · CEQA exempt</div>
    <div class="law-ref" id="dataFreshness" style="margin-top:2px"></div>
  </div>

  <div class="loading-banner" id="loadingBanner">Rendering data...</div>

  <!-- Deal Pipeline Stats -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Deal Pipeline <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value green" id="sb1123Count">0</div><div class="stat-label">1123 Eligible</div></div>
        <div class="stat-card"><div class="stat-value yellow" id="avgMargin">0%</div><div class="stat-label">Avg Margin</div></div>
        <div class="stat-card"><div class="stat-value" id="totalListings">0</div><div class="stat-label">Total Listed</div></div>
      </div>
      <div class="stats-grid two-col" style="margin-top:6px">
        <div class="stat-card"><div class="stat-value" id="medPpu">$0</div><div class="stat-label">Med $/Unit</div></div>
        <div class="stat-card"><div class="stat-value" id="medPpsf">$0</div><div class="stat-label">Med $/SF</div></div>
      </div>
    </div>
  </div>

  <!-- SB9 Mode -->
  <div class="section">
    <button class="mode-toggle active" id="sb1123Toggle" onclick="toggle1123Mode()">
      <div class="toggle-track"><div class="toggle-thumb"></div></div>
      <span class="toggle-label">SB 1123 Eligible Only</span>
      <span class="toggle-count" id="sb1123ToggleCount">0</span>
    </button>
    <div class="preset-row" style="margin-top:8px">
      <button class="preset-btn" onclick="applyPreset('sweet')">Sweet Spot<br><span style="font-size:9px;color:var(--text-dim)">10-15K lot, 8-10 units</span></button>
      <button class="preset-btn" onclick="applyPreset('maxDensity')">Max Density<br><span style="font-size:9px;color:var(--text-dim)">15-25K lot, 10 units</span></button>
      <button class="preset-btn" onclick="applyPreset('value')">Below Market<br><span style="font-size:9px;color:var(--text-dim)">Low $/lot-SF, negotiate</span></button>
      <button class="preset-btn" onclick="applyPreset('stale')">Stale Listings<br><span style="font-size:9px;color:var(--text-dim)">60+ DOM</span></button>
    </div>
  </div>

  <!-- List Price Filter -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">List Price <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="priceMin" step="25000"></div>
          <span class="separator">—</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="priceMax" step="25000"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="priceSliderFill"></div>
          <input type="range" id="priceSliderMin" min="0" max="5000000" step="25000" value="0">
          <input type="range" id="priceSliderMax" min="0" max="5000000" step="25000" value="5000000">
        </div>
        <button class="reset-btn" onclick="resetFilter('price')">Reset Price Filter</button>
      </div>
    </div>
  </div>

  <!-- $/SF Filter -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">$/SF Filter <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="psfMin" step="50"></div>
          <span class="separator">—</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="psfMax" step="50"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="psfSliderFill"></div>
          <input type="range" id="psfSliderMin" min="0" max="2000" step="25" value="0">
          <input type="range" id="psfSliderMax" min="0" max="2000" step="25" value="2000">
        </div>
        <button class="reset-btn" onclick="resetFilter('psf')">Reset $/SF Filter</button>
      </div>
    </div>
  </div>

  <!-- Lot Size Filter -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Lot Size (SF) <span class="badge">KEY</span> <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="lotMin" step="500"></div>
          <span class="separator">—</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="lotMax" step="500"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="lotSliderFill"></div>
          <input type="range" id="lotSliderMin" min="0" max="45000" step="500" value="0">
          <input type="range" id="lotSliderMax" min="0" max="45000" step="500" value="45000">
        </div>
        <button class="reset-btn" onclick="resetFilter('lot')">Reset Lot Filter</button>
      </div>
    </div>
  </div>

  <!-- Structure Size -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Structure Size (SF) <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="sqftMin" step="100"></div>
          <span class="separator">—</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="sqftMax" step="100"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="sqftSliderFill"></div>
          <input type="range" id="sqftSliderMin" min="0" max="7000" step="100" value="0">
          <input type="range" id="sqftSliderMax" min="0" max="7000" step="100" value="7000">
        </div>
        <button class="reset-btn" onclick="resetFilter('sqft')">Reset Size Filter</button>
      </div>
    </div>
  </div>

  <!-- Lot Slope -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Lot Slope <span class="badge">NEW</span> <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min %</div><input type="number" id="slopeMin" step="1"></div>
          <span class="separator">—</span>
          <div class="input-group"><div class="input-label">Max %</div><input type="number" id="slopeMax" step="1"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="slopeSliderFill"></div>
          <input type="range" id="slopeSliderMin" min="0" max="100" step="1" value="0">
          <input type="range" id="slopeSliderMax" min="0" max="100" step="1" value="100">
        </div>
        <button class="reset-btn" onclick="resetFilter('slope')">Reset Slope Filter</button>
      </div>
    </div>
  </div>

  <!-- Filter summary -->
  <div class="section">
    <div class="filter-count" id="filterCount">Showing all</div>
    <button class="reset-btn" onclick="resetFilter('all')">Reset All Filters</button>
  </div>

  <!-- Favorites -->
  <div class="section">
    <button class="fav-toggle" id="favToggle" onclick="toggleFavoritesFilter()">
      <span style="font-size:14px">&#9733;</span> Favorites Only
      <span class="fav-count" id="favCount">0</span>
    </button>
  </div>

  <!-- Zone Filters -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Zone Filters <span class="chevron">▼</span></div>
    <div class="section-content" id="zoneToggles"></div>
  </div>

  <!-- Base Map -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Base Map <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="basemap-group">
        <button class="basemap-btn" data-base="dark" onclick="setBaseMap('dark')">Dark</button>
        <button class="basemap-btn active" data-base="light" onclick="setBaseMap('light')">Light</button>
        <button class="basemap-btn" data-base="satellite" onclick="setBaseMap('satellite')">Satellite</button>
      </div>
    </div>
  </div>

  <!-- Map Layers -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Map Layers <span class="chevron">▼</span></div>
    <div class="section-content">
      <button class="layer-btn" data-layer="markers" onclick="toggleLayer('markers',this)"><span class="icon">o</span> Comp Pins <span class="layer-count" id="compCount"></span></button>
      <button class="layer-btn" data-layer="compHeat" onclick="toggleLayer('compHeat',this)"><span class="icon" style="color:#f0641e">&#9608;</span> $/SF Heatmap <span class="layer-count" id="heatCount"></span></button>
      <button class="layer-btn active" data-layer="listings" onclick="toggleLayer('listings',this)"><span class="icon">*</span> Active Listings <span class="layer-count" id="listingCount"></span></button>
      <button class="layer-btn" data-layer="fireZones" onclick="toggleLayer('fireZones',this)"><span class="icon" style="color:#ef4444">!</span> Fire Hazard Zones</button>
      <button class="layer-btn" data-layer="floodZones" onclick="toggleLayer('floodZones',this)"><span class="icon" style="color:#3b82f6">~</span> Flood Zones (FEMA)</button>
      <button class="layer-btn" data-layer="liquefaction" onclick="toggleLayer('liquefaction',this)"><span class="icon" style="color:#a855f7">&#9632;</span> Liquefaction Zones</button>
      <button class="layer-btn active" data-layer="parcels" onclick="toggleLayer('parcels',this)"><span class="icon">&#9633;</span> Parcel Outlines <small style="color:var(--text-dim)">(zoom 15+)</small></button>
    </div>
  </div>

  <!-- Pro Forma Assumptions -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Pro Forma Assumptions <span class="chevron">▼</span></div>
    <div class="section-content">
      <div class="proforma-inputs">
        <div class="proforma-group">
          <label>Build $/SF</label>
          <input type="number" id="pfBuildCost" value="350" step="25" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Unit SF (avg)</label>
          <input type="number" id="pfUnitSize" value="1200" step="50" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Soft Cost %</label>
          <input type="number" id="pfSoftCost" value="25" step="5" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Sale Discount %</label>
          <input type="number" id="pfDiscount" value="5" step="1" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Demo Cost $</label>
          <input type="number" id="pfDemoCost" value="25000" step="5000" onchange="onProformaChange()">
        </div>
      </div>
      <p style="font-size:10px;color:var(--text-dim);margin-top:8px;line-height:1.4">
        SB 1123 ground-up: demolish existing, build all new townhome units.
        Max avg unit size: 1,200 SF (R1). Guaranteed FAR: 1.0x (3-7 units) / 1.25x (8-10).
      </p>
    </div>
  </div>

  <!-- Listings Table Toggle -->
  <div class="section">
    <button class="panel-toggle" onclick="toggleListingsPanel()">
      <span>Deal Pipeline Table</span>
      <span class="toggle-count" id="listingPanelCount">0 deals</span>
    </button>
    <button class="export-btn" onclick="exportCSV()">Export Filtered Deals to CSV</button>
  </div>
</aside>

<button class="mobile-filter-btn" id="mobileFilterBtn" onclick="openMobileSheet()">
  <span class="filter-icon">&#9776;</span> Filters
</button>

<div id="map"></div>

<div class="map-legend">
  <div class="legend-section">Comps (Market Data)</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r1)"></div> R1 Single Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r2)"></div> R2 Two Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r3)"></div> R3 Multi-Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r4)"></div> R4 High Density</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--land)"></div> Vacant Land</div>
  <div class="legend-section" style="margin-top:8px">Listings (Exit $/SF)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#2563eb;border-radius:50%"></div> &lt;$300/SF</div>
  <div class="legend-item"><div class="legend-dot" style="background:#0ea5e9;border-radius:50%"></div> $300-450</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22c55e;border-radius:50%"></div> $450-600</div>
  <div class="legend-item"><div class="legend-dot" style="background:#eab308;border-radius:50%"></div> $600-750</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f97316;border-radius:50%"></div> $750-900</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ef4444;border-radius:50%"></div> $900+</div>
</div>
</div><!-- /app-row -->

<!-- Listings Panel -->
<div class="listings-panel" id="listingsPanel">
  <div class="listings-panel-resize" id="panelResize"></div>
  <div class="listings-panel-header">
    <h2><span>SB 1123</span> Deal Pipeline</h2>
    <span class="listings-panel-count" id="tablePanelCount">0</span>
    <button class="listings-panel-close" onclick="toggleListingsPanel()">x</button>
  </div>
  <div class="listings-table-wrap" id="tableWrap">
    <table class="listings-table">
      <thead>
        <tr>
          <th class="col-fav" data-sort="fav" onclick="sortTable('fav')"><span style="font-size:12px">&#9733;</span> <span class="sort-arrow">▲</span></th>
          <th class="col-addr" data-sort="address" onclick="sortTable('address')">Address <span class="sort-arrow">▲</span></th>
          <th class="col-zone" data-sort="zone" onclick="sortTable('zone')">Zone <span class="sort-arrow">▲</span></th>
          <th class="col-price" data-sort="price" onclick="sortTable('price')">Price <span class="sort-arrow">▲</span></th>
          <th class="col-lot" data-sort="lotSf" onclick="sortTable('lotSf')">Lot SF <span class="sort-arrow">▲</span></th>
          <th class="col-units" data-sort="maxUnits" onclick="sortTable('maxUnits')">Units <span class="sort-arrow">▲</span></th>
          <th class="col-hood" data-sort="hoodPpsf" onclick="sortTable('hoodPpsf')">Exit $/SF <span class="sort-arrow">▲</span></th>
          <th class="col-sale" data-sort="salePerUnit" onclick="sortTable('salePerUnit')">Sale/Unit <span class="sort-arrow">▲</span></th>
          <th class="col-ppu" data-sort="pricePerUnit" onclick="sortTable('pricePerUnit')">Buy/Unit <span class="sort-arrow">▲</span></th>
          <th class="col-profit" data-sort="estProfit" onclick="sortTable('estProfit')">Profit <span class="sort-arrow">▲</span></th>
          <th class="col-margin" data-sort="estMargin" onclick="sortTable('estMargin')">Margin <span class="sort-arrow">▲</span></th>
          <th class="col-slope" data-sort="slope" onclick="sortTable('slope')">Slope <span class="sort-arrow">▲</span></th>
          <th class="col-dom" data-sort="dom" onclick="sortTable('dom')">DOM <span class="sort-arrow">▲</span></th>
          <th class="col-link">Link</th>
        </tr>
      </thead>
      <tbody id="listingsTableBody"></tbody>
    </table>
  </div>
  <div class="mobile-cards" id="mobileCards"></div>
</div>

<script>
// ── Constants ──
const ZONE_COLORS = {R1:'#2563eb',R2:'#16a34a',R3:'#ea580c',R4:'#9333ea',LAND:'#b45309'};
const ZONE_LABELS = {R1:'Single Family',R2:'Two Family',R3:'Multi-Family',R4:'High Density',LAND:'Vacant Land'};
// Hood $/SF color scale: cool (cheap) → hot (expensive)
function hoodPpsfColor(ppsf){
  if(!ppsf || ppsf <= 0) return '#888';
  if(ppsf < 300) return '#2563eb';   // Deep blue — very affordable
  if(ppsf < 450) return '#0ea5e9';   // Sky blue
  if(ppsf < 600) return '#22c55e';   // Green — moderate
  if(ppsf < 750) return '#eab308';   // Yellow — above average
  if(ppsf < 900) return '#f97316';   // Orange — expensive
  return '#ef4444';                    // Red — premium
}

// ── State ──
let COMPS = [];
let LISTINGS = [];
const markerLayers = {R1:L.layerGroup(),R2:L.layerGroup(),R3:L.layerGroup(),R4:L.layerGroup(),LAND:L.layerGroup()};
const listingsLayer = L.layerGroup();
const layerState = {markers:false,compHeat:false,listings:true,fireZones:false,floodZones:false,liquefaction:false,parcels:true};
const zoneState = {R1:true,R2:false,R3:false,R4:false,LAND:false};
let sb1123Mode = true;  // Default ON — we only care about 1123 deals

const filters = {
  price:{ min:0, max:5000000, dataMin:0, dataMax:5000000, step:25000, cap:5000000, defaultMin:null, defaultMax:null },
  psf:  { min:0, max:2000, dataMin:0, dataMax:2000, step:25, cap:null, defaultMin:800, defaultMax:null },
  sqft: { min:0, max:7000, dataMin:0, dataMax:7000, step:100, cap:7000, defaultMin:null, defaultMax:null },
  lot:  { min:0, max:45000, dataMin:0, dataMax:45000, step:500, cap:45000, defaultMin:12000, defaultMax:25000 },
  slope:{ min:0, max:100, dataMin:0, dataMax:100, step:1, cap:100, defaultMin:null, defaultMax:10 },
};

let currentSort = { key:'estMargin', dir:'desc' };
let listingsPanelOpen = false;
let favoritesOnly = false;

// ── Favorites (localStorage) ──
const FAV_KEY = 'sb1123_favorites';
function loadFavorites(){ try{return JSON.parse(localStorage.getItem(FAV_KEY))||{}}catch(e){return{}} }
function saveFavorites(f){ localStorage.setItem(FAV_KEY, JSON.stringify(f)); }
function listingKey(l){ return l.lat+','+l.lng; }
function isFavorite(l){ return !!loadFavorites()[listingKey(l)]; }
function toggleFavorite(lat,lng){
  const key=lat+','+lng, favs=loadFavorites();
  if(favs[key]) delete favs[key]; else favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  saveFavorites(favs); updateFavCount(); applyFilters();
}
function saveFavNote(lat,lng,text){
  const key=lat+','+lng, favs=loadFavorites();
  if(!favs[key]) favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  favs[key].notes=text; saveFavorites(favs);
}
function getFavNote(lat,lng){ const f=loadFavorites()[lat+','+lng]; return f?f.notes||'':''; }
function updateFavCount(){
  const n=Object.keys(loadFavorites()).length;
  document.getElementById('favCount').textContent=n;
}
function copyRefreshCmd(){
  const cmd='./refresh.sh';
  navigator.clipboard.writeText(cmd).then(()=>{
    const btn=document.querySelector('.refresh-btn');
    btn.textContent='Copied!';
    btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';
    setTimeout(()=>{btn.innerHTML='&#8635; Refresh';btn.style.borderColor='';btn.style.color='';},2000);
  }).catch(()=>{
    prompt('Run this in your terminal to refresh data:',cmd);
  });
}
function toggleFavoritesFilter(){
  favoritesOnly=!favoritesOnly;
  document.getElementById('favToggle').classList.toggle('active',favoritesOnly);
  applyFilters();
}

// Pro forma defaults — SB 1123 townhome development
let proforma = {
  buildCostPerSf: 350,   // Hard construction $/SF for townhome
  avgUnitSf: 1200,       // Avg townhome unit size (SB1123 max avg 1,200 SF in R1)
  softCostPct: 25,       // Permits, architecture, engineering
  saleDiscountPct: 5,    // Broker fees + closing costs
  demoCost: 25000,       // Demolition of existing structure
};

// ── Map ──
const map = L.map('map',{center:[34.05,-118.35],zoom:11,zoomControl:false});
L.control.zoom({position:'topright'}).addTo(map);

// Custom panes so heatmap renders below listings
map.createPane('heatmapPane').style.zIndex = 350;
map.createPane('compDotsPane').style.zIndex = 360;
const listingsPane = map.createPane('listingsPane');
listingsPane.style.zIndex = 450;
listingsPane.style.filter = 'drop-shadow(0 0 6px rgba(0,0,0,0.5))';

// Base tile layers
const baseLayers = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'Esri World Imagery',maxZoom:19
  })
};
let activeBase = 'light';
baseLayers.light.addTo(map);

function setBaseMap(name){
  map.removeLayer(baseLayers[activeBase]);
  activeBase = name;
  baseLayers[name].addTo(map);
  // Update button states
  document.querySelectorAll('.basemap-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.base===name);
  });
  // Toggle body class for light mode adjustments
  document.body.classList.toggle('light-mode', name==='light');
}

Object.values(markerLayers).forEach(l=>l.addTo(map));
listingsLayer.addTo(map);

// Overlay layers (server-rendered from LA County / FEMA / CGS ArcGIS)
let fireZoneLayer = null;
let parcelLayer = null;
let floodZoneLayer = null;
let liquefactionLayer = null;
let compHeatLayer = null;
let compCanvasRenderer = null;
let compPointsLayer = L.layerGroup();
let compLabelsLayer = L.layerGroup();
let compSpatialGrid = {};  // grid for fast viewport queries

// Build spatial grid for comps (0.005° cells ≈ 500m)
function buildCompGrid(comps){
  const grid = {};
  const S = 0.005;
  comps.forEach(c=>{
    if(!c.ppsf || c.ppsf <= 0) return;
    const key = Math.floor(c.lat/S)+','+Math.floor(c.lng/S);
    if(!grid[key]) grid[key]=[];
    grid[key].push(c);
  });
  return grid;
}

// Query comps in a bounding box from grid
function queryCompGrid(bounds){
  const S = 0.005;
  const s=bounds.getSouth(), n=bounds.getNorth(), w=bounds.getWest(), e=bounds.getEast();
  const rMin=Math.floor(s/S), rMax=Math.floor(n/S);
  const cMin=Math.floor(w/S), cMax=Math.floor(e/S);
  const result=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=compSpatialGrid[r+','+c];
      if(cell) result.push(...cell);
    }
  }
  return result;
}

// Render comp points + labels for current viewport
function updateCompPoints(){
  compPointsLayer.clearLayers();
  compLabelsLayer.clearLayers();
  if(!layerState.compHeat) return;
  const zoom = map.getZoom();
  if(zoom < 13) return;

  const bounds = map.getBounds();
  const visible = queryCompGrid(bounds);
  const showLabels = zoom >= 15;
  // Cap markers to prevent browser freeze at mid-zoom with wide viewport
  const cap = showLabels ? 2000 : 5000;
  const toRender = visible.length > cap ? visible.slice(0, cap) : visible;

  toRender.forEach(c=>{
    const color = hoodPpsfColor(c.ppsf);
    const r = zoom >= 16 ? 6 : zoom >= 14 ? 4 : 3;
    const cm = L.circleMarker([c.lat,c.lng],{
      radius:r, color:'rgba(255,255,255,0.3)', fillColor:color,
      fillOpacity:0.85, weight:0.8, renderer:compCanvasRenderer,
      pane:'compDotsPane'
    });
    cm.bindPopup(`<div style="font-size:12px"><b>${c.address||'Sold Comp'}</b><br>
      <span style="font-family:monospace;font-size:14px;color:${color}">$${c.ppsf}/SF</span><br>
      $${c.price.toLocaleString()} · ${c.sqft.toLocaleString()} sf${c.zone?' · '+c.zone:''}${c.date?' · '+c.date:''}</div>`,{maxWidth:250});
    compPointsLayer.addLayer(cm);

    if(showLabels){
      const label = L.marker([c.lat,c.lng],{
        icon: L.divIcon({
          className:'comp-psf-label',
          html:'$'+c.ppsf,
          iconSize:[40,14],
          iconAnchor:[20,-6]
        }),
        interactive:false
      });
      compLabelsLayer.addLayer(label);
    }
  });
}
if(L.esri){
  try {
    fireZoneLayer = L.esri.dynamicMapLayer({
      url:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Dynamic/Hazards/MapServer',
      layers:[2],
      opacity:0.4
    });
    // FEMA 100-year + 500-year flood plains (LA County Hazards service)
    floodZoneLayer = L.esri.dynamicMapLayer({
      url:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Dynamic/Hazards/MapServer',
      layers:[11,12],
      opacity:0.4
    });
    // CGS Liquefaction zones (CA state service)
    liquefactionLayer = L.esri.dynamicMapLayer({
      url:'https://services.gis.ca.gov/arcgis/rest/services/GeoscientificInformation/Liquefaction/MapServer',
      layers:[0,3],
      opacity:0.4
    });
    parcelLayer = L.esri.tiledMapLayer({
      url:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer',
      opacity:0.6,
      maxZoom:20,
      minZoom:15
    });
  } catch(e) {
    console.warn('esri-leaflet layers failed:', e.message);
  }
}

// ══════════════════════════════════════════
//  SB 1123 ELIGIBILITY + PRO FORMA
// ══════════════════════════════════════════

// SB 1123 eligibility: R1-R4 + LAND zones, lot 10K+ SF
// Exclude condos/townhouses — on shared/HOA land, can't subdivide
// Exclude R1 with HOA — indicates shared land/CC&Rs that block subdivision
// Exclude VHFHSZ — hard exclusion under SB 1123
function isSB1123Eligible(l){
  const validZone = ['R1','R2','R3','R4','LAND'].includes(l.zone);
  const notCondoTownhouse = !['Condo/Co-op','Townhouse'].includes(l.type);
  const notR1Hoa = !(l.zone === 'R1' && l.hoa > 0);
  const notFireZone = !l.fireZone;
  const validLot = l.lotSf && l.lotSf >= 10000;  // Min 10K for meaningful split
  return validZone && notCondoTownhouse && notR1Hoa && notFireZone && validLot;
}

function getMinLotPerUnit(zone){
  // SB 1123: 1,200 SF min per parcel in single-family zones, 600 SF in multifamily
  if(zone === 'R1') return 1200;
  if(zone === 'LAND') return 1200;  // Assume R1 density for unzoned land
  return 600;  // R2, R3, R4
}

function getMaxUnits(l){
  if(!l.lotSf) return 1;
  const minPer = getMinLotPerUnit(l.zone);
  const byLot = Math.floor(l.lotSf / minPer);
  return Math.min(10, Math.max(1, byLot));  // SB 1123 caps at 10
}

function getGuaranteedFAR(units){
  // SB 1123 guaranteed FAR minimums
  if(units >= 8) return 1.25;
  if(units >= 3) return 1.0;
  return 0.5;  // Below 3 units, use base zoning
}

function calculateProForma(l){
  const maxUnits = getMaxUnits(l);
  const pf = proforma;
  // Prefer new-construction comps (what we're actually selling), fall back to existing
  const valuePerSf = l.newconPpsf || l.hoodPpsf || l.ppsf;

  // Revenue: sell townhome units at local $/SF (new-con preferred)
  const grossPerUnit = valuePerSf * pf.avgUnitSf;
  const grossRevenue = maxUnits * grossPerUnit;
  const netRevenue = grossRevenue * (1 - pf.saleDiscountPct / 100);

  // Costs — SB 1123 is ground-up development (demolish existing, build all new)
  const acquisition = l.price;
  const demo = l.sqft > 0 ? pf.demoCost : 0;  // Demo existing structure
  const hardCost = maxUnits * pf.avgUnitSf * pf.buildCostPerSf;
  const softCost = hardCost * (pf.softCostPct / 100);
  const totalBuildCost = hardCost + softCost + demo;
  const totalCost = acquisition + totalBuildCost;

  return {
    maxUnits,
    grossRevenue,
    netRevenue,
    acquisition,
    demo,
    totalBuildCost,
    totalCost,
    profit: netRevenue - totalCost,
    margin: totalCost > 0 ? ((netRevenue - totalCost) / totalCost * 100) : 0,
    pricePerUnit: Math.round(acquisition / maxUnits),
    guaranteedFAR: getGuaranteedFAR(maxUnits),
    buildableSf: Math.round(l.lotSf * getGuaranteedFAR(maxUnits)),
  };
}

// Generate ZIMAS lookup URL for LA City properties
function getZimasUrl(l){
  const addr = (l.address || '').split(',')[0].trim();
  return 'https://zimas.lacity.org/search?address=' + encodeURIComponent(addr);
}

// Enrich listings with computed fields
function enrichListings(){
  LISTINGS.forEach(l => {
    l.sb1123Eligible = isSB1123Eligible(l);
    l.maxUnits = getMaxUnits(l);
    const pf = calculateProForma(l);
    l.pricePerUnit = pf.pricePerUnit;
    l.estProfit = pf.profit;
    l.estMargin = pf.margin;
    l.totalCost = pf.totalCost;
    l.netRevenue = pf.netRevenue;
    l.totalBuildCost = pf.totalBuildCost;
    l.salePerUnit = pf.maxUnits > 0 ? Math.round(pf.netRevenue / pf.maxUnits) : 0;
    l.buildPerUnit = pf.maxUnits > 0 ? Math.round(pf.totalBuildCost / pf.maxUnits) : 0;
    l.guaranteedFAR = pf.guaranteedFAR;
    l.buildableSf = pf.buildableSf;
    l.landPpsf = l.lotSf ? Math.round(l.price / l.lotSf) : null;
  });
}

// ══════════════════════════════════════════
//  FILTERING
// ══════════════════════════════════════════

function getFilteredComps(){
  return COMPS.filter(c =>
    zoneState[c.zone] &&
    c.price >= filters.price.min && c.price <= filters.price.max &&
    (c.ppsf || c.price/c.sqft) >= filters.psf.min &&
    (c.ppsf || c.price/c.sqft) <= filters.psf.max &&
    c.sqft >= filters.sqft.min && c.sqft <= filters.sqft.max
  );
}

function getFilteredListings(){
  const favs = favoritesOnly ? loadFavorites() : null;
  return LISTINGS.filter(l => {
    if(favoritesOnly && !favs[listingKey(l)]) return false;
    if(sb1123Mode && !l.sb1123Eligible) return false;
    const zoneOk = !l.zone || zoneState[l.zone];
    const priceOk = l.price >= filters.price.min && l.price <= filters.price.max;
    const isLand = l.zone === 'LAND';
    const psfOk = isLand || (l.ppsf >= filters.psf.min && l.ppsf <= filters.psf.max);
    const sqftOk = isLand || (l.sqft >= filters.sqft.min && l.sqft <= filters.sqft.max);
    const lotVal = l.lotSf || 0;
    const lotAtDefault = filters.lot.min === filters.lot.dataMin && filters.lot.max === filters.lot.dataMax;
    const lotOk = lotAtDefault ? true : (lotVal >= filters.lot.min && lotVal <= filters.lot.max);
    const slopeVal = l.slope != null ? l.slope : 0;
    const slopeAtDefault = filters.slope.min === filters.slope.dataMin && filters.slope.max === filters.slope.dataMax;
    const slopeOk = slopeAtDefault ? true : (slopeVal >= filters.slope.min && slopeVal <= filters.slope.max);
    return zoneOk && priceOk && psfOk && sqftOk && lotOk && slopeOk;
  });
}

// ══════════════════════════════════════════
//  MAP RENDERING
// ══════════════════════════════════════════

function rebuildMarkers(){
  Object.values(markerLayers).forEach(l=>l.clearLayers());
  const filtered = getFilteredComps();
  filtered.forEach(comp => {
    const psf = comp.ppsf || Math.round(comp.price / comp.sqft);
    const cm = L.circleMarker([comp.lat,comp.lng],{
      radius:3, color:ZONE_COLORS[comp.zone], fillColor:ZONE_COLORS[comp.zone],
      fillOpacity:0.5, weight:1
    });
    cm.bindPopup(`
      <div class="popup-badge comp">Market Comp</div>
      <div class="popup-title">${comp.address || 'N/A'}</div>
      <div class="popup-grid">
        <div><div class="popup-label">Market Value</div><div class="popup-value">$${comp.price.toLocaleString()}</div></div>
        <div><div class="popup-label">$/SF</div><div class="popup-value" style="color:${ZONE_COLORS[comp.zone]}">$${psf}</div></div>
        <div><div class="popup-label">Size</div><div class="popup-value">${comp.sqft.toLocaleString()} sf</div></div>
        <div><div class="popup-label">Zone</div><div class="popup-value">${comp.zone}</div></div>
        ${comp.zip?`<div><div class="popup-label">Zip</div><div class="popup-value">${comp.zip}</div></div>`:''}
      </div>
    `,{maxWidth:280});
    cm.addTo(markerLayers[comp.zone]);
  });
  document.getElementById('compCount').textContent = filtered.length.toLocaleString();
  refreshVisibility();
}

function rebuildListings(){
  listingsLayer.clearLayers();
  const filtered = getFilteredListings();

  filtered.forEach(l => {
    const exitPpsf = l.newconPpsf || l.hoodPpsf;
    const color = hoodPpsfColor(exitPpsf);
    const lotSf = l.lotSf || 0;
    const radius = lotSf >= 15000 ? 11 : lotSf >= 10000 ? 9 : 8;
    const cm = L.circleMarker([l.lat,l.lng],{
      radius, color:'#fff', fillColor:color,
      fillOpacity: 0.95,
      weight: 3,
      pane:'listingsPane',
    });

    const delta = l.hoodPpsf ? l.ppsf - l.hoodPpsf : null;
    const pf = calculateProForma(l);

    cm.bindPopup(`
      ${l.sb1123Eligible ? '<div class="popup-badge" style="background:rgba(34,197,94,0.2);color:var(--green)">SB 1123</div>' : ''}
      <div class="popup-title">${l.address || 'N/A'}</div>
      <div class="popup-grid">
        <div><div class="popup-label">List Price</div><div class="popup-value" style="color:${color}">$${l.price.toLocaleString()}</div></div>
        <div><div class="popup-label">$/SF</div><div class="popup-value">$${l.ppsf}</div></div>
        ${l.hoodPpsf?`<div><div class="popup-label">Hood $/SF</div><div class="popup-value">$${l.hoodPpsf}</div></div>`:''}
        ${l.newconPpsf?`<div><div class="popup-label">New-Con $/SF</div><div class="popup-value" style="color:var(--green)">$${l.newconPpsf}</div></div>`:''}
        ${delta!==null?`<div><div class="popup-label">vs Hood</div><div class="popup-value" style="color:${delta>0?'var(--red)':'var(--green)'}">${delta>0?'+':''}$${delta}/sf</div></div>`:''}
        <div><div class="popup-label">Structure</div><div class="popup-value">${l.sqft.toLocaleString()} sf</div></div>
        ${l.lotSf?`<div><div class="popup-label">Lot Size</div><div class="popup-value">${l.lotSf.toLocaleString()} sf</div></div>`:''}
        ${l.beds?`<div><div class="popup-label">Beds/Baths</div><div class="popup-value">${l.beds}/${l.baths}</div></div>`:''}
        <div><div class="popup-label">Zone</div><div class="popup-value">${l.zone||'—'}</div></div>
        ${l.city?`<div><div class="popup-label">City</div><div class="popup-value">${l.city}</div></div>`:''}
        ${l.slope!=null?`<div><div class="popup-label">Lot Slope</div><div class="popup-value" style="color:${l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)'}">${l.slope}%</div></div>`:''}
        ${l.fireZone?`<div><div class="popup-label">Fire Zone</div><div class="popup-value" style="color:var(--red)">VHFHSZ</div></div>`:''}
        ${l.hoa?`<div><div class="popup-label">HOA</div><div class="popup-value">$${l.hoa}/mo</div></div>`:''}
        ${l.ain?`<div><div class="popup-label">AIN</div><div class="popup-value">${l.ain}</div></div>`:''}
        ${l.assessedLandValue?`<div><div class="popup-label">Land Assessed</div><div class="popup-value">$${l.assessedLandValue.toLocaleString()}</div></div>`:''}
        ${l.assessedImpValue?`<div><div class="popup-label">Imp Assessed</div><div class="popup-value">$${l.assessedImpValue.toLocaleString()}</div></div>`:''}

        <div class="popup-divider"></div>
        <div class="popup-section-label">SB 1123 Pro Forma — ${pf.maxUnits} Townhomes</div>
        <div><div class="popup-label">Guaranteed FAR</div><div class="popup-value">${pf.guaranteedFAR}x (${pf.buildableSf.toLocaleString()} sf)</div></div>
        <div><div class="popup-label">Exit $/SF</div><div class="popup-value" style="color:var(--green)">$${(l.newconPpsf||l.hoodPpsf||l.ppsf)}</div></div>
        ${l.dom!==null&&l.dom!==undefined?`<div><div class="popup-label">Days on Market</div><div class="popup-value" style="color:${l.dom>=60?'var(--green)':l.dom>=30?'var(--yellow)':'var(--text)'}">${l.dom}</div></div>`:''}
        ${l.lotSf&&l.sqft?`<div><div class="popup-label">Current FAR</div><div class="popup-value">${(l.sqft/l.lotSf).toFixed(2)}</div></div>`:''}

        <div class="popup-divider"></div>
        <div class="popup-section-label">Per-Unit Economics</div>
        <div><div class="popup-label">Buy / Unit</div><div class="popup-value">$${pf.pricePerUnit.toLocaleString()}</div></div>
        <div><div class="popup-label">Build / Unit</div><div class="popup-value">$${Math.round(pf.totalBuildCost/pf.maxUnits).toLocaleString()}</div></div>
        <div><div class="popup-label">Sell / Unit</div><div class="popup-value" style="color:var(--green)">$${Math.round(pf.netRevenue/pf.maxUnits).toLocaleString()}</div></div>
        <div><div class="popup-label">Profit / Unit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit/pf.maxUnits).toLocaleString()}</div></div>

        <div class="popup-divider"></div>
        <div class="popup-section-label">Total Project</div>
        <div><div class="popup-label">Total Cost</div><div class="popup-value">$${Math.round(pf.totalCost).toLocaleString()}</div></div>
        <div><div class="popup-label">Net Revenue</div><div class="popup-value">$${Math.round(pf.netRevenue).toLocaleString()}</div></div>
        <div><div class="popup-label">Est Profit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit).toLocaleString()}</div></div>
        <div><div class="popup-label">Margin</div><div class="popup-value ${pf.margin>=0?'popup-profit-positive':'popup-profit-negative'}">${pf.margin.toFixed(1)}%</div></div>

        <div class="popup-divider"></div>
        <div class="popup-section-label">ZIMAS Due Diligence</div>
        <div style="grid-column:1/-1;font-size:10px;color:var(--text-dim);line-height:1.6">
          Verify before pursuing:<br>
          <span style="color:var(--green)">&#10003;</span> R1-1 or R2+ zoning confirmed<br>
          <span style="color:var(--green)">&#10003;</span> Not in Hillside Area<br>
          <span style="color:var(--green)">&#10003;</span> No Historic Preservation overlay<br>
          <span style="color:var(--red)">&#10007;</span> NOT in Very High Fire Hazard Zone (hard exclusion)<br>
          <span style="color:var(--green)">&#10003;</span> No Specific Plan restrictions<br>
          <span style="color:var(--yellow)">&#9733;</span> Transit Priority Area = 0 parking req<br>
          <span style="color:var(--green)">&#10003;</span> No rent-controlled tenants (last 5 yrs)<br>
          <span style="color:var(--green)">&#10003;</span> No Ellis Act evictions (last 15 yrs)
        </div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:center;align-items:center">
        ${l.url?`<a href="${l.url}" target="_blank" style="color:var(--accent);font-size:11px">Redfin &#8599;</a>`:''}
        <a href="${getZimasUrl(l)}" target="_blank" style="color:var(--yellow);font-size:11px">ZIMAS &#8599;</a>
        <button class="popup-fav-btn ${isFavorite(l)?'active':''}" onclick="toggleFavorite(${l.lat},${l.lng});this.classList.toggle('active')">&#9733; ${isFavorite(l)?'Saved':'Save'}</button>
      </div>
      <textarea class="popup-notes" placeholder="Add notes..." onchange="saveFavNote(${l.lat},${l.lng},this.value)">${getFavNote(l.lat,l.lng)}</textarea>
    `,{maxWidth:320});
    cm.addTo(listingsLayer);
  });

  document.getElementById('listingCount').textContent = filtered.length.toLocaleString();
  rebuildTable(filtered);
}

function refreshVisibility(){
  Object.entries(markerLayers).forEach(([z,l])=>{
    if(layerState.markers && zoneState[z]) l.addTo(map);
    else map.removeLayer(l);
  });
  if(compHeatLayer){
    if(layerState.compHeat) compHeatLayer.addTo(map);
    else map.removeLayer(compHeatLayer);
  }
  if(layerState.compHeat){
    compPointsLayer.addTo(map);
    compLabelsLayer.addTo(map);
    updateCompPoints();
  } else {
    map.removeLayer(compPointsLayer);
    map.removeLayer(compLabelsLayer);
  }
  if(layerState.listings) listingsLayer.addTo(map);
  else map.removeLayer(listingsLayer);
  if(fireZoneLayer){
    if(layerState.fireZones) fireZoneLayer.addTo(map);
    else map.removeLayer(fireZoneLayer);
  }
  if(floodZoneLayer){
    if(layerState.floodZones) floodZoneLayer.addTo(map);
    else map.removeLayer(floodZoneLayer);
  }
  if(liquefactionLayer){
    if(layerState.liquefaction) liquefactionLayer.addTo(map);
    else map.removeLayer(liquefactionLayer);
  }
  if(parcelLayer){
    if(layerState.parcels) parcelLayer.addTo(map);
    else map.removeLayer(parcelLayer);
  }
}

// ══════════════════════════════════════════
//  UI CONTROLS
// ══════════════════════════════════════════

function toggle1123Mode(){
  sb1123Mode = !sb1123Mode;
  document.getElementById('sb1123Toggle').classList.toggle('active', sb1123Mode);
  applyFilters();
}

function toggleZone(zone,enabled){
  zoneState[zone]=enabled;
  applyFilters();
}

function toggleLayer(layer,btn){
  layerState[layer]=!layerState[layer];
  btn.classList.toggle('active');
  refreshVisibility();
}

function toggleSection(titleEl){
  titleEl.closest('.section').classList.toggle('collapsed');
}

function toggleListingsPanel(){
  const panel = document.getElementById('listingsPanel');
  listingsPanelOpen = !listingsPanelOpen;
  panel.classList.toggle('open', listingsPanelOpen);
  if(isMobile() && listingsPanelOpen) setSheetState('collapsed');
  setTimeout(() => map.invalidateSize(), 350);
}

// ── Panel resize ──
(function(){
  const panel = document.getElementById('listingsPanel');
  const handle = document.getElementById('panelResize');
  let startY, startH;
  handle.addEventListener('mousedown', function(e){
    startY = e.clientY; startH = panel.offsetHeight;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    e.preventDefault();
  });
  handle.addEventListener('touchstart', function(e){
    startY = e.touches[0].clientY; startH = panel.offsetHeight;
    document.addEventListener('touchmove', onTouchMove, {passive:false});
    document.addEventListener('touchend', onTouchUp);
  }, {passive:true});
  function onMove(e){
    const diff = startY - e.clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
  }
  function onTouchMove(e){
    const diff = startY - e.touches[0].clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
    e.preventDefault();
  }
  function onUp(){
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    map.invalidateSize();
  }
  function onTouchUp(){
    document.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onTouchUp);
    map.invalidateSize();
  }
})();

// ── Presets ──
function applyPreset(name){
  // Clear all first
  resetFilter('all');
  sb1123Mode = true;
  document.getElementById('sb1123Toggle').classList.add('active');

  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  event.target.closest('.preset-btn').classList.add('active');

  if(name === 'sweet'){
    // Sweet spot: 10-15K SF lots = 8-10 townhomes, efficient build
    setFilter('lot', 10000, 15000);
  } else if(name === 'maxDensity'){
    // Max density: 15-25K SF lots, all 10 units
    setFilter('lot', 15000, 25000);
  } else if(name === 'value'){
    // Below-market land acquisition — sort by margin
    currentSort = {key:'estMargin', dir:'desc'};
  } else if(name === 'stale'){
    // Stale inventory — negotiation leverage
    currentSort = {key:'dom', dir:'desc'};
  }
  applyFilters();
}

function setFilter(key, min, max){
  const f = filters[key];
  f.min = Math.max(f.dataMin, min);
  f.max = Math.min(f.dataMax, max);
  const sMin = document.getElementById(key+'SliderMin');
  const sMax = document.getElementById(key+'SliderMax');
  const iMin = document.getElementById(key+'Min');
  const iMax = document.getElementById(key+'Max');
  if(sMin) sMin.value = f.min;
  if(sMax) sMax.value = f.max;
  if(iMin) iMin.value = f.min;
  if(iMax) iMax.value = f.max;
  updateFill(key);
}

// ── Stats ──
function updateStats(){
  const filtered = getFilteredListings();
  const margins = filtered.map(l=>l.estMargin||0);
  const ppus = filtered.filter(l=>l.pricePerUnit>0).map(l=>l.pricePerUnit).sort((a,b)=>a-b);
  const ppsfs = filtered.map(l=>l.ppsf).sort((a,b)=>a-b);

  const sb1123 = filtered.filter(l=>l.sb1123Eligible);
  document.getElementById('sb1123Count').textContent = sb1123.length.toLocaleString();
  document.getElementById('avgMargin').textContent = margins.length ? Math.round(margins.reduce((a,b)=>a+b,0)/margins.length)+'%' : '0%';
  document.getElementById('totalListings').textContent = filtered.length.toLocaleString();
  document.getElementById('medPpu').textContent = ppus.length ? '$'+(ppus[Math.floor(ppus.length/2)]).toLocaleString() : '$0';
  document.getElementById('medPpsf').textContent = ppsfs.length ? '$'+ppsfs[Math.floor(ppsfs.length/2)] : '$0';

  document.getElementById('sb1123ToggleCount').textContent = LISTINGS.filter(l=>l.sb1123Eligible).length;

  // Comp stats
  const compFiltered = getFilteredComps();
  document.getElementById('compCount').textContent = compFiltered.length.toLocaleString();
  updatePeekStats();
}

function updateFilterCount(){
  const comps = getFilteredComps().length;
  const listings = getFilteredListings().length;
  document.getElementById('filterCount').textContent = `${comps.toLocaleString()} comps | ${listings.toLocaleString()} listings`;
  document.getElementById('listingPanelCount').textContent = `${listings} deals`;
}

function rebuildZoneToggles(){
  const el=document.getElementById('zoneToggles');
  el.innerHTML='';
  const filtered = getFilteredComps();
  const fListings = getFilteredListings();
  ['R1','R2','R3','R4','LAND'].forEach(zone=>{
    const zc=filtered.filter(c=>c.zone===zone);
    const zl=fListings.filter(l=>l.zone===zone);
    const psfs=zc.map(c=>c.ppsf||c.price/c.sqft);
    const avg=psfs.length?Math.round(psfs.reduce((a,b)=>a+b,0)/psfs.length):0;
    const div=document.createElement('label');
    div.className='zone-toggle';
    div.innerHTML=`
      <input type="checkbox" ${zoneState[zone]?'checked':''} onchange="toggleZone('${zone}',this.checked)">
      <span class="check-box"></span>
      <span class="zone-swatch" style="background:${ZONE_COLORS[zone]}"></span>
      <span class="zone-label">${zone} <small>${ZONE_LABELS[zone]}</small></span>
      <span class="zone-stat">${avg?'$'+avg+'/sf':'—'}<span class="data-count">${zl.length}</span></span>
    `;
    el.appendChild(div);
  });
}

// ══════════════════════════════════════════
//  SORTABLE TABLE
// ══════════════════════════════════════════

function getSortValue(l, key){
  if(key==='fav') return isFavorite(l)?1:0;
  if(key==='maxUnits') return l.maxUnits||1;
  if(key==='pricePerUnit') return l.pricePerUnit||Infinity;
  if(key==='salePerUnit') return l.salePerUnit||0;
  if(key==='estProfit') return l.estProfit||(-Infinity);
  if(key==='estMargin') return l.estMargin||(-Infinity);
  const v=l[key]; return v===null||v===undefined ? -Infinity : v;
}

function sortTable(key){
  if(currentSort.key===key) currentSort.dir = currentSort.dir==='asc'?'desc':'asc';
  else{
    currentSort.key=key;
    currentSort.dir = (typeof getSortValue(LISTINGS[0]||{},key)==='string')?'asc':'desc';
  }
  document.querySelectorAll('.listings-table th').forEach(th=>{
    th.classList.remove('sorted');
    th.querySelector('.sort-arrow').textContent='▲';
  });
  const th=document.querySelector(`.listings-table th[data-sort="${key}"]`);
  if(th){th.classList.add('sorted');th.querySelector('.sort-arrow').textContent=currentSort.dir==='asc'?'▲':'▼';}
  rebuildTable(getFilteredListings());
}

function rebuildTable(filtered){
  const tbody = document.getElementById('listingsTableBody');
  const sorted = [...filtered].sort((a,b) => {
    let va=getSortValue(a,currentSort.key), vb=getSortValue(b,currentSort.key);
    if(typeof va==='string') va=va.toLowerCase();
    if(typeof vb==='string') vb=vb.toLowerCase();
    if(va<vb) return currentSort.dir==='asc'?-1:1;
    if(va>vb) return currentSort.dir==='asc'?1:-1;
    return 0;
  });

  // Cap table rows for performance
  const display = sorted.slice(0, 500);

  tbody.innerHTML = display.map(l => {
    const zoneColor = ZONE_COLORS[l.zone]||'#666';
    const profitClass = (l.estProfit||0)>=0?'profit-pos':'profit-neg';
    const marginClass = (l.estMargin||0)>=0?'profit-pos':'profit-neg';
    const starred = isFavorite(l);
    const exitPpsf = l.newconPpsf || l.hoodPpsf;
    return `<tr onclick="flyToListing(${l.lat},${l.lng})">
      <td class="col-fav"><span class="fav-star ${starred?'active':''}" onclick="event.stopPropagation();toggleFavorite(${l.lat},${l.lng})">&#9733;</span></td>
      <td class="col-addr" title="${l.address}">${l.address}</td>
      <td class="col-zone"><span class="zone-pill" style="background:${zoneColor}22;color:${zoneColor}">${l.zone||'—'}</span></td>
      <td class="col-price mono">$${l.price.toLocaleString()}</td>
      <td class="col-lot mono">${l.lotSf?l.lotSf.toLocaleString():'—'}</td>
      <td class="col-units mono" style="color:${l.maxUnits>=8?'var(--green)':l.maxUnits>=4?'var(--yellow)':'var(--text-dim)'}">${l.maxUnits}</td>
      <td class="col-hood mono">${exitPpsf?'$'+exitPpsf:'—'}</td>
      <td class="col-sale mono">${l.salePerUnit?'$'+(l.salePerUnit).toLocaleString():'—'}</td>
      <td class="col-ppu mono">$${(l.pricePerUnit||0).toLocaleString()}</td>
      <td class="col-profit mono ${profitClass}">$${Math.round(l.estProfit||0).toLocaleString()}</td>
      <td class="col-margin mono ${marginClass}">${(l.estMargin||0).toFixed(0)}%</td>
      <td class="col-slope mono" style="color:${l.slope!=null?(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)'):'var(--text-dim)'}">${l.slope!=null?l.slope+'%':'—'}</td>
      <td class="col-dom mono">${l.dom!==null&&l.dom!==undefined?l.dom:'—'}</td>
      <td class="col-link">${l.url?'<a class="redfin-link" href="'+l.url+'" target="_blank" onclick="event.stopPropagation()">View</a>':''}</td>
    </tr>`;
  }).join('');

  const countStr = sorted.length > 500 ? `${sorted.length} deals (showing 500)` : `${sorted.length} deals`;
  document.getElementById('tablePanelCount').textContent = countStr;
  document.getElementById('listingPanelCount').textContent = `${sorted.length} deals`;
  rebuildMobileCards(sorted);
}

function flyToListing(lat, lng){
  if(isMobile()){
    if(listingsPanelOpen) toggleListingsPanel();
    setSheetState('collapsed');
  }
  map.flyTo([lat, lng], 16, {duration:0.8});
  listingsLayer.eachLayer(layer => {
    if(layer.getLatLng){
      const ll = layer.getLatLng();
      if(Math.abs(ll.lat-lat)<0.0001 && Math.abs(ll.lng-lng)<0.0001) layer.openPopup();
    }
  });
}

// ══════════════════════════════════════════
//  FILTER MACHINERY
// ══════════════════════════════════════════

function initRangeFilter(key, valueFn, dataSource){
  const f = filters[key];
  const source = dataSource || COMPS;
  const values = source.map(valueFn).filter(v => v > 0);
  if(!values.length) return;
  let vMin = Infinity, vMax = -Infinity;
  for(let i=0;i<values.length;i++){ if(values[i]<vMin) vMin=values[i]; if(values[i]>vMax) vMax=values[i]; }
  f.dataMin = Math.floor(vMin / f.step) * f.step;
  f.dataMax = Math.ceil(vMax / f.step) * f.step;
  if(f.cap && f.dataMax > f.cap) f.dataMax = f.cap;
  f.min = f.dataMin; f.max = f.dataMax;
  if(f.defaultMin != null && f.defaultMin >= f.dataMin) f.min = Math.min(f.defaultMin, f.dataMax);
  if(f.defaultMax != null && f.defaultMax <= f.dataMax) f.max = Math.max(f.defaultMax, f.dataMin);

  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  sMin.min=f.dataMin; sMin.max=f.dataMax; sMin.value=f.min; sMin.step=f.step;
  sMax.min=f.dataMin; sMax.max=f.dataMax; sMax.value=f.max; sMax.step=f.step;
  iMin.value=f.min; iMax.value=f.max;
  updateFill(key);

  let timer=null;
  function debounced(){ clearTimeout(timer); timer=setTimeout(applyFilters, 250); }
  sMin.addEventListener('input', function(){
    let v=parseInt(this.value); if(v>parseInt(sMax.value)-f.step) v=parseInt(sMax.value)-f.step;
    this.value=v; iMin.value=v; f.min=v; updateFill(key); debounced();
  });
  sMax.addEventListener('input', function(){
    let v=parseInt(this.value); if(v<parseInt(sMin.value)+f.step) v=parseInt(sMin.value)+f.step;
    this.value=v; iMax.value=v; f.max=v; updateFill(key); debounced();
  });
  iMin.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMin; v=Math.max(f.dataMin,Math.min(v,f.max-f.step));
    this.value=v; sMin.value=v; f.min=v; updateFill(key); applyFilters();
  });
  iMax.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMax; v=Math.min(f.dataMax,Math.max(v,f.min+f.step));
    this.value=v; sMax.value=v; f.max=v; updateFill(key); applyFilters();
  });
}

function updateFill(key){
  const f=filters[key], fill=document.getElementById(key+'SliderFill');
  if(!fill) return;
  const range=f.dataMax-f.dataMin; if(range<=0) return;
  fill.style.left=((f.min-f.dataMin)/range)*100+'%';
  fill.style.width=((f.max-f.min)/range)*100+'%';
}

function applyFilters(){
  rebuildMarkers();
  rebuildListings();
  rebuildZoneToggles();
  updateStats();
  updateFilterCount();
}

function resetFilter(key){
  if(key==='all'){
    ['price','psf','sqft','lot','slope'].forEach(k=>resetFilter(k));
    sb1123Mode=false;
    document.getElementById('sb1123Toggle').classList.remove('active');
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    return;
  }
  const f=filters[key]; f.min=f.dataMin; f.max=f.dataMax;
  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  if(sMin) sMin.value=f.dataMin;
  if(sMax) sMax.value=f.dataMax;
  if(iMin) iMin.value=f.dataMin;
  if(iMax) iMax.value=f.dataMax;
  updateFill(key);
  applyFilters();
}

function onProformaChange(){
  proforma.buildCostPerSf = parseInt(document.getElementById('pfBuildCost').value)||350;
  proforma.avgUnitSf = parseInt(document.getElementById('pfUnitSize').value)||1200;
  proforma.softCostPct = parseInt(document.getElementById('pfSoftCost').value)||25;
  proforma.saleDiscountPct = parseInt(document.getElementById('pfDiscount').value)||5;
  proforma.demoCost = parseInt(document.getElementById('pfDemoCost').value)||25000;
  enrichListings();
  applyFilters();
}

// ── Export ──
function exportCSV(){
  const filtered = getFilteredListings();
  if(!filtered.length) return;
  const headers = ['Fav','Address','Zone','Price','Lot SF','Units','Exit $/SF','Sale/Unit','Buy/Unit','Build/Unit','Profit','Margin %','Slope %','DOM','City','AIN','Notes','URL'];
  const favs = loadFavorites();
  const rows = filtered.map(l=>[
    favs[listingKey(l)]?'*':'', l.address, l.zone, l.price,
    l.lotSf||'', l.maxUnits, l.newconPpsf||l.hoodPpsf||l.ppsf,
    l.salePerUnit||'', l.pricePerUnit||'', l.buildPerUnit||'',
    Math.round(l.estProfit||0), (l.estMargin||0).toFixed(1),
    l.slope!=null?l.slope:'', l.dom!==null?l.dom:'', l.city||'',
    l.ain||'', (favs[listingKey(l)]||{}).notes||'', l.url||''
  ]);
  const csv = [headers,...rows].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='sb1123_deals_export.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ══════════════════════════════════════════
//  INITIALIZATION
// ══════════════════════════════════════════

window.addEventListener('DOMContentLoaded', function(){
  if(typeof LOADED_COMPS !== 'undefined' && LOADED_COMPS.length > 0) COMPS = LOADED_COMPS;
  if(typeof LOADED_LISTINGS !== 'undefined' && LOADED_LISTINGS.length > 0) LISTINGS = LOADED_LISTINGS;

  if(COMPS.length > 0 || LISTINGS.length > 0){
    document.getElementById('loadingBanner').classList.add('active');
    document.getElementById('loadingBanner').textContent =
      `Loading ${COMPS.length.toLocaleString()} comps + ${LISTINGS.length.toLocaleString()} listings...`;

    setTimeout(function(){
      // Enrich listings with deal scores
      enrichListings();

      // Init filters (use comps if available, fall back to listings)
      var filterSource = COMPS.length ? COMPS : LISTINGS;
      initRangeFilter('price', c=>c.price, filterSource);
      initRangeFilter('psf', c=>c.ppsf||Math.round(c.price/c.sqft), filterSource);
      initRangeFilter('sqft', c=>c.sqft, filterSource);
      const lotsWithData = LISTINGS.filter(l=>l.lotSf&&l.lotSf>0);
      if(lotsWithData.length) initRangeFilter('lot', l=>l.lotSf||0, lotsWithData);
      const withSlope = LISTINGS.filter(l=>l.slope!=null);
      if(withSlope.length) initRangeFilter('slope', l=>l.slope!=null?l.slope:0, withSlope);

      // Build $/SF heatmap layer from sold comps
      if(COMPS.length && typeof L.heatLayer === 'function'){
        const heatPts = COMPS.filter(c=>c.ppsf>0).map(c=>{
          // Normalize $/SF to 0-1 intensity (clamped 200-1500 range)
          const intensity = Math.min(1, Math.max(0.05, (c.ppsf - 200) / 1300));
          return [c.lat, c.lng, intensity];
        });
        compHeatLayer = L.heatLayer(heatPts, {
          radius: 25,
          blur: 20,
          maxZoom: 15,
          max: 1.0,
          minOpacity: 0.25,
          pane:'heatmapPane',
          gradient: {0.0:'#1e50b4', 0.15:'#1e88e5', 0.3:'#1ea0b4', 0.45:'#43a047', 0.6:'#b4d232', 0.75:'#f0b41e', 0.88:'#f0641e', 1.0:'#dc2828'}
        });
        document.getElementById('heatCount').textContent = heatPts.length.toLocaleString();
        compCanvasRenderer = L.canvas({padding:0.5});
        compSpatialGrid = buildCompGrid(COMPS);
        map.on('moveend', updateCompPoints);
        map.on('zoomend', updateCompPoints);
      }

      rebuildMarkers();
      rebuildListings();
      rebuildZoneToggles();
      updateStats();
      updateFilterCount();
      updateFavCount();

      // Fit bounds
      const allLats=[...COMPS.map(c=>c.lat),...LISTINGS.map(l=>l.lat)];
      const allLngs=[...COMPS.map(c=>c.lng),...LISTINGS.map(l=>l.lng)];
      if(allLats.length){
        let minLat=Infinity,maxLat=-Infinity,minLng=Infinity,maxLng=-Infinity;
        for(let i=0;i<allLats.length;i++){
          if(allLats[i]<minLat) minLat=allLats[i]; if(allLats[i]>maxLat) maxLat=allLats[i];
          if(allLngs[i]<minLng) minLng=allLngs[i]; if(allLngs[i]>maxLng) maxLng=allLngs[i];
        }
        map.fitBounds([[minLat,minLng],[maxLat,maxLng]],{padding:[50,50]});
      }

      // Auto-open the table panel (desktop only)
      if(!isMobile()) toggleListingsPanel();

      // Set default sort to margin desc
      const th=document.querySelector('.listings-table th[data-sort="estMargin"]');
      if(th){th.classList.add('sorted');th.querySelector('.sort-arrow').textContent='▼';}

      // Data freshness indicator
      if(typeof LISTINGS_META !== 'undefined' && LISTINGS_META.builtAt){
        const built = new Date(LISTINGS_META.builtAt);
        const ago = Math.floor((Date.now() - built.getTime()) / 3600000);
        const freshEl = document.getElementById('dataFreshness');
        if(ago < 24) freshEl.innerHTML = '<span style="color:var(--green)">&#9679;</span> Data updated ' + ago + 'h ago';
        else if(ago < 72) freshEl.innerHTML = '<span style="color:var(--yellow)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' day(s) old';
        else freshEl.innerHTML = '<span style="color:var(--red)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' days stale — re-run fetch';
      }

      document.getElementById('loadingBanner').classList.remove('active');
    }, 100);
  } else {
    rebuildZoneToggles();
    updateStats();
  }
});

// ══════════════════════════════════════════
//  MOBILE OPTIMIZATION
// ══════════════════════════════════════════

function isMobile() { return window.innerWidth <= 768; }
var sheetState = 'collapsed';

function setSheetState(state) {
  if (!isMobile()) return;
  var sidebar = document.querySelector('.sidebar');
  sheetState = state;
  sidebar.classList.remove('sheet-half', 'sheet-full');
  if (state === 'half') sidebar.classList.add('sheet-half');
  else if (state === 'full') sidebar.classList.add('sheet-full');
  if (state === 'collapsed') sidebar.scrollTop = 0;
}

function openMobileSheet() {
  setSheetState('full');
}

function updatePeekStats() {
  var el = document.getElementById('peekEligible');
  var ml = document.getElementById('peekMargin');
  if (!el || !ml) return;
  el.textContent = document.getElementById('sb1123Count').textContent;
  ml.textContent = document.getElementById('avgMargin').textContent;
}

function rebuildMobileCards(sorted) {
  var container = document.getElementById('mobileCards');
  if (!container) return;
  var display = sorted.slice(0, 200);
  container.innerHTML = display.map(function(l) {
    var marginClass = (l.estMargin || 0) >= 0 ? 'profit-pos' : 'profit-neg';
    var profitK = Math.round((l.estProfit || 0) / 1000);
    var profitStr = profitK >= 0 ? '+$' + profitK.toLocaleString() + 'K' : '-$' + Math.abs(profitK).toLocaleString() + 'K';
    return '<div class="mobile-card" onclick="flyToListing(' + l.lat + ',' + l.lng + ')">' +
      '<div class="card-addr">' + l.address + '</div>' +
      '<div class="card-grid">' +
        '<div class="card-row"><span class="card-label">Zone</span><span class="card-value" style="color:' + (ZONE_COLORS[l.zone] || '#666') + '">' + (l.zone || '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Price</span><span class="card-value">$' + l.price.toLocaleString() + '</span></div>' +
        '<div class="card-row"><span class="card-label">Lot</span><span class="card-value">' + (l.lotSf ? l.lotSf.toLocaleString() + ' sf' : '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Units</span><span class="card-value">' + l.maxUnits + '</span></div>' +
      '</div>' +
      '<div class="card-margin-row">' +
        '<span class="card-profit ' + marginClass + '">' + profitStr + '</span>' +
        '<span class="card-margin ' + marginClass + '">' + (l.estMargin || 0).toFixed(0) + '%</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

// Sheet touch drag
(function initSheetDrag() {
  var handle = document.getElementById('sheetHandle');
  if (!handle) return;
  var startY, startH, sidebar, isDragging;

  handle.addEventListener('touchstart', function(e) {
    if (!isMobile()) return;
    isDragging = false;
    sidebar = document.querySelector('.sidebar');
    startY = e.touches[0].clientY;
    startH = sidebar.offsetHeight;
    sidebar.style.transition = 'none';
  }, { passive: true });

  handle.addEventListener('touchmove', function(e) {
    if (!isMobile() || !sidebar) return;
    isDragging = true;
    var dy = startY - e.touches[0].clientY;
    var newH = Math.max(56, Math.min(window.innerHeight * 0.85, startH + dy));
    sidebar.style.height = newH + 'px';
    e.preventDefault();
  }, { passive: false });

  handle.addEventListener('touchend', function() {
    if (!isMobile() || !sidebar) return;
    sidebar.style.transition = '';
    if (!isDragging) {
      // Tap: toggle between collapsed and half
      if (sheetState === 'collapsed') setSheetState('half');
      else setSheetState('collapsed');
      sidebar.style.height = '';
      return;
    }
    var h = sidebar.offsetHeight;
    var vh = window.innerHeight;
    if (h < vh * 0.2) setSheetState('collapsed');
    else if (h < vh * 0.6) setSheetState('half');
    else setSheetState('full');
    sidebar.style.height = '';
  });
})();

// Tap map to collapse sheet
map.on('click', function() {
  if (isMobile() && sheetState !== 'collapsed') {
    setSheetState('collapsed');
  }
});
</script>
</body>
</html>
