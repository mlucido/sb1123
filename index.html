<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SB 1123 Deal Finder ‚Äî LA County</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js" onerror="console.warn('esri-leaflet failed to load')"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script>
// Market config ‚Äî select via ?market=sd URL param (default: la)
var _urlMarket = new URLSearchParams(window.location.search).get('market') || 'la';
var MARKET_CONFIG = {
  la: { name:'Los Angeles', slug:'la', center:[34.05,-118.35], zoom:11,
        dataFile:'data.js', listingsFile:'listings.js', rentalDataFile:'rental_data.js',
        burnZones:true, burnZoneLabel:'Palisades + Eaton',
        hasZimas:true,
        hazardsUrl:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Dynamic/Hazards/MapServer',
        parcelUrl:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer',
        subtitle:'Townhome development sites in Los Angeles' },
  sd: { name:'San Diego', slug:'sd', center:[32.77,-117.15], zoom:10,
        dataFile:'sd_data.js', listingsFile:'sd_listings.js', rentalDataFile:'sd_rental_data.js',
        burnZones:false, burnZoneLabel:'',
        hasZimas:false,
        hazardsUrl:null, parcelUrl:null,
        subtitle:'Townhome development sites in San Diego' }
};
var MARKET = MARKET_CONFIG[_urlMarket] || MARKET_CONFIG.la;
document.title = 'SB 1123 Deal Finder ‚Äî ' + MARKET.name;

// Mobile: skip 25MB comps file, load only listings (already has pre-computed $/SF)
// Desktop: load both
var _isMob = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
if(!_isMob){
  document.write('<script src="'+MARKET.dataFile+'?v=7"><\/script>');
}
document.write('<script src="'+MARKET.listingsFile+'?v=7"><\/script>');
document.write('<script src="'+(MARKET.rentalDataFile||'rental_data.js')+'?v=7"><\/script>');
window.LOADED_COMPS = window.LOADED_COMPS || [];
window.LOADED_LISTINGS = window.LOADED_LISTINGS || [];
window.CLUSTERS = window.CLUSTERS || [];
window.LOADED_RENTAL_COMPS = window.LOADED_RENTAL_COMPS || [];
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,500;9..40,700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --r1:#2563eb;--r2:#16a34a;--r3:#ea580c;--r4:#9333ea;--land:#b45309;
    --listing:#f43f5e;
    --bg:#0f1117;--surface:#1a1d27;--surface2:#252833;
    --border:#2e3140;--text:#e4e6ed;--text-dim:#8b8fa3;--accent:#60a5fa;
    --green:#22c55e;--red:#ef4444;--yellow:#facc15;--orange:#f97316;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
  body.light-mode{
    --bg:#f5f5f5;--surface:#ffffff;--surface2:#e8e8e8;
    --border:#d0d0d0;--text:#1a1a2e;--text-dim:#666;--accent:#2563eb;
  }
  .mono{font-family:'JetBrains Mono',monospace}

  .app-row{display:flex;flex:1;overflow:hidden}

  /* (hero-stats removed ‚Äî stats now in sidebar pills) */
  .onboarding-tip{position:absolute;top:140px;left:50%;transform:translateX(-50%);max-width:500px;background:#fff;border:2px solid var(--green);border-radius:8px;padding:12px 40px 12px 16px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:2000;font-size:13px;line-height:1.5;animation:slideIn 0.3s ease-out}
  .onboarding-tip .close-btn{position:absolute;top:8px;right:8px;background:none;border:none;font-size:20px;color:var(--text-dim);cursor:pointer;padding:4px 8px;line-height:1}
  .onboarding-tip .close-btn:hover{color:var(--text)}
  @keyframes slideIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar{width:360px;min-width:360px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:1000;overflow:hidden}
  .sidebar-header{padding:20px 20px 14px;border-bottom:1px solid var(--border)}
  .sidebar-header h1{font-size:17px;font-weight:700;letter-spacing:-0.02em;margin-bottom:2px}
  .sidebar-header h1 span{color:var(--green)}
  .sidebar-header p{font-size:11px;color:var(--text-dim);line-height:1.5}
  .sidebar-header .law-ref{font-size:10px;color:var(--accent);margin-top:4px;opacity:0.7}

  /* Stat pills */
  .stat-pills{display:flex;gap:8px;margin-top:8px}
  .pill{flex:1;text-align:center;padding:6px 0;border-radius:6px;background:#f1f5f9}
  .pill-val{display:block;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:#1e293b}
  .pill-label{display:block;font-size:9px;color:#94a3b8;margin-top:1px}

  /* Sidebar scroll wrapper */
  .sidebar-scroll{flex:1;overflow-y:auto;padding-bottom:80px}

  /* Accordion headers */
  .accordion-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;cursor:pointer;background:#f8fafc;border-bottom:1px solid #e2e8f0}
  .accordion-header .label{font-size:11px;font-weight:700;letter-spacing:0.08em;color:#475569;text-transform:uppercase}
  .accordion-header .acc-right{display:flex;align-items:center;gap:8px}
  .accordion-header .acc-dim{font-size:10px;color:#94a3b8;font-weight:400;text-transform:none;letter-spacing:0}
  .accordion-header .acc-reset{font-size:10px;color:#3b82f6;cursor:pointer;font-weight:500;text-transform:none;letter-spacing:0}
  .accordion-header .acc-reset:hover{text-decoration:underline}
  .accordion-header .chevron{color:#94a3b8;font-size:10px;transition:transform 0.2s}
  .accordion-section.collapsed .accordion-header .chevron{transform:rotate(-90deg)}
  .accordion-section.collapsed .accordion-body{display:none}
  .accordion-body{padding:8px 10px}

  /* Layer rows (primary) */
  .layer-row{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:1px solid #e2e8f0;cursor:pointer;font-size:11px;font-weight:500;margin-bottom:4px;transition:all 0.15s;font-family:inherit;background:transparent;width:100%;color:var(--text)}
  .layer-row:hover{border-color:#94a3b8}
  .layer-row .ldot{width:8px;height:8px;border-radius:50%;background:#cbd5e1;flex-shrink:0;transition:background 0.15s}
  .layer-row .lname{flex:1;text-align:left}
  .layer-row .lcount{font-family:'JetBrains Mono',monospace;font-size:10px;color:#94a3b8}

  /* Layer grid (2-col for secondary layers) */
  .layer-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
  .layer-cell{display:flex;align-items:center;gap:6px;padding:7px 8px;border-radius:6px;border:1px solid #e2e8f0;cursor:pointer;font-size:11px;font-weight:500;transition:all 0.15s;font-family:inherit;background:transparent;color:var(--text)}
  .layer-cell:hover{border-color:#94a3b8}
  .layer-cell .ldot{width:8px;height:8px;border-radius:50%;background:#cbd5e1;flex-shrink:0;transition:background 0.15s}
  .layer-cell .lname{flex:1}
  .layer-cell .lcount{font-family:'JetBrains Mono',monospace;font-size:10px;color:#94a3b8}

  /* Overlay chips */
  .overlay-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
  .chip-btn{font-size:10px;padding:3px 8px;border-radius:10px;border:1px solid #e2e8f0;color:#64748b;cursor:pointer;transition:all 0.15s;font-family:inherit;background:transparent}
  .chip-btn:hover{border-color:#94a3b8}
  .chip-btn.active{background:rgba(96,165,250,0.1);border-color:#3b82f6;color:#3b82f6}

  /* Zoning compact row */
  .zoning-bar{display:flex;align-items:center;gap:8px;margin-top:10px;padding:6px 8px;border-radius:6px;background:#f8fafc}
  .zoning-bar .zone-sw{width:12px;height:12px;border-radius:3px;background:#3b82f6;flex-shrink:0}
  .zoning-bar .zone-name{font-size:11px;font-weight:500}
  .zoning-bar .zone-psf{font-family:'JetBrains Mono',monospace;font-size:10px;color:#94a3b8}
  .zoning-bar .zone-expand{font-size:10px;color:#64748b;margin-left:auto;cursor:pointer;background:none;border:none;font-family:inherit;padding:0}
  .zoning-bar .zone-expand:hover{color:#3b82f6}

  /* Sticky bottom bar */
  .sidebar-bottom{display:flex;flex-direction:column;gap:6px;padding:10px 14px;border-top:1px solid #e2e8f0;background:#fff;flex-shrink:0}
  .sidebar-bottom .bottom-row{display:flex;gap:6px}
  .bottom-btn{flex:1;padding:8px;font-size:11px;font-weight:600;border:1px solid #e2e8f0;border-radius:6px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;font-family:inherit;color:var(--text);transition:all 0.15s}
  .bottom-btn:hover{border-color:#94a3b8}
  .bottom-btn.active{border-color:#facc15;background:rgba(250,204,21,0.08)}
  .bottom-btn.gear{padding:8px 10px;flex:none;font-size:16px}
  .basemap-row{display:flex;justify-content:center;gap:12px;margin-top:8px}
  .basemap-link{font-size:10px;cursor:pointer;color:#94a3b8;background:none;border:none;font-family:inherit;padding:0;transition:color 0.15s}
  .basemap-link:hover{color:#3b82f6}
  .basemap-link.active{color:#3b82f6;font-weight:600}
  .basemap-dot{color:#94a3b8;font-size:8px}

  /* Key filter labels */
  .kf-header{display:flex;align-items:center;margin-bottom:6px}
  .kf-label{font-size:11px;font-weight:600;color:var(--text)}
  .kf-chips{display:flex;gap:4px;margin-left:auto}
  .kf-chip{font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all 0.15s}
  .kf-chip.active{background:#dcfce7;color:#16a34a}
  .kf-chip:not(.active){background:#e2e8f0;color:#94a3b8}
  .kf-chip:hover:not(.active){background:#e2e8f0;color:#64748b}
  .kf-range-labels{display:flex;justify-content:space-between;font-size:10px;color:#94a3b8;margin-bottom:6px}
  .kf-block{margin-bottom:14px}

  /* Secondary filter rows */
  .sf-list{border-top:1px solid #e2e8f0;margin-top:10px;padding-top:8px}
  .sf-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:11px;color:#64748b;cursor:pointer}
  .sf-row:hover{color:var(--text)}
  .sf-row .sf-chevron{color:#cbd5e1;font-size:10px;transition:transform 0.2s}
  .sf-row.expanded .sf-chevron{transform:rotate(90deg)}
  .sf-body{display:none;padding:4px 0 8px}
  .sf-row.expanded+.sf-body{display:block}

  .section{padding:14px 20px;border-bottom:1px solid var(--border)}
  .section-title{font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:6px}
  .section-title .badge{background:var(--green);color:#000;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700;letter-spacing:0.03em}

  /* Stats grid */
  .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .stats-grid.two-col{grid-template-columns:1fr 1fr}
  .stat-card{background:var(--surface2);border-radius:8px;padding:10px 12px}
  .stat-card .stat-value{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;color:var(--accent)}
  .stat-card .stat-value.green{color:var(--green)}
  .stat-card .stat-value.yellow{color:var(--yellow)}
  .stat-card .stat-value.red{color:var(--red)}
  .stat-card .stat-label{font-size:10px;color:var(--text-dim);margin-top:2px}

  /* SB9 mode toggle */
  .mode-toggle{
    display:flex;align-items:center;gap:10px;padding:10px 14px;
    border-radius:8px;cursor:pointer;transition:all 0.2s;
    border:1px solid var(--border);background:transparent;width:100%;
    font-family:inherit;font-size:13px;color:var(--text);
  }
  .mode-toggle:hover{border-color:var(--green);background:rgba(34,197,94,0.04)}
  .mode-toggle.active{border-color:var(--green);background:rgba(34,197,94,0.08)}
  .mode-toggle .toggle-track{
    width:36px;height:20px;border-radius:10px;background:var(--surface2);
    border:1px solid var(--border);position:relative;transition:all 0.2s;flex-shrink:0;
  }
  .mode-toggle.active .toggle-track{background:var(--green);border-color:var(--green)}
  .mode-toggle .toggle-thumb{
    width:16px;height:16px;border-radius:50%;background:#fff;
    position:absolute;top:1px;left:1px;transition:all 0.2s;
  }
  .mode-toggle.active .toggle-thumb{left:17px}
  .mode-toggle .toggle-label{flex:1}
  .mode-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Zone toggles */
  .zone-toggle{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background 0.15s;margin-bottom:2px}
  .zone-toggle:hover{background:var(--surface2)}
  .zone-swatch{width:12px;height:12px;border-radius:3px;flex-shrink:0}
  .zone-toggle input[type="checkbox"]{display:none}
  .zone-toggle .check-box{width:16px;height:16px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
  .zone-toggle input:checked+.check-box{border-color:var(--accent);background:var(--accent)}
  .zone-toggle input:checked+.check-box::after{content:'‚úì';color:#fff;font-size:10px;font-weight:700}
  .zone-label{font-size:12px;flex:1}
  .zone-label small{color:var(--text-dim);font-size:10px}
  .zone-stat{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim)}
  .data-count{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);background:rgba(96,165,250,0.1);padding:1px 5px;border-radius:3px;margin-left:3px}

  /* Basemap toggle */
  .basemap-group{display:flex;gap:4px}
  .basemap-btn{flex:1;padding:6px 0;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:11px;font-weight:500;transition:all 0.15s}
  .basemap-btn:hover{border-color:var(--accent)}
  .basemap-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.15);color:var(--accent)}

  /* Layer buttons */
  .layer-btn{display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:12px;margin-bottom:4px;transition:all 0.15s}
  .layer-btn:hover{border-color:var(--accent)}
  .layer-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.08)}
  .layer-btn .icon{font-size:14px}
  .layer-btn .layer-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);margin-left:auto}

  /* Range filters */
  .range-filter{margin-top:2px}
  .range-inputs{display:flex;gap:6px;align-items:center;margin-bottom:8px}
  .range-inputs input[type="number"]{
    width:100%;padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;
    outline:none;transition:border 0.15s;
  }
  .range-inputs input[type="number"]:focus{border-color:var(--accent)}
  .range-inputs .separator{color:var(--text-dim);font-size:12px;flex-shrink:0}
  .range-inputs .input-group{flex:1}
  .range-inputs .input-label{font-size:9px;color:var(--text-dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.08em}

  .range-slider-track{position:relative;height:4px;background:#e2e8f0;border-radius:2px;margin:0 4px 10px}
  .range-slider-fill{position:absolute;height:100%;background:var(--accent);border-radius:2px;opacity:0.4}
  .range-slider-track input[type="range"]{
    position:absolute;width:100%;height:4px;top:0;
    -webkit-appearance:none;appearance:none;background:transparent;pointer-events:none;margin:0;
  }
  .range-slider-track input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;pointer-events:auto;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);margin-top:-6px;
  }
  .range-slider-track input[type="range"]::-moz-range-thumb{
    width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;pointer-events:auto;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);
  }
  /* Standalone single slider (Min Units) */
  input[type="range"].standalone-slider{
    -webkit-appearance:none;appearance:none;width:100%;height:4px;
    background:#e2e8f0;border-radius:2px;outline:none;margin:0;
  }
  input[type="range"].standalone-slider::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);margin-top:-6px;
  }
  input[type="range"].standalone-slider::-moz-range-thumb{
    width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);
  }

  .filter-count{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);text-align:center;padding:6px 0;background:rgba(96,165,250,0.06);border-radius:6px}
  .reset-btn{
    display:block;width:100%;padding:6px;margin-top:6px;background:transparent;
    border:1px solid var(--border);border-radius:6px;color:var(--text-dim);
    font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;text-align:center;
  }
  .reset-btn:hover{border-color:var(--accent);color:var(--accent)}

  /* Pro forma assumptions */
  .proforma-inputs{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .proforma-group{display:flex;flex-direction:column;gap:2px}
  .proforma-group label{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em}
  .proforma-group input{
    padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;
    outline:none;width:100%;
  }
  .proforma-group input:focus{border-color:var(--accent)}

  /* Quick presets */
  .preset-row{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
  .preset-btn{
    padding:4px 10px;border:1px solid var(--border);border-radius:4px;
    background:transparent;color:var(--text-dim);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;
  }
  .preset-btn:hover{border-color:var(--green);color:var(--green)}
  .preset-btn.active{border-color:var(--green);background:rgba(34,197,94,0.1);color:var(--green)}

  /* Map */
  #map{flex:1;height:100%;z-index:1}

  /* Popups */
  .leaflet-popup-content-wrapper{background:var(--surface)!important;color:var(--text)!important;border-radius:10px!important;border:1px solid var(--border)!important;box-shadow:0 8px 32px rgba(0,0,0,0.5)!important}
  .leaflet-popup-tip{background:var(--surface)!important}
  .leaflet-popup-content{font-family:'DM Sans',sans-serif!important;margin:12px 14px!important;min-width:340px;max-width:750px}
  .dark-popup .leaflet-popup-content{min-width:260px}
  .popup-two-col{display:flex;gap:14px;max-height:75vh;width:710px}
  .popup-col-left,.popup-col-right{flex:1;min-width:0;overflow-y:auto;padding-right:4px}
  .popup-col-left::-webkit-scrollbar,.popup-col-right::-webkit-scrollbar{width:4px}
  .popup-col-left::-webkit-scrollbar-thumb,.popup-col-right::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
  .popup-col-left::-webkit-scrollbar-track,.popup-col-right::-webkit-scrollbar-track{background:transparent}
  .popup-title{font-weight:700;font-size:14px;margin-bottom:8px;line-height:1.3}
  .popup-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;margin-right:4px}
  .popup-badge.comp{background:rgba(96,165,250,0.15);color:var(--accent)}
  .popup-badge.listing{background:rgba(244,63,94,0.15);color:var(--listing)}
  .popup-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:3px 10px}
  .popup-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:3px 10px}
  .popup-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:3px 12px}
  .popup-label{font-size:10px;color:var(--text-dim);line-height:1.2}
  .popup-value{font-family:'JetBrains Mono',monospace;font-size:11.5px;font-weight:600;line-height:1.3}
  .popup-divider{grid-column:1/-1;border-top:1px solid var(--border);margin:5px 0 3px 0}
  .popup-section-label{grid-column:1/-1;font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);font-weight:700;margin-top:2px;margin-bottom:2px}
  .popup-span-2{grid-column:span 2}
  .popup-span-3{grid-column:span 3}
  .popup-span-4{grid-column:span 4}
  .popup-profit-positive{color:var(--green)}
  .popup-profit-negative{color:var(--red)}
  .lot-layout-toggle{grid-column:1/-1;cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);font-weight:700;margin-top:4px;padding:4px 0;display:flex;align-items:center;gap:6px;border-top:1px solid var(--border)}
  .lot-layout-toggle:hover{color:var(--text)}
  .lot-layout-toggle .tri{font-size:8px;transition:transform 0.2s}
  .lot-layout-toggle.open .tri{transform:rotate(90deg)}
  .lot-layout-body{grid-column:1/-1;overflow:hidden;max-height:0;transition:max-height 0.4s ease-out}
  .lot-layout-body.open{max-height:2000px;transition:max-height 0.5s ease-in}
  .lot-layout-body svg{display:block;margin:4px auto 0;max-width:100%}
  /* Deal Scorecard */
  .popup-scorecard{display:grid;grid-template-columns:repeat(4,1fr);gap:2px 8px;padding:6px 8px;margin-bottom:8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px}
  .popup-scorecard .sc-label{font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);line-height:1.2}
  .popup-scorecard .sc-value{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;line-height:1.3}
  /* Action links bar */
  .popup-links{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:8px}
  .popup-links a{color:var(--accent);font-size:10px;text-decoration:none;white-space:nowrap}
  .popup-links a:hover{text-decoration:underline}
  /* Collapsible toggle (generic) */
  .popup-collapse-toggle{cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;padding:2px 0;display:flex;align-items:center;gap:5px}
  .popup-collapse-toggle:hover{color:var(--text)}
  .popup-collapse-toggle .tri{font-size:8px;transition:transform 0.2s}
  .popup-collapse-toggle.open .tri{transform:rotate(90deg)}
  .popup-collapse-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease-out}
  .popup-collapse-body.open{max-height:800px;transition:max-height 0.4s ease-in}

  /* Deal Card v2 */
  .deal-popup .leaflet-popup-content-wrapper{overflow:visible!important}
  .deal-popup .leaflet-popup-content{min-width:560px;max-width:660px;margin:0!important;padding:0!important;overflow:visible!important}
  .dp-card{font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text)}

  /* Strip (always visible) */
  .dp-strip{display:grid;grid-template-columns:1.8fr repeat(4,1fr) 40px;align-items:center;gap:0;padding:10px 12px;cursor:pointer;border:1px solid var(--border);border-radius:6px;margin:6px 6px 0}
  .dp-strip:hover{background:var(--surface2)}
  .dp-addr{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;line-height:1.25;text-transform:capitalize}
  .dp-addr .dp-city{font-weight:400;font-size:11px;color:var(--text-dim)}
  .dp-addr .dp-zip{color:#888;font-weight:500;font-size:11px}
  .dp-addr .dp-badges-inline{display:flex;gap:4px;margin-left:auto;flex-shrink:0}
  .dp-addr .dp-badges-inline .popup-badge{margin:0;font-size:9px;padding:1px 6px}
  .dp-metric{text-align:center}
  .dp-metric .dp-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:2px}
  .dp-metric .dp-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;line-height:1.2}
  .dp-toggle{display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--text-dim);transition:transform 0.2s}
  .dp-card.expanded .dp-toggle{transform:rotate(180deg)}

  /* Alert badges row (burn zone, tenant risk etc) */
  .dp-alerts{display:flex;gap:4px;flex-wrap:wrap;padding:4px 8px 0}

  /* Drawer (hidden until expanded) */
  .dp-drawer{max-height:0;overflow:hidden;transition:max-height 0.35s ease-out}
  .dp-card.expanded .dp-drawer{max-height:3000px;transition:max-height 0.4s ease-in}

  /* 3-column body */
  .dp-body{display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:0;margin:6px 6px 0;border:1px solid var(--border);border-radius:6px;overflow:hidden}
  .dp-col{min-width:0;padding:8px 10px}
  .dp-col+.dp-col{border-left:1px solid var(--border)}
  .dp-col-head{font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin-bottom:6px}
  .dp-row{display:flex;justify-content:space-between;font-size:11px;line-height:1.7}
  .dp-row .dp-k{color:var(--text-dim);white-space:nowrap}
  .dp-row .dp-v{font-family:'JetBrains Mono',monospace;font-weight:600;text-align:right;white-space:nowrap}
  .dp-sep{border-top:1px solid var(--border);margin:4px 0}

  /* Comp buttons */
  .dp-comps{display:flex;gap:16px;padding:6px 8px 0;align-items:center}
  .dp-comp-btn{display:inline-flex;align-items:center;background:none;border:none;padding:0;cursor:pointer;font-family:inherit;font-size:11.5px;font-weight:600;color:#2563eb;text-decoration:none;white-space:nowrap;line-height:1.3}
  .dp-comp-btn:hover{text-decoration:underline}
  .dp-comp-arrow{font-size:10px}

  /* BTR section */
  .dp-btr{display:grid;grid-template-columns:1fr 1fr;gap:0;margin:8px 8px 0;border:1px solid var(--border);border-radius:6px;overflow:hidden}
  .dp-btr-col{padding:8px 10px}
  .dp-btr-col+.dp-btr-col{border-left:1px solid var(--border)}
  .dp-btr .dp-row .dp-k{color:var(--text-dim)}

  /* DD bar */
  .dp-dd{padding:8px 12px;font-size:11px;color:var(--text-dim);margin:8px 6px 0;line-height:1.5}

  /* Action buttons toolbar */
  .dp-actions{display:flex;justify-content:space-around;background:#fafafa;border-top:1px solid #e5e7eb;border-radius:0 0 6px 6px;padding:6px 8px;margin-top:4px;gap:0}
  .dp-actions a,.dp-actions button{display:flex;flex-direction:column;align-items:center;gap:1px;padding:4px 10px;background:none;border:none;border-radius:6px;color:#64748b;font-family:inherit;font-size:8px;text-transform:uppercase;letter-spacing:0.04em;cursor:pointer;text-decoration:none;line-height:1.2}
  .dp-actions a:hover,.dp-actions button:hover{background:#e5e7eb}
  .dp-actions .dp-icon{font-size:13px;line-height:1}
  .dp-actions .active{border:none;background:none;color:#f59e0b}
  .dp-actions .active:hover{background:#e5e7eb}
  .dp-actions .active .dp-icon{color:#f59e0b}

  /* Lot layout toggle in drawer */
  .dp-lot-toggle{cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin-top:4px;display:flex;align-items:center;gap:5px}
  .dp-lot-toggle:hover{color:var(--text)}
  .dp-lot-toggle .tri{font-size:8px;transition:transform 0.2s}
  .dp-lot-toggle.open .tri{transform:rotate(90deg)}
  .dp-lot-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease-out}
  .dp-lot-body.open{max-height:2000px;transition:max-height 0.4s ease-in}
  .dp-lot-body svg{display:block;margin:4px auto 0;max-width:100%}

  @media (max-width: 768px){
    .deal-popup .leaflet-popup-content{min-width:320px}
    .dp-body{grid-template-columns:1fr;gap:0}
    .dp-col+.dp-col{border-left:none;border-top:1px solid var(--border)}
    .dp-strip{grid-template-columns:1.5fr repeat(2,1fr) 36px;font-size:11px}
    .dp-strip .dp-metric:nth-child(4),.dp-strip .dp-metric:nth-child(5){display:none}
    .dp-btr{grid-template-columns:1fr}
    .dp-btr-col+.dp-btr-col{border-left:none;border-top:1px solid var(--border)}
    .dp-actions{flex-wrap:wrap}
  }

  /* Pin Color Legend */
  .pin-legend{
    position:absolute;bottom:10px;left:10px;
    background:rgba(26,29,39,0.92);border:1px solid var(--border);border-radius:8px;
    padding:8px 10px;z-index:850;font-size:10px;box-shadow:0 2px 12px rgba(0,0,0,0.4);
  }
  body.light-mode .pin-legend{background:rgba(255,255,255,0.92)}
  .pin-legend-item{display:flex;align-items:center;gap:6px;margin-bottom:2px;line-height:1.4}
  .pin-legend-item:last-child{margin-bottom:0}
  .pin-legend-marker{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .pin-legend-marker.diamond{border-radius:0;transform:rotate(45deg);border:1.5px dashed #d97706;background:rgba(245,158,11,0.85)}
  .pin-legend-marker.circle{border:2px solid #666;background:transparent}
  .pin-legend-section{border-top:1px solid var(--border);margin:4px 0;padding-top:4px}
  .pin-legend-gradient{height:8px;border-radius:4px;margin:3px 0}
  .pin-legend-gradient-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim)}

  /* Old Legend (keep for desktop reference) */
  .map-legend{position:absolute;bottom:30px;right:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;z-index:800;font-size:11px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:none}
  .legend-item{display:flex;align-items:center;gap:8px;margin-bottom:3px}
  .legend-item:last-child{margin-bottom:0}
  .legend-dot{width:10px;height:10px;border-radius:2px}
  .legend-section{font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);margin:6px 0 3px;font-weight:700}

  .sidebar::-webkit-scrollbar{width:6px}
  .sidebar::-webkit-scrollbar-track{background:transparent}
  .sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .loading-banner{padding:10px 20px;background:rgba(96,165,250,0.1);border-bottom:1px solid var(--border);font-size:12px;color:var(--accent);text-align:center;display:none}
  .loading-banner.active{display:block}

  /* ‚îÄ‚îÄ Listings Table Panel ‚îÄ‚îÄ */
  .listings-panel{
    position:relative;height:0;min-height:0;background:var(--surface);
    border-top:1px solid var(--border);transition:height 0.3s ease, min-height 0.3s ease;
    overflow:hidden;z-index:900;
  }
  .listings-panel.open{height:360px;min-height:200px}
  .listings-panel-header{
    display:flex;align-items:center;gap:10px;padding:8px 20px;
    border-bottom:1px solid var(--border);background:var(--surface);
    position:sticky;top:0;z-index:2;
  }
  .listings-panel-header h2{font-size:13px;font-weight:700;letter-spacing:-0.01em}
  .listings-panel-header h2 span{color:var(--green)}
  .listings-panel-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);background:rgba(96,165,250,0.1);padding:2px 6px;border-radius:4px}
  .listings-panel-close{margin-left:auto;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:4px 8px;border-radius:4px;transition:all 0.15s}
  .listings-panel-close:hover{color:var(--text);background:var(--surface2)}
  .listings-panel-tab{
    position:absolute;bottom:0;left:50%;transform:translateX(-50%);
    background:var(--surface);border:1px solid var(--border);border-bottom:none;
    border-radius:8px 8px 0 0;padding:5px 18px;cursor:pointer;z-index:901;
    display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;
    color:var(--text-dim);transition:all 0.15s;
  }
  .listings-panel-tab:hover{color:var(--text);background:var(--surface2)}
  .listings-panel-tab .tab-arrow{font-size:9px}
  .listings-panel-tab .tab-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent)}
  .listings-panel-resize{position:absolute;top:0;left:0;right:0;height:5px;cursor:ns-resize;z-index:3}
  .listings-panel-resize:hover{background:var(--accent);opacity:0.3}
  .listings-table-wrap{overflow:auto;height:calc(100% - 41px)}
  .listings-table-wrap::-webkit-scrollbar{width:6px;height:6px}
  .listings-table-wrap::-webkit-scrollbar-track{background:transparent}
  .listings-table-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .listings-table{width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed;min-width:1300px}
  .listings-table thead{position:sticky;top:0;z-index:1}
  .listings-table th{
    background:var(--surface2);padding:7px 10px;text-align:left;font-size:9px;
    text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-weight:700;
    cursor:pointer;white-space:nowrap;border-bottom:1px solid var(--border);
    user-select:none;transition:color 0.15s;position:relative;
  }
  .listings-table th:hover{color:var(--accent)}
  .listings-table th.sorted{color:var(--accent)}
  .listings-table th .sort-arrow{display:inline-block;margin-left:3px;font-size:8px;opacity:0;transition:opacity 0.15s}
  .listings-table th.sorted .sort-arrow{opacity:1}
  .listings-table th:hover .sort-arrow{opacity:0.5}
  .listings-table td{padding:6px 10px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .listings-table tr{transition:background 0.1s}
  .listings-table tbody tr:hover{background:var(--surface2);cursor:pointer}

  .listings-table .col-addr{width:230px}
  .listings-table .col-zone{width:50px}
  .listings-table .col-price{width:95px}
  .listings-table .col-lot{width:75px}
  .listings-table .col-lotw{width:50px;text-align:right}
  .listings-table .col-units{width:55px}
  .listings-table .col-hood{width:80px}
  .listings-table .col-sale{width:90px}
  .listings-table .col-ppu{width:90px}
  .listings-table .col-profit{width:90px}
  .listings-table .col-margin{width:65px}
  .listings-table .col-slope{width:60px}
  .listings-table .col-dom{width:45px}
  .listings-table .col-new{width:40px;text-align:center}
  .listings-table .col-link{width:45px}

  .listings-table .zone-pill{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:0.03em}
  .listings-table .redfin-link{color:var(--accent);text-decoration:none;font-size:10px}
  .listings-table .redfin-link:hover{text-decoration:underline}
  .listings-table .profit-pos{color:var(--green)}
  .listings-table .profit-neg{color:var(--red)}

  /* NEW listing badge */
  .new-badge{display:inline-block;padding:1px 6px;border-radius:9px;font-size:9px;font-weight:700;letter-spacing:0.04em;background:#22c55e;color:#fff;vertical-align:middle;margin-left:4px;line-height:1.4}
  .new-badge.week{background:#0ea5e9}
  .listing-marker-new{animation:newPulse 2s ease-in-out infinite}
  @keyframes newPulse{0%,100%{filter:drop-shadow(0 0 4px rgba(34,197,94,0.6))}50%{filter:drop-shadow(0 0 10px rgba(34,197,94,0.9))}}
  .marker-highlight{animation:markerPulse .5s ease-in-out infinite;transform-origin:center;transform-box:fill-box}
  @keyframes markerPulse{0%,100%{transform:scale(1);filter:drop-shadow(0 0 6px #fff)}50%{transform:scale(1.8);filter:drop-shadow(0 0 12px #fff)}}

  /* Panel toggle in sidebar */
  .panel-toggle{
    display:flex;align-items:center;justify-content:space-between;width:100%;
    padding:10px 12px;border:1px solid var(--green);border-radius:8px;
    background:rgba(34,197,94,0.06);color:var(--text);cursor:pointer;
    font-family:inherit;font-size:13px;transition:all 0.15s;
  }
  .panel-toggle:hover{background:rgba(34,197,94,0.12)}
  .panel-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Collapsible sections */
  .section.collapsed .section-content{display:none}
  .section-title{cursor:pointer}
  .section-title .chevron{transition:transform 0.2s;font-size:10px;margin-left:auto;color:var(--text-dim)}
  .section.collapsed .section-title .chevron{transform:rotate(-90deg)}

  /* (export-btn removed ‚Äî export now in bottom bar) */
  .refresh-btn{
    padding:4px 10px;background:rgba(34,197,94,0.1);border:1px solid var(--green);
    border-radius:4px;color:var(--green);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;white-space:nowrap;
  }
  .refresh-btn:hover{background:rgba(34,197,94,0.2)}
  .analytics-btn{
    padding:4px 10px;background:rgba(96,165,250,0.1);border:1px solid var(--accent);
    border-radius:4px;color:var(--accent);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;white-space:nowrap;text-decoration:none;
  }
  .analytics-btn:hover{background:rgba(96,165,250,0.2)}

  /* Favorites */
  .listings-table .col-fav{width:32px;text-align:center;cursor:pointer}
  .fav-star{font-size:14px;cursor:pointer;opacity:0.3;transition:all 0.15s;user-select:none}
  .fav-star:hover{opacity:0.7;transform:scale(1.2)}
  .fav-star.active{opacity:1;color:#facc15}
  .fav-toggle{
    display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;
    background:var(--surface2);border:1px solid var(--border);border-radius:6px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .fav-toggle:hover:not(:disabled){border-color:var(--accent)}
  .fav-toggle:disabled{opacity:0.4;cursor:not-allowed;border-color:transparent;pointer-events:none}
  .fav-toggle.active{border-color:#facc15;background:rgba(250,204,21,0.08)}
  .fav-toggle .fav-count{margin-left:auto;font-family:'JetBrains Mono',monospace;color:#facc15;font-size:10px}
  .popup-fav-btn{
    display:inline-flex;align-items:center;gap:4px;padding:4px 10px;margin-top:6px;
    background:var(--surface2);border:1px solid var(--border);border-radius:4px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .popup-fav-btn:hover{border-color:#facc15}
  .popup-fav-btn.active{border-color:#facc15;background:rgba(250,204,21,0.1);color:#facc15}
  .comp-psf-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:#e2e8f0;text-shadow:0 0 3px rgba(0,0,0,0.9),0 0 6px rgba(0,0,0,0.7);white-space:nowrap;text-align:center;pointer-events:none}

  /* ‚îÄ‚îÄ Mobile: Bottom Sheet + Cards ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    html, body { height: 100vh; height: 100dvh; overflow-x: hidden; max-width: 100vw; }
    .app-row { position: relative; max-width: 100vw; overflow-x: hidden; }
    #map { width: 100% !important; }

    /* Sidebar ‚Üí Bottom sheet */
    .sidebar {
      position: fixed !important; bottom: 0; left: 0; right: 0;
      width: 100% !important; min-width: 0 !important;
      height: 56px; max-height: 85vh;
      border-right: none !important; border-top: 1px solid var(--border);
      border-radius: 16px 16px 0 0;
      z-index: 1100; transition: height 0.3s ease;
      overflow: hidden;
    }
    .sidebar.sheet-half { height: 40vh; }
    .sidebar.sheet-full { height: 85vh; }

    /* Sheet handle */
    .sheet-handle {
      display: flex; flex-direction: column; align-items: center;
      padding: 10px 16px 6px; cursor: grab;
      position: sticky; top: 0; z-index: 10; background: var(--surface);
      border-radius: 16px 16px 0 0;
    }
    .sheet-handle .handle-bar {
      width: 40px; height: 4px; background: var(--text-dim); border-radius: 2px;
      margin-bottom: 8px; opacity: 0.5;
    }
    .sheet-handle .peek-stats {
      display: flex; gap: 16px; font-size: 13px; font-weight: 500;
      width: 100%; justify-content: center;
    }
    .sheet-handle .peek-stats .peek-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--green);
    }

    /* Floating filter button */
    .mobile-filter-btn {
      display: flex !important; position: fixed; top: 12px; left: 12px; z-index: 1050;
      padding: 10px 16px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-family: inherit; font-size: 13px;
      font-weight: 600; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      align-items: center; gap: 8px;
    }

    .sidebar-header .refresh-btn { display: none; }
    .sidebar-header .analytics-btn { display: none; }

    /* Stats grid: 2 columns */
    .stats-grid { grid-template-columns: 1fr 1fr; }

    /* Pro forma: 1 column */
    .proforma-inputs { grid-template-columns: 1fr; }

    /* Range slider: bigger touch targets */
    .range-slider-track input[type="range"]::-webkit-slider-thumb {
      width: 24px; height: 24px; margin-top: -10px;
    }
    .range-slider-track input[type="range"] { height: 4px; top: 0; }
    input[type="range"].standalone-slider::-webkit-slider-thumb {
      width: 24px; height: 24px; margin-top: -10px;
    }

    /* Buttons: min 44px touch target */
    .mode-toggle, .layer-btn, .layer-row, .layer-cell, .panel-toggle, .fav-toggle,
    .reset-btn, .bottom-btn { min-height: 44px; }
    .preset-btn, .basemap-btn { min-height: 40px; }

    /* Legend + panel tab: hide on mobile */
    .map-legend { display: none; }
    .listings-panel-tab { display: none !important; }

    /* Popup: mobile-friendly */
    .leaflet-popup-content { min-width: unset !important; max-width: unset !important; }
    .leaflet-popup-content-wrapper {
      max-height: 50vh; overflow-y: auto !important;
      max-width: calc(100vw - 40px) !important;
    }
    .popup-two-col { flex-direction: column; max-height: none; width: auto !important; }
    .popup-col-left,.popup-col-right { overflow-y: visible; padding-right: 0; }
    .popup-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 2px 8px; }
    .popup-grid-3 { grid-template-columns: repeat(2, 1fr) !important; }
    .popup-section-label { font-size: 10px; }
    .popup-scorecard { grid-template-columns: repeat(2, 1fr) !important; }
    .popup-scorecard .sc-value { font-size: 12px; }

    /* Pin legend: above bottom sheet */
    .pin-legend { bottom: 70px; }

    /* Onboarding tip: constrain to viewport */
    .onboarding-tip { max-width: calc(100vw - 24px); }

    /* Listings panel: full-screen overlay */
    .listings-panel {
      position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
      height: 0; min-height: 0; z-index: 1200; border-top: none;
      max-width: 100vw; overflow-x: hidden;
    }
    .listings-panel.open { height: 100% !important; min-height: 100% !important; }
    .listings-panel-resize { display: none; }
    .listings-panel-close {
      font-size: 24px; min-width: 44px; min-height: 44px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Hide desktop table, show mobile cards */
    .listings-table-wrap { display: none; }
    .mobile-cards {
      display: block; padding: 10px 6px; overflow-y: auto; overflow-x: hidden;
      height: calc(100% - 45px); -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }

    /* Mobile card styling */
    .mobile-card {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 10px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.15s;
      min-width: 0; overflow: hidden; max-width: 100%;
    }
    .mobile-card:active { border-color: var(--accent); }
    .mobile-card .card-addr {
      font-weight: 600; font-size: 13px; margin-bottom: 8px; line-height: 1.3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .mobile-card .card-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px; font-size: 12px;
      min-width: 0;
    }
    .mobile-card .card-row {
      display: flex; justify-content: space-between; gap: 4px; min-width: 0;
    }
    .mobile-card .card-label { color: var(--text-dim); font-size: 11px; }
    .mobile-card .card-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .mobile-card .card-margin-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border);
    }
    .mobile-card .card-margin {
      font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700;
    }
    .mobile-card .card-profit {
      font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600;
    }

    /* Font scaling */
    .section-title { font-size: 11px; }
    .stat-card .stat-value { font-size: 18px; }
  }

  /* Desktop: hide mobile-only elements */
  @media (min-width: 769px) {
    .sheet-handle { display: none; }
    .mobile-filter-btn { display: none !important; }
    .mobile-cards { display: none !important; }
  }

  /* ‚îÄ‚îÄ BTR Opportunity Layer ‚îÄ‚îÄ */
  @keyframes btr-pulse {
    0% {
      transform: rotate(45deg) scale(1);
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.5);
    }
    50% {
      transform: rotate(45deg) scale(1.15);
      box-shadow: 0 0 12px 4px rgba(245, 158, 11, 0.25);
    }
    100% {
      transform: rotate(45deg) scale(1);
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
    }
  }

  .btr-pin {
    width: 12px;
    height: 12px;
    background: rgba(245, 158, 11, 0.85);
    border: 1.5px dashed #d97706;
    transform: rotate(45deg);
    animation: btr-pulse 2.5s ease-in-out infinite;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btr-pin:hover {
    animation: none;
    transform: rotate(45deg) scale(1.4);
    box-shadow: 0 0 16px 6px rgba(245, 158, 11, 0.4);
    background: rgba(245, 158, 11, 1);
  }

  /* BTR Tooltip Styles */
  .btr-tooltip {
    background: #1a1d27 !important;
    border: 1px solid #f59e0b !important;
    border-radius: 8px !important;
    color: #e4e6ed !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 12px !important;
    padding: 10px 14px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4) !important;
    max-width: 280px !important;
  }

  .btr-tooltip .leaflet-tooltip-top::before {
    border-top-color: #f59e0b !important;
  }

  .btr-tooltip .tooltip-header {
    color: #f59e0b;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .btr-tooltip .tooltip-addr {
    font-weight: 500;
    margin-bottom: 8px;
  }

  .btr-tooltip .tooltip-row {
    display: flex;
    justify-content: space-between;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 2px 0;
  }

  .btr-tooltip .tooltip-row .label {
    color: #8b8fa3;
  }

  .btr-tooltip .gap-negative {
    color: #f87171;
  }

  /* ‚îÄ‚îÄ Deal Assumptions Modal ‚îÄ‚îÄ */
  .modal-overlay{
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.7);z-index:2000;display:none;
    align-items:center;justify-content:center;
  }
  .modal-overlay.active{display:flex}
  .modal-panel{
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    width:90%;max-width:500px;max-height:80vh;overflow-y:auto;
    box-shadow:0 8px 32px rgba(0,0,0,0.5);
  }
  .modal-header{
    padding:16px 20px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;
  }
  .modal-header h3{font-size:15px;font-weight:700;letter-spacing:-0.01em}
  .modal-close{
    background:none;border:none;color:var(--text-dim);cursor:pointer;
    font-size:24px;padding:0;width:28px;height:28px;border-radius:4px;
    transition:all 0.15s;display:flex;align-items:center;justify-content:center;
  }
  .modal-close:hover{color:var(--text);background:var(--surface2)}
  .modal-body{padding:20px}
  .data-key-panel{max-width:640px}
  .data-key-section{margin-bottom:16px}
  .data-key-section h4{font-size:12px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin:0 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
  .data-key-item{margin-bottom:10px}
  .data-key-item dt{font-weight:700;font-size:12px;color:var(--text);margin-bottom:2px}
  .data-key-item dd{margin:0;font-size:11px;color:var(--text-dim);line-height:1.5}
  .gear-icon{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:28px;border-radius:6px;cursor:pointer;
    color:var(--text-dim);transition:all 0.15s;margin-left:4px;
    background:var(--surface2);border:1px solid var(--border);
  }
  .gear-icon:hover{color:var(--text);background:var(--surface);border-color:var(--accent)}

  /* ‚îÄ‚îÄ Polygon Draw Control ‚îÄ‚îÄ */
  .draw-control{position:absolute;top:90px;right:10px;z-index:1000;display:flex;flex-direction:column;gap:4px}
  .draw-btn,.draw-clear-btn{
    width:34px;height:34px;border-radius:4px;border:2px solid rgba(0,0,0,0.2);
    background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;
    font-size:16px;color:#333;box-shadow:0 1px 5px rgba(0,0,0,0.15);transition:all 0.15s;
  }
  .draw-btn:hover,.draw-clear-btn:hover{background:#f4f4f4}
  .draw-btn.active{border-color:#2563eb;background:#eff6ff;color:#2563eb}
  .draw-clear-btn{font-size:12px;font-weight:700;color:#ef4444;display:none}
  .draw-clear-btn.visible{display:flex}
  .leaflet-container.draw-mode{cursor:crosshair !important}
  .leaflet-container.draw-mode .leaflet-marker-icon,.leaflet-container.draw-mode .leaflet-interactive{cursor:crosshair !important}
  /* Polygon edit vertex handles */
  .leaflet-editing-icon{
    width:10px !important;height:10px !important;margin-left:-5px !important;margin-top:-5px !important;
    background:#2563eb;border:2px solid #fff;border-radius:50%;cursor:grab;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }
  .leaflet-editing-icon:hover{background:#1d4ed8;transform:scale(1.3)}
  .leaflet-editing-icon:active{cursor:grabbing}
  /* Midpoint (ghost) handles ‚Äî smaller, translucent */
  .leaflet-edit-resize,.leaflet-marker-icon.leaflet-editing-icon[style*="opacity"]{
    opacity:0.5 !important;width:8px !important;height:8px !important;
    margin-left:-4px !important;margin-top:-4px !important;
  }
</style>
</head>
<body class="light-mode">

<div class="app-row">
<aside class="sidebar">
  <div class="sheet-handle" id="sheetHandle">
    <div class="handle-bar"></div>
    <div class="peek-stats">
      <div class="peek-stat"><span class="peek-value" id="peekEligible">0</span> eligible</div>
      <div class="peek-stat"><span class="peek-value" id="peekMargin">0%</span> avg margin</div>
    </div>
  </div>
  <div class="sidebar-header">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h1><span>SB 1123</span> Deal Finder</h1>
      <a href="analytics.html" class="analytics-btn" id="analyticsLink" title="Market Analytics Dashboard">&#9632; Analytics</a>
      <a href="" class="analytics-btn" id="marketSwitchLink" title="Switch market"></a>
      <button class="refresh-btn" onclick="copyRefreshCmd()" title="Copy refresh command to clipboard">&#8635; Refresh</button>
    </div>
    <p id="marketSubtitle">Townhome development sites in Los Angeles</p>
    <div class="law-ref">California SB 1123 ‚Äî by-right subdivision, no city approval required</div>
    <div class="law-ref" id="dataFreshness" style="margin-top:2px"></div>
    <div class="stat-pills" id="statPills">
      <span class="pill"><span class="pill-val" id="pillOnMarket">0</span><span class="pill-label">on-mkt</span></span>
      <span class="pill"><span class="pill-val" id="pillComps">0</span><span class="pill-label">comps</span></span>
      <span class="pill"><span class="pill-val" id="pillMinMargin">30%</span><span class="pill-label">min margin</span></span>
    </div>
  </div>

  <div class="loading-banner" id="loadingBanner">Rendering data...</div>

  <div class="sidebar-scroll">

  <!-- Hidden elements kept for JS compatibility -->
  <span id="compCount" style="display:none">0</span>
  <span id="heatCount" style="display:none">0</span>
  <div id="heatmapModeToggle" style="display:none"><button class="basemap-btn active" id="heatRaw"></button><button class="basemap-btn" id="heatNorm"></button><div id="heatmapModeLabel"></div></div>
  <span id="filterCount" style="display:none"></span>

  <!-- ‚ïê‚ïê‚ïê LAYERS ‚ïê‚ïê‚ïê -->
  <div class="accordion-section" id="layersAccordion">
    <div class="accordion-header" onclick="this.parentElement.classList.toggle('collapsed')">
      <span class="label">Layers</span>
      <div class="acc-right">
        <span class="acc-dim" id="layersActiveCount"></span>
        <span class="chevron">‚ñº</span>
      </div>
    </div>
    <div class="accordion-body">
      <!-- Primary layers -->
      <button class="layer-row active" data-layer="listings" onclick="toggleLayerRow('listings',this)">
        <span class="ldot" style="background:#22c55e"></span>
        <span class="lname">On-Market</span>
        <span class="lcount" id="listingCount">0</span>
      </button>
      <button class="layer-row" data-layer="neighborhoods" onclick="toggleLayerRow('neighborhoods',this)">
        <span class="ldot"></span>
        <span class="lname">Sale $/SF</span>
        <span class="lcount" id="neighborhoodCount">0</span>
      </button>

      <!-- Secondary layers: Off-Market / BTR grid -->
      <div class="layer-grid" style="margin-top:4px">
        <button class="layer-cell" data-layer="offMarket" onclick="toggleLayerRow('offMarket',this)">
          <span class="ldot"></span>
          <span class="lname">Off-Market</span>
          <span class="lcount" id="offMarketCount">0</span>
        </button>
        <button class="layer-cell" data-layer="btr" onclick="toggleLayerRow('btr',this)">
          <span class="ldot"></span>
          <span class="lname">BTR</span>
          <span class="lcount" id="btrCount">0</span>
        </button>
      </div>

      <!-- Overlay chips -->
      <div class="overlay-chips">
        <button class="chip-btn active" data-layer="parcels" onclick="toggleLayerRow('parcels',this)">Parcels</button>
        <button class="chip-btn" data-layer="fireZones" onclick="toggleLayerRow('fireZones',this)">üî• Fire</button>
        <button class="chip-btn" data-layer="floodZones" onclick="toggleLayerRow('floodZones',this)">üåä Flood</button>
        <button class="chip-btn" data-layer="liquefaction" onclick="toggleLayerRow('liquefaction',this)">üèî Quake</button>
      </div>

      <!-- Zoning -->
      <div class="zoning-bar" id="zoningBar">
        <span class="zone-sw"></span>
        <span class="zone-name" id="zoningBarName">R1</span>
        <span class="zone-psf" id="zoningBarPsf"></span>
        <button class="zone-expand" id="zoningExpandBtn" onclick="document.getElementById('zoneTogglesWrap').style.display=this.textContent.indexOf('+')>=0?'block':'none';this.textContent=this.textContent.indexOf('+')>=0?'‚àí zones':'+ zones'">+ zones</button>
      </div>
      <div id="zoneTogglesWrap" style="display:none;margin-top:6px">
        <div id="zoneToggles"></div>
      </div>

      <!-- Condition Tier (shown when comp layer active) -->
      <div id="tierFilterSection" style="display:none;margin-top:8px">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:#475569;margin-bottom:6px;font-weight:700">Condition Tier</div>
        <label class="zone-toggle" style="margin:0 0 2px">
          <input type="checkbox" checked onchange="tierState.t1=this.checked;updateCompPoints()">
          <span class="check-box"></span>
          <span class="zone-swatch" style="background:#14b8a6"></span>
          <span class="zone-label">T1 ‚Äî New / Remodel</span>
          <span class="zone-stat" id="tierT1Count">0</span>
        </label>
        <label class="zone-toggle" style="margin:0">
          <input type="checkbox" checked onchange="tierState.t2=this.checked;updateCompPoints()">
          <span class="check-box"></span>
          <span class="zone-swatch" style="background:#64748b"></span>
          <span class="zone-label">T2 ‚Äî Existing / As-Is</span>
          <span class="zone-stat" id="tierT2Count">0</span>
        </label>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê -->
  <div class="accordion-section" id="filtersAccordion">
    <div class="accordion-header" onclick="var t=event.target;if(t.classList.contains('acc-reset'))return;this.parentElement.classList.toggle('collapsed')">
      <span class="label">Filters</span>
      <div class="acc-right">
        <span class="acc-reset" onclick="event.stopPropagation();resetFilter('all')">reset</span>
        <span class="chevron">‚ñº</span>
      </div>
    </div>
    <div class="accordion-body" style="padding:10px 14px">

      <!-- Margin -->
      <div class="kf-block">
        <div class="kf-header">
          <span class="kf-label">Margin</span>
          <div class="kf-chips">
            <button class="kf-chip active" onclick="setMarginPreset(30,this)">30%+</button>
            <button class="kf-chip" onclick="setMarginPreset(20,this)">20%+</button>
            <button class="kf-chip" onclick="setMarginPreset(0,this)">0%+</button>
          </div>
        </div>
        <!-- Hidden inputs for JS compat -->
        <input type="number" id="marginMin" step="5" style="display:none">
        <input type="number" id="marginMax" step="5" style="display:none">
        <div class="range-slider-track">
          <div class="range-slider-fill" id="marginSliderFill"></div>
          <input type="range" id="marginSliderMin" min="-100" max="100" step="5" value="30">
          <input type="range" id="marginSliderMax" min="-100" max="100" step="5" value="100">
        </div>
      </div>

      <!-- Lot Size -->
      <div class="kf-block">
        <div class="kf-header"><span class="kf-label">Lot Size</span></div>
        <div class="kf-range-labels">
          <span id="lotRangeMin">12K sf</span>
          <span id="lotRangeMax">45K sf</span>
        </div>
        <!-- Hidden inputs for JS compat -->
        <input type="number" id="lotMin" step="500" style="display:none">
        <input type="number" id="lotMax" step="500" style="display:none">
        <div class="range-slider-track">
          <div class="range-slider-fill" id="lotSliderFill"></div>
          <input type="range" id="lotSliderMin" min="0" max="45000" step="500" value="12000">
          <input type="range" id="lotSliderMax" min="0" max="45000" step="500" value="45000">
        </div>
      </div>

      <!-- Min Units -->
      <div class="kf-block">
        <div class="kf-header">
          <span class="kf-label">Min Units</span>
          <span id="minUnitsLabel" style="margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:11px;color:#94a3b8">4</span>
        </div>
        <input type="range" class="standalone-slider" id="minUnitsSlider" min="2" max="10" step="1" value="4" oninput="onMinUnitsChange(this.value)">
      </div>

      <!-- Secondary filters -->
      <div class="sf-list">
        <div class="sf-row" onclick="this.classList.toggle('expanded')">Asking Price <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min</div><input type="number" id="priceMin" step="25000"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max</div><input type="number" id="priceMax" step="25000"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="priceSliderFill"></div>
            <input type="range" id="priceSliderMin" min="0" max="5000000" step="25000" value="0">
            <input type="range" id="priceSliderMax" min="0" max="5000000" step="25000" value="3000000">
          </div>
        </div>

        <div class="sf-row" onclick="this.classList.toggle('expanded')">$/SF <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min</div><input type="number" id="psfMin" step="50"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max</div><input type="number" id="psfMax" step="50"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="psfSliderFill"></div>
            <input type="range" id="psfSliderMin" min="0" max="2000" step="25" value="0">
            <input type="range" id="psfSliderMax" min="0" max="2000" step="25" value="2000">
          </div>
        </div>

        <!-- Home Size filter inputs hidden for JS compat -->
        <input type="number" id="sqftMin" step="100" style="display:none">
        <input type="number" id="sqftMax" step="100" style="display:none">
        <div style="display:none"><div id="sqftSliderFill"></div><input type="range" id="sqftSliderMin" min="0" max="7000" step="100" value="0"><input type="range" id="sqftSliderMax" min="0" max="7000" step="100" value="7000"></div>

        <div class="sf-row" onclick="this.classList.toggle('expanded')">Lot Width <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min</div><input type="number" id="lotwMin" step="5"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max</div><input type="number" id="lotwMax" step="5"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="lotwSliderFill"></div>
            <input type="range" id="lotwSliderMin" min="0" max="200" step="5" value="50">
            <input type="range" id="lotwSliderMax" min="0" max="200" step="5" value="200">
          </div>
        </div>

        <div class="sf-row" onclick="this.classList.toggle('expanded')">Slope <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min %</div><input type="number" id="slopeMin" step="1"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max %</div><input type="number" id="slopeMax" step="1"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="slopeSliderFill"></div>
            <input type="range" id="slopeSliderMin" min="0" max="100" step="1" value="0">
            <input type="range" id="slopeSliderMax" min="0" max="100" step="1" value="100">
          </div>
        </div>
      </div>

      <!-- Hide Burn Zones -->
      <div style="display:flex;align-items:center;gap:6px;margin-top:10px" id="burnZoneSection">
        <label class="zone-toggle" style="margin:0;padding:0">
          <input type="checkbox" id="hideBurnZones" checked onchange="toggleBurnZoneFilter(this.checked)">
          <span class="check-box" style="width:14px;height:14px"></span>
          <span style="font-size:11px;color:var(--red)" id="burnZoneLabel">Hide Burn Zones</span>
        </label>
      </div>

    </div>
  </div>

  </div><!-- /sidebar-scroll -->

  <!-- ‚ïê‚ïê‚ïê STICKY BOTTOM BAR ‚ïê‚ïê‚ïê -->
  <div class="sidebar-bottom">
    <div class="bottom-row">
      <button class="bottom-btn" id="favToggle" onclick="toggleFavoritesFilter()">
        <span>&#9733; Saved</span><span class="fav-count" id="favCount" style="font-family:'JetBrains Mono',monospace;color:#facc15;font-size:10px">0</span>
      </button>
      <button class="bottom-btn" onclick="exportCSV()">&#128202; Export</button>
      <button class="bottom-btn gear" onclick="openAssumptionsModal()" title="Deal Assumptions">&#9881;</button>
    </div>
    <div class="basemap-row">
      <button class="basemap-link active" data-base="light" onclick="setBaseMap('light')">Light</button>
      <span class="basemap-dot">&middot;</span>
      <button class="basemap-link" data-base="satellite" onclick="setBaseMap('satellite')">Satellite</button>
    </div>
  </div>
</aside>

<button class="mobile-filter-btn" id="mobileFilterBtn" onclick="openMobileSheet()">
  <span class="filter-icon">&#9776;</span> Filters
</button>

<div id="onboarding-tip" class="onboarding-tip" style="display:none">
  <button class="close-btn" onclick="dismissOnboarding()">√ó</button>
  üëã <strong>First time here?</strong> Click any <span style="color:var(--green);font-weight:700">green pin</span> to see a profitable deal. Yellow = moderate margin, Gray = below target.
</div>
<div id="map">
  <!-- Pin Color Legend (bottom-left of map, always visible, dynamic) -->
  <div class="pin-legend" id="pinLegend">
    <!-- Dynamically populated based on active layers -->
  </div>
</div>

<div class="map-legend">
  <div class="legend-section">Comps (Market Data)</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r1)"></div> R1 Single Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r2)"></div> R2 Two Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r3)"></div> R3 Multi-Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r4)"></div> R4 High Density</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--land)"></div> Vacant Land</div>
  <div class="legend-section" style="margin-top:8px">Listings (Exit $/SF)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#6366f1;border-radius:50%"></div> &lt;$650/SF</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3b82f6;border-radius:50%"></div> $650‚Äì700</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22d3ee;border-radius:50%"></div> $700‚Äì750</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22c55e;border-radius:50%"></div> $750‚Äì800</div>
  <div class="legend-item"><div class="legend-dot" style="background:#eab308;border-radius:50%"></div> $800‚Äì900</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f97316;border-radius:50%"></div> $900+</div>
</div>
</div><!-- /app-row -->

<!-- Deal Assumptions Modal -->
<div class="modal-overlay" id="assumptionsModal" onclick="if(event.target===this) closeAssumptionsModal()">
  <div class="modal-panel">
    <div class="modal-header">
      <h3>Deal Assumptions</h3>
      <button class="modal-close" onclick="closeAssumptionsModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="proforma-inputs">
        <div class="proforma-group">
          <label>All-In Build $/SF</label>
          <input type="number" id="pfBuildCost" value="360" step="25" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Unit SF (avg)</label>
          <input type="number" id="pfUnitSize" value="1750" step="50" onchange="onProformaChange()">
        </div>
        <!-- Soft cost removed: allInBuildPsf includes hard + soft -->
        <div class="proforma-group">
          <label>Txn Costs %</label>
          <input type="number" id="pfTxnCost" value="4.7" step="0.5" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Fixed Disp $</label>
          <input type="number" id="pfFixedDisp" value="40000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Demo Cost $</label>
          <input type="number" id="pfDemoCost" value="55000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Hold Months</label>
          <input type="number" id="pfHoldMonths" value="24" step="3" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Carry Rate %</label>
          <input type="number" id="pfCarryRate" value="9" step="0.5" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Insurance $</label>
          <input type="number" id="pfInsurance" value="40000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Origination %</label>
          <input type="number" id="pfOrigination" value="1" step="0.25" onchange="onProformaChange()">
        </div>
      </div>
      <p style="font-size:10px;color:var(--text-dim);margin-top:12px;line-height:1.4">
        SB 1123 ground-up: demolish existing, build all new townhome units.
        Max avg unit size: 1,200 SF (R1). Guaranteed FAR: 1.0x (3-7 units) / 1.25x (8-10).
      </p>
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
        <h4 style="margin:0 0 8px;font-size:12px;color:var(--accent)">Build-to-Rent Assumptions</h4>
        <div class="proforma-inputs">
          <div class="proforma-group">
            <label>OpEx Ratio</label>
            <input type="number" id="btrOpex" value="0.30" step="0.05" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Cap Rate</label>
            <input type="number" id="btrCapRate" value="0.055" step="0.005" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Refi LTV</label>
            <input type="number" id="btrLTV" value="0.70" step="0.05" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Refi Rate</label>
            <input type="number" id="btrRate" value="0.0625" step="0.0025" onchange="onProformaChange()">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Key Modal -->
<div class="modal-overlay" id="dataKeyModal" onclick="if(event.target===this) closeDataKeyModal()">
  <div class="modal-panel data-key-panel">
    <div class="modal-header">
      <h3>Data Key</h3>
      <button class="modal-close" onclick="closeDataKeyModal()">&times;</button>
    </div>
    <div class="modal-body">

      <div class="data-key-section">
        <h4>Deal Metrics (Top Row)</h4>
        <dl class="data-key-item"><dt>Price</dt><dd>Listing price from MLS. For off-market, enter your own estimate.</dd></dl>
        <dl class="data-key-item"><dt>Units</dt><dd>Number of SB 1123 townhome units the lot can support. R1/LAND: floor(lotSF &divide; 1,200), cap 10. R2&ndash;R4: floor(lotSF &divide; 600), cap 10. Layout constraints (setbacks, driveway) may reduce this further.</dd></dl>
        <dl class="data-key-item"><dt>Lot SF</dt><dd>Total lot area in square feet. Primary source is MLS listing data; falls back to county parcel data if MLS is missing. Source shown as &ldquo;mls&rdquo; or &ldquo;parcel.&rdquo;</dd></dl>
        <dl class="data-key-item"><dt>Exit $/SF</dt><dd>Estimated sale price per square foot for finished townhomes. Prefers new-construction comps within 1 mile; falls back to zone-matched resale comps with expanding search radius (0.25mi &rarr; 4mi). Color indicates comp type: <span style="color:#4ecdc4">teal = new-con</span>, <span style="color:#ffe66d">gold = zone comps</span>.</dd></dl>
        <dl class="data-key-item"><dt>Spread</dt><dd>Exit $/SF minus hard construction cost (default $350/SF). Higher spread = more margin for profit.</dd></dl>
        <dl class="data-key-item"><dt>Net Margin</dt><dd>Estimated profit &divide; gross revenue. Green (&ge;20%) = strong, yellow (10&ndash;20%) = marginal, red (&lt;10%) = risky.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Comp Quality</h4>
        <dl class="data-key-item"><dt>Comp Confidence</dt><dd>Score from 0&ndash;100 rating reliability of the exit $/SF estimate. Based on: number of comps found, distance from subject, recency, and whether new-construction comps are available. Shown as a colored bar in the deal card.</dd></dl>
        <dl class="data-key-item"><dt>Comp Type</dt><dd><b>New-con (subdiv)</b>: Recent new-construction sales &mdash; most reliable for SB 1123 product. <b>Zone comps</b>: Resale comps matched by zoning type (R1 with R1, etc.) &mdash; used when no new-con available.</dd></dl>
        <dl class="data-key-item"><dt>Comp Count &amp; Radius</dt><dd>Number of comparable sales found and the search radius used. More comps at shorter radius = higher confidence.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Unit Count &amp; Layout</h4>
        <dl class="data-key-item"><dt>Lot Dimensions</dt><dd>Width &times; Depth estimated from parcel geometry. &ldquo;Irregular&rdquo; flag appears when effective rectangle area differs &gt;15% from actual lot area (pie-shaped, flag lots, etc.).</dd></dl>
        <dl class="data-key-item"><dt>Layout Constraint</dt><dd>Unit count may be reduced by physical fit: buildable width = lot width minus 20&rsquo; driveway minus 4&rsquo; far-side setback. Driveway is flush to property line and encroaches into the setback on its side. Use the Layout Planner tool to experiment with driveway placement.</dd></dl>
        <dl class="data-key-item"><dt>FAR (Floor Area Ratio)</dt><dd>Maximum buildable SF &divide; lot SF. SB 1123 allows: 1.25 FAR for 8&ndash;10 units, 1.0 for 3&ndash;7 units, 0.5 for &lt;3 units. Buildable SF = min(units &times; avg unit size, lot &times; FAR).</dd></dl>
        <dl class="data-key-item"><dt>Density Cap</dt><dd>SB 1123 caps at 10 units per lot regardless of lot size. R1/LAND uses 1,200 SF/unit divisor; R2&ndash;R4 uses 600 SF/unit.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Financial Model</h4>
        <dl class="data-key-item"><dt>Buildable SF</dt><dd>Total square footage of finished product. = units &times; avg unit size (default 1,200 SF), capped by FAR limit.</dd></dl>
        <dl class="data-key-item"><dt>Gross Revenue</dt><dd>Buildable SF &times; Exit $/SF. What you&rsquo;d gross if you sold all units.</dd></dl>
        <dl class="data-key-item"><dt>Sale Discount</dt><dd>5% reduction from gross revenue to account for broker commissions, concessions, and closing costs.</dd></dl>
        <dl class="data-key-item"><dt>Net Revenue</dt><dd>Gross revenue minus sale discount.</dd></dl>
        <dl class="data-key-item"><dt>Hard Costs</dt><dd>Construction cost = buildable SF &times; $350/SF (default). Covers structure, MEP, finishes.</dd></dl>
        <dl class="data-key-item"><dt>Soft Costs</dt><dd>25% of hard costs (default). Covers architecture, engineering, permits, insurance, legal, financing.</dd></dl>
        <dl class="data-key-item"><dt>Demo Cost</dt><dd>$25,000 flat (default) for demolition of existing structures.</dd></dl>
        <dl class="data-key-item"><dt>Total Development Cost</dt><dd>Hard + soft + demo + land acquisition (asking price).</dd></dl>
        <dl class="data-key-item"><dt>Est. Profit</dt><dd>Net revenue minus total development cost.</dd></dl>
        <dl class="data-key-item"><dt>Buy/Unit</dt><dd>Asking price &divide; number of units. Lower = more land efficiency.</dd></dl>
        <dl class="data-key-item"><dt>Land Basis</dt><dd>Asking price &divide; buildable SF. What you&rsquo;re paying per SF of finished product for the land alone.</dd></dl>
        <dl class="data-key-item"><dt>Max Offer</dt><dd>Maximum land price that still achieves the target margin (default 20%). Calculated as: net revenue &minus; construction costs &minus; target profit.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Build-to-Rent (BTR)</h4>
        <dl class="data-key-item"><dt>Monthly Rent</dt><dd>Estimated market rent per unit from HUD Small Area Fair Market Rents (SAFMR) for the property&rsquo;s ZIP code, sized to unit bedroom count.</dd></dl>
        <dl class="data-key-item"><dt>Gross Annual Income</dt><dd>Monthly rent &times; units &times; 12 months.</dd></dl>
        <dl class="data-key-item"><dt>NOI (Net Operating Income)</dt><dd>Gross income minus operating expenses (default 35% of gross: property management, maintenance, insurance, taxes, vacancy).</dd></dl>
        <dl class="data-key-item"><dt>Yield on Cost (YOC)</dt><dd>NOI &divide; total development cost. The unlevered return on your all-in investment. Target: &ge;5.5%. Shown as pass/fail badge.</dd></dl>
        <dl class="data-key-item"><dt>Cap Rate Valuation</dt><dd>NOI &divide; market cap rate (default 5%). Estimates what the completed, stabilized property would sell for as a rental asset.</dd></dl>
        <dl class="data-key-item"><dt>Refi Loan (70% LTV)</dt><dd>70% of the cap rate valuation. Estimates how much permanent debt you could place after stabilization.</dd></dl>
        <dl class="data-key-item"><dt>Equity Remaining</dt><dd>Total development cost minus refi loan. The cash you&rsquo;d still have tied up after refinancing.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Due Diligence Flags</h4>
        <dl class="data-key-item"><dt>Fire Zone (VHFHSZ)</dt><dd>Very High Fire Hazard Severity Zone. SB 1123 projects are <b>not eligible</b> in VHFHSZ areas. These listings are flagged but still shown for awareness.</dd></dl>
        <dl class="data-key-item"><dt>Slope</dt><dd>Average ground slope percentage from USGS LiDAR elevation data. Steeper slopes increase grading costs and may require retaining walls. &gt;15% is flagged as challenging.</dd></dl>
        <dl class="data-key-item"><dt>Tenant Risk</dt><dd>Risk level (0&ndash;3) for existing tenant displacement issues. Factors: occupied/improved property, 3+ bedrooms, 5+ bedrooms, multi-family structures, pre-2000 construction, RSO (rent stabilization) overlay. Higher risk = more relocation costs and legal complexity.</dd></dl>
        <dl class="data-key-item"><dt>HOA</dt><dd>Existing HOA may restrict or prevent SB 1123 development. R1 properties with HOA are flagged as potentially ineligible.</dd></dl>
        <dl class="data-key-item"><dt>Lot Source</dt><dd>Where lot size data comes from: &ldquo;MLS&rdquo; (listing agent, more reliable) or &ldquo;Parcel&rdquo; (county GIS, may match wrong parcel on irregular lots).</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Deal Margin Colors</h4>
        <dl class="data-key-item"><dt style="color:#4ecdc4">Green (Net Margin &ge; 20%)</dt><dd>Strong deal &mdash; meets or exceeds target profit margin.</dd></dl>
        <dl class="data-key-item"><dt style="color:#ffe66d">Yellow (Net Margin 10&ndash;20%)</dt><dd>Marginal deal &mdash; profit exists but thin. Sensitive to cost overruns or market softening.</dd></dl>
        <dl class="data-key-item"><dt style="color:#ff6b6b">Red (Net Margin &lt; 10%)</dt><dd>Risky deal &mdash; little to no profit cushion. Likely not viable at asking price.</dd></dl>
      </div>

    </div>
  </div>
</div>

<!-- Listings Panel Tab (visible when panel is closed) -->
<div class="listings-panel-tab" id="listingsPanelTab" onclick="toggleListingsPanel()">
  <span class="tab-arrow">&#9650;</span> Deal Pipeline <span class="tab-count" id="tabPanelCount">0</span>
</div>

<!-- Listings Panel -->
<div class="listings-panel" id="listingsPanel">
  <div class="listings-panel-resize" id="panelResize"></div>
  <div class="listings-panel-header">
    <h2><span>Deal Pipeline</span></h2>
    <span class="listings-panel-count" id="tablePanelCount">0</span>
    <button class="listings-panel-close" onclick="toggleListingsPanel()">x</button>
  </div>
  <div class="listings-table-wrap" id="tableWrap">
    <table class="listings-table">
      <thead>
        <tr>
          <th class="col-fav" data-sort="fav" onclick="sortTable('fav')"><span style="font-size:12px">&#9733;</span> <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-addr" data-sort="address" onclick="sortTable('address')">Address <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-zone" data-sort="zone" onclick="sortTable('zone')">Zone <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-price" data-sort="price" onclick="sortTable('price')">Price <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-lot" data-sort="lotSf" onclick="sortTable('lotSf')">Lot Size <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-lotw" data-sort="lw" onclick="sortTable('lw')">Lot W <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-units" data-sort="maxUnits" onclick="sortTable('maxUnits')">Units <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-hood" data-sort="exitPsf" onclick="sortTable('exitPsf')">Exit $/SF <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-sale" data-sort="salePerUnit" onclick="sortTable('salePerUnit')">Revenue/Unit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-ppu" data-sort="pricePerUnit" onclick="sortTable('pricePerUnit')">Cost/Unit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-profit" data-sort="estProfit" onclick="sortTable('estProfit')">Profit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-margin" data-sort="estMargin" onclick="sortTable('estMargin')">Margin <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-slope" data-sort="slope" onclick="sortTable('slope')">Slope <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-dom" data-sort="dom" onclick="sortTable('dom')">Days Listed <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-new" data-sort="isNew" onclick="sortTable('isNew')">New <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-link">Link</th>
        </tr>
      </thead>
      <tbody id="listingsTableBody"></tbody>
    </table>
  </div>
  <div class="mobile-cards" id="mobileCards"></div>
</div>

<script>
// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
const ZONE_COLORS = {R1:'#2563eb',R2:'#16a34a',R3:'#ea580c',R4:'#9333ea',LAND:'#b45309'};
const ZONE_LABELS = {R1:'Single Family',R2:'Two Family',R3:'Multi-Family',R4:'High Density',LAND:'Vacant Land'};
// Exit $/SF color scale: cool (cheap) ‚Üí hot (expensive)
// RECENTERED for SFV: $600-$1,000 decision range
function exitPsfColor(ppsf){
  if(!ppsf || ppsf <= 0) return '#888';
  if(ppsf < 650) return '#6366f1';   // Indigo ‚Äî weak exit market
  if(ppsf < 700) return '#3b82f6';   // Blue ‚Äî below target
  if(ppsf < 750) return '#22d3ee';   // Teal ‚Äî break-even zone
  if(ppsf < 800) return '#22c55e';   // Green ‚Äî healthy margin
  if(ppsf < 900) return '#eab308';   // Amber ‚Äî strong exit
  return '#f97316';                   // Orange ‚Äî premium market
}

function getPinBorder(ppsf){
  if(!ppsf || ppsf <= 0) return '#666';
  if(ppsf < 600) return '#2563eb';   // Darker blue border
  if(ppsf < 700) return '#06b6d4';   // Darker cyan border
  if(ppsf < 800) return '#16a34a';   // Darker green border
  if(ppsf < 900) return '#ca8a04';   // Darker yellow border
  if(ppsf < 1000) return '#ea580c';  // Darker orange border
  return '#dc2626';                   // Darker red border
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let COMPS = [];
let LISTINGS = [];
let RENTAL_COMPS = [];
let rentalCompGrid = null;
const markerLayers = {R1:L.layerGroup(),R2:L.layerGroup(),R3:L.layerGroup(),R4:L.layerGroup(),LAND:L.layerGroup()};
const listingsLayer = L.layerGroup();
const btrLayer = L.layerGroup();  // BTR opportunity layer
const offMarketLayer = L.layerGroup();  // Priority 4: Off-market targets
const neighborhoodLayer = L.layerGroup();  // Sale $/SF grid overlay
const layerState = {markers:false,compHeat:false,neighborhoods:false,listings:true,offMarket:false,btr:false,fireZones:false,floodZones:false,liquefaction:false,parcels:true};

// ‚îÄ‚îÄ Polygon Draw State ‚îÄ‚îÄ
let drawPolygonLayer = null;   // The drawn polygon L.Polygon on the map
let drawPolygonGeoJSON = null; // turf-compatible GeoJSON for point-in-polygon tests
let drawMode = false;
let drawVertices = [];         // Array of [lat, lng] while drawing
let drawPreviewLine = null;    // Polyline showing edges while drawing
const zoneState = {R1:true,R2:false,R3:false,R4:false,LAND:false};
let sb1123Mode = true;  // Default ON ‚Äî we only care about 1123 deals

const filters = {
  price:{ min:0, max:3000000, dataMin:0, dataMax:5000000, step:25000, cap:5000000, defaultMin:null, defaultMax:3000000 },
  psf:  { min:0, max:3000, dataMin:0, dataMax:3000, step:25, cap:null, defaultMin:600, defaultMax:3000 },
  sqft: { min:0, max:7000, dataMin:0, dataMax:7000, step:100, cap:7000, defaultMin:null, defaultMax:null },
  lot:  { min:0, max:45000, dataMin:0, dataMax:45000, step:500, cap:45000, defaultMin:12000, defaultMax:45000 },
  lotw: { min:0, max:200, dataMin:0, dataMax:200, step:5, cap:200, defaultMin:50, defaultMax:200 },
  slope:{ min:0, max:100, dataMin:0, dataMax:100, step:1, cap:100, defaultMin:null, defaultMax:10 },
  margin:{ min:-100, max:100, dataMin:-100, dataMax:100, step:5, cap:null, defaultMin:30, defaultMax:null },
};

let currentSort = { key:null, dir:'desc' };
let listingsPanelOpen = false;
let compsTableActive = false;
let compsMapLayer = null;
let compsRadiusCircle = null;
let rentalCompsTableActive = false;
let rentalCompsMapLayer = null;
let rentalCompsRadiusCircle = null;
let savedPipelineHeader = '';
let favoritesOnly = false;
let newThisWeekFilter = false;
let hideBurnZones = true;
let minUnitsFilter = 4;  // Default: require at least 4 units
function onMinUnitsChange(val){ minUnitsFilter = parseInt(val); document.getElementById('minUnitsLabel').textContent = val; applyFilters(); }
function resetMinUnits(){ minUnitsFilter = 4; document.getElementById('minUnitsSlider').value = 4; document.getElementById('minUnitsLabel').textContent = '4'; applyFilters(); }

const tierState = { t1: true, t2: true };
let heatmapMode = 'raw';

// ‚îÄ‚îÄ Favorites (localStorage) ‚îÄ‚îÄ
const FAV_KEY = 'sb1123_favorites';
function loadFavorites(){ try{return JSON.parse(localStorage.getItem(FAV_KEY))||{}}catch(e){return{}} }
function saveFavorites(f){ localStorage.setItem(FAV_KEY, JSON.stringify(f)); }
function listingKey(l){ return l.lat+','+l.lng; }
function isFavorite(l){ return !!loadFavorites()[listingKey(l)]; }
function toggleFavorite(lat,lng){
  const key=lat+','+lng, favs=loadFavorites();
  if(favs[key]) delete favs[key]; else favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  saveFavorites(favs); updateFavCount();
  // Only rebuild markers when in favorites-only mode (un-star removes pin).
  // Otherwise skip applyFilters() to keep the popup open.
  if(favoritesOnly) applyFilters();
}
function saveFavNote(lat,lng,text){
  const key=lat+','+lng, favs=loadFavorites();
  if(!favs[key]) favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  favs[key].notes=text; saveFavorites(favs);
}
function getFavNote(lat,lng){ const f=loadFavorites()[lat+','+lng]; return f?f.notes||'':''; }
function updateFavCount(){
  const n=Object.keys(loadFavorites()).length;
  document.getElementById('favCount').textContent=n;
  const btn = document.getElementById('favToggle');
  btn.disabled = n === 0;
  if(n === 0 && favoritesOnly){
    favoritesOnly = false;
    btn.classList.remove('active');
    applyFilters();
  }
}
function copyRefreshCmd(){
  const cmd=MARKET.slug==='la'?'./refresh.sh':'./refresh.sh --market '+MARKET.slug;
  navigator.clipboard.writeText(cmd).then(()=>{
    const btn=document.querySelector('.refresh-btn');
    btn.textContent='Copied!';
    btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';
    setTimeout(()=>{btn.innerHTML='&#8635; Refresh';btn.style.borderColor='';btn.style.color='';},2000);
  }).catch(()=>{
    prompt('Run this in your terminal to refresh data:',cmd);
  });
}
function sharePin(lat,lng,event){
  var params=MARKET.slug!=='la'?'?market='+MARKET.slug+'&pin='+lat+','+lng:'?pin='+lat+','+lng;
  const url=window.location.origin+window.location.pathname+params;
  navigator.clipboard.writeText(url).then(()=>{
    const btn=event.target;
    const orig=btn.innerHTML;
    btn.innerHTML='Link Copied!';
    btn.style.background='var(--green)';
    setTimeout(()=>{btn.innerHTML=orig;btn.style.background='';},2000);
  }).catch(()=>{
    prompt('Share this link:',url);
  });
}
function toggleFavoritesFilter(){
  // Guard: check actual count, not just btn.disabled (inline onclick can fire on some browsers)
  if(Object.keys(loadFavorites()).length === 0) return;
  const btn = document.getElementById('favToggle');
  favoritesOnly=!favoritesOnly;
  if(favoritesOnly){
    btn.classList.add('active');
  } else {
    btn.classList.remove('active');
  }
  applyFilters();
}
function toggleBurnZoneFilter(checked){
  hideBurnZones = checked;
  applyFilters();
}

// Pro forma defaults ‚Äî SB 1123 townhome development
let proforma = {
  allInBuildPsf: 360,    // All-in construction $/SF (hard + soft combined)
  avgUnitSf: 1750,       // Avg townhome unit size
  txnCostPct: 4.7,       // Retail exit: broker (3%) + transfer tax + title + escrow
  fixedDispositionCosts: 40000, // Fixed per-project: legal, marketing, staging
  demoCost: 55000,       // Demolition of existing structure
  holdMonths: 24,        // Construction + sale hold period
  carryRatePct: 9,       // Annual carry rate on construction loan
  insurance: 40000,      // Builder's risk insurance for hold period
  originationPct: 1,     // Loan origination fee as % of construction loan
};

// ‚îÄ‚îÄ Map ‚îÄ‚îÄ
const map = L.map('map',{center:MARKET.center,zoom:MARKET.zoom,zoomControl:false});
L.control.zoom({position:'topright'}).addTo(map);

// Custom panes so heatmap renders below listings
map.createPane('heatmapPane').style.zIndex = 350;
map.createPane('compDotsPane').style.zIndex = 360;
const listingsPane = map.createPane('listingsPane');
listingsPane.style.zIndex = 450;
// Note: avoid CSS filter on pane ‚Äî causes compositing bugs when swapping tile layers

// Base tile layers
const baseLayers = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'Esri World Imagery',maxZoom:19
  })
};
let activeBase = 'light';
baseLayers.light.addTo(map);

function setBaseMap(name){
  map.removeLayer(baseLayers[activeBase]);
  activeBase = name;
  baseLayers[name].addTo(map);
  // Update button states
  document.querySelectorAll('.basemap-btn,.basemap-link').forEach(b=>{
    b.classList.toggle('active', b.dataset.base===name);
  });
  // Toggle body class for light mode adjustments
  document.body.classList.toggle('light-mode', name==='light' || name==='satellite');
  // Re-assert overlay layers after basemap swap
  refreshVisibility();
}

Object.values(markerLayers).forEach(l=>l.addTo(map));

// Overlay layers (server-rendered from LA County / FEMA / CGS ArcGIS)
let fireZoneLayer = null;
let parcelLayer = null;
let floodZoneLayer = null;
let liquefactionLayer = null;
let compHeatLayer = null;
let compCanvasRenderer = null;
let compPointsLayer = L.layerGroup();
let compLabelsLayer = L.layerGroup();
let compSpatialGrid = {};  // grid for fast viewport queries

// Build spatial grid for comps (0.005¬∞ cells ‚âà 500m)
function buildCompGrid(comps){
  const grid = {};
  const S = 0.005;
  comps.forEach(c=>{
    if(!c.ppsf || c.ppsf <= 0) return;
    const key = Math.floor(c.lat/S)+','+Math.floor(c.lng/S);
    if(!grid[key]) grid[key]=[];
    grid[key].push(c);
  });
  return grid;
}

// Query comps in a bounding box from grid
function queryCompGrid(bounds){
  const S = 0.005;
  const s=bounds.getSouth(), n=bounds.getNorth(), w=bounds.getWest(), e=bounds.getEast();
  const rMin=Math.floor(s/S), rMax=Math.floor(n/S);
  const cMin=Math.floor(w/S), cMax=Math.floor(e/S);
  const result=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=compSpatialGrid[r+','+c];
      if(cell) result.push(...cell);
    }
  }
  return result;
}

// Render comp points + labels for current viewport
function updateCompPoints(){
  compPointsLayer.clearLayers();
  compLabelsLayer.clearLayers();
  if(!layerState.compHeat) return;
  const zoom = map.getZoom();
  if(zoom < 13) return;

  const bounds = map.getBounds();
  const visible = queryCompGrid(bounds);
  const showLabels = zoom >= 15;
  // Cap markers to prevent browser freeze at mid-zoom with wide viewport
  const cap = showLabels ? 2000 : 5000;

  // Filter by tier
  const tierFiltered = visible.filter(c =>
    (tierState.t1 && c.t === 1) || (tierState.t2 && c.t === 2) || (!c.t)
  );
  const toRender = tierFiltered.length > cap ? tierFiltered.slice(0, cap) : tierFiltered;

  // Update tier counts
  const t1El = document.getElementById('tierT1Count');
  const t2El = document.getElementById('tierT2Count');
  if(t1El) t1El.textContent = tierFiltered.filter(c => c.t === 1).length;
  if(t2El) t2El.textContent = tierFiltered.filter(c => c.t === 2).length;

  toRender.forEach(c=>{
    const color = exitPsfColor(c.ppsf);
    const r = zoom >= 16 ? 6 : zoom >= 14 ? 4 : 3;
    const isT1 = c.t === 1;
    const cm = L.circleMarker([c.lat,c.lng],{
      radius:r, color: isT1 ? '#14b8a6' : 'rgba(255,255,255,0.3)', fillColor:color,
      fillOpacity:0.85, weight: isT1 ? 2 : 0.8, renderer:compCanvasRenderer,
      pane:'compDotsPane'
    });
    cm.bindPopup(`<div style="font-size:12px"><b>${c.address||'Sold Comp'}</b> <span style="display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;margin-left:4px;background:${isT1?'rgba(20,184,166,0.15)':'rgba(100,116,139,0.15)'};color:${isT1?'#14b8a6':'#64748b'}">${isT1?'T1 New/Remodel':'T2 Existing'}</span><br>
      <span style="font-family:monospace;font-size:14px;color:${color}">$${c.ppsf}/SF</span><br>
      $${c.price.toLocaleString()} ¬∑ ${c.sqft.toLocaleString()} sf${c.zone?' ¬∑ '+c.zone:''}${c.date?' ¬∑ '+c.date:''}${c.yb?' ¬∑ Built '+c.yb:''}</div>`,{maxWidth:280});
    compPointsLayer.addLayer(cm);

    if(showLabels){
      const label = L.marker([c.lat,c.lng],{
        icon: L.divIcon({
          className:'comp-psf-label',
          html:'$'+c.ppsf,
          iconSize:[40,14],
          iconAnchor:[20,-6]
        }),
        interactive:false
      });
      compLabelsLayer.addLayer(label);
    }
  });
}
if(L.esri){
  try {
    // Fire zone + flood zone overlays (market-specific hazards service)
    if(MARKET.hazardsUrl){
      fireZoneLayer = L.esri.dynamicMapLayer({
        url:MARKET.hazardsUrl, layers:[2], opacity:0.4
      });
      floodZoneLayer = L.esri.dynamicMapLayer({
        url:MARKET.hazardsUrl, layers:[11,12], opacity:0.4
      });
    }
    // CGS Liquefaction zones (CA state service ‚Äî works for all markets)
    liquefactionLayer = L.esri.dynamicMapLayer({
      url:'https://services.gis.ca.gov/arcgis/rest/services/GeoscientificInformation/Liquefaction/MapServer',
      layers:[0,3],
      opacity:0.4
    });
    // Parcel boundaries (market-specific)
    if(MARKET.parcelUrl){
      parcelLayer = L.esri.tiledMapLayer({
        url:MARKET.parcelUrl, opacity:0.6, maxZoom:20, minZoom:15
      });
    }
  } catch(e) {
    console.warn('esri-leaflet layers failed:', e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SB 1123 ELIGIBILITY + PRO FORMA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// SB 1123 eligibility: R1-R4 + LAND zones, lot 10K+ SF
// Exclude condos/townhouses ‚Äî on shared/HOA land, can't subdivide
// Exclude R1 with HOA ‚Äî indicates shared land/CC&Rs that block subdivision
// Exclude VHFHSZ ‚Äî hard exclusion under SB 1123
function isSB1123Eligible(l){
  const validZone = ['R1','R2','R3','R4','LAND'].includes(l.zone);
  const notCondoTownhouse = !['Condo/Co-op','Townhouse'].includes(l.type);
  const notR1Hoa = !(l.zone === 'R1' && l.hoa > 0);
  const notHighHoa = !(l.hoa && l.hoa >= 1000);  // High HOA = shared land/CC&Rs
  const notFireZone = !l.fireZone;
  const minLot = ['R1','LAND'].includes(l.zone) ? 2400 : 1200;  // 2 units min: R1=2√ó1200, MF=2√ó600
  const validLot = l.lotSf && l.lotSf >= minLot;
  const maxLotSf = ['R1','LAND'].includes(l.zone) ? 65340 : 217800;
  const underAcreageCap = !l.lotSf || l.lotSf <= maxLotSf;
  const inUrbanArea = l.urbanArea !== false;  // true or undefined (not yet checked) = OK
  return validZone && notCondoTownhouse && notR1Hoa && notHighHoa && notFireZone && validLot && underAcreageCap && inUrbanArea;
}

function getMinLotPerUnit(zone){
  // SB 1123: 1,200 SF min per parcel in single-family zones, 600 SF in multifamily
  if(zone === 'R1') return 1200;
  if(zone === 'LAND') return 1200;  // Assume R1 density for unzoned land
  return 600;  // R2, R3, R4
}

function getMaxUnits(l){
  if(!l.lotSf) return 1;
  const minPer = getMinLotPerUnit(l.zone);
  const byLot = Math.floor(l.lotSf / minPer);
  return Math.min(10, Math.max(1, byLot));  // SB 1123 caps at 10
}

function getSlopeAdjBuildCost(slope,base){
  // base = all-in $/SF; add $15/SF per 5% slope above 5%
  if(!slope||slope<=5) return base;
  return base + Math.ceil((slope-5)/5)*15;
}

// Comp confidence indicator: how reliable is the exit $/SF?
function compConfidence(l){
  // Determine active comp source + count
  let count = 0, method = '', radius = 0;
  if(l.subdivExitPsf){
    count = l.subdivCompCount || 0;
    method = 'subdiv';
    radius = l.subdivCompRadius || 0;
  } else if(l.newconPpsf){
    count = l.newconCount || 0;
    method = l.newconFlag === 'cross-zone' ? 'newcon-xz' : 'newcon';
    // newcon doesn't store radius, estimate from tier
  } else if(l.exitPsf){
    count = l.compCount || 0;
    method = l.compMethod || 'none';
    radius = l.compRadius || 0;
  } else {
    return {score: 0, label: 'No Data', color: '#ef4444', icon: '&#9711;', bar: 0};
  }

  // Score: 0-100 based on comp count + method quality
  let score = 0;

  // Count contribution (0-60 pts): 3=15, 5=25, 10=40, 20=50, 30+=60
  if(count >= 30) score += 60;
  else if(count >= 20) score += 50;
  else if(count >= 10) score += 40;
  else if(count >= 5) score += 25;
  else if(count >= 3) score += 15;
  else score += count * 3;

  // Method quality (0-40 pts)
  if(method === 'subdiv') score += 40;        // Best: actual subdivision sales
  else if(method === 'newcon') score += 35;    // Great: zone-matched new construction
  else if(method === 'newcon-xz') score += 25; // Good: cross-zone new construction
  else if(method === 'zone') score += 30;      // Good: zone-matched all sales
  else if(method === 'all') score += 20;       // OK: all-zone
  else if(method === 'zone-thin') score += 15; // Weak: thin zone-matched
  else if(method === 'all-thin') score += 10;  // Weak: thin all-zone
  else if(method.includes('zip')) score += 8;  // Poor: zip fallback
  else score += 5;

  // Flags: penalize
  if(l.newconFlag === 'sanity-high') score -= 10;
  if(l.compMethod && l.compMethod.includes('thin')) score -= 10;

  score = Math.max(0, Math.min(100, score));

  // Map to label + color
  let label, color, icon;
  if(score >= 75){ label = 'High'; color = '#22c55e'; icon = '&#9679;&#9679;&#9679;'; }
  else if(score >= 50){ label = 'Medium'; color = '#f59e0b'; icon = '&#9679;&#9679;&#9675;'; }
  else if(score >= 25){ label = 'Low'; color = '#f97316'; icon = '&#9679;&#9675;&#9675;'; }
  else { label = 'Very Low'; color = '#ef4444'; icon = '&#9675;&#9675;&#9675;'; }

  return {score, label, color, icon, bar: Math.round(score), count, method, radius};
}

// ‚îÄ‚îÄ Deal Scorecard (hero metrics banner) ‚îÄ‚îÄ
function dealScorecard(l, pf, btr){
  const exitPsf = exitLabel(l).psf;
  const allInPsf = pf.effective_buildable_sf>0 ? Math.round(pf.totalCost/pf.effective_buildable_sf) : 0;
  const spread = exitPsf - allInPsf;
  const spreadColor = spread>=100?'var(--green)':spread>=0?'var(--yellow)':'var(--red)';
  const marginColor = pf.margin>=30?'var(--green)':pf.margin>=15?'var(--yellow)':'var(--red)';
  const moColor = pf.max_offer>=l.price?'var(--green)':'var(--red)';
  const moVal = pf.max_offer>=1000000?'$'+(pf.max_offer/1000000).toFixed(1)+'M':'$'+Math.round(pf.max_offer/1000).toLocaleString()+'k';
  return '<div class="popup-scorecard">'
    +'<div><div class="sc-label">SPREAD</div><div class="sc-value" style="color:'+spreadColor+'">$'+spread+'/sf</div></div>'
    +'<div><div class="sc-label">NET MARGIN</div><div class="sc-value" style="color:'+marginColor+'">'+pf.margin.toFixed(1)+'%</div></div>'
    +'<div><div class="sc-label">MAX OFFER</div><div class="sc-value" style="color:'+moColor+'">'+moVal+'</div></div>'
    +'<div><div class="sc-label">UNITS</div><div class="sc-value">'+pf.maxUnits+'</div></div>'
    +'</div>';
}

// ‚îÄ‚îÄ Action links bar ‚îÄ‚îÄ
function actionLinksBar(l){
  return '<div class="popup-links">'
    +'<a href="https://www.google.com/maps?q='+l.lat+','+l.lng+'&t=k&z=19" target="_blank">Maps &#8599;</a>'
    +(l.url?'<a href="'+l.url+'" target="_blank">Redfin &#8599;</a>':'')
    +(MARKET.hasZimas?'<a href="'+getZimasUrl(l)+'" target="_blank" style="color:var(--yellow)">ZIMAS &#8599;</a>':'')
    +(l.lw&&l.ld?'<a href="'+lotPlannerUrl(l)+'" target="_blank">Planner &#8599;</a>':'')
    +'</div>';
}

// ‚îÄ‚îÄ Condensed Due Diligence ‚îÄ‚îÄ
function dueDiligenceBlock(l){
  var failures = [];
  if(l.burnZone) failures.push('<span style="color:var(--red)">&#10007;</span> &#128293; BURN ZONE');
  else if(l.fireZone) failures.push('<span style="color:var(--red)">&#10007;</span> VHFHSZ fire zone');
  if(l.rsoRisk) failures.push('<span style="color:var(--red)">&#10007;</span> RSO rent-controlled (Ellis Act)');
  var sb = slopeBadge(l);
  if(sb && sb.includes('&#10007;')) failures.push(sb.replace(/^ ‚Ä¢ /,''));

  var h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">Due Diligence</div>';
  if(failures.length === 0){
    h += '<div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">'
      +'<span style="color:var(--green)">&#10003;</span> All checks passed &nbsp;&bull;&nbsp; '
      +'<span style="color:var(--yellow)">&#9733;</span> TPA = 0 parking'
      +(sb?sb:'')
      +'</div>';
  } else {
    h += '<div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">'
      +failures.join(' &bull; ')
      +' &bull; <span style="color:var(--yellow)">&#9733;</span> TPA = 0 parking'
      +'</div>';
  }
  if(l.rsoRisk&&l.zone!=='R1'&&l.zone!=='LAND'){
    h += '<div class="popup-span-2" style="font-size:10px;color:#dc2626;line-height:1.4">&#9888; RSO: Budget ~$20K/unit relocation + 120-day Ellis Act notice</div>';
  }
  return h;
}

// ‚îÄ‚îÄ Collapsible Economics (cost breakdown) ‚îÄ‚îÄ
function economicsBlock(pf, opts){
  opts = opts || {};
  var collapseId = 'econ-'+Math.random().toString(36).slice(2,8);
  var h = '<div class="popup-section-label">'+(opts.label||'Economics')+'</div>';
  // Always visible: Build $/SF + Construction
  h += '<div><div class="popup-label">Build $/SF'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' <span style="color:var(--orange)">(slope)</span>':'')+'</div><div class="popup-value"'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':'')+'>$'+pf.adjBuildCostPerSf+'/sf</div></div>';
  h += '<div><div class="popup-label">Construction</div><div class="popup-value">$'+Math.round(pf.constructionCost).toLocaleString()+'</div></div>';
  // Collapsible: remaining cost items
  var carryTotal = pf.carryInterest + pf.carryPropTax + pf.insurance + pf.originationFee + (pf.demo>0?pf.demo:0);
  h += '<div class="popup-span-2"><div class="popup-collapse-toggle" onclick="var b=document.getElementById(\''+collapseId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> Cost breakdown &mdash; $'+Math.round(carryTotal).toLocaleString()+' carry+soft</div>';
  h += '<div class="popup-collapse-body" id="'+collapseId+'" style="display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;padding-top:4px">';
  if(pf.demo>0) h += '<div><div class="popup-label">Demo</div><div class="popup-value">$'+pf.demo.toLocaleString()+'</div></div><div></div>';
  h += '<div><div class="popup-label">Insurance</div><div class="popup-value">$'+pf.insurance.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Origination ('+proforma.originationPct+'%)</div><div class="popup-value">$'+pf.originationFee.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Carry Interest ('+proforma.holdMonths+'mo)</div><div class="popup-value">$'+pf.carryInterest.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Prop Tax ('+proforma.holdMonths+'mo)</div><div class="popup-value">$'+pf.carryPropTax.toLocaleString()+'</div></div>';
  h += '</div></div>';
  return h;
}

// ‚îÄ‚îÄ BTR section (collapsible when not viable) ‚îÄ‚îÄ
function btrConfidenceDot(conf){
  if(conf==='validated') return '<span style="color:#22c55e" title="Validated (5+ comps)">\u25cf</span>';
  if(conf==='estimated') return '<span style="color:#eab308" title="Estimated (<5 comps)">\u25d0</span>';
  if(conf==='manual') return '<span style="color:#3b82f6" title="Manual neighborhood data">\u25cf</span>';
  return '<span style="color:#64748b" title="Default (no local data)">\u25cb</span>';
}

function btrBlock(l, btr){
  var hasRent = btr.rentPsf > 0;
  if(!hasRent){
    return '<div class="popup-divider"></div>'
      +'<div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>'
      +'<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(100,116,139,0.1);color:#94a3b8;font-size:11px">&#9888;&#65039; No rent data</div>';
  }
  var collapseId = 'btr-'+Math.random().toString(36).slice(2,8);
  var viable = btr.btrPencils;
  var h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>';

  // Three-scenario table (from pre-computed pipeline data)
  var hasScenarios = l.rentBase > 0 && l.yocBase > 0;
  var btrContent = '';
  if(hasScenarios){
    var conf = l.confidence || 'default';
    var pf_str = l.premiumFactor ? l.premiumFactor.toFixed(2)+'x' : 'N/A';
    btrContent += '<div class="popup-span-2" style="margin:4px 0 2px">';
    btrContent += '<table style="width:100%;font-size:11px;font-family:\'JetBrains Mono\',monospace;border-collapse:collapse">';
    btrContent += '<tr style="color:#8b8fa3;font-size:10px"><td></td><td style="text-align:right">$/mo</td><td style="text-align:right">YoC</td></tr>';
    // Conservative
    btrContent += '<tr><td style="color:#8b8fa3;padding:1px 0">Conservative</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentConservative.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocConservative>=0.04?'var(--green)':l.yocConservative>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocConservative||0)*100).toFixed(1)+'%</td></tr>';
    // Base
    btrContent += '<tr style="font-weight:600"><td style="padding:1px 0">Base Case '+btrConfidenceDot(conf)+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentBase.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocBase>=0.04?'var(--green)':l.yocBase>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocBase||0)*100).toFixed(1)+'%</td></tr>';
    // Aggressive
    btrContent += '<tr><td style="color:#8b8fa3;padding:1px 0">Aggressive</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentAggressive.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocAggressive>=0.04?'var(--green)':l.yocAggressive>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocAggressive||0)*100).toFixed(1)+'%</td></tr>';
    btrContent += '</table></div>';
    // Data source footer
    btrContent += '<div class="popup-span-2" style="font-size:10px;color:#64748b;padding:2px 0;display:flex;gap:8px;flex-wrap:wrap">';
    if(l.safmr3br) btrContent += '<span>SAFMR: $'+l.safmr3br.toLocaleString()+'</span>';
    if(l.zoriBase) btrContent += '<span>ZORI: $'+l.zoriBase.toLocaleString()+'</span>';
    if(l.premiumFactor) btrContent += '<span>Premium: '+pf_str+'</span>';
    btrContent += '<span>'+btrConfidenceDot(conf)+' '+conf+'</span>';
    btrContent += '</div>';
  }

  // Existing BTR metrics (from calculateBTRProForma)
  btrContent += '<div><div class="popup-label">Rent Source</div><div class="popup-value">'+getRentSourceLabel(l)+'</div></div>';
  if(RENTAL_COMPS.length > 0 && l.rentMethod && l.rentMethod.startsWith('rental-comp')){
    btrContent += '<div class="popup-span-2" style="font-size:10px;line-height:1.4"><a href="#" onclick="showRentalCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">'+l.rentCompCount+' rental comps within '+l.rentCompRadius+'mi &#8599;</a></div>';
  }
  btrContent += '<div><div class="popup-label">Est. Rent/Unit</div><div class="popup-value">$'+btr.rentPerUnit.toLocaleString()+'/mo <small style="color:var(--text-dim)">($'+btr.rentPsf.toFixed(2)+'/SF √ó '+proforma.avgUnitSf.toLocaleString()+' SF)</small></div></div>';
  btrContent += '<div><div class="popup-label">NOI</div><div class="popup-value">$'+Math.round(btr.annualNOI).toLocaleString()+'</div></div>';
  btrContent += '<div><div class="popup-label">YOC</div><div class="popup-value" style="color:'+(btr.yieldOnCost>=0.04?'var(--green)':btr.yieldOnCost>=0.03?'var(--yellow)':'var(--red)')+'">'+(btr.yieldOnCost*100).toFixed(1)+'%</div></div>';
  btrContent += '<div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:'+(btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)')+'">$'+(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')+'M</div></div>';
  btrContent += '<div><div class="popup-label">Cap Rate</div><div class="popup-value">'+(btr.capRate*100).toFixed(1)+'%</div></div>';
  if(viable){
    btrContent += '<div><div class="popup-label">DSCR</div><div class="popup-value" style="color:'+(btr.dscr>=1.25?'var(--green)':btr.dscr>=1.15?'var(--yellow)':'var(--red)')+'">'+btr.dscr.toFixed(2)+'x</div></div>';
    btrContent += '<div><div class="popup-label">Cash Flow</div><div class="popup-value" style="color:'+(btr.cashFlow>=0?'var(--green)':'var(--red)')+'">$'+Math.round(btr.cashFlow).toLocaleString()+'/yr</div></div>';
  }
  if(viable){
    // Expanded by default when viable
    h += btrContent;
  } else {
    // Collapsed with summary line when not viable
    var summaryYoc = (btr.yieldOnCost*100).toFixed(1);
    var summaryStab = '$'+(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')+'M';
    h += '<div class="popup-span-2"><div class="popup-collapse-toggle" onclick="var b=document.getElementById(\''+collapseId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> BTR: '+summaryYoc+'% YOC &middot; Stab '+summaryStab+'</div>';
    h += '<div class="popup-collapse-body" id="'+collapseId+'" style="display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;padding-top:4px">';
    h += btrContent;
    h += '</div></div>';
  }
  return h;
}

// ‚îÄ‚îÄ Pro Forma Block (shared across all 3 pin card templates) ‚îÄ‚îÄ
function proFormaBlock(l, pf, opts){
  opts = opts || {};
  const buyLabel = opts.buyLabel || 'Buy/Unit';
  const buyPerUnit = opts.buyPerUnit != null ? opts.buyPerUnit : pf.pricePerUnit;
  const comparePrice = opts.comparePrice != null ? opts.comparePrice : l.price;
  const cc = compConfidence(l);
  const lbColor = pf.land_basis_psf<120?'var(--green)':pf.land_basis_psf<=160?'var(--yellow)':'var(--red)';
  const moColor = pf.max_offer>=comparePrice?'var(--green)':'var(--red)';
  let h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">PRO FORMA &mdash; <span class="pf-units">'+pf.maxUnits+'</span> UNITS';
  if(l.layoutNote) h += ' <span style="color:var(--orange);font-weight:400">(layout-capped from '+l.densityUnits+')</span>';
  else if(l.slopeAdjUnits) h += ' <span style="color:var(--orange);font-weight:400">(slope-adj ~'+l.slopeAdjUnits+')</span>';
  h += ' &bull; <span class="pf-buildable-sf">'+pf.effective_buildable_sf.toLocaleString()+'</span> SF</div>';
  if(l.layoutNote) h += '<div class="popup-span-2" style="color:var(--orange);font-size:11px">&#9888; '+l.layoutNote+'</div>';
  h += '<div class="popup-span-2" style="font-size:10px;line-height:1.4"><span style="color:'+cc.color+';letter-spacing:2px">'+cc.icon+'</span> <a href="#" onclick="showCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">'+cc.count+' comps'+(cc.radius ? ' within '+cc.radius+'mi' : '')+' &#8599;</a></div>';
  h += '<div class="popup-span-2" style="display:flex;justify-content:space-between;font-size:11px"><span>'+buyLabel+' <b class="pf-buy-per-unit">$'+buyPerUnit.toLocaleString()+'</b></span><span>Total Cost <b class="pf-total-cost">$'+Math.round(pf.totalCost).toLocaleString()+'</b></span></div>';
  h += '<div class="popup-span-2" style="display:flex;justify-content:space-between;font-size:11px"><span>Land Basis <b class="pf-land-basis" style="color:'+lbColor+'">$'+pf.land_basis_psf+'/sf</b></span><span>Buildable SF <b class="pf-buildable-sf2">'+pf.effective_buildable_sf.toLocaleString()+' sf</b></span></div>';
  h += '<div class="popup-span-2 pf-max-offer-row" style="font-size:11px;font-weight:600;color:'+moColor+'">Max Offer @ 30%: <span class="pf-max-offer">$'+pf.max_offer.toLocaleString()+'</span></div>';
  h += remainderAnalysis(l);
  return h;
}

// ‚îÄ‚îÄ View Comps ‚îÄ‚îÄ

const COMP_SQFT_MIN = 1300, COMP_SQFT_MAX = 3500; // Match listings_build.py size band
const ZONE_TYPE_MAP = {R1:'SFR',R2:'TH/Condo',R3:'MF 2-4',R4:'MF 5+',LAND:'Land'};
const PT_LABEL = {1:'SFR',2:'Condo',3:'Townhome',4:'MF 2-4',5:'MF 5+'};
const ADJ_ZONES = {R1:['R2'],R2:['R1','R3'],R3:['R2','R4'],R4:['R3'],LAND:['R1']};

function distMi(lat1,lng1,lat2,lng2){
  const dlat=(lat2-lat1)*69, dlng=(lng2-lng1)*69*Math.cos(lat1*Math.PI/180);
  return Math.sqrt(dlat*dlat+dlng*dlng);
}

function searchCompsInRadius(lat,lng,radiusMi){
  if(!compSpatialGrid || !COMPS.length) return [];
  const radiusDeg=radiusMi/69, S=0.005;
  const rMin=Math.floor((lat-radiusDeg)/S), rMax=Math.floor((lat+radiusDeg)/S);
  const cMin=Math.floor((lng-radiusDeg)/S), cMax=Math.floor((lng+radiusDeg)/S);
  const out=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=compSpatialGrid[r+','+c];
      if(cell) cell.forEach(comp=>{
        // Use box check matching Python: abs(dlat)<=radius && abs(dlng)<=radius
        if(Math.abs(comp.lat-lat)<=radiusDeg && Math.abs(comp.lng-lng)<=radiusDeg){
          out.push(Object.assign({},comp,{dist:distMi(lat,lng,comp.lat,comp.lng)}));
        }
      });
    }
  }
  return out;
}

function findCompsForListing(l){
  if(!COMPS.length) return {used:[],ref:[],source:'none',radius:0};

  let source,searchRadius,targetCount;

  if(l.subdivExitPsf){
    source='subdiv'; searchRadius=l.subdivCompRadius||2; targetCount=l.subdivCompCount||0;
  } else if(l.newconPpsf){
    source='newcon'; searchRadius=2; targetCount=l.newconCount||0;
  } else if(l.exitPsf){
    source='zone'; searchRadius=l.compRadius||1; targetCount=l.compCount||0;
  } else {
    return {used:[],ref:[],source:'none',radius:0};
  }

  // Wider search for reference comps
  const wideRadius = Math.min(searchRadius*2, 5);
  const all = searchCompsInRadius(l.lat,l.lng,wideRadius);

  const used=[], ref=[];
  for(const c of all){
    const inRadius = c.dist <= searchRadius + 0.05; // small tolerance
    let isUsed = false;

    if(source==='newcon'){
      // New-con: yb>=2021, zone-matched or cross-zone
      const isNewcon = c.yb && c.yb >= 2021;
      const zmOrAdj = l.newconZoneMatch
        ? c.zone===l.zone
        : (c.zone===l.zone || (ADJ_ZONES[l.zone]||[]).includes(c.zone));
      const inBand = c.sqft>=COMP_SQFT_MIN && c.sqft<=COMP_SQFT_MAX;
      isUsed = inRadius && isNewcon && zmOrAdj && inBand;
    } else if(source==='subdiv'){
      // Subdiv: zone-matched, recent sales
      isUsed = inRadius && c.zone===l.zone && c.yb && c.yb>=2021;
    } else {
      // Zone/all comps
      const method = l.compMethod||'';
      const zoneMatch = method.startsWith('zone') ? c.zone===l.zone : true;
      const inBand = c.sqft>=COMP_SQFT_MIN && c.sqft<=COMP_SQFT_MAX;
      // Try size-band match first
      isUsed = inRadius && zoneMatch && inBand;
    }

    c.isUsed = isUsed;
    c.isOutlier = c.sqft<400 || c.ppsf>2000;
    if(isUsed && !c.isOutlier) used.push(c);
    else ref.push(c);
  }

  // If zone comps and size-band gave too few, widen to all-size (matching Python fallback)
  if(source==='zone' && used.length < targetCount){
    const method = l.compMethod||'';
    const zoneMatch = method.startsWith('zone');
    // Move non-band, in-radius, zone-matched comps from ref to used
    for(let i=ref.length-1;i>=0;i--){
      const c=ref[i];
      if(c.dist<=searchRadius+0.05 && !c.isOutlier && (zoneMatch?c.zone===l.zone:true)){
        c.isUsed=true;
        used.push(ref.splice(i,1)[0]);
      }
    }
  }

  used.sort((a,b)=>a.dist-b.dist);
  ref.sort((a,b)=>a.dist-b.dist);
  return {used,ref,source,radius:searchRadius};
}

function formatCompDate(d){
  if(!d) return '‚Äî';
  const parts = d.split('-');
  if(parts.length>=3) return parts[0].substring(0,3)+' '+parts[2];
  return d;
}

function compRow(c){
  const outlier = c.isOutlier;
  const style = outlier ? 'opacity:0.4' : c.isUsed ? 'border-left:3px solid var(--green)' : '';
  const tag = outlier ? ' <span style="color:var(--orange);font-size:9px">&#9888; outlier</span>' : '';
  return `<tr style="cursor:pointer;${style}" onclick="map.flyTo([${c.lat},${c.lng}],17)">
    <td style="text-align:center">${c.isUsed&&!outlier?'<span style="color:var(--green)">&#10003;</span>':''}</td>
    <td style="white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis">${c.address||'‚Äî'}${tag}</td>
    <td>$${c.price.toLocaleString()}</td>
    <td style="color:${c.ppsf>=800?'var(--green)':c.ppsf>=600?'var(--yellow)':'var(--red)'}">$${c.ppsf}</td>
    <td>${c.sqft.toLocaleString()}</td>
    <td>${c.bd||'‚Äî'}/${c.ba||'‚Äî'}</td>
    <td${c.pt===3?' style="color:var(--green);font-weight:600"':''}>${PT_LABEL[c.pt]||ZONE_TYPE_MAP[c.zone]||c.zone||'‚Äî'}</td>
    <td>${c.zone||'‚Äî'}</td>
    <td>${c.yb||'‚Äî'}</td>
    <td style="color:${c.t===1?'var(--green)':'var(--text-dim)'}">T${c.t||'?'}</td>
    <td>${formatCompDate(c.date)}</td>
    <td>${c.dist.toFixed(2)}mi</td>
  </tr>`;
}

function showCompsTable(lat,lng){
  const l = LISTINGS.find(ll=>ll.lat===lat&&ll.lng===lng);
  if(!l || !COMPS.length) return;
  if(!listingsPanelOpen) toggleListingsPanel();

  // Hide any existing rental comps table first
  if(rentalCompsTableActive) hideRentalCompsTable();

  const {used,ref,source,radius} = findCompsForListing(l);
  const sourceLabel = {subdiv:'Subdivision',newcon:'New Construction',zone:'Zone-Matched'}[source]||source;

  // Hide pipeline elements
  document.getElementById('tableWrap').style.display='none';
  document.getElementById('mobileCards').style.display='none';
  const header = document.querySelector('.listings-panel-header');
  savedPipelineHeader = header.innerHTML;
  header.innerHTML = `
    <button onclick="hideCompsTable()" style="background:none;border:1px solid var(--border);color:var(--text);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap">&larr; Back to Pipeline</button>
    <div style="flex:1;min-width:0">
      <div style="font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">BTS COMPS &mdash; ${l.address}</div>
      <div style="font-size:11px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${sourceLabel} &bull; ${used.length} used / ${used.length+ref.length} nearby within ${radius.toFixed(1)}mi</div>
    </div>
    <button class="listings-panel-close" onclick="hideCompsTable()">x</button>
  `;

  // Create or reuse comps container
  let wrap = document.getElementById('compsTableWrap');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'compsTableWrap';
    wrap.className = 'listings-table-wrap';
    const panel = document.getElementById('listingsPanel');
    panel.insertBefore(wrap, document.getElementById('tableWrap'));
  }
  wrap.style.display = '';

  const thead = `<table class="listings-table"><thead><tr>
    <th style="width:30px">Used</th>
    <th onclick="sortCompsTable('address')">Address</th>
    <th onclick="sortCompsTable('price')">Sale Price</th>
    <th onclick="sortCompsTable('ppsf')">$/SF</th>
    <th onclick="sortCompsTable('sqft')">SqFt</th>
    <th>Bd/Ba</th>
    <th>Type</th>
    <th onclick="sortCompsTable('zone')">Zone</th>
    <th onclick="sortCompsTable('yb')">Yr Built</th>
    <th onclick="sortCompsTable('t')">Tier</th>
    <th onclick="sortCompsTable('date')">Sale Date</th>
    <th onclick="sortCompsTable('dist')">Dist</th>
  </tr></thead>`;

  const dividerRow = ref.length ? `<tr><td colspan="12" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${ref.length}) &mdash;</td></tr>` : '';
  const tbody = `<tbody>${used.map(c=>compRow(c)).join('')}${dividerRow}${ref.filter(c=>!c.isOutlier).map(c=>compRow(c)).join('')}</tbody></table>`;
  wrap.innerHTML = thead + tbody;

  // Store data for sorting
  wrap._used = used;
  wrap._ref = ref;
  wrap._listing = l;

  // Map markers ‚Äî used=green, reference=gray
  if(compsMapLayer){ map.removeLayer(compsMapLayer); }
  if(compsRadiusCircle){ map.removeLayer(compsRadiusCircle); }
  compsMapLayer = L.layerGroup();
  used.forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:6, color:'#22c55e', fillColor:'#22c55e', fillOpacity:0.8, weight:1
    }).bindPopup(`<b>${c.address||'‚Äî'}</b><br>$${c.price.toLocaleString()} &bull; $${c.ppsf}/sf &bull; ${c.sqft}sf<br>${c.date||'‚Äî'} &bull; T${c.t||'?'} &bull; ${c.zone}`).addTo(compsMapLayer);
  });
  ref.filter(c=>!c.isOutlier).forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:4, color:'#64748b', fillColor:'#64748b', fillOpacity:0.4, weight:1
    }).addTo(compsMapLayer);
  });
  compsRadiusCircle = L.circle([l.lat,l.lng],{
    radius: radius*1609.34, color:'#22c55e', fillColor:'#22c55e',
    fillOpacity:0.04, weight:1, dashArray:'6,4'
  });
  compsMapLayer.addTo(map);
  compsRadiusCircle.addTo(map);
  compsTableActive = true;
}

function sortCompsTable(key){
  const wrap = document.getElementById('compsTableWrap');
  if(!wrap || !wrap._used) return;
  const prev = wrap.getAttribute('data-sort-key');
  const dir = prev===key && wrap.getAttribute('data-sort-dir')!=='asc' ? 'asc' : 'desc';
  wrap.setAttribute('data-sort-key', key);
  wrap.setAttribute('data-sort-dir', dir==='asc' ? 'desc' : 'asc');
  const sorter = (a,b)=>{
    let va=a[key],vb=b[key];
    if(typeof va==='string') return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);
    va=va||0;vb=vb||0;
    return dir==='asc'?va-vb:vb-va;
  };
  wrap._used.sort(sorter);
  wrap._ref.sort(sorter);
  const dividerRow = wrap._ref.length ? `<tr><td colspan="12" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${wrap._ref.length}) &mdash;</td></tr>` : '';
  wrap.querySelector('tbody').innerHTML = wrap._used.map(c=>compRow(c)).join('') + dividerRow + wrap._ref.filter(c=>!c.isOutlier).map(c=>compRow(c)).join('');
}

function hideCompsTable(){
  // Restore pipeline
  document.getElementById('tableWrap').style.display='';
  document.getElementById('mobileCards').style.display='';
  const header = document.querySelector('.listings-panel-header');
  if(savedPipelineHeader) header.innerHTML = savedPipelineHeader;
  const wrap = document.getElementById('compsTableWrap');
  if(wrap) wrap.remove();
  // Remove map markers
  if(compsMapLayer){ map.removeLayer(compsMapLayer); compsMapLayer=null; }
  if(compsRadiusCircle){ map.removeLayer(compsRadiusCircle); compsRadiusCircle=null; }
  compsTableActive = false;
}

// ‚îÄ‚îÄ Rental Comps Table ‚îÄ‚îÄ

function buildRentalCompGrid(comps){
  const grid = {};
  const S = 0.005;
  comps.forEach(c=>{
    const key = Math.floor(c.lat/S)+','+Math.floor(c.lng/S);
    if(!grid[key]) grid[key]=[];
    grid[key].push(c);
  });
  return grid;
}

function searchRentalCompsInRadius(lat,lng,radiusMi){
  if(!rentalCompGrid || !RENTAL_COMPS.length) return [];
  const radiusDeg=radiusMi/69, S=0.005;
  const rMin=Math.floor((lat-radiusDeg)/S), rMax=Math.floor((lat+radiusDeg)/S);
  const cMin=Math.floor((lng-radiusDeg)/S), cMax=Math.floor((lng+radiusDeg)/S);
  const out=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=rentalCompGrid[r+','+c];
      if(cell) cell.forEach(comp=>{
        if(Math.abs(comp.lat-lat)<=radiusDeg && Math.abs(comp.lng-lng)<=radiusDeg){
          out.push(Object.assign({},comp,{dist:distMi(lat,lng,comp.lat,comp.lng)}));
        }
      });
    }
  }
  return out;
}

const RENTAL_PT_LABEL = {1:'SFR',2:'Condo',3:'Townhome',4:'MF 2-4',5:'MF 5+'};
const SFR_TH_TYPES = [1,2,3,4]; // SFR, Condo, TH, MF 2-4

function findRentalCompsForListing(l){
  if(!RENTAL_COMPS.length) return {used:[],ref:[],radius:0,method:'none'};
  const method = l.rentMethod||'';

  // Determine search radius from listing data
  let usedRadius = l.rentCompRadius || 1;
  // Widen for reference comps
  const wideRadius = Math.min(usedRadius * 2, 5);
  const all = searchRentalCompsInRadius(l.lat, l.lng, wideRadius);

  const used=[], ref=[];
  for(const c of all){
    const inRadius = c.dist <= usedRadius + 0.05;
    let isUsed = false;

    if(method === 'rental-comp' || method === 'rental-comp-wide'){
      // Tier 1/2: 3BR exact, 800-2500 SF, SFR/TH/Condo/MF types
      const bdOk = (c.bd||0) === 3;
      const sfOk = (c.sqft||0) >= 800 && (c.sqft||0) <= 2500;
      const ptOk = SFR_TH_TYPES.includes(c.pt||0);
      isUsed = inRadius && bdOk && sfOk && ptOk;
    } else if(method === 'rental-adj'){
      // Tier 3: 2+ BR, 800+ SF, all types
      const bdOk = (c.bd||0) >= 2;
      const sfOk = (c.sqft||0) >= 800;
      isUsed = inRadius && bdOk && sfOk;
    } else {
      // ZORI/SAFMR ‚Äî show nearby for reference but none "used"
      isUsed = false;
    }

    c.isUsed = isUsed;
    if(isUsed) used.push(c);
    else ref.push(c);
  }

  used.sort((a,b)=>a.dist-b.dist);
  ref.sort((a,b)=>a.dist-b.dist);
  return {used, ref, radius:usedRadius, method};
}

function rentalCompRow(c){
  const rentPsf = (c.sqft && c.sqft > 0) ? (c.rent / c.sqft).toFixed(2) : '‚Äî';
  const style = c.isUsed ? 'border-left:3px solid var(--green)' : '';
  return `<tr style="cursor:pointer;${style}" onclick="map.flyTo([${c.lat},${c.lng}],17)">
    <td style="text-align:center">${c.isUsed?'<span style="color:var(--green)">&#10003;</span>':''}</td>
    <td style="white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis">${c.addr||'‚Äî'}</td>
    <td>$${c.rent.toLocaleString()}</td>
    <td>${rentPsf==='‚Äî'?'‚Äî':'$'+rentPsf}</td>
    <td>${c.bd||'‚Äî'}</td>
    <td>${c.ba||'‚Äî'}</td>
    <td>${c.sqft?c.sqft.toLocaleString():'‚Äî'}</td>
    <td>${RENTAL_PT_LABEL[c.pt]||'‚Äî'}</td>
    <td>${c.dist.toFixed(2)}mi</td>
  </tr>`;
}

function showRentalCompsTable(lat,lng){
  const l = LISTINGS.find(ll=>ll.lat===lat&&ll.lng===lng);
  if(!l || !RENTAL_COMPS.length) return;
  if(!listingsPanelOpen) toggleListingsPanel();

  // Hide any existing comps table first
  if(compsTableActive) hideCompsTable();

  const {used,ref,radius,method} = findRentalCompsForListing(l);

  // Hide pipeline elements
  document.getElementById('tableWrap').style.display='none';
  document.getElementById('mobileCards').style.display='none';
  const header = document.querySelector('.listings-panel-header');
  if(!rentalCompsTableActive && !compsTableActive) savedPipelineHeader = header.innerHTML;
  header.innerHTML = `
    <button onclick="hideRentalCompsTable()" style="background:none;border:1px solid var(--border);color:var(--text);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap">&larr; Back to Pipeline</button>
    <div style="flex:1;min-width:0">
      <div style="font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">RENTAL COMPS &mdash; ${l.address}</div>
      <div style="font-size:11px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${used.length} used / ${used.length+ref.length} nearby within ${radius.toFixed(1)}mi</div>
    </div>
    <button class="listings-panel-close" onclick="hideRentalCompsTable()">x</button>
  `;

  // Create or reuse rental comps container
  let wrap = document.getElementById('rentalCompsTableWrap');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'rentalCompsTableWrap';
    wrap.className = 'listings-table-wrap';
    const panel = document.getElementById('listingsPanel');
    panel.insertBefore(wrap, document.getElementById('tableWrap'));
  }
  wrap.style.display = '';

  const thead = `<table class="listings-table"><thead><tr>
    <th style="width:30px">Used</th>
    <th onclick="sortRentalCompsTable('addr')">Address</th>
    <th onclick="sortRentalCompsTable('rent')">Rent $/mo</th>
    <th onclick="sortRentalCompsTable('rentPsf')">$/SF/mo</th>
    <th onclick="sortRentalCompsTable('bd')">Beds</th>
    <th onclick="sortRentalCompsTable('ba')">Baths</th>
    <th onclick="sortRentalCompsTable('sqft')">SqFt</th>
    <th>Type</th>
    <th onclick="sortRentalCompsTable('dist')">Dist</th>
  </tr></thead>`;

  const dividerRow = ref.length ? `<tr><td colspan="9" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${ref.length}) &mdash;</td></tr>` : '';
  const tbody = `<tbody>${used.map(c=>rentalCompRow(c)).join('')}${dividerRow}${ref.map(c=>rentalCompRow(c)).join('')}</tbody></table>`;
  wrap.innerHTML = thead + tbody;

  // Store data for sorting
  wrap._used = used;
  wrap._ref = ref;
  wrap._listing = l;

  // Map markers ‚Äî used=blue, reference=gray
  if(rentalCompsMapLayer){ map.removeLayer(rentalCompsMapLayer); }
  if(rentalCompsRadiusCircle){ map.removeLayer(rentalCompsRadiusCircle); }
  rentalCompsMapLayer = L.layerGroup();
  used.forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:6, color:'#3b82f6', fillColor:'#3b82f6', fillOpacity:0.8, weight:1
    }).bindPopup(`<b>${c.addr||'‚Äî'}</b><br>$${c.rent.toLocaleString()}/mo &bull; ${c.bd||'?'}bd/${c.ba||'?'}ba &bull; ${c.sqft?c.sqft.toLocaleString()+'sf':'‚Äî'}`).addTo(rentalCompsMapLayer);
  });
  ref.forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:4, color:'#64748b', fillColor:'#64748b', fillOpacity:0.4, weight:1
    }).addTo(rentalCompsMapLayer);
  });
  rentalCompsRadiusCircle = L.circle([l.lat,l.lng],{
    radius: radius*1609.34, color:'#3b82f6', fillColor:'#3b82f6',
    fillOpacity:0.04, weight:1, dashArray:'6,4'
  });
  rentalCompsMapLayer.addTo(map);
  rentalCompsRadiusCircle.addTo(map);
  rentalCompsTableActive = true;
}

function sortRentalCompsTable(key){
  const wrap = document.getElementById('rentalCompsTableWrap');
  if(!wrap || !wrap._used) return;
  const prev = wrap.getAttribute('data-sort-key');
  const dir = prev===key && wrap.getAttribute('data-sort-dir')!=='asc' ? 'asc' : 'desc';
  wrap.setAttribute('data-sort-key', key);
  wrap.setAttribute('data-sort-dir', dir==='asc' ? 'desc' : 'asc');
  const sorter = (a,b)=>{
    let va,vb;
    if(key==='rentPsf'){
      va=(a.sqft&&a.sqft>0)?a.rent/a.sqft:0;
      vb=(b.sqft&&b.sqft>0)?b.rent/b.sqft:0;
    } else {
      va=a[key]; vb=b[key];
    }
    if(typeof va==='string') return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);
    va=va||0;vb=vb||0;
    return dir==='asc'?va-vb:vb-va;
  };
  wrap._used.sort(sorter);
  wrap._ref.sort(sorter);
  const dividerRow = wrap._ref.length ? `<tr><td colspan="9" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${wrap._ref.length}) &mdash;</td></tr>` : '';
  wrap.querySelector('tbody').innerHTML = wrap._used.map(c=>rentalCompRow(c)).join('') + dividerRow + wrap._ref.map(c=>rentalCompRow(c)).join('');
}

function hideRentalCompsTable(){
  document.getElementById('tableWrap').style.display='';
  document.getElementById('mobileCards').style.display='';
  const header = document.querySelector('.listings-panel-header');
  if(savedPipelineHeader) header.innerHTML = savedPipelineHeader;
  const wrap = document.getElementById('rentalCompsTableWrap');
  if(wrap) wrap.remove();
  if(rentalCompsMapLayer){ map.removeLayer(rentalCompsMapLayer); rentalCompsMapLayer=null; }
  if(rentalCompsRadiusCircle){ map.removeLayer(rentalCompsRadiusCircle); rentalCompsRadiusCircle=null; }
  rentalCompsTableActive = false;
}

// Build descriptive exit $/SF label for popup display
function exitLabel(l){
  // Prefer calibrated T1 normalized from CLUSTERS
  if(l.clusterT1psf){
    const t1n = l.clusterT1n || 0;
    const fb = l.clusterFb;
    const fbTag = fb === 0 ? 'per-cell' : fb === 1 ? 'blended' : 'median';
    const conf = (l.clusterRw >= 0.8 && t1n >= 8) ? 'high' : (l.clusterRw >= 0.5 && t1n >= 4) ? 'med' : 'low';
    const color = conf === 'high' ? '#22c55e' : conf === 'med' ? 'var(--accent)' : '#f59e0b';
    return {psf: l.clusterT1psf, label: `T1 NORM ‚Äî ${t1n} comps, ${fbTag}, ${conf} conf`, color, short: 'T1 norm'};
  }
  if(l.subdivExitPsf){
    const count = l.subdivCompCount || 0;
    const radius = l.subdivCompRadius || '';
    const appr = l.subdivAvgAppr ? ` (${l.subdivAvgAppr > 0 ? '+' : ''}${l.subdivAvgAppr.toFixed(1)}% adj)` : '';
    return {psf: l.subdivExitPsf, label: `SUBDIV COMP ‚Äî ${count} comps within ${radius}mi${appr}`, color: '#10b981', short: 'subdiv'};
  }
  const exitPsf = l.newconPpsf || l.exitPsf || 0;
  if(!exitPsf) return {psf: 0, label: 'NO COMP DATA', color: 'var(--red)', short: 'no data'};
  if(l.newconPpsf){
    const tier = l.newconTier || '';
    const count = l.newconCount || 0;
    const zm = l.newconZoneMatch !== false ? 'zone-matched' : 'cross-zone';
    const flag = l.newconFlag;
    let label = `NEW-CON ‚Äî ${count} comps, ${tier}, ${zm}`;
    let color = 'var(--accent)';
    if(flag === 'thin'){ label += ' ‚ö†Ô∏è thin'; color = '#f59e0b'; }
    else if(flag === 'cross-zone'){ color = '#f59e0b'; }
    else if(flag === 'sanity-high'){ label += ' ‚ö†Ô∏è high'; color = '#f59e0b'; }
    return {psf: exitPsf, label, color, short: 'new-con'};
  }
  // General P75 fallback
  const count = l.compCount || 0;
  const radius = l.compRadius || '';
  let reason = '';
  if(l.newconFlag === 'sanity-low') reason = ' ‚Äî newcon failed sanity check';
  else if(l.newconFlag === 'sanity-high') reason = ' ‚Äî newcon flagged high';
  const label = `ALL SALES ‚Äî ${count} comps within ${radius}mi${reason}`;
  return {psf: exitPsf, label, color: 'var(--text-dim)', short: 'all sales'};
}

function calculateProForma(l){
  const densityUnits = getMaxUnits(l);
  let maxUnits = densityUnits;
  let layoutMax = null, layoutNote = null;
  if (l.lw && l.ld) {
    // SB 1123 parcel-depth layout model
    // Driveway (20') is flush to property line ‚Äî it encroaches into the 4' side setback on that side
    // Far side: 4' setback (can't build structure, but driveway side setback is consumed by driveway)
    // Front setback: per underlying zone (R1=20', R2-R4=15')
    const driveW = 20;
    const sideSet = 4; // far-side setback only
    const frontSet = (l.zone === 'R2' || l.zone === 'R3' || l.zone === 'R4') ? 15 : 20;
    const rearSet = 4;
    const unitBuildW = l.lw - driveW - sideSet; // buildable width: lot minus driveway minus far-side setback
    if (unitBuildW >= 20) {
      // Parcel depth = 1,200 SF / full lot width (driveway is shared easement)
      const parcelDepth = 1200 / l.lw;
      const availDepth = l.ld - frontSet - rearSet;
      layoutMax = Math.min(10, Math.floor(availDepth / parcelDepth));
      if (layoutMax > 0 && layoutMax < maxUnits) {
        maxUnits = Math.max(2, layoutMax);
        layoutNote = l.lw + "'\u00d7" + l.ld + "' \u2014 " + layoutMax + " parcels at " + parcelDepth.toFixed(1) + "' depth";
      }
    } else {
      layoutMax = 0;
      layoutNote = "Lot " + l.lw + "' too narrow \u2014 need 44'+ (20' drive + 4' setback + 20' unit)";
    }
  }
  const pf = proforma;
  const valuePerSf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, pf.allInBuildPsf);

  const effective_buildable_sf = maxUnits * pf.avgUnitSf;

  const grossPerUnit = valuePerSf * pf.avgUnitSf;
  const grossRevenue = maxUnits * grossPerUnit;
  const netRevenue = grossRevenue * (1 - pf.txnCostPct / 100) - pf.fixedDispositionCosts;

  const acquisition = l.price;
  const demo = l.sqft > 0 ? pf.demoCost : 0;
  const constructionCost = maxUnits * pf.avgUnitSf * adjBuildCostPerSf;
  const totalBuildCost = constructionCost + demo;

  // Carry costs: interest on construction loan only (cash acquisition)
  const avgLoanOutstanding = totalBuildCost * 0.5;
  const carryInterest = avgLoanOutstanding * (pf.carryRatePct / 100) * (pf.holdMonths / 12);
  const carryPropTax = acquisition * 0.011 * (pf.holdMonths / 12);
  const insurance = pf.insurance || 40000;
  const originationFee = totalBuildCost * ((pf.originationPct || 1) / 100);
  const totalCarry = carryInterest + carryPropTax + insurance + originationFee;

  const totalCost = acquisition + totalBuildCost + totalCarry;
  const profit = netRevenue - totalCost;
  const margin_on_revenue = netRevenue > 0 ? ((profit / netRevenue) * 100) : 0;

  const land_basis_psf = effective_buildable_sf > 0 ? (l.price / effective_buildable_sf) : 0;

  // Max offer at 30% margin: work backwards from target margin
  const target_margin = 0.30;
  const exit_psf = valuePerSf;
  // Net revenue = gross * (1 - txn%) - fixedDisp
  // Total cost = acquisition + build + carry(build-only interest) + propTax(acq) + insurance + origination
  // For max offer, we solve: profit/netRevenue = 0.30 ‚Üí totalCost = netRevenue * 0.70
  // Simplified: max_acq = netRevenue*0.70 - build - carry_on_build - propTax_factor*max_acq - insurance - origination
  // Since propTax depends on acq, iterate or approximate
  const nr = netRevenue;  // Reuse same revenue as economics block
  const target_total_cost = nr * (1 - target_margin);
  const build_carry = avgLoanOutstanding * (pf.carryRatePct / 100) * (pf.holdMonths / 12);
  const build_plus_soft = totalBuildCost + build_carry + insurance + originationFee;
  // max_acq + max_acq * propTaxRate * holdYears = target_total_cost - build_plus_soft
  const propTaxFactor = 0.011 * (pf.holdMonths / 12);
  const max_offer = (target_total_cost - build_plus_soft) / (1 + propTaxFactor);

  const lot_efficiency = l.lotSf > 0 ? (effective_buildable_sf / l.lotSf) : 0;
  const return_on_cost = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

  return {
    maxUnits,
    densityUnits,
    layoutMax,
    layoutNote,
    grossRevenue,
    netRevenue,
    acquisition,
    demo,
    constructionCost,
    totalBuildCost,
    totalCost,
    profit,
    margin: margin_on_revenue,
    margin_on_revenue,
    return_on_cost,
    pricePerUnit: Math.round(acquisition / maxUnits),
    effective_buildable_sf: Math.round(effective_buildable_sf),
    land_basis_psf: Math.round(land_basis_psf),
    max_offer: Math.round(max_offer),
    lot_efficiency,
    adjBuildCostPerSf,
    totalCarry: Math.round(totalCarry),
    carryInterest: Math.round(carryInterest),
    carryPropTax: Math.round(carryPropTax),
    insurance: Math.round(insurance),
    originationFee: Math.round(originationFee),
  };
}

function sizeEquityAndDebt(askingPrice, units, avgUnitSF, buildCostPSF, exitPSF, monthlyRent) {
  const SOFT_PCT = 0.25;
  const DEMO = 55000;
  const SUBDIV = 100000;
  const AE = 150000;
  const TAX_RATE = 0.011;
  const INS_ANNUAL = 20000;
  const AM_MONTHLY = 3000;
  const DM_MONTHLY = 5000;
  const ACQ_FEE_PCT = 0.02;
  const ORIG_FEE_PCT = 0.02;
  const EQUITY_PCT = 0.26;
  const PRE_DEV_MO = 6;
  const CONSTR_MO = 12;
  const SALE_MO = 6;

  const buildableSF = units * avgUnitSF;
  const hardCosts = buildableSF * buildCostPSF;
  const softCosts = hardCosts * SOFT_PCT;
  const totalDev = hardCosts + softCosts + DEMO + SUBDIV + AE;

  const monthlyTax = askingPrice * TAX_RATE / 12;
  const monthlyIns = INS_ANNUAL / 12;
  const preDev = (monthlyTax + monthlyIns + AM_MONTHLY) * PRE_DEV_MO;
  const constr = (monthlyTax + monthlyIns + AM_MONTHLY + DM_MONTHLY) * CONSTR_MO;
  const sale = (monthlyTax + monthlyIns + AM_MONTHLY) * SALE_MO;
  const totalCarry = preDev + constr + sale;

  const acqFee = askingPrice * ACQ_FEE_PCT;

  const baseCosts = askingPrice + totalDev + totalCarry + acqFee;
  const totalCost = baseCosts / (1 - (1 - EQUITY_PCT) * ORIG_FEE_PCT);

  const equity = Math.ceil(totalCost * EQUITY_PCT / 10000) * 10000;
  const debt = Math.round(totalCost - equity);

  return { equity, debt, totalCost: equity + debt };
}

// ‚îÄ‚îÄ Layout Planner URL builder ‚îÄ‚îÄ
// ‚îÄ‚îÄ Lot Layout SVG for popup ‚îÄ‚îÄ
function lotLayoutSection(l, pf){
  if(!l.lw || !l.ld || !pf.maxUnits || pf.maxUnits <= 0 || pf.max_offer <= 0) return '';
  var layoutId = 'lot-layout-'+Math.random().toString(36).slice(2,8);
  return '<div class="lot-layout-toggle" onclick="var b=document.getElementById(\''+layoutId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> Lot Layout &middot; '+pf.maxUnits+' units</div>'
    + '<div class="lot-layout-body" id="'+layoutId+'">'+buildLotLayoutSVG(l,pf)+'</div>';
}

function buildLotLayoutSVG(l, pf){
  if(!l.lw || !l.ld) return '';
  var lw = l.lw, ld = l.ld;
  var units = pf.maxUnits || 0;
  var driveW = 20, sideSet = 4, rearSet = 4;
  var frontSet = (l.zone === 'R2' || l.zone === 'R3' || l.zone === 'R4') ? 15 : 20;
  var unitBuildW = lw - driveW - sideSet;
  if(unitBuildW < 20) return '';

  var parcelDepth = 1200 / lw;
  var availDepth = ld - frontSet - rearSet;

  var remDepth = 0;
  if(l.remainderUnits > 0){
    var lotSf = l.lotSf || lw * ld;
    var remSf = lotSf - units * 1200;
    if(remSf > 400) remDepth = Math.min(Math.round(remSf / lw), ld * 0.4);
  }

  var devDepth = availDepth - remDepth;
  if(devDepth < parcelDepth) devDepth = availDepth;
  var maxFit = Math.min(10, Math.floor(devDepth / parcelDepth));
  var placed = Math.min(units, maxFit);

  // SVG viewBox padding for labels
  var padL = 16, padR = 8, padT = 14, padB = 18;
  var totalW = lw + padL + padR;
  var totalH = ld + padT + padB;
  var ox = padL, oy = padT;

  // Compact sizing: scale to fit within 260√ó180px
  var maxPxW = 260, maxPxH = 180;
  var sc = Math.min(maxPxW / totalW, maxPxH / totalH);
  var svgW = Math.round(totalW * sc), svgH = Math.round(totalH * sc);

  // Colors ‚Äî light architectural style
  var cLot = '#fafaf8', cBorder = '#1e3a5f', cSetback = '#e74c3c';
  var cDrive = '#e8e6e1', cDriveBorder = '#c8c5be';
  var cUnit = '#dbeafe', cUnitStroke = '#3b82f6';
  var cYard = '#f0fdf4', cLabel = '#888';
  var cRem = '#fef3c7', cRemStroke = '#d97706';

  var s = '<svg xmlns="http://www.w3.org/2000/svg" width="'+svgW+'" height="'+svgH+'" viewBox="0 0 '+totalW+' '+totalH+'" style="font-family:\'DM Sans\',system-ui,sans-serif">';

  // Lot boundary ‚Äî white fill, thin navy outline
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+lw+'" height="'+ld+'" fill="'+cLot+'" stroke="'+cBorder+'" stroke-width="1"/>';

  // Front setback zone (bottom = front of lot)
  s += '<rect x="'+ox+'" y="'+(oy+ld-frontSet)+'" width="'+lw+'" height="'+frontSet+'" fill="'+cYard+'" opacity="0.6"/>';
  // Rear setback zone (top = rear of lot)
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+lw+'" height="'+rearSet+'" fill="'+cYard+'" opacity="0.4"/>';
  // Far-side setback strip (right edge)
  s += '<rect x="'+(ox+lw-sideSet)+'" y="'+oy+'" width="'+sideSet+'" height="'+ld+'" fill="'+cYard+'" opacity="0.3"/>';

  // Driveway ‚Äî 20' wide, flush to left property line
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+driveW+'" height="'+ld+'" fill="'+cDrive+'" stroke="'+cDriveBorder+'" stroke-width="0.5"/>';
  // 4' setback zone within driveway (subtle dashed line)
  s += '<line x1="'+(ox+sideSet)+'" y1="'+oy+'" x2="'+(ox+sideSet)+'" y2="'+(oy+ld)+'" stroke="'+cSetback+'" stroke-width="0.4" stroke-dasharray="2,3" opacity="0.35"/>';
  // Driveway label (rotated)
  var driveFS = Math.min(6, driveW * 0.25);
  s += '<text x="'+(ox+driveW/2)+'" y="'+(oy+ld/2)+'" text-anchor="middle" dominant-baseline="central" fill="#999" font-size="'+driveFS+'" transform="rotate(-90,'+(ox+driveW/2)+','+(oy+ld/2)+')">20\u2032 DRIVE</text>';

  // Setback lines ‚Äî coral dashed (front + rear)
  var frontY = oy + ld - frontSet;
  s += '<line x1="'+ox+'" y1="'+frontY+'" x2="'+(ox+lw)+'" y2="'+frontY+'" stroke="'+cSetback+'" stroke-width="0.6" stroke-dasharray="3,2" opacity="0.55"/>';
  var rearY = oy + rearSet;
  s += '<line x1="'+ox+'" y1="'+rearY+'" x2="'+(ox+lw)+'" y2="'+rearY+'" stroke="'+cSetback+'" stroke-width="0.6" stroke-dasharray="3,2" opacity="0.55"/>';
  // Far-side setback line
  s += '<line x1="'+(ox+lw-sideSet)+'" y1="'+oy+'" x2="'+(ox+lw-sideSet)+'" y2="'+(oy+ld)+'" stroke="'+cSetback+'" stroke-width="0.4" stroke-dasharray="2,3" opacity="0.35"/>';

  // Remainder parcel at front (just above front setback)
  if(remDepth > 0){
    var remY = oy + ld - frontSet - remDepth;
    s += '<rect x="'+(ox+driveW)+'" y="'+remY+'" width="'+unitBuildW+'" height="'+remDepth+'" fill="'+cRem+'" stroke="'+cRemStroke+'" stroke-width="0.5" stroke-dasharray="2,2" opacity="0.7"/>';
  }

  // Place units ‚Äî compact colored rectangles, no unit number labels
  var unitStartX = ox + driveW;
  var unitStartY = oy + rearSet;
  for(var i = 0; i < placed; i++){
    var uy = unitStartY + i * parcelDepth;
    var uh = Math.max(parcelDepth - 1, 1);
    s += '<rect x="'+unitStartX+'" y="'+uy+'" width="'+unitBuildW+'" height="'+uh+'" fill="'+cUnit+'" stroke="'+cUnitStroke+'" stroke-width="0.8" rx="1"/>';
  }

  // Open space after last unit
  var lastUnitBottom = unitStartY + placed * parcelDepth;
  var yardH = (oy + ld - frontSet - remDepth) - lastUnitBottom;
  if(yardH > 2){
    s += '<rect x="'+(ox+driveW)+'" y="'+lastUnitBottom+'" width="'+unitBuildW+'" height="'+yardH+'" fill="'+cYard+'" opacity="0.5"/>';
  }

  // Dimension labels
  s += '<text x="'+(ox+lw/2)+'" y="'+(oy-4)+'" text-anchor="middle" fill="'+cLabel+'" font-size="6">'+lw+'\u2032</text>';
  s += '<text x="'+(ox-5)+'" y="'+(oy+ld/2)+'" text-anchor="middle" fill="'+cLabel+'" font-size="6" transform="rotate(-90,'+(ox-5)+','+(oy+ld/2)+')">'+ld+'\u2032</text>';
  // Setback dimension labels
  s += '<text x="'+(ox+lw+2)+'" y="'+(oy+rearSet/2+2)+'" fill="'+cSetback+'" font-size="4" opacity="0.6">4\u2032</text>';
  s += '<text x="'+(ox+lw+2)+'" y="'+(frontY+frontSet/2+2)+'" fill="'+cSetback+'" font-size="4" opacity="0.6">'+frontSet+'\u2032</text>';

  // STREET label
  s += '<text x="'+(ox+lw/2)+'" y="'+(oy+ld+11)+'" text-anchor="middle" fill="'+cLabel+'" font-size="5" letter-spacing="2" font-weight="600">STREET</text>';

  // Scale bar ‚Äî bottom-left, 10ft reference
  var sbX = ox + 1, sbY = oy + ld + 13;
  s += '<line x1="'+sbX+'" y1="'+sbY+'" x2="'+(sbX+10)+'" y2="'+sbY+'" stroke="'+cLabel+'" stroke-width="0.7"/>';
  s += '<line x1="'+sbX+'" y1="'+(sbY-1.5)+'" x2="'+sbX+'" y2="'+(sbY+1.5)+'" stroke="'+cLabel+'" stroke-width="0.5"/>';
  s += '<line x1="'+(sbX+10)+'" y1="'+(sbY-1.5)+'" x2="'+(sbX+10)+'" y2="'+(sbY+1.5)+'" stroke="'+cLabel+'" stroke-width="0.5"/>';
  s += '<text x="'+(sbX+5)+'" y="'+(sbY-2)+'" text-anchor="middle" fill="'+cLabel+'" font-size="3.5">10\u2032</text>';

  // North arrow ‚Äî bottom-right
  var naX = ox + lw + padR - 4, naY = oy + ld + 10;
  s += '<line x1="'+naX+'" y1="'+(naY+5)+'" x2="'+naX+'" y2="'+naY+'" stroke="'+cLabel+'" stroke-width="0.7"/>';
  s += '<polygon points="'+(naX-1.5)+','+(naY+2)+' '+naX+','+naY+' '+(naX+1.5)+','+(naY+2)+'" fill="'+cLabel+'"/>';
  s += '<text x="'+naX+'" y="'+(naY-1.5)+'" text-anchor="middle" fill="'+cLabel+'" font-size="3.5" font-weight="700">N</text>';

  s += '</svg>';
  return s;
}

function lotPlannerUrl(l){
  var exitSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var p = 'width='+l.lw+'&depth='+l.ld+'&zone='+(l.zone||'R1')+'&street=S';
  p += '&address='+encodeURIComponent(l.address||'');
  p += '&asking='+(l.price||0);
  p += '&lotSF='+(l.lotSf||0);
  if(exitSF) p += '&exitSF='+exitSF;
  return 'https://mlucido.github.io/lot-planner/?'+p;
}

// Lot size display with source + mismatch warning
function lotLabel(l, effPct){
  if(!l.lotSf) return '';
  const src = l.lotSource === 'parcel' ? 'Parcel' : 'MLS';
  const srcColor = l.lotSfParcel ? 'var(--orange)' : 'var(--text-dim)';
  const mismatch = l.lotSfParcel ? ` <small style="color:var(--orange)">&#9888; Parcel: ${l.lotSfParcel.toLocaleString()}</small>` : '';
  const irregWarn = l.lotShape === 'irreg' ? ' <small style="color:var(--orange)">&#9888; irregular</small>' : '';
  const dims = l.lw && l.ld ? ` <small style="color:var(--text-dim)">${l.lw}'\u00d7${l.ld}'</small>${irregWarn}` : '';
  const eff = effPct != null ? ` <small style="color:${effPct>=85?'var(--green)':effPct>=60?'var(--yellow)':'var(--red)'}">(${effPct}% eff)</small>` : '';
  return `<div><div class="popup-label">Lot Size</div><div class="popup-value">${l.lotSf.toLocaleString()} sf <small style="color:${srcColor}">(${src})</small>${dims}${mismatch}${eff}</div></div>`;
}

// Remainder parcel analysis section for R2-R4
function remainderAnalysis(l){
  if(!l.remainderUnits || l.remainderUnits <= 0) return '';
  const viable = l.remainderViable;
  const color = viable && l.remainderUnits >= 8 ? '#22c55e' : viable && l.remainderUnits >= 4 ? '#eab308' : '#ef4444';
  const icon = viable ? '&#9989;' : '&#10060;';
  return `<div class="popup-span-2" style="font-size:10px;line-height:1.6;padding:4px 8px;border-radius:4px;background:${color}15;color:${color}">
    <b>REMAINDER PARCEL ANALYSIS</b><br>
    Total Lot: ${l.lotSf?l.lotSf.toLocaleString():'?'} SF |
    Footprint: -${(l.estFootprint||0).toLocaleString()} SF |
    Driveway: -${(l.drivewayDeduction||2000).toLocaleString()} SF<br>
    <b>Available: ${l.remainderSf.toLocaleString()} SF &#8594; ${l.remainderUnits} units ${icon}</b>
    ${viable ? ' (keep existing structure, develop remainder)' : ' (insufficient for viable development)'}
  </div>`;
}

// BTR (Build-to-Rent) Pro Forma Calculator
function getRentSourceLabel(l) {
  const m = l.rentMethod;
  const psf = l.rentPsf ? ` ($${l.rentPsf.toFixed(2)}/SF)` : '';
  if (m === 'rental-comp') return `${l.rentCompCount} rental comps within ${l.rentCompRadius} mi${psf}`;
  if (m === 'rental-comp-wide') return `${l.rentCompCount} comps within ${l.rentCompRadius} mi <small>(wide)</small>${psf}`;
  if (m === 'rental-adj') return `${l.rentCompCount} comps within ${l.rentCompRadius} mi <small>(2BR adj +15%)</small>${psf}`;
  if (m === 'census-tract') return `Census tract${psf}`;
  if (m === 'zori') return `ZORI <small>ZIP ${l.zip||'\u2014'}</small>${psf}`;
  return `SAFMR <small>ZIP ${l.zip||'\u2014'}</small>${psf}`;
}

function calculateBTRProForma(l){
  // Inherit all BTS (build-to-sell) numbers for shared inputs
  const pf = calculateProForma(l);

  // BTR-specific assumptions (configurable via modal)
  const opexRatio = parseFloat((document.getElementById('btrOpex')||{}).value) || 0.30;
  const capRate = parseFloat((document.getElementById('btrCapRate')||{}).value) || 0.055;
  const refiLTV = parseFloat((document.getElementById('btrLTV')||{}).value) || 0.70;
  const refiRate = parseFloat((document.getElementById('btrRate')||{}).value) || 0.0625;

  const rentPsf = l.rentPsf || (l.estRentMonth > 0 ? l.estRentMonth / 1750 : 0);
  const hasEstRent = rentPsf > 0;
  const rentPerUnit = Math.round(rentPsf * proforma.avgUnitSf);
  const units = pf.maxUnits;
  const totalCost = pf.totalCost;

  // Income ‚Äî opex ratio already includes vacancy allowance
  const grossAnnualRent = rentPerUnit * 12 * units;
  const annualNOI = grossAnnualRent * (1 - opexRatio);

  // Returns
  const yieldOnCost = totalCost > 0 ? annualNOI / totalCost : 0;
  const stabilizedValue = capRate > 0 ? annualNOI / capRate : 0;

  // DSCR: can NOI service an I/O loan that takes out construction principal?
  const loanAmount = pf.constructionCost;
  const annualDebtService = loanAmount * 0.065;  // 6.5% I/O
  const dscr = annualDebtService > 0 ? annualNOI / annualDebtService : 0;

  // Refi (stabilized value based)
  const refiLoanAmount = stabilizedValue * refiLTV;
  const refiAnnualDS = refiLoanAmount * refiRate;
  const cashOutRefi = refiLoanAmount - totalCost;
  const equityAfterRefi = totalCost - refiLoanAmount;
  const cashFlow = annualNOI - refiAnnualDS;
  const cashOnCash = equityAfterRefi > 0 ? cashFlow / equityAfterRefi : 0;

  // GRM: gross sale value / gross annual rent (how many years of rent = sale price)
  const grm = grossAnnualRent > 0 ? pf.grossRevenue / grossAnnualRent : 0;

  // Does it pencil? DSCR >= 1.25x is lender go/no-go
  const btrPencils = dscr >= 1.25 && rentPsf > 0;

  return {
    ...pf,  // inherit all BTS fields
    rentPerUnit,
    rentPsf,
    hasEstRent,
    grm,
    grossAnnualRent,
    annualNOI,
    yieldOnCost,
    stabilizedValue,
    loanAmount,
    annualDebtService,
    dscr,
    refiLoanAmount,
    cashOutRefi,
    cashFlow,
    cashOnCash,
    btrPencils,
    opexRatio,
    capRate,
    refiLTV,
    units,
  };
}

// Generate ZIMAS lookup URL for LA City properties
function getZimasUrl(l){
  if(l.ain) return 'https://zimas.lacity.org/displayreport.aspx?apn=' + l.ain;
  return 'https://zimas.lacity.org/';
}

// Slope score badge for due diligence sections
function slopeBadge(l){
  if(l.slopeScore == null || l.slopeScore <= 30) return '';
  const detail = 'Elev range: '+l.elevRange+'ft | Max slope: '+l.maxSlope+'% | Flat area: '+l.flatPct+'%';
  if(l.slopeScore >= 76) return ' ‚Ä¢ <span style="color:var(--red)">&#10007; SEVERE SLOPE (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
  if(l.slopeScore >= 51) return ' ‚Ä¢ <span style="color:var(--orange)">&#10007; STEEP TERRAIN (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
  return ' ‚Ä¢ <span style="color:var(--yellow)">&#9888; Moderate slope (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
}

// Enrich listings with computed fields
function enrichListings(){
  LISTINGS.forEach(l => {
    l.sb1123Eligible = isSB1123Eligible(l);
    const pf = calculateProForma(l);
    l.maxUnits = pf.maxUnits;
    if (pf.densityUnits > pf.maxUnits) {
      l.densityUnits = pf.densityUnits;
      l.layoutMax = pf.layoutMax;
      l.layoutNote = pf.layoutNote;
    }
    // Slope-adjusted unit warning (informational only ‚Äî does not override pro forma)
    if (l.flatPct != null && l.flatPct < 100 && l.lotSf) {
      const usableFlatSf = Math.max(0, l.lotSf * (l.flatPct / 100) - 2000);
      const slopeAdjUnits = Math.min(l.maxUnits, Math.max(1, Math.floor(usableFlatSf / 1400)));
      if (slopeAdjUnits < l.maxUnits) l.slopeAdjUnits = slopeAdjUnits;
    }
    l.pricePerUnit = pf.pricePerUnit;
    l.estProfit = pf.profit;
    l.estMargin = pf.margin;
    l.totalCost = pf.totalCost;
    l.netRevenue = pf.netRevenue;
    l.totalBuildCost = pf.totalBuildCost;
    l.salePerUnit = pf.maxUnits > 0 ? Math.round(pf.netRevenue / pf.maxUnits) : 0;
    l.buildPerUnit = pf.maxUnits > 0 ? Math.round(pf.totalBuildCost / pf.maxUnits) : 0;
    l.buildableSf = pf.buildableSf;
    l.maxOffer = pf.max_offer;
    l.landPpsf = l.lotSf ? Math.round(l.price / l.lotSf) : null;
    l.lotEfficiency = pf.lot_efficiency ? Math.round(pf.lot_efficiency * 100) : 0; // Store as percentage
    // NEW listing detection: DOM <= 3 = NEW, DOM <= 7 = new this week
    l.isNew = (l.dom !== null && l.dom !== undefined && l.dom <= 3) ? 1 : 0;
    l.isNewThisWeek = (l.dom !== null && l.dom !== undefined && l.dom <= 7) ? 1 : 0;
    // BTR viability flag for dual-deal detection (DSCR >= 1.25x gate)
    if((l.estRentMonth && l.estRentMonth > 0) || (l.fmr3br && l.fmr3br > 0) || l.yocBase > 0){
      const btrPF = calculateBTRProForma(l);
      l.btrViable = btrPF.btrPencils;
    } else {
      l.btrViable = false;
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getFilteredComps(){
  return COMPS.filter(c =>
    zoneState[c.zone] &&
    c.price >= filters.price.min && c.price <= filters.price.max &&
    (c.ppsf || c.price/c.sqft) >= filters.psf.min &&
    (c.ppsf || c.price/c.sqft) <= filters.psf.max &&
    c.sqft >= filters.sqft.min && c.sqft <= filters.sqft.max
  );
}

function isInsideDrawPolygon(lat, lng){
  if(!drawPolygonGeoJSON) return true; // No polygon = everything passes
  return turf.booleanPointInPolygon(turf.point([lng, lat]), drawPolygonGeoJSON);
}

function getFilteredListings(skipZoneFilter){
  const favs = favoritesOnly ? loadFavorites() : null;
  return LISTINGS.filter(l => {
    if(drawPolygonGeoJSON && !isInsideDrawPolygon(l.lat, l.lng)) return false;
    if(favoritesOnly && !favs[listingKey(l)]) return false;
    if(sb1123Mode && !l.sb1123Eligible) return false;
    if(newThisWeekFilter && !l.isNewThisWeek) return false;
    if(hideBurnZones && l.burnZone) return false;
    if(minUnitsFilter > 1 && (l.maxUnits || 0) < minUnitsFilter) return false;
    // Always hide unviable deals (maxOffer <= 0) unless BTR-viable
    if((l.maxOffer || 0) <= 0) {
      if(layerState.btr && l.btrViable) { /* keep ‚Äî BTR economics work */ }
      else return false;
    }
    const zoneOk = skipZoneFilter || !l.zone || zoneState[l.zone];
    const priceOk = l.price >= filters.price.min && l.price <= filters.price.max;
    const isLand = l.zone === 'LAND';
    const psfOk = isLand || (l.ppsf >= filters.psf.min && l.ppsf <= filters.psf.max);
    const sqftOk = isLand || (l.sqft >= filters.sqft.min && l.sqft <= filters.sqft.max);
    const lotVal = l.lotSf || 0;
    const lotAtDefault = filters.lot.min === filters.lot.dataMin && filters.lot.max === filters.lot.dataMax;
    const lotOk = lotAtDefault ? true : (lotVal >= filters.lot.min && lotVal <= filters.lot.max);
    const lotwVal = l.lw || 0;
    const lotwAtDefault = filters.lotw.min === filters.lotw.dataMin && filters.lotw.max === filters.lotw.dataMax;
    const lotwOk = lotwAtDefault ? true : (lotwVal === 0 ? true : (lotwVal >= filters.lotw.min && lotwVal <= filters.lotw.max));
    const slopeVal = l.slope != null ? l.slope : 0;
    const slopeAtDefault = filters.slope.min === filters.slope.dataMin && filters.slope.max === filters.slope.dataMax;
    const slopeOk = slopeAtDefault ? true : (slopeVal >= filters.slope.min && slopeVal <= filters.slope.max);
    const marginVal = l.estMargin || 0;
    const marginAtDefault = filters.margin.min === filters.margin.dataMin && filters.margin.max === filters.margin.dataMax;
    // When BTR layer is on, don't exclude BTR-viable deals via margin filter
    const marginOk = marginAtDefault ? true : (marginVal >= filters.margin.min && marginVal <= filters.margin.max)
      || (layerState.btr && l.btrViable);
    return zoneOk && priceOk && psfOk && sqftOk && lotOk && lotwOk && slopeOk && marginOk;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function rebuildMarkers(){
  Object.values(markerLayers).forEach(l=>l.clearLayers());
  const filtered = getFilteredComps();
  filtered.forEach(comp => {
    const psf = comp.ppsf || Math.round(comp.price / comp.sqft);
    const cm = L.circleMarker([comp.lat,comp.lng],{
      radius:3, color:ZONE_COLORS[comp.zone], fillColor:ZONE_COLORS[comp.zone],
      fillOpacity:0.5, weight:1
    });
    cm.bindPopup(`
      <div class="popup-badge comp">Market Comp</div>
      <div class="popup-title">${comp.address || 'N/A'}</div>
      <div class="popup-grid">
        <div><div class="popup-label">Market Value</div><div class="popup-value">$${comp.price.toLocaleString()}</div></div>
        <div><div class="popup-label">$/SF</div><div class="popup-value" style="color:${ZONE_COLORS[comp.zone]}">$${psf}</div></div>
        <div><div class="popup-label">Size</div><div class="popup-value">${comp.sqft.toLocaleString()} sf</div></div>
        <div><div class="popup-label">Zone</div><div class="popup-value">${comp.zone}</div></div>
        ${comp.zip?`<div><div class="popup-label">Zip</div><div class="popup-value">${comp.zip}</div></div>`:''}
      </div>
      <div style="margin-top:6px;display:flex;gap:8px;justify-content:center">
        <a href="https://www.google.com/maps?q=${comp.lat},${comp.lng}&t=k&z=19" target="_blank" style="color:var(--accent);font-size:11px">Google Maps &#8599;</a>
      </div>
    `,{maxWidth:280});
    cm.addTo(markerLayers[comp.zone]);
  });
  document.getElementById('compCount').textContent = filtered.length.toLocaleString();
  refreshVisibility();
}

function toggleDealCard(el){
  var card = el.closest('.dp-card');
  if(!card) return;
  card.classList.toggle('expanded');
}

function generateDealCard(l, opts){
  opts = opts || {};
  var ctx = opts.context || 'bts';
  var pf = calculateProForma(l);
  var btr = calculateBTRProForma(l);
  var el = exitLabel(l);
  var cc = compConfidence(l);
  var margin = pf.margin;
  var marginColor = margin>=30?'#22c55e':margin>=20?'#facc15':'#9ca3af';
  var isDualViable = margin >= 20 && l.btrViable;

  // Format helpers
  function fmtDollar(n){ return '$'+Math.round(n).toLocaleString(); }
  function fmtShort(n){ return n>=1000000?'$'+(n/1000000).toFixed(2).replace(/0+$/,'').replace(/\.$/,'')+'M':n>=1000?'$'+Math.round(n/1000)+'k':'$'+Math.round(n); }
  function commas(n){ return n!=null?Math.round(n).toLocaleString():'‚Äî'; }

  var effPct = pf.lot_efficiency ? Math.round(pf.lot_efficiency*100) : 0;
  var allInPsf = pf.effective_buildable_sf>0 ? Math.round(pf.totalCost/pf.effective_buildable_sf) : 0;
  var spread = el.psf - allInPsf;
  var sellPerUnit = pf.maxUnits>0 ? Math.round(pf.netRevenue/pf.maxUnits) : 0;
  var profitPerUnit = pf.maxUnits>0 ? Math.round(pf.profit/pf.maxUnits) : 0;

  // ‚îÄ‚îÄ Inline badges (zone, BTS/BTR, DEMO ‚Äî shown inside strip) ‚îÄ‚îÄ
  var inlineBadges = '';
  inlineBadges += '<div class="popup-badge" style="background:'+(ZONE_COLORS[l.zone]||'#666')+'22;color:'+(ZONE_COLORS[l.zone]||'#666')+'">'+(l.zone||'?')+'</div>';
  if(ctx==='btr'){
    inlineBadges += (l.estMargin||0)<=0
      ? '<div class="popup-badge" style="background:rgba(245,158,11,0.2);color:#f59e0b">BTR-ONLY</div>'
      : '<div class="popup-badge" style="background:rgba(234,179,8,0.15);color:#eab308">BTR</div>';
  } else {
    inlineBadges += '<div class="popup-badge" style="background:rgba(34,197,94,0.15);color:#22c55e">BTS</div>';
    if(isDualViable) inlineBadges += '<div class="popup-badge" style="background:rgba(234,179,8,0.15);color:#eab308">BTR</div>';
  }
  if(l.hasStructure) inlineBadges += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">DEMO</div>';
  if(l.isNew) inlineBadges += '<div class="popup-badge" style="background:rgba(34,197,94,0.2);color:#22c55e">NEW</div>';

  // ‚îÄ‚îÄ Alert badges (burn zone, tenant risk, etc ‚Äî shown above strip) ‚îÄ‚îÄ
  var alerts = '';
  if(l.burnZone) alerts += '<div class="popup-badge" style="background:#dc2626;color:#fff;font-weight:700;padding:2px 8px">&#128293; BURN ZONE ‚Äî '+l.burnZone+' Fire</div>';
  if(l.urbanArea===false) alerts += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NOT URBAN AREA</div>';
  if(l.compMethod&&l.compMethod.includes('thin')) alerts += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">THIN COMPS</div>';
  else if(!l.exitPsf&&!l.newconPpsf&&!l.clusterT1psf&&!l.subdivExitPsf) alerts += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NO COMP DATA</div>';
  if(l.zone!=='R1'&&l.zone!=='LAND'){
    if(l.tenantRisk>=3) alerts += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">HIGH TENANT RISK</div>';
    else if(l.tenantRisk>=2) alerts += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">TENANT RISK</div>';
    if(l.rsoRisk) alerts += '<div class="popup-badge" style="background:rgba(220,38,38,0.15);color:#dc2626">RSO ‚Äî ELLIS ACT</div>';
  }
  if(l.remainderViable) alerts += '<div class="popup-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">REMAINDER: '+commas(l.remainderSf)+' SF &#8594; '+l.remainderUnits+' units</div>';
  else if(l.remainderUnits>0) alerts += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">REMAINDER: '+commas(l.remainderSf)+' SF ('+l.remainderUnits+')</div>';

  // ‚îÄ‚îÄ Strip ‚îÄ‚îÄ
  // Extract city from address (after last comma) or use zip
  var addrParts = (l.address||'N/A').split(',');
  var mainAddr = addrParts.length > 1 ? addrParts.slice(0,-1).join(',').trim() : l.address||'N/A';
  var cityLine = addrParts.length > 1 ? addrParts[addrParts.length-1].trim() : '';

  var strip = '<div class="dp-strip" onclick="toggleDealCard(this)">';
  strip += '<div class="dp-addr"><span class="dp-addr-text">'+mainAddr+(cityLine?', <span class="dp-city">'+cityLine+'</span>':'')+(l.zip?' <span class="dp-zip">'+l.zip+'</span>':'')+'</span>';
  strip += '<div class="dp-badges-inline">'+inlineBadges+'</div></div>';
  strip += '<div class="dp-metric"><div class="dp-lbl">List Price</div><div class="dp-val" style="color:'+marginColor+'">'+fmtShort(l.price)+'</div></div>';
  strip += '<div class="dp-metric"><div class="dp-lbl">Exit $/SF</div><div class="dp-val" style="color:'+el.color+'">$'+commas(el.psf)+'</div></div>';
  strip += '<div class="dp-metric"><div class="dp-lbl">Lot Size</div><div class="dp-val">'+(l.lotSf?commas(l.lotSf):'‚Äî')+'</div></div>';
  strip += '<div class="dp-metric"><div class="dp-lbl">Units</div><div class="dp-val" style="color:var(--green)">'+pf.maxUnits+'</div></div>';
  strip += '<div class="dp-toggle">&#9650;</div>';
  strip += '</div>';

  // ‚îÄ‚îÄ Drawer body: 3 columns ‚îÄ‚îÄ

  // Column 1: Economics
  var carryTotal = pf.carryInterest+pf.carryPropTax+pf.insurance+pf.originationFee+(pf.demo>0?pf.demo:0);
  var col1 = '<div class="dp-col"><div class="dp-col-head">Economics</div>';
  col1 += '<div class="dp-row"><span class="dp-k">Construction</span><span class="dp-v">'+fmtDollar(pf.constructionCost)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Build $/SF</span><span class="dp-v"'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':'')+'>'+fmtDollar(pf.adjBuildCostPerSf)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">All-In $/SF</span><span class="dp-v">'+fmtDollar(allInPsf)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Total Cost</span><span class="dp-v">'+fmtDollar(pf.totalCost)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Carry + Soft</span><span class="dp-v">'+fmtDollar(carryTotal)+'</span></div>';
  col1 += '<div class="dp-sep"></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Spread</span><span class="dp-v" style="color:'+(spread>=100?'var(--green)':spread>=0?'var(--yellow)':'var(--red)')+'">'+fmtDollar(spread)+'/sf</span></div>';
  var moColor = pf.max_offer>=l.price?'var(--green)':'var(--red)';
  col1 += '<div class="dp-row"><span class="dp-k">Max Offer</span><span class="dp-v" style="color:'+moColor+'">'+fmtDollar(pf.max_offer)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Est Profit</span><span class="dp-v" style="color:'+(pf.profit>=0?'var(--green)':'var(--red)')+'">'+fmtDollar(pf.profit)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Net Revenue</span><span class="dp-v">'+fmtDollar(pf.netRevenue)+'</span></div>';
  col1 += '</div>';

  // Column 2: Site
  var col2 = '<div class="dp-col"><div class="dp-col-head">Site</div>';
  col2 += '<div class="dp-row"><span class="dp-k">Lot Size</span><span class="dp-v">'+(l.lotSf?commas(l.lotSf)+' sf':'‚Äî')+'</span></div>';
  if(l.lw&&l.ld) col2 += '<div class="dp-row"><span class="dp-k">Dimensions</span><span class="dp-v">'+l.lw+'\' &times; '+l.ld+'\'</span></div>';
  col2 += '<div class="dp-row"><span class="dp-k">Efficiency</span><span class="dp-v" style="color:'+(effPct>=100?'var(--green)':effPct>=60?'var(--yellow)':'var(--red)')+'">'+effPct+'%</span></div>';
  if(l.slope!=null) col2 += '<div class="dp-row"><span class="dp-k">Slope</span><span class="dp-v" style="color:'+(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)')+'">'+l.slope+'%</span></div>';
  if(l.dom!=null) col2 += '<div class="dp-row"><span class="dp-k">DOM</span><span class="dp-v">'+l.dom+'</span></div>';
  if(l.beds) col2 += '<div class="dp-row"><span class="dp-k">Beds / Baths</span><span class="dp-v">'+l.beds+' / '+l.baths+'</span></div>';
  // Lot layout toggle
  if(l.lw&&l.ld&&pf.maxUnits>0&&pf.max_offer>0){
    var lotId = 'dp-lot-'+Math.random().toString(36).slice(2,8);
    col2 += '<div class="dp-lot-toggle" onclick="var b=document.getElementById(\''+lotId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\');event.stopPropagation()"><span class="tri">&#9654;</span> Layout &middot; '+pf.maxUnits+'u</div>';
    col2 += '<div class="dp-lot-body" id="'+lotId+'">'+buildLotLayoutSVG(l,pf)+'</div>';
  }
  col2 += '</div>';

  // Column 3: Pro Forma
  var lbColor = pf.land_basis_psf<120?'var(--green)':pf.land_basis_psf<=160?'var(--yellow)':'var(--red)';
  var col3 = '<div class="dp-col"><div class="dp-col-head">Pro Forma</div>';
  col3 += '<div class="dp-row"><span class="dp-k">Units</span><span class="dp-v">'+pf.maxUnits+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Buildable SF</span><span class="dp-v">'+commas(pf.effective_buildable_sf)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Net Margin</span><span class="dp-v" style="color:'+(margin>=30?'var(--green)':margin>=15?'var(--yellow)':'var(--red)')+'">'+margin.toFixed(1)+'%</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Return on Cost</span><span class="dp-v" style="color:'+(pf.return_on_cost>=0?'var(--green)':'var(--red)')+'">'+pf.return_on_cost.toFixed(1)+'%</span></div>';
  col3 += '<div class="dp-sep"></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Buy / Unit</span><span class="dp-v">'+fmtDollar(pf.pricePerUnit)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Sell / Unit</span><span class="dp-v">'+fmtDollar(sellPerUnit)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Profit / Unit</span><span class="dp-v" style="color:'+(profitPerUnit>=0?'var(--green)':'var(--red)')+'">'+fmtDollar(profitPerUnit)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Land Basis</span><span class="dp-v" style="color:'+lbColor+'">'+fmtDollar(pf.land_basis_psf)+'/sf</span></div>';
  col3 += '</div>';

  // ‚îÄ‚îÄ Comp buttons ‚îÄ‚îÄ
  var compBtns = '<div class="dp-comps">';
  compBtns += '<a class="dp-comp-btn" href="#" onclick="showCompsTable('+l.lat+','+l.lng+');return false">'+cc.count+' Sale Comps <span class="dp-comp-arrow">&#8599;</span></a>';
  var hasRentalComps = typeof RENTAL_COMPS!=='undefined'&&RENTAL_COMPS.length>0&&l.rentMethod&&l.rentMethod.startsWith('rental-comp');
  if(hasRentalComps){
    compBtns += '<a class="dp-comp-btn" href="#" onclick="showRentalCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--orange)">'+(l.rentCompCount||'')+' Rent Comps <span class="dp-comp-arrow">&#8599;</span></a>';
  }
  compBtns += '</div>';

  // ‚îÄ‚îÄ BTR section (2-column) ‚îÄ‚îÄ
  var btrSection = '';
  if(btr.rentPsf>0){
    btrSection = '<div class="dp-btr">';
    // Left column: Rent, NOI, YoC
    btrSection += '<div class="dp-btr-col">';
    btrSection += '<div class="dp-row"><span class="dp-k">Rent / Unit</span><span class="dp-v" style="color:var(--green)">$'+btr.rentPerUnit.toLocaleString()+'/mo <small style="color:var(--text-dim)">($'+btr.rentPsf.toFixed(2)+'/SF)</small></span></div>';
    btrSection += '<div class="dp-row"><span class="dp-k">NOI</span><span class="dp-v">'+fmtDollar(btr.annualNOI)+'</span></div>';
    btrSection += '<div class="dp-row"><span class="dp-k">YoC</span><span class="dp-v" style="color:'+(btr.yieldOnCost>=0.04?'var(--green)':btr.yieldOnCost>=0.03?'var(--yellow)':'var(--red)')+'">'+(btr.yieldOnCost*100).toFixed(1)+'%</span></div>';
    btrSection += '</div>';
    // Right column: Stab Value, Cap Rate, DSCR, Cash Flow
    btrSection += '<div class="dp-btr-col">';
    btrSection += '<div class="dp-row"><span class="dp-k">Stabilized Value</span><span class="dp-v" style="color:'+(btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)')+'">'+fmtShort(btr.stabilizedValue)+'</span></div>';
    btrSection += '<div class="dp-row"><span class="dp-k">Cap Rate</span><span class="dp-v">'+(btr.capRate*100).toFixed(1)+'%</span></div>';
    btrSection += '<div class="dp-row"><span class="dp-k">Cash Flow</span><span class="dp-v" style="color:'+(btr.cashFlow>=0?'var(--green)':'var(--red)')+'">'+fmtDollar(btr.cashFlow)+'/yr</span></div>';
    btrSection += '</div>';
    btrSection += '</div>';
    // Loan summary bar
    var loanAmt = btr.loanAmount;
    var loanAbbr = loanAmt >= 1e6 ? '$'+(loanAmt/1e6).toFixed(1)+'M' : '$'+(loanAmt/1e3).toFixed(0)+'K';
    var annualDS = Math.round(loanAmt * 0.065);
    var dscrOk = btr.dscr >= 1.25;
    var dscrColor = dscrOk ? '#15803d' : '#dc2626';
    btrSection += '<div style="display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 14px;margin:6px 8px 0">';
    btrSection += '<div>';
    btrSection += '<div style="font-size:10px;font-weight:700;letter-spacing:1px;color:#64748b;text-transform:uppercase">I/O Takeout Loan</div>';
    btrSection += '<div style="font-size:12px;color:var(--text)">'+loanAbbr+' @ 6.5% = $'+annualDS.toLocaleString()+'/yr</div>';
    btrSection += '</div>';
    btrSection += '<div style="text-align:right">';
    btrSection += '<div style="font-size:20px;font-weight:700;color:'+dscrColor+'">'+btr.dscr.toFixed(2)+'x</div>';
    btrSection += '<div style="font-size:9px;font-weight:700;letter-spacing:1px;color:'+dscrColor+';text-transform:uppercase">DSCR '+(dscrOk?'&#10003;':'&#10007;')+'</div>';
    btrSection += '</div>';
    btrSection += '</div>';
  }

  // ‚îÄ‚îÄ Due Diligence (one-liner) ‚îÄ‚îÄ
  var ddItems = [];
  if(l.burnZone) ddItems.push('<span style="color:var(--red)">&#10007;</span> Burn zone');
  else if(l.fireZone) ddItems.push('<span style="color:var(--red)">&#10007;</span> VHFHSZ');
  if(l.rsoRisk) ddItems.push('<span style="color:var(--red)">&#10007;</span> RSO');
  var sb = slopeBadge(l);
  if(sb&&sb.includes('&#10007;')) ddItems.push(sb.replace(/^ ‚Ä¢ /,'').replace(/<br>.*/,''));
  if(ddItems.length===0) ddItems.push('<span style="color:var(--green)">&#10003;</span> All checks passed');
  ddItems.push('<span style="color:var(--yellow)">&#9888;</span> TPA = 0 parking');
  var ddLine = '<div class="dp-dd">'+ddItems.join(' &nbsp;&middot;&nbsp; ')+'</div>';

  // ‚îÄ‚îÄ Action buttons (7-button toolbar with icons) ‚îÄ‚îÄ
  var isSaved = isFavorite(l);
  var actions = '<div class="dp-actions">';
  actions += '<button onclick="exportModel('+l.lat+','+l.lng+').catch(console.error)"><span class="dp-icon">&#8595;</span>XLS</button>';
  actions += '<button onclick="exportOM('+l.lat+','+l.lng+').catch(console.error)"><span class="dp-icon">&#128196;</span>OM</button>';
  actions += '<a href="https://www.google.com/maps?q='+l.lat+','+l.lng+'&amp;t=k&amp;z=19" target="_blank"><span class="dp-icon">&#128205;</span>Maps</a>';
  if(l.url) actions += '<a href="'+l.url+'" target="_blank"><span class="dp-icon">&#127968;</span>Redfin</a>';
  else actions += '<span></span>';
  if(l.lw&&l.ld) actions += '<a href="'+lotPlannerUrl(l)+'" target="_blank"><span class="dp-icon">&#128208;</span>Planner</a>';
  else actions += '<span></span>';
  actions += '<button class="'+(isSaved?'active':'')+'" onclick="toggleFavorite('+l.lat+','+l.lng+');this.classList.toggle(\'active\');this.querySelector(\'span:last-child\').textContent=this.classList.contains(\'active\')?\'Saved\':\'Save\'"><span class="dp-icon">&#9733;</span><span>'+(isSaved?'Saved':'Save')+'</span></button>';
  actions += '<button onclick="sharePin('+l.lat+','+l.lng+',event)"><span class="dp-icon">&#8599;</span>Share</button>';
  actions += '</div>';

  // ‚îÄ‚îÄ Assemble ‚îÄ‚îÄ
  var autoExpand = ctx==='btr' ? ' expanded' : '';
  var h = '<div class="dp-card'+autoExpand+'">';
  if(alerts) h += '<div class="dp-alerts">'+alerts+'</div>';
  h += strip;
  h += '<div class="dp-drawer">';
  h += '<div class="dp-body">'+col1+col2+col3+'</div>';
  h += compBtns;
  h += btrSection;
  h += ddLine;
  h += actions;
  h += '</div>';  // end dp-drawer
  h += '</div>';  // end dp-card
  return h;
}

function rebuildListings(){
  listingsLayer.clearLayers();
  // Clear for-sale flags so off-market layer can exclude visible for-sale listings
  LISTINGS.forEach(l => { l._onForSaleLayer = false; });
  const filtered = getFilteredListings();

  filtered.forEach(l => {
    l._onForSaleLayer = true;
    // Color fill by exit $/SF
    const ePsf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const fillColor = exitPsfColor(ePsf);

    const lotSf = l.lotSf || 0;
    const isNewListing = l.isNew;
    const baseRadius = lotSf >= 15000 ? 11 : lotSf >= 10000 ? 9 : 8;
    const radius = isNewListing ? baseRadius + 3 : baseRadius;
    const borderColor = isNewListing ? '#22c55e' : '#f97316'; // Orange border = for-sale identifier
    const markerWeight = isNewListing ? 4 : 2;
    const margin = l.estMargin || 0;
    const isDualViable = margin >= 20 && l.btrViable;
    const cm = L.circleMarker([l.lat,l.lng],{
      radius, color: isDualViable ? '#f59e0b' : borderColor, fillColor,
      fillOpacity: 0.95,
      weight: isDualViable ? 3 : markerWeight,
      pane:'listingsPane',
      className: isNewListing ? 'listing-marker-new' : '',
    });

    cm.bindPopup(generateDealCard(l),{maxWidth:660,className:'deal-popup'});
    cm.addTo(listingsLayer);
  });

  document.getElementById('listingCount').textContent = filtered.length.toLocaleString();
  rebuildTable(filtered);
}

function buildBTRLayer(){
  btrLayer.clearLayers();

  // BTR layer shows ALL BTR-viable deals (DSCR >= 1.25x gate)
  // Dual-viable deals (also BTS profitable) show both a BTS circle and BTR diamond
  const btrListings = getFilteredListings().filter(l => {
    if(!l.sb1123Eligible) return false;
    if(!(l.estRentMonth > 0 || l.fmr3br > 0 || l.yocBase > 0)) return false;
    const btrPF = calculateBTRProForma(l);
    return btrPF.btrPencils;
  });

  btrListings.forEach(l => {
    const btrIcon = L.divIcon({
      className: '',
      html: '<div class="btr-pin"></div>',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });

    const marker = L.marker([l.lat, l.lng], { icon: btrIcon });
    marker.bindPopup(generateDealCard(l, {context:'btr'}), {maxWidth:660, className:'deal-popup'});
    marker.addTo(btrLayer);
  });

}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SALE $/SF NEIGHBORHOOD GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildNeighborhoodLayer(){
  neighborhoodLayer.clearLayers();

  // Grid cell size (0.01¬∞ ‚âà 1km)
  const CELL_SIZE = 0.01;

  // Group listings by neighborhood grid cell
  const cells = {};
  LISTINGS.forEach(l => {
    if(!l.sb1123Eligible) return;
    const exitPsf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    if(!exitPsf) return;
    const cellLat = Math.floor(l.lat / CELL_SIZE) * CELL_SIZE;
    const cellLng = Math.floor(l.lng / CELL_SIZE) * CELL_SIZE;
    const key = `${cellLat},${cellLng}`;
    if(!cells[key]) cells[key] = {lat:cellLat, lng:cellLng, listings:[], exitVals:[]};
    cells[key].listings.push(l);
    cells[key].exitVals.push(exitPsf);
  });

  // Calculate scores for each cell ‚Äî pure exit $/SF
  Object.values(cells).forEach(cell => {
    const vals = cell.exitVals;
    vals.sort((a,b)=>a-b);
    const median = vals.length%2 ? vals[Math.floor(vals.length/2)] : (vals[Math.floor(vals.length/2)-1]+vals[Math.floor(vals.length/2)])/2;
    const min = vals[0], max = vals[vals.length-1];

    // Color by median exit $/SF ‚Äî same scale as exitPsfColor() / listing pins
    const color = exitPsfColor(median);
    let fillOpacity;
    if(median >= 900)      fillOpacity = 0.4;
    else if(median >= 800) fillOpacity = 0.35;
    else if(median >= 700) fillOpacity = 0.35;
    else if(median >= 650) fillOpacity = 0.3;
    else                   fillOpacity = 0.2;

    // Create polygon for cell
    const bounds = [
      [cell.lat, cell.lng],
      [cell.lat + CELL_SIZE, cell.lng],
      [cell.lat + CELL_SIZE, cell.lng + CELL_SIZE],
      [cell.lat, cell.lng + CELL_SIZE]
    ];

    const polygon = L.polygon(bounds, {
      color: color,
      fillColor: color,
      fillOpacity: fillOpacity,
      weight: 1,
      opacity: 0.7
    });

    polygon.bindTooltip(`
      <div style="font-size:12px;font-weight:700;margin-bottom:4px;color:${color}">Exit $/SF: $${median.toFixed(0)}</div>
      <div style="font-size:10px;line-height:1.5">
        <div><strong>Range:</strong> $${min.toFixed(0)} ‚Äì $${max.toFixed(0)}/SF</div>
        <div><strong>Eligible Parcels:</strong> ${vals.length}</div>
      </div>
    `, {permanent: false, direction: 'top'});

    polygon.addTo(neighborhoodLayer);
  });

  document.getElementById('neighborhoodCount').textContent = Object.keys(cells).length.toLocaleString();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRIORITY 4: OFF-MARKET TARGETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildOffMarketLayer(){
  offMarketLayer.clearLayers();
  
  // In a real implementation, this would load a separate parcel dataset
  // For now, we'll simulate "off-market" by filtering existing data
  // that meets SB1123 criteria but isn't in active listings
  
  // Simulate off-market parcels (in practice, load from separate dataset)
  // For demo purposes, let's create a hypothetical off-market filter
  const offMarketListings = LISTINGS.filter(l => {
    if(!l.sb1123Eligible) return false;
    if(l._onForSaleLayer) return false;  // Already visible on For Sale layer

    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;

    // Est. Market Value = hood_psf √ó structure_sf
    const est_market_value = hood_psf * structure_sf;

    // Est. Offer = est_market_value √ó 0.95 (5% below market)
    const est_offer = est_market_value * 0.95;

    // Calculate pro forma metrics for margin calculation
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);

    // Margin at Offer - retail exit model
    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf + (l.sqft > 0 ? proforma.demoCost : 0);
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const f_insurance = proforma.insurance || 40000;
    const f_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + f_insurance + f_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;

    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;

    const lotEff = l.lotEfficiency || 0;
    const slope = l.slope || 0;

    return spread > 150 && margin_at_offer >= 0.25 && lotEff > 70 && !l.fireZone && slope < 15;
  });

  offMarketListings.forEach(l => {
    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;

    // Est. Market Value = hood_psf √ó structure_sf
    const est_market_value = hood_psf * structure_sf;

    // Est. Offer = est_market_value √ó 0.95
    const est_offer = est_market_value * 0.95;

    // Calculate pro forma metrics
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);

    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf + (l.sqft > 0 ? proforma.demoCost : 0);
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const om_insurance = proforma.insurance || 40000;
    const om_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + om_insurance + om_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;

    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    
    const target_margin = 0.30;
    const target_all_in_psf = exit_psf * (1 - target_margin);
    const target_land_basis_psf = target_all_in_psf - adjBuildCostPerSf;
    const target_max_buy = target_land_basis_psf * effective_buildable_sf;
    const headroom = target_max_buy - est_offer;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;
    
    // Color coding for margin_at_offer
    let marginColor = '#ef4444'; // red
    if(margin_at_offer >= 0.30) marginColor = '#22c55e'; // green
    else if(margin_at_offer >= 0.20) marginColor = '#facc15'; // yellow
    
    // Color coding for land_basis_psf
    let landBasisColor = '#ef4444'; // red
    if(land_basis_psf < 120) landBasisColor = '#22c55e'; // green
    else if(land_basis_psf >= 120 && land_basis_psf <= 160) landBasisColor = '#facc15'; // yellow
    
    // Color coding for headroom
    const headroomColor = headroom > 0 ? '#22c55e' : '#ef4444';
    
    // Color by spread for pin
    let pinColor = '#ef4444'; // red
    if(spread >= 300) pinColor = '#059669'; // deep green
    else if(spread >= 200) pinColor = '#22c55e'; // green
    else if(spread >= 100) pinColor = '#eab308'; // yellow
    else if(spread >= 0) pinColor = '#f97316'; // orange
    
    const offMarketIcon = L.divIcon({
      className: '',
      html: `<div style="width:10px;height:10px;border:2px solid ${pinColor};border-radius:50%;background:transparent;position:relative">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:1px;height:8px;background:${pinColor}"></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:1px;background:${pinColor}"></div>
      </div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });
    
    const marker = L.marker([l.lat, l.lng], { icon: offMarketIcon });
    
    // Build full pro forma using est_offer as acquisition price
    const omProxy = Object.assign({}, l, {price: Math.round(est_offer)});
    const pf = calculateProForma(omProxy);
    const btr = calculateBTRProForma(omProxy);
    const omExitPsf = l.clusterT1psf || l.newconPpsf || l.exitPsf || 0;
    const omEstMvPsf = (est_market_value && l.lotSf) ? Math.round(est_market_value / l.lotSf) : null;

    marker.bindPopup(`
      ${l.burnZone ? '<div class="popup-badge" style="background:#dc2626;color:#fff;font-weight:700;padding:4px 10px">&#128293; BURN ZONE ‚Äî '+l.burnZone+' Fire (Jan 2025)</div>' : ''}
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <div class="popup-badge" style="background:#666;color:#fff">OFF-MARKET</div>
        <div class="popup-badge" style="background:${ZONE_COLORS[l.zone]||'#666'}22;color:${ZONE_COLORS[l.zone]||'#666'}">${l.zone} ‚Äî ${ZONE_LABELS[l.zone]||l.zone||'Unknown'}</div>
      </div>
      ${l.hasStructure ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">DEMO REQUIRED</div>' : ''}
      ${l.urbanArea === false ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NOT URBAN AREA</div>' : ''}
      ${l.zone!=='R1'&&l.zone!=='LAND' ? (l.tenantRisk >= 3 ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">HIGH TENANT RISK</div>' : l.tenantRisk >= 2 ? '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">TENANT RISK</div>' : '') : ''}
      ${l.zone!=='R1'&&l.zone!=='LAND'&&l.rsoRisk ? '<div class="popup-badge" style="background:rgba(220,38,38,0.15);color:#dc2626">RSO ‚Äî ELLIS ACT REQUIRED</div>' : ''}
      ${l.remainderViable ? '<div class="popup-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">REMAINDER PARCEL: '+l.remainderSf.toLocaleString()+' SF &#8594; '+l.remainderUnits+' units</div>' : l.remainderUnits > 0 ? '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">REMAINDER: '+l.remainderSf.toLocaleString()+' SF ('+l.remainderUnits+' units)</div>' : ''}
      <div class="popup-title">${l.address || 'N/A'}</div>

      <div class="popup-grid">
        <div><div class="popup-label">Est. Market Value</div><div class="popup-value" style="color:${marginColor}">$${est_market_value > 0 ? Math.round(est_market_value).toLocaleString() : '‚Äî'}</div></div>
        <div><div class="popup-label">Exit $/SF</div><div class="popup-value">$${exitLabel(l).psf} <small style="color:${exitLabel(l).color}">(${exitLabel(l).short}${l.newconCount?', '+l.newconCount:''})</small></div></div>
        <div><div class="popup-label">All-In $/SF</div><div class="popup-value">$${pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0}/sf</div></div>
        <div><div class="popup-label">Spread</div><div class="popup-value" style="color:${(exitLabel(l).psf-(pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0))>=0?'var(--green)':'var(--red)'}">$${exitLabel(l).psf-(pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0)}/sf</div></div>

        ${l.lotSf?lotLabel(l,Math.round(pf.lot_efficiency*100)):'<div></div>'}
        ${l.city?'<div><div class="popup-label">City</div><div class="popup-value">'+l.city+'</div></div>':'<div></div>'}
        <div><div class="popup-label">Zone</div><div class="popup-value">${l.zone||'‚Äî'}${l.zimasZone?' <small style="color:var(--text-dim)">'+l.zimasZone+'</small>':''}</div></div>
        ${l.slope!=null?'<div><div class="popup-label">Terrain Slope</div><div class="popup-value" style="color:'+(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)')+'">'+l.slope+'%</div></div>':'<div></div>'}

        ${proFormaBlock(l, pf, {buyLabel:'Est. Offer/Unit', buyPerUnit:Math.round(est_offer/pf.maxUnits), comparePrice:Math.round(est_offer)})}
      </div>

      <div class="popup-grid-2">
        <div class="popup-section-label">Economics (at Est. Offer $${Math.round(est_offer).toLocaleString()})</div>

        <div><div class="popup-label">Build $/SF${pf.adjBuildCostPerSf>proforma.allInBuildPsf?' <span style="color:var(--orange)">(slope adj)</span>':''}</div><div class="popup-value"${pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':''}>$${pf.adjBuildCostPerSf}/sf</div></div>
        <div><div class="popup-label">Construction</div><div class="popup-value">$${Math.round(pf.constructionCost).toLocaleString()}</div></div>
        ${pf.demo>0?'<div><div class="popup-label">Demo</div><div class="popup-value">$'+pf.demo.toLocaleString()+'</div></div><div></div>':''}
        <div><div class="popup-label">Insurance</div><div class="popup-value">$${pf.insurance.toLocaleString()}</div></div>
        <div><div class="popup-label">Loan Origination (${proforma.originationPct}%)</div><div class="popup-value">$${pf.originationFee.toLocaleString()}</div></div>
        <div><div class="popup-label">Carry Interest (${proforma.holdMonths}mo)</div><div class="popup-value">$${pf.carryInterest.toLocaleString()}</div></div>
        <div><div class="popup-label">Property Tax (${proforma.holdMonths}mo)</div><div class="popup-value">$${pf.carryPropTax.toLocaleString()}</div></div>

        <div class="popup-divider"></div>
        <div><div class="popup-label">Net Revenue</div><div class="popup-value">$${Math.round(pf.netRevenue).toLocaleString()}</div></div>
        <div><div class="popup-label">Est Profit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit).toLocaleString()}</div></div>

        <div><div class="popup-label">Sell / Unit</div><div class="popup-value" style="color:var(--green)">$${Math.round(pf.netRevenue/pf.maxUnits).toLocaleString()}</div></div>
        <div><div class="popup-label">Profit / Unit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit/pf.maxUnits).toLocaleString()}</div></div>

        <div><div class="popup-label">Return on Cost</div><div class="popup-value ${pf.return_on_cost>=0?'popup-profit-positive':'popup-profit-negative'}">${pf.return_on_cost.toFixed(1)}%</div></div>
        <div><div class="popup-label">Net Margin on Sale</div><div class="popup-value ${pf.margin>=0?'popup-profit-positive':'popup-profit-negative'}">${pf.margin.toFixed(1)}%<br><small style="color:var(--text-dim);font-weight:400">(Revenue‚àíCost)/Revenue</small></div></div>

        <div class="popup-divider"></div>
        <div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>
        ${btr.btrPencils
          ? '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(34,197,94,0.1);color:var(--green);font-weight:600;font-size:11px">&#9989; BTR VIABLE ‚Äî '+btr.dscr.toFixed(2)+'x DSCR</div>'
          : btr.rentPsf <= 0
            ? '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(100,116,139,0.1);color:#94a3b8;font-size:11px">&#9888;&#65039; BTR ‚Äî No rent data available</div>'
            : '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(239,68,68,0.1);color:var(--red);font-size:11px">&#10060; BTR ‚Äî '+btr.dscr.toFixed(2)+'x DSCR (need 1.25x)</div>'
        }
        ${btr.rentPsf > 0 ? `
        <div><div class="popup-label">Rent Source</div><div class="popup-value">${getRentSourceLabel(l)}</div></div>
        ${RENTAL_COMPS.length > 0 && l.rentMethod && l.rentMethod.startsWith('rental-comp') ? `<div class="popup-span-2" style="font-size:10px;line-height:1.4"><a href="#" onclick="showRentalCompsTable(${l.lat},${l.lng});return false" style="color:var(--accent);cursor:pointer">${l.rentCompCount} rental comps within ${l.rentCompRadius}mi &#8599;</a></div>` : ''}
        <div><div class="popup-label">Est. Rent/Unit</div><div class="popup-value">$${btr.rentPerUnit.toLocaleString()}/mo <small style="color:var(--text-dim)">($${btr.rentPsf.toFixed(2)}/SF √ó ${proforma.avgUnitSf.toLocaleString()} SF)</small></div></div>
        <div><div class="popup-label">Gross Annual Rent</div><div class="popup-value">$${Math.round(btr.grossAnnualRent).toLocaleString()} <small style="color:var(--text-dim)">(${btr.units} units)</small></div></div>
        <div><div class="popup-label">NOI</div><div class="popup-value">$${Math.round(btr.annualNOI).toLocaleString()} <small style="color:var(--text-dim)">(${Math.round((1-btr.opexRatio)*100)}% of gross)</small></div></div>
        <div><div class="popup-label">OpEx</div><div class="popup-value">${Math.round(btr.opexRatio*100)}% <small style="color:var(--text-dim)">($${Math.round(btr.grossAnnualRent*btr.opexRatio).toLocaleString()}/yr)</small></div></div>
        <div><div class="popup-label">Yield on Cost</div><div class="popup-value" style="color:${btr.yieldOnCost>=0.04?'var(--green)':btr.yieldOnCost>=0.03?'var(--yellow)':'var(--red)'}">${(btr.yieldOnCost*100).toFixed(1)}%</div></div>
        <div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:${btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)'}">$${(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')}M</div></div>
        <div><div class="popup-label">Cap Rate</div><div class="popup-value">${(btr.capRate*100).toFixed(1)}%</div></div>
        ` : `
        <div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:var(--text-dim)">N/A</div></div>
        <div><div class="popup-label">Cap Rate</div><div class="popup-value" style="color:var(--text-dim)">N/A</div></div>
        `}
        ${btr.btrPencils ? `
        <div class="popup-span-2" style="font-size:10px;padding:3px 8px;border-radius:4px;background:${btr.stabilizedValue>=btr.totalCost?'rgba(34,197,94,0.1)':'rgba(239,68,68,0.1)'};color:${btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)'}">${btr.stabilizedValue>=btr.totalCost?'&#9989; Refi-able &mdash; $'+Math.round((btr.stabilizedValue-btr.totalCost)/1000).toLocaleString()+'k equity at '+(btr.capRate*100).toFixed(1)+'% cap':'&#10060; Refi gap: -$'+Math.round((btr.totalCost-btr.stabilizedValue)/1000).toLocaleString()+'k &mdash; cash trapped at '+(btr.capRate*100).toFixed(1)+'% cap'}</div>
        <div><div class="popup-label">DSCR</div><div class="popup-value" style="color:${btr.dscr>=1.25?'var(--green)':btr.dscr>=1.15?'var(--yellow)':'var(--red)'}">${btr.dscr.toFixed(2)}x</div></div>
        <div><div class="popup-label">Cash Flow</div><div class="popup-value" style="color:${btr.cashFlow>=0?'var(--green)':'var(--red)'}">$${Math.round(btr.cashFlow).toLocaleString()}/yr</div></div>
        ` : ''}

        <div class="popup-divider"></div>
        <div class="popup-section-label">Due Diligence</div>
        <div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">
          ${l.zimasZone ? (
            '<span style="color:var(--green)">‚úì</span> ' + l.zimasZone + ' zoning confirmed ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> Not Hillside Area ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> No Historic Overlay ‚Ä¢ ' +
            (l.burnZone ? '<span style="color:var(--red)">‚úó</span> &#128293; BURN ZONE ‚Äî active fire damage area. Insurance unavailable, infrastructure compromised.' : l.fireZone ? '<span style="color:var(--red)">‚úó</span> VHFHSZ fire zone (hard exclusion)' : '<span style="color:var(--green)">‚úì</span> NOT VHFHSZ (safe to build)') + ' ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> No Specific Plan restrictions ‚Ä¢ ' +
            '<span style="color:var(--yellow)">&#9733;</span> Transit Priority Area = 0 parking ‚Ä¢ ' +
            (l.rsoRisk ? '<span style="color:var(--red)">&#10007;</span> RSO rent-controlled (Ellis Act)' : '<span style="color:var(--green)">&#10003;</span> No rent-control/Ellis Act') +
            slopeBadge(l)
          ) : (l.fireZone || l.burnZone || l.slope > 0 ? (
            (l.burnZone ? '<span style="color:var(--red)">‚úó</span> &#128293; BURN ZONE' : l.fireZone ? '<span style="color:var(--red)">‚úó</span> VHFHSZ fire zone' : '<span style="color:var(--green)">‚úì</span> NOT VHFHSZ') +
            slopeBadge(l)
          ) : '<span style="color:var(--text-dim)">No zoning verification data available</span>')}
        </div>
        ${l.rsoRisk&&l.zone!=='R1'&&l.zone!=='LAND' ? '<div class="popup-span-2" style="font-size:10px;color:#dc2626;line-height:1.4">&#9888; RSO: Budget ~$20K/unit relocation + 120-day Ellis Act notice</div>' : ''}
        ${remainderAnalysis(l)}
      </div>
      <div style="margin-top:6px;display:flex;gap:8px;justify-content:center;align-items:center">
        <a href="https://www.google.com/maps?q=${l.lat},${l.lng}&t=k&z=19" target="_blank" style="color:var(--accent);font-size:11px">Google Maps &#8599;</a>
        ${l.url?`<a href="${l.url}" target="_blank" style="color:var(--accent);font-size:11px">Redfin &#8599;</a>`:''}
        ${MARKET.hasZimas?`<a href="${getZimasUrl(l)}" target="_blank" style="color:var(--yellow);font-size:11px">ZIMAS &#8599;</a>`:''}
        ${l.lw && l.ld ? `<a href="${lotPlannerUrl(l)}" target="_blank" style="color:var(--accent);font-size:11px">Layout Planner &#8599;</a>` : ''}
        <button class="popup-fav-btn" onclick="alert('Mail campaign coming soon!')" style="background:var(--accent);color:#fff;border-color:var(--accent)">Mail ‚òÖ</button>
        <button class="popup-fav-btn" onclick="exportModel(${l.lat},${l.lng}).catch(console.error)">&#128202; XLS</button>
        <button class="popup-fav-btn" onclick="exportOM(${l.lat},${l.lng}).catch(console.error)">&#128196; OM</button>
        <button class="popup-fav-btn ${isFavorite(l)?'active':''}" onclick="toggleFavorite(${l.lat},${l.lng});this.classList.toggle('active')">&#9733; ${isFavorite(l)?'Saved':'Save'}</button>
        <button class="popup-fav-btn" onclick="sharePin(${l.lat},${l.lng},event)">&#128279; Share</button>
      </div>
      ${lotLayoutSection(l, pf)}
    `, {maxWidth: 580});

    marker.addTo(offMarketLayer);
  });
  
}

function refreshVisibility(){
  Object.entries(markerLayers).forEach(([z,l])=>{
    if(layerState.markers && zoneState[z]) l.addTo(map);
    else map.removeLayer(l);
  });
  if(compHeatLayer){
    if(layerState.compHeat) compHeatLayer.addTo(map);
    else map.removeLayer(compHeatLayer);
  }
  if(layerState.compHeat){
    compPointsLayer.addTo(map);
    compLabelsLayer.addTo(map);
    updateCompPoints();
  } else {
    map.removeLayer(compPointsLayer);
    map.removeLayer(compLabelsLayer);
  }
  // Sale $/SF neighborhood grid
  if(layerState.neighborhoods){
    if(neighborhoodLayer.getLayers().length === 0) buildNeighborhoodLayer();
    neighborhoodLayer.addTo(map);
  } else {
    map.removeLayer(neighborhoodLayer);
  }
  if(layerState.listings) listingsLayer.addTo(map);
  else map.removeLayer(listingsLayer);
  // Priority 4: Off-market targets
  if(layerState.offMarket){
    if(offMarketLayer.getLayers().length === 0) buildOffMarketLayer();
    offMarketLayer.addTo(map);
  } else {
    map.removeLayer(offMarketLayer);
  }
  if(layerState.btr) {
    if(btrLayer.getLayers().length === 0) buildBTRLayer();
    btrLayer.addTo(map);
  } else {
    map.removeLayer(btrLayer);
  }
  if(fireZoneLayer){
    if(layerState.fireZones) fireZoneLayer.addTo(map);
    else map.removeLayer(fireZoneLayer);
  }
  if(floodZoneLayer){
    if(layerState.floodZones) floodZoneLayer.addTo(map);
    else map.removeLayer(floodZoneLayer);
  }
  if(liquefactionLayer){
    if(layerState.liquefaction) liquefactionLayer.addTo(map);
    else map.removeLayer(liquefactionLayer);
  }
  if(parcelLayer){
    if(layerState.parcels) parcelLayer.addTo(map);
    else map.removeLayer(parcelLayer);
  }
  updatePinLegend();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIN LEGEND (dynamic, updates with layers)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updatePinLegend(){
  const legend = document.getElementById('pinLegend');
  if(!legend) return;
  
  let html = '';
  
  // Show For Sale legend if listings layer is on
  if(layerState.listings){
    html += '<div class="pin-legend-item" style="font-weight:600;font-size:10px;color:var(--text-dim);margin-bottom:4px">Listing Exit $/SF</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#6366f1;border:1.5px solid #f97316"></div> &lt;$650</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#3b82f6;border:1.5px solid #f97316"></div> $650‚Äì700</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22d3ee;border:1.5px solid #f97316"></div> $700‚Äì750</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22c55e;border:1.5px solid #f97316"></div> $750‚Äì800</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#eab308;border:1.5px solid #f97316"></div> $800‚Äì900</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#f97316;border:1.5px solid #f97316"></div> $900+</div>';
  }
  
  // Show BTR legend if Build to Rent layer is on
  if(layerState.btr){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker diamond"></div> BTR-only deal</div>';
  }
  // Show dual-viable legend if both listings and BTR layers are on
  if(layerState.listings && layerState.btr){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="border:2px solid #f59e0b"></div> BTS + BTR viable (amber ring)</div>';
  }
  
  // Show Off-Market legend if off-market layer is on
  if(layerState.offMarket){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker circle"></div> Off-market target</div>';
  }

  // Show tier legend when comp layer is on
  if(layerState.compHeat){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#14b8a6"></div> T1 New/Remodel</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#64748b"></div> T2 Existing</div>';
  }

  // Sale $/SF grid legend
  if(layerState.neighborhoods){
    if(html) html += '<div class="pin-legend-section"></div>';
    html += '<div class="pin-legend-item" style="font-weight:600;font-size:10px;color:var(--text-dim);margin-bottom:4px">Sale $/SF</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#f97316;border-radius:2px"></div> $900+</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#eab308;border-radius:2px"></div> $800‚Äì900</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22c55e;border-radius:2px"></div> $750‚Äì800</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22d3ee;border-radius:2px"></div> $700‚Äì750</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#3b82f6;border-radius:2px"></div> $650‚Äì700</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#6366f1;border-radius:2px"></div> &lt;$650</div>';
  }

  // Risk overlay legends
  if(layerState.fireZones || layerState.floodZones || layerState.liquefaction){
    if(html) html += '<div class="pin-legend-section"></div>';
    if(layerState.fireZones)    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:rgba(239,68,68,0.5);border-radius:2px"></div> VHFHSZ Fire Hazard</div>';
    if(layerState.floodZones)   html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:rgba(59,130,246,0.5);border-radius:2px"></div> FEMA Flood Zone</div>';
    if(layerState.liquefaction)  html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:rgba(147,51,234,0.5);border-radius:2px"></div> Liquefaction Risk</div>';
  }

  legend.innerHTML = html;
  legend.style.display = html ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEAL ASSUMPTIONS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Onboarding ‚îÄ‚îÄ
const ONBOARD_KEY = 'sb1123_onboarded';
function showOnboardingIfNeeded(){
  if(localStorage.getItem(ONBOARD_KEY)) return;
  const tip = document.getElementById('onboarding-tip');
  if(tip) tip.style.display = 'block';
}
function dismissOnboarding(){
  localStorage.setItem(ONBOARD_KEY, '1');
  const tip = document.getElementById('onboarding-tip');
  if(tip) tip.style.display = 'none';
}

function openAssumptionsModal(){
  document.getElementById('assumptionsModal').classList.add('active');
}

function closeAssumptionsModal(){
  document.getElementById('assumptionsModal').classList.remove('active');
}
function closeDataKeyModal(){
  document.getElementById('dataKeyModal').classList.remove('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HERO STAT BAR (updates with filters)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateStatPills(){
  const filtered = getFilteredListings();
  const eligible = filtered.filter(l=>l.sb1123Eligible);
  document.getElementById('pillOnMarket').textContent = eligible.length.toLocaleString();
  const compN = getFilteredComps().length;
  document.getElementById('pillComps').textContent = compN >= 1000 ? (compN/1000).toFixed(1).replace(/\.0$/,'') + 'K' : compN.toLocaleString();
  document.getElementById('pillMinMargin').textContent = filters.margin.min + '%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleZone(zone,enabled){
  zoneState[zone]=enabled;
  applyFilters();
}

function setHeatmapMode(mode) {
  heatmapMode = mode;
  document.getElementById('heatRaw').classList.toggle('active', mode === 'raw');
  document.getElementById('heatNorm').classList.toggle('active', mode === 'normalized');
  document.getElementById('heatmapModeLabel').textContent =
    mode === 'normalized' ? 'T1 (New/Remodel) at 1,750 SF' : 'All sales, raw $/SF';

  if (compHeatLayer) map.removeLayer(compHeatLayer);

  if (mode === 'normalized' && CLUSTERS.length > 0) {
    const HEAT_MIN = 500, HEAT_MAX = 900;
    const heatPts = CLUSTERS.filter(cl => cl.t1psf > 0).map(cl => {
      const intensity = Math.max(0, Math.min(1, (cl.t1psf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
      return [cl.lat, cl.lng, intensity];
    });
    compHeatLayer = L.heatLayer(heatPts, {
      radius: 30, blur: 20, maxZoom: 17, max: 1.0, minOpacity: 0.25,
      pane: 'heatmapPane',
      gradient: { 0.0:'#3b82f6', 0.25:'#22d3ee', 0.50:'#22c55e', 0.75:'#eab308', 1.0:'#ef4444' }
    });
  } else {
    const HEAT_MIN = 600, HEAT_MAX = 1000;
    const heatPts = COMPS.filter(c => c.ppsf > 0).map(c => {
      const intensity = Math.max(0, Math.min(1, (c.ppsf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
      return [c.lat, c.lng, intensity];
    });
    compHeatLayer = L.heatLayer(heatPts, {
      radius: 25, blur: 15, maxZoom: 17, max: 1.0, minOpacity: 0.25,
      pane: 'heatmapPane',
      gradient: { 0.0:'#3b82f6', 0.25:'#22d3ee', 0.50:'#22c55e', 0.75:'#eab308', 1.0:'#ef4444' }
    });
  }

  if (layerState.compHeat) compHeatLayer.addTo(map);
}

var LAYER_COLORS = {listings:'#22c55e',neighborhoods:'#8b5cf6',offMarket:'#3b82f6',btr:'#f59e0b',parcels:'#3b82f6',fireZones:'#ef4444',floodZones:'#3b82f6',liquefaction:'#a855f7',markers:'#64748b',compHeat:'#f0641e'};
function toggleLayer(layer,btn){
  layerState[layer]=!layerState[layer];
  btn.classList.toggle('active');
  if(layer === 'compHeat'){
    document.getElementById('heatmapModeToggle').style.display = layerState.compHeat ? 'block' : 'none';
    document.getElementById('tierFilterSection').style.display = layerState.compHeat ? 'block' : 'none';
  }
  refreshVisibility();
  updateLayersActiveCount();
}
function toggleLayerRow(layer,btn){
  layerState[layer]=!layerState[layer];
  btn.classList.toggle('active');
  // Update dot color
  var dot=btn.querySelector('.ldot');
  if(dot) dot.style.background=layerState[layer]?(LAYER_COLORS[layer]||'#3b82f6'):'#cbd5e1';
  // Tinted border/bg for active state
  if(layerState[layer]){
    var c=LAYER_COLORS[layer]||'#3b82f6';
    btn.style.borderColor=c+'40';
    btn.style.background=c+'08';
  } else {
    btn.style.borderColor='#e2e8f0';
    btn.style.background='transparent';
  }
  if(layer === 'compHeat'){
    document.getElementById('heatmapModeToggle').style.display = layerState.compHeat ? 'block' : 'none';
    document.getElementById('tierFilterSection').style.display = layerState.compHeat ? 'block' : 'none';
  }
  refreshVisibility();
  updateLayersActiveCount();
}
function initLayerRowStates(){
  document.querySelectorAll('.layer-row.active,.layer-cell.active,.chip-btn.active').forEach(function(btn){
    var layer=btn.dataset.layer;
    if(!layer) return;
    var dot=btn.querySelector('.ldot');
    if(dot) dot.style.background=LAYER_COLORS[layer]||'#3b82f6';
    var c=LAYER_COLORS[layer]||'#3b82f6';
    if(btn.classList.contains('chip-btn')) return; // chips use CSS
    btn.style.borderColor=c+'40';
    btn.style.background=c+'08';
  });
}
function updateLayersActiveCount(){
  var n=0;
  ['listings','neighborhoods','offMarket','btr','parcels','fireZones','floodZones','liquefaction'].forEach(function(k){if(layerState[k])n++});
  var el=document.getElementById('layersActiveCount');
  if(el) el.textContent=n+' active';
}

function toggleSection(titleEl){
  titleEl.closest('.section').classList.toggle('collapsed');
}

function toggleListingsPanel(){
  const panel = document.getElementById('listingsPanel');
  const tab = document.getElementById('listingsPanelTab');
  listingsPanelOpen = !listingsPanelOpen;
  panel.classList.toggle('open', listingsPanelOpen);
  if(tab) tab.style.display = listingsPanelOpen ? 'none' : 'flex';
  if(isMobile() && listingsPanelOpen) setSheetState('collapsed');
  setTimeout(() => map.invalidateSize(), 350);
}

// ‚îÄ‚îÄ Panel resize ‚îÄ‚îÄ
(function(){
  const panel = document.getElementById('listingsPanel');
  const handle = document.getElementById('panelResize');
  let startY, startH;
  handle.addEventListener('mousedown', function(e){
    startY = e.clientY; startH = panel.offsetHeight;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    e.preventDefault();
  });
  handle.addEventListener('touchstart', function(e){
    startY = e.touches[0].clientY; startH = panel.offsetHeight;
    document.addEventListener('touchmove', onTouchMove, {passive:false});
    document.addEventListener('touchend', onTouchUp);
  }, {passive:true});
  function onMove(e){
    const diff = startY - e.clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
  }
  function onTouchMove(e){
    const diff = startY - e.touches[0].clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
    e.preventDefault();
  }
  function onUp(){
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    map.invalidateSize();
  }
  function onTouchUp(){
    document.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onTouchUp);
    map.invalidateSize();
  }
})();

// ‚îÄ‚îÄ Presets ‚îÄ‚îÄ
function toggleNewThisWeek(btn){
  // Support both old button and new checkbox style
  if(btn && btn.classList) {
    newThisWeekFilter = !newThisWeekFilter;
    btn.classList.toggle('active', newThisWeekFilter);
  } else {
    const cb = document.getElementById('newThisWeekCheckbox');
    newThisWeekFilter = cb ? cb.checked : !newThisWeekFilter;
  }
  applyFilters();
}

function setFilter(key, min, max){
  const f = filters[key];
  f.min = Math.max(f.dataMin, min);
  f.max = Math.min(f.dataMax, max);
  const sMin = document.getElementById(key+'SliderMin');
  const sMax = document.getElementById(key+'SliderMax');
  const iMin = document.getElementById(key+'Min');
  const iMax = document.getElementById(key+'Max');
  if(sMin) sMin.value = f.min;
  if(sMax) sMax.value = f.max;
  if(iMin) iMin.value = f.min;
  if(iMax) iMax.value = f.max;
  updateFill(key);
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
function updateStats(){
  const filtered = getFilteredListings();

  // Listing count in layers panel
  const listingCountEl = document.getElementById('listingCount');
  if(listingCountEl) listingCountEl.textContent = filtered.length.toLocaleString();

  // Comp stats
  const compFiltered = getFilteredComps();
  const compCountEl = document.getElementById('compCount');
  if(compCountEl) compCountEl.textContent = compFiltered.length.toLocaleString();

  updatePeekStats();
  updateLayerCounts();
}

// Compute layer counts regardless of toggle state so sidebar shows what's available
function updateLayerCounts(){
  // Off-Market count ‚Äî same predicate as buildOffMarketLayer() but without _onForSaleLayer gate
  let offMarketN = 0;
  for(const l of LISTINGS){
    if(!l.sb1123Eligible) continue;
    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;
    const est_market_value = hood_psf * structure_sf;
    const est_offer = est_market_value * 0.95;
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);
    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf + (l.sqft > 0 ? proforma.demoCost : 0);
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const f_insurance = proforma.insurance || 40000;
    const f_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + f_insurance + f_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;
    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;
    const lotEff = l.lotEfficiency || 0;
    const slope = l.slope || 0;
    if(spread > 150 && margin_at_offer >= 0.25 && lotEff > 70 && !l.fireZone && slope < 15) offMarketN++;
  }
  const omEl = document.getElementById('offMarketCount');
  if(omEl) omEl.textContent = offMarketN.toLocaleString();

  // BTR count ‚Äî all BTR-viable deals (DSCR >= 1.25x gate)
  let btrN = 0;
  for(const l of LISTINGS){
    if(!l.sb1123Eligible) continue;
    if(!(l.estRentMonth > 0 || l.fmr3br > 0 || l.yocBase > 0)) continue;
    const btrPF = calculateBTRProForma(l);
    if(btrPF.btrPencils) btrN++;
  }
  const btrEl = document.getElementById('btrCount');
  if(btrEl) btrEl.textContent = btrN.toLocaleString();
}

function updateFilterCount(){
  const comps = getFilteredComps().length;
  const listings = getFilteredListings().length;
  const fc = document.getElementById('filterCount');
  if(fc) fc.textContent = `${comps.toLocaleString()} comps | ${listings.toLocaleString()} listings`;
  const lpc = document.getElementById('listingPanelCount');
  if(lpc) lpc.textContent = `${listings} deals`;
}

let _otherZonesExpanded = false;
function rebuildZoneToggles(){
  const el=document.getElementById('zoneToggles');
  if(!el){ console.error('zoneToggles element not found!'); return; }
  el.innerHTML='';
  const filtered = getFilteredComps();
  // Count listings per zone ignoring zone toggle state (all other filters apply)
  const allFiltered = getFilteredListings(true);

  function makeRow(zone){
    const zc=filtered.filter(c=>c.zone===zone);
    const zl=allFiltered.filter(l=>l.zone===zone);
    const psfs=zc.map(c=>c.ppsf||c.price/c.sqft);
    const avg=psfs.length?Math.round(psfs.reduce((a,b)=>a+b,0)/psfs.length):0;
    const div=document.createElement('label');
    div.className='zone-toggle';
    div.innerHTML=`
      <input type="checkbox" ${zoneState[zone]?'checked':''} onchange="toggleZone('${zone}',this.checked)">
      <span class="check-box"></span>
      <span class="zone-swatch" style="background:${ZONE_COLORS[zone]}"></span>
      <span class="zone-label">${zone} <small>${ZONE_LABELS[zone]}</small></span>
      <span class="zone-stat">${avg?'$'+avg+'/sf':'‚Äî'}<span class="data-count">${zl.length}</span></span>
    `;
    return div;
  }

  // R1 always visible
  el.appendChild(makeRow('R1'));

  // Collapsible group for R2-R4, LAND
  const otherCount = ['R2','R3','R4','LAND'].reduce((n,z)=>n+allFiltered.filter(l=>l.zone===z).length,0);
  const header = document.createElement('div');
  header.style.cssText = 'display:flex;align-items:center;gap:6px;padding:6px 10px;cursor:pointer;font-size:11px;color:var(--text-dim);user-select:none';
  header.innerHTML = `<span id="otherZoneChevron" style="font-size:9px;transition:transform 0.15s;transform:rotate(${_otherZonesExpanded?'90':'0'}deg)">‚ñ∂</span> Other Zones <span class="data-count" style="margin-left:auto">${otherCount}</span>`;
  header.onclick = function(){
    _otherZonesExpanded = !_otherZonesExpanded;
    document.getElementById('otherZoneChevron').style.transform = 'rotate('+(_otherZonesExpanded?90:0)+'deg)';
    document.getElementById('otherZoneRows').style.display = _otherZonesExpanded ? 'block' : 'none';
  };
  el.appendChild(header);

  const otherRows = document.createElement('div');
  otherRows.id = 'otherZoneRows';
  otherRows.style.display = _otherZonesExpanded ? 'block' : 'none';
  ['R2','R3','R4','LAND'].forEach(z => otherRows.appendChild(makeRow(z)));
  el.appendChild(otherRows);
  // Update zoning bar summary (R1 stats)
  var r1c=filtered.filter(c=>c.zone==='R1');
  var r1psfs=r1c.map(c=>c.ppsf||c.price/c.sqft);
  var r1avg=r1psfs.length?Math.round(r1psfs.reduce((a,b)=>a+b,0)/r1psfs.length):0;
  var zbn=document.getElementById('zoningBarName');
  var zbp=document.getElementById('zoningBarPsf');
  var zbsw=document.querySelector('.zoning-bar .zone-sw');
  if(zbn) zbn.textContent='R1';
  if(zbp) zbp.textContent=r1avg?'$'+r1avg+'/sf':'';
  if(zbsw && typeof ZONE_COLORS!=='undefined') zbsw.style.background=ZONE_COLORS.R1||'#3b82f6';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SORTABLE TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getSortValue(l, key){
  if(key==='fav') return isFavorite(l)?1:0;
  if(key==='isNew') return l.isNew ? 2 : l.isNewThisWeek ? 1 : 0;
  if(key==='lw') return l.lw||0;
  if(key==='maxUnits') return l.maxUnits||1;
  if(key==='pricePerUnit') return l.pricePerUnit||Infinity;
  if(key==='salePerUnit') return l.salePerUnit||0;
  if(key==='estProfit') return l.estProfit||(-Infinity);
  if(key==='estMargin') return l.estMargin||(-Infinity);
  const v=l[key]; return v===null||v===undefined ? -Infinity : v;
}

function sortTable(key){
  if(currentSort.key===key) currentSort.dir = currentSort.dir==='asc'?'desc':'asc';
  else{
    currentSort.key=key;
    currentSort.dir = (typeof getSortValue(LISTINGS[0]||{},key)==='string')?'asc':'desc';
  }
  document.querySelectorAll('.listings-table th').forEach(th=>{
    th.classList.remove('sorted');
    const arrow = th.querySelector('.sort-arrow');
    if(arrow) arrow.textContent='‚ñ≤';
  });
  const th=document.querySelector(`.listings-table th[data-sort="${key}"]`);
  if(th){
    th.classList.add('sorted');
    const arrow = th.querySelector('.sort-arrow');
    if(arrow) arrow.textContent=currentSort.dir==='asc'?'‚ñ≤':'‚ñº';
  }
  rebuildTable(getFilteredListings());
}

function rebuildTable(filtered){
  const tbody = document.getElementById('listingsTableBody');
  
  // Only sort if we have a valid sort key
  let sorted = filtered;
  if (currentSort && currentSort.key) {
    sorted = [...filtered].sort((a,b) => {
      let va=getSortValue(a,currentSort.key), vb=getSortValue(b,currentSort.key);
      if(typeof va==='string') va=va.toLowerCase();
      if(typeof vb==='string') vb=vb.toLowerCase();
      if(va<vb) return currentSort.dir==='asc'?-1:1;
      if(va>vb) return currentSort.dir==='asc'?1:-1;
      return 0;
    });
  }

  // Cap table rows for performance
  const display = sorted.slice(0, 500);

  tbody.innerHTML = display.map(l => {
    const zoneColor = ZONE_COLORS[l.zone]||'#666';
    const profitClass = (l.estProfit||0)>=0?'profit-pos':'profit-neg';
    const marginClass = (l.estMargin||0)>=0?'profit-pos':'profit-neg';
    const starred = isFavorite(l);
    const exitPpsf = l.clusterT1psf || l.newconPpsf || l.exitPsf;
    return `<tr onclick="flyToListing(${l.lat},${l.lng})" onmouseenter="highlightMarker(${l.lat},${l.lng})" onmouseleave="unhighlightMarker()">
      <td class="col-fav"><span class="fav-star ${starred?'active':''}" onclick="event.stopPropagation();toggleFavorite(${l.lat},${l.lng})">&#9733;</span></td>
      <td class="col-addr" title="${l.address}">${l.address}</td>
      <td class="col-zone"><span class="zone-pill" style="background:${zoneColor}22;color:${zoneColor}">${l.zone||'‚Äî'}</span></td>
      <td class="col-price mono">$${l.price.toLocaleString()}</td>
      <td class="col-lot mono">${l.lotSf?l.lotSf.toLocaleString():'‚Äî'}</td>
      <td class="col-lotw mono">${l.lw?l.lw+"'":'\u2014'}</td>
      <td class="col-units mono" style="color:${l.maxUnits>=8?'var(--green)':l.maxUnits>=4?'var(--yellow)':'var(--text-dim)'}">${l.maxUnits}${l.layoutNote?' <span style="font-size:9px;color:var(--orange)" title="'+l.layoutNote+'">&#9888;</span>':''}</td>
      <td class="col-hood mono">${exitPpsf?'$'+exitPpsf:'‚Äî'}</td>
      <td class="col-sale mono">${l.salePerUnit?'$'+(l.salePerUnit).toLocaleString():'‚Äî'}</td>
      <td class="col-ppu mono">$${(l.pricePerUnit||0).toLocaleString()}</td>
      <td class="col-profit mono ${profitClass}">$${Math.round(l.estProfit||0).toLocaleString()}</td>
      <td class="col-margin mono ${marginClass}">${(l.estMargin||0).toFixed(0)}%</td>
      <td class="col-slope mono" style="color:${l.slope!=null?(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)'):'var(--text-dim)'}">${l.slope!=null?l.slope+'%':'‚Äî'}${l.slopeScore!=null?' <span style="font-size:9px;color:'+(l.slopeScore<=20?'var(--green)':l.slopeScore<=50?'var(--yellow)':l.slopeScore<=75?'var(--orange)':'var(--red)')+'">S'+l.slopeScore+'</span>':''}</td>
      <td class="col-dom mono">${l.dom!==null&&l.dom!==undefined?l.dom:'‚Äî'}</td>
      <td class="col-new">${l.isNew?'<span class="new-badge">NEW</span>':l.isNewThisWeek?'<span class="new-badge week">7d</span>':''}</td>
      <td class="col-link">${l.url?'<a class="redfin-link" href="'+l.url+'" target="_blank" onclick="event.stopPropagation()">View</a>':''}</td>
    </tr>`;
  }).join('');

  const countStr = sorted.length > 500 ? `${sorted.length} deals (showing 500)` : `${sorted.length} deals`;
  const tablePanelCount = document.getElementById('tablePanelCount');
  if(tablePanelCount) tablePanelCount.textContent = countStr;
  const tabPanelCount = document.getElementById('tabPanelCount');
  if(tabPanelCount) tabPanelCount.textContent = `${sorted.length} deals`;
  rebuildMobileCards(sorted);
}

function flyToListing(lat, lng){
  if(isMobile()){
    if(listingsPanelOpen) toggleListingsPanel();
    setSheetState('collapsed');
  }
  map.flyTo([lat, lng], 16, {duration:0.8});
  listingsLayer.eachLayer(layer => {
    if(layer.getLatLng){
      const ll = layer.getLatLng();
      if(Math.abs(ll.lat-lat)<0.0001 && Math.abs(ll.lng-lng)<0.0001) layer.openPopup();
    }
  });
}

let _highlightedPath = null;
function highlightMarker(lat, lng){
  unhighlightMarker();
  listingsLayer.eachLayer(layer => {
    if(!layer.getLatLng || !layer._path) return;
    const ll = layer.getLatLng();
    if(Math.abs(ll.lat - lat) < 0.0001 && Math.abs(ll.lng - lng) < 0.0001){
      layer._path.classList.add('marker-highlight');
      _highlightedPath = layer._path;
    }
  });
}
function unhighlightMarker(){
  if(_highlightedPath){ _highlightedPath.classList.remove('marker-highlight'); _highlightedPath = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTER MACHINERY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initRangeFilter(key, valueFn, dataSource){
  const f = filters[key];
  const source = dataSource || COMPS;
  const values = source.map(valueFn).filter(v => v > 0);
  if(!values.length) return;
  let vMin = Infinity, vMax = -Infinity;
  for(let i=0;i<values.length;i++){ if(values[i]<vMin) vMin=values[i]; if(values[i]>vMax) vMax=values[i]; }
  f.dataMin = Math.floor(vMin / f.step) * f.step;
  f.dataMax = Math.ceil(vMax / f.step) * f.step;
  if(f.cap && f.dataMax > f.cap) f.dataMax = f.cap;
  f.min = f.dataMin; f.max = f.dataMax;
  if(f.defaultMin != null && f.defaultMin >= f.dataMin) f.min = Math.min(f.defaultMin, f.dataMax);
  if(f.defaultMax != null && f.defaultMax <= f.dataMax) f.max = Math.max(f.defaultMax, f.dataMin);

  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  sMin.min=f.dataMin; sMin.max=f.dataMax; sMin.value=f.min; sMin.step=f.step;
  sMax.min=f.dataMin; sMax.max=f.dataMax; sMax.value=f.max; sMax.step=f.step;
  iMin.value=f.min; iMax.value=f.max;
  updateFill(key);

  let timer=null;
  function debounced(){ clearTimeout(timer); timer=setTimeout(applyFilters, 250); }
  sMin.addEventListener('input', function(){
    let v=parseInt(this.value); if(v>parseInt(sMax.value)-f.step) v=parseInt(sMax.value)-f.step;
    this.value=v; iMin.value=v; f.min=v; updateFill(key); debounced();
  });
  sMax.addEventListener('input', function(){
    let v=parseInt(this.value); if(v<parseInt(sMin.value)+f.step) v=parseInt(sMin.value)+f.step;
    this.value=v; iMax.value=v; f.max=v; updateFill(key); debounced();
  });
  iMin.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMin; v=Math.max(f.dataMin,Math.min(v,f.max-f.step));
    this.value=v; sMin.value=v; f.min=v; updateFill(key); applyFilters();
  });
  iMax.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMax; v=Math.min(f.dataMax,Math.max(v,f.min+f.step));
    this.value=v; sMax.value=v; f.max=v; updateFill(key); applyFilters();
  });
}

function updateFill(key){
  const f=filters[key], fill=document.getElementById(key+'SliderFill');
  if(!fill) return;
  const range=f.dataMax-f.dataMin; if(range<=0) return;
  fill.style.left=((f.min-f.dataMin)/range)*100+'%';
  fill.style.width=((f.max-f.min)/range)*100+'%';
  // Update lot range labels
  if(key==='lot'){
    var lm=document.getElementById('lotRangeMin'),lx=document.getElementById('lotRangeMax');
    if(lm) lm.textContent=fmtSf(f.min);
    if(lx) lx.textContent=fmtSf(f.max);
  }
}
function fmtSf(v){return v>=1000?(v/1000).toFixed(v%1000?1:0).replace(/\.0$/,'')+'K sf':v+' sf'}

function setMarginPreset(minPct,btn){
  document.querySelectorAll('.preset-row .preset-btn, .kf-chips .kf-chip').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const f=filters.margin;
  f.min=minPct; f.max=f.dataMax;
  const sMin=document.getElementById('marginSliderMin'), sMax=document.getElementById('marginSliderMax');
  const iMin=document.getElementById('marginMin'), iMax=document.getElementById('marginMax');
  if(sMin) sMin.value=minPct;
  if(iMin) iMin.value=minPct;
  if(sMax) sMax.value=f.dataMax;
  if(iMax) iMax.value=f.dataMax;
  updateFill('margin');
  applyFilters();
}

function applyFilters(){
  rebuildMarkers();
  rebuildListings();
  if(layerState.btr) buildBTRLayer();
  if(layerState.neighborhoods) buildNeighborhoodLayer();
  if(layerState.offMarket) buildOffMarketLayer();
  rebuildZoneToggles();
  updateStats();
  updateFilterCount();
  updateStatPills();
  refreshVisibility();
  applyPolygonOpacity();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  POLYGON DRAW-TO-FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initDrawControl(){
  const container = L.DomUtil.create('div','draw-control');
  container.innerHTML = `
    <button class="draw-btn" id="drawBtn" title="Draw area to filter">&#9998;</button>
    <button class="draw-btn" id="drawDoneBtn" title="Close polygon" style="display:none;font-size:11px;font-weight:700">Done</button>
    <button class="draw-clear-btn" id="drawClearBtn" title="Clear drawn area">&#10005;</button>
    <button class="draw-btn" id="dataKeyBtn" title="Data Key ‚Äî how metrics are calculated" style="font-size:14px;font-weight:700;margin-top:8px">?</button>
  `;
  document.getElementById('map').appendChild(container);
  L.DomEvent.disableClickPropagation(container);
  L.DomEvent.disableScrollPropagation(container);

  document.getElementById('drawBtn').addEventListener('click', toggleDrawMode);
  document.getElementById('drawDoneBtn').addEventListener('click', function(){ finishPolygon(); });
  document.getElementById('drawClearBtn').addEventListener('click', clearDrawPolygon);
  document.getElementById('dataKeyBtn').addEventListener('click', function(){
    document.getElementById('dataKeyModal').classList.add('active');
  });
}

function toggleDrawMode(){
  if(drawMode) stopDrawMode();
  else startDrawMode();
}

function startDrawMode(){
  drawMode = true;
  drawVertices = [];
  document.getElementById('drawBtn').classList.add('active');
  document.getElementById('drawDoneBtn').style.display = 'none';
  map.getContainer().classList.add('draw-mode');
  map._drawClickHandler = onDrawClick;
  map._drawMoveHandler = onDrawMouseMove;
  map._drawDblClickHandler = onDrawDoubleClick;
  map._drawKeyHandler = onDrawKeyDown;
  map.on('click', map._drawClickHandler);
  map.on('mousemove', map._drawMoveHandler);
  map.on('dblclick', map._drawDblClickHandler);
  document.addEventListener('keydown', map._drawKeyHandler);
  map.doubleClickZoom.disable();
}

function stopDrawMode(){
  drawMode = false;
  document.getElementById('drawBtn').classList.remove('active');
  document.getElementById('drawDoneBtn').style.display = 'none';
  map.getContainer().classList.remove('draw-mode');
  if(drawPreviewLine){ map.removeLayer(drawPreviewLine); drawPreviewLine = null; }
  if(map._drawClickHandler) map.off('click', map._drawClickHandler);
  if(map._drawMoveHandler) map.off('mousemove', map._drawMoveHandler);
  if(map._drawDblClickHandler) map.off('dblclick', map._drawDblClickHandler);
  if(map._drawKeyHandler) document.removeEventListener('keydown', map._drawKeyHandler);
  map.doubleClickZoom.enable();
}

function onDrawClick(e){
  if(!drawMode) return;
  // If we already have 3+ vertices, check snap-to-first (close polygon)
  if(drawVertices.length >= 3){
    const first = map.latLngToContainerPoint(L.latLng(drawVertices[0]));
    const click = map.latLngToContainerPoint(e.latlng);
    if(first.distanceTo(click) < 20){
      finishPolygon();
      return;
    }
  }
  drawVertices.push([e.latlng.lat, e.latlng.lng]);
  updateDrawPreview();
  // Show Done button once we have enough vertices
  if(drawVertices.length >= 3){
    document.getElementById('drawDoneBtn').style.display = 'flex';
  }
}

function onDrawMouseMove(e){
  if(!drawMode || drawVertices.length === 0) return;
  updateDrawPreview(e.latlng);
}

function onDrawDoubleClick(e){
  if(!drawMode) return;
  L.DomEvent.stop(e);
  // Double-click fires two click events first, adding 2 duplicate vertices.
  // Pop the extras so we keep the intended shape.
  if(drawVertices.length > 2) drawVertices.pop();
  if(drawVertices.length > 2) drawVertices.pop();
  if(drawVertices.length >= 3) finishPolygon();
}

function onDrawKeyDown(e){
  if(e.key === 'Escape') stopDrawMode();
  if(e.key === 'Enter' && drawVertices.length >= 3) finishPolygon();
}

function updateDrawPreview(mouseLatLng){
  if(drawPreviewLine){ map.removeLayer(drawPreviewLine); drawPreviewLine = null; }
  if(drawVertices.length === 0) return;
  const pts = drawVertices.map(v => L.latLng(v[0], v[1]));
  if(mouseLatLng) pts.push(mouseLatLng);
  if(pts.length >= 2) pts.push(pts[0]);
  drawPreviewLine = L.polyline(pts, {color:'#2563eb',weight:2,dashArray:'6,6',fillOpacity:0}).addTo(map);
}

function finishPolygon(){
  // Save vertices before stopping draw mode (which doesn't touch drawVertices)
  const verts = drawVertices.slice();
  stopDrawMode();
  if(verts.length < 3) return;
  // Remove old polygon + disable old edit
  disablePolygonEdit();
  if(drawPolygonLayer){ map.removeLayer(drawPolygonLayer); }
  // Create Leaflet polygon (interactive so edit handles work)
  drawPolygonLayer = L.polygon(verts, {
    color:'#2563eb', weight:2, fillColor:'#2563eb', fillOpacity:0.1
  }).addTo(map);
  syncPolygonGeoJSON();
  drawVertices = [];
  // Enable vertex editing
  enablePolygonEdit();
  // Show clear button
  document.getElementById('drawClearBtn').classList.add('visible');
  // Re-apply filters with polygon
  applyFilters();
}

function syncPolygonGeoJSON(){
  if(!drawPolygonLayer) return;
  const latlngs = drawPolygonLayer.getLatLngs()[0];
  const coords = latlngs.map(ll => [ll.lng, ll.lat]);
  coords.push(coords[0]); // Close ring
  drawPolygonGeoJSON = turf.polygon([coords]);
}

let _polyEditHandler = null;
function enablePolygonEdit(){
  if(!drawPolygonLayer) return;
  // Leaflet.draw adds editing capability to polygons
  if(drawPolygonLayer.editing){
    drawPolygonLayer.editing.enable();
    _polyEditHandler = function(){ syncPolygonGeoJSON(); applyFilters(); };
    drawPolygonLayer.on('edit', _polyEditHandler);
    // Leaflet.draw fires 'edit' on the layer when editing completes,
    // but for live drag updates we listen on the map's editvertex events
    map.on('draw:editvertex', _polyEditHandler);
  }
}

function disablePolygonEdit(){
  if(drawPolygonLayer && drawPolygonLayer.editing){
    drawPolygonLayer.editing.disable();
    if(_polyEditHandler){
      drawPolygonLayer.off('edit', _polyEditHandler);
      map.off('draw:editvertex', _polyEditHandler);
    }
  }
  _polyEditHandler = null;
}

function clearDrawPolygon(){
  disablePolygonEdit();
  if(drawPolygonLayer){ map.removeLayer(drawPolygonLayer); drawPolygonLayer = null; }
  drawPolygonGeoJSON = null;
  drawVertices = [];
  document.getElementById('drawClearBtn').classList.remove('visible');
  document.getElementById('drawBtn').classList.remove('active');
  document.getElementById('drawDoneBtn').style.display = 'none';
  applyFilters();
}

function applyPolygonOpacity(){
  if(!drawPolygonGeoJSON) return; // No polygon ‚Äî nothing to dim
  // Dim off-market markers outside polygon
  offMarketLayer.eachLayer(function(marker){
    if(marker.getLatLng){
      const ll = marker.getLatLng();
      const inside = isInsideDrawPolygon(ll.lat, ll.lng);
      marker.setStyle({opacity: inside ? 1 : 0.2, fillOpacity: inside ? 0.85 : 0.1});
    }
  });
  // Dim BTR markers outside polygon
  btrLayer.eachLayer(function(marker){
    if(marker.getLatLng){
      const ll = marker.getLatLng();
      const inside = isInsideDrawPolygon(ll.lat, ll.lng);
      marker.setStyle({opacity: inside ? 1 : 0.2, fillOpacity: inside ? 0.85 : 0.1});
    }
  });
  // Dim comp markers outside polygon
  Object.values(markerLayers).forEach(function(layer){
    layer.eachLayer(function(marker){
      if(marker.getLatLng){
        const ll = marker.getLatLng();
        const inside = isInsideDrawPolygon(ll.lat, ll.lng);
        marker.setStyle({opacity: inside ? 1 : 0.15, fillOpacity: inside ? 0.5 : 0.05});
      }
    });
  });
}

function resetFilter(key){
  if(key==='all'){
    ['margin','price','psf','sqft','lot','lotw','slope'].forEach(k=>resetFilter(k));
    newThisWeekFilter=false;
    var ntwCb=document.getElementById('newThisWeekCheckbox'); if(ntwCb) ntwCb.checked=false;
    resetMinUnits();
    document.querySelectorAll('.preset-btn,.kf-chip').forEach(b=>b.classList.remove('active'));
    // Re-activate the 30%+ chip as default
    var defChip=document.querySelector('.kf-chip');
    if(defChip) defChip.classList.add('active');
    return;
  }
  const f=filters[key]; f.min=f.dataMin; f.max=f.dataMax;
  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  if(sMin) sMin.value=f.dataMin;
  if(sMax) sMax.value=f.dataMax;
  if(iMin) iMin.value=f.dataMin;
  if(iMax) iMax.value=f.dataMax;
  updateFill(key);
  applyFilters();
}

function onProformaChange(){
  proforma.allInBuildPsf = parseInt(document.getElementById('pfBuildCost').value)||360;
  proforma.avgUnitSf = parseInt(document.getElementById('pfUnitSize').value)||1750;
  proforma.txnCostPct = parseFloat(document.getElementById('pfTxnCost').value)||4.7;
  proforma.fixedDispositionCosts = parseInt(document.getElementById('pfFixedDisp').value)||40000;
  proforma.demoCost = parseInt(document.getElementById('pfDemoCost').value)||55000;
  proforma.holdMonths = parseInt(document.getElementById('pfHoldMonths').value)||24;
  proforma.carryRatePct = parseFloat(document.getElementById('pfCarryRate').value)||9;
  proforma.insurance = parseInt(document.getElementById('pfInsurance').value)||40000;
  proforma.originationPct = parseFloat(document.getElementById('pfOrigination').value)||1;
  enrichListings();
  applyFilters();
}

// ‚îÄ‚îÄ Export ‚îÄ‚îÄ
function exportCSV(){
  const filtered = getFilteredListings();
  if(!filtered.length) return;
  const headers = ['Fav','Address','Zone','Price','Lot SF','Lot Width','Units','Exit $/SF','Sale/Unit','Buy/Unit','Build/Unit','Profit','Margin %','Slope %','DOM','City','AIN','Notes','URL'];
  const favs = loadFavorites();
  const rows = filtered.map(l=>[
    favs[listingKey(l)]?'*':'', l.address, l.zone, l.price,
    l.lotSf||'', l.lw||'', l.maxUnits, l.clusterT1psf||l.newconPpsf||l.exitPsf||0,
    l.salePerUnit||'', l.pricePerUnit||'', l.buildPerUnit||'',
    Math.round(l.estProfit||0), (l.estMargin||0).toFixed(1),
    l.slope!=null?l.slope:'', l.dom!==null?l.dom:'', l.city||'',
    l.ain||'', (favs[listingKey(l)]||{}).notes||'', l.url||''
  ]);
  const csv = [headers,...rows].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='sb1123_deals_export.csv'; a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ Excel Export Helpers ‚îÄ‚îÄ
function colLetter(n) {
  var s = '';
  while (n > 0) { n--; s = String.fromCharCode(65 + (n % 26)) + s; n = Math.floor(n / 26); }
  return s;
}
function setVal(ws, addr, value, numFmt) {
  var cell = ws.getCell(addr);
  cell.value = value;
  if (numFmt) cell.numFmt = numFmt;
}
function setFormula(ws, addr, formula, result, numFmt) {
  var cell = ws.getCell(addr);
  cell.value = { formula: formula, result: result != null ? result : 0 };
  if (numFmt) cell.numFmt = numFmt;
}
function sectionHeader(ws, row, col, text) {
  var cell = ws.getCell(colLetter(col) + row);
  cell.value = text;
  cell.font = { bold: true, size: 11 };
}
function labelCell(ws, row, col, text) {
  var cell = ws.getCell(colLetter(col) + row);
  cell.value = text;
  cell.font = { color: { argb: 'FF666666' } };
}
var _hdrFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1B2A4A' } };
var _hdrFont = { bold: true, color: { argb: 'FFFFFFFF' }, size: 11 };
var _inputFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFDE7' } };
var _borderThin = { style: 'thin', color: { argb: 'FFCCCCCC' } };
var _borders = { top: _borderThin, bottom: _borderThin, left: _borderThin, right: _borderThin };
function inputCell(ws, addr, value, numFmt) {
  var cell = ws.getCell(addr);
  cell.value = value;
  cell.fill = _inputFill;
  cell.border = _borders;
  if (numFmt) cell.numFmt = numFmt;
}

function buildAssumptionsTab(wb, l, pf, ed, exitPSF, monthlyRent) {
  var ws = wb.addWorksheet('Assumptions');
  ws.getColumn(1).width = 2;
  ws.getColumn(2).width = 20;
  ws.getColumn(3).width = 18;
  ws.getColumn(4).width = 3;
  ws.getColumn(5).width = 2;
  ws.getColumn(6).width = 20;
  ws.getColumn(7).width = 18;

  var units = pf.maxUnits;
  var avgUnitSF = proforma.avgUnitSf;
  var buildCostPSF = pf.adjBuildCostPerSf;
  var lotWidth = l.lw || Math.round(Math.sqrt((l.lotSf || 10000) * 0.33));
  var lotDepth = l.ld || Math.round((l.lotSf || 10000) / lotWidth);
  var slopeDecimal = (l.slope || 0) / 100;
  var bedsBaths = (l.beds || '') + ' / ' + (l.baths || '');
  var buildableSF = units * avgUnitSF;
  var hardCosts = buildableSF * buildCostPSF;
  var grossRevenue = units * avgUnitSF * exitPSF;
  var txCostPct = proforma.txnCostPct / 100;
  var start = new Date();
  start.setDate(start.getDate() + 60);
  start.setDate(1);

  // Title
  ws.mergeCells('B2:C2');
  var titleCell = ws.getCell('B2');
  titleCell.value = 'SB 1123 Pro Forma';
  titleCell.font = { bold: true, size: 14 };

  // ‚îÄ‚îÄ Left: Property & Development ‚îÄ‚îÄ
  ws.getCell('B4').value = 'PROPERTY';
  ws.getCell('B4').font = _hdrFont; ws.getCell('B4').fill = _hdrFill;
  ws.getCell('C4').fill = _hdrFill;

  labelCell(ws, 5, 2, 'Address');       inputCell(ws, 'C5', l.address || '');
  labelCell(ws, 6, 2, 'City, Zip');     inputCell(ws, 'C6', (l.city || '') + (l.zip ? ', ' + l.zip : ''));
  labelCell(ws, 7, 2, 'Zoning');        inputCell(ws, 'C7', (l.zone || 'R1').toUpperCase());
  labelCell(ws, 8, 2, 'Lot SF');        inputCell(ws, 'C8', l.lotSf || 0, '#,##0');
  labelCell(ws, 9, 2, 'Lot Width');     inputCell(ws, 'C9', lotWidth, '#,##0');
  labelCell(ws, 10, 2, 'Lot Depth');    inputCell(ws, 'C10', lotDepth, '#,##0');
  labelCell(ws, 11, 2, 'Slope');        inputCell(ws, 'C11', slopeDecimal, '0.0%');
  labelCell(ws, 12, 2, 'Beds / Baths'); inputCell(ws, 'C12', bedsBaths);
  labelCell(ws, 13, 2, 'DOM');          inputCell(ws, 'C13', l.dom || 0, '#,##0');

  ws.getCell('B15').value = 'ACQUISITION';
  ws.getCell('B15').font = _hdrFont; ws.getCell('B15').fill = _hdrFill;
  ws.getCell('C15').fill = _hdrFill;

  labelCell(ws, 16, 2, 'Purchase Price'); inputCell(ws, 'C16', l.price || 0, '$#,##0');

  ws.getCell('B19').value = 'DEVELOPMENT';
  ws.getCell('B19').font = _hdrFont; ws.getCell('B19').fill = _hdrFill;
  ws.getCell('C19').fill = _hdrFill;

  labelCell(ws, 20, 2, 'Units');           inputCell(ws, 'C20', units, '#,##0');
  labelCell(ws, 21, 2, 'Avg Unit SF');     inputCell(ws, 'C21', avgUnitSF, '#,##0');
  labelCell(ws, 22, 2, 'Buildable SF');    setFormula(ws, 'C22', 'C20*C21', buildableSF, '#,##0');
  labelCell(ws, 23, 2, 'Build Cost $/SF'); inputCell(ws, 'C23', buildCostPSF, '$#,##0');
  labelCell(ws, 24, 2, 'Hard Costs');      setFormula(ws, 'C24', 'C22*C23', hardCosts, '$#,##0');
  labelCell(ws, 25, 2, 'Soft Cost %');     inputCell(ws, 'C25', 0.25, '0.0%');
  labelCell(ws, 26, 2, 'Soft Costs');      setFormula(ws, 'C26', 'C24*C25', hardCosts * 0.25, '$#,##0');
  labelCell(ws, 27, 2, 'Demo');            inputCell(ws, 'C27', 55000, '$#,##0');
  labelCell(ws, 28, 2, 'Subdivision');     inputCell(ws, 'C28', 100000, '$#,##0');
  labelCell(ws, 29, 2, 'A&E');             inputCell(ws, 'C29', 150000, '$#,##0');
  labelCell(ws, 30, 2, 'Total Dev Costs'); setFormula(ws, 'C30', 'C24+C26+C27+C28+C29', hardCosts + hardCosts * 0.25 + 55000 + 100000 + 150000, '$#,##0');
  ws.getCell('C30').font = { bold: true };

  ws.getCell('B34').value = 'EXIT';
  ws.getCell('B34').font = _hdrFont; ws.getCell('B34').fill = _hdrFill;
  ws.getCell('C34').fill = _hdrFill;

  labelCell(ws, 35, 2, 'Exit $/SF');       inputCell(ws, 'C35', exitPSF, '$#,##0');
  labelCell(ws, 36, 2, 'Gross Revenue');   setFormula(ws, 'C36', 'C20*C21*C35', grossRevenue, '$#,##0');
  labelCell(ws, 37, 2, 'Txn Cost %');      inputCell(ws, 'C37', txCostPct, '0.0%');
  labelCell(ws, 38, 2, 'Net Proceeds');    setFormula(ws, 'C38', 'C36*(1-C37)', grossRevenue * (1 - txCostPct), '$#,##0');
  ws.getCell('C38').font = { bold: true };

  ws.getCell('B41').value = 'WATERFALL';
  ws.getCell('B41').font = _hdrFont; ws.getCell('B41').fill = _hdrFill;
  ws.getCell('C41').fill = _hdrFill;

  labelCell(ws, 42, 2, 'LP Pref Rate');      inputCell(ws, 'C42', 0.08, '0.0%');
  labelCell(ws, 43, 2, 'GP Promote %');       inputCell(ws, 'C43', 0.20, '0.0%');
  labelCell(ws, 44, 2, 'GP Co-Invest %');     inputCell(ws, 'C44', 0.05, '0.0%');

  ws.getCell('B47').value = 'BTR HOLD';
  ws.getCell('B47').font = _hdrFont; ws.getCell('B47').fill = _hdrFill;
  ws.getCell('C47').fill = _hdrFill;

  labelCell(ws, 48, 2, 'BTR Rent/Mo');     inputCell(ws, 'C48', monthlyRent, '$#,##0');
  labelCell(ws, 50, 2, 'BTR OpEx Ratio');  inputCell(ws, 'C50', 0.30, '0.0%');
  labelCell(ws, 51, 2, 'BTR Cap Rate');    inputCell(ws, 'C51', 0.055, '0.0%');
  labelCell(ws, 52, 2, 'BTR Refi LTV');    inputCell(ws, 'C52', 0.70, '0.0%');
  labelCell(ws, 53, 2, 'BTR Perm Rate');   inputCell(ws, 'C53', 0.0625, '0.00%');
  labelCell(ws, 54, 2, 'BTR Rent Growth'); inputCell(ws, 'C54', 0.03, '0.0%');

  // ‚îÄ‚îÄ Right: Timeline & Capital ‚îÄ‚îÄ
  ws.getCell('F4').value = 'TIMELINE';
  ws.getCell('F4').font = _hdrFont; ws.getCell('F4').fill = _hdrFill;
  ws.getCell('G4').fill = _hdrFill;

  labelCell(ws, 5, 6, 'Pre-Dev Months');      inputCell(ws, 'G5', 6, '#,##0');
  labelCell(ws, 6, 6, 'Construction Months');  inputCell(ws, 'G6', 12, '#,##0');
  labelCell(ws, 7, 6, 'Sale Months');          inputCell(ws, 'G7', 6, '#,##0');
  labelCell(ws, 8, 6, 'Hold Months');          setFormula(ws, 'G8', 'G5+G6+G7', 24, '#,##0');
  ws.getCell('G8').font = { bold: true };
  labelCell(ws, 9, 6, 'Start Date');           inputCell(ws, 'G9', start, 'MMM YYYY');

  ws.getCell('F13').value = 'CAPITAL STRUCTURE';
  ws.getCell('F13').font = _hdrFont; ws.getCell('F13').fill = _hdrFill;
  ws.getCell('G13').fill = _hdrFill;

  labelCell(ws, 14, 6, 'Equity');              inputCell(ws, 'G14', ed.equity, '$#,##0');
  labelCell(ws, 15, 6, 'Debt');                inputCell(ws, 'G15', ed.debt, '$#,##0');
  labelCell(ws, 16, 6, 'Total Project Cost');  setFormula(ws, 'G16', 'G14+G15', ed.equity + ed.debt, '$#,##0');
  ws.getCell('G16').font = { bold: true };
  labelCell(ws, 17, 6, 'Equity %');            setFormula(ws, 'G17', 'G14/G16', ed.equity / (ed.equity + ed.debt), '0.0%');
  labelCell(ws, 18, 6, 'Interest Rate');       inputCell(ws, 'G18', 0.09, '0.0%');
  labelCell(ws, 19, 6, 'Orig Fee %');          inputCell(ws, 'G19', 0.02, '0.0%');
  labelCell(ws, 20, 6, 'Orig Fee $');          setFormula(ws, 'G20', 'G15*G19', ed.debt * 0.02, '$#,##0');

  ws.getCell('F25').value = 'CARRY COSTS';
  ws.getCell('F25').font = _hdrFont; ws.getCell('F25').fill = _hdrFill;
  ws.getCell('G25').fill = _hdrFill;

  labelCell(ws, 26, 6, 'Prop Tax Rate');    inputCell(ws, 'G26', 0.011, '0.000%');
  labelCell(ws, 27, 6, 'Monthly Tax');      setFormula(ws, 'G27', 'C16*G26/12', (l.price || 0) * 0.011 / 12, '$#,##0');
  labelCell(ws, 28, 6, 'Insurance Annual'); inputCell(ws, 'G28', 20000, '$#,##0');
  labelCell(ws, 29, 6, 'Monthly Insurance'); setFormula(ws, 'G29', 'G28/12', 20000 / 12, '$#,##0');

  ws.getCell('F32').value = 'FEES';
  ws.getCell('F32').font = _hdrFont; ws.getCell('F32').fill = _hdrFill;
  ws.getCell('G32').fill = _hdrFill;

  labelCell(ws, 33, 6, 'Acq Fee %');       inputCell(ws, 'G33', 0.02, '0.0%');
  labelCell(ws, 34, 6, 'Acq Fee $');       setFormula(ws, 'G34', 'C16*G33', (l.price || 0) * 0.02, '$#,##0');
  labelCell(ws, 35, 6, 'AM Monthly');       inputCell(ws, 'G35', 3000, '$#,##0');
  labelCell(ws, 36, 6, 'DM Monthly');       inputCell(ws, 'G36', 5000, '$#,##0');
  labelCell(ws, 37, 6, 'Disp Fee %');      inputCell(ws, 'G37', 0.015, '0.0%');
  labelCell(ws, 38, 6, 'Disp Fee $');      setFormula(ws, 'G38', 'C36*G37', grossRevenue * 0.015, '$#,##0');

  // Print setup
  ws.pageSetup = { orientation: 'portrait', fitToPage: true, fitToWidth: 1 };
  return ws;
}

function buildSourcesUsesTab(wb, l, ed, pf) {
  var ws = wb.addWorksheet('Sources & Uses');
  ws.getColumn(1).width = 2;
  ws.getColumn(2).width = 22;
  ws.getColumn(3).width = 16;
  ws.getColumn(4).width = 12;
  ws.getColumn(5).width = 3;
  ws.getColumn(6).width = 22;
  ws.getColumn(7).width = 16;
  ws.getColumn(8).width = 12;

  var units = pf.maxUnits;
  var avgUnitSF = proforma.avgUnitSf;
  var buildCostPSF = pf.adjBuildCostPerSf;
  var buildableSF = units * avgUnitSF;
  var hardCosts = buildableSF * buildCostPSF;
  var softCosts = hardCosts * 0.25;
  var price = l.price || 0;
  var monthlyTax = price * 0.011 / 12;

  // Title
  ws.mergeCells('B2:H2');
  ws.getCell('B2').value = 'Sources & Uses of Funds';
  ws.getCell('B2').font = { bold: true, size: 14 };

  // ‚îÄ‚îÄ SOURCES ‚îÄ‚îÄ
  ws.getCell('B4').value = 'SOURCES';
  ws.getCell('B4').font = _hdrFont; ws.getCell('B4').fill = _hdrFill;
  ws.getCell('C4').value = 'Amount'; ws.getCell('C4').font = _hdrFont; ws.getCell('C4').fill = _hdrFill;
  ws.getCell('D4').value = '% of Total'; ws.getCell('D4').font = _hdrFont; ws.getCell('D4').fill = _hdrFill;

  sectionHeader(ws, 5, 2, 'Senior Debt');
  labelCell(ws, 6, 2, '  Construction Loan');
  setFormula(ws, 'C6', 'Assumptions!G15', ed.debt, '$#,##0');
  labelCell(ws, 7, 2, '  Origination Fee');
  setFormula(ws, 'C7', 'Assumptions!G20', ed.debt * 0.02, '$#,##0');
  ws.getCell('C7').font = { color: { argb: 'FF999999' }, italic: true };

  sectionHeader(ws, 9, 2, 'Equity');
  labelCell(ws, 10, 2, '  LP Equity');
  setFormula(ws, 'C10', 'Assumptions!G14*(1-Assumptions!C44)', ed.equity * 0.95, '$#,##0');
  labelCell(ws, 11, 2, '  GP Co-Invest');
  setFormula(ws, 'C11', 'Assumptions!G14*Assumptions!C44', ed.equity * 0.05, '$#,##0');

  labelCell(ws, 13, 2, 'TOTAL SOURCES');
  ws.getCell('B13').font = { bold: true };
  setFormula(ws, 'C13', 'C6+C10+C11', ed.debt + ed.equity, '$#,##0');
  ws.getCell('C13').font = { bold: true };
  ws.getCell('C13').border = { top: { style: 'double', color: { argb: 'FF000000' } } };
  setFormula(ws, 'D13', 'C13/C13', 1, '0.0%');

  // Source % of total
  setFormula(ws, 'D6', 'C6/C$13', ed.debt / (ed.debt + ed.equity), '0.0%');
  setFormula(ws, 'D10', 'C10/C$13', ed.equity * 0.95 / (ed.debt + ed.equity), '0.0%');
  setFormula(ws, 'D11', 'C11/C$13', ed.equity * 0.05 / (ed.debt + ed.equity), '0.0%');

  // ‚îÄ‚îÄ USES ‚îÄ‚îÄ
  ws.getCell('F4').value = 'USES';
  ws.getCell('F4').font = _hdrFont; ws.getCell('F4').fill = _hdrFill;
  ws.getCell('G4').value = 'Amount'; ws.getCell('G4').font = _hdrFont; ws.getCell('G4').fill = _hdrFill;
  ws.getCell('H4').value = '% of Total'; ws.getCell('H4').font = _hdrFont; ws.getCell('H4').fill = _hdrFill;

  sectionHeader(ws, 5, 6, 'Land Acquisition');
  labelCell(ws, 6, 6, '  Purchase Price');
  setFormula(ws, 'G6', 'Assumptions!C16', price, '$#,##0');
  labelCell(ws, 7, 6, '  Acq Fee');
  setFormula(ws, 'G7', 'Assumptions!G34', price * 0.02, '$#,##0');

  sectionHeader(ws, 9, 6, 'Development');
  labelCell(ws, 10, 6, '  Hard Costs');
  setFormula(ws, 'G10', 'Assumptions!C24', hardCosts, '$#,##0');
  labelCell(ws, 11, 6, '  Soft Costs');
  setFormula(ws, 'G11', 'Assumptions!C26', softCosts, '$#,##0');
  labelCell(ws, 12, 6, '  Demo');
  setFormula(ws, 'G12', 'Assumptions!C27', 55000, '$#,##0');
  labelCell(ws, 13, 6, '  Subdivision');
  setFormula(ws, 'G13', 'Assumptions!C28', 100000, '$#,##0');
  labelCell(ws, 14, 6, '  A&E');
  setFormula(ws, 'G14', 'Assumptions!C29', 150000, '$#,##0');

  sectionHeader(ws, 16, 6, 'Carry');
  labelCell(ws, 17, 6, '  Interest Reserve');
  setFormula(ws, 'G17', "'Cash Flow'!AA39", 0, '$#,##0'); // Total cumulative interest from CF
  labelCell(ws, 18, 6, '  Property Tax');
  setFormula(ws, 'G18', 'Assumptions!G27*Assumptions!G8', monthlyTax * 24, '$#,##0');
  labelCell(ws, 19, 6, '  Insurance');
  setFormula(ws, 'G19', 'Assumptions!G28*(Assumptions!G8/12)', 20000 * 2, '$#,##0');
  labelCell(ws, 20, 6, '  Asset Mgmt');
  setFormula(ws, 'G20', 'Assumptions!G35*Assumptions!G8', 3000 * 24, '$#,##0');
  labelCell(ws, 21, 6, '  Dev Mgmt');
  setFormula(ws, 'G21', 'Assumptions!G36*Assumptions!G6', 5000 * 12, '$#,##0');

  sectionHeader(ws, 23, 6, 'Financing');
  labelCell(ws, 24, 6, '  Origination Fee');
  setFormula(ws, 'G24', 'Assumptions!G20', ed.debt * 0.02, '$#,##0');

  labelCell(ws, 26, 6, 'TOTAL USES');
  ws.getCell('F26').font = { bold: true };
  setFormula(ws, 'G26', 'G6+G7+G10+G11+G12+G13+G14+G17+G18+G19+G20+G21+G24', 0, '$#,##0');
  ws.getCell('G26').font = { bold: true };
  ws.getCell('G26').border = { top: { style: 'double', color: { argb: 'FF000000' } } };
  setFormula(ws, 'H26', 'G26/G26', 1, '0.0%');

  // Uses % of total
  setFormula(ws, 'H6', 'G6/G$26', 0, '0.0%');
  setFormula(ws, 'H7', 'G7/G$26', 0, '0.0%');
  setFormula(ws, 'H10', 'G10/G$26', 0, '0.0%');
  setFormula(ws, 'H11', 'G11/G$26', 0, '0.0%');
  setFormula(ws, 'H12', 'G12/G$26', 0, '0.0%');
  setFormula(ws, 'H13', 'G13/G$26', 0, '0.0%');
  setFormula(ws, 'H14', 'G14/G$26', 0, '0.0%');
  setFormula(ws, 'H17', 'G17/G$26', 0, '0.0%');
  setFormula(ws, 'H18', 'G18/G$26', 0, '0.0%');
  setFormula(ws, 'H19', 'G19/G$26', 0, '0.0%');
  setFormula(ws, 'H20', 'G20/G$26', 0, '0.0%');
  setFormula(ws, 'H21', 'G21/G$26', 0, '0.0%');
  setFormula(ws, 'H24', 'G24/G$26', 0, '0.0%');

  // Check row
  labelCell(ws, 28, 2, 'CHECK (Sources - Uses)');
  setFormula(ws, 'C28', 'C13-G26', 0, '$#,##0');
  ws.getCell('C28').font = { bold: true, color: { argb: 'FFFF0000' } };

  ws.pageSetup = { orientation: 'landscape', fitToPage: true, fitToWidth: 1 };
  return ws;
}

function buildCashFlowTab(wb, l, ed, pf) {
  var ws = wb.addWorksheet('Cash Flow');
  var MONTHS = 24;
  var totalCol = MONTHS + 3; // col index for TOTAL (months in cols 3..26, total in 27 = AA)
  var totalLtr = colLetter(totalCol); // AA

  ws.getColumn(1).width = 2;
  ws.getColumn(2).width = 24;
  for (var mi = 3; mi <= totalCol; mi++) ws.getColumn(mi).width = 12;

  var price = l.price || 0;
  var units = pf.maxUnits;
  var avgUnitSF = proforma.avgUnitSf;
  var buildCostPSF = pf.adjBuildCostPerSf;
  var buildableSF = units * avgUnitSF;
  var hardCosts = buildableSF * buildCostPSF;
  var softCosts = hardCosts * 0.25;
  var exitPSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var grossRevenue = units * avgUnitSF * exitPSF;
  var txCostPct = proforma.txnCostPct / 100;

  // Row 1: Title
  ws.mergeCells('B1:' + totalLtr + '1');
  ws.getCell('B1').value = 'Monthly Cash Flow';
  ws.getCell('B1').font = { bold: true, size: 14 };

  // Row 2: Month headers
  var hdrRow = ws.getRow(2);
  hdrRow.getCell(2).value = '';
  for (var m = 0; m < MONTHS; m++) {
    var c = hdrRow.getCell(m + 3);
    c.value = 'Month ' + m;
    c.font = _hdrFont; c.fill = _hdrFill;
    c.alignment = { horizontal: 'center' };
  }
  var tc = hdrRow.getCell(totalCol);
  tc.value = 'TOTAL'; tc.font = _hdrFont; tc.fill = _hdrFill;
  tc.alignment = { horizontal: 'center' };

  // Row 3: Phase labels
  var phaseRow = ws.getRow(3);
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    // Phase: IF(month < G5, "Pre-Dev", IF(month < G5+G6, "Construction", "Sale"))
    setFormula(ws, cl + '3',
      'IF(' + m + '<Assumptions!$G$5,"Pre-Dev",IF(' + m + '<Assumptions!$G$5+Assumptions!$G$6,"Construction","Sale"))',
      m < 6 ? 'Pre-Dev' : (m < 18 ? 'Construction' : 'Sale'));
    ws.getCell(cl + '3').font = { italic: true, color: { argb: 'FF888888' } };
    ws.getCell(cl + '3').alignment = { horizontal: 'center' };
  }

  // Helper: formula for each month column
  function monthFormula(row, formulaFn, resultFn) {
    for (var m = 0; m < MONTHS; m++) {
      var cl = colLetter(m + 3);
      setFormula(ws, cl + row, formulaFn(m, cl), resultFn(m), '$#,##0');
    }
    // Total column = SUM
    setFormula(ws, totalLtr + row, 'SUM(C' + row + ':' + colLetter(MONTHS + 2) + row + ')', 0, '$#,##0');
    ws.getCell(totalLtr + row).font = { bold: true };
  }

  // ‚îÄ‚îÄ Row 5: SOURCES header ‚îÄ‚îÄ
  sectionHeader(ws, 5, 2, 'SOURCES');
  ws.getCell('B5').fill = _hdrFill; ws.getCell('B5').font = _hdrFont;
  for (var m = 0; m < MONTHS; m++) { ws.getCell(colLetter(m+3) + '5').fill = _hdrFill; }
  ws.getCell(totalLtr + '5').fill = _hdrFill;

  // Row 6: LP Equity Call ‚Äî Month 0 only
  labelCell(ws, 6, 2, '  LP Equity Call');
  var lpEquityVal = ed.equity * 0.95;
  monthFormula(6,
    function(m) { return m === 0 ? 'Assumptions!G14*(1-Assumptions!C44)' : '0'; },
    function(m) { return m === 0 ? lpEquityVal : 0; }
  );

  // Row 7: GP Co-Invest Call ‚Äî Month 0 only
  labelCell(ws, 7, 2, '  GP Co-Invest Call');
  var gpCoInvestVal = ed.equity * 0.05;
  monthFormula(7,
    function(m) { return m === 0 ? 'Assumptions!G14*Assumptions!C44' : '0'; },
    function(m) { return m === 0 ? gpCoInvestVal : 0; }
  );

  // Row 8: Construction Draws ‚Äî balancing entry (total uses - equity for that month)
  labelCell(ws, 8, 2, '  Construction Draws');
  monthFormula(8,
    function(m, cl) { return 'MAX(0,' + cl + '32-' + cl + '6-' + cl + '7)'; },
    function() { return 0; }
  );

  // Row 9: Total Sources
  labelCell(ws, 9, 2, 'Total Sources');
  ws.getCell('B9').font = { bold: true };
  monthFormula(9,
    function(m, cl) { return cl + '6+' + cl + '7+' + cl + '8'; },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 11: USES - DEVELOPMENT ‚îÄ‚îÄ
  sectionHeader(ws, 11, 2, 'USES - DEVELOPMENT');
  ws.getCell('B11').fill = _hdrFill; ws.getCell('B11').font = _hdrFont;
  for (var m = 0; m < MONTHS; m++) { ws.getCell(colLetter(m+3) + '11').fill = _hdrFill; }
  ws.getCell(totalLtr + '11').fill = _hdrFill;

  // Row 12: Land Acquisition ‚Äî Month 0
  labelCell(ws, 12, 2, '  Land Acquisition');
  monthFormula(12,
    function(m) { return m === 0 ? 'Assumptions!C16' : '0'; },
    function(m) { return m === 0 ? price : 0; }
  );

  // Row 13: Hard Costs ‚Äî construction months, spread evenly
  labelCell(ws, 13, 2, '  Hard Costs');
  monthFormula(13,
    function(m) { return 'IF(AND(' + m + '>=Assumptions!$G$5,' + m + '<Assumptions!$G$5+Assumptions!$G$6),Assumptions!C24/Assumptions!$G$6,0)'; },
    function(m) { return (m >= 6 && m < 18) ? hardCosts / 12 : 0; }
  );

  // Row 14: Soft Costs ‚Äî construction months, spread evenly
  labelCell(ws, 14, 2, '  Soft Costs');
  monthFormula(14,
    function(m) { return 'IF(AND(' + m + '>=Assumptions!$G$5,' + m + '<Assumptions!$G$5+Assumptions!$G$6),Assumptions!C26/Assumptions!$G$6,0)'; },
    function(m) { return (m >= 6 && m < 18) ? softCosts / 12 : 0; }
  );

  // Row 15: Demo ‚Äî Month 0
  labelCell(ws, 15, 2, '  Demo');
  monthFormula(15,
    function(m) { return m === 0 ? 'Assumptions!C27' : '0'; },
    function(m) { return m === 0 ? 55000 : 0; }
  );

  // Row 16: Subdivision ‚Äî Month 1
  labelCell(ws, 16, 2, '  Subdivision');
  monthFormula(16,
    function(m) { return m === 1 ? 'Assumptions!C28' : '0'; },
    function(m) { return m === 1 ? 100000 : 0; }
  );

  // Row 17: A&E ‚Äî Pre-dev months 1+ spread evenly
  labelCell(ws, 17, 2, '  A&E');
  monthFormula(17,
    function(m) { return 'IF(AND(' + m + '>=1,' + m + '<Assumptions!$G$5),Assumptions!C29/(Assumptions!$G$5-1),0)'; },
    function(m) { return (m >= 1 && m < 6) ? 150000 / 5 : 0; }
  );

  // Row 18: Subtotal Development
  labelCell(ws, 18, 2, 'Subtotal Development');
  ws.getCell('B18').font = { bold: true };
  monthFormula(18,
    function(m, cl) { return 'SUM(' + cl + '12:' + cl + '17)'; },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 20: USES - CARRY ‚îÄ‚îÄ
  sectionHeader(ws, 20, 2, 'USES - CARRY');
  ws.getCell('B20').fill = _hdrFill; ws.getCell('B20').font = _hdrFont;
  for (var m = 0; m < MONTHS; m++) { ws.getCell(colLetter(m+3) + '20').fill = _hdrFill; }
  ws.getCell(totalLtr + '20').fill = _hdrFill;

  // Row 21: Property Tax ‚Äî every month
  labelCell(ws, 21, 2, '  Property Tax');
  monthFormula(21,
    function() { return 'Assumptions!$G$27'; },
    function() { return price * 0.011 / 12; }
  );

  // Row 22: Insurance ‚Äî every month
  labelCell(ws, 22, 2, '  Insurance');
  monthFormula(22,
    function() { return 'Assumptions!$G$29'; },
    function() { return 20000 / 12; }
  );

  // Row 23: Asset Mgmt ‚Äî every month
  labelCell(ws, 23, 2, '  Asset Mgmt');
  monthFormula(23,
    function() { return 'Assumptions!$G$35'; },
    function() { return 3000; }
  );

  // Row 24: Dev Mgmt ‚Äî construction months only
  labelCell(ws, 24, 2, '  Dev Mgmt');
  monthFormula(24,
    function(m) { return 'IF(AND(' + m + '>=Assumptions!$G$5,' + m + '<Assumptions!$G$5+Assumptions!$G$6),Assumptions!$G$36,0)'; },
    function(m) { return (m >= 6 && m < 18) ? 5000 : 0; }
  );

  // Row 25: Subtotal Carry
  labelCell(ws, 25, 2, 'Subtotal Carry');
  ws.getCell('B25').font = { bold: true };
  monthFormula(25,
    function(m, cl) { return 'SUM(' + cl + '21:' + cl + '24)'; },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 27: USES - FEES ‚îÄ‚îÄ
  sectionHeader(ws, 27, 2, 'USES - FEES');
  ws.getCell('B27').fill = _hdrFill; ws.getCell('B27').font = _hdrFont;
  for (var m = 0; m < MONTHS; m++) { ws.getCell(colLetter(m+3) + '27').fill = _hdrFill; }
  ws.getCell(totalLtr + '27').fill = _hdrFill;

  // Row 28: Acquisition Fee ‚Äî Month 0
  labelCell(ws, 28, 2, '  Acquisition Fee');
  monthFormula(28,
    function(m) { return m === 0 ? 'Assumptions!G34' : '0'; },
    function(m) { return m === 0 ? price * 0.02 : 0; }
  );

  // Row 29: Origination Fee ‚Äî Month 0
  labelCell(ws, 29, 2, '  Origination Fee');
  monthFormula(29,
    function(m) { return m === 0 ? 'Assumptions!G20' : '0'; },
    function(m) { return m === 0 ? ed.debt * 0.02 : 0; }
  );

  // Row 30: Subtotal Fees
  labelCell(ws, 30, 2, 'Subtotal Fees');
  ws.getCell('B30').font = { bold: true };
  monthFormula(30,
    function(m, cl) { return cl + '28+' + cl + '29'; },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 32: TOTAL USES ‚îÄ‚îÄ
  labelCell(ws, 32, 2, 'TOTAL USES');
  ws.getCell('B32').font = { bold: true, size: 11 };
  monthFormula(32,
    function(m, cl) { return cl + '18+' + cl + '25+' + cl + '30'; },
    function() { return 0; }
  );
  // Double top border on total
  for (var m = 0; m < MONTHS; m++) {
    ws.getCell(colLetter(m+3) + '32').border = { top: { style: 'double', color: { argb: 'FF000000' } } };
  }
  ws.getCell(totalLtr + '32').border = { top: { style: 'double', color: { argb: 'FF000000' } } };

  // ‚îÄ‚îÄ Row 34: LOAN SCHEDULE ‚îÄ‚îÄ
  sectionHeader(ws, 34, 2, 'LOAN SCHEDULE');
  ws.getCell('B34').fill = _hdrFill; ws.getCell('B34').font = _hdrFont;
  for (var m = 0; m < MONTHS; m++) { ws.getCell(colLetter(m+3) + '34').fill = _hdrFill; }
  ws.getCell(totalLtr + '34').fill = _hdrFill;

  // Row 35: Opening Balance
  labelCell(ws, 35, 2, '  Opening Balance');
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    if (m === 0) {
      setFormula(ws, cl + '35', '0', 0, '$#,##0');
    } else {
      var prevCl = colLetter(m + 2);
      setFormula(ws, cl + '35', prevCl + '37', 0, '$#,##0');
    }
  }

  // Row 36: + Draws (= construction draws from row 8)
  labelCell(ws, 36, 2, '  + Draws');
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    setFormula(ws, cl + '36', cl + '8', 0, '$#,##0');
  }
  setFormula(ws, totalLtr + '36', 'SUM(C36:' + colLetter(MONTHS + 2) + '36)', 0, '$#,##0');
  ws.getCell(totalLtr + '36').font = { bold: true };

  // Row 37: Closing Balance
  labelCell(ws, 37, 2, '  Closing Balance');
  ws.getCell('B37').font = { bold: true };
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    setFormula(ws, cl + '37', cl + '35+' + cl + '36', 0, '$#,##0');
  }

  // Row 38: Interest Accrual (PIK)
  labelCell(ws, 38, 2, '  Interest Accrual (PIK)');
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    setFormula(ws, cl + '38', cl + '37*Assumptions!$G$18/12', 0, '$#,##0');
  }
  setFormula(ws, totalLtr + '38', 'SUM(C38:' + colLetter(MONTHS + 2) + '38)', 0, '$#,##0');
  ws.getCell(totalLtr + '38').font = { bold: true };

  // Row 39: Cumulative Interest
  labelCell(ws, 39, 2, '  Cumulative Interest');
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    if (m === 0) {
      setFormula(ws, cl + '39', cl + '38', 0, '$#,##0');
    } else {
      var prevCl = colLetter(m + 2);
      setFormula(ws, cl + '39', prevCl + '39+' + cl + '38', 0, '$#,##0');
    }
  }
  ws.getCell(totalLtr + '39').font = { bold: true };

  // ‚îÄ‚îÄ Row 41: NET OPERATING CF ‚îÄ‚îÄ
  labelCell(ws, 41, 2, 'NET OPERATING CF');
  ws.getCell('B41').font = { bold: true };
  monthFormula(41,
    function(m, cl) { return cl + '9-' + cl + '32'; },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 43: EXIT ‚îÄ‚îÄ
  sectionHeader(ws, 43, 2, 'EXIT');
  ws.getCell('B43').fill = _hdrFill; ws.getCell('B43').font = _hdrFont;
  for (var m = 0; m < MONTHS; m++) { ws.getCell(colLetter(m+3) + '43').fill = _hdrFill; }
  ws.getCell(totalLtr + '43').fill = _hdrFill;

  // Row 44: Gross Sale Proceeds ‚Äî last month only (month = G8-1)
  labelCell(ws, 44, 2, '  Gross Sale Proceeds');
  monthFormula(44,
    function(m) { return 'IF(' + m + '=Assumptions!$G$8-1,Assumptions!C36,0)'; },
    function(m) { return m === 23 ? grossRevenue : 0; }
  );

  // Row 45: Transaction Costs
  labelCell(ws, 45, 2, '  Transaction Costs');
  monthFormula(45,
    function(m) { return 'IF(' + m + '=Assumptions!$G$8-1,Assumptions!C36*Assumptions!C37,0)'; },
    function(m) { return m === 23 ? grossRevenue * txCostPct : 0; }
  );

  // Row 46: Disposition Fee
  labelCell(ws, 46, 2, '  Disposition Fee');
  monthFormula(46,
    function(m) { return 'IF(' + m + '=Assumptions!$G$8-1,Assumptions!G38,0)'; },
    function(m) { return m === 23 ? grossRevenue * 0.015 : 0; }
  );

  // Row 47: Loan Repayment (principal + accrued interest)
  labelCell(ws, 47, 2, '  Loan Repayment');
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    setFormula(ws, cl + '47', 'IF(' + m + '=Assumptions!$G$8-1,' + cl + '37+' + cl + '39,0)', 0, '$#,##0');
  }
  setFormula(ws, totalLtr + '47', 'SUM(C47:' + colLetter(MONTHS + 2) + '47)', 0, '$#,##0');
  ws.getCell(totalLtr + '47').font = { bold: true };

  // Row 48: Net Exit CF
  labelCell(ws, 48, 2, 'Net Exit CF');
  ws.getCell('B48').font = { bold: true };
  monthFormula(48,
    function(m, cl) { return cl + '44-' + cl + '45-' + cl + '46-' + cl + '47'; },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 50: NET CASH TO EQUITY ‚îÄ‚îÄ
  labelCell(ws, 50, 2, 'NET CASH TO EQUITY');
  ws.getCell('B50').font = { bold: true, size: 11 };
  monthFormula(50,
    function(m, cl) { return cl + '41+' + cl + '48'; },
    function() { return 0; }
  );
  for (var m = 0; m < MONTHS; m++) {
    ws.getCell(colLetter(m+3) + '50').border = { top: { style: 'double', color: { argb: 'FF000000' } } };
  }
  ws.getCell(totalLtr + '50').border = { top: { style: 'double', color: { argb: 'FF000000' } } };

  // ‚îÄ‚îÄ Row 52: DISTRIBUTIONS (last month) ‚îÄ‚îÄ
  sectionHeader(ws, 52, 2, 'DISTRIBUTIONS');
  ws.getCell('B52').fill = _hdrFill; ws.getCell('B52').font = _hdrFont;
  for (var m = 0; m < MONTHS; m++) { ws.getCell(colLetter(m+3) + '52').fill = _hdrFill; }
  ws.getCell(totalLtr + '52').fill = _hdrFill;

  var lastMo = 23;
  var lastCl = colLetter(lastMo + 3); // Z

  // Row 53: LP Return of Capital
  labelCell(ws, 53, 2, '  LP Return of Capital');
  monthFormula(53,
    function(m) { return m === lastMo ? 'Assumptions!G14*(1-Assumptions!C44)' : '0'; },
    function(m) { return m === lastMo ? lpEquityVal : 0; }
  );

  // Row 54: GP Return of Capital
  labelCell(ws, 54, 2, '  GP Return of Capital');
  monthFormula(54,
    function(m) { return m === lastMo ? 'Assumptions!G14*Assumptions!C44' : '0'; },
    function(m) { return m === lastMo ? gpCoInvestVal : 0; }
  );

  // Row 55: LP Preferred Return
  labelCell(ws, 55, 2, '  LP Preferred Return');
  monthFormula(55,
    function(m) {
      if (m !== lastMo) return '0';
      return 'Assumptions!G14*(1-Assumptions!C44)*Assumptions!C42*Assumptions!G8/12';
    },
    function(m) { return m === lastMo ? lpEquityVal * 0.08 * 24 / 12 : 0; }
  );

  // Row 56: GP Promote ‚Äî MAX(0, NetCashToEquity - LP ROC - GP ROC - LP Pref) * promote %
  labelCell(ws, 56, 2, '  GP Promote');
  monthFormula(56,
    function(m, cl) {
      if (m !== lastMo) return '0';
      return 'MAX(0,' + totalLtr + '50-' + cl + '53-' + cl + '54-' + cl + '55)*Assumptions!C43';
    },
    function() { return 0; }
  );

  // Row 57: LP Residual Share
  labelCell(ws, 57, 2, '  LP Residual Share');
  monthFormula(57,
    function(m, cl) {
      if (m !== lastMo) return '0';
      return 'MAX(0,' + totalLtr + '50-' + cl + '53-' + cl + '54-' + cl + '55)*(1-Assumptions!C43)';
    },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 59: LP TOTAL DISTRIBUTION ‚îÄ‚îÄ
  labelCell(ws, 59, 2, 'LP TOTAL DISTRIBUTION');
  ws.getCell('B59').font = { bold: true };
  monthFormula(59,
    function(m, cl) { return cl + '53+' + cl + '55+' + cl + '57'; },
    function() { return 0; }
  );

  // Row 60: LP Net Profit
  labelCell(ws, 60, 2, 'LP Net Profit');
  monthFormula(60,
    function(m, cl) { return cl + '59-' + cl + '53'; },
    function() { return 0; }
  );

  // ‚îÄ‚îÄ Row 62: LLC CASH BALANCE ‚îÄ‚îÄ
  labelCell(ws, 62, 2, 'LLC CASH BALANCE');
  ws.getCell('B62').font = { bold: true };
  for (var m = 0; m < MONTHS; m++) {
    var cl = colLetter(m + 3);
    if (m === 0) {
      setFormula(ws, cl + '62', cl + '9-' + cl + '32+' + cl + '48', 0, '$#,##0');
    } else {
      var prevCl = colLetter(m + 2);
      setFormula(ws, cl + '62', prevCl + '62+' + cl + '9-' + cl + '32+' + cl + '48', 0, '$#,##0');
    }
  }

  // Freeze panes: B column labels + header rows
  ws.views = [{ state: 'frozen', xSplit: 2, ySplit: 3 }];
  ws.pageSetup = { orientation: 'landscape', fitToPage: true, fitToWidth: 1 };
  return ws;
}

function buildOutputsTab(wb, ed) {
  var ws = wb.addWorksheet('Outputs');
  ws.getColumn(1).width = 2;
  ws.getColumn(2).width = 22;
  ws.getColumn(3).width = 18;

  // Title
  ws.mergeCells('B2:C2');
  ws.getCell('B2').value = 'Investment Returns';
  ws.getCell('B2').font = { bold: true, size: 14 };

  // ‚îÄ‚îÄ LP Returns ‚îÄ‚îÄ
  ws.getCell('B4').value = 'LP RETURNS';
  ws.getCell('B4').font = _hdrFont; ws.getCell('B4').fill = _hdrFill;
  ws.getCell('C4').fill = _hdrFill;

  labelCell(ws, 5, 2, 'LP MOIC');
  setFormula(ws, 'C5', "IF('Cash Flow'!AA6=0,0,'Cash Flow'!AA59/'Cash Flow'!AA6)", 0, '0.00x');
  ws.getCell('C5').font = { bold: true, size: 12 };

  labelCell(ws, 6, 2, 'LP IRR (ann.)');
  setFormula(ws, 'C6', 'IF(C5<=0,0,(C5^(12/Assumptions!G8))-1)', 0, '0.0%');
  ws.getCell('C6').font = { bold: true, size: 12 };

  labelCell(ws, 7, 2, 'LP Total Dist');
  setFormula(ws, 'C7', "'Cash Flow'!AA59", 0, '$#,##0');

  labelCell(ws, 8, 2, 'LP Equity In');
  setFormula(ws, 'C8', "'Cash Flow'!AA6", 0, '$#,##0');

  labelCell(ws, 9, 2, 'LP Net Profit');
  setFormula(ws, 'C9', "'Cash Flow'!AA60", 0, '$#,##0');

  // ‚îÄ‚îÄ Project Metrics ‚îÄ‚îÄ
  ws.getCell('B11').value = 'PROJECT METRICS';
  ws.getCell('B11').font = _hdrFont; ws.getCell('B11').fill = _hdrFill;
  ws.getCell('C11').fill = _hdrFill;

  labelCell(ws, 12, 2, 'Project Margin');
  setFormula(ws, 'C12', 'IF(Assumptions!C38=0,0,(Assumptions!C38-Assumptions!G16)/Assumptions!C38)', 0, '0.0%');

  labelCell(ws, 13, 2, 'Project MOIC');
  setFormula(ws, 'C13', 'IF(Assumptions!G16=0,0,Assumptions!C38/Assumptions!G16)', 0, '0.00x');

  labelCell(ws, 14, 2, 'Development Spread');
  setFormula(ws, 'C14', 'Assumptions!C35-Assumptions!G16/Assumptions!C22', 0, '$#,##0');

  labelCell(ws, 17, 2, 'All-In $/SF');
  setFormula(ws, 'C17', 'IF(Assumptions!C22=0,0,Assumptions!G16/Assumptions!C22)', 0, '$#,##0');

  labelCell(ws, 18, 2, 'Break-Even $/SF');
  setFormula(ws, 'C18', 'IF(Assumptions!C22=0,0,Assumptions!G16/(Assumptions!C22*(1-Assumptions!C37)))', 0, '$#,##0');

  // ‚îÄ‚îÄ GP Economics ‚îÄ‚îÄ
  ws.getCell('B20').value = 'GP ECONOMICS';
  ws.getCell('B20').font = _hdrFont; ws.getCell('B20').fill = _hdrFill;
  ws.getCell('C20').fill = _hdrFill;

  labelCell(ws, 21, 2, 'GP Promote $');
  setFormula(ws, 'C21', "'Cash Flow'!AA56", 0, '$#,##0');

  labelCell(ws, 22, 2, 'Acq Fee');
  setFormula(ws, 'C22', 'Assumptions!G34', 0, '$#,##0');

  labelCell(ws, 23, 2, 'Asset Mgmt Total');
  setFormula(ws, 'C23', 'Assumptions!G35*Assumptions!G8', 0, '$#,##0');

  labelCell(ws, 24, 2, 'Dev Mgmt Total');
  setFormula(ws, 'C24', 'Assumptions!G36*Assumptions!G6', 0, '$#,##0');

  labelCell(ws, 25, 2, 'Disp Fee');
  setFormula(ws, 'C25', 'Assumptions!G38', 0, '$#,##0');

  labelCell(ws, 26, 2, 'GP Total Income');
  ws.getCell('B26').font = { bold: true };
  setFormula(ws, 'C26', 'C21+C22+C23+C24+C25', 0, '$#,##0');
  ws.getCell('C26').font = { bold: true };
  ws.getCell('C26').border = { top: { style: 'double', color: { argb: 'FF000000' } } };

  ws.pageSetup = { orientation: 'portrait', fitToPage: true, fitToWidth: 1 };
  return ws;
}

function buildBTRTab(wb) {
  var ws = wb.addWorksheet('BTR Hold');
  ws.getColumn(1).width = 2;
  ws.getColumn(2).width = 24;
  ws.getColumn(3).width = 18;

  ws.mergeCells('B2:C2');
  ws.getCell('B2').value = 'Build-to-Rent Analysis';
  ws.getCell('B2').font = { bold: true, size: 14 };

  // ‚îÄ‚îÄ Income ‚îÄ‚îÄ
  ws.getCell('B4').value = 'INCOME';
  ws.getCell('B4').font = _hdrFont; ws.getCell('B4').fill = _hdrFill;
  ws.getCell('C4').fill = _hdrFill;

  labelCell(ws, 5, 2, 'Units');
  setFormula(ws, 'C5', 'Assumptions!C20', 0, '#,##0');

  labelCell(ws, 6, 2, 'Rent / Unit / Mo');
  setFormula(ws, 'C6', 'Assumptions!C48', 0, '$#,##0');

  labelCell(ws, 7, 2, 'Gross Annual Rent');
  setFormula(ws, 'C7', 'C5*C6*12', 0, '$#,##0');

  labelCell(ws, 8, 2, 'OpEx Ratio');
  setFormula(ws, 'C8', 'Assumptions!C50', 0, '0.0%');

  labelCell(ws, 9, 2, 'Annual NOI');
  setFormula(ws, 'C9', 'C7*(1-C8)', 0, '$#,##0');
  ws.getCell('C9').font = { bold: true };

  // ‚îÄ‚îÄ Valuation ‚îÄ‚îÄ
  ws.getCell('B11').value = 'VALUATION';
  ws.getCell('B11').font = _hdrFont; ws.getCell('B11').fill = _hdrFill;
  ws.getCell('C11').fill = _hdrFill;

  labelCell(ws, 12, 2, 'Cap Rate');
  setFormula(ws, 'C12', 'Assumptions!C51', 0, '0.0%');

  labelCell(ws, 13, 2, 'Stabilized Value');
  setFormula(ws, 'C13', 'IF(C12=0,0,C9/C12)', 0, '$#,##0');
  ws.getCell('C13').font = { bold: true };

  labelCell(ws, 14, 2, 'Yield on Cost');
  setFormula(ws, 'C14', 'IF(Assumptions!G16=0,0,C9/Assumptions!G16)', 0, '0.0%');

  // ‚îÄ‚îÄ Refinance ‚îÄ‚îÄ
  ws.getCell('B16').value = 'REFINANCE';
  ws.getCell('B16').font = _hdrFont; ws.getCell('B16').fill = _hdrFill;
  ws.getCell('C16').fill = _hdrFill;

  labelCell(ws, 17, 2, 'Refi LTV');
  setFormula(ws, 'C17', 'Assumptions!C52', 0, '0.0%');

  labelCell(ws, 18, 2, 'Refi Loan');
  setFormula(ws, 'C18', 'C13*C17', 0, '$#,##0');

  labelCell(ws, 19, 2, 'Perm Rate');
  setFormula(ws, 'C19', 'Assumptions!C53', 0, '0.00%');

  labelCell(ws, 20, 2, 'Annual Debt Service');
  setFormula(ws, 'C20', 'C18*C19', 0, '$#,##0');

  labelCell(ws, 21, 2, 'DSCR');
  setFormula(ws, 'C21', 'IF(C20=0,0,C9/C20)', 0, '0.00x');
  ws.getCell('C21').font = { bold: true };

  // ‚îÄ‚îÄ Cash Flow ‚îÄ‚îÄ
  ws.getCell('B23').value = 'LEVERED CASH FLOW';
  ws.getCell('B23').font = _hdrFont; ws.getCell('B23').fill = _hdrFill;
  ws.getCell('C23').fill = _hdrFill;

  labelCell(ws, 24, 2, 'Annual Cash Flow');
  setFormula(ws, 'C24', 'C9-C20', 0, '$#,##0');
  ws.getCell('C24').font = { bold: true };

  labelCell(ws, 25, 2, 'Equity After Refi');
  setFormula(ws, 'C25', 'Assumptions!G16-C18', 0, '$#,##0');

  labelCell(ws, 26, 2, 'Cash-on-Cash');
  setFormula(ws, 'C26', 'IF(C25=0,0,C24/C25)', 0, '0.0%');
  ws.getCell('C26').font = { bold: true };

  labelCell(ws, 27, 2, 'Cash-Out at Refi');
  setFormula(ws, 'C27', 'C18-Assumptions!G16', 0, '$#,##0');

  ws.pageSetup = { orientation: 'portrait', fitToPage: true, fitToWidth: 1 };
  return ws;
}

function buildExitCompsTab(wb, l) {
  var compResult = findCompsForListing(l);
  if (!compResult.used.length && !compResult.ref.length) return null;

  var cs = wb.addWorksheet('Exit Comps');
  var el = exitLabel(l);

  cs.getCell('A1').value = 'Exit Comps for ' + (l.address || '');
  cs.getCell('A1').font = { bold: true, size: 14 };
  cs.mergeCells('A1:L1');
  cs.getCell('A2').value = el.label + '  \u2014  $' + el.psf + '/SF';
  cs.getCell('A2').font = { bold: true, size: 11 };
  cs.mergeCells('A2:L2');

  var compHeaders = ['Status','Address','Sale Price','$/SF','SqFt','Beds','Baths','Zone','Year Built','Tier','Sale Date','Distance (mi)'];
  var headerRow = cs.getRow(4);
  compHeaders.forEach(function(h, i) {
    var cell = headerRow.getCell(i + 1);
    cell.value = h;
    cell.font = { bold: true };
    cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFE0E0E0' } };
  });

  cs.getColumn(1).width = 8;
  cs.getColumn(2).width = 35;
  cs.getColumn(3).width = 14;
  cs.getColumn(4).width = 10;
  cs.getColumn(5).width = 10;
  cs.getColumn(6).width = 6;
  cs.getColumn(7).width = 6;
  cs.getColumn(8).width = 8;
  cs.getColumn(9).width = 11;
  cs.getColumn(10).width = 6;
  cs.getColumn(11).width = 12;
  cs.getColumn(12).width = 12;

  var greenFill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFE8F5E9' } };
  var allComps = compResult.used.concat(compResult.ref);
  for (var ci = 0; ci < allComps.length; ci++) {
    var comp = allComps[ci];
    var row = cs.getRow(5 + ci);
    var isUsed = ci < compResult.used.length;

    row.getCell(1).value = isUsed ? 'Used' : 'Ref';
    row.getCell(2).value = comp.address || '';
    row.getCell(3).value = comp.price || 0;
    row.getCell(3).numFmt = '$#,##0';
    row.getCell(4).value = comp.ppsf || 0;
    row.getCell(4).numFmt = '$#,##0';
    row.getCell(5).value = comp.sqft || 0;
    row.getCell(5).numFmt = '#,##0';
    row.getCell(6).value = comp.bd || '';
    row.getCell(7).value = comp.ba || '';
    row.getCell(8).value = comp.zone || '';
    row.getCell(9).value = comp.yb || '';
    row.getCell(10).value = comp.t ? 'T' + comp.t : '';
    row.getCell(11).value = comp.date || '';
    row.getCell(12).value = comp.dist ? +comp.dist.toFixed(2) : '';
    row.getCell(12).numFmt = '0.00';

    if (isUsed) {
      for (var k = 1; k <= 12; k++) row.getCell(k).fill = greenFill;
    }
  }
  return cs;
}

async function exportModel(lat, lng) {
  var l = LISTINGS.find(function(x){ return x.lat===lat && x.lng===lng; });
  if (!l) { alert('Listing not found'); return; }

  var pf = calculateProForma(l);
  var exitPSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var monthlyRent = l.estRentMonth || l.fmr3br || 4000;
  var units = pf.maxUnits;
  var avgUnitSF = proforma.avgUnitSf;
  var buildCostPSF = pf.adjBuildCostPerSf;

  var ed = sizeEquityAndDebt(l.price, units, avgUnitSF, buildCostPSF, exitPSF, monthlyRent);

  // Build workbook programmatically ‚Äî no template needed
  var wb = new ExcelJS.Workbook();
  wb.creator = 'SB 1123 Deal Finder';

  buildAssumptionsTab(wb, l, pf, ed, exitPSF, monthlyRent);
  buildSourcesUsesTab(wb, l, ed, pf);
  buildCashFlowTab(wb, l, ed, pf);
  buildOutputsTab(wb, ed);
  buildBTRTab(wb);
  buildExitCompsTab(wb, l);

  // Generate and download
  var filename = (l.address||'deal').replace(/[^a-zA-Z0-9]/g,'_').replace(/_+/g,'_') + '_model.xlsx';
  var outBuf = await wb.xlsx.writeBuffer();
  var blob = new Blob([outBuf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

async function exportOM(lat, lng) {
  var OM_API = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? '' : 'https://sb1123-om-api.fly.dev';

  var l = LISTINGS.find(function(x){ return x.lat===lat && x.lng===lng; });
  if (!l) { alert('Listing not found'); return; }

  var pf = calculateProForma(l);
  var btr = calculateBTRProForma(l);
  var exitPSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var monthlyRent = l.estRentMonth || l.fmr3br || 4000;
  var avgUnitSF = proforma.avgUnitSf;
  var buildCostPSF = pf.adjBuildCostPerSf;
  var units = pf.maxUnits;

  var ed = sizeEquityAndDebt(l.price, units, avgUnitSF, buildCostPSF, exitPSF, monthlyRent);

  // ‚îÄ‚îÄ Constants (must match sizeEquityAndDebt) ‚îÄ‚îÄ
  var SOFT_PCT = 0.25;
  var DEMO = 55000;
  var SUBDIV = 100000;
  var AE = 150000;
  var TAX_RATE = 0.011;
  var INS_ANNUAL = 20000;
  var AM_MONTHLY = 3000;
  var DM_MONTHLY = 5000;
  var ACQ_FEE_PCT = 0.02;
  var DISP_FEE_PCT = 0.015;
  var ORIG_FEE_PCT = 0.02;
  var INTEREST_RATE = 0.09;
  var LP_PREF = 0.08;
  var GP_PROMOTE = 0.20;
  var GP_COINVEST = 0.05;
  var PRE_DEV_MO = 6;
  var CONSTR_MO = 12;
  var SALE_MO = 6;
  var HOLD_MO = PRE_DEV_MO + CONSTR_MO + SALE_MO;
  var TX_COST_PCT = proforma.txnCostPct / 100;
  var BTR_OPEX = btr.opexRatio;
  var BTR_CAP = btr.capRate;
  var BTR_LTV = btr.refiLTV;
  var BTR_PERM_RATE = 0.0625;
  var BTR_RENT_GROWTH = 0.03;

  // ‚îÄ‚îÄ Development costs ‚îÄ‚îÄ
  var buildableSF = units * avgUnitSF;
  var hardCosts = buildableSF * buildCostPSF;
  var softCosts = hardCosts * SOFT_PCT;
  var totalDev = hardCosts + softCosts + DEMO + SUBDIV + AE;

  // ‚îÄ‚îÄ Capital structure ‚îÄ‚îÄ
  var totalProjectCost = ed.totalCost;
  var equity = ed.equity;
  var debt = totalProjectCost - equity;
  var gpCoinvestEquity = Math.round(equity * GP_COINVEST);
  var lpEquity = equity - gpCoinvestEquity;
  var origFee = debt * ORIG_FEE_PCT;

  // ‚îÄ‚îÄ Carry costs (monthly accumulation) ‚îÄ‚îÄ
  var monthlyTax = l.price * TAX_RATE / 12;
  var monthlyIns = INS_ANNUAL / 12;

  var totalPropTax = monthlyTax * HOLD_MO;
  var totalInsurance = monthlyIns * HOLD_MO;
  var totalAssetMgmt = AM_MONTHLY * HOLD_MO;
  var totalDevMgmt = DM_MONTHLY * CONSTR_MO;

  // ‚îÄ‚îÄ Interest (PIK ‚Äî accrues on drawn debt) ‚îÄ‚îÄ
  // Pre-dev: land acquisition debt drawn; Construction: progressive draws; Sale: fully drawn
  var landDebt = Math.max(0, l.price - equity);  // debt portion of land
  var constrDebt = debt - landDebt;  // remaining debt for construction
  // Simplified PIK: average outstanding √ó rate √ó time
  var preDevInterest = landDebt * INTEREST_RATE * (PRE_DEV_MO / 12);
  var constrInterest = (landDebt + constrDebt * 0.5) * INTEREST_RATE * (CONSTR_MO / 12);
  var saleInterest = debt * INTEREST_RATE * (SALE_MO / 12);
  var totalInterest = preDevInterest + constrInterest + saleInterest;

  // ‚îÄ‚îÄ Fees ‚îÄ‚îÄ
  var acqFee = l.price * ACQ_FEE_PCT;
  var dispFee = 0;  // computed on exit below
  var totalSponsorFees = acqFee + totalAssetMgmt + totalDevMgmt;  // disposition added at exit

  // ‚îÄ‚îÄ Exit ‚îÄ‚îÄ
  var grossRevenue = units * avgUnitSF * exitPSF;
  var txCosts = grossRevenue * TX_COST_PCT;
  dispFee = grossRevenue * DISP_FEE_PCT;
  totalSponsorFees += dispFee;
  var netSaleProceeds = grossRevenue - txCosts;

  // ‚îÄ‚îÄ Waterfall ‚îÄ‚îÄ
  var loanRepayment = debt + totalInterest + origFee;
  var netDistributable = netSaleProceeds - loanRepayment;
  var lpROC = lpEquity;
  var gpROC = gpCoinvestEquity;
  var profitAfterROC = netDistributable - lpROC - gpROC;

  // LP preferred return (simple, on hold period)
  var lpPrefDollars = lpEquity * LP_PREF * (HOLD_MO / 12);
  var remainingAfterPref = Math.max(0, profitAfterROC - lpPrefDollars);

  // GP promote on remaining
  var gpPromoteDollars = remainingAfterPref * GP_PROMOTE;
  var lpShareRemaining = remainingAfterPref * (1 - GP_PROMOTE);

  // LP totals
  var lpTotalDist = lpROC + lpPrefDollars + lpShareRemaining;
  var lpNetProfit = lpTotalDist - lpEquity;
  var lpMOIC = lpEquity > 0 ? lpTotalDist / lpEquity : 0;

  // LP IRR (annualized approximation from MOIC and hold)
  var holdYears = HOLD_MO / 12;
  var lpIRR = holdYears > 0 ? Math.pow(lpMOIC, 1 / holdYears) - 1 : 0;

  // Project-level metrics
  var projectMargin = netSaleProceeds > 0 ? (netSaleProceeds - totalProjectCost) / netSaleProceeds : 0;
  var projectMOIC = totalProjectCost > 0 ? netSaleProceeds / totalProjectCost : 0;
  var allInPsf = buildableSF > 0 ? totalProjectCost / buildableSF : 0;

  // GP economics
  var gpTotalIncome = gpPromoteDollars + totalSponsorFees;
  var gpFeeLoad = grossRevenue > 0 ? gpTotalIncome / grossRevenue : 0;

  // Lot dimensions
  var lotWidth = l.lw || Math.round(Math.sqrt((l.lotSf||10000) * 0.33));
  var lotDepth = l.ld || Math.round((l.lotSf||10000) / lotWidth);

  // ‚îÄ‚îÄ BTR ‚îÄ‚îÄ
  var btrGPI = btr.grossAnnualRent;
  var btrEGI = btr.grossAnnualRent;
  var btrNOI = btr.annualNOI;
  var btrStabilizedValue = btr.stabilizedValue;
  var btrRefiLoan = btr.refiLoanAmount;
  var btrEffectiveLTV = btrStabilizedValue > 0 ? btrRefiLoan / btrStabilizedValue : 0;
  var btrAnnualDS = btr.annualDebtService;
  var btrDSCR = btr.dscr;
  var btrAnnualCF = btr.cashFlow;
  var btrCoC = btr.cashOnCash;
  var btrYOC = btr.yieldOnCost;

  // ‚îÄ‚îÄ Build deal dict matching read_xls() schema ‚îÄ‚îÄ
  var addrParts = (l.address || '').split(',');
  var street = addrParts[0] ? addrParts[0].trim() : (l.address || '');

  var d = {
    // Property
    address: street,
    city: l.city || '',
    zip: l.zip || '',
    state: 'CA',
    zoning: (l.zone || 'R1').toUpperCase(),
    lot_sf: l.lotSf || 0,
    lot_width: lotWidth,
    lot_depth: lotDepth,
    slope_pct: (l.slope || 0) / 100,
    beds_baths: (l.beds || '') + ' / ' + (l.baths || ''),
    dom: l.dom || 0,

    // Acquisition
    asking_price: l.price || 0,

    // Development
    units: units,
    unit_sf: avgUnitSF,
    buildable_sf: buildableSF,
    build_cost_psf: buildCostPSF,
    hard_costs: hardCosts,
    soft_cost_pct: SOFT_PCT,
    soft_costs: softCosts,
    demo_cost: DEMO,
    subdivision_cost: SUBDIV,
    ae_cost: AE,
    total_dev_costs: totalDev,

    // Exit
    exit_psf: exitPSF,
    gross_revenue: grossRevenue,
    tx_cost_pct: TX_COST_PCT,
    net_sale_proceeds: netSaleProceeds,

    // Timeline
    predev_months: PRE_DEV_MO,
    construction_months: CONSTR_MO,
    sale_months: SALE_MO,
    hold_months: HOLD_MO,

    // Capital structure
    equity_total: equity,
    debt_total: debt,
    total_project_cost: totalProjectCost,
    equity_pct: totalProjectCost > 0 ? equity / totalProjectCost : 0,
    interest_rate: INTEREST_RATE,
    orig_fee_pct: ORIG_FEE_PCT,
    orig_fee_dollars: origFee,
    interest_treatment: 'PIK',

    // Carry
    prop_tax_rate: TAX_RATE,
    monthly_tax: monthlyTax,
    insurance_annual: INS_ANNUAL,
    monthly_insurance: monthlyIns,

    // Fees
    acq_fee_pct: ACQ_FEE_PCT,
    acq_fee_dollars: acqFee,
    asset_mgmt_monthly: AM_MONTHLY,
    dev_mgmt_monthly: DM_MONTHLY,
    disposition_fee_pct: DISP_FEE_PCT,
    disposition_fee_dollars: dispFee,
    total_sponsor_fees: totalSponsorFees,

    // Waterfall
    lp_pref_rate: LP_PREF,
    gp_promote_pct: GP_PROMOTE,
    gp_coinvest_pct: GP_COINVEST,
    lp_promote_pct: 1 - GP_PROMOTE,

    // Waterfall results
    lp_moic: lpMOIC,
    lp_irr: lpIRR,
    lp_total_dist: lpTotalDist,
    lp_equity_in: lpEquity,
    lp_net_profit: lpNetProfit,
    project_margin: projectMargin,
    project_moic: projectMOIC,
    all_in_psf: allInPsf,
    gp_promote_dollars: gpPromoteDollars,
    gp_total_income: gpTotalIncome,
    gp_fee_load: gpFeeLoad,

    // Monthly CF waterfall detail
    loan_repayment: loanRepayment,
    net_distributable: netDistributable,
    lp_roc: lpROC,
    gp_roc: gpROC,
    profit_after_roc: profitAfterROC,
    lp_pref_dollars: lpPrefDollars,
    remaining_after_pref: remainingAfterPref,
    lp_share_remaining: lpShareRemaining,
    gp_coinvest_equity: gpCoinvestEquity,
    loan_draws: debt,
    total_interest: totalInterest,
    total_prop_tax: totalPropTax,
    total_insurance: totalInsurance,
    total_asset_mgmt: totalAssetMgmt,
    total_dev_mgmt: totalDevMgmt,

    // BTR
    btr_rent_monthly: btr.rentPerUnit,
    btr_opex_ratio: BTR_OPEX,
    btr_cap_rate: BTR_CAP,
    btr_refi_ltv: BTR_LTV,
    btr_perm_rate: BTR_PERM_RATE,
    btr_rent_growth: BTR_RENT_GROWTH,
    btr_gpi: btrGPI,
    btr_egi: btrEGI,
    btr_noi: btrNOI,
    btr_stabilized_value: btrStabilizedValue,
    btr_effective_ltv: btrEffectiveLTV,
    btr_refi_loan: btrRefiLoan,
    btr_annual_ds: btrAnnualDS,
    btr_dscr: btrDSCR,
    btr_annual_cf: btrAnnualCF,
    btr_coc: btrCoC,
    btr_yoc: btrYOC,

    // Derived
    break_even_psf: buildableSF > 0 ? totalProjectCost / (buildableSF * (1 - TX_COST_PCT)) : 0,
    lot_per_unit: units > 0 ? (l.lotSf || 0) / units : 0,
    fee_pct_of_cap: totalProjectCost > 0 ? totalSponsorFees / totalProjectCost : 0,
  };

  // ‚îÄ‚îÄ Attach comp sales data ‚îÄ‚îÄ
  var compResult = findCompsForListing(l);
  var el = exitLabel(l);
  d.comp_source = el.short || '';
  d.comp_label = el.label || '';
  d.comps = compResult.used.slice(0, 12).map(function(c) {
    return {
      address: c.address || '',
      price: c.price || 0,
      ppsf: Math.round(c.ppsf || 0),
      sqft: c.sqft || 0,
      beds: c.bd || '',
      baths: c.ba || '',
      zone: c.zone || '',
      year_built: c.yb || '',
      date: c.date || '',
      dist: c.dist ? +c.dist.toFixed(2) : 0,
    };
  });

  // ‚îÄ‚îÄ POST to OM API ‚îÄ‚îÄ
  try {
    var resp = await fetch(OM_API + '/api/generate-om', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(d),
    });
    if (!resp.ok) {
      var errText = await resp.text();
      alert('OM generation failed: ' + errText);
      return;
    }
    var blob = await resp.blob();
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = street.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_') + '_OM.pptx';
    a.click();
    URL.revokeObjectURL(url);
  } catch (err) {
    alert('OM export failed: ' + err.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.addEventListener('DOMContentLoaded', function(){
  // Market-specific UI setup
  document.getElementById('marketSubtitle').textContent = MARKET.subtitle;
  if(!MARKET.burnZones) document.getElementById('burnZoneSection').style.display='none';
  else if(MARKET.burnZoneLabel) document.getElementById('burnZoneLabel').innerHTML='Hide Burn Zones <small>('+MARKET.burnZoneLabel+')</small>';
  // Market switcher ‚Äî cycle through all markets except current
  var otherSlugs = Object.keys(MARKET_CONFIG).filter(function(s){return s!==MARKET.slug;});
  var switchLink = document.getElementById('marketSwitchLink');
  if(otherSlugs.length === 1){
    var otherCfg = MARKET_CONFIG[otherSlugs[0]];
    switchLink.href = '?market='+otherSlugs[0];
    switchLink.textContent = otherCfg.name.split(' ').map(function(w){return w[0]}).join('')+' \u2197';
    switchLink.title = 'Switch to '+otherCfg.name;
  } else if(otherSlugs.length > 1){
    // Multiple other markets ‚Äî show dropdown on click
    switchLink.textContent = '\u2630 Markets';
    switchLink.title = 'Switch market';
    switchLink.href = '#';
    switchLink.onclick = function(e){
      e.preventDefault();
      var existing = document.getElementById('marketDropdown');
      if(existing){ existing.remove(); return; }
      var dd = document.createElement('div');
      dd.id = 'marketDropdown';
      dd.style.cssText = 'position:absolute;top:100%;right:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px 0;z-index:999;min-width:140px;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
      otherSlugs.forEach(function(s){
        var cfg = MARKET_CONFIG[s];
        var a = document.createElement('a');
        a.href = '?market='+s;
        a.textContent = cfg.name;
        a.style.cssText = 'display:block;padding:6px 14px;color:var(--text);text-decoration:none;font-size:12px';
        a.onmouseenter = function(){this.style.background='var(--border)'};
        a.onmouseleave = function(){this.style.background='transparent'};
        dd.appendChild(a);
      });
      switchLink.parentElement.style.position = 'relative';
      switchLink.parentElement.appendChild(dd);
      setTimeout(function(){document.addEventListener('click',function close(){dd.remove();document.removeEventListener('click',close)})},0);
    };
  }
  var analyticsLink = document.getElementById('analyticsLink');
  if(MARKET.slug!=='la') analyticsLink.href='analytics.html?market='+MARKET.slug;

  if(typeof LOADED_COMPS !== 'undefined' && LOADED_COMPS.length > 0) COMPS = LOADED_COMPS;
  if(typeof LOADED_LISTINGS !== 'undefined' && LOADED_LISTINGS.length > 0) LISTINGS = LOADED_LISTINGS;
  if(typeof LOADED_RENTAL_COMPS !== 'undefined' && LOADED_RENTAL_COMPS.length > 0){
    RENTAL_COMPS = LOADED_RENTAL_COMPS;
    rentalCompGrid = buildRentalCompGrid(RENTAL_COMPS);
    console.log('Rental comps loaded:', RENTAL_COMPS.length, 'grid cells:', Object.keys(rentalCompGrid).length);
  }

  // Stamp each listing with nearest cluster's T1 normalized exit $/SF
  if(CLUSTERS.length && LISTINGS.length){
    LISTINGS.forEach(function(l){
      var best = null, bestD = Infinity;
      for(var ci = 0; ci < CLUSTERS.length; ci++){
        var cl = CLUSTERS[ci];
        var d = Math.abs(cl.lat - l.lat) + Math.abs(cl.lng - l.lng);
        if(d < bestD){ bestD = d; best = cl; }
      }
      if(best && bestD < 0.01 && best.t1psf > 0){
        l.clusterT1psf = best.t1psf;
        l.clusterT1n = best.t1n || 0;
        l.clusterRw = best.rw || 0;
        l.clusterFb = best.t1fb;
      }
    });
  }

  if(COMPS.length > 0 || LISTINGS.length > 0){
    document.getElementById('loadingBanner').classList.add('active');
    document.getElementById('loadingBanner').textContent =
      `Loading ${COMPS.length.toLocaleString()} comps + ${LISTINGS.length.toLocaleString()} listings...`;

    setTimeout(function(){
      // Enrich listings with deal scores
      enrichListings();

      // Init filters (use comps if available, fall back to listings)
      var filterSource = COMPS.length ? COMPS : LISTINGS;
      initRangeFilter('price', c=>c.price, filterSource);
      initRangeFilter('psf', c=>c.ppsf||Math.round(c.price/c.sqft), filterSource);
      initRangeFilter('sqft', c=>c.sqft, filterSource);
      const lotsWithData = LISTINGS.filter(l=>l.lotSf&&l.lotSf>0);
      if(lotsWithData.length) initRangeFilter('lot', l=>l.lotSf||0, lotsWithData);
      const withLotW = LISTINGS.filter(l=>l.lw&&l.lw>0);
      if(withLotW.length) initRangeFilter('lotw', l=>l.lw||0, withLotW);
      const withSlope = LISTINGS.filter(l=>l.slope!=null);
      if(withSlope.length) initRangeFilter('slope', l=>l.slope!=null?l.slope:0, withSlope);
      const withMargin = LISTINGS.filter(l=>l.estMargin!=null);
      if(withMargin.length) initRangeFilter('margin', l=>l.estMargin||0, withMargin);

      // Build $/SF heatmap layer from sold comps
      if(COMPS.length && typeof L.heatLayer === 'function'){
        // **CRITICAL FIX**: Clamp heatmap to $600-$1,000 decision range
        const HEAT_MIN = 600;
        const HEAT_MAX = 1000;
        const heatPts = COMPS.filter(c=>c.ppsf>0).map(c=>{
          // Normalize $/SF to 0-1 intensity within $600-$1,000 range
          const intensity = Math.max(0, Math.min(1, (c.ppsf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
          return [c.lat, c.lng, intensity];
        });
        compHeatLayer = L.heatLayer(heatPts, {
          radius: 25,
          blur: 15,
          maxZoom: 17,
          max: 1.0,
          minOpacity: 0.25,
          pane:'heatmapPane',
          gradient: {
            0.0:  '#3b82f6',  // $600 ‚Äî blue (cool)
            0.25: '#22d3ee',  // $700 ‚Äî cyan
            0.50: '#22c55e',  // $800 ‚Äî green
            0.75: '#eab308',  // $900 ‚Äî yellow
            1.0:  '#ef4444'   // $1,000 ‚Äî red (hot)
          }
        });
        document.getElementById('heatCount').textContent = heatPts.length.toLocaleString();
        compCanvasRenderer = L.canvas({padding:0.5});
        compSpatialGrid = buildCompGrid(COMPS);
        map.on('moveend', updateCompPoints);
        map.on('zoomend', updateCompPoints);
      }
      
      // Set sort BEFORE building table
      currentSort = { key: 'estMargin', dir: 'desc' };
      
      rebuildMarkers();
      rebuildListings();
      rebuildZoneToggles();
      refreshVisibility();
      updateStats();
      updateFilterCount();
      updateFavCount();
      updateStatPills();
      updateLayersActiveCount();
      initLayerRowStates();
      updatePinLegend();
      initDrawControl();
      showOnboardingIfNeeded();
      
      // Ensure Saved Deals button starts in correct visual state
      document.getElementById('favToggle').classList.remove('active');

      // Fit bounds
      const allLats=[...COMPS.map(c=>c.lat),...LISTINGS.map(l=>l.lat)];
      const allLngs=[...COMPS.map(c=>c.lng),...LISTINGS.map(l=>l.lng)];
      if(allLats.length){
        let minLat=Infinity,maxLat=-Infinity,minLng=Infinity,maxLng=-Infinity;
        for(let i=0;i<allLats.length;i++){
          if(allLats[i]<minLat) minLat=allLats[i]; if(allLats[i]>maxLat) maxLat=allLats[i];
          if(allLngs[i]<minLng) minLng=allLngs[i]; if(allLngs[i]>maxLng) maxLng=allLngs[i];
        }
        map.fitBounds([[minLat,minLng],[maxLat,maxLng]],{padding:[50,50]});
      }


      // Update visual sort indicators to match current sort
      const th=document.querySelector('.listings-table th[data-sort="estMargin"]');
      if(th){
        th.classList.add('sorted');
        th.querySelector('.sort-arrow').textContent='‚ñº';
      }

      // Data freshness indicator
      if(typeof LISTINGS_META !== 'undefined' && LISTINGS_META.builtAt){
        const built = new Date(LISTINGS_META.builtAt);
        const ago = Math.floor((Date.now() - built.getTime()) / 3600000);
        const freshEl = document.getElementById('dataFreshness');
        if(ago < 24) freshEl.innerHTML = '<span style="color:var(--green)">&#9679;</span> Data updated ' + ago + 'h ago';
        else if(ago < 72) freshEl.innerHTML = '<span style="color:var(--yellow)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' day(s) old';
        else freshEl.innerHTML = '<span style="color:var(--red)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' days stale ‚Äî re-run fetch';
      }

      document.getElementById('loadingBanner').classList.remove('active');
      
      // Check for shared pin URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const pinParam = urlParams.get('pin');
      if(pinParam){
        const coords = pinParam.split(',');
        if(coords.length === 2){
          const lat = parseFloat(coords[0]);
          const lng = parseFloat(coords[1]);
          if(!isNaN(lat) && !isNaN(lng)){
            // Pan to the shared pin location
            map.setView([lat, lng], 17);
            // Find and open the popup for this pin
            setTimeout(function(){
              // Check all layers for a marker at this location
              var found = false;
              const layers = [listingsLayer, btrLayer, offMarketLayer];
              layers.forEach(layer => {
                if(layer && !found){
                  layer.eachLayer(marker => {
                    if(found) return;
                    const pos = marker.getLatLng();
                    if(Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001){
                      marker.openPopup();
                      found = true;
                    }
                  });
                }
              });
              // Fallback: listing may be filtered out ‚Äî open popup directly from LISTINGS data
              if(!found){
                var pinListing = LISTINGS.find(function(x){
                  return Math.abs(x.lat - lat) < 0.0001 && Math.abs(x.lng - lng) < 0.0001;
                });
                if(pinListing){
                  L.popup({maxWidth:660, className:'deal-popup'})
                    .setLatLng([lat, lng])
                    .setContent(generateDealCard(pinListing))
                    .openOn(map);
                }
              }
            }, 500);
          }
        }
      }
    }, 100);
  } else {
    rebuildZoneToggles();
    updateStats();
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOBILE OPTIMIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function isMobile() { return window.innerWidth <= 768; }
var sheetState = 'collapsed';

function setSheetState(state) {
  if (!isMobile()) return;
  var sidebar = document.querySelector('.sidebar');
  sheetState = state;
  sidebar.classList.remove('sheet-half', 'sheet-full');
  if (state === 'half') sidebar.classList.add('sheet-half');
  else if (state === 'full') sidebar.classList.add('sheet-full');
  if (state === 'collapsed') {
    sidebar.scrollTop = 0;
    var scrollEl = sidebar.querySelector('.sidebar-scroll');
    if(scrollEl) scrollEl.scrollTop = 0;
  }
}

function openMobileSheet() {
  setSheetState('full');
}

function updatePeekStats() {
  var el = document.getElementById('peekEligible');
  var ml = document.getElementById('peekMargin');
  if (!el || !ml) return;
  var filtered = getFilteredListings();
  var eligible = filtered.filter(function(l){ return l.sb1123Eligible; });
  var positiveMargin = eligible.filter(function(l){ return l.estMargin > 0; });
  var avgM = positiveMargin.length ? Math.round(positiveMargin.reduce(function(s,l){ return s+l.estMargin; },0)/positiveMargin.length) : 0;
  el.textContent = eligible.length;
  ml.textContent = avgM + '%';
}

function rebuildMobileCards(sorted) {
  var container = document.getElementById('mobileCards');
  if (!container) return;
  var display = sorted.slice(0, 200);
  container.innerHTML = display.map(function(l) {
    var marginClass = (l.estMargin || 0) >= 0 ? 'profit-pos' : 'profit-neg';
    var profitK = Math.round((l.estProfit || 0) / 1000);
    var profitStr = profitK >= 0 ? '+$' + profitK.toLocaleString() + 'K' : '-$' + Math.abs(profitK).toLocaleString() + 'K';
    var newBadge = l.isNew ? ' <span class="new-badge">NEW</span>' : (l.isNewThisWeek ? ' <span class="new-badge week">7d</span>' : '');
    return '<div class="mobile-card" onclick="flyToListing(' + l.lat + ',' + l.lng + ')">' +
      '<div class="card-addr">' + l.address + newBadge + '</div>' +
      '<div class="card-grid">' +
        '<div class="card-row"><span class="card-label">Zone</span><span class="card-value" style="color:' + (ZONE_COLORS[l.zone] || '#666') + '">' + (l.zone || '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Price</span><span class="card-value">$' + l.price.toLocaleString() + '</span></div>' +
        '<div class="card-row"><span class="card-label">Lot</span><span class="card-value">' + (l.lotSf ? l.lotSf.toLocaleString() + ' sf' : '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Units</span><span class="card-value">' + l.maxUnits + '</span></div>' +
      '</div>' +
      '<div class="card-margin-row">' +
        '<span class="card-profit ' + marginClass + '">' + profitStr + '</span>' +
        '<span class="card-margin ' + marginClass + '">' + (l.estMargin || 0).toFixed(0) + '%</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

// Sheet touch drag
(function initSheetDrag() {
  var handle = document.getElementById('sheetHandle');
  if (!handle) return;
  var startY, startH, sidebar, isDragging;

  handle.addEventListener('touchstart', function(e) {
    if (!isMobile()) return;
    isDragging = false;
    sidebar = document.querySelector('.sidebar');
    startY = e.touches[0].clientY;
    startH = sidebar.offsetHeight;
    sidebar.style.transition = 'none';
  }, { passive: true });

  handle.addEventListener('touchmove', function(e) {
    if (!isMobile() || !sidebar) return;
    isDragging = true;
    var dy = startY - e.touches[0].clientY;
    var newH = Math.max(56, Math.min(window.innerHeight * 0.85, startH + dy));
    sidebar.style.height = newH + 'px';
    e.preventDefault();
  }, { passive: false });

  handle.addEventListener('touchend', function() {
    if (!isMobile() || !sidebar) return;
    sidebar.style.transition = '';
    if (!isDragging) {
      // Tap: toggle between collapsed and half
      if (sheetState === 'collapsed') setSheetState('half');
      else setSheetState('collapsed');
      sidebar.style.height = '';
      return;
    }
    var h = sidebar.offsetHeight;
    var vh = window.innerHeight;
    if (h < vh * 0.2) setSheetState('collapsed');
    else if (h < vh * 0.6) setSheetState('half');
    else setSheetState('full');
    sidebar.style.height = '';
  });
})();

// Tap map to collapse sheet + neighborhood pricing card
map.on('click', function(e) {
  // Mobile: collapse sheet first
  if (isMobile() && sheetState !== 'collapsed') {
    setSheetState('collapsed');
    return;
  }

  // Neighborhood pricing card at zoom >= 14
  if (map.getZoom() < 14 || !CLUSTERS.length) return;

  var lat = e.latlng.lat, lng = e.latlng.lng;
  var nearest = null, minDist = Infinity;
  CLUSTERS.forEach(function(cl) {
    var d = Math.abs(cl.lat - lat) + Math.abs(cl.lng - lng);
    if (d < minDist) { minDist = d; nearest = cl; }
  });

  if (!nearest || minDist > 0.01) return;

  var t1psf = nearest.t1psf || 0;
  var t2psf = nearest.t2psf || 0;
  var prem = nearest.prem || (t1psf - t2psf);
  var t1n = nearest.t1n || 0;
  var t2n = nearest.t2n || 0;
  var rw = nearest.rw || 0;

  // Confidence: based on recency weight AND T1 count
  var confLabel, confDots;
  if (rw >= 0.8 && t1n >= 8) { confLabel = 'High'; confDots = 4; }
  else if (rw >= 0.5 && t1n >= 4) { confLabel = 'Medium'; confDots = 3; }
  else if (t1n >= 2) { confLabel = 'Low'; confDots = 2; }
  else { confLabel = 'Low'; confDots = 1; }

  var dots = '';
  for (var di = 0; di < 4; di++) {
    dots += '<span style="display:inline-block;width:8px;height:8px;border-radius:50;margin-right:2px;background:' + (di < confDots ? '#14b8a6' : '#2e3140') + '"></span>';
  }

  // Find zip from nearest listing
  var nearestListing = null, nlDist = Infinity;
  LISTINGS.forEach(function(ll) {
    var d2 = Math.abs(ll.lat - nearest.lat) + Math.abs(ll.lng - nearest.lng);
    if (d2 < nlDist) { nlDist = d2; nearestListing = ll; }
  });
  var zipLabel = nearestListing ? (nearestListing.zip || '') : '';
  var cityLabel = nearestListing ? (nearestListing.city || '') : '';
  var locLine = (zipLabel ? zipLabel + ' ¬∑ ' : '') + cityLabel;

  // Compute T1 raw median from nearby comps for display
  var cellComps = COMPS.filter(function(c) {
    return Math.abs(c.lat - nearest.lat) < 0.004 && Math.abs(c.lng - nearest.lng) < 0.004;
  });
  var t1Raw = cellComps.filter(function(c) { return c.t === 1; }).map(function(c) { return c.ppsf; }).sort(function(a,b){return a-b;});
  var t1RawMedian = t1Raw.length ? t1Raw[Math.floor(t1Raw.length / 2)] : t1psf;

  var html = '<div style="min-width:260px;font-family:DM Sans,sans-serif">'
    // Header
    + '<div style="padding-bottom:8px;border-bottom:1px solid #2e3140;margin-bottom:10px">'
    + '  <div style="font-size:13px;font-weight:600;color:#e4e6ed">' + locLine + '</div>'
    + '  <div style="font-size:11px;color:#8b8fa3;margin-top:3px">' + dots + ' ' + confLabel + ' (' + t1n + ' T1)</div>'
    + '</div>'
    // Primary metric
    + '<div style="padding-bottom:10px;border-bottom:1px solid #2e3140;margin-bottom:10px">'
    + '  <div style="font-size:11px;color:#8b8fa3;margin-bottom:4px">T1 Exit $/SF (@ 1,750 SF)</div>'
    + '  <div style="font-family:JetBrains Mono,monospace;font-size:28px;font-weight:700;color:#14b8a6">$' + t1psf.toLocaleString() + '</div>'
    + '</div>'
    // Breakdown rows
    + '<div style="padding-bottom:10px;border-bottom:1px solid #2e3140;margin-bottom:10px;font-size:12px">'
    + '  <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:#8b8fa3">T1 Raw Median</span><span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">$' + t1RawMedian.toLocaleString() + '</span></div>'
    + '  <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:#8b8fa3">T2 Baseline</span><span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">$' + t2psf.toLocaleString() + '</span></div>'
    + (prem > 0 ? '  <div style="display:flex;justify-content:space-between"><span style="color:#8b8fa3">Remodel Premium</span><span style="font-family:JetBrains Mono,monospace;color:#14b8a6">+$' + prem.toLocaleString() + '</span></div>' : '')
    + '</div>'
    // Footer stats
    + '<div style="display:flex;justify-content:space-between;font-size:11px">'
    + '  <div><span style="color:#8b8fa3">Recency</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + rw.toFixed(2) + '</span></div>'
    + '  <div><span style="color:#8b8fa3">T1</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + t1n + '</span></div>'
    + '  <div><span style="color:#8b8fa3">T2</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + t2n + '</span></div>'
    + '</div></div>';

  L.popup({className:'dark-popup'}).setLatLng(e.latlng).setContent(html).openOn(map);
});
</script>
</body>
</html>
