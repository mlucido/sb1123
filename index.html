<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SB 1123 Deal Finder ‚Äî LA County</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js" onerror="console.warn('esri-leaflet failed to load')"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script>
// Market config ‚Äî select via ?market=sd URL param (default: la)
var _urlMarket = new URLSearchParams(window.location.search).get('market') || 'la';
var MARKET_CONFIG = {
  la: { name:'Los Angeles', slug:'la', center:[34.05,-118.35], zoom:11,
        dataFile:'data.js', listingsFile:'listings.js', rentalDataFile:'rental_data.js',
        burnZones:true, burnZoneLabel:'Palisades + Eaton',
        hasZimas:true,
        hazardsUrl:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Dynamic/Hazards/MapServer',
        parcelUrl:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer',
        subtitle:'Townhome development sites in Los Angeles' },
  sd: { name:'San Diego', slug:'sd', center:[32.77,-117.15], zoom:10,
        dataFile:'sd_data.js', listingsFile:'sd_listings.js', rentalDataFile:'sd_rental_data.js',
        burnZones:false, burnZoneLabel:'',
        hasZimas:false,
        hazardsUrl:null, parcelUrl:null,
        subtitle:'Townhome development sites in San Diego' }
};
var MARKET = MARKET_CONFIG[_urlMarket] || MARKET_CONFIG.la;
document.title = 'SB 1123 Deal Finder ‚Äî ' + MARKET.name;

// Mobile: skip 25MB comps file, load only listings (already has pre-computed $/SF)
// Desktop: load both
var _isMob = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
if(!_isMob){
  document.write('<script src="'+MARKET.dataFile+'?v=7"><\/script>');
}
document.write('<script src="'+MARKET.listingsFile+'?v=7"><\/script>');
document.write('<script src="'+(MARKET.rentalDataFile||'rental_data.js')+'?v=7"><\/script>');
window.LOADED_COMPS = window.LOADED_COMPS || [];
window.LOADED_LISTINGS = window.LOADED_LISTINGS || [];
window.CLUSTERS = window.CLUSTERS || [];
window.LOADED_RENTAL_COMPS = window.LOADED_RENTAL_COMPS || [];
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,500;9..40,700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --r1:#2563eb;--r2:#16a34a;--r3:#ea580c;--r4:#9333ea;--land:#b45309;
    --listing:#f43f5e;
    --bg:#0f1117;--surface:#1a1d27;--surface2:#252833;
    --border:#2e3140;--text:#e4e6ed;--text-dim:#8b8fa3;--accent:#60a5fa;
    --green:#22c55e;--red:#ef4444;--yellow:#facc15;--orange:#f97316;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
  body.light-mode{
    --bg:#f5f5f5;--surface:#ffffff;--surface2:#e8e8e8;
    --border:#d0d0d0;--text:#1a1a2e;--text-dim:#666;--accent:#2563eb;
  }
  .mono{font-family:'JetBrains Mono',monospace}

  .app-row{display:flex;flex:1;overflow:hidden}

  /* (hero-stats removed ‚Äî stats now in sidebar pills) */
  /* ‚îÄ‚îÄ Onboarding walkthrough ‚îÄ‚îÄ */
  .onboard-overlay{position:fixed;inset:0;z-index:9000;display:none}
  .onboard-overlay.active{display:block}
  .onboard-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.55)}
  .onboard-card{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);width:420px;max-width:calc(100vw - 32px);background:#fff;border-radius:12px;padding:24px 24px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);font-size:13px;line-height:1.6;animation:slideIn 0.3s ease-out}
  .onboard-step{display:none}
  .onboard-step.active{display:block}
  .onboard-title{font-size:15px;font-weight:700;margin-bottom:8px}
  .onboard-body{color:#475569;margin-bottom:16px}
  .onboard-body .key{display:inline-block;padding:1px 6px;border-radius:4px;font-weight:600;font-size:12px}
  .onboard-footer{display:flex;justify-content:space-between;align-items:center}
  .onboard-dots{display:flex;gap:6px}
  .onboard-dots span{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
  .onboard-dots span.active{background:var(--green)}
  .onboard-btns{display:flex;gap:8px}
  .onboard-btns button{padding:6px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:none}
  .onboard-skip{background:none;color:#94a3b8}
  .onboard-skip:hover{color:#475569}
  .onboard-next{background:var(--green);color:#fff}
  .onboard-next:hover{opacity:0.9}
  @keyframes slideIn{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar{width:360px;min-width:360px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:1000;overflow:hidden}
  .sidebar-header{padding:20px 20px 14px;border-bottom:1px solid var(--border)}
  .sidebar-header h1{font-size:17px;font-weight:700;letter-spacing:-0.02em;margin-bottom:2px}
  .sidebar-header h1 span{color:var(--green)}
  .sidebar-header p{font-size:11px;color:var(--text-dim);line-height:1.5}
  .sidebar-header .law-ref{font-size:10px;color:var(--accent);margin-top:4px;opacity:0.7}

  /* Stat pills */
  .stat-pills{display:flex;gap:8px;margin-top:8px}
  .pill{flex:1;text-align:center;padding:6px 0;border-radius:6px;background:#f1f5f9}
  .pill-val{display:block;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:#1e293b}
  .pill-label{display:block;font-size:9px;color:#94a3b8;margin-top:1px}

  /* Sidebar scroll wrapper */
  .sidebar-scroll{flex:1;overflow-y:auto;padding-bottom:80px}

  /* Accordion headers */
  .accordion-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;cursor:pointer;background:#f8fafc;border-bottom:1px solid #e2e8f0}
  .accordion-header .label{font-size:11px;font-weight:700;letter-spacing:0.08em;color:#475569;text-transform:uppercase}
  .accordion-header .acc-right{display:flex;align-items:center;gap:8px}
  .accordion-header .acc-dim{font-size:10px;color:#94a3b8;font-weight:400;text-transform:none;letter-spacing:0}
  .accordion-header .acc-reset{font-size:10px;color:#3b82f6;cursor:pointer;font-weight:500;text-transform:none;letter-spacing:0}
  .accordion-header .acc-reset:hover{text-decoration:underline}
  .accordion-header .chevron{color:#94a3b8;font-size:10px;transition:transform 0.2s}
  .accordion-section.collapsed .accordion-header .chevron{transform:rotate(-90deg)}
  .accordion-section.collapsed .accordion-body{display:none}
  .accordion-body{padding:8px 10px}

  /* Layer rows (primary) */
  .layer-row{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:1px solid #e2e8f0;cursor:pointer;font-size:11px;font-weight:500;margin-bottom:4px;transition:all 0.15s;font-family:inherit;background:transparent;width:100%;color:var(--text)}
  .layer-row:hover{border-color:#94a3b8}
  .layer-row .ldot{width:8px;height:8px;border-radius:50%;background:#cbd5e1;flex-shrink:0;transition:background 0.15s}
  .layer-row .lname{flex:1;text-align:left}
  .layer-row .lcount{font-family:'JetBrains Mono',monospace;font-size:10px;color:#94a3b8}

  /* Layer grid (2-col for secondary layers) */
  .layer-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
  .layer-cell{display:flex;align-items:center;gap:6px;padding:7px 8px;border-radius:6px;border:1px solid #e2e8f0;cursor:pointer;font-size:11px;font-weight:500;transition:all 0.15s;font-family:inherit;background:transparent;color:var(--text)}
  .layer-cell:hover{border-color:#94a3b8}
  .layer-cell .ldot{width:8px;height:8px;border-radius:50%;background:#cbd5e1;flex-shrink:0;transition:background 0.15s}
  .layer-cell .lname{flex:1}
  .layer-cell .lcount{font-family:'JetBrains Mono',monospace;font-size:10px;color:#94a3b8}

  /* Overlay chips */
  .overlay-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
  .chip-btn{font-size:10px;padding:3px 8px;border-radius:10px;border:1px solid #e2e8f0;color:#64748b;cursor:pointer;transition:all 0.15s;font-family:inherit;background:transparent}
  .chip-btn:hover{border-color:#94a3b8}
  .chip-btn.active{background:rgba(96,165,250,0.1);border-color:#3b82f6;color:#3b82f6}

  /* Zoning compact row */
  .zoning-bar{display:flex;align-items:center;gap:8px;margin-top:10px;padding:6px 8px;border-radius:6px;background:#f8fafc}
  .zoning-bar .zone-sw{width:12px;height:12px;border-radius:3px;background:#3b82f6;flex-shrink:0}
  .zoning-bar .zone-name{font-size:11px;font-weight:500}
  .zoning-bar .zone-psf{font-family:'JetBrains Mono',monospace;font-size:10px;color:#94a3b8}
  .zoning-bar .zone-expand{font-size:10px;color:#64748b;margin-left:auto;cursor:pointer;background:none;border:none;font-family:inherit;padding:0}
  .zoning-bar .zone-expand:hover{color:#3b82f6}

  /* Sticky bottom bar */
  .sidebar-bottom{display:flex;flex-direction:column;gap:6px;padding:10px 14px;border-top:1px solid #e2e8f0;background:#fff;flex-shrink:0}
  .sidebar-bottom .bottom-row{display:flex;gap:6px}
  .bottom-btn{flex:1;padding:8px;font-size:11px;font-weight:600;border:1px solid #e2e8f0;border-radius:6px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;font-family:inherit;color:var(--text);transition:all 0.15s}
  .bottom-btn:hover{border-color:#94a3b8}
  .bottom-btn.active{border-color:#facc15;background:rgba(250,204,21,0.08)}
  .bottom-btn.gear{padding:8px 10px;flex:none;font-size:16px}
  .basemap-row{display:flex;justify-content:center;gap:12px;margin-top:8px}
  .basemap-link{font-size:10px;cursor:pointer;color:#94a3b8;background:none;border:none;font-family:inherit;padding:0;transition:color 0.15s}
  .basemap-link:hover{color:#3b82f6}
  .basemap-link.active{color:#3b82f6;font-weight:600}
  .basemap-dot{color:#94a3b8;font-size:8px}

  /* Key filter labels */
  .kf-header{display:flex;align-items:center;margin-bottom:6px}
  .kf-label{font-size:11px;font-weight:600;color:var(--text)}
  .kf-chips{display:flex;gap:4px;margin-left:auto}
  .kf-chip{font-size:9px;padding:2px 6px;border-radius:8px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all 0.15s}
  .kf-chip.active{background:#dcfce7;color:#16a34a}
  .kf-chip:not(.active){background:#e2e8f0;color:#94a3b8}
  .kf-chip:hover:not(.active){background:#e2e8f0;color:#64748b}
  .kf-range-labels{display:flex;justify-content:space-between;font-size:10px;color:#94a3b8;margin-bottom:6px}
  .kf-block{margin-bottom:14px}

  /* Secondary filter rows */
  .sf-list{border-top:1px solid #e2e8f0;margin-top:10px;padding-top:8px}
  .sf-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:11px;color:#64748b;cursor:pointer}
  .sf-row:hover{color:var(--text)}
  .sf-row .sf-chevron{color:#cbd5e1;font-size:10px;transition:transform 0.2s}
  .sf-row.expanded .sf-chevron{transform:rotate(90deg)}
  .sf-body{display:none;padding:4px 0 8px}
  .sf-row.expanded+.sf-body{display:block}

  .section{padding:14px 20px;border-bottom:1px solid var(--border)}
  .section-title{font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:6px}
  .section-title .badge{background:var(--green);color:#000;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700;letter-spacing:0.03em}

  /* Stats grid */
  .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .stats-grid.two-col{grid-template-columns:1fr 1fr}
  .stat-card{background:var(--surface2);border-radius:8px;padding:10px 12px}
  .stat-card .stat-value{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;color:var(--accent)}
  .stat-card .stat-value.green{color:var(--green)}
  .stat-card .stat-value.yellow{color:var(--yellow)}
  .stat-card .stat-value.red{color:var(--red)}
  .stat-card .stat-label{font-size:10px;color:var(--text-dim);margin-top:2px}

  /* SB9 mode toggle */
  .mode-toggle{
    display:flex;align-items:center;gap:10px;padding:10px 14px;
    border-radius:8px;cursor:pointer;transition:all 0.2s;
    border:1px solid var(--border);background:transparent;width:100%;
    font-family:inherit;font-size:13px;color:var(--text);
  }
  .mode-toggle:hover{border-color:var(--green);background:rgba(34,197,94,0.04)}
  .mode-toggle.active{border-color:var(--green);background:rgba(34,197,94,0.08)}
  .mode-toggle .toggle-track{
    width:36px;height:20px;border-radius:10px;background:var(--surface2);
    border:1px solid var(--border);position:relative;transition:all 0.2s;flex-shrink:0;
  }
  .mode-toggle.active .toggle-track{background:var(--green);border-color:var(--green)}
  .mode-toggle .toggle-thumb{
    width:16px;height:16px;border-radius:50%;background:#fff;
    position:absolute;top:1px;left:1px;transition:all 0.2s;
  }
  .mode-toggle.active .toggle-thumb{left:17px}
  .mode-toggle .toggle-label{flex:1}
  .mode-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Zone toggles */
  .zone-toggle{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background 0.15s;margin-bottom:2px}
  .zone-toggle:hover{background:var(--surface2)}
  .zone-swatch{width:12px;height:12px;border-radius:3px;flex-shrink:0}
  .zone-toggle input[type="checkbox"]{display:none}
  .zone-toggle .check-box{width:16px;height:16px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
  .zone-toggle input:checked+.check-box{border-color:var(--accent);background:var(--accent)}
  .zone-toggle input:checked+.check-box::after{content:'‚úì';color:#fff;font-size:10px;font-weight:700}
  .zone-label{font-size:12px;flex:1}
  .zone-label small{color:var(--text-dim);font-size:10px}
  .zone-stat{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim)}
  .data-count{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);background:rgba(96,165,250,0.1);padding:1px 5px;border-radius:3px;margin-left:3px}

  /* Basemap toggle */
  .basemap-group{display:flex;gap:4px}
  .basemap-btn{flex:1;padding:6px 0;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:11px;font-weight:500;transition:all 0.15s}
  .basemap-btn:hover{border-color:var(--accent)}
  .basemap-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.15);color:var(--accent)}

  /* Layer buttons */
  .layer-btn{display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:12px;margin-bottom:4px;transition:all 0.15s}
  .layer-btn:hover{border-color:var(--accent)}
  .layer-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.08)}
  .layer-btn .icon{font-size:14px}
  .layer-btn .layer-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);margin-left:auto}

  /* Range filters */
  .range-filter{margin-top:2px}
  .range-inputs{display:flex;gap:6px;align-items:center;margin-bottom:8px}
  .range-inputs input[type="number"]{
    width:100%;padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;
    outline:none;transition:border 0.15s;
  }
  .range-inputs input[type="number"]:focus{border-color:var(--accent)}
  .range-inputs .separator{color:var(--text-dim);font-size:12px;flex-shrink:0}
  .range-inputs .input-group{flex:1}
  .range-inputs .input-label{font-size:9px;color:var(--text-dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.08em}

  .range-slider-track{position:relative;height:4px;background:#e2e8f0;border-radius:2px;margin:0 4px 10px}
  .range-slider-fill{position:absolute;height:100%;background:var(--accent);border-radius:2px;opacity:0.4}
  .range-slider-track input[type="range"]{
    position:absolute;width:100%;height:4px;top:0;
    -webkit-appearance:none;appearance:none;background:transparent;pointer-events:none;margin:0;
  }
  .range-slider-track input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;pointer-events:auto;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);margin-top:-6px;
  }
  .range-slider-track input[type="range"]::-moz-range-thumb{
    width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;pointer-events:auto;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);
  }
  /* Standalone single slider (Min Units) */
  input[type="range"].standalone-slider{
    -webkit-appearance:none;appearance:none;width:100%;height:4px;
    background:#e2e8f0;border-radius:2px;outline:none;margin:0;
  }
  input[type="range"].standalone-slider::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);margin-top:-6px;
  }
  input[type="range"].standalone-slider::-moz-range-thumb{
    width:16px;height:16px;border-radius:50%;
    background:#3b82f6;border:2px solid #fff;cursor:pointer;
    box-shadow:0 1px 3px rgba(0,0,0,0.2);
  }

  .filter-count{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);text-align:center;padding:6px 0;background:rgba(96,165,250,0.06);border-radius:6px}
  .reset-btn{
    display:block;width:100%;padding:6px;margin-top:6px;background:transparent;
    border:1px solid var(--border);border-radius:6px;color:var(--text-dim);
    font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;text-align:center;
  }
  .reset-btn:hover{border-color:var(--accent);color:var(--accent)}

  /* Pro forma assumptions */
  .proforma-inputs{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .proforma-group{display:flex;flex-direction:column;gap:2px}
  .proforma-group label{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em}
  .proforma-group input{
    padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;
    outline:none;width:100%;
  }
  .proforma-group input:focus{border-color:var(--accent)}

  /* Quick presets */
  .preset-row{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
  .preset-btn{
    padding:4px 10px;border:1px solid var(--border);border-radius:4px;
    background:transparent;color:var(--text-dim);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;
  }
  .preset-btn:hover{border-color:var(--green);color:var(--green)}
  .preset-btn.active{border-color:var(--green);background:rgba(34,197,94,0.1);color:var(--green)}

  /* Map */
  #map{flex:1;height:100%;z-index:1}

  /* Popups */
  .leaflet-popup-content-wrapper{background:var(--surface)!important;color:var(--text)!important;border-radius:10px!important;border:1px solid var(--border)!important;box-shadow:0 8px 32px rgba(0,0,0,0.5)!important}
  .leaflet-popup-tip{background:var(--surface)!important}
  .leaflet-popup-content{font-family:'DM Sans',sans-serif!important;margin:12px 14px!important;min-width:340px;max-width:750px}
  .dark-popup .leaflet-popup-content{min-width:260px}
  .popup-two-col{display:flex;gap:14px;max-height:75vh;width:710px}
  .popup-col-left,.popup-col-right{flex:1;min-width:0;overflow-y:auto;padding-right:4px}
  .popup-col-left::-webkit-scrollbar,.popup-col-right::-webkit-scrollbar{width:4px}
  .popup-col-left::-webkit-scrollbar-thumb,.popup-col-right::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
  .popup-col-left::-webkit-scrollbar-track,.popup-col-right::-webkit-scrollbar-track{background:transparent}
  .popup-title{font-weight:700;font-size:14px;margin-bottom:8px;line-height:1.3}
  .popup-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;margin-right:4px}
  .popup-badge.comp{background:rgba(96,165,250,0.15);color:var(--accent)}
  .popup-badge.listing{background:rgba(244,63,94,0.15);color:var(--listing)}
  .popup-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:3px 10px}
  .popup-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:3px 10px}
  .popup-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:3px 12px}
  .popup-label{font-size:10px;color:var(--text-dim);line-height:1.2}
  .popup-value{font-family:'JetBrains Mono',monospace;font-size:11.5px;font-weight:600;line-height:1.3}
  .popup-divider{grid-column:1/-1;border-top:1px solid var(--border);margin:5px 0 3px 0}
  .popup-section-label{grid-column:1/-1;font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);font-weight:700;margin-top:2px;margin-bottom:2px}
  .popup-span-2{grid-column:span 2}
  .popup-span-3{grid-column:span 3}
  .popup-span-4{grid-column:span 4}
  .popup-profit-positive{color:var(--green)}
  .popup-profit-negative{color:var(--red)}
  .lot-layout-toggle{grid-column:1/-1;cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);font-weight:700;margin-top:4px;padding:4px 0;display:flex;align-items:center;gap:6px;border-top:1px solid var(--border)}
  .lot-layout-toggle:hover{color:var(--text)}
  .lot-layout-toggle .tri{font-size:8px;transition:transform 0.2s}
  .lot-layout-toggle.open .tri{transform:rotate(90deg)}
  .lot-layout-body{grid-column:1/-1;overflow:hidden;max-height:0;transition:max-height 0.4s ease-out}
  .lot-layout-body.open{max-height:2000px;transition:max-height 0.5s ease-in}
  .lot-layout-body svg{display:block;margin:4px auto 0;max-width:100%}
  /* Deal Scorecard */
  .popup-scorecard{display:grid;grid-template-columns:repeat(4,1fr);gap:2px 8px;padding:6px 8px;margin-bottom:8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px}
  .popup-scorecard .sc-label{font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);line-height:1.2}
  .popup-scorecard .sc-value{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;line-height:1.3}
  /* Action links bar */
  .popup-links{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:8px}
  .popup-links a{color:var(--accent);font-size:10px;text-decoration:none;white-space:nowrap}
  .popup-links a:hover{text-decoration:underline}
  /* Collapsible toggle (generic) */
  .popup-collapse-toggle{cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;padding:2px 0;display:flex;align-items:center;gap:5px}
  .popup-collapse-toggle:hover{color:var(--text)}
  .popup-collapse-toggle .tri{font-size:8px;transition:transform 0.2s}
  .popup-collapse-toggle.open .tri{transform:rotate(90deg)}
  .popup-collapse-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease-out}
  .popup-collapse-body.open{max-height:800px;transition:max-height 0.4s ease-in}

  /* Deal Card v2 */
  .deal-popup .leaflet-popup-content-wrapper{overflow:visible!important}
  .deal-popup .leaflet-popup-content{min-width:560px;max-width:660px;margin:0!important;padding:0!important;overflow:visible!important}
  .dp-card{font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text)}

  /* Strip (always visible) */
  .dp-strip{display:grid;grid-template-columns:1.8fr repeat(4,1fr) 40px;align-items:center;gap:0;padding:10px 12px;cursor:pointer;border:1px solid var(--border);border-radius:6px;margin:6px 6px 0}
  .dp-strip:hover{background:var(--surface2)}
  .dp-addr{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;line-height:1.25;text-transform:capitalize}
  .dp-addr .dp-city{font-weight:400;font-size:11px;color:var(--text-dim)}
  .dp-addr .dp-zip{color:#888;font-weight:500;font-size:11px}
  .dp-addr .dp-badges-inline{display:flex;gap:4px;margin-left:auto;flex-shrink:0}
  .dp-addr .dp-badges-inline .popup-badge{margin:0;font-size:9px;padding:1px 6px}
  .dp-metric{text-align:center}
  .dp-metric .dp-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:2px}
  .dp-metric .dp-val{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;line-height:1.2}
  .dp-toggle{display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--text-dim);transition:transform 0.2s}
  .dp-card.expanded .dp-toggle{transform:rotate(180deg)}

  /* Alert badges row (burn zone, tenant risk etc) */
  .dp-alerts{display:flex;gap:4px;flex-wrap:wrap;padding:4px 8px 0}

  /* Drawer (hidden until expanded) */
  .dp-drawer{max-height:0;overflow:hidden;transition:max-height 0.35s ease-out}
  .dp-card.expanded .dp-drawer{max-height:3000px;transition:max-height 0.4s ease-in}

  /* 3-column body */
  .dp-body{display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:0;margin:6px 6px 0;border:1px solid var(--border);border-radius:6px;overflow:hidden}
  .dp-col{min-width:0;padding:8px 10px}
  .dp-col+.dp-col{border-left:1px solid var(--border)}
  .dp-col-head{font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin-bottom:6px}
  .dp-row{display:flex;justify-content:space-between;font-size:11px;line-height:1.7}
  .dp-row .dp-k{color:var(--text-dim);white-space:nowrap}
  .dp-row .dp-v{font-family:'JetBrains Mono',monospace;font-weight:600;text-align:right;white-space:nowrap}
  .dp-sep{border-top:1px solid var(--border);margin:4px 0}

  /* Comp buttons */
  .dp-comps{display:flex;gap:16px;padding:6px 8px 0;align-items:center}
  .dp-comp-btn{display:inline-flex;align-items:center;background:none;border:none;padding:0;cursor:pointer;font-family:inherit;font-size:11.5px;font-weight:600;color:#2563eb;text-decoration:none;white-space:nowrap;line-height:1.3}
  .dp-comp-btn:hover{text-decoration:underline}
  .dp-comp-arrow{font-size:10px}

  /* BTR section */
  .dp-btr{display:grid;grid-template-columns:1fr 1fr;gap:0;margin:8px 8px 0;border:1px solid var(--border);border-radius:6px;overflow:hidden}
  .dp-btr-col{padding:8px 10px}
  .dp-btr-col+.dp-btr-col{border-left:1px solid var(--border)}
  .dp-btr .dp-row .dp-k{color:var(--text-dim)}

  /* DD bar */
  .dp-dd{padding:8px 12px;font-size:11px;color:var(--text-dim);margin:8px 6px 0;line-height:1.5}

  /* Action buttons toolbar */
  .dp-actions{display:flex;justify-content:space-around;background:#fafafa;border-top:1px solid #e5e7eb;border-radius:0 0 6px 6px;padding:6px 8px;margin-top:4px;gap:0}
  .dp-actions a,.dp-actions button{display:flex;flex-direction:column;align-items:center;gap:1px;padding:4px 10px;background:none;border:none;border-radius:6px;color:#64748b;font-family:inherit;font-size:8px;text-transform:uppercase;letter-spacing:0.04em;cursor:pointer;text-decoration:none;line-height:1.2}
  .dp-actions a:hover,.dp-actions button:hover{background:#e5e7eb}
  .dp-actions .dp-icon{font-size:13px;line-height:1}
  .dp-actions .active{border:none;background:none;color:#f59e0b}
  .dp-actions .active:hover{background:#e5e7eb}
  .dp-actions .active .dp-icon{color:#f59e0b}

  /* Lot layout toggle in drawer */
  .dp-lot-toggle{cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin-top:4px;display:flex;align-items:center;gap:5px}
  .dp-lot-toggle:hover{color:var(--text)}
  .dp-lot-toggle .tri{font-size:8px;transition:transform 0.2s}
  .dp-lot-toggle.open .tri{transform:rotate(90deg)}
  .dp-lot-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease-out}
  .dp-lot-body.open{max-height:2000px;transition:max-height 0.4s ease-in}
  .dp-lot-body svg{display:block;margin:4px auto 0;max-width:100%}

  @media (max-width: 768px){
    .deal-popup .leaflet-popup-content{min-width:320px}
    .dp-body{grid-template-columns:1fr;gap:0}
    .dp-col+.dp-col{border-left:none;border-top:1px solid var(--border)}
    .dp-strip{grid-template-columns:1.5fr repeat(2,1fr) 36px;font-size:11px}
    .dp-strip .dp-metric:nth-child(4),.dp-strip .dp-metric:nth-child(5){display:none}
    .dp-btr{grid-template-columns:1fr}
    .dp-btr-col+.dp-btr-col{border-left:none;border-top:1px solid var(--border)}
    .dp-actions{flex-wrap:wrap}
  }

  /* Pin Color Legend */
  .pin-legend{
    position:absolute;bottom:10px;left:10px;
    background:rgba(26,29,39,0.92);border:1px solid var(--border);border-radius:8px;
    padding:8px 10px;z-index:850;font-size:10px;box-shadow:0 2px 12px rgba(0,0,0,0.4);
  }
  body.light-mode .pin-legend{background:rgba(255,255,255,0.92)}
  .pin-legend-item{display:flex;align-items:center;gap:6px;margin-bottom:2px;line-height:1.4}
  .pin-legend-item:last-child{margin-bottom:0}
  .pin-legend-marker{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .pin-legend-marker.diamond{border-radius:0;transform:rotate(45deg);border:1.5px dashed #d97706;background:rgba(245,158,11,0.85)}
  .pin-legend-marker.circle{border:2px solid #666;background:transparent}
  .pin-legend-section{border-top:1px solid var(--border);margin:4px 0;padding-top:4px}
  .pin-legend-gradient{height:8px;border-radius:4px;margin:3px 0}
  .pin-legend-gradient-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim)}

  /* Old Legend (keep for desktop reference) */
  .map-legend{position:absolute;bottom:30px;right:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;z-index:800;font-size:11px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:none}
  .legend-item{display:flex;align-items:center;gap:8px;margin-bottom:3px}
  .legend-item:last-child{margin-bottom:0}
  .legend-dot{width:10px;height:10px;border-radius:2px}
  .legend-section{font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);margin:6px 0 3px;font-weight:700}

  .sidebar::-webkit-scrollbar{width:6px}
  .sidebar::-webkit-scrollbar-track{background:transparent}
  .sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .loading-banner{padding:10px 20px;background:rgba(96,165,250,0.1);border-bottom:1px solid var(--border);font-size:12px;color:var(--accent);text-align:center;display:none}
  .loading-banner.active{display:block}

  /* ‚îÄ‚îÄ Listings Table Panel ‚îÄ‚îÄ */
  .listings-panel{
    position:relative;height:0;min-height:0;background:var(--surface);
    border-top:1px solid var(--border);transition:height 0.3s ease, min-height 0.3s ease;
    overflow:hidden;z-index:900;
  }
  .listings-panel.open{height:360px;min-height:200px}
  .listings-panel-header{
    display:flex;align-items:center;gap:10px;padding:8px 20px;
    border-bottom:1px solid var(--border);background:var(--surface);
    position:sticky;top:0;z-index:2;
  }
  .listings-panel-header h2{font-size:13px;font-weight:700;letter-spacing:-0.01em}
  .listings-panel-header h2 span{color:var(--green)}
  .listings-panel-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);background:rgba(96,165,250,0.1);padding:2px 6px;border-radius:4px}
  .listings-panel-close{margin-left:auto;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:4px 8px;border-radius:4px;transition:all 0.15s}
  .listings-panel-close:hover{color:var(--text);background:var(--surface2)}
  .listings-panel-tab{
    position:absolute;bottom:0;left:50%;transform:translateX(-50%);
    background:var(--surface);border:1px solid var(--border);border-bottom:none;
    border-radius:8px 8px 0 0;padding:5px 18px;cursor:pointer;z-index:901;
    display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;
    color:var(--text-dim);transition:all 0.15s;
  }
  .listings-panel-tab:hover{color:var(--text);background:var(--surface2)}
  .listings-panel-tab .tab-arrow{font-size:9px}
  .listings-panel-tab .tab-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent)}
  .listings-panel-resize{position:absolute;top:0;left:0;right:0;height:5px;cursor:ns-resize;z-index:3}
  .listings-panel-resize:hover{background:var(--accent);opacity:0.3}
  .listings-table-wrap{overflow:auto;height:calc(100% - 41px)}
  .listings-table-wrap::-webkit-scrollbar{width:6px;height:6px}
  .listings-table-wrap::-webkit-scrollbar-track{background:transparent}
  .listings-table-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .listings-table{width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed;min-width:1300px}
  .listings-table thead{position:sticky;top:0;z-index:1}
  .listings-table th{
    background:var(--surface2);padding:7px 10px;text-align:left;font-size:9px;
    text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-weight:700;
    cursor:pointer;white-space:nowrap;border-bottom:1px solid var(--border);
    user-select:none;transition:color 0.15s;position:relative;
  }
  .listings-table th:hover{color:var(--accent)}
  .listings-table th.sorted{color:var(--accent)}
  .listings-table th .sort-arrow{display:inline-block;margin-left:3px;font-size:8px;opacity:0;transition:opacity 0.15s}
  .listings-table th.sorted .sort-arrow{opacity:1}
  .listings-table th:hover .sort-arrow{opacity:0.5}
  .listings-table td{padding:6px 10px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .listings-table tr{transition:background 0.1s}
  .listings-table tbody tr:hover{background:var(--surface2);cursor:pointer}

  .listings-table .col-addr{width:230px}
  .listings-table .col-zone{width:50px}
  .listings-table .col-price{width:95px}
  .listings-table .col-lot{width:75px}
  .listings-table .col-lotw{width:50px;text-align:right}
  .listings-table .col-units{width:55px}
  .listings-table .col-hood{width:80px}
  .listings-table .col-sale{width:90px}
  .listings-table .col-ppu{width:90px}
  .listings-table .col-profit{width:90px}
  .listings-table .col-margin{width:65px}
  .listings-table .col-slope{width:60px}
  .listings-table .col-dom{width:45px}
  .listings-table .col-new{width:40px;text-align:center}
  .listings-table .col-link{width:45px}

  .listings-table .zone-pill{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:0.03em}
  .listings-table .redfin-link{color:var(--accent);text-decoration:none;font-size:10px}
  .listings-table .redfin-link:hover{text-decoration:underline}
  .listings-table .profit-pos{color:var(--green)}
  .listings-table .profit-neg{color:var(--red)}

  /* NEW listing badge */
  .new-badge{display:inline-block;padding:1px 6px;border-radius:9px;font-size:9px;font-weight:700;letter-spacing:0.04em;background:#22c55e;color:#fff;vertical-align:middle;margin-left:4px;line-height:1.4}
  .new-badge.week{background:#0ea5e9}
  .listing-marker-new{animation:newPulse 2s ease-in-out infinite}
  @keyframes newPulse{0%,100%{filter:drop-shadow(0 0 4px rgba(34,197,94,0.6))}50%{filter:drop-shadow(0 0 10px rgba(34,197,94,0.9))}}
  .marker-highlight{animation:markerPulse .5s ease-in-out infinite;transform-origin:center;transform-box:fill-box}
  @keyframes markerPulse{0%,100%{transform:scale(1);filter:drop-shadow(0 0 6px #fff)}50%{transform:scale(1.8);filter:drop-shadow(0 0 12px #fff)}}

  /* Panel toggle in sidebar */
  .panel-toggle{
    display:flex;align-items:center;justify-content:space-between;width:100%;
    padding:10px 12px;border:1px solid var(--green);border-radius:8px;
    background:rgba(34,197,94,0.06);color:var(--text);cursor:pointer;
    font-family:inherit;font-size:13px;transition:all 0.15s;
  }
  .panel-toggle:hover{background:rgba(34,197,94,0.12)}
  .panel-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Collapsible sections */
  .section.collapsed .section-content{display:none}
  .section-title{cursor:pointer}
  .section-title .chevron{transition:transform 0.2s;font-size:10px;margin-left:auto;color:var(--text-dim)}
  .section.collapsed .section-title .chevron{transform:rotate(-90deg)}

  /* (export-btn removed ‚Äî export now in bottom bar) */
  .refresh-btn{
    padding:4px 10px;background:rgba(34,197,94,0.1);border:1px solid var(--green);
    border-radius:4px;color:var(--green);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;white-space:nowrap;
  }
  .refresh-btn:hover{background:rgba(34,197,94,0.2)}
  .analytics-btn{
    padding:4px 10px;background:rgba(96,165,250,0.1);border:1px solid var(--accent);
    border-radius:4px;color:var(--accent);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;white-space:nowrap;text-decoration:none;
  }
  .analytics-btn:hover{background:rgba(96,165,250,0.2)}

  /* Favorites */
  .listings-table .col-fav{width:32px;text-align:center;cursor:pointer}
  .fav-star{font-size:14px;cursor:pointer;opacity:0.3;transition:all 0.15s;user-select:none}
  .fav-star:hover{opacity:0.7;transform:scale(1.2)}
  .fav-star.active{opacity:1;color:#facc15}
  .fav-toggle{
    display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;
    background:var(--surface2);border:1px solid var(--border);border-radius:6px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .fav-toggle:hover:not(:disabled){border-color:var(--accent)}
  .fav-toggle:disabled{opacity:0.4;cursor:not-allowed;border-color:transparent;pointer-events:none}
  .fav-toggle.active{border-color:#facc15;background:rgba(250,204,21,0.08)}
  .fav-toggle .fav-count{margin-left:auto;font-family:'JetBrains Mono',monospace;color:#facc15;font-size:10px}
  .popup-fav-btn{
    display:inline-flex;align-items:center;gap:4px;padding:4px 10px;margin-top:6px;
    background:var(--surface2);border:1px solid var(--border);border-radius:4px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .popup-fav-btn:hover{border-color:#facc15}
  .popup-fav-btn.active{border-color:#facc15;background:rgba(250,204,21,0.1);color:#facc15}
  .comp-psf-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:#e2e8f0;text-shadow:0 0 3px rgba(0,0,0,0.9),0 0 6px rgba(0,0,0,0.7);white-space:nowrap;text-align:center;pointer-events:none}

  /* ‚îÄ‚îÄ Mobile: Bottom Sheet + Cards ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    html, body { height: 100vh; height: 100dvh; overflow-x: hidden; max-width: 100vw; }
    .app-row { position: relative; max-width: 100vw; overflow-x: hidden; }
    #map { width: 100% !important; }

    /* Sidebar ‚Üí Bottom sheet */
    .sidebar {
      position: fixed !important; bottom: 0; left: 0; right: 0;
      width: 100% !important; min-width: 0 !important;
      height: 56px; max-height: 85vh;
      border-right: none !important; border-top: 1px solid var(--border);
      border-radius: 16px 16px 0 0;
      z-index: 1100; transition: height 0.3s ease;
      overflow: hidden;
    }
    .sidebar.sheet-half { height: 40vh; }
    .sidebar.sheet-full { height: 85vh; }

    /* Sheet handle */
    .sheet-handle {
      display: flex; flex-direction: column; align-items: center;
      padding: 10px 16px 6px; cursor: grab;
      position: sticky; top: 0; z-index: 10; background: var(--surface);
      border-radius: 16px 16px 0 0;
    }
    .sheet-handle .handle-bar {
      width: 40px; height: 4px; background: var(--text-dim); border-radius: 2px;
      margin-bottom: 8px; opacity: 0.5;
    }
    .sheet-handle .peek-stats {
      display: flex; gap: 16px; font-size: 13px; font-weight: 500;
      width: 100%; justify-content: center;
    }
    .sheet-handle .peek-stats .peek-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--green);
    }

    /* Floating filter button */
    .mobile-filter-btn {
      display: flex !important; position: fixed; top: 12px; left: 12px; z-index: 1050;
      padding: 10px 16px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-family: inherit; font-size: 13px;
      font-weight: 600; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      align-items: center; gap: 8px;
    }

    .sidebar-header .refresh-btn { display: none; }
    .sidebar-header .analytics-btn { display: none; }

    /* Stats grid: 2 columns */
    .stats-grid { grid-template-columns: 1fr 1fr; }

    /* Pro forma: 1 column */
    .proforma-inputs { grid-template-columns: 1fr; }

    /* Range slider: bigger touch targets */
    .range-slider-track input[type="range"]::-webkit-slider-thumb {
      width: 24px; height: 24px; margin-top: -10px;
    }
    .range-slider-track input[type="range"] { height: 4px; top: 0; }
    input[type="range"].standalone-slider::-webkit-slider-thumb {
      width: 24px; height: 24px; margin-top: -10px;
    }

    /* Buttons: min 44px touch target */
    .mode-toggle, .layer-btn, .layer-row, .layer-cell, .panel-toggle, .fav-toggle,
    .reset-btn, .bottom-btn { min-height: 44px; }
    .preset-btn, .basemap-btn { min-height: 40px; }

    /* Legend + panel tab: hide on mobile */
    .map-legend { display: none; }
    .listings-panel-tab { display: none !important; }

    /* Popup: mobile-friendly */
    .leaflet-popup-content { min-width: unset !important; max-width: unset !important; }
    .leaflet-popup-content-wrapper {
      max-height: 50vh; overflow-y: auto !important;
      max-width: calc(100vw - 40px) !important;
    }
    .popup-two-col { flex-direction: column; max-height: none; width: auto !important; }
    .popup-col-left,.popup-col-right { overflow-y: visible; padding-right: 0; }
    .popup-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 2px 8px; }
    .popup-grid-3 { grid-template-columns: repeat(2, 1fr) !important; }
    .popup-section-label { font-size: 10px; }
    .popup-scorecard { grid-template-columns: repeat(2, 1fr) !important; }
    .popup-scorecard .sc-value { font-size: 12px; }

    /* Pin legend: above bottom sheet */
    .pin-legend { bottom: 70px; }

    .onboard-card { bottom: 40px; width: calc(100vw - 32px); }

    /* Listings panel: full-screen overlay */
    .listings-panel {
      position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
      height: 0; min-height: 0; z-index: 1200; border-top: none;
      max-width: 100vw; overflow-x: hidden;
    }
    .listings-panel.open { height: 100% !important; min-height: 100% !important; }
    .listings-panel-resize { display: none; }
    .listings-panel-close {
      font-size: 24px; min-width: 44px; min-height: 44px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Hide desktop table, show mobile cards */
    .listings-table-wrap { display: none; }
    .mobile-cards {
      display: block; padding: 10px 6px; overflow-y: auto; overflow-x: hidden;
      height: calc(100% - 45px); -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }

    /* Mobile card styling */
    .mobile-card {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 10px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.15s;
      min-width: 0; overflow: hidden; max-width: 100%;
    }
    .mobile-card:active { border-color: var(--accent); }
    .mobile-card .card-addr {
      font-weight: 600; font-size: 13px; margin-bottom: 8px; line-height: 1.3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .mobile-card .card-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px; font-size: 12px;
      min-width: 0;
    }
    .mobile-card .card-row {
      display: flex; justify-content: space-between; gap: 4px; min-width: 0;
    }
    .mobile-card .card-label { color: var(--text-dim); font-size: 11px; }
    .mobile-card .card-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .mobile-card .card-margin-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border);
    }
    .mobile-card .card-margin {
      font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700;
    }
    .mobile-card .card-profit {
      font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600;
    }

    /* Font scaling */
    .section-title { font-size: 11px; }
    .stat-card .stat-value { font-size: 18px; }
  }

  /* Desktop: hide mobile-only elements */
  @media (min-width: 769px) {
    .sheet-handle { display: none; }
    .mobile-filter-btn { display: none !important; }
    .mobile-cards { display: none !important; }
  }

  /* ‚îÄ‚îÄ BTR Opportunity Layer ‚îÄ‚îÄ */
  @keyframes btr-pulse {
    0% {
      transform: rotate(45deg) scale(1);
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.5);
    }
    50% {
      transform: rotate(45deg) scale(1.15);
      box-shadow: 0 0 12px 4px rgba(245, 158, 11, 0.25);
    }
    100% {
      transform: rotate(45deg) scale(1);
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
    }
  }

  .btr-pin {
    width: 12px;
    height: 12px;
    background: rgba(245, 158, 11, 0.85);
    border: 1.5px dashed #d97706;
    transform: rotate(45deg);
    animation: btr-pulse 2.5s ease-in-out infinite;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btr-pin:hover {
    animation: none;
    transform: rotate(45deg) scale(1.4);
    box-shadow: 0 0 16px 6px rgba(245, 158, 11, 0.4);
    background: rgba(245, 158, 11, 1);
  }

  /* BTR Tooltip Styles */
  .btr-tooltip {
    background: #1a1d27 !important;
    border: 1px solid #f59e0b !important;
    border-radius: 8px !important;
    color: #e4e6ed !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 12px !important;
    padding: 10px 14px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4) !important;
    max-width: 280px !important;
  }

  .btr-tooltip .leaflet-tooltip-top::before {
    border-top-color: #f59e0b !important;
  }

  .btr-tooltip .tooltip-header {
    color: #f59e0b;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .btr-tooltip .tooltip-addr {
    font-weight: 500;
    margin-bottom: 8px;
  }

  .btr-tooltip .tooltip-row {
    display: flex;
    justify-content: space-between;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 2px 0;
  }

  .btr-tooltip .tooltip-row .label {
    color: #8b8fa3;
  }

  .btr-tooltip .gap-negative {
    color: #f87171;
  }

  /* ‚îÄ‚îÄ Deal Assumptions Modal ‚îÄ‚îÄ */
  .modal-overlay{
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.7);z-index:2000;display:none;
    align-items:center;justify-content:center;
  }
  .modal-overlay.active{display:flex}
  .modal-panel{
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    width:90%;max-width:500px;max-height:80vh;overflow-y:auto;
    box-shadow:0 8px 32px rgba(0,0,0,0.5);
  }
  .modal-header{
    padding:16px 20px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;
  }
  .modal-header h3{font-size:15px;font-weight:700;letter-spacing:-0.01em}
  .modal-close{
    background:none;border:none;color:var(--text-dim);cursor:pointer;
    font-size:24px;padding:0;width:28px;height:28px;border-radius:4px;
    transition:all 0.15s;display:flex;align-items:center;justify-content:center;
  }
  .modal-close:hover{color:var(--text);background:var(--surface2)}
  .modal-body{padding:20px}
  .data-key-panel{max-width:640px}
  .data-key-section{margin-bottom:16px}
  .data-key-section h4{font-size:12px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin:0 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
  .data-key-item{margin-bottom:10px}
  .data-key-item dt{font-weight:700;font-size:12px;color:var(--text);margin-bottom:2px}
  .data-key-item dd{margin:0;font-size:11px;color:var(--text-dim);line-height:1.5}
  .gear-icon{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:28px;border-radius:6px;cursor:pointer;
    color:var(--text-dim);transition:all 0.15s;margin-left:4px;
    background:var(--surface2);border:1px solid var(--border);
  }
  .gear-icon:hover{color:var(--text);background:var(--surface);border-color:var(--accent)}

  /* ‚îÄ‚îÄ Polygon Draw Control ‚îÄ‚îÄ */
  .draw-control{position:absolute;top:90px;right:10px;z-index:1000;display:flex;flex-direction:column;gap:4px}
  .draw-btn,.draw-clear-btn{
    width:34px;height:34px;border-radius:4px;border:2px solid rgba(0,0,0,0.2);
    background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;
    font-size:16px;color:#333;box-shadow:0 1px 5px rgba(0,0,0,0.15);transition:all 0.15s;
  }
  .draw-btn:hover,.draw-clear-btn:hover{background:#f4f4f4}
  .draw-btn.active{border-color:#2563eb;background:#eff6ff;color:#2563eb}
  .draw-clear-btn{font-size:12px;font-weight:700;color:#ef4444;display:none}
  .draw-clear-btn.visible{display:flex}
  .leaflet-container.draw-mode{cursor:crosshair !important}
  .leaflet-container.draw-mode .leaflet-marker-icon,.leaflet-container.draw-mode .leaflet-interactive{cursor:crosshair !important}
  /* Polygon edit vertex handles */
  .leaflet-editing-icon{
    width:10px !important;height:10px !important;margin-left:-5px !important;margin-top:-5px !important;
    background:#2563eb;border:2px solid #fff;border-radius:50%;cursor:grab;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }
  .leaflet-editing-icon:hover{background:#1d4ed8;transform:scale(1.3)}
  .leaflet-editing-icon:active{cursor:grabbing}
  /* Midpoint (ghost) handles ‚Äî smaller, translucent */
  .leaflet-edit-resize,.leaflet-marker-icon.leaflet-editing-icon[style*="opacity"]{
    opacity:0.5 !important;width:8px !important;height:8px !important;
    margin-left:-4px !important;margin-top:-4px !important;
  }
</style>
</head>
<body class="light-mode">

<div class="app-row">
<aside class="sidebar" role="complementary" aria-label="Filters and controls">
  <div class="sheet-handle" id="sheetHandle">
    <div class="handle-bar"></div>
    <div class="peek-stats">
      <div class="peek-stat"><span class="peek-value" id="peekEligible">0</span> eligible</div>
      <div class="peek-stat"><span class="peek-value" id="peekMargin">0%</span> avg margin</div>
    </div>
  </div>
  <div class="sidebar-header">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h1><span>SB 1123</span> Deal Finder</h1>
      <a href="analytics.html" class="analytics-btn" id="analyticsLink" title="Market Analytics Dashboard">&#9632; Analytics</a>
      <a href="" class="analytics-btn" id="marketSwitchLink" title="Switch market"></a>
      <button class="refresh-btn" onclick="copyRefreshCmd()" title="Copy refresh command to clipboard" aria-label="Copy refresh command">&#8635; Refresh</button>
    </div>
    <p id="marketSubtitle">Townhome development sites in Los Angeles</p>
    <div class="law-ref">California SB 1123 ‚Äî by-right subdivision, no city approval required</div>
    <div class="law-ref" id="dataFreshness" style="margin-top:2px"></div>
    <div class="stat-pills" id="statPills" aria-live="polite">
      <span class="pill"><span class="pill-val" id="pillOnMarket">0</span><span class="pill-label">on-mkt</span></span>
      <span class="pill"><span class="pill-val" id="pillComps">0</span><span class="pill-label">comps</span></span>
      <span class="pill"><span class="pill-val" id="pillMinMargin">30%</span><span class="pill-label">min margin</span></span>
    </div>
  </div>

  <div class="loading-banner" id="loadingBanner">Rendering data...</div>

  <div class="sidebar-scroll">

  <!-- Hidden elements kept for JS compatibility -->
  <span id="compCount" style="display:none">0</span>
  <span id="heatCount" style="display:none">0</span>
  <div id="heatmapModeToggle" style="display:none"><button class="basemap-btn active" id="heatRaw"></button><button class="basemap-btn" id="heatNorm"></button><div id="heatmapModeLabel"></div></div>
  <span id="filterCount" style="display:none"></span>

  <!-- ‚ïê‚ïê‚ïê LAYERS ‚ïê‚ïê‚ïê -->
  <div class="accordion-section" id="layersAccordion">
    <div class="accordion-header" onclick="this.parentElement.classList.toggle('collapsed')">
      <span class="label">Layers</span>
      <div class="acc-right">
        <span class="acc-dim" id="layersActiveCount"></span>
        <span class="chevron">‚ñº</span>
      </div>
    </div>
    <div class="accordion-body">
      <!-- Primary layers -->
      <button class="layer-row active" data-layer="listings" onclick="toggleLayerRow('listings',this)">
        <span class="ldot" style="background:#22c55e"></span>
        <span class="lname">On-Market</span>
        <span class="lcount" id="listingCount">0</span>
      </button>
      <button class="layer-row" data-layer="neighborhoods" onclick="toggleLayerRow('neighborhoods',this)">
        <span class="ldot"></span>
        <span class="lname">Sale $/SF</span>
        <span class="lcount" id="neighborhoodCount">0</span>
      </button>

      <!-- Secondary layers: Off-Market / BTR grid -->
      <div class="layer-grid" style="margin-top:4px">
        <button class="layer-cell" data-layer="offMarket" onclick="toggleLayerRow('offMarket',this)">
          <span class="ldot"></span>
          <span class="lname">Off-Market</span>
          <span class="lcount" id="offMarketCount">0</span>
        </button>
        <button class="layer-cell" data-layer="btr" onclick="toggleLayerRow('btr',this)">
          <span class="ldot"></span>
          <span class="lname">BTR</span>
          <span class="lcount" id="btrCount">0</span>
        </button>
      </div>

      <!-- Overlay chips -->
      <div class="overlay-chips">
        <button class="chip-btn active" data-layer="parcels" onclick="toggleLayerRow('parcels',this)">Parcels</button>
        <button class="chip-btn" data-layer="fireZones" onclick="toggleLayerRow('fireZones',this)">üî• Fire</button>
        <button class="chip-btn" data-layer="floodZones" onclick="toggleLayerRow('floodZones',this)">üåä Flood</button>
        <button class="chip-btn" data-layer="liquefaction" onclick="toggleLayerRow('liquefaction',this)">üèî Quake</button>
      </div>

      <!-- Zoning -->
      <div class="zoning-bar" id="zoningBar">
        <span class="zone-sw"></span>
        <span class="zone-name" id="zoningBarName">R1</span>
        <span class="zone-psf" id="zoningBarPsf"></span>
        <button class="zone-expand" id="zoningExpandBtn" onclick="document.getElementById('zoneTogglesWrap').style.display=this.textContent.indexOf('+')>=0?'block':'none';this.textContent=this.textContent.indexOf('+')>=0?'‚àí zones':'+ zones'">+ zones</button>
      </div>
      <div id="zoneTogglesWrap" style="display:none;margin-top:6px">
        <div id="zoneToggles" role="group" aria-label="Zone filters"></div>
      </div>

      <!-- Condition Tier (shown when comp layer active) -->
      <div id="tierFilterSection" style="display:none;margin-top:8px">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:#475569;margin-bottom:6px;font-weight:700">Condition Tier</div>
        <label class="zone-toggle" style="margin:0 0 2px">
          <input type="checkbox" checked onchange="tierState.t1=this.checked;updateCompPoints()">
          <span class="check-box"></span>
          <span class="zone-swatch" style="background:#14b8a6"></span>
          <span class="zone-label">T1 ‚Äî New / Remodel</span>
          <span class="zone-stat" id="tierT1Count">0</span>
        </label>
        <label class="zone-toggle" style="margin:0">
          <input type="checkbox" checked onchange="tierState.t2=this.checked;updateCompPoints()">
          <span class="check-box"></span>
          <span class="zone-swatch" style="background:#64748b"></span>
          <span class="zone-label">T2 ‚Äî Existing / As-Is</span>
          <span class="zone-stat" id="tierT2Count">0</span>
        </label>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê -->
  <div class="accordion-section" id="filtersAccordion">
    <div class="accordion-header" onclick="var t=event.target;if(t.classList.contains('acc-reset'))return;this.parentElement.classList.toggle('collapsed')">
      <span class="label">Filters</span>
      <div class="acc-right">
        <span class="acc-reset" onclick="event.stopPropagation();resetFilter('all')">reset</span>
        <span class="chevron">‚ñº</span>
      </div>
    </div>
    <div class="accordion-body" style="padding:10px 14px">

      <!-- Margin -->
      <div class="kf-block">
        <div class="kf-header">
          <span class="kf-label">Margin</span>
          <div class="kf-chips">
            <button class="kf-chip active" onclick="setMarginPreset(30,this)">30%+</button>
            <button class="kf-chip" onclick="setMarginPreset(20,this)">20%+</button>
            <button class="kf-chip" onclick="setMarginPreset(0,this)">0%+</button>
          </div>
        </div>
        <!-- Hidden inputs for JS compat -->
        <input type="number" id="marginMin" step="5" style="display:none">
        <input type="number" id="marginMax" step="5" style="display:none">
        <div class="kf-range-labels">
          <span id="marginRangeMin">30%</span>
          <span id="marginRangeMax">85%</span>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="marginSliderFill"></div>
          <input type="range" id="marginSliderMin" min="-100" max="100" step="5" value="30">
          <input type="range" id="marginSliderMax" min="-100" max="100" step="5" value="85">
        </div>
      </div>

      <!-- Lot Size -->
      <div class="kf-block">
        <div class="kf-header"><span class="kf-label">Lot Size</span></div>
        <div class="kf-range-labels">
          <span id="lotRangeMin">12K sf</span>
          <span id="lotRangeMax">65K sf</span>
        </div>
        <!-- Hidden inputs for JS compat -->
        <input type="number" id="lotMin" step="500" style="display:none">
        <input type="number" id="lotMax" step="500" style="display:none">
        <div class="range-slider-track">
          <div class="range-slider-fill" id="lotSliderFill"></div>
          <input type="range" id="lotSliderMin" min="0" max="65000" step="500" value="12000">
          <input type="range" id="lotSliderMax" min="0" max="65000" step="500" value="65000">
        </div>
      </div>

      <!-- Min Units -->
      <div class="kf-block">
        <div class="kf-header">
          <span class="kf-label">Min Units</span>
          <span id="minUnitsLabel" style="margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:11px;color:#94a3b8">4</span>
        </div>
        <input type="range" class="standalone-slider" id="minUnitsSlider" min="2" max="10" step="1" value="4" oninput="onMinUnitsChange(this.value)">
      </div>

      <!-- Secondary filters -->
      <div class="sf-list">
        <div class="sf-row" tabindex="0" role="button" onclick="this.classList.toggle('expanded')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.classList.toggle('expanded')}">Asking Price <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min</div><input type="number" id="priceMin" step="25000"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max</div><input type="number" id="priceMax" step="25000"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="priceSliderFill"></div>
            <input type="range" id="priceSliderMin" min="0" max="5000000" step="25000" value="0">
            <input type="range" id="priceSliderMax" min="0" max="5000000" step="25000" value="3000000">
          </div>
        </div>

        <div class="sf-row" tabindex="0" role="button" onclick="this.classList.toggle('expanded')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.classList.toggle('expanded')}">$/SF <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min</div><input type="number" id="psfMin" step="50"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max</div><input type="number" id="psfMax" step="50"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="psfSliderFill"></div>
            <input type="range" id="psfSliderMin" min="0" max="2000" step="25" value="0">
            <input type="range" id="psfSliderMax" min="0" max="2000" step="25" value="2000">
          </div>
        </div>

        <!-- Home Size filter inputs hidden for JS compat -->
        <input type="number" id="sqftMin" step="100" style="display:none">
        <input type="number" id="sqftMax" step="100" style="display:none">
        <div style="display:none"><div id="sqftSliderFill"></div><input type="range" id="sqftSliderMin" min="0" max="7000" step="100" value="0"><input type="range" id="sqftSliderMax" min="0" max="7000" step="100" value="7000"></div>

        <div class="sf-row" tabindex="0" role="button" onclick="this.classList.toggle('expanded')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.classList.toggle('expanded')}">Lot Width <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min</div><input type="number" id="lotwMin" step="5"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max</div><input type="number" id="lotwMax" step="5"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="lotwSliderFill"></div>
            <input type="range" id="lotwSliderMin" min="0" max="200" step="5" value="0">
            <input type="range" id="lotwSliderMax" min="0" max="200" step="5" value="200">
          </div>
        </div>

        <div class="sf-row" tabindex="0" role="button" onclick="this.classList.toggle('expanded')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.classList.toggle('expanded')}">Slope <span class="sf-chevron">‚ñ∏</span></div>
        <div class="sf-body">
          <div class="range-inputs">
            <div class="input-group"><div class="input-label">Min %</div><input type="number" id="slopeMin" step="1"></div>
            <span class="separator">‚Äî</span>
            <div class="input-group"><div class="input-label">Max %</div><input type="number" id="slopeMax" step="1"></div>
          </div>
          <div class="range-slider-track">
            <div class="range-slider-fill" id="slopeSliderFill"></div>
            <input type="range" id="slopeSliderMin" min="0" max="100" step="1" value="0">
            <input type="range" id="slopeSliderMax" min="0" max="100" step="1" value="100">
          </div>
        </div>
      </div>

      <!-- Hide Burn Zones -->
      <div style="display:flex;align-items:center;gap:6px;margin-top:10px" id="burnZoneSection">
        <label class="zone-toggle" style="margin:0;padding:0">
          <input type="checkbox" id="hideBurnZones" checked onchange="toggleBurnZoneFilter(this.checked)">
          <span class="check-box" style="width:14px;height:14px"></span>
          <span style="font-size:11px;color:var(--red)" id="burnZoneLabel">Hide Burn Zones</span>
        </label>
      </div>

    </div>
  </div>

  </div><!-- /sidebar-scroll -->

  <!-- ‚ïê‚ïê‚ïê STICKY BOTTOM BAR ‚ïê‚ïê‚ïê -->
  <div class="sidebar-bottom">
    <div class="bottom-row">
      <button class="bottom-btn" id="favToggle" onclick="toggleFavoritesFilter()">
        <span>&#9733; Saved</span><span class="fav-count" id="favCount" style="font-family:'JetBrains Mono',monospace;color:#facc15;font-size:10px">0</span>
      </button>
      <button class="bottom-btn" onclick="exportCSV()" aria-label="Export to CSV">&#128202; Export</button>
      <button class="bottom-btn gear" onclick="openAssumptionsModal()" title="Deal Assumptions" aria-label="Deal assumptions">&#9881;</button>
    </div>
    <div class="basemap-row">
      <button class="basemap-link active" data-base="light" onclick="setBaseMap('light')">Light</button>
      <span class="basemap-dot">&middot;</span>
      <button class="basemap-link" data-base="satellite" onclick="setBaseMap('satellite')">Satellite</button>
    </div>
  </div>
</aside>

<button class="mobile-filter-btn" id="mobileFilterBtn" onclick="openMobileSheet()">
  <span class="filter-icon">&#9776;</span> Filters
</button>

<div id="onboardOverlay" class="onboard-overlay" role="dialog" aria-modal="true" aria-label="Welcome walkthrough">
  <div class="onboard-backdrop" onclick="dismissOnboarding()"></div>
  <div class="onboard-card">
    <div class="onboard-step active" data-step="0">
      <div class="onboard-title">Welcome to SB 1123 Deal Finder</div>
      <div class="onboard-body">
        Each pin is a lot for sale. Size = lot area. Color = exit $/SF from <span class="key" style="background:#dbeafe;color:#2563eb">low</span> to <span class="key" style="background:#fee2e2;color:#dc2626">high</span>.<br>
        <span class="key" style="background:#dcfce7;color:#16a34a">Green border</span> = new listing. <span class="key" style="background:#fff7ed;color:#f97316">Orange border</span> = for-sale.
      </div>
    </div>
    <div class="onboard-step" data-step="1">
      <div class="onboard-title">Click a Pin to See the Deal</div>
      <div class="onboard-body">
        The deal card strip shows key metrics at a glance:<br>
        <strong>List Price</strong> &middot; <strong>Exit $/SF</strong> &middot; <strong>Lot Size</strong> &middot; <strong>Units</strong><br>
        <span style="color:var(--green)">Green price</span> = 30%+ margin. <span style="color:#facc15">Yellow</span> = 20-30%. <span style="color:#9ca3af">Gray</span> = below target.
      </div>
    </div>
    <div class="onboard-step" data-step="2">
      <div class="onboard-title">Expand for Full Economics</div>
      <div class="onboard-body">
        Click the strip to expand three columns: <strong>Economics</strong>, <strong>Site</strong>, and <strong>Pro Forma</strong>.<br>
        <strong>Max Offer</strong> = highest price where you still make your target margin (default 30%).<br>
        Use the <strong>gear icon</strong> in the sidebar to adjust assumptions.
      </div>
    </div>
    <div class="onboard-footer">
      <div class="onboard-dots" id="onboardDots"><span class="active"></span><span></span><span></span></div>
      <div class="onboard-btns">
        <button class="onboard-skip" onclick="dismissOnboarding()">Skip</button>
        <button class="onboard-next" id="onboardNext" onclick="advanceOnboarding()">Next</button>
      </div>
    </div>
  </div>
</div>
<div id="map" role="main" aria-label="Map">
  <!-- Pin Color Legend (bottom-left of map, always visible, dynamic) -->
  <div class="pin-legend" id="pinLegend">
    <!-- Dynamically populated based on active layers -->
  </div>
</div>

<div class="map-legend">
  <div class="legend-section">Comps (Market Data)</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r1)"></div> R1 Single Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r2)"></div> R2 Two Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r3)"></div> R3 Multi-Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r4)"></div> R4 High Density</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--land)"></div> Vacant Land</div>
  <div class="legend-section" style="margin-top:8px">Listings (Exit $/SF)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#6366f1;border-radius:50%"></div> &lt;$650/SF</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3b82f6;border-radius:50%"></div> $650‚Äì700</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22d3ee;border-radius:50%"></div> $700‚Äì750</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22c55e;border-radius:50%"></div> $750‚Äì800</div>
  <div class="legend-item"><div class="legend-dot" style="background:#eab308;border-radius:50%"></div> $800‚Äì900</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f97316;border-radius:50%"></div> $900+</div>
</div>
</div><!-- /app-row -->

<!-- Deal Assumptions Modal -->
<div class="modal-overlay" id="assumptionsModal" role="dialog" aria-modal="true" aria-labelledby="assumptionsTitle" onclick="if(event.target===this) closeAssumptionsModal()">
  <div class="modal-panel">
    <div class="modal-header">
      <h3 id="assumptionsTitle">Deal Assumptions</h3>
      <button class="modal-close" onclick="closeAssumptionsModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="proforma-inputs">
        <div class="proforma-group">
          <label>All-In Build $/SF</label>
          <input type="number" id="pfBuildCost" value="450" step="25" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Unit SF (avg)</label>
          <input type="number" id="pfUnitSize" value="1750" step="50" onchange="onProformaChange()">
        </div>
        <!-- allInBuildPsf ($450) is truly all-in: hard + soft + demo + subdivision + A&E -->
        <div class="proforma-group">
          <label>Txn Costs %</label>
          <input type="number" id="pfTxnCost" value="4.7" step="0.5" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Fixed Disp $</label>
          <input type="number" id="pfFixedDisp" value="40000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Demo Cost $</label>
          <input type="number" id="pfDemoCost" value="55000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Hold Months</label>
          <input type="number" id="pfHoldMonths" value="24" step="3" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Carry Rate %</label>
          <input type="number" id="pfCarryRate" value="9" step="0.5" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Insurance $</label>
          <input type="number" id="pfInsurance" value="40000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Origination %</label>
          <input type="number" id="pfOrigination" value="1" step="0.25" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Ellis $/Unit</label>
          <input type="number" id="pfEllisPerUnit" value="20000" step="5000" onchange="onProformaChange()">
        </div>
      </div>
      <p style="font-size:10px;color:var(--text-dim);margin-top:12px;line-height:1.4">
        SB 1123 ground-up: demolish existing, build all new townhome units.
        Max avg unit size: 1,200 SF (R1). Guaranteed FAR: 1.0x (3-7 units) / 1.25x (8-10).
      </p>
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
        <h4 style="margin:0 0 8px;font-size:12px;color:var(--accent)">Build-to-Rent Assumptions</h4>
        <div class="proforma-inputs">
          <div class="proforma-group">
            <label>OpEx Ratio</label>
            <input type="number" id="btrOpex" value="0.30" step="0.05" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Cap Rate</label>
            <input type="number" id="btrCapRate" value="0.055" step="0.005" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Refi LTV</label>
            <input type="number" id="btrLTV" value="0.70" step="0.05" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Refi Rate</label>
            <input type="number" id="btrRate" value="0.0625" step="0.0025" onchange="onProformaChange()">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Key Modal -->
<div class="modal-overlay" id="dataKeyModal" role="dialog" aria-modal="true" aria-labelledby="dataKeyTitle" onclick="if(event.target===this) closeDataKeyModal()">
  <div class="modal-panel data-key-panel">
    <div class="modal-header">
      <h3 id="dataKeyTitle">Data Key</h3>
      <button class="modal-close" onclick="closeDataKeyModal()">&times;</button>
    </div>
    <div class="modal-body">

      <div class="data-key-section">
        <h4>Deal Metrics (Top Row)</h4>
        <dl class="data-key-item"><dt>Price</dt><dd>Listing price from MLS. For off-market, enter your own estimate.</dd></dl>
        <dl class="data-key-item"><dt>Units</dt><dd>Number of SB 1123 townhome units the lot can support. R1/LAND: floor(lotSF &divide; 1,200), cap 10. R2&ndash;R4: floor(lotSF &divide; 600), cap 10. Layout constraints (setbacks, driveway) may reduce this further.</dd></dl>
        <dl class="data-key-item"><dt>Lot SF</dt><dd>Total lot area in square feet. Primary source is MLS listing data; falls back to county parcel data if MLS is missing. Source shown as &ldquo;mls&rdquo; or &ldquo;parcel.&rdquo;</dd></dl>
        <dl class="data-key-item"><dt>Exit $/SF</dt><dd>Estimated sale price per square foot for finished townhomes. Prefers new-construction comps within 1 mile; falls back to zone-matched resale comps with expanding search radius (0.25mi &rarr; 4mi). Color indicates comp type: <span style="color:#4ecdc4">teal = new-con</span>, <span style="color:#ffe66d">gold = zone comps</span>.</dd></dl>
        <dl class="data-key-item"><dt>Spread</dt><dd>Exit $/SF minus hard construction cost (default $350/SF). Higher spread = more margin for profit.</dd></dl>
        <dl class="data-key-item"><dt>Net Margin</dt><dd>Estimated profit &divide; gross revenue. Green (&ge;20%) = strong, yellow (10&ndash;20%) = marginal, red (&lt;10%) = risky.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Comp Quality</h4>
        <dl class="data-key-item"><dt>Comp Confidence</dt><dd>Score from 0&ndash;100 rating reliability of the exit $/SF estimate. Based on: number of comps found, distance from subject, recency, and whether new-construction comps are available. Shown as a colored bar in the deal card.</dd></dl>
        <dl class="data-key-item"><dt>Comp Type</dt><dd><b>New-con (subdiv)</b>: Recent new-construction sales &mdash; most reliable for SB 1123 product. <b>Zone comps</b>: Resale comps matched by zoning type (R1 with R1, etc.) &mdash; used when no new-con available.</dd></dl>
        <dl class="data-key-item"><dt>Comp Count &amp; Radius</dt><dd>Number of comparable sales found and the search radius used. More comps at shorter radius = higher confidence.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Unit Count &amp; Layout</h4>
        <dl class="data-key-item"><dt>Lot Dimensions</dt><dd>Width &times; Depth estimated from parcel geometry. &ldquo;Irregular&rdquo; flag appears when effective rectangle area differs &gt;15% from actual lot area (pie-shaped, flag lots, etc.).</dd></dl>
        <dl class="data-key-item"><dt>Layout Constraint</dt><dd>Unit count may be reduced by physical fit: buildable width = lot width minus 20&rsquo; driveway minus 4&rsquo; far-side setback. Driveway is flush to property line and encroaches into the setback on its side. Use the Layout Planner tool to experiment with driveway placement.</dd></dl>
        <dl class="data-key-item"><dt>FAR (Floor Area Ratio)</dt><dd>Maximum buildable SF &divide; lot SF. SB 1123 allows: 1.25 FAR for 8&ndash;10 units, 1.0 for 3&ndash;7 units, 0.5 for &lt;3 units. Buildable SF = min(units &times; avg unit size, lot &times; FAR).</dd></dl>
        <dl class="data-key-item"><dt>Density Cap</dt><dd>SB 1123 caps at 10 units per lot regardless of lot size. R1/LAND uses 1,200 SF/unit divisor; R2&ndash;R4 uses 600 SF/unit.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Financial Model</h4>
        <dl class="data-key-item"><dt>Buildable SF</dt><dd>Total square footage of finished product. = units &times; avg unit size (default 1,200 SF), capped by FAR limit.</dd></dl>
        <dl class="data-key-item"><dt>Gross Revenue</dt><dd>Buildable SF &times; Exit $/SF. What you&rsquo;d gross if you sold all units.</dd></dl>
        <dl class="data-key-item"><dt>Sale Discount</dt><dd>5% reduction from gross revenue to account for broker commissions, concessions, and closing costs.</dd></dl>
        <dl class="data-key-item"><dt>Net Revenue</dt><dd>Gross revenue minus sale discount.</dd></dl>
        <dl class="data-key-item"><dt>Hard Costs</dt><dd>Construction cost = buildable SF &times; $350/SF (default). Covers structure, MEP, finishes.</dd></dl>
        <dl class="data-key-item"><dt>Soft Costs</dt><dd>25% of hard costs (default). Covers architecture, engineering, permits, insurance, legal, financing.</dd></dl>
        <dl class="data-key-item"><dt>Demo Cost</dt><dd>$25,000 flat (default) for demolition of existing structures.</dd></dl>
        <dl class="data-key-item"><dt>Total Development Cost</dt><dd>Hard + soft + demo + land acquisition (asking price).</dd></dl>
        <dl class="data-key-item"><dt>Est. Profit</dt><dd>Net revenue minus total development cost.</dd></dl>
        <dl class="data-key-item"><dt>Buy/Unit</dt><dd>Asking price &divide; number of units. Lower = more land efficiency.</dd></dl>
        <dl class="data-key-item"><dt>Land Basis</dt><dd>Asking price &divide; buildable SF. What you&rsquo;re paying per SF of finished product for the land alone.</dd></dl>
        <dl class="data-key-item"><dt>Max Offer</dt><dd>Maximum land price that still achieves the target margin (default 20%). Calculated as: net revenue &minus; construction costs &minus; target profit.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Build-to-Rent (BTR)</h4>
        <dl class="data-key-item"><dt>Monthly Rent</dt><dd>Estimated market rent per unit from HUD Small Area Fair Market Rents (SAFMR) for the property&rsquo;s ZIP code, sized to unit bedroom count.</dd></dl>
        <dl class="data-key-item"><dt>Gross Annual Income</dt><dd>Monthly rent &times; units &times; 12 months.</dd></dl>
        <dl class="data-key-item"><dt>NOI (Net Operating Income)</dt><dd>Gross income minus operating expenses (default 35% of gross: property management, maintenance, insurance, taxes, vacancy).</dd></dl>
        <dl class="data-key-item"><dt>Yield on Cost (YOC)</dt><dd>NOI &divide; total development cost. The unlevered return on your all-in investment. Target: &ge;5.5%. Shown as pass/fail badge.</dd></dl>
        <dl class="data-key-item"><dt>Cap Rate Valuation</dt><dd>NOI &divide; market cap rate (default 5%). Estimates what the completed, stabilized property would sell for as a rental asset.</dd></dl>
        <dl class="data-key-item"><dt>Refi Loan (70% LTV)</dt><dd>70% of the cap rate valuation. Estimates how much permanent debt you could place after stabilization.</dd></dl>
        <dl class="data-key-item"><dt>Equity Remaining</dt><dd>Total development cost minus refi loan. The cash you&rsquo;d still have tied up after refinancing.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Due Diligence Flags</h4>
        <dl class="data-key-item"><dt>Fire Zone (VHFHSZ)</dt><dd>Very High Fire Hazard Severity Zone. SB 1123 projects are <b>not eligible</b> in VHFHSZ areas. These listings are flagged but still shown for awareness.</dd></dl>
        <dl class="data-key-item"><dt>Slope</dt><dd>Average ground slope percentage from USGS LiDAR elevation data. Steeper slopes increase grading costs and may require retaining walls. &gt;15% is flagged as challenging.</dd></dl>
        <dl class="data-key-item"><dt>Tenant Risk</dt><dd>Risk level (0&ndash;3) for existing tenant displacement issues. Factors: occupied/improved property, 3+ bedrooms, 5+ bedrooms, multi-family structures, pre-2000 construction, RSO (rent stabilization) overlay. Higher risk = more relocation costs and legal complexity.</dd></dl>
        <dl class="data-key-item"><dt>HOA</dt><dd>Existing HOA may restrict or prevent SB 1123 development. R1 properties with HOA are flagged as potentially ineligible.</dd></dl>
        <dl class="data-key-item"><dt>Lot Source</dt><dd>Where lot size data comes from: &ldquo;MLS&rdquo; (listing agent, more reliable) or &ldquo;Parcel&rdquo; (county GIS, may match wrong parcel on irregular lots).</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Deal Margin Colors</h4>
        <dl class="data-key-item"><dt style="color:#4ecdc4">Green (Net Margin &ge; 20%)</dt><dd>Strong deal &mdash; meets or exceeds target profit margin.</dd></dl>
        <dl class="data-key-item"><dt style="color:#ffe66d">Yellow (Net Margin 10&ndash;20%)</dt><dd>Marginal deal &mdash; profit exists but thin. Sensitive to cost overruns or market softening.</dd></dl>
        <dl class="data-key-item"><dt style="color:#ff6b6b">Red (Net Margin &lt; 10%)</dt><dd>Risky deal &mdash; little to no profit cushion. Likely not viable at asking price.</dd></dl>
      </div>

    </div>
  </div>
</div>

<!-- Listings Panel Tab (visible when panel is closed) -->
<div class="listings-panel-tab" id="listingsPanelTab" onclick="toggleListingsPanel()">
  <span class="tab-arrow">&#9650;</span> Deal Pipeline <span class="tab-count" id="tabPanelCount">0</span>
</div>

<!-- Listings Panel -->
<div class="listings-panel" id="listingsPanel">
  <div class="listings-panel-resize" id="panelResize"></div>
  <div class="listings-panel-header">
    <h2><span>Deal Pipeline</span></h2>
    <span class="listings-panel-count" id="tablePanelCount">0</span>
    <button class="listings-panel-close" onclick="toggleListingsPanel()">x</button>
  </div>
  <div class="listings-table-wrap" id="tableWrap">
    <table class="listings-table">
      <thead>
        <tr>
          <th class="col-fav" data-sort="fav" onclick="sortTable('fav')"><span style="font-size:12px">&#9733;</span> <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-addr" data-sort="address" onclick="sortTable('address')">Address <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-zone" data-sort="zone" onclick="sortTable('zone')">Zone <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-price" data-sort="price" onclick="sortTable('price')">Price <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-lot" data-sort="lotSf" onclick="sortTable('lotSf')">Lot Size <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-lotw" data-sort="lw" onclick="sortTable('lw')">Lot W <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-units" data-sort="maxUnits" onclick="sortTable('maxUnits')">Units <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-hood" data-sort="exitPsf" onclick="sortTable('exitPsf')">Exit $/SF <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-sale" data-sort="salePerUnit" onclick="sortTable('salePerUnit')">Revenue/Unit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-ppu" data-sort="pricePerUnit" onclick="sortTable('pricePerUnit')">Cost/Unit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-profit" data-sort="estProfit" onclick="sortTable('estProfit')">Profit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-margin" data-sort="estMargin" onclick="sortTable('estMargin')">Margin <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-slope" data-sort="slope" onclick="sortTable('slope')">Slope <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-dom" data-sort="dom" onclick="sortTable('dom')">Days Listed <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-new" data-sort="isNew" onclick="sortTable('isNew')">New <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-link">Link</th>
        </tr>
      </thead>
      <tbody id="listingsTableBody"></tbody>
    </table>
  </div>
  <div class="mobile-cards" id="mobileCards"></div>
</div>

<script type="module">
// ‚îÄ‚îÄ Module imports ‚îÄ‚îÄ
import { fmtDollar, fmtShort, commas } from './js/format.js';
import { proforma, clearProformaCaches, getMinLotPerUnit, getMaxUnits, getSlopeAdjBuildCost, calculateProForma, calculateBTRProForma } from './js/proforma.js';
import { initExport, exportCSV, exportModel, exportOM } from './js/export.js';
import { initDraw, initDrawControl, toggleDrawMode, clearDrawPolygon, isInsideDrawPolygon, getDrawPolygonGeoJSON, applyPolygonOpacity } from './js/draw.js';
import { initComps, distMi, findCompsForListing, showCompsTable, sortCompsTable, hideCompsTable, buildRentalCompGrid, findRentalCompsForListing, showRentalCompsTable, sortRentalCompsTable, hideRentalCompsTable, isCompsTableActive, isRentalCompsTableActive } from './js/comps.js';

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
const ZONE_COLORS = {R1:'#2563eb',R2:'#16a34a',R3:'#ea580c',R4:'#9333ea',LAND:'#b45309'};
const ZONE_LABELS = {R1:'Single Family',R2:'Two Family',R3:'Multi-Family',R4:'High Density',LAND:'Vacant Land'};
// Exit $/SF color scale: cool (cheap) ‚Üí hot (expensive)
// RECENTERED for SFV: $600-$1,000 decision range
function exitPsfColor(ppsf){
  if(!ppsf || ppsf <= 0) return '#888';
  if(ppsf < 650) return '#6366f1';   // Indigo ‚Äî weak exit market
  if(ppsf < 700) return '#3b82f6';   // Blue ‚Äî below target
  if(ppsf < 750) return '#22d3ee';   // Teal ‚Äî break-even zone
  if(ppsf < 800) return '#22c55e';   // Green ‚Äî healthy margin
  if(ppsf < 900) return '#eab308';   // Amber ‚Äî strong exit
  return '#f97316';                   // Orange ‚Äî premium market
}

function getPinBorder(ppsf){
  if(!ppsf || ppsf <= 0) return '#666';
  if(ppsf < 600) return '#2563eb';   // Darker blue border
  if(ppsf < 700) return '#06b6d4';   // Darker cyan border
  if(ppsf < 800) return '#16a34a';   // Darker green border
  if(ppsf < 900) return '#ca8a04';   // Darker yellow border
  if(ppsf < 1000) return '#ea580c';  // Darker orange border
  return '#dc2626';                   // Darker red border
}

// ‚îÄ‚îÄ AppState: event-emitting state container ‚îÄ‚îÄ
var AppState = (function(){
  var _s = {}, _l = {};
  return {
    get: function(k){ return _s[k]; },
    set: function(k, v){ _s[k] = v; (_l[k]||[]).forEach(function(f){f(v);}); (_l['*']||[]).forEach(function(f){f(k,v);}); },
    on: function(k, fn){ (_l[k] = _l[k]||[]).push(fn); },
    getAll: function(){ return Object.assign({}, _s); },
  };
})();

// Persist soft filters across page reloads
var _PERSIST_KEYS = ['favoritesOnly','newThisWeekFilter','hideBurnZones','minUnitsFilter'];
AppState.on('*', function(k, v){
  if(_PERSIST_KEYS.indexOf(k) >= 0) localStorage.setItem('sb1123_'+k, JSON.stringify(v));
});

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let COMPS = [];
let LISTINGS = [];
let RENTAL_COMPS = [];
let rentalCompGrid = null;
const markerLayers = {R1:L.layerGroup(),R2:L.layerGroup(),R3:L.layerGroup(),R4:L.layerGroup(),LAND:L.layerGroup()};
const listingsLayer = L.layerGroup();
const btrLayer = L.layerGroup();  // BTR opportunity layer
const offMarketLayer = L.layerGroup();  // Priority 4: Off-market targets
const neighborhoodLayer = L.layerGroup();  // Sale $/SF grid overlay
const layerState = {markers:false,compHeat:false,neighborhoods:false,listings:true,offMarket:false,btr:false,fireZones:false,floodZones:false,liquefaction:false,parcels:true};

// ‚îÄ‚îÄ Polygon Draw State ‚îÄ‚îÄ
// Draw state ‚Äî see js/draw.js
const zoneState = {R1:true,R2:true,R3:true,R4:true,LAND:true};
let sb1123Mode = true;  // Default ON ‚Äî we only care about 1123 deals

const filters = {
  price:{ min:0, max:3000000, dataMin:0, dataMax:5000000, step:25000, cap:5000000, defaultMin:null, defaultMax:3000000 },
  psf:  { min:0, max:3000, dataMin:0, dataMax:3000, step:25, cap:null, defaultMin:600, defaultMax:3000 },
  sqft: { min:0, max:7000, dataMin:0, dataMax:7000, step:100, cap:7000, defaultMin:null, defaultMax:null },
  lot:  { min:0, max:65000, dataMin:0, dataMax:65000, step:500, cap:65000, defaultMin:12000, defaultMax:null },
  lotw: { min:0, max:200, dataMin:0, dataMax:200, step:5, cap:200, defaultMin:null, defaultMax:null },
  slope:{ min:0, max:100, dataMin:0, dataMax:100, step:1, cap:100, defaultMin:null, defaultMax:10 },
  margin:{ min:-100, max:100, dataMin:-100, dataMax:100, step:5, cap:null, defaultMin:30, defaultMax:85 },
};

let currentSort = { key:null, dir:'desc' };
let listingsPanelOpen = false;
// Comp table state ‚Äî see js/comps.js

// Soft filters ‚Äî restore from localStorage via AppState
let favoritesOnly = false;
let newThisWeekFilter = false;
let hideBurnZones = true;
let minUnitsFilter = 4;  // Default: require at least 4 units

// Initialize AppState with soft filter defaults, then restore persisted values
AppState.set('favoritesOnly', false);
AppState.set('newThisWeekFilter', false);
AppState.set('hideBurnZones', true);
AppState.set('minUnitsFilter', 4);
_PERSIST_KEYS.forEach(function(k){
  var s = localStorage.getItem('sb1123_'+k);
  if(s != null){ try{ AppState.set(k, JSON.parse(s)); }catch(e){} }
});
// Sync globals from restored state
favoritesOnly = AppState.get('favoritesOnly');
newThisWeekFilter = AppState.get('newThisWeekFilter');
hideBurnZones = AppState.get('hideBurnZones');
minUnitsFilter = AppState.get('minUnitsFilter');

// Keep globals in sync when AppState changes
AppState.on('favoritesOnly', function(v){ favoritesOnly = v; });
AppState.on('newThisWeekFilter', function(v){ newThisWeekFilter = v; });
AppState.on('hideBurnZones', function(v){ hideBurnZones = v; });
AppState.on('minUnitsFilter', function(v){ minUnitsFilter = v; });
function onMinUnitsChange(val){ AppState.set('minUnitsFilter', parseInt(val)); document.getElementById('minUnitsLabel').textContent = val; applyFilters(); }
function resetMinUnits(){ AppState.set('minUnitsFilter', 4); document.getElementById('minUnitsSlider').value = 4; document.getElementById('minUnitsLabel').textContent = '4'; applyFilters(); }

const tierState = { t1: true, t2: true };
let heatmapMode = 'raw';

// ‚îÄ‚îÄ Favorites (localStorage) ‚îÄ‚îÄ
const FAV_KEY = 'sb1123_favorites';
function loadFavorites(){ try{return JSON.parse(localStorage.getItem(FAV_KEY))||{}}catch(e){return{}} }
function saveFavorites(f){ localStorage.setItem(FAV_KEY, JSON.stringify(f)); }
function listingKey(l){ return l.lat+','+l.lng; }
function isFavorite(l){ return !!loadFavorites()[listingKey(l)]; }
function toggleFavorite(lat,lng){
  const key=lat+','+lng, favs=loadFavorites();
  if(favs[key]) delete favs[key]; else favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  saveFavorites(favs); updateFavCount();
  // Only rebuild markers when in favorites-only mode (un-star removes pin).
  // Otherwise skip applyFilters() to keep the popup open.
  if(favoritesOnly) applyFilters();
}
function saveFavNote(lat,lng,text){
  const key=lat+','+lng, favs=loadFavorites();
  if(!favs[key]) favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  favs[key].notes=text; saveFavorites(favs);
}
function getFavNote(lat,lng){ const f=loadFavorites()[lat+','+lng]; return f?f.notes||'':''; }
function updateFavCount(){
  const n=Object.keys(loadFavorites()).length;
  document.getElementById('favCount').textContent=n;
  const btn = document.getElementById('favToggle');
  btn.disabled = n === 0;
  if(n === 0 && favoritesOnly){
    favoritesOnly = false;
    btn.classList.remove('active');
    applyFilters();
  }
}
function copyRefreshCmd(){
  const cmd=MARKET.slug==='la'?'./refresh.sh':'./refresh.sh --market '+MARKET.slug;
  navigator.clipboard.writeText(cmd).then(()=>{
    const btn=document.querySelector('.refresh-btn');
    btn.textContent='Copied!';
    btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';
    setTimeout(()=>{btn.innerHTML='&#8635; Refresh';btn.style.borderColor='';btn.style.color='';},2000);
  }).catch(()=>{
    prompt('Run this in your terminal to refresh data:',cmd);
  });
}
function sharePin(lat,lng,event){
  var params=MARKET.slug!=='la'?'?market='+MARKET.slug+'&pin='+lat+','+lng:'?pin='+lat+','+lng;
  const url=window.location.origin+window.location.pathname+params;
  navigator.clipboard.writeText(url).then(()=>{
    const btn=event.target;
    const orig=btn.innerHTML;
    btn.innerHTML='Link Copied!';
    btn.style.background='var(--green)';
    setTimeout(()=>{btn.innerHTML=orig;btn.style.background='';},2000);
  }).catch(()=>{
    prompt('Share this link:',url);
  });
}
function toggleFavoritesFilter(){
  // Guard: check actual count, not just btn.disabled (inline onclick can fire on some browsers)
  if(Object.keys(loadFavorites()).length === 0) return;
  const btn = document.getElementById('favToggle');
  AppState.set('favoritesOnly', !favoritesOnly);
  if(favoritesOnly){
    btn.classList.add('active');
  } else {
    btn.classList.remove('active');
  }
  applyFilters();
}
function toggleBurnZoneFilter(checked){
  AppState.set('hideBurnZones', checked);
  applyFilters();
}

// Pro forma defaults + caches ‚Äî see js/proforma.js

// ‚îÄ‚îÄ Map ‚îÄ‚îÄ
const map = L.map('map',{center:MARKET.center,zoom:MARKET.zoom,zoomControl:false});
L.control.zoom({position:'topright'}).addTo(map);

// Custom panes so heatmap renders below listings
map.createPane('heatmapPane').style.zIndex = 350;
map.createPane('compDotsPane').style.zIndex = 360;
const listingsPane = map.createPane('listingsPane');
listingsPane.style.zIndex = 450;
// Note: avoid CSS filter on pane ‚Äî causes compositing bugs when swapping tile layers

// Base tile layers
const baseLayers = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'Esri World Imagery',maxZoom:19
  })
};
let activeBase = 'light';
baseLayers.light.addTo(map);

function setBaseMap(name){
  map.removeLayer(baseLayers[activeBase]);
  activeBase = name;
  baseLayers[name].addTo(map);
  // Update button states
  document.querySelectorAll('.basemap-btn,.basemap-link').forEach(b=>{
    b.classList.toggle('active', b.dataset.base===name);
  });
  // Toggle body class for light mode adjustments
  document.body.classList.toggle('light-mode', name==='light' || name==='satellite');
  // Re-assert overlay layers after basemap swap
  refreshVisibility();
}

Object.values(markerLayers).forEach(l=>l.addTo(map));

// Overlay layers (server-rendered from LA County / FEMA / CGS ArcGIS)
let fireZoneLayer = null;
let parcelLayer = null;
let floodZoneLayer = null;
let liquefactionLayer = null;
let compHeatLayer = null;
let compCanvasRenderer = null;
let compPointsLayer = L.layerGroup();
let compLabelsLayer = L.layerGroup();
let compSpatialGrid = {};  // grid for fast viewport queries

// Build spatial grid for comps (0.005¬∞ cells ‚âà 500m)
function buildCompGrid(comps){
  const grid = {};
  const S = 0.005;
  comps.forEach(c=>{
    if(!c.ppsf || c.ppsf <= 0) return;
    const key = Math.floor(c.lat/S)+','+Math.floor(c.lng/S);
    if(!grid[key]) grid[key]=[];
    grid[key].push(c);
  });
  return grid;
}

// Query comps in a bounding box from grid
function queryCompGrid(bounds){
  const S = 0.005;
  const s=bounds.getSouth(), n=bounds.getNorth(), w=bounds.getWest(), e=bounds.getEast();
  const rMin=Math.floor(s/S), rMax=Math.floor(n/S);
  const cMin=Math.floor(w/S), cMax=Math.floor(e/S);
  const result=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=compSpatialGrid[r+','+c];
      if(cell) result.push(...cell);
    }
  }
  return result;
}

// Render comp points + labels for current viewport
function updateCompPoints(){
  compPointsLayer.clearLayers();
  compLabelsLayer.clearLayers();
  if(!layerState.compHeat) return;
  const zoom = map.getZoom();
  if(zoom < 13) return;

  const bounds = map.getBounds();
  const visible = queryCompGrid(bounds);
  const showLabels = zoom >= 15;
  // Cap markers to prevent browser freeze at mid-zoom with wide viewport
  const cap = showLabels ? 2000 : 5000;

  // Filter by tier
  const tierFiltered = visible.filter(c =>
    (tierState.t1 && c.t === 1) || (tierState.t2 && c.t === 2) || (!c.t)
  );
  const toRender = tierFiltered.length > cap ? tierFiltered.slice(0, cap) : tierFiltered;

  // Update tier counts
  const t1El = document.getElementById('tierT1Count');
  const t2El = document.getElementById('tierT2Count');
  if(t1El) t1El.textContent = tierFiltered.filter(c => c.t === 1).length;
  if(t2El) t2El.textContent = tierFiltered.filter(c => c.t === 2).length;

  toRender.forEach(c=>{
    const color = exitPsfColor(c.ppsf);
    const r = zoom >= 16 ? 6 : zoom >= 14 ? 4 : 3;
    const isT1 = c.t === 1;
    const cm = L.circleMarker([c.lat,c.lng],{
      radius:r, color: isT1 ? '#14b8a6' : 'rgba(255,255,255,0.3)', fillColor:color,
      fillOpacity:0.85, weight: isT1 ? 2 : 0.8, renderer:compCanvasRenderer,
      pane:'compDotsPane'
    });
    cm.bindPopup(`<div style="font-size:12px"><b>${c.address||'Sold Comp'}</b> <span style="display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;margin-left:4px;background:${isT1?'rgba(20,184,166,0.15)':'rgba(100,116,139,0.15)'};color:${isT1?'#14b8a6':'#64748b'}">${isT1?'T1 New/Remodel':'T2 Existing'}</span><br>
      <span style="font-family:monospace;font-size:14px;color:${color}">$${c.ppsf}/SF</span><br>
      $${c.price.toLocaleString()} ¬∑ ${c.sqft.toLocaleString()} sf${c.zone?' ¬∑ '+c.zone:''}${c.date?' ¬∑ '+c.date:''}${c.yb?' ¬∑ Built '+c.yb:''}</div>`,{maxWidth:280});
    compPointsLayer.addLayer(cm);

    if(showLabels){
      const label = L.marker([c.lat,c.lng],{
        icon: L.divIcon({
          className:'comp-psf-label',
          html:'$'+c.ppsf,
          iconSize:[40,14],
          iconAnchor:[20,-6]
        }),
        interactive:false
      });
      compLabelsLayer.addLayer(label);
    }
  });
}
if(L.esri){
  try {
    // Fire zone + flood zone overlays (market-specific hazards service)
    if(MARKET.hazardsUrl){
      fireZoneLayer = L.esri.dynamicMapLayer({
        url:MARKET.hazardsUrl, layers:[2], opacity:0.4
      });
      floodZoneLayer = L.esri.dynamicMapLayer({
        url:MARKET.hazardsUrl, layers:[11,12], opacity:0.4
      });
    }
    // CGS Liquefaction zones (CA state service ‚Äî works for all markets)
    liquefactionLayer = L.esri.dynamicMapLayer({
      url:'https://services.gis.ca.gov/arcgis/rest/services/GeoscientificInformation/Liquefaction/MapServer',
      layers:[0,3],
      opacity:0.4
    });
    // Parcel boundaries (market-specific)
    if(MARKET.parcelUrl){
      parcelLayer = L.esri.tiledMapLayer({
        url:MARKET.parcelUrl, opacity:0.6, maxZoom:20, minZoom:15
      });
    }
  } catch(e) {
    console.warn('esri-leaflet layers failed:', e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SB 1123 ELIGIBILITY + PRO FORMA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// SB 1123 eligibility: R1-R4 + LAND zones, lot 10K+ SF
// Exclude condos/townhouses ‚Äî on shared/HOA land, can't subdivide
// Exclude R1 with HOA ‚Äî indicates shared land/CC&Rs that block subdivision
// Exclude VHFHSZ ‚Äî hard exclusion under SB 1123
function isSB1123Eligible(l){
  const validZone = ['R1','R2','R3','R4','LAND'].includes(l.zone);
  const notCondoTownhouse = !['Condo/Co-op','Townhouse'].includes(l.type);
  const notR1Hoa = !(l.zone === 'R1' && l.hoa > 0);
  const notHighHoa = !(l.hoa && l.hoa >= 1000);  // High HOA = shared land/CC&Rs
  const notFireZone = !l.fireZone;
  const minLot = ['R1','LAND'].includes(l.zone) ? 2400 : 1200;  // 2 units min: R1=2√ó1200, MF=2√ó600
  const validLot = l.lotSf && l.lotSf >= minLot;
  const maxLotSf = ['R1','LAND'].includes(l.zone) ? 65340 : 217800;
  const underAcreageCap = !l.lotSf || l.lotSf <= maxLotSf;
  const inUrbanArea = l.urbanArea !== false;  // true or undefined (not yet checked) = OK
  return validZone && notCondoTownhouse && notR1Hoa && notHighHoa && notFireZone && validLot && underAcreageCap && inUrbanArea;
}

// getMinLotPerUnit, getMaxUnits, getSlopeAdjBuildCost ‚Äî see js/proforma.js

// Comp confidence indicator: how reliable is the exit $/SF?
function compConfidence(l){
  // Determine active comp source + count
  let count = 0, method = '', radius = 0;
  if(l.subdivExitPsf){
    count = l.subdivCompCount || 0;
    method = 'subdiv';
    radius = l.subdivCompRadius || 0;
  } else if(l.newconPpsf){
    count = l.newconCount || 0;
    method = l.newconFlag === 'cross-zone' ? 'newcon-xz' : 'newcon';
    // newcon doesn't store radius, estimate from tier
  } else if(l.exitPsf){
    count = l.compCount || 0;
    method = l.compMethod || 'none';
    radius = l.compRadius || 0;
  } else {
    return {score: 0, label: 'No Data', color: '#ef4444', icon: '&#9711;', bar: 0};
  }

  // Score: 0-100 based on comp count + method quality
  let score = 0;

  // Count contribution (0-60 pts): 3=15, 5=25, 10=40, 20=50, 30+=60
  if(count >= 30) score += 60;
  else if(count >= 20) score += 50;
  else if(count >= 10) score += 40;
  else if(count >= 5) score += 25;
  else if(count >= 3) score += 15;
  else score += count * 3;

  // Method quality (0-40 pts)
  if(method === 'subdiv') score += 40;        // Best: actual subdivision sales
  else if(method === 'newcon') score += 35;    // Great: zone-matched new construction
  else if(method === 'newcon-xz') score += 25; // Good: cross-zone new construction
  else if(method === 'zone') score += 30;      // Good: zone-matched all sales
  else if(method === 'all') score += 20;       // OK: all-zone
  else if(method === 'zone-thin') score += 15; // Weak: thin zone-matched
  else if(method === 'all-thin') score += 10;  // Weak: thin all-zone
  else if(method.includes('zip')) score += 8;  // Poor: zip fallback
  else score += 5;

  // Flags: penalize
  if(l.newconFlag === 'sanity-high') score -= 10;
  if(l.compMethod && l.compMethod.includes('thin')) score -= 10;

  score = Math.max(0, Math.min(100, score));

  // Map to label + color
  let label, color, icon;
  if(score >= 75){ label = 'High'; color = '#22c55e'; icon = '&#9679;&#9679;&#9679;'; }
  else if(score >= 50){ label = 'Medium'; color = '#f59e0b'; icon = '&#9679;&#9679;&#9675;'; }
  else if(score >= 25){ label = 'Low'; color = '#f97316'; icon = '&#9679;&#9675;&#9675;'; }
  else { label = 'Very Low'; color = '#ef4444'; icon = '&#9675;&#9675;&#9675;'; }

  return {score, label, color, icon, bar: Math.round(score), count, method, radius};
}

// ‚îÄ‚îÄ Deal Scorecard (hero metrics banner) ‚îÄ‚îÄ
function dealScorecard(l, pf, btr){
  const exitPsf = exitLabel(l).psf;
  const allInPsf = pf.effective_buildable_sf>0 ? Math.round(pf.totalCost/pf.effective_buildable_sf) : 0;
  const spread = exitPsf - allInPsf;
  const spreadColor = spread>=100?'var(--green)':spread>=0?'var(--yellow)':'var(--red)';
  const marginColor = pf.margin>=30?'var(--green)':pf.margin>=15?'var(--yellow)':'var(--red)';
  const moColor = pf.max_offer>=l.price?'var(--green)':'var(--red)';
  const moVal = pf.max_offer>=1000000?'$'+(pf.max_offer/1000000).toFixed(1)+'M':'$'+Math.round(pf.max_offer/1000).toLocaleString()+'k';
  return '<div class="popup-scorecard">'
    +'<div><div class="sc-label">SPREAD</div><div class="sc-value" style="color:'+spreadColor+'">$'+spread+'/sf</div></div>'
    +'<div><div class="sc-label">NET MARGIN</div><div class="sc-value" style="color:'+marginColor+'">'+pf.margin.toFixed(1)+'%</div></div>'
    +'<div><div class="sc-label">MAX OFFER</div><div class="sc-value" style="color:'+moColor+'">'+moVal+'</div></div>'
    +'<div><div class="sc-label">UNITS</div><div class="sc-value">'+pf.maxUnits+'</div></div>'
    +'</div>';
}

// ‚îÄ‚îÄ Action links bar ‚îÄ‚îÄ
function actionLinksBar(l){
  return '<div class="popup-links">'
    +'<a href="https://www.google.com/maps?q='+l.lat+','+l.lng+'&t=k&z=19" target="_blank">Maps &#8599;</a>'
    +(l.url?'<a href="'+l.url+'" target="_blank">Redfin &#8599;</a>':'')
    +(MARKET.hasZimas?'<a href="'+getZimasUrl(l)+'" target="_blank" style="color:var(--yellow)">ZIMAS &#8599;</a>':'')
    +(l.lw&&l.ld?'<a href="'+lotPlannerUrl(l)+'" target="_blank">Planner &#8599;</a>':'')
    +'</div>';
}

// ‚îÄ‚îÄ Condensed Due Diligence ‚îÄ‚îÄ
function dueDiligenceBlock(l){
  var failures = [];
  if(l.burnZone) failures.push('<span style="color:var(--red)">&#10007;</span> &#128293; BURN ZONE');
  else if(l.fireZone) failures.push('<span style="color:var(--red)">&#10007;</span> VHFHSZ fire zone');
  if(l.rsoRisk) failures.push('<span style="color:var(--red)">&#10007;</span> RSO rent-controlled (Ellis Act)');
  var sb = slopeBadge(l);
  if(sb && sb.includes('&#10007;')) failures.push(sb.replace(/^ ‚Ä¢ /,''));

  var h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">Due Diligence</div>';
  if(failures.length === 0){
    h += '<div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">'
      +'<span style="color:var(--green)">&#10003;</span> All checks passed &nbsp;&bull;&nbsp; '
      +'<span style="color:var(--yellow)">&#9733;</span> TPA = 0 parking'
      +(sb?sb:'')
      +'</div>';
  } else {
    h += '<div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">'
      +failures.join(' &bull; ')
      +' &bull; <span style="color:var(--yellow)">&#9733;</span> TPA = 0 parking'
      +'</div>';
  }
  if(l.rsoRisk&&l.zone!=='R1'&&l.zone!=='LAND'){
    h += '<div class="popup-span-2" style="font-size:10px;color:#dc2626;line-height:1.4">&#9888; RSO: Budget ~$20K/unit relocation + 120-day Ellis Act notice</div>';
  }
  return h;
}

// ‚îÄ‚îÄ Collapsible Economics (cost breakdown) ‚îÄ‚îÄ
function economicsBlock(pf, opts){
  opts = opts || {};
  var collapseId = 'econ-'+Math.random().toString(36).slice(2,8);
  var h = '<div class="popup-section-label">'+(opts.label||'Economics')+'</div>';
  // Always visible: Build $/SF + Hard/Soft/Total Build
  h += '<div><div class="popup-label">Build $/SF'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' <span style="color:var(--orange)">(slope)</span>':'')+'</div><div class="popup-value"'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':'')+'>$'+pf.adjBuildCostPerSf+'/sf</div></div>';
  h += '<div><div class="popup-label">Hard Costs</div><div class="popup-value">$'+pf.hardCosts.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Soft Costs</div><div class="popup-value">$'+pf.softCosts.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Total Build</div><div class="popup-value">$'+Math.round(pf.constructionCost).toLocaleString()+'</div></div>';
  // Collapsible: financing/carry items
  var carryTotal = pf.carryInterest + pf.carryPropTax + pf.insurance + pf.originationFee;
  h += '<div class="popup-span-2"><div class="popup-collapse-toggle" onclick="var b=document.getElementById(\''+collapseId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> Financing &mdash; $'+Math.round(carryTotal).toLocaleString()+' carry</div>';
  h += '<div class="popup-collapse-body" id="'+collapseId+'" style="display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;padding-top:4px">';
  h += '<div><div class="popup-label">Insurance</div><div class="popup-value">$'+pf.insurance.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Origination ('+proforma.originationPct+'%)</div><div class="popup-value">$'+pf.originationFee.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Carry Interest ('+proforma.holdMonths+'mo)</div><div class="popup-value">$'+pf.carryInterest.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Prop Tax ('+proforma.holdMonths+'mo)</div><div class="popup-value">$'+pf.carryPropTax.toLocaleString()+'</div></div>';
  h += '</div></div>';
  return h;
}

// ‚îÄ‚îÄ BTR section (collapsible when not viable) ‚îÄ‚îÄ
function btrConfidenceDot(conf){
  if(conf==='validated') return '<span style="color:#22c55e" title="Validated (5+ comps)">\u25cf</span>';
  if(conf==='estimated') return '<span style="color:#eab308" title="Estimated (<5 comps)">\u25d0</span>';
  if(conf==='manual') return '<span style="color:#3b82f6" title="Manual neighborhood data">\u25cf</span>';
  return '<span style="color:#64748b" title="Default (no local data)">\u25cb</span>';
}

function btrBlock(l, btr){
  var hasRent = btr.rentPsf > 0;
  if(!hasRent){
    return '<div class="popup-divider"></div>'
      +'<div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>'
      +'<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(100,116,139,0.1);color:#94a3b8;font-size:11px">&#9888;&#65039; No rent data</div>';
  }
  var collapseId = 'btr-'+Math.random().toString(36).slice(2,8);
  var viable = btr.btrPencils;
  var h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>';

  // Three-scenario table (from pre-computed pipeline data)
  var hasScenarios = l.rentBase > 0 && l.yocBase > 0;
  var btrContent = '';
  if(hasScenarios){
    var conf = l.confidence || 'default';
    var pf_str = l.premiumFactor ? l.premiumFactor.toFixed(2)+'x' : 'N/A';
    btrContent += '<div class="popup-span-2" style="margin:4px 0 2px">';
    btrContent += '<table style="width:100%;font-size:11px;font-family:\'JetBrains Mono\',monospace;border-collapse:collapse">';
    btrContent += '<tr style="color:#8b8fa3;font-size:10px"><td></td><td style="text-align:right">$/mo</td><td style="text-align:right">YoC</td></tr>';
    // Conservative
    btrContent += '<tr><td style="color:#8b8fa3;padding:1px 0">Conservative</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentConservative.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocConservative>=0.04?'var(--green)':l.yocConservative>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocConservative||0)*100).toFixed(1)+'%</td></tr>';
    // Base
    btrContent += '<tr style="font-weight:600"><td style="padding:1px 0">Base Case '+btrConfidenceDot(conf)+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentBase.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocBase>=0.04?'var(--green)':l.yocBase>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocBase||0)*100).toFixed(1)+'%</td></tr>';
    // Aggressive
    btrContent += '<tr><td style="color:#8b8fa3;padding:1px 0">Aggressive</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentAggressive.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocAggressive>=0.04?'var(--green)':l.yocAggressive>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocAggressive||0)*100).toFixed(1)+'%</td></tr>';
    btrContent += '</table></div>';
    // Data source footer
    btrContent += '<div class="popup-span-2" style="font-size:10px;color:#64748b;padding:2px 0;display:flex;gap:8px;flex-wrap:wrap">';
    if(l.safmr3br) btrContent += '<span>SAFMR: $'+l.safmr3br.toLocaleString()+'</span>';
    if(l.zoriBase) btrContent += '<span>ZORI: $'+l.zoriBase.toLocaleString()+'</span>';
    if(l.premiumFactor) btrContent += '<span>Premium: '+pf_str+'</span>';
    btrContent += '<span>'+btrConfidenceDot(conf)+' '+conf+'</span>';
    btrContent += '</div>';
  }

  // Existing BTR metrics (from calculateBTRProForma)
  btrContent += '<div><div class="popup-label">Rent Source</div><div class="popup-value">'+getRentSourceLabel(l)+'</div></div>';
  if(RENTAL_COMPS.length > 0 && l.rentMethod && l.rentMethod.startsWith('rental-comp')){
    btrContent += '<div class="popup-span-2" style="font-size:10px;line-height:1.4"><a href="#" onclick="showRentalCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">'+l.rentCompCount+' rental comps within '+l.rentCompRadius+'mi &#8599;</a></div>';
  }
  btrContent += '<div><div class="popup-label">Est. Rent/Unit</div><div class="popup-value">$'+btr.rentPerUnit.toLocaleString()+'/mo <small style="color:var(--text-dim)">($'+btr.rentPsf.toFixed(2)+'/SF √ó '+proforma.avgUnitSf.toLocaleString()+' SF)</small></div></div>';
  btrContent += '<div><div class="popup-label">NOI</div><div class="popup-value">$'+Math.round(btr.annualNOI).toLocaleString()+'</div></div>';
  btrContent += '<div><div class="popup-label">YOC</div><div class="popup-value" style="color:'+(btr.yieldOnCost>=0.04?'var(--green)':btr.yieldOnCost>=0.03?'var(--yellow)':'var(--red)')+'">'+(btr.yieldOnCost*100).toFixed(1)+'%</div></div>';
  btrContent += '<div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:'+(btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)')+'">$'+(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')+'M</div></div>';
  btrContent += '<div><div class="popup-label">Cap Rate</div><div class="popup-value">'+(btr.capRate*100).toFixed(1)+'%</div></div>';
  if(viable){
    btrContent += '<div><div class="popup-label">DSCR</div><div class="popup-value" style="color:'+(btr.dscr>=1.25?'var(--green)':btr.dscr>=1.15?'var(--yellow)':'var(--red)')+'">'+btr.dscr.toFixed(2)+'x</div></div>';
    btrContent += '<div><div class="popup-label">Cash Flow</div><div class="popup-value" style="color:'+(btr.cashFlow>=0?'var(--green)':'var(--red)')+'">$'+Math.round(btr.cashFlow).toLocaleString()+'/yr</div></div>';
  }
  if(viable){
    // Expanded by default when viable
    h += btrContent;
  } else {
    // Collapsed with summary line when not viable
    var summaryYoc = (btr.yieldOnCost*100).toFixed(1);
    var summaryStab = '$'+(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')+'M';
    h += '<div class="popup-span-2"><div class="popup-collapse-toggle" onclick="var b=document.getElementById(\''+collapseId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> BTR: '+summaryYoc+'% YOC &middot; Stab '+summaryStab+'</div>';
    h += '<div class="popup-collapse-body" id="'+collapseId+'" style="display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;padding-top:4px">';
    h += btrContent;
    h += '</div></div>';
  }
  return h;
}

// ‚îÄ‚îÄ Pro Forma Block (shared across all 3 pin card templates) ‚îÄ‚îÄ
function proFormaBlock(l, pf, opts){
  opts = opts || {};
  const buyLabel = opts.buyLabel || 'Buy/Unit';
  const buyPerUnit = opts.buyPerUnit != null ? opts.buyPerUnit : pf.pricePerUnit;
  const comparePrice = opts.comparePrice != null ? opts.comparePrice : l.price;
  const cc = compConfidence(l);
  const lbColor = pf.land_basis_psf<120?'var(--green)':pf.land_basis_psf<=160?'var(--yellow)':'var(--red)';
  const moColor = pf.max_offer>=comparePrice?'var(--green)':'var(--red)';
  let h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">PRO FORMA &mdash; <span class="pf-units">'+pf.maxUnits+'</span> UNITS';
  if(l.layoutNote) h += ' <span style="color:var(--orange);font-weight:400">(layout-capped from '+l.densityUnits+')</span>';
  else if(l.slopeAdjUnits) h += ' <span style="color:var(--orange);font-weight:400">(slope-adj ~'+l.slopeAdjUnits+')</span>';
  h += ' &bull; <span class="pf-buildable-sf">'+pf.effective_buildable_sf.toLocaleString()+'</span> SF</div>';
  if(l.layoutNote) h += '<div class="popup-span-2" style="color:var(--orange);font-size:11px">&#9888; '+l.layoutNote+'</div>';
  h += '<div class="popup-span-2" style="font-size:10px;line-height:1.4"><span style="color:'+cc.color+';letter-spacing:2px">'+cc.icon+'</span> <a href="#" onclick="showCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">'+cc.count+' comps'+(cc.radius ? ' within '+cc.radius+'mi' : '')+' &#8599;</a></div>';
  h += '<div class="popup-span-2" style="display:flex;justify-content:space-between;font-size:11px"><span>'+buyLabel+' <b class="pf-buy-per-unit">$'+buyPerUnit.toLocaleString()+'</b></span><span>Total Cost <b class="pf-total-cost">$'+Math.round(pf.totalCost).toLocaleString()+'</b></span></div>';
  h += '<div class="popup-span-2" style="display:flex;justify-content:space-between;font-size:11px"><span>Land Basis <b class="pf-land-basis" style="color:'+lbColor+'">$'+pf.land_basis_psf+'/sf</b></span><span>Buildable SF <b class="pf-buildable-sf2">'+pf.effective_buildable_sf.toLocaleString()+' sf</b></span></div>';
  h += '<div class="popup-span-2 pf-max-offer-row" style="font-size:11px;font-weight:600;color:'+moColor+'">Max Offer @ 30%: <span class="pf-max-offer">$'+pf.max_offer.toLocaleString()+'</span></div>';
  h += remainderAnalysis(l);
  return h;
}

// ‚îÄ‚îÄ View Comps ‚Äî see js/comps.js ‚îÄ‚îÄ
// Build descriptive exit $/SF label for popup display
function exitLabel(l){
  // Prefer calibrated T1 normalized from CLUSTERS
  if(l.clusterT1psf){
    const t1n = l.clusterT1n || 0;
    const fb = l.clusterFb;
    const fbTag = fb === 0 ? 'per-cell' : fb === 1 ? 'blended' : 'median';
    const conf = (l.clusterRw >= 0.8 && t1n >= 8) ? 'high' : (l.clusterRw >= 0.5 && t1n >= 4) ? 'med' : 'low';
    const color = conf === 'high' ? '#22c55e' : conf === 'med' ? 'var(--accent)' : '#f59e0b';
    return {psf: l.clusterT1psf, label: `T1 NORM ‚Äî ${t1n} comps, ${fbTag}, ${conf} conf`, color, short: 'T1 norm'};
  }
  if(l.subdivExitPsf){
    const count = l.subdivCompCount || 0;
    const radius = l.subdivCompRadius || '';
    const appr = l.subdivAvgAppr ? ` (${l.subdivAvgAppr > 0 ? '+' : ''}${l.subdivAvgAppr.toFixed(1)}% adj)` : '';
    return {psf: l.subdivExitPsf, label: `SUBDIV COMP ‚Äî ${count} comps within ${radius}mi${appr}`, color: '#10b981', short: 'subdiv'};
  }
  const exitPsf = l.newconPpsf || l.exitPsf || 0;
  if(!exitPsf) return {psf: 0, label: 'NO COMP DATA', color: 'var(--red)', short: 'no data'};
  if(l.newconPpsf){
    const tier = l.newconTier || '';
    const count = l.newconCount || 0;
    const zm = l.newconZoneMatch !== false ? 'zone-matched' : 'cross-zone';
    const flag = l.newconFlag;
    let label = `NEW-CON ‚Äî ${count} comps, ${tier}, ${zm}`;
    let color = 'var(--accent)';
    if(flag === 'thin'){ label += ' ‚ö†Ô∏è thin'; color = '#f59e0b'; }
    else if(flag === 'cross-zone'){ color = '#f59e0b'; }
    else if(flag === 'sanity-high'){ label += ' ‚ö†Ô∏è high'; color = '#f59e0b'; }
    return {psf: exitPsf, label, color, short: 'new-con'};
  }
  // General P75 fallback
  const count = l.compCount || 0;
  const radius = l.compRadius || '';
  let reason = '';
  if(l.newconFlag === 'sanity-low') reason = ' ‚Äî newcon failed sanity check';
  else if(l.newconFlag === 'sanity-high') reason = ' ‚Äî newcon flagged high';
  const label = `ALL SALES ‚Äî ${count} comps within ${radius}mi${reason}`;
  return {psf: exitPsf, label, color: 'var(--text-dim)', short: 'all sales'};
}

// calculateProForma ‚Äî see js/proforma.js
// sizeEquityAndDebt ‚Äî see js/export.js

// ‚îÄ‚îÄ Layout Planner URL builder ‚îÄ‚îÄ
// ‚îÄ‚îÄ Lot Layout SVG for popup ‚îÄ‚îÄ
function lotLayoutSection(l, pf){
  if(!l.lw || !l.ld || !pf.maxUnits || pf.maxUnits <= 0 || pf.max_offer <= 0) return '';
  var layoutId = 'lot-layout-'+Math.random().toString(36).slice(2,8);
  return '<div class="lot-layout-toggle" onclick="var b=document.getElementById(\''+layoutId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> Lot Layout &middot; '+pf.maxUnits+' units</div>'
    + '<div class="lot-layout-body" id="'+layoutId+'">'+buildLotLayoutSVG(l,pf)+'</div>';
}

function buildLotLayoutSVG(l, pf){
  if(!l.lw || !l.ld) return '';
  var lw = l.lw, ld = l.ld;
  var units = pf.maxUnits || 0;
  var driveW = 20, sideSet = 4, rearSet = 4;
  var frontSet = (l.zone === 'R2' || l.zone === 'R3' || l.zone === 'R4') ? 15 : 20;
  var unitBuildW = lw - driveW - sideSet;
  if(unitBuildW < 20) return '';

  var parcelDepth = 1200 / lw;
  var availDepth = ld - frontSet - rearSet;

  var remDepth = 0;
  if(l.remainderUnits > 0){
    var lotSf = l.lotSf || lw * ld;
    var remSf = lotSf - units * 1200;
    if(remSf > 400) remDepth = Math.min(Math.round(remSf / lw), ld * 0.4);
  }

  var devDepth = availDepth - remDepth;
  if(devDepth < parcelDepth) devDepth = availDepth;
  var maxFit = Math.min(10, Math.floor(devDepth / parcelDepth));
  var placed = Math.min(units, maxFit);

  // SVG viewBox padding for labels
  var padL = 16, padR = 8, padT = 14, padB = 18;
  var totalW = lw + padL + padR;
  var totalH = ld + padT + padB;
  var ox = padL, oy = padT;

  // Compact sizing: scale to fit within 260√ó180px
  var maxPxW = 260, maxPxH = 180;
  var sc = Math.min(maxPxW / totalW, maxPxH / totalH);
  var svgW = Math.round(totalW * sc), svgH = Math.round(totalH * sc);

  // Colors ‚Äî light architectural style
  var cLot = '#fafaf8', cBorder = '#1e3a5f', cSetback = '#e74c3c';
  var cDrive = '#e8e6e1', cDriveBorder = '#c8c5be';
  var cUnit = '#dbeafe', cUnitStroke = '#3b82f6';
  var cYard = '#f0fdf4', cLabel = '#888';
  var cRem = '#fef3c7', cRemStroke = '#d97706';

  var s = '<svg xmlns="http://www.w3.org/2000/svg" width="'+svgW+'" height="'+svgH+'" viewBox="0 0 '+totalW+' '+totalH+'" style="font-family:\'DM Sans\',system-ui,sans-serif">';

  // Lot boundary ‚Äî white fill, thin navy outline
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+lw+'" height="'+ld+'" fill="'+cLot+'" stroke="'+cBorder+'" stroke-width="1"/>';

  // Front setback zone (bottom = front of lot)
  s += '<rect x="'+ox+'" y="'+(oy+ld-frontSet)+'" width="'+lw+'" height="'+frontSet+'" fill="'+cYard+'" opacity="0.6"/>';
  // Rear setback zone (top = rear of lot)
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+lw+'" height="'+rearSet+'" fill="'+cYard+'" opacity="0.4"/>';
  // Far-side setback strip (right edge)
  s += '<rect x="'+(ox+lw-sideSet)+'" y="'+oy+'" width="'+sideSet+'" height="'+ld+'" fill="'+cYard+'" opacity="0.3"/>';

  // Driveway ‚Äî 20' wide, flush to left property line
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+driveW+'" height="'+ld+'" fill="'+cDrive+'" stroke="'+cDriveBorder+'" stroke-width="0.5"/>';
  // 4' setback zone within driveway (subtle dashed line)
  s += '<line x1="'+(ox+sideSet)+'" y1="'+oy+'" x2="'+(ox+sideSet)+'" y2="'+(oy+ld)+'" stroke="'+cSetback+'" stroke-width="0.4" stroke-dasharray="2,3" opacity="0.35"/>';
  // Driveway label (rotated)
  var driveFS = Math.min(6, driveW * 0.25);
  s += '<text x="'+(ox+driveW/2)+'" y="'+(oy+ld/2)+'" text-anchor="middle" dominant-baseline="central" fill="#999" font-size="'+driveFS+'" transform="rotate(-90,'+(ox+driveW/2)+','+(oy+ld/2)+')">20\u2032 DRIVE</text>';

  // Setback lines ‚Äî coral dashed (front + rear)
  var frontY = oy + ld - frontSet;
  s += '<line x1="'+ox+'" y1="'+frontY+'" x2="'+(ox+lw)+'" y2="'+frontY+'" stroke="'+cSetback+'" stroke-width="0.6" stroke-dasharray="3,2" opacity="0.55"/>';
  var rearY = oy + rearSet;
  s += '<line x1="'+ox+'" y1="'+rearY+'" x2="'+(ox+lw)+'" y2="'+rearY+'" stroke="'+cSetback+'" stroke-width="0.6" stroke-dasharray="3,2" opacity="0.55"/>';
  // Far-side setback line
  s += '<line x1="'+(ox+lw-sideSet)+'" y1="'+oy+'" x2="'+(ox+lw-sideSet)+'" y2="'+(oy+ld)+'" stroke="'+cSetback+'" stroke-width="0.4" stroke-dasharray="2,3" opacity="0.35"/>';

  // Remainder parcel at front (just above front setback)
  if(remDepth > 0){
    var remY = oy + ld - frontSet - remDepth;
    s += '<rect x="'+(ox+driveW)+'" y="'+remY+'" width="'+unitBuildW+'" height="'+remDepth+'" fill="'+cRem+'" stroke="'+cRemStroke+'" stroke-width="0.5" stroke-dasharray="2,2" opacity="0.7"/>';
  }

  // Place units ‚Äî compact colored rectangles, no unit number labels
  var unitStartX = ox + driveW;
  var unitStartY = oy + rearSet;
  for(var i = 0; i < placed; i++){
    var uy = unitStartY + i * parcelDepth;
    var uh = Math.max(parcelDepth - 1, 1);
    s += '<rect x="'+unitStartX+'" y="'+uy+'" width="'+unitBuildW+'" height="'+uh+'" fill="'+cUnit+'" stroke="'+cUnitStroke+'" stroke-width="0.8" rx="1"/>';
  }

  // Open space after last unit
  var lastUnitBottom = unitStartY + placed * parcelDepth;
  var yardH = (oy + ld - frontSet - remDepth) - lastUnitBottom;
  if(yardH > 2){
    s += '<rect x="'+(ox+driveW)+'" y="'+lastUnitBottom+'" width="'+unitBuildW+'" height="'+yardH+'" fill="'+cYard+'" opacity="0.5"/>';
  }

  // Dimension labels
  s += '<text x="'+(ox+lw/2)+'" y="'+(oy-4)+'" text-anchor="middle" fill="'+cLabel+'" font-size="6">'+lw+'\u2032</text>';
  s += '<text x="'+(ox-5)+'" y="'+(oy+ld/2)+'" text-anchor="middle" fill="'+cLabel+'" font-size="6" transform="rotate(-90,'+(ox-5)+','+(oy+ld/2)+')">'+ld+'\u2032</text>';
  // Setback dimension labels
  s += '<text x="'+(ox+lw+2)+'" y="'+(oy+rearSet/2+2)+'" fill="'+cSetback+'" font-size="4" opacity="0.6">4\u2032</text>';
  s += '<text x="'+(ox+lw+2)+'" y="'+(frontY+frontSet/2+2)+'" fill="'+cSetback+'" font-size="4" opacity="0.6">'+frontSet+'\u2032</text>';

  // STREET label
  s += '<text x="'+(ox+lw/2)+'" y="'+(oy+ld+11)+'" text-anchor="middle" fill="'+cLabel+'" font-size="5" letter-spacing="2" font-weight="600">STREET</text>';

  // Scale bar ‚Äî bottom-left, 10ft reference
  var sbX = ox + 1, sbY = oy + ld + 13;
  s += '<line x1="'+sbX+'" y1="'+sbY+'" x2="'+(sbX+10)+'" y2="'+sbY+'" stroke="'+cLabel+'" stroke-width="0.7"/>';
  s += '<line x1="'+sbX+'" y1="'+(sbY-1.5)+'" x2="'+sbX+'" y2="'+(sbY+1.5)+'" stroke="'+cLabel+'" stroke-width="0.5"/>';
  s += '<line x1="'+(sbX+10)+'" y1="'+(sbY-1.5)+'" x2="'+(sbX+10)+'" y2="'+(sbY+1.5)+'" stroke="'+cLabel+'" stroke-width="0.5"/>';
  s += '<text x="'+(sbX+5)+'" y="'+(sbY-2)+'" text-anchor="middle" fill="'+cLabel+'" font-size="3.5">10\u2032</text>';

  // North arrow ‚Äî bottom-right
  var naX = ox + lw + padR - 4, naY = oy + ld + 10;
  s += '<line x1="'+naX+'" y1="'+(naY+5)+'" x2="'+naX+'" y2="'+naY+'" stroke="'+cLabel+'" stroke-width="0.7"/>';
  s += '<polygon points="'+(naX-1.5)+','+(naY+2)+' '+naX+','+naY+' '+(naX+1.5)+','+(naY+2)+'" fill="'+cLabel+'"/>';
  s += '<text x="'+naX+'" y="'+(naY-1.5)+'" text-anchor="middle" fill="'+cLabel+'" font-size="3.5" font-weight="700">N</text>';

  s += '</svg>';
  return s;
}

function lotPlannerUrl(l){
  var exitSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var p = 'width='+l.lw+'&depth='+l.ld+'&zone='+(l.zone||'R1')+'&street=S';
  p += '&address='+encodeURIComponent(l.address||'');
  p += '&asking='+(l.price||0);
  p += '&lotSF='+(l.lotSf||0);
  if(exitSF) p += '&exitSF='+exitSF;
  return 'https://mlucido.github.io/lot-planner/?'+p;
}

// Lot size display with source + mismatch warning
function lotLabel(l, effPct){
  if(!l.lotSf) return '';
  const src = l.lotSource === 'parcel' ? 'Parcel' : 'MLS';
  const srcColor = l.lotSfParcel ? 'var(--orange)' : 'var(--text-dim)';
  const mismatch = l.lotSfParcel ? ` <small style="color:var(--orange)">&#9888; Parcel: ${l.lotSfParcel.toLocaleString()}</small>` : '';
  const irregWarn = l.lotShape === 'irreg' ? ' <small style="color:var(--orange)">&#9888; irregular</small>' : '';
  const dims = l.lw && l.ld ? ` <small style="color:var(--text-dim)">${l.lw}'\u00d7${l.ld}'</small>${irregWarn}` : '';
  const eff = effPct != null ? ` <small style="color:${effPct>=85?'var(--green)':effPct>=60?'var(--yellow)':'var(--red)'}">(${effPct}% eff)</small>` : '';
  return `<div><div class="popup-label">Lot Size</div><div class="popup-value">${l.lotSf.toLocaleString()} sf <small style="color:${srcColor}">(${src})</small>${dims}${mismatch}${eff}</div></div>`;
}

// Remainder parcel analysis section for R2-R4
function remainderAnalysis(l){
  if(!l.remainderUnits || l.remainderUnits <= 0) return '';
  const viable = l.remainderViable;
  const color = viable && l.remainderUnits >= 8 ? '#22c55e' : viable && l.remainderUnits >= 4 ? '#eab308' : '#ef4444';
  const icon = viable ? '&#9989;' : '&#10060;';
  return `<div class="popup-span-2" style="font-size:10px;line-height:1.6;padding:4px 8px;border-radius:4px;background:${color}15;color:${color}">
    <b>REMAINDER PARCEL ANALYSIS</b><br>
    Total Lot: ${l.lotSf?l.lotSf.toLocaleString():'?'} SF |
    Footprint: -${(l.estFootprint||0).toLocaleString()} SF |
    Driveway: -${(l.drivewayDeduction||2000).toLocaleString()} SF<br>
    <b>Available: ${l.remainderSf.toLocaleString()} SF &#8594; ${l.remainderUnits} units ${icon}</b>
    ${viable ? ' (keep existing structure, develop remainder)' : ' (insufficient for viable development)'}
  </div>`;
}

// BTR (Build-to-Rent) Pro Forma Calculator
function getRentSourceLabel(l) {
  const m = l.rentMethod;
  const psf = l.rentPsf ? ` ($${l.rentPsf.toFixed(2)}/SF)` : '';
  if (m === 'rental-comp') return `${l.rentCompCount} rental comps within ${l.rentCompRadius} mi${psf}`;
  if (m === 'rental-comp-wide') return `${l.rentCompCount} comps within ${l.rentCompRadius} mi <small>(wide)</small>${psf}`;
  if (m === 'rental-adj') return `${l.rentCompCount} comps within ${l.rentCompRadius} mi <small>(2BR adj +15%)</small>${psf}`;
  if (m === 'census-tract') return `Census tract${psf}`;
  if (m === 'zori') return `ZORI <small>ZIP ${l.zip||'\u2014'}</small>${psf}`;
  return `SAFMR <small>ZIP ${l.zip||'\u2014'}</small>${psf}`;
}

// calculateBTRProForma ‚Äî see js/proforma.js

// Generate ZIMAS lookup URL for LA City properties
function getZimasUrl(l){
  if(l.ain) return 'https://zimas.lacity.org/displayreport.aspx?apn=' + l.ain;
  return 'https://zimas.lacity.org/';
}

// Slope score badge for due diligence sections
function slopeBadge(l){
  if(l.slopeScore == null || l.slopeScore <= 30) return '';
  const detail = 'Elev range: '+l.elevRange+'ft | Max slope: '+l.maxSlope+'% | Flat area: '+l.flatPct+'%';
  if(l.slopeScore >= 76) return ' ‚Ä¢ <span style="color:var(--red)">&#10007; SEVERE SLOPE (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
  if(l.slopeScore >= 51) return ' ‚Ä¢ <span style="color:var(--orange)">&#10007; STEEP TERRAIN (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
  return ' ‚Ä¢ <span style="color:var(--yellow)">&#9888; Moderate slope (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
}

// Enrich listings with computed fields
function enrichListings(){
  LISTINGS.forEach(l => {
    l.sb1123Eligible = isSB1123Eligible(l);
    const pf = calculateProForma(l);
    l.maxUnits = pf.maxUnits;
    if (pf.densityUnits > pf.maxUnits) {
      l.densityUnits = pf.densityUnits;
      l.layoutMax = pf.layoutMax;
      l.layoutNote = pf.layoutNote;
    }
    // Slope-adjusted unit warning (informational only ‚Äî does not override pro forma)
    if (l.flatPct != null && l.flatPct < 100 && l.lotSf) {
      const usableFlatSf = Math.max(0, l.lotSf * (l.flatPct / 100) - 2000);
      const slopeAdjUnits = Math.min(l.maxUnits, Math.max(1, Math.floor(usableFlatSf / 1400)));
      if (slopeAdjUnits < l.maxUnits) l.slopeAdjUnits = slopeAdjUnits;
    }
    l.pricePerUnit = pf.pricePerUnit;
    l.estProfit = pf.profit;
    l.estMargin = pf.margin;
    l.totalCost = pf.totalCost;
    l.netRevenue = pf.netRevenue;
    l.totalBuildCost = pf.totalBuildCost;
    l.salePerUnit = pf.maxUnits > 0 ? Math.round(pf.netRevenue / pf.maxUnits) : 0;
    l.buildPerUnit = pf.maxUnits > 0 ? Math.round(pf.totalBuildCost / pf.maxUnits) : 0;
    l.buildableSf = pf.buildableSf;
    l.maxOffer = pf.max_offer;
    l.landPpsf = l.lotSf ? Math.round(l.price / l.lotSf) : null;
    l.lotEfficiency = pf.lot_efficiency ? Math.round(pf.lot_efficiency * 100) : 0; // Store as percentage
    // NEW listing detection: DOM <= 3 = NEW, DOM <= 7 = new this week
    l.isNew = (l.dom !== null && l.dom !== undefined && l.dom <= 3) ? 1 : 0;
    l.isNewThisWeek = (l.dom !== null && l.dom !== undefined && l.dom <= 7) ? 1 : 0;
    // BTR viability flag for dual-deal detection (DSCR >= 1.25x gate)
    if((l.estRentMonth && l.estRentMonth > 0) || (l.fmr3br && l.fmr3br > 0) || l.yocBase > 0){
      const btrPF = calculateBTRProForma(l);
      l.btrViable = btrPF.btrPencils;
    } else {
      l.btrViable = false;
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getFilteredComps(){
  return COMPS.filter(c =>
    zoneState[c.zone] &&
    c.price >= filters.price.min && c.price <= filters.price.max &&
    (c.ppsf || c.price/c.sqft) >= filters.psf.min &&
    (c.ppsf || c.price/c.sqft) <= filters.psf.max &&
    c.sqft >= filters.sqft.min && c.sqft <= filters.sqft.max
  );
}

// isInsideDrawPolygon ‚Äî see js/draw.js

function getFilteredListings(skipZoneFilter){
  const favs = favoritesOnly ? loadFavorites() : null;
  return LISTINGS.filter(l => {
    if(getDrawPolygonGeoJSON() && !isInsideDrawPolygon(l.lat, l.lng)) return false;
    if(favoritesOnly && !favs[listingKey(l)]) return false;
    if(sb1123Mode && !l.sb1123Eligible) return false;
    if(newThisWeekFilter && !l.isNewThisWeek) return false;
    if(hideBurnZones && l.burnZone) return false;
    if(minUnitsFilter > 1 && (l.maxUnits || 0) < minUnitsFilter) return false;
    const zoneOk = skipZoneFilter || !l.zone || zoneState[l.zone];
    const priceOk = l.price >= filters.price.min && l.price <= filters.price.max;
    const isLand = l.zone === 'LAND';
    const psfOk = isLand || (l.ppsf >= filters.psf.min && l.ppsf <= filters.psf.max);
    const sqftOk = isLand || (l.sqft >= filters.sqft.min && l.sqft <= filters.sqft.max);
    const lotVal = l.lotSf || 0;
    const lotAtDefault = filters.lot.min === filters.lot.dataMin && filters.lot.max === filters.lot.dataMax;
    const lotOk = lotAtDefault ? true : (lotVal >= filters.lot.min && lotVal <= filters.lot.max);
    const lotwVal = l.lw || 0;
    const lotwAtDefault = filters.lotw.min === filters.lotw.dataMin && filters.lotw.max === filters.lotw.dataMax;
    const lotwOk = lotwAtDefault ? true : (lotwVal === 0 ? true : (lotwVal >= filters.lotw.min && lotwVal <= filters.lotw.max));
    const slopeVal = l.slope != null ? l.slope : 0;
    const slopeAtDefault = filters.slope.min === filters.slope.dataMin && filters.slope.max === filters.slope.dataMax;
    const slopeOk = slopeAtDefault ? true : (slopeVal >= filters.slope.min && slopeVal <= filters.slope.max);
    const marginVal = l.estMargin || 0;
    const marginAtDefault = filters.margin.min === filters.margin.dataMin && filters.margin.max === filters.margin.dataMax;
    // When BTR layer is on, don't exclude BTR-viable deals via margin filter
    const marginOk = marginAtDefault ? true : (marginVal >= filters.margin.min && marginVal <= filters.margin.max)
      || (layerState.btr && l.btrViable);
    return zoneOk && priceOk && psfOk && sqftOk && lotOk && lotwOk && slopeOk && marginOk;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function rebuildMarkers(cachedComps){
  Object.values(markerLayers).forEach(l=>l.clearLayers());
  const filtered = cachedComps || getFilteredComps();
  filtered.forEach(comp => {
    const psf = comp.ppsf || Math.round(comp.price / comp.sqft);
    const cm = L.circleMarker([comp.lat,comp.lng],{
      radius:3, color:ZONE_COLORS[comp.zone], fillColor:ZONE_COLORS[comp.zone],
      fillOpacity:0.5, weight:1
    });
    cm.bindPopup(`
      <div class="popup-badge comp">Market Comp</div>
      <div class="popup-title">${comp.address || 'N/A'}</div>
      <div class="popup-grid">
        <div><div class="popup-label">Market Value</div><div class="popup-value">$${comp.price.toLocaleString()}</div></div>
        <div><div class="popup-label">$/SF</div><div class="popup-value" style="color:${ZONE_COLORS[comp.zone]}">$${psf}</div></div>
        <div><div class="popup-label">Size</div><div class="popup-value">${comp.sqft.toLocaleString()} sf</div></div>
        <div><div class="popup-label">Zone</div><div class="popup-value">${comp.zone}</div></div>
        ${comp.zip?`<div><div class="popup-label">Zip</div><div class="popup-value">${comp.zip}</div></div>`:''}
      </div>
      <div style="margin-top:6px;display:flex;gap:8px;justify-content:center">
        <a href="https://www.google.com/maps?q=${comp.lat},${comp.lng}&t=k&z=19" target="_blank" style="color:var(--accent);font-size:11px">Google Maps &#8599;</a>
      </div>
    `,{maxWidth:280});
    cm.addTo(markerLayers[comp.zone]);
  });
  document.getElementById('compCount').textContent = filtered.length.toLocaleString();
  refreshVisibility();
}

function toggleDealCard(el){
  var card = el.closest('.dp-card');
  if(!card) return;
  card.classList.toggle('expanded');
}

// ‚îÄ‚îÄ Format helpers ‚Äî see js/format.js ‚îÄ‚îÄ

function dealCardBadges(l, ctx, isDualViable){
  // Inline badges (zone, BTS/BTR, DEMO ‚Äî shown inside strip)
  var inline = '';
  inline += '<div class="popup-badge" style="background:'+(ZONE_COLORS[l.zone]||'#666')+'22;color:'+(ZONE_COLORS[l.zone]||'#666')+'">'+(l.zone||'?')+'</div>';
  if(ctx==='btr'){
    inline += (l.estMargin||0)<=0
      ? '<div class="popup-badge" style="background:rgba(245,158,11,0.2);color:#f59e0b">BTR-ONLY</div>'
      : '<div class="popup-badge" style="background:rgba(234,179,8,0.15);color:#eab308">BTR</div>';
  } else {
    inline += '<div class="popup-badge" style="background:rgba(34,197,94,0.15);color:#22c55e">BTS</div>';
    if(isDualViable) inline += '<div class="popup-badge" style="background:rgba(234,179,8,0.15);color:#eab308">BTR</div>';
  }
  if(l.hasStructure) inline += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">DEMO</div>';
  if(l.isNew) inline += '<div class="popup-badge" style="background:rgba(34,197,94,0.2);color:#22c55e">NEW</div>';

  // Alert badges (burn zone, tenant risk, etc ‚Äî shown above strip)
  var alerts = '';
  if(l.burnZone) alerts += '<div class="popup-badge" style="background:#dc2626;color:#fff;font-weight:700;padding:2px 8px">&#128293; BURN ZONE ‚Äî '+l.burnZone+' Fire</div>';
  if(l.urbanArea===false) alerts += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NOT URBAN AREA</div>';
  if(l.compMethod&&l.compMethod.includes('thin')) alerts += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">THIN COMPS</div>';
  else if(!l.exitPsf&&!l.newconPpsf&&!l.clusterT1psf&&!l.subdivExitPsf) alerts += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NO COMP DATA</div>';
  if(l.zone!=='R1'&&l.zone!=='LAND'){
    if(l.tenantRisk>=3) alerts += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">HIGH TENANT RISK</div>';
    else if(l.tenantRisk>=2) alerts += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">TENANT RISK</div>';
    if(l.rsoRisk) alerts += '<div class="popup-badge" style="background:rgba(220,38,38,0.15);color:#dc2626">RSO ‚Äî ELLIS ACT</div>';
  }
  if(l.remainderViable) alerts += '<div class="popup-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">REMAINDER: '+commas(l.remainderSf)+' SF &#8594; '+l.remainderUnits+' units</div>';
  else if(l.remainderUnits>0) alerts += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">REMAINDER: '+commas(l.remainderSf)+' SF ('+l.remainderUnits+')</div>';
  return {inline: inline, alerts: alerts};
}

function dealCardStrip(l, pf, el, inlineBadges){
  var margin = pf.margin;
  var marginColor = margin>=30?'#22c55e':margin>=20?'#facc15':'#9ca3af';
  var addrParts = (l.address||'N/A').split(',');
  var mainAddr = addrParts.length > 1 ? addrParts.slice(0,-1).join(',').trim() : l.address||'N/A';
  var cityLine = addrParts.length > 1 ? addrParts[addrParts.length-1].trim() : '';
  var moColor2 = pf.max_offer >= l.price ? 'var(--green)' : 'var(--red)';
  var moLabel = pf.max_offer >= l.price ? '\u2713' : '\u2717';
  var unitsLabel = pf.layoutMax != null && pf.layoutMax < pf.densityUnits ? pf.maxUnits + ' of ' + pf.densityUnits : '' + pf.maxUnits;

  var s = '<div class="dp-strip" onclick="toggleDealCard(this)">';
  s += '<div class="dp-addr"><span class="dp-addr-text">'+mainAddr+(cityLine?', <span class="dp-city">'+cityLine+'</span>':'')+(l.zip?' <span class="dp-zip">'+l.zip+'</span>':'')+'</span>';
  s += '<div class="dp-badges-inline">'+inlineBadges+'</div></div>';
  s += '<div class="dp-metric"><div class="dp-lbl">List Price</div><div class="dp-val" style="color:'+marginColor+'">'+fmtShort(l.price)+' <span style="font-size:9px;color:'+moColor2+'">'+moLabel+'</span></div></div>';
  s += '<div class="dp-metric"><div class="dp-lbl">Exit $/SF</div><div class="dp-val" style="color:'+el.color+'">$'+commas(el.psf)+'</div></div>';
  s += '<div class="dp-metric"><div class="dp-lbl">Lot Size</div><div class="dp-val">'+(l.lotSf?commas(l.lotSf):'‚Äî')+'</div></div>';
  s += '<div class="dp-metric"><div class="dp-lbl">Units</div><div class="dp-val" style="color:var(--green)">'+unitsLabel+'</div></div>';
  s += '<div class="dp-toggle">&#9650;</div>';
  s += '</div>';
  return s;
}

function dealCardEconomics(l, pf, el){
  var bsf = pf.effective_buildable_sf || 1;
  var psfSuffix = function(v){ return ' <small style="color:var(--text-dim)">($'+Math.round(v/bsf)+'/sf)</small>'; };
  var moColor = pf.max_offer>=l.price?'var(--green)':'var(--red)';
  var allInPsf = Math.round(pf.totalCost/bsf);
  var spread = el.psf - allInPsf;

  var h = '<div class="dp-col"><div class="dp-col-head">Economics</div>';
  h += '<div class="dp-row"><span class="dp-k">Acquisition</span><span class="dp-v">'+fmtDollar(pf.acquisition)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Hard Costs</span><span class="dp-v">'+fmtDollar(pf.hardCosts)+psfSuffix(pf.hardCosts)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Soft Costs</span><span class="dp-v">'+fmtDollar(pf.softCosts)+psfSuffix(pf.softCosts)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Total Build</span><span class="dp-v">'+fmtDollar(pf.constructionCost)+psfSuffix(pf.constructionCost)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Total Project</span><span class="dp-v">'+fmtDollar(pf.totalProjectCost)+psfSuffix(pf.totalProjectCost)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Interest Carry</span><span class="dp-v">'+fmtDollar(pf.carryInterest)+'</span></div>';
  if(pf.ellisRelocation>0) h += '<div class="dp-row"><span class="dp-k">Ellis Relocation</span><span class="dp-v" style="color:var(--red)">'+fmtDollar(pf.ellisRelocation)+' <small style="color:var(--text-dim)">(+'+pf.ellisHoldMonths+'mo)</small></span></div>';
  h += '<div class="dp-sep"></div>';
  h += '<div class="dp-row"><span class="dp-k">Spread</span><span class="dp-v" style="color:'+(spread>=100?'var(--green)':spread>=0?'var(--yellow)':'var(--red)')+'">'+fmtDollar(spread)+'/sf</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Max Offer</span><span class="dp-v" style="color:'+moColor+'">'+fmtDollar(pf.max_offer)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Est Profit</span><span class="dp-v" style="color:'+(pf.profit>=0?'var(--green)':'var(--red)')+'">'+fmtDollar(pf.profit)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Net Revenue</span><span class="dp-v">'+fmtDollar(pf.netRevenue)+'</span></div>';
  h += '</div>';
  return h;
}

function dealCardSite(l, pf){
  var effPct = pf.lot_efficiency ? Math.round(pf.lot_efficiency*100) : 0;
  var h = '<div class="dp-col"><div class="dp-col-head">Site</div>';
  h += '<div class="dp-row"><span class="dp-k">Lot Size</span><span class="dp-v">'+(l.lotSf?commas(l.lotSf)+' sf':'‚Äî')+'</span></div>';
  if(l.lw&&l.ld) h += '<div class="dp-row"><span class="dp-k">Dimensions</span><span class="dp-v">'+l.lw+'\' &times; '+l.ld+'\'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Efficiency</span><span class="dp-v" style="color:'+(effPct>=100?'var(--green)':effPct>=60?'var(--yellow)':'var(--red)')+'">'+effPct+'%</span></div>';
  if(l.slope!=null) h += '<div class="dp-row"><span class="dp-k">Slope</span><span class="dp-v" style="color:'+(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)')+'">'+l.slope+'%</span></div>';
  if(l.dom!=null) h += '<div class="dp-row"><span class="dp-k">DOM</span><span class="dp-v">'+l.dom+'</span></div>';
  if(l.beds) h += '<div class="dp-row"><span class="dp-k">Beds / Baths</span><span class="dp-v">'+l.beds+' / '+l.baths+'</span></div>';
  if(l.existingUnits) h += '<div class="dp-row"><span class="dp-k">Existing Units</span><span class="dp-v">'+l.existingUnits+'</span></div>';
  if(l.lw&&l.ld&&pf.maxUnits>0&&pf.max_offer>0){
    var lotId = 'dp-lot-'+Math.random().toString(36).slice(2,8);
    h += '<div class="dp-lot-toggle" onclick="var b=document.getElementById(\''+lotId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\');event.stopPropagation()"><span class="tri">&#9654;</span> Layout &middot; '+pf.maxUnits+'u</div>';
    h += '<div class="dp-lot-body" id="'+lotId+'">'+buildLotLayoutSVG(l,pf)+'</div>';
  }
  h += '</div>';
  return h;
}

function dealCardProForma(l, pf){
  var margin = pf.margin;
  var sellPerUnit = pf.maxUnits>0 ? Math.round(pf.netRevenue/pf.maxUnits) : 0;
  var profitPerUnit = pf.maxUnits>0 ? Math.round(pf.profit/pf.maxUnits) : 0;
  var lbColor = pf.land_basis_psf<120?'var(--green)':pf.land_basis_psf<=160?'var(--yellow)':'var(--red)';

  var h = '<div class="dp-col"><div class="dp-col-head">Pro Forma</div>';
  h += '<div class="dp-row"><span class="dp-k">Units</span><span class="dp-v">'+pf.maxUnits+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Buildable SF</span><span class="dp-v">'+commas(pf.effective_buildable_sf)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Net Margin</span><span class="dp-v" style="color:'+(margin>=30?'var(--green)':margin>=15?'var(--yellow)':'var(--red)')+'">'+margin.toFixed(1)+'%</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Return on Cost</span><span class="dp-v" style="color:'+(pf.return_on_cost>=0?'var(--green)':'var(--red)')+'">'+pf.return_on_cost.toFixed(1)+'%</span></div>';
  h += '<div class="dp-sep"></div>';
  h += '<div class="dp-row"><span class="dp-k">Buy / Unit</span><span class="dp-v">'+fmtDollar(pf.pricePerUnit)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Sell / Unit</span><span class="dp-v">'+fmtDollar(sellPerUnit)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Profit / Unit</span><span class="dp-v" style="color:'+(profitPerUnit>=0?'var(--green)':'var(--red)')+'">'+fmtDollar(profitPerUnit)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Land Basis</span><span class="dp-v" style="color:'+lbColor+'">'+fmtDollar(pf.land_basis_psf)+'/sf</span></div>';
  h += '</div>';
  return h;
}

function dealCardCompButtons(l){
  var cc = compConfidence(l);
  var h = '<div class="dp-comps">';
  h += '<a class="dp-comp-btn" href="#" onclick="showCompsTable('+l.lat+','+l.lng+');return false">'+cc.count+' Sale Comps <span class="dp-comp-arrow">&#8599;</span></a>';
  var hasRentalComps = typeof RENTAL_COMPS!=='undefined'&&RENTAL_COMPS.length>0&&l.rentMethod&&l.rentMethod.startsWith('rental-comp');
  if(hasRentalComps){
    h += '<a class="dp-comp-btn" href="#" onclick="showRentalCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--orange)">'+(l.rentCompCount||'')+' Rent Comps <span class="dp-comp-arrow">&#8599;</span></a>';
  }
  h += '</div>';
  return h;
}

function dealCardBTR(l, btr){
  if(btr.rentPsf<=0) return '';
  var h = '<div class="dp-btr">';
  h += '<div class="dp-btr-col">';
  h += '<div class="dp-row"><span class="dp-k">Rent / Unit</span><span class="dp-v" style="color:var(--green)">$'+btr.rentPerUnit.toLocaleString()+'/mo <small style="color:var(--text-dim)">($'+btr.rentPsf.toFixed(2)+'/SF)</small></span></div>';
  h += '<div class="dp-row"><span class="dp-k">NOI</span><span class="dp-v">'+fmtDollar(btr.annualNOI)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">YoC</span><span class="dp-v" style="color:'+(btr.yieldOnCost>=0.04?'var(--green)':btr.yieldOnCost>=0.03?'var(--yellow)':'var(--red)')+'">'+(btr.yieldOnCost*100).toFixed(1)+'%</span></div>';
  h += '</div>';
  h += '<div class="dp-btr-col">';
  h += '<div class="dp-row"><span class="dp-k">Stabilized Value</span><span class="dp-v" style="color:'+(btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)')+'">'+fmtShort(btr.stabilizedValue)+'</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Cap Rate</span><span class="dp-v">'+(btr.capRate*100).toFixed(1)+'%</span></div>';
  h += '<div class="dp-row"><span class="dp-k">Cash Flow</span><span class="dp-v" style="color:'+(btr.cashFlow>=0?'var(--green)':'var(--red)')+'">'+fmtDollar(btr.cashFlow)+'/yr</span></div>';
  h += '</div>';
  h += '</div>';
  // Loan summary bar
  var loanAmt = btr.loanAmount;
  var loanAbbr = loanAmt >= 1e6 ? '$'+(loanAmt/1e6).toFixed(1)+'M' : '$'+(loanAmt/1e3).toFixed(0)+'K';
  var annualDS = Math.round(loanAmt * 0.065);
  var dscrOk = btr.dscr >= 1.25;
  var dscrColor = dscrOk ? '#15803d' : '#dc2626';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 14px;margin:6px 8px 0">';
  h += '<div>';
  h += '<div style="font-size:10px;font-weight:700;letter-spacing:1px;color:#64748b;text-transform:uppercase">I/O Takeout Loan</div>';
  h += '<div style="font-size:12px;color:var(--text)">'+loanAbbr+' @ 6.5% = $'+annualDS.toLocaleString()+'/yr</div>';
  h += '</div>';
  h += '<div style="text-align:right">';
  h += '<div style="font-size:20px;font-weight:700;color:'+dscrColor+'">'+btr.dscr.toFixed(2)+'x</div>';
  h += '<div style="font-size:9px;font-weight:700;letter-spacing:1px;color:'+dscrColor+';text-transform:uppercase">DSCR '+(dscrOk?'&#10003;':'&#10007;')+'</div>';
  h += '</div>';
  h += '</div>';
  return h;
}

function dealCardDD(l){
  var ddItems = [];
  if(l.burnZone) ddItems.push('<span style="color:var(--red)">&#10007;</span> Burn zone');
  else if(l.fireZone) ddItems.push('<span style="color:var(--red)">&#10007;</span> VHFHSZ');
  if(l.rsoRisk) ddItems.push('<span style="color:var(--red)">&#10007;</span> RSO');
  var sb = slopeBadge(l);
  if(sb&&sb.includes('&#10007;')) ddItems.push(sb.replace(/^ ‚Ä¢ /,'').replace(/<br>.*/,''));
  if(ddItems.length===0) ddItems.push('<span style="color:var(--green)">&#10003;</span> All checks passed');
  ddItems.push('<span style="color:var(--yellow)">&#9888;</span> TPA = 0 parking');
  return '<div class="dp-dd">'+ddItems.join(' &nbsp;&middot;&nbsp; ')+'</div>';
}

function dealCardActions(l){
  var isSaved = isFavorite(l);
  var h = '<div class="dp-actions">';
  h += '<button onclick="exportModel('+l.lat+','+l.lng+').catch(console.error)"><span class="dp-icon">&#8595;</span>XLS</button>';
  h += '<button onclick="exportOM('+l.lat+','+l.lng+').catch(console.error)"><span class="dp-icon">&#128196;</span>OM</button>';
  h += '<a href="https://www.google.com/maps?q='+l.lat+','+l.lng+'&amp;t=k&amp;z=19" target="_blank"><span class="dp-icon">&#128205;</span>Maps</a>';
  if(l.url) h += '<a href="'+l.url+'" target="_blank"><span class="dp-icon">&#127968;</span>Redfin</a>';
  else h += '<span></span>';
  if(l.lw&&l.ld) h += '<a href="'+lotPlannerUrl(l)+'" target="_blank"><span class="dp-icon">&#128208;</span>Planner</a>';
  else h += '<span></span>';
  h += '<button class="'+(isSaved?'active':'')+'" onclick="toggleFavorite('+l.lat+','+l.lng+');this.classList.toggle(\'active\');this.querySelector(\'span:last-child\').textContent=this.classList.contains(\'active\')?\'Saved\':\'Save\'"><span class="dp-icon">&#9733;</span><span>'+(isSaved?'Saved':'Save')+'</span></button>';
  h += '<button onclick="sharePin('+l.lat+','+l.lng+',event)"><span class="dp-icon">&#8599;</span>Share</button>';
  h += '</div>';
  return h;
}

function generateDealCard(l, opts){
  opts = opts || {};
  var ctx = opts.context || 'bts';
  var pf = calculateProForma(l);
  var btr = calculateBTRProForma(l);
  var el = exitLabel(l);
  var isDualViable = (pf.margin >= 20) && l.btrViable;

  var badges = dealCardBadges(l, ctx, isDualViable);
  var autoExpand = ctx==='btr' ? ' expanded' : '';
  var h = '<div class="dp-card'+autoExpand+'">';
  if(badges.alerts) h += '<div class="dp-alerts">'+badges.alerts+'</div>';
  h += dealCardStrip(l, pf, el, badges.inline);
  h += '<div class="dp-drawer">';
  h += '<div class="dp-body">'+dealCardEconomics(l, pf, el)+dealCardSite(l, pf)+dealCardProForma(l, pf)+'</div>';
  h += dealCardCompButtons(l);
  h += dealCardBTR(l, btr);
  h += dealCardDD(l);
  h += dealCardActions(l);
  h += '</div>';
  h += '</div>';
  return h;
}

function rebuildListings(cachedListings){
  listingsLayer.clearLayers();
  // Clear for-sale flags so off-market layer can exclude visible for-sale listings
  LISTINGS.forEach(l => { l._onForSaleLayer = false; });
  const filtered = cachedListings || getFilteredListings();

  filtered.forEach(l => {
    l._onForSaleLayer = true;
    // Color fill by exit $/SF
    const ePsf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const fillColor = exitPsfColor(ePsf);

    const lotSf = l.lotSf || 0;
    const isNewListing = l.isNew;
    const baseRadius = lotSf >= 15000 ? 11 : lotSf >= 10000 ? 9 : 8;
    const radius = isNewListing ? baseRadius + 3 : baseRadius;
    const borderColor = isNewListing ? '#22c55e' : '#f97316'; // Orange border = for-sale identifier
    const markerWeight = isNewListing ? 4 : 2;
    const margin = l.estMargin || 0;
    const isDualViable = margin >= 20 && l.btrViable;
    const cm = L.circleMarker([l.lat,l.lng],{
      radius, color: isDualViable ? '#f59e0b' : borderColor, fillColor,
      fillOpacity: 0.95,
      weight: isDualViable ? 3 : markerWeight,
      pane:'listingsPane',
      className: isNewListing ? 'listing-marker-new' : '',
    });

    cm.bindPopup(generateDealCard(l),{maxWidth:660,className:'deal-popup'});
    cm.addTo(listingsLayer);
  });

  document.getElementById('listingCount').textContent = filtered.length.toLocaleString();
  rebuildTable(filtered);
}

function buildBTRLayer(cachedListings){
  btrLayer.clearLayers();

  // BTR layer shows ALL BTR-viable deals (DSCR >= 1.25x gate)
  // Dual-viable deals (also BTS profitable) show both a BTS circle and BTR diamond
  const btrListings = (cachedListings || getFilteredListings()).filter(l => {
    if(!l.sb1123Eligible) return false;
    if(!(l.estRentMonth > 0 || l.fmr3br > 0 || l.yocBase > 0)) return false;
    const btrPF = calculateBTRProForma(l);
    return btrPF.btrPencils;
  });

  btrListings.forEach(l => {
    const btrIcon = L.divIcon({
      className: '',
      html: '<div class="btr-pin"></div>',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });

    const marker = L.marker([l.lat, l.lng], { icon: btrIcon });
    marker.bindPopup(generateDealCard(l, {context:'btr'}), {maxWidth:660, className:'deal-popup'});
    marker.addTo(btrLayer);
  });

}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SALE $/SF NEIGHBORHOOD GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildNeighborhoodLayer(){
  neighborhoodLayer.clearLayers();

  // Grid cell size (0.01¬∞ ‚âà 1km)
  const CELL_SIZE = 0.01;

  // Group listings by neighborhood grid cell
  const cells = {};
  LISTINGS.forEach(l => {
    if(!l.sb1123Eligible) return;
    const exitPsf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    if(!exitPsf) return;
    const cellLat = Math.floor(l.lat / CELL_SIZE) * CELL_SIZE;
    const cellLng = Math.floor(l.lng / CELL_SIZE) * CELL_SIZE;
    const key = `${cellLat},${cellLng}`;
    if(!cells[key]) cells[key] = {lat:cellLat, lng:cellLng, listings:[], exitVals:[]};
    cells[key].listings.push(l);
    cells[key].exitVals.push(exitPsf);
  });

  // Calculate scores for each cell ‚Äî pure exit $/SF
  Object.values(cells).forEach(cell => {
    const vals = cell.exitVals;
    vals.sort((a,b)=>a-b);
    const median = vals.length%2 ? vals[Math.floor(vals.length/2)] : (vals[Math.floor(vals.length/2)-1]+vals[Math.floor(vals.length/2)])/2;
    const min = vals[0], max = vals[vals.length-1];

    // Color by median exit $/SF ‚Äî same scale as exitPsfColor() / listing pins
    const color = exitPsfColor(median);
    let fillOpacity;
    if(median >= 900)      fillOpacity = 0.4;
    else if(median >= 800) fillOpacity = 0.35;
    else if(median >= 700) fillOpacity = 0.35;
    else if(median >= 650) fillOpacity = 0.3;
    else                   fillOpacity = 0.2;

    // Create polygon for cell
    const bounds = [
      [cell.lat, cell.lng],
      [cell.lat + CELL_SIZE, cell.lng],
      [cell.lat + CELL_SIZE, cell.lng + CELL_SIZE],
      [cell.lat, cell.lng + CELL_SIZE]
    ];

    const polygon = L.polygon(bounds, {
      color: color,
      fillColor: color,
      fillOpacity: fillOpacity,
      weight: 1,
      opacity: 0.7
    });

    polygon.bindTooltip(`
      <div style="font-size:12px;font-weight:700;margin-bottom:4px;color:${color}">Exit $/SF: $${median.toFixed(0)}</div>
      <div style="font-size:10px;line-height:1.5">
        <div><strong>Range:</strong> $${min.toFixed(0)} ‚Äì $${max.toFixed(0)}/SF</div>
        <div><strong>Eligible Parcels:</strong> ${vals.length}</div>
      </div>
    `, {permanent: false, direction: 'top'});

    polygon.addTo(neighborhoodLayer);
  });

  document.getElementById('neighborhoodCount').textContent = Object.keys(cells).length.toLocaleString();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRIORITY 4: OFF-MARKET TARGETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildOffMarketLayer(){
  offMarketLayer.clearLayers();
  
  // In a real implementation, this would load a separate parcel dataset
  // For now, we'll simulate "off-market" by filtering existing data
  // that meets SB1123 criteria but isn't in active listings
  
  // Simulate off-market parcels (in practice, load from separate dataset)
  // For demo purposes, let's create a hypothetical off-market filter
  const offMarketListings = LISTINGS.filter(l => {
    if(!l.sb1123Eligible) return false;
    if(l._onForSaleLayer) return false;  // Already visible on For Sale layer

    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;

    // Est. Market Value = hood_psf √ó structure_sf
    const est_market_value = hood_psf * structure_sf;

    // Est. Offer = est_market_value √ó 0.95 (5% below market)
    const est_offer = est_market_value * 0.95;

    // Calculate pro forma metrics for margin calculation
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);

    // Margin at Offer - retail exit model
    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf;
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const f_insurance = proforma.insurance || 40000;
    const f_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + f_insurance + f_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;

    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;

    const lotEff = l.lotEfficiency || 0;
    const slope = l.slope || 0;

    return spread > 150 && margin_at_offer >= 0.25 && lotEff > 70 && !l.fireZone && slope < 15;
  });

  offMarketListings.forEach(l => {
    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;

    // Est. Market Value = hood_psf √ó structure_sf
    const est_market_value = hood_psf * structure_sf;

    // Est. Offer = est_market_value √ó 0.95
    const est_offer = est_market_value * 0.95;

    // Calculate pro forma metrics
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);

    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf;
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const om_insurance = proforma.insurance || 40000;
    const om_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + om_insurance + om_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;

    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    
    const target_margin = 0.30;
    const target_all_in_psf = exit_psf * (1 - target_margin);
    const target_land_basis_psf = target_all_in_psf - adjBuildCostPerSf;
    const target_max_buy = target_land_basis_psf * effective_buildable_sf;
    const headroom = target_max_buy - est_offer;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;
    
    // Color coding for margin_at_offer
    let marginColor = '#ef4444'; // red
    if(margin_at_offer >= 0.30) marginColor = '#22c55e'; // green
    else if(margin_at_offer >= 0.20) marginColor = '#facc15'; // yellow
    
    // Color coding for land_basis_psf
    let landBasisColor = '#ef4444'; // red
    if(land_basis_psf < 120) landBasisColor = '#22c55e'; // green
    else if(land_basis_psf >= 120 && land_basis_psf <= 160) landBasisColor = '#facc15'; // yellow
    
    // Color coding for headroom
    const headroomColor = headroom > 0 ? '#22c55e' : '#ef4444';
    
    // Color by spread for pin
    let pinColor = '#ef4444'; // red
    if(spread >= 300) pinColor = '#059669'; // deep green
    else if(spread >= 200) pinColor = '#22c55e'; // green
    else if(spread >= 100) pinColor = '#eab308'; // yellow
    else if(spread >= 0) pinColor = '#f97316'; // orange
    
    const offMarketIcon = L.divIcon({
      className: '',
      html: `<div style="width:10px;height:10px;border:2px solid ${pinColor};border-radius:50%;background:transparent;position:relative">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:1px;height:8px;background:${pinColor}"></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:1px;background:${pinColor}"></div>
      </div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });
    
    const marker = L.marker([l.lat, l.lng], { icon: offMarketIcon });
    
    // Build full pro forma using est_offer as acquisition price
    const omProxy = Object.assign({}, l, {price: Math.round(est_offer)});
    const pf = calculateProForma(omProxy);
    const btr = calculateBTRProForma(omProxy);
    const omExitPsf = l.clusterT1psf || l.newconPpsf || l.exitPsf || 0;
    const omEstMvPsf = (est_market_value && l.lotSf) ? Math.round(est_market_value / l.lotSf) : null;

    marker.bindPopup(`
      ${l.burnZone ? '<div class="popup-badge" style="background:#dc2626;color:#fff;font-weight:700;padding:4px 10px">&#128293; BURN ZONE ‚Äî '+l.burnZone+' Fire (Jan 2025)</div>' : ''}
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <div class="popup-badge" style="background:#666;color:#fff">OFF-MARKET</div>
        <div class="popup-badge" style="background:${ZONE_COLORS[l.zone]||'#666'}22;color:${ZONE_COLORS[l.zone]||'#666'}">${l.zone} ‚Äî ${ZONE_LABELS[l.zone]||l.zone||'Unknown'}</div>
      </div>
      ${l.hasStructure ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">DEMO REQUIRED</div>' : ''}
      ${l.urbanArea === false ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NOT URBAN AREA</div>' : ''}
      ${l.zone!=='R1'&&l.zone!=='LAND' ? (l.tenantRisk >= 3 ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">HIGH TENANT RISK</div>' : l.tenantRisk >= 2 ? '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">TENANT RISK</div>' : '') : ''}
      ${l.zone!=='R1'&&l.zone!=='LAND'&&l.rsoRisk ? '<div class="popup-badge" style="background:rgba(220,38,38,0.15);color:#dc2626">RSO ‚Äî ELLIS ACT REQUIRED</div>' : ''}
      ${l.remainderViable ? '<div class="popup-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">REMAINDER PARCEL: '+l.remainderSf.toLocaleString()+' SF &#8594; '+l.remainderUnits+' units</div>' : l.remainderUnits > 0 ? '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">REMAINDER: '+l.remainderSf.toLocaleString()+' SF ('+l.remainderUnits+' units)</div>' : ''}
      <div class="popup-title">${l.address || 'N/A'}</div>

      <div class="popup-grid">
        <div><div class="popup-label">Est. Market Value</div><div class="popup-value" style="color:${marginColor}">$${est_market_value > 0 ? Math.round(est_market_value).toLocaleString() : '‚Äî'}</div></div>
        <div><div class="popup-label">Exit $/SF</div><div class="popup-value">$${exitLabel(l).psf} <small style="color:${exitLabel(l).color}">(${exitLabel(l).short}${l.newconCount?', '+l.newconCount:''})</small></div></div>
        <div><div class="popup-label">All-In $/SF</div><div class="popup-value">$${pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0}/sf</div></div>
        <div><div class="popup-label">Spread</div><div class="popup-value" style="color:${(exitLabel(l).psf-(pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0))>=0?'var(--green)':'var(--red)'}">$${exitLabel(l).psf-(pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0)}/sf</div></div>

        ${l.lotSf?lotLabel(l,Math.round(pf.lot_efficiency*100)):'<div></div>'}
        ${l.city?'<div><div class="popup-label">City</div><div class="popup-value">'+l.city+'</div></div>':'<div></div>'}
        <div><div class="popup-label">Zone</div><div class="popup-value">${l.zone||'‚Äî'}${l.zimasZone?' <small style="color:var(--text-dim)">'+l.zimasZone+'</small>':''}</div></div>
        ${l.slope!=null?'<div><div class="popup-label">Terrain Slope</div><div class="popup-value" style="color:'+(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)')+'">'+l.slope+'%</div></div>':'<div></div>'}

        ${proFormaBlock(l, pf, {buyLabel:'Est. Offer/Unit', buyPerUnit:Math.round(est_offer/pf.maxUnits), comparePrice:Math.round(est_offer)})}
      </div>

      <div class="popup-grid-2">
        <div class="popup-section-label">Economics (at Est. Offer $${Math.round(est_offer).toLocaleString()})</div>

        <div><div class="popup-label">Build $/SF${pf.adjBuildCostPerSf>proforma.allInBuildPsf?' <span style="color:var(--orange)">(slope adj)</span>':''}</div><div class="popup-value"${pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':''}>$${pf.adjBuildCostPerSf}/sf</div></div>
        <div><div class="popup-label">Hard Costs</div><div class="popup-value">$${pf.hardCosts.toLocaleString()}</div></div>
        <div><div class="popup-label">Soft Costs</div><div class="popup-value">$${pf.softCosts.toLocaleString()}</div></div>
        <div><div class="popup-label">Total Build</div><div class="popup-value">$${Math.round(pf.constructionCost).toLocaleString()}</div></div>
        <div><div class="popup-label">Insurance</div><div class="popup-value">$${pf.insurance.toLocaleString()}</div></div>
        <div><div class="popup-label">Loan Origination (${proforma.originationPct}%)</div><div class="popup-value">$${pf.originationFee.toLocaleString()}</div></div>
        <div><div class="popup-label">Carry Interest (${proforma.holdMonths}mo)</div><div class="popup-value">$${pf.carryInterest.toLocaleString()}</div></div>
        <div><div class="popup-label">Property Tax (${proforma.holdMonths}mo)</div><div class="popup-value">$${pf.carryPropTax.toLocaleString()}</div></div>

        <div class="popup-divider"></div>
        <div><div class="popup-label">Net Revenue</div><div class="popup-value">$${Math.round(pf.netRevenue).toLocaleString()}</div></div>
        <div><div class="popup-label">Est Profit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit).toLocaleString()}</div></div>

        <div><div class="popup-label">Sell / Unit</div><div class="popup-value" style="color:var(--green)">$${Math.round(pf.netRevenue/pf.maxUnits).toLocaleString()}</div></div>
        <div><div class="popup-label">Profit / Unit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit/pf.maxUnits).toLocaleString()}</div></div>

        <div><div class="popup-label">Return on Cost</div><div class="popup-value ${pf.return_on_cost>=0?'popup-profit-positive':'popup-profit-negative'}">${pf.return_on_cost.toFixed(1)}%</div></div>
        <div><div class="popup-label">Net Margin on Sale</div><div class="popup-value ${pf.margin>=0?'popup-profit-positive':'popup-profit-negative'}">${pf.margin.toFixed(1)}%<br><small style="color:var(--text-dim);font-weight:400">(Revenue‚àíCost)/Revenue</small></div></div>

        <div class="popup-divider"></div>
        <div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>
        ${btr.btrPencils
          ? '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(34,197,94,0.1);color:var(--green);font-weight:600;font-size:11px">&#9989; BTR VIABLE ‚Äî '+btr.dscr.toFixed(2)+'x DSCR</div>'
          : btr.rentPsf <= 0
            ? '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(100,116,139,0.1);color:#94a3b8;font-size:11px">&#9888;&#65039; BTR ‚Äî No rent data available</div>'
            : '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(239,68,68,0.1);color:var(--red);font-size:11px">&#10060; BTR ‚Äî '+btr.dscr.toFixed(2)+'x DSCR (need 1.25x)</div>'
        }
        ${btr.rentPsf > 0 ? `
        <div><div class="popup-label">Rent Source</div><div class="popup-value">${getRentSourceLabel(l)}</div></div>
        ${RENTAL_COMPS.length > 0 && l.rentMethod && l.rentMethod.startsWith('rental-comp') ? `<div class="popup-span-2" style="font-size:10px;line-height:1.4"><a href="#" onclick="showRentalCompsTable(${l.lat},${l.lng});return false" style="color:var(--accent);cursor:pointer">${l.rentCompCount} rental comps within ${l.rentCompRadius}mi &#8599;</a></div>` : ''}
        <div><div class="popup-label">Est. Rent/Unit</div><div class="popup-value">$${btr.rentPerUnit.toLocaleString()}/mo <small style="color:var(--text-dim)">($${btr.rentPsf.toFixed(2)}/SF √ó ${proforma.avgUnitSf.toLocaleString()} SF)</small></div></div>
        <div><div class="popup-label">Gross Annual Rent</div><div class="popup-value">$${Math.round(btr.grossAnnualRent).toLocaleString()} <small style="color:var(--text-dim)">(${btr.units} units)</small></div></div>
        <div><div class="popup-label">NOI</div><div class="popup-value">$${Math.round(btr.annualNOI).toLocaleString()} <small style="color:var(--text-dim)">(${Math.round((1-btr.opexRatio)*100)}% of gross)</small></div></div>
        <div><div class="popup-label">OpEx</div><div class="popup-value">${Math.round(btr.opexRatio*100)}% <small style="color:var(--text-dim)">($${Math.round(btr.grossAnnualRent*btr.opexRatio).toLocaleString()}/yr)</small></div></div>
        <div><div class="popup-label">Yield on Cost</div><div class="popup-value" style="color:${btr.yieldOnCost>=0.04?'var(--green)':btr.yieldOnCost>=0.03?'var(--yellow)':'var(--red)'}">${(btr.yieldOnCost*100).toFixed(1)}%</div></div>
        <div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:${btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)'}">$${(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')}M</div></div>
        <div><div class="popup-label">Cap Rate</div><div class="popup-value">${(btr.capRate*100).toFixed(1)}%</div></div>
        ` : `
        <div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:var(--text-dim)">N/A</div></div>
        <div><div class="popup-label">Cap Rate</div><div class="popup-value" style="color:var(--text-dim)">N/A</div></div>
        `}
        ${btr.btrPencils ? `
        <div class="popup-span-2" style="font-size:10px;padding:3px 8px;border-radius:4px;background:${btr.stabilizedValue>=btr.totalCost?'rgba(34,197,94,0.1)':'rgba(239,68,68,0.1)'};color:${btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)'}">${btr.stabilizedValue>=btr.totalCost?'&#9989; Refi-able &mdash; $'+Math.round((btr.stabilizedValue-btr.totalCost)/1000).toLocaleString()+'k equity at '+(btr.capRate*100).toFixed(1)+'% cap':'&#10060; Refi gap: -$'+Math.round((btr.totalCost-btr.stabilizedValue)/1000).toLocaleString()+'k &mdash; cash trapped at '+(btr.capRate*100).toFixed(1)+'% cap'}</div>
        <div><div class="popup-label">DSCR</div><div class="popup-value" style="color:${btr.dscr>=1.25?'var(--green)':btr.dscr>=1.15?'var(--yellow)':'var(--red)'}">${btr.dscr.toFixed(2)}x</div></div>
        <div><div class="popup-label">Cash Flow</div><div class="popup-value" style="color:${btr.cashFlow>=0?'var(--green)':'var(--red)'}">$${Math.round(btr.cashFlow).toLocaleString()}/yr</div></div>
        ` : ''}

        <div class="popup-divider"></div>
        <div class="popup-section-label">Due Diligence</div>
        <div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">
          ${l.zimasZone ? (
            '<span style="color:var(--green)">‚úì</span> ' + l.zimasZone + ' zoning confirmed ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> Not Hillside Area ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> No Historic Overlay ‚Ä¢ ' +
            (l.burnZone ? '<span style="color:var(--red)">‚úó</span> &#128293; BURN ZONE ‚Äî active fire damage area. Insurance unavailable, infrastructure compromised.' : l.fireZone ? '<span style="color:var(--red)">‚úó</span> VHFHSZ fire zone (hard exclusion)' : '<span style="color:var(--green)">‚úì</span> NOT VHFHSZ (safe to build)') + ' ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> No Specific Plan restrictions ‚Ä¢ ' +
            '<span style="color:var(--yellow)">&#9733;</span> Transit Priority Area = 0 parking ‚Ä¢ ' +
            (l.rsoRisk ? '<span style="color:var(--red)">&#10007;</span> RSO rent-controlled (Ellis Act)' : '<span style="color:var(--green)">&#10003;</span> No rent-control/Ellis Act') +
            slopeBadge(l)
          ) : (l.fireZone || l.burnZone || l.slope > 0 ? (
            (l.burnZone ? '<span style="color:var(--red)">‚úó</span> &#128293; BURN ZONE' : l.fireZone ? '<span style="color:var(--red)">‚úó</span> VHFHSZ fire zone' : '<span style="color:var(--green)">‚úì</span> NOT VHFHSZ') +
            slopeBadge(l)
          ) : '<span style="color:var(--text-dim)">No zoning verification data available</span>')}
        </div>
        ${l.rsoRisk&&l.zone!=='R1'&&l.zone!=='LAND' ? '<div class="popup-span-2" style="font-size:10px;color:#dc2626;line-height:1.4">&#9888; RSO: Budget ~$20K/unit relocation + 120-day Ellis Act notice</div>' : ''}
        ${remainderAnalysis(l)}
      </div>
      <div style="margin-top:6px;display:flex;gap:8px;justify-content:center;align-items:center">
        <a href="https://www.google.com/maps?q=${l.lat},${l.lng}&t=k&z=19" target="_blank" style="color:var(--accent);font-size:11px">Google Maps &#8599;</a>
        ${l.url?`<a href="${l.url}" target="_blank" style="color:var(--accent);font-size:11px">Redfin &#8599;</a>`:''}
        ${MARKET.hasZimas?`<a href="${getZimasUrl(l)}" target="_blank" style="color:var(--yellow);font-size:11px">ZIMAS &#8599;</a>`:''}
        ${l.lw && l.ld ? `<a href="${lotPlannerUrl(l)}" target="_blank" style="color:var(--accent);font-size:11px">Layout Planner &#8599;</a>` : ''}
        <button class="popup-fav-btn" onclick="alert('Mail campaign coming soon!')" style="background:var(--accent);color:#fff;border-color:var(--accent)">Mail ‚òÖ</button>
        <button class="popup-fav-btn" onclick="exportModel(${l.lat},${l.lng}).catch(console.error)">&#128202; XLS</button>
        <button class="popup-fav-btn" onclick="exportOM(${l.lat},${l.lng}).catch(console.error)">&#128196; OM</button>
        <button class="popup-fav-btn ${isFavorite(l)?'active':''}" onclick="toggleFavorite(${l.lat},${l.lng});this.classList.toggle('active')">&#9733; ${isFavorite(l)?'Saved':'Save'}</button>
        <button class="popup-fav-btn" onclick="sharePin(${l.lat},${l.lng},event)">&#128279; Share</button>
      </div>
      ${lotLayoutSection(l, pf)}
    `, {maxWidth: 580});

    marker.addTo(offMarketLayer);
  });
  
}

function refreshVisibility(){
  Object.entries(markerLayers).forEach(([z,l])=>{
    if(layerState.markers && zoneState[z]) l.addTo(map);
    else map.removeLayer(l);
  });
  if(compHeatLayer){
    if(layerState.compHeat) compHeatLayer.addTo(map);
    else map.removeLayer(compHeatLayer);
  }
  if(layerState.compHeat){
    compPointsLayer.addTo(map);
    compLabelsLayer.addTo(map);
    updateCompPoints();
  } else {
    map.removeLayer(compPointsLayer);
    map.removeLayer(compLabelsLayer);
  }
  // Sale $/SF neighborhood grid
  if(layerState.neighborhoods){
    if(neighborhoodLayer.getLayers().length === 0) buildNeighborhoodLayer();
    neighborhoodLayer.addTo(map);
  } else {
    map.removeLayer(neighborhoodLayer);
  }
  if(layerState.listings) listingsLayer.addTo(map);
  else map.removeLayer(listingsLayer);
  // Priority 4: Off-market targets
  if(layerState.offMarket){
    if(offMarketLayer.getLayers().length === 0) buildOffMarketLayer();
    offMarketLayer.addTo(map);
  } else {
    map.removeLayer(offMarketLayer);
  }
  if(layerState.btr) {
    if(btrLayer.getLayers().length === 0) buildBTRLayer();
    btrLayer.addTo(map);
  } else {
    map.removeLayer(btrLayer);
  }
  if(fireZoneLayer){
    if(layerState.fireZones) fireZoneLayer.addTo(map);
    else map.removeLayer(fireZoneLayer);
  }
  if(floodZoneLayer){
    if(layerState.floodZones) floodZoneLayer.addTo(map);
    else map.removeLayer(floodZoneLayer);
  }
  if(liquefactionLayer){
    if(layerState.liquefaction) liquefactionLayer.addTo(map);
    else map.removeLayer(liquefactionLayer);
  }
  if(parcelLayer){
    if(layerState.parcels) parcelLayer.addTo(map);
    else map.removeLayer(parcelLayer);
  }
  updatePinLegend();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIN LEGEND (dynamic, updates with layers)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updatePinLegend(){
  const legend = document.getElementById('pinLegend');
  if(!legend) return;
  
  let html = '';
  
  // Show For Sale legend if listings layer is on
  if(layerState.listings){
    html += '<div class="pin-legend-item" style="font-weight:600;font-size:10px;color:var(--text-dim);margin-bottom:4px">Listing Exit $/SF</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#6366f1;border:1.5px solid #f97316"></div> &lt;$650</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#3b82f6;border:1.5px solid #f97316"></div> $650‚Äì700</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22d3ee;border:1.5px solid #f97316"></div> $700‚Äì750</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22c55e;border:1.5px solid #f97316"></div> $750‚Äì800</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#eab308;border:1.5px solid #f97316"></div> $800‚Äì900</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#f97316;border:1.5px solid #f97316"></div> $900+</div>';
  }
  
  // Show BTR legend if Build to Rent layer is on
  if(layerState.btr){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker diamond"></div> BTR-only deal</div>';
  }
  // Show dual-viable legend if both listings and BTR layers are on
  if(layerState.listings && layerState.btr){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="border:2px solid #f59e0b"></div> BTS + BTR viable (amber ring)</div>';
  }
  
  // Show Off-Market legend if off-market layer is on
  if(layerState.offMarket){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker circle"></div> Off-market target</div>';
  }

  // Show tier legend when comp layer is on
  if(layerState.compHeat){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#14b8a6"></div> T1 New/Remodel</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#64748b"></div> T2 Existing</div>';
  }

  // Sale $/SF grid legend
  if(layerState.neighborhoods){
    if(html) html += '<div class="pin-legend-section"></div>';
    html += '<div class="pin-legend-item" style="font-weight:600;font-size:10px;color:var(--text-dim);margin-bottom:4px">Sale $/SF</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#f97316;border-radius:2px"></div> $900+</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#eab308;border-radius:2px"></div> $800‚Äì900</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22c55e;border-radius:2px"></div> $750‚Äì800</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22d3ee;border-radius:2px"></div> $700‚Äì750</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#3b82f6;border-radius:2px"></div> $650‚Äì700</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#6366f1;border-radius:2px"></div> &lt;$650</div>';
  }

  // Risk overlay legends
  if(layerState.fireZones || layerState.floodZones || layerState.liquefaction){
    if(html) html += '<div class="pin-legend-section"></div>';
    if(layerState.fireZones)    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:rgba(239,68,68,0.5);border-radius:2px"></div> VHFHSZ Fire Hazard</div>';
    if(layerState.floodZones)   html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:rgba(59,130,246,0.5);border-radius:2px"></div> FEMA Flood Zone</div>';
    if(layerState.liquefaction)  html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:rgba(147,51,234,0.5);border-radius:2px"></div> Liquefaction Risk</div>';
  }

  legend.innerHTML = html;
  legend.style.display = html ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEAL ASSUMPTIONS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Onboarding walkthrough ‚îÄ‚îÄ
const ONBOARD_KEY = 'sb1123_onboarded';
var _onboardStep = 0;
function showOnboardingIfNeeded(){
  if(localStorage.getItem(ONBOARD_KEY)) return;
  var ov = document.getElementById('onboardOverlay');
  if(ov) ov.classList.add('active');
  _onboardStep = 0;
  updateOnboardStep();
}
function advanceOnboarding(){
  _onboardStep++;
  if(_onboardStep >= 3){ dismissOnboarding(); return; }
  updateOnboardStep();
}
function updateOnboardStep(){
  var steps = document.querySelectorAll('.onboard-step');
  var dots = document.querySelectorAll('#onboardDots span');
  steps.forEach(function(s,i){ s.classList.toggle('active', i===_onboardStep); });
  dots.forEach(function(d,i){ d.classList.toggle('active', i===_onboardStep); });
  var btn = document.getElementById('onboardNext');
  if(btn) btn.textContent = _onboardStep === 2 ? 'Got it' : 'Next';
}
function dismissOnboarding(){
  localStorage.setItem(ONBOARD_KEY, '1');
  var ov = document.getElementById('onboardOverlay');
  if(ov) ov.classList.remove('active');
}

function openAssumptionsModal(){
  document.getElementById('assumptionsModal').classList.add('active');
}

function closeAssumptionsModal(){
  document.getElementById('assumptionsModal').classList.remove('active');
}
function closeDataKeyModal(){
  document.getElementById('dataKeyModal').classList.remove('active');
}

// ‚îÄ‚îÄ Escape key: close topmost modal/panel ‚îÄ‚îÄ
document.addEventListener('keydown', function(e){
  if(e.key !== 'Escape') return;
  if(document.getElementById('assumptionsModal').classList.contains('active')) closeAssumptionsModal();
  else if(document.getElementById('dataKeyModal').classList.contains('active')) closeDataKeyModal();
  else if(document.getElementById('onboardOverlay').classList.contains('active')) dismissOnboarding();
  else if(isCompsTableActive()) hideCompsTable();
  else if(isRentalCompsTableActive()) hideRentalCompsTable();
  else if(listingsPanelOpen) toggleListingsPanel();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HERO STAT BAR (updates with filters)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateStatPills(cachedListings, cachedComps){
  const filtered = cachedListings || getFilteredListings();
  const eligible = filtered.filter(l=>l.sb1123Eligible);
  document.getElementById('pillOnMarket').textContent = eligible.length.toLocaleString();
  const compN = (cachedComps || getFilteredComps()).length;
  document.getElementById('pillComps').textContent = compN >= 1000 ? (compN/1000).toFixed(1).replace(/\.0$/,'') + 'K' : compN.toLocaleString();
  document.getElementById('pillMinMargin').textContent = filters.margin.min + '%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleZone(zone,enabled){
  zoneState[zone]=enabled;
  applyFilters();
}

function setHeatmapMode(mode) {
  heatmapMode = mode;
  document.getElementById('heatRaw').classList.toggle('active', mode === 'raw');
  document.getElementById('heatNorm').classList.toggle('active', mode === 'normalized');
  document.getElementById('heatmapModeLabel').textContent =
    mode === 'normalized' ? 'T1 (New/Remodel) at 1,750 SF' : 'All sales, raw $/SF';

  if (compHeatLayer) map.removeLayer(compHeatLayer);

  if (mode === 'normalized' && CLUSTERS.length > 0) {
    const HEAT_MIN = 500, HEAT_MAX = 900;
    const heatPts = CLUSTERS.filter(cl => cl.t1psf > 0).map(cl => {
      const intensity = Math.max(0, Math.min(1, (cl.t1psf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
      return [cl.lat, cl.lng, intensity];
    });
    compHeatLayer = L.heatLayer(heatPts, {
      radius: 30, blur: 20, maxZoom: 17, max: 1.0, minOpacity: 0.25,
      pane: 'heatmapPane',
      gradient: { 0.0:'#3b82f6', 0.25:'#22d3ee', 0.50:'#22c55e', 0.75:'#eab308', 1.0:'#ef4444' }
    });
  } else {
    const HEAT_MIN = 600, HEAT_MAX = 1000;
    const heatPts = COMPS.filter(c => c.ppsf > 0).map(c => {
      const intensity = Math.max(0, Math.min(1, (c.ppsf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
      return [c.lat, c.lng, intensity];
    });
    compHeatLayer = L.heatLayer(heatPts, {
      radius: 25, blur: 15, maxZoom: 17, max: 1.0, minOpacity: 0.25,
      pane: 'heatmapPane',
      gradient: { 0.0:'#3b82f6', 0.25:'#22d3ee', 0.50:'#22c55e', 0.75:'#eab308', 1.0:'#ef4444' }
    });
  }

  if (layerState.compHeat) compHeatLayer.addTo(map);
}

var LAYER_COLORS = {listings:'#22c55e',neighborhoods:'#8b5cf6',offMarket:'#3b82f6',btr:'#f59e0b',parcels:'#3b82f6',fireZones:'#ef4444',floodZones:'#3b82f6',liquefaction:'#a855f7',markers:'#64748b',compHeat:'#f0641e'};
function toggleLayer(layer,btn){
  layerState[layer]=!layerState[layer];
  btn.classList.toggle('active');
  if(layer === 'compHeat'){
    document.getElementById('heatmapModeToggle').style.display = layerState.compHeat ? 'block' : 'none';
    document.getElementById('tierFilterSection').style.display = layerState.compHeat ? 'block' : 'none';
  }
  refreshVisibility();
  updateLayersActiveCount();
}
function toggleLayerRow(layer,btn){
  layerState[layer]=!layerState[layer];
  btn.classList.toggle('active');
  // Update dot color
  var dot=btn.querySelector('.ldot');
  if(dot) dot.style.background=layerState[layer]?(LAYER_COLORS[layer]||'#3b82f6'):'#cbd5e1';
  // Tinted border/bg for active state
  if(layerState[layer]){
    var c=LAYER_COLORS[layer]||'#3b82f6';
    btn.style.borderColor=c+'40';
    btn.style.background=c+'08';
  } else {
    btn.style.borderColor='#e2e8f0';
    btn.style.background='transparent';
  }
  if(layer === 'compHeat'){
    document.getElementById('heatmapModeToggle').style.display = layerState.compHeat ? 'block' : 'none';
    document.getElementById('tierFilterSection').style.display = layerState.compHeat ? 'block' : 'none';
  }
  refreshVisibility();
  updateLayersActiveCount();
}
function initLayerRowStates(){
  document.querySelectorAll('.layer-row.active,.layer-cell.active,.chip-btn.active').forEach(function(btn){
    var layer=btn.dataset.layer;
    if(!layer) return;
    var dot=btn.querySelector('.ldot');
    if(dot) dot.style.background=LAYER_COLORS[layer]||'#3b82f6';
    var c=LAYER_COLORS[layer]||'#3b82f6';
    if(btn.classList.contains('chip-btn')) return; // chips use CSS
    btn.style.borderColor=c+'40';
    btn.style.background=c+'08';
  });
}
function updateLayersActiveCount(){
  var n=0;
  ['listings','neighborhoods','offMarket','btr','parcels','fireZones','floodZones','liquefaction'].forEach(function(k){if(layerState[k])n++});
  var el=document.getElementById('layersActiveCount');
  if(el) el.textContent=n+' active';
}

function toggleSection(titleEl){
  titleEl.closest('.section').classList.toggle('collapsed');
}

function toggleListingsPanel(){
  const panel = document.getElementById('listingsPanel');
  const tab = document.getElementById('listingsPanelTab');
  listingsPanelOpen = !listingsPanelOpen;
  panel.classList.toggle('open', listingsPanelOpen);
  if(tab) tab.style.display = listingsPanelOpen ? 'none' : 'flex';
  if(isMobile() && listingsPanelOpen) setSheetState('collapsed');
  setTimeout(() => map.invalidateSize(), 350);
}

// ‚îÄ‚îÄ Panel resize ‚îÄ‚îÄ
(function(){
  const panel = document.getElementById('listingsPanel');
  const handle = document.getElementById('panelResize');
  let startY, startH;
  handle.addEventListener('mousedown', function(e){
    startY = e.clientY; startH = panel.offsetHeight;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    e.preventDefault();
  });
  handle.addEventListener('touchstart', function(e){
    startY = e.touches[0].clientY; startH = panel.offsetHeight;
    document.addEventListener('touchmove', onTouchMove, {passive:false});
    document.addEventListener('touchend', onTouchUp);
  }, {passive:true});
  function onMove(e){
    const diff = startY - e.clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
  }
  function onTouchMove(e){
    const diff = startY - e.touches[0].clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
    e.preventDefault();
  }
  function onUp(){
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    map.invalidateSize();
  }
  function onTouchUp(){
    document.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onTouchUp);
    map.invalidateSize();
  }
})();

// ‚îÄ‚îÄ Presets ‚îÄ‚îÄ
function toggleNewThisWeek(btn){
  // Support both old button and new checkbox style
  if(btn && btn.classList) {
    AppState.set('newThisWeekFilter', !newThisWeekFilter);
    btn.classList.toggle('active', newThisWeekFilter);
  } else {
    const cb = document.getElementById('newThisWeekCheckbox');
    AppState.set('newThisWeekFilter', cb ? cb.checked : !newThisWeekFilter);
  }
  applyFilters();
}

function setFilter(key, min, max){
  const f = filters[key];
  f.min = Math.max(f.dataMin, min);
  f.max = Math.min(f.dataMax, max);
  const sMin = document.getElementById(key+'SliderMin');
  const sMax = document.getElementById(key+'SliderMax');
  const iMin = document.getElementById(key+'Min');
  const iMax = document.getElementById(key+'Max');
  if(sMin) sMin.value = f.min;
  if(sMax) sMax.value = f.max;
  if(iMin) iMin.value = f.min;
  if(iMax) iMax.value = f.max;
  updateFill(key);
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
function updateStats(cachedListings, cachedComps){
  const filtered = cachedListings || getFilteredListings();

  // Listing count in layers panel
  const listingCountEl = document.getElementById('listingCount');
  if(listingCountEl) listingCountEl.textContent = filtered.length.toLocaleString();

  // Comp stats
  const compFiltered = cachedComps || getFilteredComps();
  const compCountEl = document.getElementById('compCount');
  if(compCountEl) compCountEl.textContent = compFiltered.length.toLocaleString();

  updatePeekStats(filtered);
  updateLayerCounts();
}

// Compute layer counts regardless of toggle state so sidebar shows what's available
function updateLayerCounts(){
  // Off-Market count ‚Äî same predicate as buildOffMarketLayer() but without _onForSaleLayer gate
  let offMarketN = 0;
  for(const l of LISTINGS){
    if(!l.sb1123Eligible) continue;
    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;
    const est_market_value = hood_psf * structure_sf;
    const est_offer = est_market_value * 0.95;
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);
    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf;
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const f_insurance = proforma.insurance || 40000;
    const f_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + f_insurance + f_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;
    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;
    const lotEff = l.lotEfficiency || 0;
    const slope = l.slope || 0;
    if(spread > 150 && margin_at_offer >= 0.25 && lotEff > 70 && !l.fireZone && slope < 15) offMarketN++;
  }
  const omEl = document.getElementById('offMarketCount');
  if(omEl) omEl.textContent = offMarketN.toLocaleString();

  // BTR count ‚Äî all BTR-viable deals (DSCR >= 1.25x gate)
  let btrN = 0;
  for(const l of LISTINGS){
    if(!l.sb1123Eligible) continue;
    if(!(l.estRentMonth > 0 || l.fmr3br > 0 || l.yocBase > 0)) continue;
    const btrPF = calculateBTRProForma(l);
    if(btrPF.btrPencils) btrN++;
  }
  const btrEl = document.getElementById('btrCount');
  if(btrEl) btrEl.textContent = btrN.toLocaleString();
}

function updateFilterCount(cachedComps, cachedListings){
  const comps = (cachedComps || getFilteredComps()).length;
  const listings = (cachedListings || getFilteredListings()).length;
  const fc = document.getElementById('filterCount');
  if(fc) fc.textContent = `${comps.toLocaleString()} comps | ${listings.toLocaleString()} listings`;
  const lpc = document.getElementById('listingPanelCount');
  if(lpc) lpc.textContent = `${listings} deals`;
}

let _otherZonesExpanded = false;
function rebuildZoneToggles(cachedComps, cachedListingsAllZones){
  const el=document.getElementById('zoneToggles');
  if(!el){ console.error('zoneToggles element not found!'); return; }
  el.innerHTML='';
  const filtered = cachedComps || getFilteredComps();
  // Count listings per zone ignoring zone toggle state (all other filters apply)
  const allFiltered = cachedListingsAllZones || getFilteredListings(true);

  function makeRow(zone){
    const zc=filtered.filter(c=>c.zone===zone);
    const zl=allFiltered.filter(l=>l.zone===zone);
    const psfs=zc.map(c=>c.ppsf||c.price/c.sqft);
    const avg=psfs.length?Math.round(psfs.reduce((a,b)=>a+b,0)/psfs.length):0;
    const div=document.createElement('label');
    div.className='zone-toggle';
    div.innerHTML=`
      <input type="checkbox" ${zoneState[zone]?'checked':''} onchange="toggleZone('${zone}',this.checked)">
      <span class="check-box"></span>
      <span class="zone-swatch" style="background:${ZONE_COLORS[zone]}"></span>
      <span class="zone-label">${zone} <small>${ZONE_LABELS[zone]}</small></span>
      <span class="zone-stat">${avg?'$'+avg+'/sf':'‚Äî'}<span class="data-count">${zl.length}</span></span>
    `;
    return div;
  }

  // R1 always visible
  el.appendChild(makeRow('R1'));

  // Collapsible group for R2-R4, LAND
  const otherCount = ['R2','R3','R4','LAND'].reduce((n,z)=>n+allFiltered.filter(l=>l.zone===z).length,0);
  const header = document.createElement('div');
  header.style.cssText = 'display:flex;align-items:center;gap:6px;padding:6px 10px;cursor:pointer;font-size:11px;color:var(--text-dim);user-select:none';
  header.innerHTML = `<span id="otherZoneChevron" style="font-size:9px;transition:transform 0.15s;transform:rotate(${_otherZonesExpanded?'90':'0'}deg)">‚ñ∂</span> Other Zones <span class="data-count" style="margin-left:auto">${otherCount}</span>`;
  header.onclick = function(){
    _otherZonesExpanded = !_otherZonesExpanded;
    document.getElementById('otherZoneChevron').style.transform = 'rotate('+(_otherZonesExpanded?90:0)+'deg)';
    document.getElementById('otherZoneRows').style.display = _otherZonesExpanded ? 'block' : 'none';
  };
  el.appendChild(header);

  const otherRows = document.createElement('div');
  otherRows.id = 'otherZoneRows';
  otherRows.style.display = _otherZonesExpanded ? 'block' : 'none';
  ['R2','R3','R4','LAND'].forEach(z => otherRows.appendChild(makeRow(z)));
  el.appendChild(otherRows);
  // Update zoning bar summary (R1 stats)
  var r1c=filtered.filter(c=>c.zone==='R1');
  var r1psfs=r1c.map(c=>c.ppsf||c.price/c.sqft);
  var r1avg=r1psfs.length?Math.round(r1psfs.reduce((a,b)=>a+b,0)/r1psfs.length):0;
  var zbn=document.getElementById('zoningBarName');
  var zbp=document.getElementById('zoningBarPsf');
  var zbsw=document.querySelector('.zoning-bar .zone-sw');
  if(zbn) zbn.textContent='R1';
  if(zbp) zbp.textContent=r1avg?'$'+r1avg+'/sf':'';
  if(zbsw && typeof ZONE_COLORS!=='undefined') zbsw.style.background=ZONE_COLORS.R1||'#3b82f6';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SORTABLE TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getSortValue(l, key){
  if(key==='fav') return isFavorite(l)?1:0;
  if(key==='isNew') return l.isNew ? 2 : l.isNewThisWeek ? 1 : 0;
  if(key==='lw') return l.lw||0;
  if(key==='maxUnits') return l.maxUnits||1;
  if(key==='pricePerUnit') return l.pricePerUnit||Infinity;
  if(key==='salePerUnit') return l.salePerUnit||0;
  if(key==='estProfit') return l.estProfit||(-Infinity);
  if(key==='estMargin') return l.estMargin||(-Infinity);
  const v=l[key]; return v===null||v===undefined ? -Infinity : v;
}

function sortTable(key){
  if(currentSort.key===key) currentSort.dir = currentSort.dir==='asc'?'desc':'asc';
  else{
    currentSort.key=key;
    currentSort.dir = (typeof getSortValue(LISTINGS[0]||{},key)==='string')?'asc':'desc';
  }
  document.querySelectorAll('.listings-table th').forEach(th=>{
    th.classList.remove('sorted');
    const arrow = th.querySelector('.sort-arrow');
    if(arrow) arrow.textContent='‚ñ≤';
  });
  const th=document.querySelector(`.listings-table th[data-sort="${key}"]`);
  if(th){
    th.classList.add('sorted');
    const arrow = th.querySelector('.sort-arrow');
    if(arrow) arrow.textContent=currentSort.dir==='asc'?'‚ñ≤':'‚ñº';
  }
  rebuildTable(getFilteredListings());
}

function rebuildTable(filtered){
  const tbody = document.getElementById('listingsTableBody');
  
  // Only sort if we have a valid sort key
  let sorted = filtered;
  if (currentSort && currentSort.key) {
    sorted = [...filtered].sort((a,b) => {
      let va=getSortValue(a,currentSort.key), vb=getSortValue(b,currentSort.key);
      if(typeof va==='string') va=va.toLowerCase();
      if(typeof vb==='string') vb=vb.toLowerCase();
      if(va<vb) return currentSort.dir==='asc'?-1:1;
      if(va>vb) return currentSort.dir==='asc'?1:-1;
      return 0;
    });
  }

  // Cap table rows for performance
  const display = sorted.slice(0, 500);

  tbody.innerHTML = display.map(l => {
    const zoneColor = ZONE_COLORS[l.zone]||'#666';
    const profitClass = (l.estProfit||0)>=0?'profit-pos':'profit-neg';
    const marginClass = (l.estMargin||0)>=0?'profit-pos':'profit-neg';
    const starred = isFavorite(l);
    const exitPpsf = l.clusterT1psf || l.newconPpsf || l.exitPsf;
    return `<tr onclick="flyToListing(${l.lat},${l.lng})" onmouseenter="highlightMarker(${l.lat},${l.lng})" onmouseleave="unhighlightMarker()">
      <td class="col-fav"><span class="fav-star ${starred?'active':''}" onclick="event.stopPropagation();toggleFavorite(${l.lat},${l.lng})">&#9733;</span></td>
      <td class="col-addr" title="${l.address}">${l.address}</td>
      <td class="col-zone"><span class="zone-pill" style="background:${zoneColor}22;color:${zoneColor}">${l.zone||'‚Äî'}</span></td>
      <td class="col-price mono">$${l.price.toLocaleString()}</td>
      <td class="col-lot mono">${l.lotSf?l.lotSf.toLocaleString():'‚Äî'}</td>
      <td class="col-lotw mono">${l.lw?l.lw+"'":'\u2014'}</td>
      <td class="col-units mono" style="color:${l.maxUnits>=8?'var(--green)':l.maxUnits>=4?'var(--yellow)':'var(--text-dim)'}">${l.maxUnits}${l.layoutNote?' <span style="font-size:9px;color:var(--orange)" title="'+l.layoutNote+'">&#9888;</span>':''}</td>
      <td class="col-hood mono">${exitPpsf?'$'+exitPpsf:'‚Äî'}</td>
      <td class="col-sale mono">${l.salePerUnit?'$'+(l.salePerUnit).toLocaleString():'‚Äî'}</td>
      <td class="col-ppu mono">$${(l.pricePerUnit||0).toLocaleString()}</td>
      <td class="col-profit mono ${profitClass}">${(l.estProfit||0)>=0?'\u2713':'\u2717'} $${Math.round(l.estProfit||0).toLocaleString()}</td>
      <td class="col-margin mono ${marginClass}">${(l.estMargin||0)>=0?'\u2713':'\u2717'} ${(l.estMargin||0).toFixed(0)}%</td>
      <td class="col-slope mono" style="color:${l.slope!=null?(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)'):'var(--text-dim)'}">${l.slope!=null?(l.slope>=15?'\u25B2 ':'')+l.slope+'%':'‚Äî'}${l.slopeScore!=null?' <span style="font-size:9px;color:'+(l.slopeScore<=20?'var(--green)':l.slopeScore<=50?'var(--yellow)':l.slopeScore<=75?'var(--orange)':'var(--red)')+'">S'+l.slopeScore+'</span>':''}</td>
      <td class="col-dom mono">${l.dom!==null&&l.dom!==undefined?l.dom:'‚Äî'}</td>
      <td class="col-new">${l.isNew?'<span class="new-badge">NEW</span>':l.isNewThisWeek?'<span class="new-badge week">7d</span>':''}</td>
      <td class="col-link">${l.url?'<a class="redfin-link" href="'+l.url+'" target="_blank" onclick="event.stopPropagation()">View</a>':''}</td>
    </tr>`;
  }).join('');

  const countStr = sorted.length > 500 ? `${sorted.length} deals (showing 500)` : `${sorted.length} deals`;
  const tablePanelCount = document.getElementById('tablePanelCount');
  if(tablePanelCount) tablePanelCount.textContent = countStr;
  const tabPanelCount = document.getElementById('tabPanelCount');
  if(tabPanelCount) tabPanelCount.textContent = `${sorted.length} deals`;
  rebuildMobileCards(sorted);
}

function flyToListing(lat, lng){
  if(isMobile()){
    if(listingsPanelOpen) toggleListingsPanel();
    setSheetState('collapsed');
  }
  map.flyTo([lat, lng], 16, {duration:0.8});
  listingsLayer.eachLayer(layer => {
    if(layer.getLatLng){
      const ll = layer.getLatLng();
      if(Math.abs(ll.lat-lat)<0.0001 && Math.abs(ll.lng-lng)<0.0001) layer.openPopup();
    }
  });
}

let _highlightedPath = null;
function highlightMarker(lat, lng){
  unhighlightMarker();
  listingsLayer.eachLayer(layer => {
    if(!layer.getLatLng || !layer._path) return;
    const ll = layer.getLatLng();
    if(Math.abs(ll.lat - lat) < 0.0001 && Math.abs(ll.lng - lng) < 0.0001){
      layer._path.classList.add('marker-highlight');
      _highlightedPath = layer._path;
    }
  });
}
function unhighlightMarker(){
  if(_highlightedPath){ _highlightedPath.classList.remove('marker-highlight'); _highlightedPath = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTER MACHINERY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initRangeFilter(key, valueFn, dataSource){
  const f = filters[key];
  const source = dataSource || COMPS;
  const values = source.map(valueFn).filter(v => v > 0);
  if(!values.length) return;
  let vMin = Infinity, vMax = -Infinity;
  for(let i=0;i<values.length;i++){ if(values[i]<vMin) vMin=values[i]; if(values[i]>vMax) vMax=values[i]; }
  f.dataMin = Math.floor(vMin / f.step) * f.step;
  f.dataMax = Math.ceil(vMax / f.step) * f.step;
  if(f.cap && f.dataMax > f.cap) f.dataMax = f.cap;
  f.min = f.dataMin; f.max = f.dataMax;
  if(f.defaultMin != null && f.defaultMin >= f.dataMin) f.min = Math.min(f.defaultMin, f.dataMax);
  if(f.defaultMax != null && f.defaultMax <= f.dataMax) f.max = Math.max(f.defaultMax, f.dataMin);

  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  sMin.min=f.dataMin; sMin.max=f.dataMax; sMin.value=f.min; sMin.step=f.step;
  sMax.min=f.dataMin; sMax.max=f.dataMax; sMax.value=f.max; sMax.step=f.step;
  iMin.value=f.min; iMax.value=f.max;
  updateFill(key);

  let timer=null;
  function debounced(){ clearTimeout(timer); timer=setTimeout(applyFilters, 250); }
  sMin.addEventListener('input', function(){
    let v=parseInt(this.value); if(v>parseInt(sMax.value)-f.step) v=parseInt(sMax.value)-f.step;
    this.value=v; iMin.value=v; f.min=v; updateFill(key); debounced();
  });
  sMax.addEventListener('input', function(){
    let v=parseInt(this.value); if(v<parseInt(sMin.value)+f.step) v=parseInt(sMin.value)+f.step;
    this.value=v; iMax.value=v; f.max=v; updateFill(key); debounced();
  });
  iMin.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMin; v=Math.max(f.dataMin,Math.min(v,f.max-f.step));
    this.value=v; sMin.value=v; f.min=v; updateFill(key); applyFilters();
  });
  iMax.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMax; v=Math.min(f.dataMax,Math.max(v,f.min+f.step));
    this.value=v; sMax.value=v; f.max=v; updateFill(key); applyFilters();
  });
}

function updateFill(key){
  const f=filters[key], fill=document.getElementById(key+'SliderFill');
  if(!fill) return;
  const range=f.dataMax-f.dataMin; if(range<=0) return;
  fill.style.left=((f.min-f.dataMin)/range)*100+'%';
  fill.style.width=((f.max-f.min)/range)*100+'%';
  // Update range labels
  if(key==='lot'){
    var lm=document.getElementById('lotRangeMin'),lx=document.getElementById('lotRangeMax');
    if(lm) lm.textContent=fmtSf(f.min);
    if(lx) lx.textContent=fmtSf(f.max);
  } else if(key==='margin'){
    var mm=document.getElementById('marginRangeMin'),mx=document.getElementById('marginRangeMax');
    if(mm) mm.textContent=f.min+'%';
    if(mx) mx.textContent=f.max+'%';
  }
}
function fmtSf(v){return v>=1000?(v/1000).toFixed(v%1000?1:0).replace(/\.0$/,'')+'K sf':v+' sf'}

function setMarginPreset(minPct,btn){
  document.querySelectorAll('.preset-row .preset-btn, .kf-chips .kf-chip').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const f=filters.margin;
  f.min=minPct; f.max=f.dataMax;
  const sMin=document.getElementById('marginSliderMin'), sMax=document.getElementById('marginSliderMax');
  const iMin=document.getElementById('marginMin'), iMax=document.getElementById('marginMax');
  if(sMin) sMin.value=minPct;
  if(iMin) iMin.value=minPct;
  if(sMax) sMax.value=f.dataMax;
  if(iMax) iMax.value=f.dataMax;
  updateFill('margin');
  applyFilters();
}

// ‚îÄ‚îÄ URL Hash Filter State ‚îÄ‚îÄ
function encodeFiltersToHash(){
  var parts = [];
  var keys = ['price','margin','lot','lotw','slope','psf','sqft'];
  keys.forEach(function(k){
    var f = filters[k];
    if(f.min !== f.dataMin || f.max !== f.dataMax){
      parts.push(k + '=' + f.min + ',' + f.max);
    }
  });
  var zones = ['R1','R2','R3','R4','LAND'].filter(function(z){ return zoneState[z]; });
  if(zones.join(',') !== 'R1') parts.push('zone=' + zones.join(','));
  if(minUnitsFilter !== 4) parts.push('units=' + minUnitsFilter);
  if(currentSort && currentSort.key) parts.push('sort=' + currentSort.key + ',' + currentSort.dir);
  if(sb1123Mode) parts.push('sb1123=1');
  if(favoritesOnly) parts.push('favs=1');
  if(!hideBurnZones) parts.push('burn=1');
  if(newThisWeekFilter) parts.push('new=1');
  var hash = parts.length ? '#' + parts.join('&') : '';
  if(window.location.hash !== hash) window.history.replaceState(null, '', hash || window.location.pathname + window.location.search);
}

function decodeFiltersFromHash(){
  if(!location.hash || location.hash.length < 2) return false;
  var pairs = location.hash.slice(1).split('&');
  var applied = false;
  pairs.forEach(function(pair){
    var eq = pair.indexOf('=');
    if(eq < 0) return;
    var k = pair.slice(0, eq), v = pair.slice(eq + 1);
    if(filters[k]){
      var vals = v.split(',');
      if(vals.length === 2){
        var mn = parseFloat(vals[0]), mx = parseFloat(vals[1]);
        if(!isNaN(mn) && !isNaN(mx)){
          filters[k].min = mn;
          filters[k].max = mx;
          var sMin = document.getElementById(k+'SliderMin'), sMax = document.getElementById(k+'SliderMax');
          var iMin = document.getElementById(k+'Min'), iMax = document.getElementById(k+'Max');
          if(sMin){ sMin.value = mn; } if(sMax){ sMax.value = mx; }
          if(iMin){ iMin.value = mn; } if(iMax){ iMax.value = mx; }
          updateFill(k);
          applied = true;
        }
      }
    } else if(k === 'zone'){
      var zList = v.split(',');
      ['R1','R2','R3','R4','LAND'].forEach(function(z){ zoneState[z] = zList.indexOf(z) >= 0; });
      applied = true;
    } else if(k === 'units'){
      minUnitsFilter = parseInt(v) || 4;
      var slider = document.getElementById('minUnitsSlider');
      var label = document.getElementById('minUnitsLabel');
      if(slider) slider.value = minUnitsFilter;
      if(label) label.textContent = minUnitsFilter;
      applied = true;
    } else if(k === 'sort'){
      var sp = v.split(',');
      if(sp.length === 2) currentSort = { key: sp[0], dir: sp[1] };
      applied = true;
    } else if(k === 'sb1123' && v === '1'){ sb1123Mode = true; applied = true; }
    else if(k === 'favs' && v === '1'){ AppState.set('favoritesOnly', true); applied = true; }
    else if(k === 'burn' && v === '1'){ AppState.set('hideBurnZones', false); applied = true; }
    else if(k === 'new' && v === '1'){ AppState.set('newThisWeekFilter', true); applied = true; }
  });
  return applied;
}

function applyFilters(){
  // Cache filtered results once ‚Äî avoid re-filtering on every sub-call
  var _cachedComps = getFilteredComps();
  var _cachedListings = getFilteredListings();
  var _cachedListingsAllZones = getFilteredListings(true);

  rebuildMarkers(_cachedComps);
  rebuildListings(_cachedListings);
  if(layerState.btr) buildBTRLayer(_cachedListings);
  if(layerState.neighborhoods) buildNeighborhoodLayer();
  if(layerState.offMarket) buildOffMarketLayer();
  rebuildZoneToggles(_cachedComps, _cachedListingsAllZones);
  updateStats(_cachedListings, _cachedComps);
  updateFilterCount(_cachedComps, _cachedListings);
  updateStatPills(_cachedListings, _cachedComps);
  refreshVisibility();
  applyPolygonOpacity();
  encodeFiltersToHash();
}


function resetFilter(key){
  if(key==='all'){
    ['margin','price','psf','sqft','lot','lotw','slope'].forEach(k=>resetFilter(k));
    AppState.set('newThisWeekFilter', false);
    var ntwCb=document.getElementById('newThisWeekCheckbox'); if(ntwCb) ntwCb.checked=false;
    resetMinUnits();
    document.querySelectorAll('.preset-btn,.kf-chip').forEach(b=>b.classList.remove('active'));
    // Re-activate the 30%+ chip as default
    var defChip=document.querySelector('.kf-chip');
    if(defChip) defChip.classList.add('active');
    return;
  }
  const f=filters[key]; f.min=f.dataMin; f.max=f.dataMax;
  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  if(sMin) sMin.value=f.dataMin;
  if(sMax) sMax.value=f.dataMax;
  if(iMin) iMin.value=f.dataMin;
  if(iMax) iMax.value=f.dataMax;
  updateFill(key);
  applyFilters();
}

var _proformaTimer = null;
function onProformaChange(){
  clearTimeout(_proformaTimer);
  _proformaTimer = setTimeout(function(){
    clearProformaCaches();
    proforma.allInBuildPsf = parseInt(document.getElementById('pfBuildCost').value)||360;
    proforma.avgUnitSf = parseInt(document.getElementById('pfUnitSize').value)||1750;
    proforma.txnCostPct = parseFloat(document.getElementById('pfTxnCost').value)||4.7;
    proforma.fixedDispositionCosts = parseInt(document.getElementById('pfFixedDisp').value)||40000;
    proforma.demoCost = parseInt(document.getElementById('pfDemoCost').value)||55000;
    proforma.holdMonths = parseInt(document.getElementById('pfHoldMonths').value)||24;
    proforma.carryRatePct = parseFloat(document.getElementById('pfCarryRate').value)||9;
    proforma.insurance = parseInt(document.getElementById('pfInsurance').value)||40000;
    proforma.originationPct = parseFloat(document.getElementById('pfOrigination').value)||1;
    proforma.ellisPerUnit = parseInt(document.getElementById('pfEllisPerUnit').value)||20000;
    enrichListings();
    applyFilters();
  }, 300);
}

// Export ‚Äî see js/export.js

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPOSE FUNCTIONS FOR INLINE onclick/onchange HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.advanceOnboarding = advanceOnboarding;
window.closeAssumptionsModal = closeAssumptionsModal;
window.closeDataKeyModal = closeDataKeyModal;
window.copyRefreshCmd = copyRefreshCmd;
window.dismissOnboarding = dismissOnboarding;
window.exportCSV = exportCSV;
window.exportModel = exportModel;
window.exportOM = exportOM;
window.flyToListing = flyToListing;
window.hideCompsTable = hideCompsTable;
window.hideRentalCompsTable = hideRentalCompsTable;
window.highlightMarker = highlightMarker;
window.onMinUnitsChange = onMinUnitsChange;
window.onProformaChange = onProformaChange;
window.openAssumptionsModal = openAssumptionsModal;
window.openMobileSheet = openMobileSheet;
window.resetFilter = resetFilter;
window.setBaseMap = setBaseMap;
window.setMarginPreset = setMarginPreset;
window.sharePin = sharePin;
window.showCompsTable = showCompsTable;
window.showRentalCompsTable = showRentalCompsTable;
window.sortCompsTable = sortCompsTable;
window.sortRentalCompsTable = sortRentalCompsTable;
window.sortTable = sortTable;
window.toggleBurnZoneFilter = toggleBurnZoneFilter;
window.toggleDealCard = toggleDealCard;
window.toggleFavorite = toggleFavorite;
window.toggleFavoritesFilter = toggleFavoritesFilter;
window.toggleLayerRow = toggleLayerRow;
window.toggleListingsPanel = toggleListingsPanel;
window.toggleZone = toggleZone;
window.unhighlightMarker = unhighlightMarker;
window.updateCompPoints = updateCompPoints;

// Variables referenced by inline handlers
window.map = map;
window.tierState = tierState;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Wire comps module dependencies
initComps({
  getMap: function(){ return map; },
  getLISTINGS: function(){ return LISTINGS; },
  getCOMPS: function(){ return COMPS; },
  getRENTAL_COMPS: function(){ return RENTAL_COMPS; },
  getCompSpatialGrid: function(){ return compSpatialGrid; },
  getRentalCompGrid: function(){ return rentalCompGrid; },
  isListingsPanelOpen: function(){ return listingsPanelOpen; },
  toggleListingsPanel: function(){ toggleListingsPanel(); },
});

// Wire draw module dependencies
initDraw({
  getMap: function(){ return map; },
  applyFilters: function(){ applyFilters(); },
  getOffMarketLayer: function(){ return offMarketLayer; },
  getBtrLayer: function(){ return btrLayer; },
  getMarkerLayers: function(){ return markerLayers; },
});

// Wire export module dependencies
initExport({
  getFilteredListings: getFilteredListings,
  loadFavorites: loadFavorites,
  listingKey: listingKey,
  findCompsForListing: findCompsForListing,
  exitLabel: exitLabel,
  getLISTINGS: function(){ return LISTINGS; },
});

window.addEventListener('DOMContentLoaded', function(){
  // Market-specific UI setup
  document.getElementById('marketSubtitle').textContent = MARKET.subtitle;
  if(!MARKET.burnZones) document.getElementById('burnZoneSection').style.display='none';
  else if(MARKET.burnZoneLabel) document.getElementById('burnZoneLabel').innerHTML='Hide Burn Zones <small>('+MARKET.burnZoneLabel+')</small>';
  // Market switcher ‚Äî cycle through all markets except current
  var otherSlugs = Object.keys(MARKET_CONFIG).filter(function(s){return s!==MARKET.slug;});
  var switchLink = document.getElementById('marketSwitchLink');
  if(otherSlugs.length === 1){
    var otherCfg = MARKET_CONFIG[otherSlugs[0]];
    switchLink.href = '?market='+otherSlugs[0];
    switchLink.textContent = otherCfg.name.split(' ').map(function(w){return w[0]}).join('')+' \u2197';
    switchLink.title = 'Switch to '+otherCfg.name;
  } else if(otherSlugs.length > 1){
    // Multiple other markets ‚Äî show dropdown on click
    switchLink.textContent = '\u2630 Markets';
    switchLink.title = 'Switch market';
    switchLink.href = '#';
    switchLink.onclick = function(e){
      e.preventDefault();
      var existing = document.getElementById('marketDropdown');
      if(existing){ existing.remove(); return; }
      var dd = document.createElement('div');
      dd.id = 'marketDropdown';
      dd.style.cssText = 'position:absolute;top:100%;right:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px 0;z-index:999;min-width:140px;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
      otherSlugs.forEach(function(s){
        var cfg = MARKET_CONFIG[s];
        var a = document.createElement('a');
        a.href = '?market='+s;
        a.textContent = cfg.name;
        a.style.cssText = 'display:block;padding:6px 14px;color:var(--text);text-decoration:none;font-size:12px';
        a.onmouseenter = function(){this.style.background='var(--border)'};
        a.onmouseleave = function(){this.style.background='transparent'};
        dd.appendChild(a);
      });
      switchLink.parentElement.style.position = 'relative';
      switchLink.parentElement.appendChild(dd);
      setTimeout(function(){document.addEventListener('click',function close(){dd.remove();document.removeEventListener('click',close)})},0);
    };
  }
  var analyticsLink = document.getElementById('analyticsLink');
  if(MARKET.slug!=='la') analyticsLink.href='analytics.html?market='+MARKET.slug;

  if(typeof LOADED_COMPS !== 'undefined' && LOADED_COMPS.length > 0) COMPS = LOADED_COMPS;
  if(typeof LOADED_LISTINGS !== 'undefined' && LOADED_LISTINGS.length > 0) LISTINGS = LOADED_LISTINGS;
  if(typeof LOADED_RENTAL_COMPS !== 'undefined' && LOADED_RENTAL_COMPS.length > 0){
    RENTAL_COMPS = LOADED_RENTAL_COMPS;
    rentalCompGrid = buildRentalCompGrid(RENTAL_COMPS);
    console.log('Rental comps loaded:', RENTAL_COMPS.length, 'grid cells:', Object.keys(rentalCompGrid).length);
  }

  // Stamp each listing with nearest cluster's T1 normalized exit $/SF
  if(CLUSTERS.length && LISTINGS.length){
    LISTINGS.forEach(function(l){
      var best = null, bestD = Infinity;
      for(var ci = 0; ci < CLUSTERS.length; ci++){
        var cl = CLUSTERS[ci];
        var d = Math.abs(cl.lat - l.lat) + Math.abs(cl.lng - l.lng);
        if(d < bestD){ bestD = d; best = cl; }
      }
      if(best && bestD < 0.01 && best.t1psf > 0){
        l.clusterT1psf = best.t1psf;
        l.clusterT1n = best.t1n || 0;
        l.clusterRw = best.rw || 0;
        l.clusterFb = best.t1fb;
      }
    });
  }

  if(COMPS.length > 0 || LISTINGS.length > 0){
    document.getElementById('loadingBanner').classList.add('active');
    document.getElementById('loadingBanner').textContent =
      `Loading ${COMPS.length.toLocaleString()} comps + ${LISTINGS.length.toLocaleString()} listings...`;

    setTimeout(function(){
      // Enrich listings with deal scores
      enrichListings();

      // Init filters (use comps if available, fall back to listings)
      var filterSource = COMPS.length ? COMPS : LISTINGS;
      initRangeFilter('price', c=>c.price, filterSource);
      initRangeFilter('psf', c=>c.ppsf||Math.round(c.price/c.sqft), filterSource);
      initRangeFilter('sqft', c=>c.sqft, filterSource);
      const lotsWithData = LISTINGS.filter(l=>l.lotSf&&l.lotSf>0);
      if(lotsWithData.length) initRangeFilter('lot', l=>l.lotSf||0, lotsWithData);
      const withLotW = LISTINGS.filter(l=>l.lw&&l.lw>0);
      if(withLotW.length) initRangeFilter('lotw', l=>l.lw||0, withLotW);
      const withSlope = LISTINGS.filter(l=>l.slope!=null);
      if(withSlope.length) initRangeFilter('slope', l=>l.slope!=null?l.slope:0, withSlope);
      const withMargin = LISTINGS.filter(l=>l.estMargin!=null);
      if(withMargin.length) initRangeFilter('margin', l=>l.estMargin||0, withMargin);

      // Restore filter state from URL hash if present
      decodeFiltersFromHash();

      // Restore soft filter UI from AppState (localStorage persistence)
      if(minUnitsFilter !== 4){
        var muSlider = document.getElementById('minUnitsSlider');
        var muLabel = document.getElementById('minUnitsLabel');
        if(muSlider) muSlider.value = minUnitsFilter;
        if(muLabel) muLabel.textContent = minUnitsFilter;
      }
      if(favoritesOnly){
        var favBtn = document.getElementById('favToggle');
        if(favBtn) favBtn.classList.add('active');
      }
      if(!hideBurnZones){
        var bzCb = document.getElementById('hideBurnZones');
        if(bzCb) bzCb.checked = false;
      }
      if(newThisWeekFilter){
        var ntwCb = document.getElementById('newThisWeekCheckbox');
        if(ntwCb) ntwCb.checked = true;
      }

      // Build $/SF heatmap layer from sold comps
      if(COMPS.length && typeof L.heatLayer === 'function'){
        // **CRITICAL FIX**: Clamp heatmap to $600-$1,000 decision range
        const HEAT_MIN = 600;
        const HEAT_MAX = 1000;
        const heatPts = COMPS.filter(c=>c.ppsf>0).map(c=>{
          // Normalize $/SF to 0-1 intensity within $600-$1,000 range
          const intensity = Math.max(0, Math.min(1, (c.ppsf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
          return [c.lat, c.lng, intensity];
        });
        compHeatLayer = L.heatLayer(heatPts, {
          radius: 25,
          blur: 15,
          maxZoom: 17,
          max: 1.0,
          minOpacity: 0.25,
          pane:'heatmapPane',
          gradient: {
            0.0:  '#3b82f6',  // $600 ‚Äî blue (cool)
            0.25: '#22d3ee',  // $700 ‚Äî cyan
            0.50: '#22c55e',  // $800 ‚Äî green
            0.75: '#eab308',  // $900 ‚Äî yellow
            1.0:  '#ef4444'   // $1,000 ‚Äî red (hot)
          }
        });
        document.getElementById('heatCount').textContent = heatPts.length.toLocaleString();
        compCanvasRenderer = L.canvas({padding:0.5});
        compSpatialGrid = buildCompGrid(COMPS);
        map.on('moveend', updateCompPoints);
        map.on('zoomend', updateCompPoints);
      }
      
      // Set sort BEFORE building table
      currentSort = { key: 'estMargin', dir: 'desc' };
      
      rebuildMarkers();
      rebuildListings();
      rebuildZoneToggles();
      refreshVisibility();
      updateStats();
      updateFilterCount();
      updateFavCount();
      updateStatPills();
      updateLayersActiveCount();
      initLayerRowStates();
      updatePinLegend();
      initDrawControl();
      showOnboardingIfNeeded();
      
      // Ensure Saved Deals button starts in correct visual state
      document.getElementById('favToggle').classList.remove('active');

      // Fit bounds
      const allLats=[...COMPS.map(c=>c.lat),...LISTINGS.map(l=>l.lat)];
      const allLngs=[...COMPS.map(c=>c.lng),...LISTINGS.map(l=>l.lng)];
      if(allLats.length){
        let minLat=Infinity,maxLat=-Infinity,minLng=Infinity,maxLng=-Infinity;
        for(let i=0;i<allLats.length;i++){
          if(allLats[i]<minLat) minLat=allLats[i]; if(allLats[i]>maxLat) maxLat=allLats[i];
          if(allLngs[i]<minLng) minLng=allLngs[i]; if(allLngs[i]>maxLng) maxLng=allLngs[i];
        }
        map.fitBounds([[minLat,minLng],[maxLat,maxLng]],{padding:[50,50]});
      }


      // Update visual sort indicators to match current sort
      const th=document.querySelector('.listings-table th[data-sort="estMargin"]');
      if(th){
        th.classList.add('sorted');
        th.querySelector('.sort-arrow').textContent='‚ñº';
      }

      // Data freshness indicator
      if(typeof LISTINGS_META !== 'undefined' && LISTINGS_META.builtAt){
        const built = new Date(LISTINGS_META.builtAt);
        const ago = Math.floor((Date.now() - built.getTime()) / 3600000);
        const freshEl = document.getElementById('dataFreshness');
        function ageDot(days){ return days<0?'':'<span style="color:'+(days<1?'var(--green)':days<3?'var(--yellow)':days<30?'var(--orange)':'var(--red)')+'">&#9679;</span>'; }
        function ageStr(days){ return days<0?'?':days<1?'<1d':Math.round(days)+'d'; }
        var parts = [];
        if(LISTINGS_META.listingsAge!=null) parts.push(ageDot(LISTINGS_META.listingsAge)+' Listings: '+ageStr(LISTINGS_META.listingsAge));
        if(LISTINGS_META.compsAge!=null) parts.push(ageDot(LISTINGS_META.compsAge)+' Comps: '+ageStr(LISTINGS_META.compsAge));
        if(LISTINGS_META.parcelsAge!=null&&LISTINGS_META.parcelsAge>=0) parts.push(ageDot(LISTINGS_META.parcelsAge)+' Parcels: '+ageStr(LISTINGS_META.parcelsAge));
        if(parts.length) freshEl.innerHTML = parts.join(' &middot; ');
        else if(ago < 24) freshEl.innerHTML = '<span style="color:var(--green)">&#9679;</span> Data updated ' + ago + 'h ago';
        else if(ago < 72) freshEl.innerHTML = '<span style="color:var(--yellow)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' day(s) old';
        else freshEl.innerHTML = '<span style="color:var(--red)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' days stale ‚Äî re-run fetch';
      }

      document.getElementById('loadingBanner').classList.remove('active');
      
      // Check for shared pin URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const pinParam = urlParams.get('pin');
      if(pinParam){
        const coords = pinParam.split(',');
        if(coords.length === 2){
          const lat = parseFloat(coords[0]);
          const lng = parseFloat(coords[1]);
          if(!isNaN(lat) && !isNaN(lng)){
            // Pan to the shared pin location
            map.setView([lat, lng], 17);
            // Find and open the popup for this pin
            setTimeout(function(){
              // Check all layers for a marker at this location
              var found = false;
              const layers = [listingsLayer, btrLayer, offMarketLayer];
              layers.forEach(layer => {
                if(layer && !found){
                  layer.eachLayer(marker => {
                    if(found) return;
                    const pos = marker.getLatLng();
                    if(Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001){
                      marker.openPopup();
                      found = true;
                    }
                  });
                }
              });
              // Fallback: listing may be filtered out ‚Äî open popup directly from LISTINGS data
              if(!found){
                var pinListing = LISTINGS.find(function(x){
                  return Math.abs(x.lat - lat) < 0.0001 && Math.abs(x.lng - lng) < 0.0001;
                });
                if(pinListing){
                  L.popup({maxWidth:660, className:'deal-popup'})
                    .setLatLng([lat, lng])
                    .setContent(generateDealCard(pinListing))
                    .openOn(map);
                }
              }
            }, 500);
          }
        }
      }
    }, 100);
  } else {
    rebuildZoneToggles();
    updateStats();
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOBILE OPTIMIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function isMobile() { return window.innerWidth <= 768; }
var sheetState = 'collapsed';

function setSheetState(state) {
  if (!isMobile()) return;
  var sidebar = document.querySelector('.sidebar');
  sheetState = state;
  sidebar.classList.remove('sheet-half', 'sheet-full');
  if (state === 'half') sidebar.classList.add('sheet-half');
  else if (state === 'full') sidebar.classList.add('sheet-full');
  if (state === 'collapsed') {
    sidebar.scrollTop = 0;
    var scrollEl = sidebar.querySelector('.sidebar-scroll');
    if(scrollEl) scrollEl.scrollTop = 0;
  }
}

function openMobileSheet() {
  setSheetState('full');
}

function updatePeekStats(cachedListings) {
  var el = document.getElementById('peekEligible');
  var ml = document.getElementById('peekMargin');
  if (!el || !ml) return;
  var filtered = cachedListings || getFilteredListings();
  var eligible = filtered.filter(function(l){ return l.sb1123Eligible; });
  var positiveMargin = eligible.filter(function(l){ return l.estMargin > 0; });
  var avgM = positiveMargin.length ? Math.round(positiveMargin.reduce(function(s,l){ return s+l.estMargin; },0)/positiveMargin.length) : 0;
  el.textContent = eligible.length;
  ml.textContent = avgM + '%';
}

function rebuildMobileCards(sorted) {
  var container = document.getElementById('mobileCards');
  if (!container) return;
  var display = sorted.slice(0, 200);
  container.innerHTML = display.map(function(l) {
    var marginClass = (l.estMargin || 0) >= 0 ? 'profit-pos' : 'profit-neg';
    var profitK = Math.round((l.estProfit || 0) / 1000);
    var profitStr = profitK >= 0 ? '+$' + profitK.toLocaleString() + 'K' : '-$' + Math.abs(profitK).toLocaleString() + 'K';
    var newBadge = l.isNew ? ' <span class="new-badge">NEW</span>' : (l.isNewThisWeek ? ' <span class="new-badge week">7d</span>' : '');
    return '<div class="mobile-card" onclick="flyToListing(' + l.lat + ',' + l.lng + ')">' +
      '<div class="card-addr">' + l.address + newBadge + '</div>' +
      '<div class="card-grid">' +
        '<div class="card-row"><span class="card-label">Zone</span><span class="card-value" style="color:' + (ZONE_COLORS[l.zone] || '#666') + '">' + (l.zone || '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Price</span><span class="card-value">$' + l.price.toLocaleString() + '</span></div>' +
        '<div class="card-row"><span class="card-label">Lot</span><span class="card-value">' + (l.lotSf ? l.lotSf.toLocaleString() + ' sf' : '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Units</span><span class="card-value">' + l.maxUnits + '</span></div>' +
      '</div>' +
      '<div class="card-margin-row">' +
        '<span class="card-profit ' + marginClass + '">' + profitStr + '</span>' +
        '<span class="card-margin ' + marginClass + '">' + (l.estMargin || 0).toFixed(0) + '%</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

// Sheet touch drag
(function initSheetDrag() {
  var handle = document.getElementById('sheetHandle');
  if (!handle) return;
  var startY, startH, sidebar, isDragging;

  handle.addEventListener('touchstart', function(e) {
    if (!isMobile()) return;
    isDragging = false;
    sidebar = document.querySelector('.sidebar');
    startY = e.touches[0].clientY;
    startH = sidebar.offsetHeight;
    sidebar.style.transition = 'none';
  }, { passive: true });

  handle.addEventListener('touchmove', function(e) {
    if (!isMobile() || !sidebar) return;
    isDragging = true;
    var dy = startY - e.touches[0].clientY;
    var newH = Math.max(56, Math.min(window.innerHeight * 0.85, startH + dy));
    sidebar.style.height = newH + 'px';
    e.preventDefault();
  }, { passive: false });

  handle.addEventListener('touchend', function() {
    if (!isMobile() || !sidebar) return;
    sidebar.style.transition = '';
    if (!isDragging) {
      // Tap: toggle between collapsed and half
      if (sheetState === 'collapsed') setSheetState('half');
      else setSheetState('collapsed');
      sidebar.style.height = '';
      return;
    }
    var h = sidebar.offsetHeight;
    var vh = window.innerHeight;
    if (h < vh * 0.2) setSheetState('collapsed');
    else if (h < vh * 0.6) setSheetState('half');
    else setSheetState('full');
    sidebar.style.height = '';
  });
})();

// Tap map to collapse sheet + neighborhood pricing card
map.on('click', function(e) {
  // Mobile: collapse sheet first
  if (isMobile() && sheetState !== 'collapsed') {
    setSheetState('collapsed');
    return;
  }

  // Neighborhood pricing card at zoom >= 14
  if (map.getZoom() < 14 || !CLUSTERS.length) return;

  var lat = e.latlng.lat, lng = e.latlng.lng;
  var nearest = null, minDist = Infinity;
  CLUSTERS.forEach(function(cl) {
    var d = Math.abs(cl.lat - lat) + Math.abs(cl.lng - lng);
    if (d < minDist) { minDist = d; nearest = cl; }
  });

  if (!nearest || minDist > 0.01) return;

  var t1psf = nearest.t1psf || 0;
  var t2psf = nearest.t2psf || 0;
  var prem = nearest.prem || (t1psf - t2psf);
  var t1n = nearest.t1n || 0;
  var t2n = nearest.t2n || 0;
  var rw = nearest.rw || 0;

  // Confidence: based on recency weight AND T1 count
  var confLabel, confDots;
  if (rw >= 0.8 && t1n >= 8) { confLabel = 'High'; confDots = 4; }
  else if (rw >= 0.5 && t1n >= 4) { confLabel = 'Medium'; confDots = 3; }
  else if (t1n >= 2) { confLabel = 'Low'; confDots = 2; }
  else { confLabel = 'Low'; confDots = 1; }

  var dots = '';
  for (var di = 0; di < 4; di++) {
    dots += '<span style="display:inline-block;width:8px;height:8px;border-radius:50;margin-right:2px;background:' + (di < confDots ? '#14b8a6' : '#2e3140') + '"></span>';
  }

  // Find zip from nearest listing
  var nearestListing = null, nlDist = Infinity;
  LISTINGS.forEach(function(ll) {
    var d2 = Math.abs(ll.lat - nearest.lat) + Math.abs(ll.lng - nearest.lng);
    if (d2 < nlDist) { nlDist = d2; nearestListing = ll; }
  });
  var zipLabel = nearestListing ? (nearestListing.zip || '') : '';
  var cityLabel = nearestListing ? (nearestListing.city || '') : '';
  var locLine = (zipLabel ? zipLabel + ' ¬∑ ' : '') + cityLabel;

  // Compute T1 raw median from nearby comps for display
  var cellComps = COMPS.filter(function(c) {
    return Math.abs(c.lat - nearest.lat) < 0.004 && Math.abs(c.lng - nearest.lng) < 0.004;
  });
  var t1Raw = cellComps.filter(function(c) { return c.t === 1; }).map(function(c) { return c.ppsf; }).sort(function(a,b){return a-b;});
  var t1RawMedian = t1Raw.length ? t1Raw[Math.floor(t1Raw.length / 2)] : t1psf;

  var html = '<div style="min-width:260px;font-family:DM Sans,sans-serif">'
    // Header
    + '<div style="padding-bottom:8px;border-bottom:1px solid #2e3140;margin-bottom:10px">'
    + '  <div style="font-size:13px;font-weight:600;color:#e4e6ed">' + locLine + '</div>'
    + '  <div style="font-size:11px;color:#8b8fa3;margin-top:3px">' + dots + ' ' + confLabel + ' (' + t1n + ' T1)</div>'
    + '</div>'
    // Primary metric
    + '<div style="padding-bottom:10px;border-bottom:1px solid #2e3140;margin-bottom:10px">'
    + '  <div style="font-size:11px;color:#8b8fa3;margin-bottom:4px">T1 Exit $/SF (@ 1,750 SF)</div>'
    + '  <div style="font-family:JetBrains Mono,monospace;font-size:28px;font-weight:700;color:#14b8a6">$' + t1psf.toLocaleString() + '</div>'
    + '</div>'
    // Breakdown rows
    + '<div style="padding-bottom:10px;border-bottom:1px solid #2e3140;margin-bottom:10px;font-size:12px">'
    + '  <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:#8b8fa3">T1 Raw Median</span><span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">$' + t1RawMedian.toLocaleString() + '</span></div>'
    + '  <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:#8b8fa3">T2 Baseline</span><span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">$' + t2psf.toLocaleString() + '</span></div>'
    + (prem > 0 ? '  <div style="display:flex;justify-content:space-between"><span style="color:#8b8fa3">Remodel Premium</span><span style="font-family:JetBrains Mono,monospace;color:#14b8a6">+$' + prem.toLocaleString() + '</span></div>' : '')
    + '</div>'
    // Footer stats
    + '<div style="display:flex;justify-content:space-between;font-size:11px">'
    + '  <div><span style="color:#8b8fa3">Recency</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + rw.toFixed(2) + '</span></div>'
    + '  <div><span style="color:#8b8fa3">T1</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + t1n + '</span></div>'
    + '  <div><span style="color:#8b8fa3">T2</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + t2n + '</span></div>'
    + '</div></div>';

  L.popup({className:'dark-popup'}).setLatLng(e.latlng).setContent(html).openOn(map);
});
</script>
</body>
</html>
