<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SB 1123 Deal Finder ‚Äî LA County</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js" onerror="console.warn('esri-leaflet failed to load')"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
<script>
// Market config ‚Äî select via ?market=sd URL param (default: la)
var _urlMarket = new URLSearchParams(window.location.search).get('market') || 'la';
var MARKET_CONFIG = {
  la: { name:'Los Angeles', slug:'la', center:[34.05,-118.35], zoom:11,
        dataFile:'data.js', listingsFile:'listings.js', rentalDataFile:'rental_data.js',
        burnZones:true, subtitle:'Townhome development sites in Los Angeles' },
  sd: { name:'San Diego', slug:'sd', center:[32.77,-117.15], zoom:10,
        dataFile:'sd_data.js', listingsFile:'sd_listings.js', rentalDataFile:'sd_rental_data.js',
        burnZones:false, subtitle:'Townhome development sites in San Diego' }
};
var MARKET = MARKET_CONFIG[_urlMarket] || MARKET_CONFIG.la;
document.title = 'SB 1123 Deal Finder ‚Äî ' + MARKET.name;
var TEMPLATE_B64 = "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";

// Mobile: skip 25MB comps file, load only listings (already has pre-computed $/SF)
// Desktop: load both
var _isMob = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
if(!_isMob){
  document.write('<script src="'+MARKET.dataFile+'?v=7"><\/script>');
}
document.write('<script src="'+MARKET.listingsFile+'?v=7"><\/script>');
document.write('<script src="'+(MARKET.rentalDataFile||'rental_data.js')+'?v=7"><\/script>');
window.LOADED_COMPS = window.LOADED_COMPS || [];
window.LOADED_LISTINGS = window.LOADED_LISTINGS || [];
window.CLUSTERS = window.CLUSTERS || [];
window.LOADED_RENTAL_COMPS = window.LOADED_RENTAL_COMPS || [];
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,500;9..40,700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --r1:#2563eb;--r2:#16a34a;--r3:#ea580c;--r4:#9333ea;--land:#b45309;
    --listing:#f43f5e;
    --bg:#0f1117;--surface:#1a1d27;--surface2:#252833;
    --border:#2e3140;--text:#e4e6ed;--text-dim:#8b8fa3;--accent:#60a5fa;
    --green:#22c55e;--red:#ef4444;--yellow:#facc15;--orange:#f97316;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}
  body.light-mode{
    --bg:#f5f5f5;--surface:#ffffff;--surface2:#e8e8e8;
    --border:#d0d0d0;--text:#1a1a2e;--text-dim:#666;--accent:#2563eb;
  }
  .mono{font-family:'JetBrains Mono',monospace}

  .app-row{display:flex;flex:1;overflow:hidden}

  /* ‚îÄ‚îÄ Hero Stat Bar ‚îÄ‚îÄ */
  .hero-stats{
    background:rgba(96,165,250,0.06);border-bottom:1px solid var(--border);
    padding:8px 20px;display:flex;align-items:center;justify-content:center;
    gap:20px;font-size:12px;font-weight:500;white-space:nowrap;
    overflow-x:auto;z-index:900;
  }
  .hero-stats .stat-item{display:flex;align-items:center;gap:6px}
  .hero-stats .stat-value{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--accent)}
  .hero-stats .stat-value.green{color:var(--green)}
  .hero-stats .separator{color:var(--border);font-weight:300}
  .onboarding-tip{position:absolute;top:140px;left:50%;transform:translateX(-50%);max-width:500px;background:#fff;border:2px solid var(--green);border-radius:8px;padding:12px 40px 12px 16px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:2000;font-size:13px;line-height:1.5;animation:slideIn 0.3s ease-out}
  .onboarding-tip .close-btn{position:absolute;top:8px;right:8px;background:none;border:none;font-size:20px;color:var(--text-dim);cursor:pointer;padding:4px 8px;line-height:1}
  .onboarding-tip .close-btn:hover{color:var(--text)}
  @keyframes slideIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar{width:360px;min-width:360px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:1000;overflow-y:auto}
  .sidebar-header{padding:20px 20px 14px;border-bottom:1px solid var(--border)}
  .sidebar-header h1{font-size:17px;font-weight:700;letter-spacing:-0.02em;margin-bottom:2px}
  .sidebar-header h1 span{color:var(--green)}
  .sidebar-header p{font-size:11px;color:var(--text-dim);line-height:1.5}
  .sidebar-header .law-ref{font-size:10px;color:var(--accent);margin-top:4px;opacity:0.7}

  .section{padding:14px 20px;border-bottom:1px solid var(--border)}
  .section-title{font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:10px;font-weight:700;display:flex;align-items:center;gap:6px}
  .section-title .badge{background:var(--green);color:#000;font-size:9px;padding:1px 6px;border-radius:3px;font-weight:700;letter-spacing:0.03em}

  /* Stats grid */
  .stats-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .stats-grid.two-col{grid-template-columns:1fr 1fr}
  .stat-card{background:var(--surface2);border-radius:8px;padding:10px 12px}
  .stat-card .stat-value{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:600;color:var(--accent)}
  .stat-card .stat-value.green{color:var(--green)}
  .stat-card .stat-value.yellow{color:var(--yellow)}
  .stat-card .stat-value.red{color:var(--red)}
  .stat-card .stat-label{font-size:10px;color:var(--text-dim);margin-top:2px}

  /* SB9 mode toggle */
  .mode-toggle{
    display:flex;align-items:center;gap:10px;padding:10px 14px;
    border-radius:8px;cursor:pointer;transition:all 0.2s;
    border:1px solid var(--border);background:transparent;width:100%;
    font-family:inherit;font-size:13px;color:var(--text);
  }
  .mode-toggle:hover{border-color:var(--green);background:rgba(34,197,94,0.04)}
  .mode-toggle.active{border-color:var(--green);background:rgba(34,197,94,0.08)}
  .mode-toggle .toggle-track{
    width:36px;height:20px;border-radius:10px;background:var(--surface2);
    border:1px solid var(--border);position:relative;transition:all 0.2s;flex-shrink:0;
  }
  .mode-toggle.active .toggle-track{background:var(--green);border-color:var(--green)}
  .mode-toggle .toggle-thumb{
    width:16px;height:16px;border-radius:50%;background:#fff;
    position:absolute;top:1px;left:1px;transition:all 0.2s;
  }
  .mode-toggle.active .toggle-thumb{left:17px}
  .mode-toggle .toggle-label{flex:1}
  .mode-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Zone toggles */
  .zone-toggle{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:8px;cursor:pointer;transition:background 0.15s;margin-bottom:2px}
  .zone-toggle:hover{background:var(--surface2)}
  .zone-swatch{width:12px;height:12px;border-radius:3px;flex-shrink:0}
  .zone-toggle input[type="checkbox"]{display:none}
  .zone-toggle .check-box{width:16px;height:16px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.15s}
  .zone-toggle input:checked+.check-box{border-color:var(--accent);background:var(--accent)}
  .zone-toggle input:checked+.check-box::after{content:'‚úì';color:#fff;font-size:10px;font-weight:700}
  .zone-label{font-size:12px;flex:1}
  .zone-label small{color:var(--text-dim);font-size:10px}
  .zone-stat{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim)}
  .data-count{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);background:rgba(96,165,250,0.1);padding:1px 5px;border-radius:3px;margin-left:3px}

  /* Basemap toggle */
  .basemap-group{display:flex;gap:4px}
  .basemap-btn{flex:1;padding:6px 0;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:11px;font-weight:500;transition:all 0.15s}
  .basemap-btn:hover{border-color:var(--accent)}
  .basemap-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.15);color:var(--accent)}

  /* Layer buttons */
  .layer-btn{display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);cursor:pointer;font-family:inherit;font-size:12px;margin-bottom:4px;transition:all 0.15s}
  .layer-btn:hover{border-color:var(--accent)}
  .layer-btn.active{border-color:var(--accent);background:rgba(96,165,250,0.08)}
  .layer-btn .icon{font-size:14px}
  .layer-btn .layer-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim);margin-left:auto}

  /* Range filters */
  .range-filter{margin-top:2px}
  .range-inputs{display:flex;gap:6px;align-items:center;margin-bottom:8px}
  .range-inputs input[type="number"]{
    width:100%;padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;
    outline:none;transition:border 0.15s;
  }
  .range-inputs input[type="number"]:focus{border-color:var(--accent)}
  .range-inputs .separator{color:var(--text-dim);font-size:12px;flex-shrink:0}
  .range-inputs .input-group{flex:1}
  .range-inputs .input-label{font-size:9px;color:var(--text-dim);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.08em}

  .range-slider-track{position:relative;height:5px;background:var(--surface2);border-radius:3px;margin:0 4px 10px}
  .range-slider-fill{position:absolute;height:100%;background:var(--accent);border-radius:3px;opacity:0.4}
  .range-slider-track input[type="range"]{
    position:absolute;width:100%;height:5px;top:-4px;
    -webkit-appearance:none;appearance:none;background:transparent;pointer-events:none;
  }
  .range-slider-track input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;
    background:var(--accent);border:2px solid var(--bg);cursor:pointer;pointer-events:auto;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }

  .filter-count{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);text-align:center;padding:6px 0;background:rgba(96,165,250,0.06);border-radius:6px}
  .reset-btn{
    display:block;width:100%;padding:6px;margin-top:6px;background:transparent;
    border:1px solid var(--border);border-radius:6px;color:var(--text-dim);
    font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;text-align:center;
  }
  .reset-btn:hover{border-color:var(--accent);color:var(--accent)}

  /* Pro forma assumptions */
  .proforma-inputs{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  .proforma-group{display:flex;flex-direction:column;gap:2px}
  .proforma-group label{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em}
  .proforma-group input{
    padding:6px 8px;background:var(--surface2);border:1px solid var(--border);
    border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;
    outline:none;width:100%;
  }
  .proforma-group input:focus{border-color:var(--accent)}

  /* Quick presets */
  .preset-row{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
  .preset-btn{
    padding:4px 10px;border:1px solid var(--border);border-radius:4px;
    background:transparent;color:var(--text-dim);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;
  }
  .preset-btn:hover{border-color:var(--green);color:var(--green)}
  .preset-btn.active{border-color:var(--green);background:rgba(34,197,94,0.1);color:var(--green)}

  /* Map */
  #map{flex:1;height:100%;z-index:1}

  /* Popups */
  .leaflet-popup-content-wrapper{background:var(--surface)!important;color:var(--text)!important;border-radius:10px!important;border:1px solid var(--border)!important;box-shadow:0 8px 32px rgba(0,0,0,0.5)!important}
  .leaflet-popup-tip{background:var(--surface)!important}
  .leaflet-popup-content{font-family:'DM Sans',sans-serif!important;margin:12px 14px!important;min-width:340px;max-width:750px}
  .dark-popup .leaflet-popup-content{min-width:260px}
  .popup-two-col{display:flex;gap:14px;max-height:75vh;width:710px}
  .popup-col-left,.popup-col-right{flex:1;min-width:0;overflow-y:auto;padding-right:4px}
  .popup-col-left::-webkit-scrollbar,.popup-col-right::-webkit-scrollbar{width:4px}
  .popup-col-left::-webkit-scrollbar-thumb,.popup-col-right::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
  .popup-col-left::-webkit-scrollbar-track,.popup-col-right::-webkit-scrollbar-track{background:transparent}
  .popup-title{font-weight:700;font-size:14px;margin-bottom:8px;line-height:1.3}
  .popup-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;margin-right:4px}
  .popup-badge.comp{background:rgba(96,165,250,0.15);color:var(--accent)}
  .popup-badge.listing{background:rgba(244,63,94,0.15);color:var(--listing)}
  .popup-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:3px 10px}
  .popup-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:3px 10px}
  .popup-grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:3px 12px}
  .popup-label{font-size:10px;color:var(--text-dim);line-height:1.2}
  .popup-value{font-family:'JetBrains Mono',monospace;font-size:11.5px;font-weight:600;line-height:1.3}
  .popup-divider{grid-column:1/-1;border-top:1px solid var(--border);margin:5px 0 3px 0}
  .popup-section-label{grid-column:1/-1;font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);font-weight:700;margin-top:2px;margin-bottom:2px}
  .popup-span-2{grid-column:span 2}
  .popup-span-3{grid-column:span 3}
  .popup-span-4{grid-column:span 4}
  .popup-profit-positive{color:var(--green)}
  .popup-profit-negative{color:var(--red)}
  .lot-layout-toggle{grid-column:1/-1;cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);font-weight:700;margin-top:4px;padding:4px 0;display:flex;align-items:center;gap:6px;border-top:1px solid var(--border)}
  .lot-layout-toggle:hover{color:var(--text)}
  .lot-layout-toggle .tri{font-size:8px;transition:transform 0.2s}
  .lot-layout-toggle.open .tri{transform:rotate(90deg)}
  .lot-layout-body{grid-column:1/-1;overflow:hidden;max-height:0;transition:max-height 0.4s ease-out}
  .lot-layout-body.open{max-height:2000px;transition:max-height 0.5s ease-in}
  .lot-layout-body svg{display:block;margin:4px auto 0;max-width:100%}
  /* Deal Scorecard */
  .popup-scorecard{display:grid;grid-template-columns:repeat(4,1fr);gap:2px 8px;padding:6px 8px;margin-bottom:8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px}
  .popup-scorecard .sc-label{font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);line-height:1.2}
  .popup-scorecard .sc-value{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;line-height:1.3}
  /* Action links bar */
  .popup-links{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:8px}
  .popup-links a{color:var(--accent);font-size:10px;text-decoration:none;white-space:nowrap}
  .popup-links a:hover{text-decoration:underline}
  /* Collapsible toggle (generic) */
  .popup-collapse-toggle{cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;padding:2px 0;display:flex;align-items:center;gap:5px}
  .popup-collapse-toggle:hover{color:var(--text)}
  .popup-collapse-toggle .tri{font-size:8px;transition:transform 0.2s}
  .popup-collapse-toggle.open .tri{transform:rotate(90deg)}
  .popup-collapse-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease-out}
  .popup-collapse-body.open{max-height:800px;transition:max-height 0.4s ease-in}

  /* Deal Card ‚Äî Variant B (compact strip + expandable drawer) */
  .deal-popup .leaflet-popup-content{min-width:380px;max-width:520px;margin:0!important;padding:0!important}
  .dp-card{font-family:'DM Sans',sans-serif;font-size:12px;color:var(--text)}

  /* Strip (always visible) */
  .dp-strip{display:grid;grid-template-columns:2fr repeat(4,1fr) 44px;align-items:center;gap:0;padding:8px 10px;cursor:pointer;border-bottom:1px solid var(--border)}
  .dp-strip:hover{background:var(--surface2)}
  .dp-addr{font-weight:700;font-size:13px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .dp-addr small{display:block;font-weight:400;font-size:10px;color:var(--text-dim);margin-top:1px}
  .dp-metric{text-align:right}
  .dp-metric .dp-val{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;line-height:1.2}
  .dp-metric .dp-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.04em}
  .dp-toggle{display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--text-dim);transition:transform 0.2s}
  .dp-card.expanded .dp-toggle{transform:rotate(180deg)}

  /* Badges row */
  .dp-badges{display:flex;gap:4px;flex-wrap:wrap;padding:4px 10px 0}

  /* Drawer (hidden until expanded) */
  .dp-drawer{max-height:0;overflow:hidden;transition:max-height 0.35s ease-out}
  .dp-card.expanded .dp-drawer{max-height:2000px;transition:max-height 0.4s ease-in}
  .dp-drawer-inner{padding:8px 10px 10px}

  /* 3-column body */
  .dp-body{display:grid;grid-template-columns:1.3fr 1fr 1fr;gap:8px 12px;margin-bottom:8px}
  .dp-col{min-width:0}
  .dp-col-head{font-size:9px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin-bottom:4px;padding-bottom:2px;border-bottom:1px solid var(--border)}
  .dp-row{display:flex;justify-content:space-between;font-size:11px;line-height:1.6}
  .dp-row .dp-k{color:var(--text-dim)}
  .dp-row .dp-v{font-family:'JetBrains Mono',monospace;font-weight:600;text-align:right}

  /* BTR strip */
  .dp-btr{padding:6px 10px;background:var(--surface2);border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(4,1fr);gap:4px 8px}
  .dp-btr .dp-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase}
  .dp-btr .dp-val{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600}

  /* DD bar + actions */
  .dp-dd{padding:4px 10px;font-size:10px;color:var(--text-dim);border-top:1px solid var(--border)}
  .dp-actions{display:flex;gap:6px;justify-content:center;padding:6px 10px 8px;border-top:1px solid var(--border)}
  .dp-actions button{padding:4px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:inherit;font-size:11px;cursor:pointer}
  .dp-actions button:hover{border-color:#facc15}
  .dp-actions button.active{border-color:#facc15;background:rgba(250,204,21,0.1);color:#facc15}

  /* Links row */
  .dp-links{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:4px 10px}
  .dp-links a{color:var(--accent);font-size:10px;text-decoration:none}
  .dp-links a:hover{text-decoration:underline}

  /* BTR scenarios table */
  .dp-btr-scenarios{padding:6px 10px;border-top:1px solid var(--border)}
  .dp-btr-scenarios table{width:100%;font-size:11px;font-family:'JetBrains Mono',monospace;border-collapse:collapse}
  .dp-btr-scenarios td{padding:1px 4px}

  /* Lot layout toggle in drawer */
  .dp-lot-toggle{cursor:pointer;user-select:none;font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin-top:4px;display:flex;align-items:center;gap:5px}
  .dp-lot-toggle:hover{color:var(--text)}
  .dp-lot-toggle .tri{font-size:8px;transition:transform 0.2s}
  .dp-lot-toggle.open .tri{transform:rotate(90deg)}
  .dp-lot-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease-out}
  .dp-lot-body.open{max-height:2000px;transition:max-height 0.4s ease-in}
  .dp-lot-body svg{display:block;margin:4px auto 0;max-width:100%}

  @media (max-width: 768px){
    .dp-body{grid-template-columns:1fr;gap:6px}
    .dp-strip{grid-template-columns:1.5fr repeat(2,1fr) 36px;font-size:11px}
    .dp-strip .dp-metric:nth-child(4),.dp-strip .dp-metric:nth-child(5){display:none}
  }

  /* Pin Color Legend */
  .pin-legend{
    position:absolute;bottom:10px;left:10px;
    background:rgba(26,29,39,0.92);border:1px solid var(--border);border-radius:8px;
    padding:8px 10px;z-index:850;font-size:10px;box-shadow:0 2px 12px rgba(0,0,0,0.4);
  }
  body.light-mode .pin-legend{background:rgba(255,255,255,0.92)}
  .pin-legend-item{display:flex;align-items:center;gap:6px;margin-bottom:2px;line-height:1.4}
  .pin-legend-item:last-child{margin-bottom:0}
  .pin-legend-marker{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .pin-legend-marker.diamond{border-radius:0;transform:rotate(45deg);border:1.5px dashed #d97706;background:rgba(245,158,11,0.85)}
  .pin-legend-marker.circle{border:2px solid #666;background:transparent}

  /* Old Legend (keep for desktop reference) */
  .map-legend{position:absolute;bottom:30px;right:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;z-index:800;font-size:11px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:none}
  .legend-item{display:flex;align-items:center;gap:8px;margin-bottom:3px}
  .legend-item:last-child{margin-bottom:0}
  .legend-dot{width:10px;height:10px;border-radius:2px}
  .legend-section{font-size:9px;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);margin:6px 0 3px;font-weight:700}

  .sidebar::-webkit-scrollbar{width:6px}
  .sidebar::-webkit-scrollbar-track{background:transparent}
  .sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .loading-banner{padding:10px 20px;background:rgba(96,165,250,0.1);border-bottom:1px solid var(--border);font-size:12px;color:var(--accent);text-align:center;display:none}
  .loading-banner.active{display:block}

  /* ‚îÄ‚îÄ Listings Table Panel ‚îÄ‚îÄ */
  .listings-panel{
    position:relative;height:0;min-height:0;background:var(--surface);
    border-top:1px solid var(--border);transition:height 0.3s ease, min-height 0.3s ease;
    overflow:hidden;z-index:900;
  }
  .listings-panel.open{height:360px;min-height:200px}
  .listings-panel-header{
    display:flex;align-items:center;gap:10px;padding:8px 20px;
    border-bottom:1px solid var(--border);background:var(--surface);
    position:sticky;top:0;z-index:2;
  }
  .listings-panel-header h2{font-size:13px;font-weight:700;letter-spacing:-0.01em}
  .listings-panel-header h2 span{color:var(--green)}
  .listings-panel-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent);background:rgba(96,165,250,0.1);padding:2px 6px;border-radius:4px}
  .listings-panel-close{margin-left:auto;background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:4px 8px;border-radius:4px;transition:all 0.15s}
  .listings-panel-close:hover{color:var(--text);background:var(--surface2)}
  .listings-panel-tab{
    position:absolute;bottom:0;left:50%;transform:translateX(-50%);
    background:var(--surface);border:1px solid var(--border);border-bottom:none;
    border-radius:8px 8px 0 0;padding:5px 18px;cursor:pointer;z-index:901;
    display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;
    color:var(--text-dim);transition:all 0.15s;
  }
  .listings-panel-tab:hover{color:var(--text);background:var(--surface2)}
  .listings-panel-tab .tab-arrow{font-size:9px}
  .listings-panel-tab .tab-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--accent)}
  .listings-panel-resize{position:absolute;top:0;left:0;right:0;height:5px;cursor:ns-resize;z-index:3}
  .listings-panel-resize:hover{background:var(--accent);opacity:0.3}
  .listings-table-wrap{overflow:auto;height:calc(100% - 41px)}
  .listings-table-wrap::-webkit-scrollbar{width:6px;height:6px}
  .listings-table-wrap::-webkit-scrollbar-track{background:transparent}
  .listings-table-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

  .listings-table{width:100%;border-collapse:collapse;font-size:11px;table-layout:fixed;min-width:1300px}
  .listings-table thead{position:sticky;top:0;z-index:1}
  .listings-table th{
    background:var(--surface2);padding:7px 10px;text-align:left;font-size:9px;
    text-transform:uppercase;letter-spacing:0.1em;color:var(--text-dim);font-weight:700;
    cursor:pointer;white-space:nowrap;border-bottom:1px solid var(--border);
    user-select:none;transition:color 0.15s;position:relative;
  }
  .listings-table th:hover{color:var(--accent)}
  .listings-table th.sorted{color:var(--accent)}
  .listings-table th .sort-arrow{display:inline-block;margin-left:3px;font-size:8px;opacity:0;transition:opacity 0.15s}
  .listings-table th.sorted .sort-arrow{opacity:1}
  .listings-table th:hover .sort-arrow{opacity:0.5}
  .listings-table td{padding:6px 10px;border-bottom:1px solid var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .listings-table tr{transition:background 0.1s}
  .listings-table tbody tr:hover{background:var(--surface2);cursor:pointer}

  .listings-table .col-addr{width:230px}
  .listings-table .col-zone{width:50px}
  .listings-table .col-price{width:95px}
  .listings-table .col-lot{width:75px}
  .listings-table .col-lotw{width:50px;text-align:right}
  .listings-table .col-units{width:55px}
  .listings-table .col-hood{width:80px}
  .listings-table .col-sale{width:90px}
  .listings-table .col-ppu{width:90px}
  .listings-table .col-profit{width:90px}
  .listings-table .col-margin{width:65px}
  .listings-table .col-slope{width:60px}
  .listings-table .col-dom{width:45px}
  .listings-table .col-new{width:40px;text-align:center}
  .listings-table .col-link{width:45px}

  .listings-table .zone-pill{display:inline-block;padding:1px 5px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:0.03em}
  .listings-table .redfin-link{color:var(--accent);text-decoration:none;font-size:10px}
  .listings-table .redfin-link:hover{text-decoration:underline}
  .listings-table .profit-pos{color:var(--green)}
  .listings-table .profit-neg{color:var(--red)}

  /* NEW listing badge */
  .new-badge{display:inline-block;padding:1px 6px;border-radius:9px;font-size:9px;font-weight:700;letter-spacing:0.04em;background:#22c55e;color:#fff;vertical-align:middle;margin-left:4px;line-height:1.4}
  .new-badge.week{background:#0ea5e9}
  .listing-marker-new{animation:newPulse 2s ease-in-out infinite}
  @keyframes newPulse{0%,100%{filter:drop-shadow(0 0 4px rgba(34,197,94,0.6))}50%{filter:drop-shadow(0 0 10px rgba(34,197,94,0.9))}}
  .marker-highlight{animation:markerPulse .5s ease-in-out infinite;transform-origin:center;transform-box:fill-box}
  @keyframes markerPulse{0%,100%{transform:scale(1);filter:drop-shadow(0 0 6px #fff)}50%{transform:scale(1.8);filter:drop-shadow(0 0 12px #fff)}}

  /* Panel toggle in sidebar */
  .panel-toggle{
    display:flex;align-items:center;justify-content:space-between;width:100%;
    padding:10px 12px;border:1px solid var(--green);border-radius:8px;
    background:rgba(34,197,94,0.06);color:var(--text);cursor:pointer;
    font-family:inherit;font-size:13px;transition:all 0.15s;
  }
  .panel-toggle:hover{background:rgba(34,197,94,0.12)}
  .panel-toggle .toggle-count{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--green)}

  /* Collapsible sections */
  .section.collapsed .section-content{display:none}
  .section-title{cursor:pointer}
  .section-title .chevron{transition:transform 0.2s;font-size:10px;margin-left:auto;color:var(--text-dim)}
  .section.collapsed .section-title .chevron{transform:rotate(-90deg)}

  /* Export button */
  .export-btn{
    display:block;width:100%;padding:8px;margin-top:6px;
    background:rgba(96,165,250,0.1);border:1px solid var(--accent);border-radius:6px;
    color:var(--accent);font-family:inherit;font-size:11px;cursor:pointer;
    transition:all 0.15s;text-align:center;
  }
  .export-btn:hover{background:rgba(96,165,250,0.2)}
  .refresh-btn{
    padding:4px 10px;background:rgba(34,197,94,0.1);border:1px solid var(--green);
    border-radius:4px;color:var(--green);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;white-space:nowrap;
  }
  .refresh-btn:hover{background:rgba(34,197,94,0.2)}
  .analytics-btn{
    padding:4px 10px;background:rgba(96,165,250,0.1);border:1px solid var(--accent);
    border-radius:4px;color:var(--accent);font-family:inherit;font-size:10px;
    cursor:pointer;transition:all 0.15s;white-space:nowrap;text-decoration:none;
  }
  .analytics-btn:hover{background:rgba(96,165,250,0.2)}

  /* Favorites */
  .listings-table .col-fav{width:32px;text-align:center;cursor:pointer}
  .fav-star{font-size:14px;cursor:pointer;opacity:0.3;transition:all 0.15s;user-select:none}
  .fav-star:hover{opacity:0.7;transform:scale(1.2)}
  .fav-star.active{opacity:1;color:#facc15}
  .fav-toggle{
    display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;
    background:var(--surface2);border:1px solid var(--border);border-radius:6px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .fav-toggle:hover:not(:disabled){border-color:var(--accent)}
  .fav-toggle:disabled{opacity:0.4;cursor:not-allowed;border-color:transparent;pointer-events:none}
  .fav-toggle.active{border-color:#facc15;background:rgba(250,204,21,0.08)}
  .fav-toggle .fav-count{margin-left:auto;font-family:'JetBrains Mono',monospace;color:#facc15;font-size:10px}
  .popup-fav-btn{
    display:inline-flex;align-items:center;gap:4px;padding:4px 10px;margin-top:6px;
    background:var(--surface2);border:1px solid var(--border);border-radius:4px;
    color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;transition:all 0.15s;
  }
  .popup-fav-btn:hover{border-color:#facc15}
  .popup-fav-btn.active{border-color:#facc15;background:rgba(250,204,21,0.1);color:#facc15}
  .comp-psf-label{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;color:#e2e8f0;text-shadow:0 0 3px rgba(0,0,0,0.9),0 0 6px rgba(0,0,0,0.7);white-space:nowrap;text-align:center;pointer-events:none}

  /* ‚îÄ‚îÄ Mobile: Bottom Sheet + Cards ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    html, body { height: 100vh; height: 100dvh; overflow-x: hidden; max-width: 100vw; }
    .app-row { position: relative; max-width: 100vw; overflow-x: hidden; }
    #map { width: 100% !important; }

    /* Sidebar ‚Üí Bottom sheet */
    .sidebar {
      position: fixed !important; bottom: 0; left: 0; right: 0;
      width: 100% !important; min-width: 0 !important;
      height: 56px; max-height: 85vh;
      border-right: none !important; border-top: 1px solid var(--border);
      border-radius: 16px 16px 0 0;
      z-index: 1100; transition: height 0.3s ease;
      overflow: hidden;
    }
    .sidebar.sheet-half { height: 40vh; overflow-y: auto; }
    .sidebar.sheet-full { height: 85vh; overflow-y: auto; }

    /* Sheet handle */
    .sheet-handle {
      display: flex; flex-direction: column; align-items: center;
      padding: 10px 16px 6px; cursor: grab;
      position: sticky; top: 0; z-index: 10; background: var(--surface);
      border-radius: 16px 16px 0 0;
    }
    .sheet-handle .handle-bar {
      width: 40px; height: 4px; background: var(--text-dim); border-radius: 2px;
      margin-bottom: 8px; opacity: 0.5;
    }
    .sheet-handle .peek-stats {
      display: flex; gap: 16px; font-size: 13px; font-weight: 500;
      width: 100%; justify-content: center;
    }
    .sheet-handle .peek-stats .peek-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--green);
    }

    /* Floating filter button */
    .mobile-filter-btn {
      display: flex !important; position: fixed; top: 12px; left: 12px; z-index: 1050;
      padding: 10px 16px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text); font-family: inherit; font-size: 13px;
      font-weight: 600; cursor: pointer; box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      align-items: center; gap: 8px;
    }

    .sidebar-header .refresh-btn { display: none; }
    .sidebar-header .analytics-btn { display: none; }

    /* Stats grid: 2 columns */
    .stats-grid { grid-template-columns: 1fr 1fr; }

    /* Pro forma: 1 column */
    .proforma-inputs { grid-template-columns: 1fr; }

    /* Range slider: bigger touch targets */
    .range-slider-track input[type="range"]::-webkit-slider-thumb {
      width: 24px; height: 24px;
    }
    .range-slider-track input[type="range"] { height: 24px; top: -12px; }

    /* Buttons: min 44px touch target */
    .mode-toggle, .layer-btn, .panel-toggle, .fav-toggle,
    .reset-btn, .export-btn { min-height: 44px; }
    .preset-btn, .basemap-btn { min-height: 40px; }

    /* Legend + panel tab: hide on mobile */
    .map-legend { display: none; }
    .listings-panel-tab { display: none !important; }

    /* Popup: mobile-friendly */
    .leaflet-popup-content { min-width: unset !important; max-width: unset !important; }
    .leaflet-popup-content-wrapper {
      max-height: 50vh; overflow-y: auto !important;
      max-width: calc(100vw - 40px) !important;
    }
    .popup-two-col { flex-direction: column; max-height: none; width: auto !important; }
    .popup-col-left,.popup-col-right { overflow-y: visible; padding-right: 0; }
    .popup-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 2px 8px; }
    .popup-grid-3 { grid-template-columns: repeat(2, 1fr) !important; }
    .popup-section-label { font-size: 10px; }
    .popup-scorecard { grid-template-columns: repeat(2, 1fr) !important; }
    .popup-scorecard .sc-value { font-size: 12px; }

    /* Pin legend: above bottom sheet */
    .pin-legend { bottom: 70px; }

    /* Onboarding tip: constrain to viewport */
    .onboarding-tip { max-width: calc(100vw - 24px); }

    /* Listings panel: full-screen overlay */
    .listings-panel {
      position: fixed !important; top: 0; left: 0; right: 0; bottom: 0;
      height: 0; min-height: 0; z-index: 1200; border-top: none;
      max-width: 100vw; overflow-x: hidden;
    }
    .listings-panel.open { height: 100% !important; min-height: 100% !important; }
    .listings-panel-resize { display: none; }
    .listings-panel-close {
      font-size: 24px; min-width: 44px; min-height: 44px;
      display: flex; align-items: center; justify-content: center;
    }

    /* Hide desktop table, show mobile cards */
    .listings-table-wrap { display: none; }
    .mobile-cards {
      display: block; padding: 10px 6px; overflow-y: auto; overflow-x: hidden;
      height: calc(100% - 45px); -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }

    /* Mobile card styling */
    .mobile-card {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 10px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.15s;
      min-width: 0; overflow: hidden; max-width: 100%;
    }
    .mobile-card:active { border-color: var(--accent); }
    .mobile-card .card-addr {
      font-weight: 600; font-size: 13px; margin-bottom: 8px; line-height: 1.3;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .mobile-card .card-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px; font-size: 12px;
      min-width: 0;
    }
    .mobile-card .card-row {
      display: flex; justify-content: space-between; gap: 4px; min-width: 0;
    }
    .mobile-card .card-label { color: var(--text-dim); font-size: 11px; }
    .mobile-card .card-value {
      font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 12px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .mobile-card .card-margin-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border);
    }
    .mobile-card .card-margin {
      font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700;
    }
    .mobile-card .card-profit {
      font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600;
    }

    /* Font scaling */
    .section-title { font-size: 11px; }
    .stat-card .stat-value { font-size: 18px; }
  }

  /* Desktop: hide mobile-only elements */
  @media (min-width: 769px) {
    .sheet-handle { display: none; }
    .mobile-filter-btn { display: none !important; }
    .mobile-cards { display: none !important; }
  }

  /* ‚îÄ‚îÄ BTR Opportunity Layer ‚îÄ‚îÄ */
  @keyframes btr-pulse {
    0% {
      transform: rotate(45deg) scale(1);
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.5);
    }
    50% {
      transform: rotate(45deg) scale(1.15);
      box-shadow: 0 0 12px 4px rgba(245, 158, 11, 0.25);
    }
    100% {
      transform: rotate(45deg) scale(1);
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
    }
  }

  .btr-pin {
    width: 12px;
    height: 12px;
    background: rgba(245, 158, 11, 0.85);
    border: 1.5px dashed #d97706;
    transform: rotate(45deg);
    animation: btr-pulse 2.5s ease-in-out infinite;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btr-pin:hover {
    animation: none;
    transform: rotate(45deg) scale(1.4);
    box-shadow: 0 0 16px 6px rgba(245, 158, 11, 0.4);
    background: rgba(245, 158, 11, 1);
  }

  /* BTR Tooltip Styles */
  .btr-tooltip {
    background: #1a1d27 !important;
    border: 1px solid #f59e0b !important;
    border-radius: 8px !important;
    color: #e4e6ed !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: 12px !important;
    padding: 10px 14px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4) !important;
    max-width: 280px !important;
  }

  .btr-tooltip .leaflet-tooltip-top::before {
    border-top-color: #f59e0b !important;
  }

  .btr-tooltip .tooltip-header {
    color: #f59e0b;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .btr-tooltip .tooltip-addr {
    font-weight: 500;
    margin-bottom: 8px;
  }

  .btr-tooltip .tooltip-row {
    display: flex;
    justify-content: space-between;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 2px 0;
  }

  .btr-tooltip .tooltip-row .label {
    color: #8b8fa3;
  }

  .btr-tooltip .gap-negative {
    color: #f87171;
  }

  /* ‚îÄ‚îÄ Deal Assumptions Modal ‚îÄ‚îÄ */
  .modal-overlay{
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.7);z-index:2000;display:none;
    align-items:center;justify-content:center;
  }
  .modal-overlay.active{display:flex}
  .modal-panel{
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    width:90%;max-width:500px;max-height:80vh;overflow-y:auto;
    box-shadow:0 8px 32px rgba(0,0,0,0.5);
  }
  .modal-header{
    padding:16px 20px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;
  }
  .modal-header h3{font-size:15px;font-weight:700;letter-spacing:-0.01em}
  .modal-close{
    background:none;border:none;color:var(--text-dim);cursor:pointer;
    font-size:24px;padding:0;width:28px;height:28px;border-radius:4px;
    transition:all 0.15s;display:flex;align-items:center;justify-content:center;
  }
  .modal-close:hover{color:var(--text);background:var(--surface2)}
  .modal-body{padding:20px}
  .data-key-panel{max-width:640px}
  .data-key-section{margin-bottom:16px}
  .data-key-section h4{font-size:12px;text-transform:uppercase;letter-spacing:0.08em;color:var(--accent);font-weight:700;margin:0 0 8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
  .data-key-item{margin-bottom:10px}
  .data-key-item dt{font-weight:700;font-size:12px;color:var(--text);margin-bottom:2px}
  .data-key-item dd{margin:0;font-size:11px;color:var(--text-dim);line-height:1.5}
  .gear-icon{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:28px;border-radius:6px;cursor:pointer;
    color:var(--text-dim);transition:all 0.15s;margin-left:4px;
    background:var(--surface2);border:1px solid var(--border);
  }
  .gear-icon:hover{color:var(--text);background:var(--surface);border-color:var(--accent)}

  /* ‚îÄ‚îÄ Polygon Draw Control ‚îÄ‚îÄ */
  .draw-control{position:absolute;top:90px;right:10px;z-index:1000;display:flex;flex-direction:column;gap:4px}
  .draw-btn,.draw-clear-btn{
    width:34px;height:34px;border-radius:4px;border:2px solid rgba(0,0,0,0.2);
    background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;
    font-size:16px;color:#333;box-shadow:0 1px 5px rgba(0,0,0,0.15);transition:all 0.15s;
  }
  .draw-btn:hover,.draw-clear-btn:hover{background:#f4f4f4}
  .draw-btn.active{border-color:#2563eb;background:#eff6ff;color:#2563eb}
  .draw-clear-btn{font-size:12px;font-weight:700;color:#ef4444;display:none}
  .draw-clear-btn.visible{display:flex}
  .leaflet-container.draw-mode{cursor:crosshair !important}
  .leaflet-container.draw-mode .leaflet-marker-icon,.leaflet-container.draw-mode .leaflet-interactive{cursor:crosshair !important}
  /* Polygon edit vertex handles */
  .leaflet-editing-icon{
    width:10px !important;height:10px !important;margin-left:-5px !important;margin-top:-5px !important;
    background:#2563eb;border:2px solid #fff;border-radius:50%;cursor:grab;
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }
  .leaflet-editing-icon:hover{background:#1d4ed8;transform:scale(1.3)}
  .leaflet-editing-icon:active{cursor:grabbing}
  /* Midpoint (ghost) handles ‚Äî smaller, translucent */
  .leaflet-edit-resize,.leaflet-marker-icon.leaflet-editing-icon[style*="opacity"]{
    opacity:0.5 !important;width:8px !important;height:8px !important;
    margin-left:-4px !important;margin-top:-4px !important;
  }
</style>
</head>
<body class="light-mode">

<!-- Hero Stat Bar -->
<div class="hero-stats">
  <div class="stat-item"><span class="stat-value green" id="heroForSale">‚Äî</span> For Sale</div>
  <span class="separator">|</span>
  <div class="stat-item"><span class="stat-value" id="heroOffMarket">‚Äî</span> Off-Market Targets</div>
  <span class="separator">|</span>
  <div class="stat-item"><span class="stat-value green" id="heroHighMargin">‚Äî</span> Deals Above 30% Margin</div>
  <span class="separator">|</span>
  <div class="stat-item">Avg Margin: <span class="stat-value" id="heroAvgMargin">‚Äî</span></div>
  <span class="separator" id="heroBtrSep" style="display:none">|</span>
  <div class="stat-item" id="heroBtrItem" style="display:none"><span class="stat-value" id="heroBtrDeals" style="color:#f59e0b">‚Äî</span> BTR Deals</div>
  <span class="separator" id="heroBtrYocSep" style="display:none">|</span>
  <div class="stat-item" id="heroBtrYocItem" style="display:none">Avg Base YOC: <span class="stat-value" id="heroBtrYoc" style="color:#f59e0b">‚Äî</span></div>
  <span class="separator" id="heroBtrRentSep" style="display:none">|</span>
  <div class="stat-item" id="heroBtrRentItem" style="display:none">Avg Base Rent: <span class="stat-value" id="heroBtrRent" style="color:#f59e0b">‚Äî</span></div>
  <span class="separator" id="heroBtrZoriSep" style="display:none">|</span>
  <div class="stat-item" id="heroBtrZoriItem" style="display:none">Avg ZORI: <span class="stat-value" id="heroBtrZori" style="color:#f59e0b">‚Äî</span></div>
</div>

<div class="app-row">
<aside class="sidebar">
  <div class="sheet-handle" id="sheetHandle">
    <div class="handle-bar"></div>
    <div class="peek-stats">
      <div class="peek-stat"><span class="peek-value" id="peekEligible">0</span> eligible</div>
      <div class="peek-stat"><span class="peek-value" id="peekMargin">0%</span> avg margin</div>
    </div>
  </div>
  <div class="sidebar-header">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h1><span>SB 1123</span> Deal Finder</h1>
      <a href="analytics.html" class="analytics-btn" id="analyticsLink" title="Market Analytics Dashboard">&#9632; Analytics</a>
      <a href="" class="analytics-btn" id="marketSwitchLink" title="Switch market"></a>
      <button class="refresh-btn" onclick="copyRefreshCmd()" title="Copy refresh command to clipboard">&#8635; Refresh</button>
    </div>
    <p id="marketSubtitle">Townhome development sites in Los Angeles</p>
    <div class="law-ref">California SB 1123 ‚Äî by-right subdivision, no city approval required</div>
    <div class="law-ref" id="dataFreshness" style="margin-top:2px"></div>
  </div>

  <div class="loading-banner" id="loadingBanner">Rendering data...</div>

  <!-- ‚ïê‚ïê‚ïê QUICK ACTIONS ‚ïê‚ïê‚ïê -->
  <div class="section">
    <div class="section-title">Quick Actions</div>
    <div class="section-content">
      <div class="preset-row">
        <button class="preset-btn" onclick="applyPreset('newThisWeek',this)" title="Listed in last 7 days">New This Week</button>
        <button class="preset-btn" onclick="applyPreset('stale',this)" title="60+ days on market">Stale Listings</button>
        <button class="preset-btn" onclick="applyPreset('offMarket',this)" title="Show off-market acquisition targets">Off-Market</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê PRIMARY LAYERS ‚ïê‚ïê‚ïê -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Layers <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <button class="layer-btn active" data-layer="listings" onclick="toggleLayer('listings',this)">
        <span class="icon">‚óè</span> For Sale <span class="layer-count" id="listingCount">0</span>
      </button>
      <button class="layer-btn" data-layer="offMarket" onclick="toggleLayer('offMarket',this)">
        <span class="icon">‚óé</span> Off-Market Targets <span class="layer-count" id="offMarketCount">0</span>
      </button>
      <button class="layer-btn" data-layer="spreadHeat" onclick="toggleLayer('spreadHeat',this)">
        <span class="icon" style="color:#22c55e">‚ñ™</span> Profit Margin Heatmap <span class="layer-count" id="spreadCount">0</span>
      </button>
      <button class="layer-btn" data-layer="btr" onclick="toggleLayer('btr',this)">
        <span class="icon" style="color:#f59e0b">‚óÜ</span> Build to Rent <span class="layer-count" id="btrCount">0</span>
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SECONDARY LAYERS ‚ïê‚ïê‚ïê -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">More Layers <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <button class="layer-btn" data-layer="markers" onclick="toggleLayer('markers',this)">
        <span class="icon">‚óã</span> Recent Sales <span class="layer-count" id="compCount">0</span>
      </button>
      <button class="layer-btn" data-layer="compHeat" onclick="toggleLayer('compHeat',this)">
        <span class="icon" style="color:#f0641e">‚ñ™</span> Sale Price Heatmap <span class="layer-count" id="heatCount">0</span>
      </button>
      <div id="heatmapModeToggle" style="display:none;padding:2px 12px 6px">
        <div style="display:flex;gap:4px">
          <button class="basemap-btn active" id="heatRaw" onclick="setHeatmapMode('raw')">Raw $/SF</button>
          <button class="basemap-btn" id="heatNorm" onclick="setHeatmapMode('normalized')">Normalized</button>
        </div>
        <div style="font-size:9px;color:var(--text-dim);margin-top:3px" id="heatmapModeLabel">All sales, raw $/SF</div>
      </div>
      <button class="layer-btn" data-layer="neighborhoods" onclick="toggleLayer('neighborhoods',this)">
        <span class="icon" style="color:#8b5cf6">‚ñ™</span> Neighborhood Scores <span class="layer-count" id="neighborhoodCount">0</span>
      </button>
      <button class="layer-btn active" data-layer="parcels" onclick="toggleLayer('parcels',this)">
        <span class="icon">‚óª</span> Parcel Boundaries
      </button>
      <button class="layer-btn" data-layer="fireZones" onclick="toggleLayer('fireZones',this)">
        <span class="icon" style="color:#ef4444">!</span> Fire Risk
      </button>
      <button class="layer-btn" data-layer="floodZones" onclick="toggleLayer('floodZones',this)">
        <span class="icon" style="color:#3b82f6">~</span> Flood Risk
      </button>
      <button class="layer-btn" data-layer="liquefaction" onclick="toggleLayer('liquefaction',this)">
        <span class="icon" style="color:#a855f7">‚ñ™</span> Earthquake Risk
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê BASEMAP ‚ïê‚ïê‚ïê -->
  <div class="section">
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:8px;font-weight:700;padding:0 12px">Base Map</div>
    <div class="basemap-group" style="padding:0 12px">
      <button class="basemap-btn active" data-base="light" onclick="setBaseMap('light')">Light</button>
      <button class="basemap-btn" data-base="satellite" onclick="setBaseMap('satellite')">Satellite</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê ZONING ‚ïê‚ïê‚ïê (always visible) -->
  <div class="section">
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:8px;font-weight:700;padding:0 12px">Zoning</div>
    <div id="zoneToggles" style="padding:0 12px"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê CONDITION TIER ‚ïê‚ïê‚ïê (visible when comp layer active) -->
  <div class="section" id="tierFilterSection" style="display:none">
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-dim);margin-bottom:8px;font-weight:700;padding:0 12px">Condition Tier</div>
    <div style="padding:0 12px">
      <label class="zone-toggle" style="margin:0 0 2px">
        <input type="checkbox" checked onchange="tierState.t1=this.checked;updateCompPoints()">
        <span class="check-box"></span>
        <span class="zone-swatch" style="background:#14b8a6"></span>
        <span class="zone-label">T1 ‚Äî New / Remodel</span>
        <span class="zone-stat" id="tierT1Count">0</span>
      </label>
      <label class="zone-toggle" style="margin:0">
        <input type="checkbox" checked onchange="tierState.t2=this.checked;updateCompPoints()">
        <span class="check-box"></span>
        <span class="zone-swatch" style="background:#64748b"></span>
        <span class="zone-label">T2 ‚Äî Existing / As-Is</span>
        <span class="zone-stat" id="tierT2Count">0</span>
      </label>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê (expanded, but subsections collapsed) -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Filters <span class="chevron">‚ñº</span></div>
    <div class="section-content">

  <!-- Margin Filter -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Deal Margin <span class="badge">KEY</span> <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min %</div><input type="number" id="marginMin" step="5"></div>
          <span class="separator">‚Äî</span>
          <div class="input-group"><div class="input-label">Max %</div><input type="number" id="marginMax" step="5"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="marginSliderFill"></div>
          <input type="range" id="marginSliderMin" min="-100" max="100" step="5" value="30">
          <input type="range" id="marginSliderMax" min="-100" max="100" step="5" value="100">
        </div>
        <div class="preset-row">
          <button class="preset-btn active" onclick="setMarginPreset(30,this)">Green (30%+)</button>
          <button class="preset-btn" onclick="setMarginPreset(20,this)">Yellow+ (20%+)</button>
          <button class="preset-btn" onclick="setMarginPreset(0,this)">Profitable (0%+)</button>
        </div>
        <button class="reset-btn" onclick="resetFilter('margin')">Reset Margin Filter</button>
      </div>
    </div>
  </div>

  <!-- Lot Size Filter -->
  <div class="section">
    <div class="section-title" onclick="toggleSection(this)">Lot Size <span class="badge">KEY</span> <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="lotMin" step="500"></div>
          <span class="separator">‚Äî</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="lotMax" step="500"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="lotSliderFill"></div>
          <input type="range" id="lotSliderMin" min="0" max="45000" step="500" value="12000">
          <input type="range" id="lotSliderMax" min="0" max="45000" step="500" value="45000">
        </div>
        <button class="reset-btn" onclick="resetFilter('lot')">Reset Lot Filter</button>
      </div>
    </div>
  </div>

  <!-- Lot Width Filter -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Lot Width <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="lotwMin" step="5"></div>
          <span class="separator">‚Äî</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="lotwMax" step="5"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="lotwSliderFill"></div>
          <input type="range" id="lotwSliderMin" min="0" max="200" step="5" value="50">
          <input type="range" id="lotwSliderMax" min="0" max="200" step="5" value="200">
        </div>
        <button class="reset-btn" onclick="resetFilter('lotw')">Reset Lot Width</button>
      </div>
    </div>
  </div>

  <!-- List Price Filter -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Asking Price <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="priceMin" step="25000"></div>
          <span class="separator">‚Äî</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="priceMax" step="25000"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="priceSliderFill"></div>
          <input type="range" id="priceSliderMin" min="0" max="5000000" step="25000" value="0">
          <input type="range" id="priceSliderMax" min="0" max="5000000" step="25000" value="3000000">
        </div>
        <button class="reset-btn" onclick="resetFilter('price')">Reset Price Filter</button>
      </div>
    </div>
  </div>

  <!-- $/SF Filter -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Price per Sq Ft <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="psfMin" step="50"></div>
          <span class="separator">‚Äî</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="psfMax" step="50"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="psfSliderFill"></div>
          <input type="range" id="psfSliderMin" min="0" max="2000" step="25" value="0">
          <input type="range" id="psfSliderMax" min="0" max="2000" step="25" value="2000">
        </div>
        <button class="reset-btn" onclick="resetFilter('psf')">Reset $/SF Filter</button>
      </div>
    </div>
  </div>

  <!-- Min Units Filter -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Min Units <span class="badge">KEY</span> <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div style="display:flex;align-items:center;gap:10px">
          <input type="range" id="minUnitsSlider" min="2" max="10" step="1" value="4" style="flex:1" oninput="onMinUnitsChange(this.value)">
          <span id="minUnitsLabel" style="font-family:'JetBrains Mono',monospace;font-size:13px;min-width:32px;text-align:center;color:var(--accent)">4</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-dim);margin-top:2px"><span>2</span><span>10</span></div>
        <button class="reset-btn" onclick="resetMinUnits()">Reset Min Units</button>
      </div>
    </div>
  </div>

  <!-- Structure Size -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Home Size <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min</div><input type="number" id="sqftMin" step="100"></div>
          <span class="separator">‚Äî</span>
          <div class="input-group"><div class="input-label">Max</div><input type="number" id="sqftMax" step="100"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="sqftSliderFill"></div>
          <input type="range" id="sqftSliderMin" min="0" max="7000" step="100" value="0">
          <input type="range" id="sqftSliderMax" min="0" max="7000" step="100" value="7000">
        </div>
        <button class="reset-btn" onclick="resetFilter('sqft')">Reset Size Filter</button>
      </div>
    </div>
  </div>

  <!-- Lot Slope -->
  <div class="section collapsed">
    <div class="section-title" onclick="toggleSection(this)">Terrain Slope <span class="badge">NEW</span> <span class="chevron">‚ñº</span></div>
    <div class="section-content">
      <div class="range-filter">
        <div class="range-inputs">
          <div class="input-group"><div class="input-label">Min %</div><input type="number" id="slopeMin" step="1"></div>
          <span class="separator">‚Äî</span>
          <div class="input-group"><div class="input-label">Max %</div><input type="number" id="slopeMax" step="1"></div>
        </div>
        <div class="range-slider-track">
          <div class="range-slider-fill" id="slopeSliderFill"></div>
          <input type="range" id="slopeSliderMin" min="0" max="100" step="1" value="0">
          <input type="range" id="slopeSliderMax" min="0" max="100" step="1" value="100">
        </div>
        <button class="reset-btn" onclick="resetFilter('slope')">Reset Slope Filter</button>
      </div>
    </div>
  </div>

  <!-- Burn Zone Toggle -->
  <div class="section" style="padding:6px 14px" id="burnZoneSection">
    <label class="zone-toggle" style="margin:0">
      <input type="checkbox" id="hideBurnZones" checked onchange="toggleBurnZoneFilter(this.checked)">
      <span class="check-box"></span>
      <span class="zone-label" style="color:var(--red)">Hide Burn Zones <small>(Palisades + Eaton)</small></span>
    </label>
  </div>

  <!-- Tenant Risk Toggle -->
  <div class="section" style="padding:6px 14px">
    <label class="zone-toggle" style="margin:0">
      <input type="checkbox" id="hideTenantRisk" onchange="toggleTenantRiskFilter(this.checked)">
      <span class="check-box"></span>
      <span class="zone-label" style="color:var(--orange)">Hide High Tenant Risk</span>
    </label>
  </div>

  <!-- Steep Slope Toggle -->
  <div class="section" style="padding:6px 14px">
    <label class="zone-toggle" style="margin:0">
      <input type="checkbox" id="hideHighSlope" onchange="toggleHighSlopeFilter(this.checked)">
      <span class="check-box"></span>
      <span class="zone-label" style="color:var(--orange)">Hide Steep Lots (score &ge; 60)</span>
    </label>
  </div>

  <!-- Structural Viability -->
  <div class="section" style="padding:6px 14px">
    <label class="zone-toggle" style="margin:0">
      <input type="checkbox" id="hideUnviable" checked onchange="toggleUnviableFilter(this.checked)">
      <span class="check-box"></span>
      <span class="zone-label" style="color:var(--red)">Hide Unviable Deals</span>
    </label>
    <div id="viabilityFloor" style="font-size:10px;color:var(--text-dim);padding:4px 0 0 26px;font-family:'JetBrains Mono',monospace"></div>
  </div>

      <!-- Filter summary -->
      <div class="filter-count" id="filterCount">Showing all</div>
      <button class="reset-btn" onclick="resetFilter('all')">Reset All Filters</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê SAVED DEALS ‚ïê‚ïê‚ïê -->
  <div class="section">
    <button class="fav-toggle" id="favToggle" onclick="toggleFavoritesFilter()">
      <span style="font-size:14px">‚òÖ</span> Saved Deals
      <span class="fav-count" id="favCount">0</span>
    </button>
  </div>

  <!-- ‚ïê‚ïê‚ïê DEAL ASSUMPTIONS ‚ïê‚ïê‚ïê -->
  <div class="section" style="display:flex;align-items:center;gap:8px">
    <span style="font-size:12px;color:var(--text-dim)">Deal Assumptions</span>
    <button class="gear-icon" onclick="openAssumptionsModal()" title="Edit deal assumptions">‚öô</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê -->
  <div class="section">
    <button class="export-btn" onclick="exportCSV()">üìä Export CSV</button>
  </div>
</aside>

<button class="mobile-filter-btn" id="mobileFilterBtn" onclick="openMobileSheet()">
  <span class="filter-icon">&#9776;</span> Filters
</button>

<div id="onboarding-tip" class="onboarding-tip" style="display:none">
  <button class="close-btn" onclick="dismissOnboarding()">√ó</button>
  üëã <strong>First time here?</strong> Click any <span style="color:var(--green);font-weight:700">green pin</span> to see a profitable deal. Yellow = moderate margin, Gray = below target.
</div>
<div id="map">
  <!-- Pin Color Legend (bottom-left of map, always visible, dynamic) -->
  <div class="pin-legend" id="pinLegend">
    <!-- Dynamically populated based on active layers -->
  </div>
</div>

<div class="map-legend">
  <div class="legend-section">Comps (Market Data)</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r1)"></div> R1 Single Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r2)"></div> R2 Two Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r3)"></div> R3 Multi-Family</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--r4)"></div> R4 High Density</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--land)"></div> Vacant Land</div>
  <div class="legend-section" style="margin-top:8px">Listings (Exit $/SF)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3b82f6;border-radius:50%"></div> &lt;$600/SF</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22d3ee;border-radius:50%"></div> $600-700</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22c55e;border-radius:50%"></div> $700-800</div>
  <div class="legend-item"><div class="legend-dot" style="background:#eab308;border-radius:50%"></div> $800-900</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f97316;border-radius:50%"></div> $900-1,000</div>
  <div class="legend-item"><div class="legend-dot" style="background:#ef4444;border-radius:50%"></div> $1,000+</div>
</div>
</div><!-- /app-row -->

<!-- Deal Assumptions Modal -->
<div class="modal-overlay" id="assumptionsModal" onclick="if(event.target===this) closeAssumptionsModal()">
  <div class="modal-panel">
    <div class="modal-header">
      <h3>Deal Assumptions</h3>
      <button class="modal-close" onclick="closeAssumptionsModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="proforma-inputs">
        <div class="proforma-group">
          <label>All-In Build $/SF</label>
          <input type="number" id="pfBuildCost" value="360" step="25" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Unit SF (avg)</label>
          <input type="number" id="pfUnitSize" value="1750" step="50" onchange="onProformaChange()">
        </div>
        <!-- Soft cost removed: allInBuildPsf includes hard + soft -->
        <div class="proforma-group">
          <label>Txn Costs %</label>
          <input type="number" id="pfTxnCost" value="4.7" step="0.5" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Fixed Disp $</label>
          <input type="number" id="pfFixedDisp" value="40000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Demo Cost $</label>
          <input type="number" id="pfDemoCost" value="55000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Hold Months</label>
          <input type="number" id="pfHoldMonths" value="24" step="3" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Carry Rate %</label>
          <input type="number" id="pfCarryRate" value="9" step="0.5" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Insurance $</label>
          <input type="number" id="pfInsurance" value="40000" step="5000" onchange="onProformaChange()">
        </div>
        <div class="proforma-group">
          <label>Origination %</label>
          <input type="number" id="pfOrigination" value="1" step="0.25" onchange="onProformaChange()">
        </div>
      </div>
      <p style="font-size:10px;color:var(--text-dim);margin-top:12px;line-height:1.4">
        SB 1123 ground-up: demolish existing, build all new townhome units.
        Max avg unit size: 1,200 SF (R1). Guaranteed FAR: 1.0x (3-7 units) / 1.25x (8-10).
      </p>
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">
        <h4 style="margin:0 0 8px;font-size:12px;color:var(--accent)">Build-to-Rent Assumptions</h4>
        <div class="proforma-inputs">
          <div class="proforma-group">
            <label>Rent Premium <small>(SAFMR only)</small></label>
            <input type="number" id="btrPremium" value="1.25" step="0.05" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Vacancy %</label>
            <input type="number" id="btrVacancy" value="0.04" step="0.01" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>OpEx Ratio</label>
            <input type="number" id="btrOpex" value="0.30" step="0.05" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Cap Rate</label>
            <input type="number" id="btrCapRate" value="0.055" step="0.005" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Refi LTV</label>
            <input type="number" id="btrLTV" value="0.70" step="0.05" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Refi Rate</label>
            <input type="number" id="btrRate" value="0.0625" step="0.0025" onchange="onProformaChange()">
          </div>
          <div class="proforma-group">
            <label>Min YOC</label>
            <input type="number" id="btrMinYOC" value="0.04" step="0.005" min="0.03" max="0.08" onchange="onProformaChange()">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Key Modal -->
<div class="modal-overlay" id="dataKeyModal" onclick="if(event.target===this) closeDataKeyModal()">
  <div class="modal-panel data-key-panel">
    <div class="modal-header">
      <h3>Data Key</h3>
      <button class="modal-close" onclick="closeDataKeyModal()">&times;</button>
    </div>
    <div class="modal-body">

      <div class="data-key-section">
        <h4>Deal Metrics (Top Row)</h4>
        <dl class="data-key-item"><dt>Price</dt><dd>Listing price from MLS. For off-market, enter your own estimate.</dd></dl>
        <dl class="data-key-item"><dt>Units</dt><dd>Number of SB 1123 townhome units the lot can support. R1/LAND: floor(lotSF &divide; 1,200), cap 10. R2&ndash;R4: floor(lotSF &divide; 600), cap 10. Layout constraints (setbacks, driveway) may reduce this further.</dd></dl>
        <dl class="data-key-item"><dt>Lot SF</dt><dd>Total lot area in square feet. Primary source is MLS listing data; falls back to county parcel data if MLS is missing. Source shown as &ldquo;mls&rdquo; or &ldquo;parcel.&rdquo;</dd></dl>
        <dl class="data-key-item"><dt>Exit $/SF</dt><dd>Estimated sale price per square foot for finished townhomes. Prefers new-construction comps within 1 mile; falls back to zone-matched resale comps with expanding search radius (0.25mi &rarr; 4mi). Color indicates comp type: <span style="color:#4ecdc4">teal = new-con</span>, <span style="color:#ffe66d">gold = zone comps</span>.</dd></dl>
        <dl class="data-key-item"><dt>Spread</dt><dd>Exit $/SF minus hard construction cost (default $350/SF). Higher spread = more margin for profit.</dd></dl>
        <dl class="data-key-item"><dt>Net Margin</dt><dd>Estimated profit &divide; gross revenue. Green (&ge;20%) = strong, yellow (10&ndash;20%) = marginal, red (&lt;10%) = risky.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Comp Quality</h4>
        <dl class="data-key-item"><dt>Comp Confidence</dt><dd>Score from 0&ndash;100 rating reliability of the exit $/SF estimate. Based on: number of comps found, distance from subject, recency, and whether new-construction comps are available. Shown as a colored bar in the deal card.</dd></dl>
        <dl class="data-key-item"><dt>Comp Type</dt><dd><b>New-con (subdiv)</b>: Recent new-construction sales &mdash; most reliable for SB 1123 product. <b>Zone comps</b>: Resale comps matched by zoning type (R1 with R1, etc.) &mdash; used when no new-con available.</dd></dl>
        <dl class="data-key-item"><dt>Comp Count &amp; Radius</dt><dd>Number of comparable sales found and the search radius used. More comps at shorter radius = higher confidence.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Unit Count &amp; Layout</h4>
        <dl class="data-key-item"><dt>Lot Dimensions</dt><dd>Width &times; Depth estimated from parcel geometry. &ldquo;Irregular&rdquo; flag appears when effective rectangle area differs &gt;15% from actual lot area (pie-shaped, flag lots, etc.).</dd></dl>
        <dl class="data-key-item"><dt>Layout Constraint</dt><dd>Unit count may be reduced by physical fit: buildable width = lot width minus 20&rsquo; driveway minus 4&rsquo; far-side setback. Driveway is flush to property line and encroaches into the setback on its side. Use the Layout Planner tool to experiment with driveway placement.</dd></dl>
        <dl class="data-key-item"><dt>FAR (Floor Area Ratio)</dt><dd>Maximum buildable SF &divide; lot SF. SB 1123 allows: 1.25 FAR for 8&ndash;10 units, 1.0 for 3&ndash;7 units, 0.5 for &lt;3 units. Buildable SF = min(units &times; avg unit size, lot &times; FAR).</dd></dl>
        <dl class="data-key-item"><dt>Density Cap</dt><dd>SB 1123 caps at 10 units per lot regardless of lot size. R1/LAND uses 1,200 SF/unit divisor; R2&ndash;R4 uses 600 SF/unit.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Financial Model</h4>
        <dl class="data-key-item"><dt>Buildable SF</dt><dd>Total square footage of finished product. = units &times; avg unit size (default 1,200 SF), capped by FAR limit.</dd></dl>
        <dl class="data-key-item"><dt>Gross Revenue</dt><dd>Buildable SF &times; Exit $/SF. What you&rsquo;d gross if you sold all units.</dd></dl>
        <dl class="data-key-item"><dt>Sale Discount</dt><dd>5% reduction from gross revenue to account for broker commissions, concessions, and closing costs.</dd></dl>
        <dl class="data-key-item"><dt>Net Revenue</dt><dd>Gross revenue minus sale discount.</dd></dl>
        <dl class="data-key-item"><dt>Hard Costs</dt><dd>Construction cost = buildable SF &times; $350/SF (default). Covers structure, MEP, finishes.</dd></dl>
        <dl class="data-key-item"><dt>Soft Costs</dt><dd>25% of hard costs (default). Covers architecture, engineering, permits, insurance, legal, financing.</dd></dl>
        <dl class="data-key-item"><dt>Demo Cost</dt><dd>$25,000 flat (default) for demolition of existing structures.</dd></dl>
        <dl class="data-key-item"><dt>Total Development Cost</dt><dd>Hard + soft + demo + land acquisition (asking price).</dd></dl>
        <dl class="data-key-item"><dt>Est. Profit</dt><dd>Net revenue minus total development cost.</dd></dl>
        <dl class="data-key-item"><dt>Buy/Unit</dt><dd>Asking price &divide; number of units. Lower = more land efficiency.</dd></dl>
        <dl class="data-key-item"><dt>Land Basis</dt><dd>Asking price &divide; buildable SF. What you&rsquo;re paying per SF of finished product for the land alone.</dd></dl>
        <dl class="data-key-item"><dt>Max Offer</dt><dd>Maximum land price that still achieves the target margin (default 20%). Calculated as: net revenue &minus; construction costs &minus; target profit.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Build-to-Rent (BTR)</h4>
        <dl class="data-key-item"><dt>Monthly Rent</dt><dd>Estimated market rent per unit from HUD Small Area Fair Market Rents (SAFMR) for the property&rsquo;s ZIP code, sized to unit bedroom count.</dd></dl>
        <dl class="data-key-item"><dt>Gross Annual Income</dt><dd>Monthly rent &times; units &times; 12 months.</dd></dl>
        <dl class="data-key-item"><dt>NOI (Net Operating Income)</dt><dd>Gross income minus operating expenses (default 35% of gross: property management, maintenance, insurance, taxes, vacancy).</dd></dl>
        <dl class="data-key-item"><dt>Yield on Cost (YOC)</dt><dd>NOI &divide; total development cost. The unlevered return on your all-in investment. Target: &ge;5.5%. Shown as pass/fail badge.</dd></dl>
        <dl class="data-key-item"><dt>Cap Rate Valuation</dt><dd>NOI &divide; market cap rate (default 5%). Estimates what the completed, stabilized property would sell for as a rental asset.</dd></dl>
        <dl class="data-key-item"><dt>Refi Loan (70% LTV)</dt><dd>70% of the cap rate valuation. Estimates how much permanent debt you could place after stabilization.</dd></dl>
        <dl class="data-key-item"><dt>Equity Remaining</dt><dd>Total development cost minus refi loan. The cash you&rsquo;d still have tied up after refinancing.</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Due Diligence Flags</h4>
        <dl class="data-key-item"><dt>Fire Zone (VHFHSZ)</dt><dd>Very High Fire Hazard Severity Zone. SB 1123 projects are <b>not eligible</b> in VHFHSZ areas. These listings are flagged but still shown for awareness.</dd></dl>
        <dl class="data-key-item"><dt>Slope</dt><dd>Average ground slope percentage from USGS LiDAR elevation data. Steeper slopes increase grading costs and may require retaining walls. &gt;15% is flagged as challenging.</dd></dl>
        <dl class="data-key-item"><dt>Tenant Risk</dt><dd>Risk level (0&ndash;3) for existing tenant displacement issues. Factors: occupied/improved property, 3+ bedrooms, 5+ bedrooms, multi-family structures, pre-2000 construction, RSO (rent stabilization) overlay. Higher risk = more relocation costs and legal complexity.</dd></dl>
        <dl class="data-key-item"><dt>HOA</dt><dd>Existing HOA may restrict or prevent SB 1123 development. R1 properties with HOA are flagged as potentially ineligible.</dd></dl>
        <dl class="data-key-item"><dt>Lot Source</dt><dd>Where lot size data comes from: &ldquo;MLS&rdquo; (listing agent, more reliable) or &ldquo;Parcel&rdquo; (county GIS, may match wrong parcel on irregular lots).</dd></dl>
      </div>

      <div class="data-key-section">
        <h4>Deal Margin Colors</h4>
        <dl class="data-key-item"><dt style="color:#4ecdc4">Green (Net Margin &ge; 20%)</dt><dd>Strong deal &mdash; meets or exceeds target profit margin.</dd></dl>
        <dl class="data-key-item"><dt style="color:#ffe66d">Yellow (Net Margin 10&ndash;20%)</dt><dd>Marginal deal &mdash; profit exists but thin. Sensitive to cost overruns or market softening.</dd></dl>
        <dl class="data-key-item"><dt style="color:#ff6b6b">Red (Net Margin &lt; 10%)</dt><dd>Risky deal &mdash; little to no profit cushion. Likely not viable at asking price.</dd></dl>
      </div>

    </div>
  </div>
</div>

<!-- Listings Panel Tab (visible when panel is closed) -->
<div class="listings-panel-tab" id="listingsPanelTab" onclick="toggleListingsPanel()">
  <span class="tab-arrow">&#9650;</span> Deal Pipeline <span class="tab-count" id="tabPanelCount">0</span>
</div>

<!-- Listings Panel -->
<div class="listings-panel" id="listingsPanel">
  <div class="listings-panel-resize" id="panelResize"></div>
  <div class="listings-panel-header">
    <h2><span>Deal Pipeline</span></h2>
    <span class="listings-panel-count" id="tablePanelCount">0</span>
    <button class="listings-panel-close" onclick="toggleListingsPanel()">x</button>
  </div>
  <div class="listings-table-wrap" id="tableWrap">
    <table class="listings-table">
      <thead>
        <tr>
          <th class="col-fav" data-sort="fav" onclick="sortTable('fav')"><span style="font-size:12px">&#9733;</span> <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-addr" data-sort="address" onclick="sortTable('address')">Address <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-zone" data-sort="zone" onclick="sortTable('zone')">Zone <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-price" data-sort="price" onclick="sortTable('price')">Price <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-lot" data-sort="lotSf" onclick="sortTable('lotSf')">Lot Size <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-lotw" data-sort="lw" onclick="sortTable('lw')">Lot W <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-units" data-sort="maxUnits" onclick="sortTable('maxUnits')">Units <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-hood" data-sort="exitPsf" onclick="sortTable('exitPsf')">Exit $/SF <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-sale" data-sort="salePerUnit" onclick="sortTable('salePerUnit')">Revenue/Unit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-ppu" data-sort="pricePerUnit" onclick="sortTable('pricePerUnit')">Cost/Unit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-profit" data-sort="estProfit" onclick="sortTable('estProfit')">Profit <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-margin" data-sort="estMargin" onclick="sortTable('estMargin')">Margin <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-slope" data-sort="slope" onclick="sortTable('slope')">Slope <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-dom" data-sort="dom" onclick="sortTable('dom')">Days Listed <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-new" data-sort="isNew" onclick="sortTable('isNew')">New <span class="sort-arrow">‚ñ≤</span></th>
          <th class="col-link">Link</th>
        </tr>
      </thead>
      <tbody id="listingsTableBody"></tbody>
    </table>
  </div>
  <div class="mobile-cards" id="mobileCards"></div>
</div>

<script>
// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ
const ZONE_COLORS = {R1:'#2563eb',R2:'#16a34a',R3:'#ea580c',R4:'#9333ea',LAND:'#b45309'};
const ZONE_LABELS = {R1:'Single Family',R2:'Two Family',R3:'Multi-Family',R4:'High Density',LAND:'Vacant Land'};
// Exit $/SF color scale: cool (cheap) ‚Üí hot (expensive)
// RECENTERED for SFV: $600-$1,000 decision range
function exitPsfColor(ppsf){
  if(!ppsf || ppsf <= 0) return '#888';
  if(ppsf < 600) return '#3b82f6';   // Blue ‚Äî below target range
  if(ppsf < 700) return '#22d3ee';   // Cyan
  if(ppsf < 800) return '#22c55e';   // Green
  if(ppsf < 900) return '#eab308';   // Yellow
  if(ppsf < 1000) return '#f97316';  // Orange
  return '#ef4444';                   // Red ‚Äî premium
}

function getPinBorder(ppsf){
  if(!ppsf || ppsf <= 0) return '#666';
  if(ppsf < 600) return '#2563eb';   // Darker blue border
  if(ppsf < 700) return '#06b6d4';   // Darker cyan border
  if(ppsf < 800) return '#16a34a';   // Darker green border
  if(ppsf < 900) return '#ca8a04';   // Darker yellow border
  if(ppsf < 1000) return '#ea580c';  // Darker orange border
  return '#dc2626';                   // Darker red border
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let COMPS = [];
let LISTINGS = [];
let RENTAL_COMPS = [];
let rentalCompGrid = null;
const markerLayers = {R1:L.layerGroup(),R2:L.layerGroup(),R3:L.layerGroup(),R4:L.layerGroup(),LAND:L.layerGroup()};
const listingsLayer = L.layerGroup();
const btrLayer = L.layerGroup();  // BTR opportunity layer
const offMarketLayer = L.layerGroup();  // Priority 4: Off-market targets
const neighborhoodLayer = L.layerGroup();  // Priority 3: Neighborhood opportunity scorer
let spreadHeatLayer = null;  // Priority 2: Spread heatmap
const layerState = {markers:false,compHeat:false,spreadHeat:false,neighborhoods:false,listings:true,offMarket:false,btr:false,fireZones:false,floodZones:false,liquefaction:false,parcels:true};

// ‚îÄ‚îÄ Polygon Draw State ‚îÄ‚îÄ
let drawPolygonLayer = null;   // The drawn polygon L.Polygon on the map
let drawPolygonGeoJSON = null; // turf-compatible GeoJSON for point-in-polygon tests
let drawMode = false;
let drawVertices = [];         // Array of [lat, lng] while drawing
let drawPreviewLine = null;    // Polyline showing edges while drawing
const zoneState = {R1:true,R2:false,R3:false,R4:false,LAND:false};
let sb1123Mode = true;  // Default ON ‚Äî we only care about 1123 deals

const filters = {
  price:{ min:0, max:3000000, dataMin:0, dataMax:5000000, step:25000, cap:5000000, defaultMin:null, defaultMax:3000000 },
  psf:  { min:0, max:3000, dataMin:0, dataMax:3000, step:25, cap:null, defaultMin:600, defaultMax:3000 },
  sqft: { min:0, max:7000, dataMin:0, dataMax:7000, step:100, cap:7000, defaultMin:null, defaultMax:null },
  lot:  { min:0, max:45000, dataMin:0, dataMax:45000, step:500, cap:45000, defaultMin:12000, defaultMax:45000 },
  lotw: { min:0, max:200, dataMin:0, dataMax:200, step:5, cap:200, defaultMin:50, defaultMax:200 },
  slope:{ min:0, max:100, dataMin:0, dataMax:100, step:1, cap:100, defaultMin:null, defaultMax:10 },
  margin:{ min:-100, max:100, dataMin:-100, dataMax:100, step:5, cap:null, defaultMin:30, defaultMax:null },
};

let currentSort = { key:null, dir:'desc' };
let listingsPanelOpen = false;
let compsTableActive = false;
let compsMapLayer = null;
let compsRadiusCircle = null;
let rentalCompsTableActive = false;
let rentalCompsMapLayer = null;
let rentalCompsRadiusCircle = null;
let savedPipelineHeader = '';
let favoritesOnly = false;
let newThisWeekFilter = false;
let hideBurnZones = true;
let hideTenantRisk = false;
function toggleTenantRiskFilter(checked){ hideTenantRisk = checked; applyFilters(); }
let hideHighSlope = false;
function toggleHighSlopeFilter(checked){ hideHighSlope = checked; applyFilters(); }
let hideUnviable = true;  // Default ON ‚Äî hide deals where max_offer <= 0
function toggleUnviableFilter(checked){ hideUnviable = checked; applyFilters(); }
let minUnitsFilter = 4;  // Default: require at least 4 units
function onMinUnitsChange(val){ minUnitsFilter = parseInt(val); document.getElementById('minUnitsLabel').textContent = val; applyFilters(); }
function resetMinUnits(){ minUnitsFilter = 4; document.getElementById('minUnitsSlider').value = 4; document.getElementById('minUnitsLabel').textContent = '4'; applyFilters(); }

function computeViabilityFloor(units) {
  const pf = proforma;
  if(!units) units = 6;  // Default: median unit count across eligible lots
  const unitSf = pf.avgUnitSf;
  const buildableSf = units * unitSf;
  const construction = buildableSf * pf.allInBuildPsf;
  const demo = pf.demoCost;
  const totalBuild = construction + demo;
  const avgLoan = totalBuild * 0.5;
  const carryInterest = avgLoan * (pf.carryRatePct / 100) * (pf.holdMonths / 12);
  const insurance = pf.insurance || 40000;
  const origination = totalBuild * ((pf.originationPct || 1) / 100);
  const totalCarry = carryInterest + insurance + origination;
  const totalNonLandCost = totalBuild + totalCarry;
  const txnMult = 1 - pf.txnCostPct / 100;
  const floor30 = Math.ceil((totalNonLandCost / 0.70 + pf.fixedDispositionCosts) / (units * unitSf * txnMult));
  const floor20 = Math.ceil((totalNonLandCost / 0.80 + pf.fixedDispositionCosts) / (units * unitSf * txnMult));
  return { floor30, floor20 };
}

function updateViabilityLabel() {
  const floors = computeViabilityFloor();
  const el = document.getElementById('viabilityFloor');
  if (el) el.innerHTML = 'Min exit: <span style="color:var(--red)">$'+floors.floor30+'/SF</span> @ 30% ¬∑ <span style="color:var(--yellow)">$'+floors.floor20+'/SF</span> @ 20%';
}

const tierState = { t1: true, t2: true };
let heatmapMode = 'raw';

// ‚îÄ‚îÄ Favorites (localStorage) ‚îÄ‚îÄ
const FAV_KEY = 'sb1123_favorites';
function loadFavorites(){ try{return JSON.parse(localStorage.getItem(FAV_KEY))||{}}catch(e){return{}} }
function saveFavorites(f){ localStorage.setItem(FAV_KEY, JSON.stringify(f)); }
function listingKey(l){ return l.lat+','+l.lng; }
function isFavorite(l){ return !!loadFavorites()[listingKey(l)]; }
function toggleFavorite(lat,lng){
  const key=lat+','+lng, favs=loadFavorites();
  if(favs[key]) delete favs[key]; else favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  saveFavorites(favs); updateFavCount();
  // Only rebuild markers when in favorites-only mode (un-star removes pin).
  // Otherwise skip applyFilters() to keep the popup open.
  if(favoritesOnly) applyFilters();
}
function saveFavNote(lat,lng,text){
  const key=lat+','+lng, favs=loadFavorites();
  if(!favs[key]) favs[key]={starred:true,notes:'',addedAt:new Date().toISOString()};
  favs[key].notes=text; saveFavorites(favs);
}
function getFavNote(lat,lng){ const f=loadFavorites()[lat+','+lng]; return f?f.notes||'':''; }
function updateFavCount(){
  const n=Object.keys(loadFavorites()).length;
  document.getElementById('favCount').textContent=n;
  const btn = document.getElementById('favToggle');
  btn.disabled = n === 0;
  if(n === 0 && favoritesOnly){
    favoritesOnly = false;
    btn.classList.remove('active');
    applyFilters();
  }
}
function copyRefreshCmd(){
  const cmd=MARKET.slug==='la'?'./refresh.sh':'./refresh.sh --market '+MARKET.slug;
  navigator.clipboard.writeText(cmd).then(()=>{
    const btn=document.querySelector('.refresh-btn');
    btn.textContent='Copied!';
    btn.style.borderColor='var(--accent)';btn.style.color='var(--accent)';
    setTimeout(()=>{btn.innerHTML='&#8635; Refresh';btn.style.borderColor='';btn.style.color='';},2000);
  }).catch(()=>{
    prompt('Run this in your terminal to refresh data:',cmd);
  });
}
function sharePin(lat,lng,event){
  var params=MARKET.slug!=='la'?'?market='+MARKET.slug+'&pin='+lat+','+lng:'?pin='+lat+','+lng;
  const url=window.location.origin+window.location.pathname+params;
  navigator.clipboard.writeText(url).then(()=>{
    const btn=event.target;
    const orig=btn.innerHTML;
    btn.innerHTML='Link Copied!';
    btn.style.background='var(--green)';
    setTimeout(()=>{btn.innerHTML=orig;btn.style.background='';},2000);
  }).catch(()=>{
    prompt('Share this link:',url);
  });
}
function toggleFavoritesFilter(){
  // Guard: check actual count, not just btn.disabled (inline onclick can fire on some browsers)
  if(Object.keys(loadFavorites()).length === 0) return;
  const btn = document.getElementById('favToggle');
  favoritesOnly=!favoritesOnly;
  if(favoritesOnly){
    btn.classList.add('active');
  } else {
    btn.classList.remove('active');
  }
  applyFilters();
}
function toggleBurnZoneFilter(checked){
  hideBurnZones = checked;
  applyFilters();
}

// Pro forma defaults ‚Äî SB 1123 townhome development
let proforma = {
  allInBuildPsf: 360,    // All-in construction $/SF (hard + soft combined)
  avgUnitSf: 1750,       // Avg townhome unit size
  txnCostPct: 4.7,       // Retail exit: broker (3%) + transfer tax + title + escrow
  fixedDispositionCosts: 40000, // Fixed per-project: legal, marketing, staging
  demoCost: 55000,       // Demolition of existing structure
  holdMonths: 24,        // Construction + sale hold period
  carryRatePct: 9,       // Annual carry rate on construction loan
  insurance: 40000,      // Builder's risk insurance for hold period
  originationPct: 1,     // Loan origination fee as % of construction loan
};

// ‚îÄ‚îÄ Map ‚îÄ‚îÄ
const map = L.map('map',{center:MARKET.center,zoom:MARKET.zoom,zoomControl:false});
L.control.zoom({position:'topright'}).addTo(map);

// Custom panes so heatmap renders below listings
map.createPane('heatmapPane').style.zIndex = 350;
map.createPane('compDotsPane').style.zIndex = 360;
const listingsPane = map.createPane('listingsPane');
listingsPane.style.zIndex = 450;
listingsPane.style.filter = 'drop-shadow(0 0 6px rgba(0,0,0,0.5))';

// Base tile layers
const baseLayers = {
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
    attribution:'OpenStreetMap CARTO',maxZoom:19
  }),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'Esri World Imagery',maxZoom:19
  })
};
let activeBase = 'light';
baseLayers.light.addTo(map);

function setBaseMap(name){
  map.removeLayer(baseLayers[activeBase]);
  activeBase = name;
  baseLayers[name].addTo(map);
  // Update button states
  document.querySelectorAll('.basemap-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.base===name);
  });
  // Toggle body class for light mode adjustments
  document.body.classList.toggle('light-mode', name==='light' || name==='satellite');
}

Object.values(markerLayers).forEach(l=>l.addTo(map));

// Overlay layers (server-rendered from LA County / FEMA / CGS ArcGIS)
let fireZoneLayer = null;
let parcelLayer = null;
let floodZoneLayer = null;
let liquefactionLayer = null;
let compHeatLayer = null;
let compCanvasRenderer = null;
let compPointsLayer = L.layerGroup();
let compLabelsLayer = L.layerGroup();
let compSpatialGrid = {};  // grid for fast viewport queries

// Build spatial grid for comps (0.005¬∞ cells ‚âà 500m)
function buildCompGrid(comps){
  const grid = {};
  const S = 0.005;
  comps.forEach(c=>{
    if(!c.ppsf || c.ppsf <= 0) return;
    const key = Math.floor(c.lat/S)+','+Math.floor(c.lng/S);
    if(!grid[key]) grid[key]=[];
    grid[key].push(c);
  });
  return grid;
}

// Query comps in a bounding box from grid
function queryCompGrid(bounds){
  const S = 0.005;
  const s=bounds.getSouth(), n=bounds.getNorth(), w=bounds.getWest(), e=bounds.getEast();
  const rMin=Math.floor(s/S), rMax=Math.floor(n/S);
  const cMin=Math.floor(w/S), cMax=Math.floor(e/S);
  const result=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=compSpatialGrid[r+','+c];
      if(cell) result.push(...cell);
    }
  }
  return result;
}

// Render comp points + labels for current viewport
function updateCompPoints(){
  compPointsLayer.clearLayers();
  compLabelsLayer.clearLayers();
  if(!layerState.compHeat) return;
  const zoom = map.getZoom();
  if(zoom < 13) return;

  const bounds = map.getBounds();
  const visible = queryCompGrid(bounds);
  const showLabels = zoom >= 15;
  // Cap markers to prevent browser freeze at mid-zoom with wide viewport
  const cap = showLabels ? 2000 : 5000;

  // Filter by tier
  const tierFiltered = visible.filter(c =>
    (tierState.t1 && c.t === 1) || (tierState.t2 && c.t === 2) || (!c.t)
  );
  const toRender = tierFiltered.length > cap ? tierFiltered.slice(0, cap) : tierFiltered;

  // Update tier counts
  const t1El = document.getElementById('tierT1Count');
  const t2El = document.getElementById('tierT2Count');
  if(t1El) t1El.textContent = tierFiltered.filter(c => c.t === 1).length;
  if(t2El) t2El.textContent = tierFiltered.filter(c => c.t === 2).length;

  toRender.forEach(c=>{
    const color = exitPsfColor(c.ppsf);
    const r = zoom >= 16 ? 6 : zoom >= 14 ? 4 : 3;
    const isT1 = c.t === 1;
    const cm = L.circleMarker([c.lat,c.lng],{
      radius:r, color: isT1 ? '#14b8a6' : 'rgba(255,255,255,0.3)', fillColor:color,
      fillOpacity:0.85, weight: isT1 ? 2 : 0.8, renderer:compCanvasRenderer,
      pane:'compDotsPane'
    });
    cm.bindPopup(`<div style="font-size:12px"><b>${c.address||'Sold Comp'}</b> <span style="display:inline-block;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;margin-left:4px;background:${isT1?'rgba(20,184,166,0.15)':'rgba(100,116,139,0.15)'};color:${isT1?'#14b8a6':'#64748b'}">${isT1?'T1 New/Remodel':'T2 Existing'}</span><br>
      <span style="font-family:monospace;font-size:14px;color:${color}">$${c.ppsf}/SF</span><br>
      $${c.price.toLocaleString()} ¬∑ ${c.sqft.toLocaleString()} sf${c.zone?' ¬∑ '+c.zone:''}${c.date?' ¬∑ '+c.date:''}${c.yb?' ¬∑ Built '+c.yb:''}</div>`,{maxWidth:280});
    compPointsLayer.addLayer(cm);

    if(showLabels){
      const label = L.marker([c.lat,c.lng],{
        icon: L.divIcon({
          className:'comp-psf-label',
          html:'$'+c.ppsf,
          iconSize:[40,14],
          iconAnchor:[20,-6]
        }),
        interactive:false
      });
      compLabelsLayer.addLayer(label);
    }
  });
}
if(L.esri){
  try {
    fireZoneLayer = L.esri.dynamicMapLayer({
      url:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Dynamic/Hazards/MapServer',
      layers:[2],
      opacity:0.4
    });
    // FEMA 100-year + 500-year flood plains (LA County Hazards service)
    floodZoneLayer = L.esri.dynamicMapLayer({
      url:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Dynamic/Hazards/MapServer',
      layers:[11,12],
      opacity:0.4
    });
    // CGS Liquefaction zones (CA state service)
    liquefactionLayer = L.esri.dynamicMapLayer({
      url:'https://services.gis.ca.gov/arcgis/rest/services/GeoscientificInformation/Liquefaction/MapServer',
      layers:[0,3],
      opacity:0.4
    });
    parcelLayer = L.esri.tiledMapLayer({
      url:'https://public.gis.lacounty.gov/public/rest/services/LACounty_Cache/LACounty_Parcel/MapServer',
      opacity:0.6,
      maxZoom:20,
      minZoom:15
    });
  } catch(e) {
    console.warn('esri-leaflet layers failed:', e.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SB 1123 ELIGIBILITY + PRO FORMA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// SB 1123 eligibility: R1-R4 + LAND zones, lot 10K+ SF
// Exclude condos/townhouses ‚Äî on shared/HOA land, can't subdivide
// Exclude R1 with HOA ‚Äî indicates shared land/CC&Rs that block subdivision
// Exclude VHFHSZ ‚Äî hard exclusion under SB 1123
function isSB1123Eligible(l){
  const validZone = ['R1','R2','R3','R4','LAND'].includes(l.zone);
  const notCondoTownhouse = !['Condo/Co-op','Townhouse'].includes(l.type);
  const notR1Hoa = !(l.zone === 'R1' && l.hoa > 0);
  const notHighHoa = !(l.hoa && l.hoa >= 1000);  // High HOA = shared land/CC&Rs
  const notFireZone = !l.fireZone;
  const minLot = ['R1','LAND'].includes(l.zone) ? 2400 : 1200;  // 2 units min: R1=2√ó1200, MF=2√ó600
  const validLot = l.lotSf && l.lotSf >= minLot;
  const maxLotSf = ['R1','LAND'].includes(l.zone) ? 65340 : 217800;
  const underAcreageCap = !l.lotSf || l.lotSf <= maxLotSf;
  const inUrbanArea = l.urbanArea !== false;  // true or undefined (not yet checked) = OK
  return validZone && notCondoTownhouse && notR1Hoa && notHighHoa && notFireZone && validLot && underAcreageCap && inUrbanArea;
}

function getMinLotPerUnit(zone){
  // SB 1123: 1,200 SF min per parcel in single-family zones, 600 SF in multifamily
  if(zone === 'R1') return 1200;
  if(zone === 'LAND') return 1200;  // Assume R1 density for unzoned land
  return 600;  // R2, R3, R4
}

function getMaxUnits(l){
  if(!l.lotSf) return 1;
  const minPer = getMinLotPerUnit(l.zone);
  const byLot = Math.floor(l.lotSf / minPer);
  return Math.min(10, Math.max(1, byLot));  // SB 1123 caps at 10
}

function getSlopeAdjBuildCost(slope,base){
  // base = all-in $/SF; add $15/SF per 5% slope above 5%
  if(!slope||slope<=5) return base;
  return base + Math.ceil((slope-5)/5)*15;
}

// Comp confidence indicator: how reliable is the exit $/SF?
function compConfidence(l){
  // Determine active comp source + count
  let count = 0, method = '', radius = 0;
  if(l.subdivExitPsf){
    count = l.subdivCompCount || 0;
    method = 'subdiv';
    radius = l.subdivCompRadius || 0;
  } else if(l.newconPpsf){
    count = l.newconCount || 0;
    method = l.newconFlag === 'cross-zone' ? 'newcon-xz' : 'newcon';
    // newcon doesn't store radius, estimate from tier
  } else if(l.exitPsf){
    count = l.compCount || 0;
    method = l.compMethod || 'none';
    radius = l.compRadius || 0;
  } else {
    return {score: 0, label: 'No Data', color: '#ef4444', icon: '&#9711;', bar: 0};
  }

  // Score: 0-100 based on comp count + method quality
  let score = 0;

  // Count contribution (0-60 pts): 3=15, 5=25, 10=40, 20=50, 30+=60
  if(count >= 30) score += 60;
  else if(count >= 20) score += 50;
  else if(count >= 10) score += 40;
  else if(count >= 5) score += 25;
  else if(count >= 3) score += 15;
  else score += count * 3;

  // Method quality (0-40 pts)
  if(method === 'subdiv') score += 40;        // Best: actual subdivision sales
  else if(method === 'newcon') score += 35;    // Great: zone-matched new construction
  else if(method === 'newcon-xz') score += 25; // Good: cross-zone new construction
  else if(method === 'zone') score += 30;      // Good: zone-matched all sales
  else if(method === 'all') score += 20;       // OK: all-zone
  else if(method === 'zone-thin') score += 15; // Weak: thin zone-matched
  else if(method === 'all-thin') score += 10;  // Weak: thin all-zone
  else if(method.includes('zip')) score += 8;  // Poor: zip fallback
  else score += 5;

  // Flags: penalize
  if(l.newconFlag === 'sanity-high') score -= 10;
  if(l.compMethod && l.compMethod.includes('thin')) score -= 10;

  score = Math.max(0, Math.min(100, score));

  // Map to label + color
  let label, color, icon;
  if(score >= 75){ label = 'High'; color = '#22c55e'; icon = '&#9679;&#9679;&#9679;'; }
  else if(score >= 50){ label = 'Medium'; color = '#f59e0b'; icon = '&#9679;&#9679;&#9675;'; }
  else if(score >= 25){ label = 'Low'; color = '#f97316'; icon = '&#9679;&#9675;&#9675;'; }
  else { label = 'Very Low'; color = '#ef4444'; icon = '&#9675;&#9675;&#9675;'; }

  return {score, label, color, icon, bar: Math.round(score), count, method, radius};
}

// ‚îÄ‚îÄ Deal Scorecard (hero metrics banner) ‚îÄ‚îÄ
function dealScorecard(l, pf, btr){
  const exitPsf = exitLabel(l).psf;
  const allInPsf = pf.effective_buildable_sf>0 ? Math.round(pf.totalCost/pf.effective_buildable_sf) : 0;
  const spread = exitPsf - allInPsf;
  const spreadColor = spread>=100?'var(--green)':spread>=0?'var(--yellow)':'var(--red)';
  const marginColor = pf.margin>=30?'var(--green)':pf.margin>=15?'var(--yellow)':'var(--red)';
  const moColor = pf.max_offer>=l.price?'var(--green)':'var(--red)';
  const moVal = pf.max_offer>=1000000?'$'+(pf.max_offer/1000000).toFixed(1)+'M':'$'+Math.round(pf.max_offer/1000).toLocaleString()+'k';
  return '<div class="popup-scorecard">'
    +'<div><div class="sc-label">SPREAD</div><div class="sc-value" style="color:'+spreadColor+'">$'+spread+'/sf</div></div>'
    +'<div><div class="sc-label">NET MARGIN</div><div class="sc-value" style="color:'+marginColor+'">'+pf.margin.toFixed(1)+'%</div></div>'
    +'<div><div class="sc-label">MAX OFFER</div><div class="sc-value" style="color:'+moColor+'">'+moVal+'</div></div>'
    +'<div><div class="sc-label">UNITS</div><div class="sc-value">'+pf.maxUnits+'</div></div>'
    +'</div>';
}

// ‚îÄ‚îÄ Action links bar ‚îÄ‚îÄ
function actionLinksBar(l){
  return '<div class="popup-links">'
    +'<a href="https://www.google.com/maps?q='+l.lat+','+l.lng+'&t=k&z=19" target="_blank">Maps &#8599;</a>'
    +(l.url?'<a href="'+l.url+'" target="_blank">Redfin &#8599;</a>':'')
    +'<a href="'+getZimasUrl(l)+'" target="_blank" style="color:var(--yellow)">ZIMAS &#8599;</a>'
    +(l.lw&&l.ld?'<a href="'+lotPlannerUrl(l)+'" target="_blank">Planner &#8599;</a>':'')
    +'</div>';
}

// ‚îÄ‚îÄ Condensed Due Diligence ‚îÄ‚îÄ
function dueDiligenceBlock(l){
  var failures = [];
  if(l.burnZone) failures.push('<span style="color:var(--red)">&#10007;</span> &#128293; BURN ZONE');
  else if(l.fireZone) failures.push('<span style="color:var(--red)">&#10007;</span> VHFHSZ fire zone');
  if(l.rsoRisk) failures.push('<span style="color:var(--red)">&#10007;</span> RSO rent-controlled (Ellis Act)');
  var sb = slopeBadge(l);
  if(sb && sb.includes('&#10007;')) failures.push(sb.replace(/^ ‚Ä¢ /,''));

  var h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">Due Diligence</div>';
  if(failures.length === 0){
    h += '<div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">'
      +'<span style="color:var(--green)">&#10003;</span> All checks passed &nbsp;&bull;&nbsp; '
      +'<span style="color:var(--yellow)">&#9733;</span> TPA = 0 parking'
      +(sb?sb:'')
      +'</div>';
  } else {
    h += '<div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">'
      +failures.join(' &bull; ')
      +' &bull; <span style="color:var(--yellow)">&#9733;</span> TPA = 0 parking'
      +'</div>';
  }
  if(l.rsoRisk&&l.zone!=='R1'&&l.zone!=='LAND'){
    h += '<div class="popup-span-2" style="font-size:10px;color:#dc2626;line-height:1.4">&#9888; RSO: Budget ~$20K/unit relocation + 120-day Ellis Act notice</div>';
  }
  return h;
}

// ‚îÄ‚îÄ Collapsible Economics (cost breakdown) ‚îÄ‚îÄ
function economicsBlock(pf, opts){
  opts = opts || {};
  var collapseId = 'econ-'+Math.random().toString(36).slice(2,8);
  var h = '<div class="popup-section-label">'+(opts.label||'Economics')+'</div>';
  // Always visible: Build $/SF + Construction
  h += '<div><div class="popup-label">Build $/SF'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' <span style="color:var(--orange)">(slope)</span>':'')+'</div><div class="popup-value"'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':'')+'>$'+pf.adjBuildCostPerSf+'/sf</div></div>';
  h += '<div><div class="popup-label">Construction</div><div class="popup-value">$'+Math.round(pf.constructionCost).toLocaleString()+'</div></div>';
  // Collapsible: remaining cost items
  var carryTotal = pf.carryInterest + pf.carryPropTax + pf.insurance + pf.originationFee + (pf.demo>0?pf.demo:0);
  h += '<div class="popup-span-2"><div class="popup-collapse-toggle" onclick="var b=document.getElementById(\''+collapseId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> Cost breakdown &mdash; $'+Math.round(carryTotal).toLocaleString()+' carry+soft</div>';
  h += '<div class="popup-collapse-body" id="'+collapseId+'" style="display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;padding-top:4px">';
  if(pf.demo>0) h += '<div><div class="popup-label">Demo</div><div class="popup-value">$'+pf.demo.toLocaleString()+'</div></div><div></div>';
  h += '<div><div class="popup-label">Insurance</div><div class="popup-value">$'+pf.insurance.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Origination ('+proforma.originationPct+'%)</div><div class="popup-value">$'+pf.originationFee.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Carry Interest ('+proforma.holdMonths+'mo)</div><div class="popup-value">$'+pf.carryInterest.toLocaleString()+'</div></div>';
  h += '<div><div class="popup-label">Prop Tax ('+proforma.holdMonths+'mo)</div><div class="popup-value">$'+pf.carryPropTax.toLocaleString()+'</div></div>';
  h += '</div></div>';
  return h;
}

// ‚îÄ‚îÄ BTR section (collapsible when not viable) ‚îÄ‚îÄ
function btrConfidenceDot(conf){
  if(conf==='validated') return '<span style="color:#22c55e" title="Validated (5+ comps)">\u25cf</span>';
  if(conf==='estimated') return '<span style="color:#eab308" title="Estimated (<5 comps)">\u25d0</span>';
  if(conf==='manual') return '<span style="color:#3b82f6" title="Manual neighborhood data">\u25cf</span>';
  return '<span style="color:#64748b" title="Default (no local data)">\u25cb</span>';
}

function btrBlock(l, btr){
  var hasRent = btr.baseRent > 0;
  if(!hasRent){
    return '<div class="popup-divider"></div>'
      +'<div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>'
      +'<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(100,116,139,0.1);color:#94a3b8;font-size:11px">&#9888;&#65039; No rent data</div>';
  }
  var collapseId = 'btr-'+Math.random().toString(36).slice(2,8);
  var viable = btr.btrPencils;
  var h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>';

  // Three-scenario table (from pre-computed pipeline data)
  var hasScenarios = l.rentBase > 0 && l.yocBase > 0;
  var btrContent = '';
  if(hasScenarios){
    var conf = l.confidence || 'default';
    var pf_str = l.premiumFactor ? l.premiumFactor.toFixed(2)+'x' : 'N/A';
    btrContent += '<div class="popup-span-2" style="margin:4px 0 2px">';
    btrContent += '<table style="width:100%;font-size:11px;font-family:\'JetBrains Mono\',monospace;border-collapse:collapse">';
    btrContent += '<tr style="color:#8b8fa3;font-size:10px"><td></td><td style="text-align:right">$/mo</td><td style="text-align:right">YoC</td></tr>';
    // Conservative
    btrContent += '<tr><td style="color:#8b8fa3;padding:1px 0">Conservative</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentConservative.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocConservative>=0.04?'var(--green)':l.yocConservative>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocConservative||0)*100).toFixed(1)+'%</td></tr>';
    // Base
    btrContent += '<tr style="font-weight:600"><td style="padding:1px 0">Base Case '+btrConfidenceDot(conf)+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentBase.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocBase>=0.04?'var(--green)':l.yocBase>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocBase||0)*100).toFixed(1)+'%</td></tr>';
    // Aggressive
    btrContent += '<tr><td style="color:#8b8fa3;padding:1px 0">Aggressive</td>';
    btrContent += '<td style="text-align:right;padding:1px 4px">$'+l.rentAggressive.toLocaleString()+'</td>';
    btrContent += '<td style="text-align:right;padding:1px 0;color:'+(l.yocAggressive>=0.04?'var(--green)':l.yocAggressive>=0.03?'var(--yellow)':'var(--red)')+'">'+((l.yocAggressive||0)*100).toFixed(1)+'%</td></tr>';
    btrContent += '</table></div>';
    // Data source footer
    btrContent += '<div class="popup-span-2" style="font-size:10px;color:#64748b;padding:2px 0;display:flex;gap:8px;flex-wrap:wrap">';
    if(l.safmr3br) btrContent += '<span>SAFMR: $'+l.safmr3br.toLocaleString()+'</span>';
    if(l.zoriBase) btrContent += '<span>ZORI: $'+l.zoriBase.toLocaleString()+'</span>';
    if(l.premiumFactor) btrContent += '<span>Premium: '+pf_str+'</span>';
    btrContent += '<span>'+btrConfidenceDot(conf)+' '+conf+'</span>';
    btrContent += '</div>';
  }

  // Existing BTR metrics (from calculateBTRProForma)
  btrContent += '<div><div class="popup-label">Rent Source</div><div class="popup-value">'+getRentSourceLabel(l)+'</div></div>';
  if(RENTAL_COMPS.length > 0 && l.rentMethod && l.rentMethod.startsWith('rental-comp')){
    btrContent += '<div class="popup-span-2" style="font-size:10px;line-height:1.4"><a href="#" onclick="showRentalCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">'+l.rentCompCount+' rental comps within '+l.rentCompRadius+'mi &#8599;</a></div>';
  }
  btrContent += '<div><div class="popup-label">Est. Rent/Unit</div><div class="popup-value">$'+btr.rentPerUnit.toLocaleString()+'/mo <small style="color:var(--text-dim)">('+proforma.avgUnitSf.toLocaleString()+' SF)</small></div></div>';
  btrContent += '<div><div class="popup-label">NOI</div><div class="popup-value">$'+Math.round(btr.annualNOI).toLocaleString()+'</div></div>';
  btrContent += '<div><div class="popup-label">YOC</div><div class="popup-value" style="color:'+(btr.yieldOnCost>=btr.minYOC?'var(--green)':btr.yieldOnCost>=btr.minYOC*0.8?'var(--yellow)':'var(--red)')+'">'+(btr.yieldOnCost*100).toFixed(1)+'%</div></div>';
  btrContent += '<div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:'+(btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)')+'">$'+(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')+'M</div></div>';
  btrContent += '<div><div class="popup-label">Cap Rate</div><div class="popup-value">'+(btr.capRate*100).toFixed(1)+'%</div></div>';
  if(viable){
    btrContent += '<div><div class="popup-label">DSCR</div><div class="popup-value" style="color:'+(btr.dscr>=1.25?'var(--green)':btr.dscr>=1.15?'var(--yellow)':'var(--red)')+'">'+btr.dscr.toFixed(2)+'x</div></div>';
    btrContent += '<div><div class="popup-label">Cash Flow</div><div class="popup-value" style="color:'+(btr.cashFlow>=0?'var(--green)':'var(--red)')+'">$'+Math.round(btr.cashFlow).toLocaleString()+'/yr</div></div>';
  }
  if(viable){
    // Expanded by default when viable
    h += btrContent;
  } else {
    // Collapsed with summary line when not viable
    var summaryYoc = (btr.yieldOnCost*100).toFixed(1);
    var summaryStab = '$'+(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')+'M';
    h += '<div class="popup-span-2"><div class="popup-collapse-toggle" onclick="var b=document.getElementById(\''+collapseId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> BTR: '+summaryYoc+'% YOC &middot; Stab '+summaryStab+'</div>';
    h += '<div class="popup-collapse-body" id="'+collapseId+'" style="display:grid;grid-template-columns:1fr 1fr;gap:3px 12px;padding-top:4px">';
    h += btrContent;
    h += '</div></div>';
  }
  return h;
}

// ‚îÄ‚îÄ Pro Forma Block (shared across all 3 pin card templates) ‚îÄ‚îÄ
function proFormaBlock(l, pf, opts){
  opts = opts || {};
  const buyLabel = opts.buyLabel || 'Buy/Unit';
  const buyPerUnit = opts.buyPerUnit != null ? opts.buyPerUnit : pf.pricePerUnit;
  const comparePrice = opts.comparePrice != null ? opts.comparePrice : l.price;
  const cc = compConfidence(l);
  const lbColor = pf.land_basis_psf<120?'var(--green)':pf.land_basis_psf<=160?'var(--yellow)':'var(--red)';
  const moColor = pf.max_offer>=comparePrice?'var(--green)':'var(--red)';
  let h = '<div class="popup-divider"></div>';
  h += '<div class="popup-section-label">PRO FORMA &mdash; <span class="pf-units">'+pf.maxUnits+'</span> UNITS';
  if(l.layoutNote) h += ' <span style="color:var(--orange);font-weight:400">(layout-capped from '+l.densityUnits+')</span>';
  else if(l.slopeAdjUnits) h += ' <span style="color:var(--orange);font-weight:400">(slope-adj ~'+l.slopeAdjUnits+')</span>';
  h += ' &bull; <span class="pf-buildable-sf">'+pf.effective_buildable_sf.toLocaleString()+'</span> SF</div>';
  if(l.layoutNote) h += '<div class="popup-span-2" style="color:var(--orange);font-size:11px">&#9888; '+l.layoutNote+'</div>';
  h += '<div class="popup-span-2" style="font-size:10px;line-height:1.4"><span style="color:'+cc.color+';letter-spacing:2px">'+cc.icon+'</span> <a href="#" onclick="showCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">'+cc.count+' comps'+(cc.radius ? ' within '+cc.radius+'mi' : '')+' &#8599;</a></div>';
  h += '<div class="popup-span-2" style="display:flex;justify-content:space-between;font-size:11px"><span>'+buyLabel+' <b class="pf-buy-per-unit">$'+buyPerUnit.toLocaleString()+'</b></span><span>Total Cost <b class="pf-total-cost">$'+Math.round(pf.totalCost).toLocaleString()+'</b></span></div>';
  h += '<div class="popup-span-2" style="display:flex;justify-content:space-between;font-size:11px"><span>Land Basis <b class="pf-land-basis" style="color:'+lbColor+'">$'+pf.land_basis_psf+'/sf</b></span><span>Buildable SF <b class="pf-buildable-sf2">'+pf.effective_buildable_sf.toLocaleString()+' sf</b></span></div>';
  h += '<div class="popup-span-2 pf-max-offer-row" style="font-size:11px;font-weight:600;color:'+moColor+'">Max Offer @ 30%: <span class="pf-max-offer">$'+pf.max_offer.toLocaleString()+'</span></div>';
  h += remainderAnalysis(l);
  return h;
}

// ‚îÄ‚îÄ View Comps ‚îÄ‚îÄ

const COMP_SQFT_MIN = 1300, COMP_SQFT_MAX = 3500; // Match listings_build.py size band
const ZONE_TYPE_MAP = {R1:'SFR',R2:'TH/Condo',R3:'MF 2-4',R4:'MF 5+',LAND:'Land'};
const PT_LABEL = {1:'SFR',2:'Condo',3:'Townhome',4:'MF 2-4',5:'MF 5+'};
const ADJ_ZONES = {R1:['R2'],R2:['R1','R3'],R3:['R2','R4'],R4:['R3'],LAND:['R1']};

function distMi(lat1,lng1,lat2,lng2){
  const dlat=(lat2-lat1)*69, dlng=(lng2-lng1)*69*Math.cos(lat1*Math.PI/180);
  return Math.sqrt(dlat*dlat+dlng*dlng);
}

function searchCompsInRadius(lat,lng,radiusMi){
  if(!compSpatialGrid || !COMPS.length) return [];
  const radiusDeg=radiusMi/69, S=0.005;
  const rMin=Math.floor((lat-radiusDeg)/S), rMax=Math.floor((lat+radiusDeg)/S);
  const cMin=Math.floor((lng-radiusDeg)/S), cMax=Math.floor((lng+radiusDeg)/S);
  const out=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=compSpatialGrid[r+','+c];
      if(cell) cell.forEach(comp=>{
        // Use box check matching Python: abs(dlat)<=radius && abs(dlng)<=radius
        if(Math.abs(comp.lat-lat)<=radiusDeg && Math.abs(comp.lng-lng)<=radiusDeg){
          out.push(Object.assign({},comp,{dist:distMi(lat,lng,comp.lat,comp.lng)}));
        }
      });
    }
  }
  return out;
}

function findCompsForListing(l){
  if(!COMPS.length) return {used:[],ref:[],source:'none',radius:0};

  let source,searchRadius,targetCount;

  if(l.subdivExitPsf){
    source='subdiv'; searchRadius=l.subdivCompRadius||2; targetCount=l.subdivCompCount||0;
  } else if(l.newconPpsf){
    source='newcon'; searchRadius=2; targetCount=l.newconCount||0;
  } else if(l.exitPsf){
    source='zone'; searchRadius=l.compRadius||1; targetCount=l.compCount||0;
  } else {
    return {used:[],ref:[],source:'none',radius:0};
  }

  // Wider search for reference comps
  const wideRadius = Math.min(searchRadius*2, 5);
  const all = searchCompsInRadius(l.lat,l.lng,wideRadius);

  const used=[], ref=[];
  for(const c of all){
    const inRadius = c.dist <= searchRadius + 0.05; // small tolerance
    let isUsed = false;

    if(source==='newcon'){
      // New-con: yb>=2021, zone-matched or cross-zone
      const isNewcon = c.yb && c.yb >= 2021;
      const zmOrAdj = l.newconZoneMatch
        ? c.zone===l.zone
        : (c.zone===l.zone || (ADJ_ZONES[l.zone]||[]).includes(c.zone));
      const inBand = c.sqft>=COMP_SQFT_MIN && c.sqft<=COMP_SQFT_MAX;
      isUsed = inRadius && isNewcon && zmOrAdj && inBand;
    } else if(source==='subdiv'){
      // Subdiv: zone-matched, recent sales
      isUsed = inRadius && c.zone===l.zone && c.yb && c.yb>=2021;
    } else {
      // Zone/all comps
      const method = l.compMethod||'';
      const zoneMatch = method.startsWith('zone') ? c.zone===l.zone : true;
      const inBand = c.sqft>=COMP_SQFT_MIN && c.sqft<=COMP_SQFT_MAX;
      // Try size-band match first
      isUsed = inRadius && zoneMatch && inBand;
    }

    c.isUsed = isUsed;
    c.isOutlier = c.sqft<400 || c.ppsf>2000;
    if(isUsed && !c.isOutlier) used.push(c);
    else ref.push(c);
  }

  // If zone comps and size-band gave too few, widen to all-size (matching Python fallback)
  if(source==='zone' && used.length < targetCount){
    const method = l.compMethod||'';
    const zoneMatch = method.startsWith('zone');
    // Move non-band, in-radius, zone-matched comps from ref to used
    for(let i=ref.length-1;i>=0;i--){
      const c=ref[i];
      if(c.dist<=searchRadius+0.05 && !c.isOutlier && (zoneMatch?c.zone===l.zone:true)){
        c.isUsed=true;
        used.push(ref.splice(i,1)[0]);
      }
    }
  }

  used.sort((a,b)=>a.dist-b.dist);
  ref.sort((a,b)=>a.dist-b.dist);
  return {used,ref,source,radius:searchRadius};
}

function formatCompDate(d){
  if(!d) return '‚Äî';
  const parts = d.split('-');
  if(parts.length>=3) return parts[0].substring(0,3)+' '+parts[2];
  return d;
}

function compRow(c){
  const outlier = c.isOutlier;
  const style = outlier ? 'opacity:0.4' : c.isUsed ? 'border-left:3px solid var(--green)' : '';
  const tag = outlier ? ' <span style="color:var(--orange);font-size:9px">&#9888; outlier</span>' : '';
  return `<tr style="cursor:pointer;${style}" onclick="map.flyTo([${c.lat},${c.lng}],17)">
    <td style="text-align:center">${c.isUsed&&!outlier?'<span style="color:var(--green)">&#10003;</span>':''}</td>
    <td style="white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis">${c.address||'‚Äî'}${tag}</td>
    <td>$${c.price.toLocaleString()}</td>
    <td style="color:${c.ppsf>=800?'var(--green)':c.ppsf>=600?'var(--yellow)':'var(--red)'}">$${c.ppsf}</td>
    <td>${c.sqft.toLocaleString()}</td>
    <td>${c.bd||'‚Äî'}/${c.ba||'‚Äî'}</td>
    <td${c.pt===3?' style="color:var(--green);font-weight:600"':''}>${PT_LABEL[c.pt]||ZONE_TYPE_MAP[c.zone]||c.zone||'‚Äî'}</td>
    <td>${c.zone||'‚Äî'}</td>
    <td>${c.yb||'‚Äî'}</td>
    <td style="color:${c.t===1?'var(--green)':'var(--text-dim)'}">T${c.t||'?'}</td>
    <td>${formatCompDate(c.date)}</td>
    <td>${c.dist.toFixed(2)}mi</td>
  </tr>`;
}

function showCompsTable(lat,lng){
  const l = LISTINGS.find(ll=>ll.lat===lat&&ll.lng===lng);
  if(!l || !COMPS.length) return;
  if(!listingsPanelOpen) toggleListingsPanel();

  // Hide any existing rental comps table first
  if(rentalCompsTableActive) hideRentalCompsTable();

  const {used,ref,source,radius} = findCompsForListing(l);
  const sourceLabel = {subdiv:'Subdivision',newcon:'New Construction',zone:'Zone-Matched'}[source]||source;

  // Hide pipeline elements
  document.getElementById('tableWrap').style.display='none';
  document.getElementById('mobileCards').style.display='none';
  const header = document.querySelector('.listings-panel-header');
  savedPipelineHeader = header.innerHTML;
  header.innerHTML = `
    <button onclick="hideCompsTable()" style="background:none;border:1px solid var(--border);color:var(--text);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap">&larr; Back to Pipeline</button>
    <div style="flex:1;min-width:0">
      <div style="font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">BTS COMPS &mdash; ${l.address}</div>
      <div style="font-size:11px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${sourceLabel} &bull; ${used.length} used / ${used.length+ref.length} nearby within ${radius.toFixed(1)}mi</div>
    </div>
    <button class="listings-panel-close" onclick="hideCompsTable()">x</button>
  `;

  // Create or reuse comps container
  let wrap = document.getElementById('compsTableWrap');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'compsTableWrap';
    wrap.className = 'listings-table-wrap';
    const panel = document.getElementById('listingsPanel');
    panel.insertBefore(wrap, document.getElementById('tableWrap'));
  }
  wrap.style.display = '';

  const thead = `<table class="listings-table"><thead><tr>
    <th style="width:30px">Used</th>
    <th onclick="sortCompsTable('address')">Address</th>
    <th onclick="sortCompsTable('price')">Sale Price</th>
    <th onclick="sortCompsTable('ppsf')">$/SF</th>
    <th onclick="sortCompsTable('sqft')">SqFt</th>
    <th>Bd/Ba</th>
    <th>Type</th>
    <th onclick="sortCompsTable('zone')">Zone</th>
    <th onclick="sortCompsTable('yb')">Yr Built</th>
    <th onclick="sortCompsTable('t')">Tier</th>
    <th onclick="sortCompsTable('date')">Sale Date</th>
    <th onclick="sortCompsTable('dist')">Dist</th>
  </tr></thead>`;

  const dividerRow = ref.length ? `<tr><td colspan="12" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${ref.length}) &mdash;</td></tr>` : '';
  const tbody = `<tbody>${used.map(c=>compRow(c)).join('')}${dividerRow}${ref.filter(c=>!c.isOutlier).map(c=>compRow(c)).join('')}</tbody></table>`;
  wrap.innerHTML = thead + tbody;

  // Store data for sorting
  wrap._used = used;
  wrap._ref = ref;
  wrap._listing = l;

  // Map markers ‚Äî used=green, reference=gray
  if(compsMapLayer){ map.removeLayer(compsMapLayer); }
  if(compsRadiusCircle){ map.removeLayer(compsRadiusCircle); }
  compsMapLayer = L.layerGroup();
  used.forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:6, color:'#22c55e', fillColor:'#22c55e', fillOpacity:0.8, weight:1
    }).bindPopup(`<b>${c.address||'‚Äî'}</b><br>$${c.price.toLocaleString()} &bull; $${c.ppsf}/sf &bull; ${c.sqft}sf<br>${c.date||'‚Äî'} &bull; T${c.t||'?'} &bull; ${c.zone}`).addTo(compsMapLayer);
  });
  ref.filter(c=>!c.isOutlier).forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:4, color:'#64748b', fillColor:'#64748b', fillOpacity:0.4, weight:1
    }).addTo(compsMapLayer);
  });
  compsRadiusCircle = L.circle([l.lat,l.lng],{
    radius: radius*1609.34, color:'#22c55e', fillColor:'#22c55e',
    fillOpacity:0.04, weight:1, dashArray:'6,4'
  });
  compsMapLayer.addTo(map);
  compsRadiusCircle.addTo(map);
  compsTableActive = true;
}

function sortCompsTable(key){
  const wrap = document.getElementById('compsTableWrap');
  if(!wrap || !wrap._used) return;
  const prev = wrap.getAttribute('data-sort-key');
  const dir = prev===key && wrap.getAttribute('data-sort-dir')!=='asc' ? 'asc' : 'desc';
  wrap.setAttribute('data-sort-key', key);
  wrap.setAttribute('data-sort-dir', dir==='asc' ? 'desc' : 'asc');
  const sorter = (a,b)=>{
    let va=a[key],vb=b[key];
    if(typeof va==='string') return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);
    va=va||0;vb=vb||0;
    return dir==='asc'?va-vb:vb-va;
  };
  wrap._used.sort(sorter);
  wrap._ref.sort(sorter);
  const dividerRow = wrap._ref.length ? `<tr><td colspan="12" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${wrap._ref.length}) &mdash;</td></tr>` : '';
  wrap.querySelector('tbody').innerHTML = wrap._used.map(c=>compRow(c)).join('') + dividerRow + wrap._ref.filter(c=>!c.isOutlier).map(c=>compRow(c)).join('');
}

function hideCompsTable(){
  // Restore pipeline
  document.getElementById('tableWrap').style.display='';
  document.getElementById('mobileCards').style.display='';
  const header = document.querySelector('.listings-panel-header');
  if(savedPipelineHeader) header.innerHTML = savedPipelineHeader;
  const wrap = document.getElementById('compsTableWrap');
  if(wrap) wrap.remove();
  // Remove map markers
  if(compsMapLayer){ map.removeLayer(compsMapLayer); compsMapLayer=null; }
  if(compsRadiusCircle){ map.removeLayer(compsRadiusCircle); compsRadiusCircle=null; }
  compsTableActive = false;
}

// ‚îÄ‚îÄ Rental Comps Table ‚îÄ‚îÄ

function buildRentalCompGrid(comps){
  const grid = {};
  const S = 0.005;
  comps.forEach(c=>{
    const key = Math.floor(c.lat/S)+','+Math.floor(c.lng/S);
    if(!grid[key]) grid[key]=[];
    grid[key].push(c);
  });
  return grid;
}

function searchRentalCompsInRadius(lat,lng,radiusMi){
  if(!rentalCompGrid || !RENTAL_COMPS.length) return [];
  const radiusDeg=radiusMi/69, S=0.005;
  const rMin=Math.floor((lat-radiusDeg)/S), rMax=Math.floor((lat+radiusDeg)/S);
  const cMin=Math.floor((lng-radiusDeg)/S), cMax=Math.floor((lng+radiusDeg)/S);
  const out=[];
  for(let r=rMin;r<=rMax;r++){
    for(let c=cMin;c<=cMax;c++){
      const cell=rentalCompGrid[r+','+c];
      if(cell) cell.forEach(comp=>{
        if(Math.abs(comp.lat-lat)<=radiusDeg && Math.abs(comp.lng-lng)<=radiusDeg){
          out.push(Object.assign({},comp,{dist:distMi(lat,lng,comp.lat,comp.lng)}));
        }
      });
    }
  }
  return out;
}

const RENTAL_PT_LABEL = {1:'SFR',2:'Condo',3:'Townhome',4:'MF 2-4',5:'MF 5+'};
const SFR_TH_TYPES = [1,2,3,4]; // SFR, Condo, TH, MF 2-4

function findRentalCompsForListing(l){
  if(!RENTAL_COMPS.length) return {used:[],ref:[],radius:0,method:'none'};
  const method = l.rentMethod||'';

  // Determine search radius from listing data
  let usedRadius = l.rentCompRadius || 1;
  // Widen for reference comps
  const wideRadius = Math.min(usedRadius * 2, 5);
  const all = searchRentalCompsInRadius(l.lat, l.lng, wideRadius);

  const used=[], ref=[];
  for(const c of all){
    const inRadius = c.dist <= usedRadius + 0.05;
    let isUsed = false;

    if(method === 'rental-comp' || method === 'rental-comp-wide'){
      // Tier 1/2: 3+ BR, 1200+ SF, SFR/TH/Condo/MF types
      const bdOk = (c.bd||0) >= 3;
      const sfOk = (c.sqft||0) >= 1200;
      const ptOk = SFR_TH_TYPES.includes(c.pt||0);
      isUsed = inRadius && bdOk && sfOk && ptOk;
    } else if(method === 'rental-adj'){
      // Tier 3: 2+ BR, 900+ SF, all types
      const bdOk = (c.bd||0) >= 2;
      const sfOk = (c.sqft||0) >= 900;
      isUsed = inRadius && bdOk && sfOk;
    } else {
      // ZORI/SAFMR ‚Äî show nearby for reference but none "used"
      isUsed = false;
    }

    c.isUsed = isUsed;
    if(isUsed) used.push(c);
    else ref.push(c);
  }

  used.sort((a,b)=>a.dist-b.dist);
  ref.sort((a,b)=>a.dist-b.dist);
  return {used, ref, radius:usedRadius, method};
}

function rentalCompRow(c){
  const rentPsf = (c.sqft && c.sqft > 0) ? (c.rent / c.sqft).toFixed(2) : '‚Äî';
  const style = c.isUsed ? 'border-left:3px solid var(--green)' : '';
  return `<tr style="cursor:pointer;${style}" onclick="map.flyTo([${c.lat},${c.lng}],17)">
    <td style="text-align:center">${c.isUsed?'<span style="color:var(--green)">&#10003;</span>':''}</td>
    <td style="white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis">${c.addr||'‚Äî'}</td>
    <td>$${c.rent.toLocaleString()}</td>
    <td>${rentPsf==='‚Äî'?'‚Äî':'$'+rentPsf}</td>
    <td>${c.bd||'‚Äî'}</td>
    <td>${c.ba||'‚Äî'}</td>
    <td>${c.sqft?c.sqft.toLocaleString():'‚Äî'}</td>
    <td>${RENTAL_PT_LABEL[c.pt]||'‚Äî'}</td>
    <td>${c.dist.toFixed(2)}mi</td>
  </tr>`;
}

function showRentalCompsTable(lat,lng){
  const l = LISTINGS.find(ll=>ll.lat===lat&&ll.lng===lng);
  if(!l || !RENTAL_COMPS.length) return;
  if(!listingsPanelOpen) toggleListingsPanel();

  // Hide any existing comps table first
  if(compsTableActive) hideCompsTable();

  const {used,ref,radius,method} = findRentalCompsForListing(l);

  // Hide pipeline elements
  document.getElementById('tableWrap').style.display='none';
  document.getElementById('mobileCards').style.display='none';
  const header = document.querySelector('.listings-panel-header');
  if(!rentalCompsTableActive && !compsTableActive) savedPipelineHeader = header.innerHTML;
  header.innerHTML = `
    <button onclick="hideRentalCompsTable()" style="background:none;border:1px solid var(--border);color:var(--text);padding:4px 12px;border-radius:6px;cursor:pointer;font-size:12px;white-space:nowrap">&larr; Back to Pipeline</button>
    <div style="flex:1;min-width:0">
      <div style="font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">RENTAL COMPS &mdash; ${l.address}</div>
      <div style="font-size:11px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${used.length} used / ${used.length+ref.length} nearby within ${radius.toFixed(1)}mi</div>
    </div>
    <button class="listings-panel-close" onclick="hideRentalCompsTable()">x</button>
  `;

  // Create or reuse rental comps container
  let wrap = document.getElementById('rentalCompsTableWrap');
  if(!wrap){
    wrap = document.createElement('div');
    wrap.id = 'rentalCompsTableWrap';
    wrap.className = 'listings-table-wrap';
    const panel = document.getElementById('listingsPanel');
    panel.insertBefore(wrap, document.getElementById('tableWrap'));
  }
  wrap.style.display = '';

  const thead = `<table class="listings-table"><thead><tr>
    <th style="width:30px">Used</th>
    <th onclick="sortRentalCompsTable('addr')">Address</th>
    <th onclick="sortRentalCompsTable('rent')">Rent $/mo</th>
    <th onclick="sortRentalCompsTable('rentPsf')">$/SF/mo</th>
    <th onclick="sortRentalCompsTable('bd')">Beds</th>
    <th onclick="sortRentalCompsTable('ba')">Baths</th>
    <th onclick="sortRentalCompsTable('sqft')">SqFt</th>
    <th>Type</th>
    <th onclick="sortRentalCompsTable('dist')">Dist</th>
  </tr></thead>`;

  const dividerRow = ref.length ? `<tr><td colspan="9" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${ref.length}) &mdash;</td></tr>` : '';
  const tbody = `<tbody>${used.map(c=>rentalCompRow(c)).join('')}${dividerRow}${ref.map(c=>rentalCompRow(c)).join('')}</tbody></table>`;
  wrap.innerHTML = thead + tbody;

  // Store data for sorting
  wrap._used = used;
  wrap._ref = ref;
  wrap._listing = l;

  // Map markers ‚Äî used=blue, reference=gray
  if(rentalCompsMapLayer){ map.removeLayer(rentalCompsMapLayer); }
  if(rentalCompsRadiusCircle){ map.removeLayer(rentalCompsRadiusCircle); }
  rentalCompsMapLayer = L.layerGroup();
  used.forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:6, color:'#3b82f6', fillColor:'#3b82f6', fillOpacity:0.8, weight:1
    }).bindPopup(`<b>${c.addr||'‚Äî'}</b><br>$${c.rent.toLocaleString()}/mo &bull; ${c.bd||'?'}bd/${c.ba||'?'}ba &bull; ${c.sqft?c.sqft.toLocaleString()+'sf':'‚Äî'}`).addTo(rentalCompsMapLayer);
  });
  ref.forEach(c=>{
    L.circleMarker([c.lat,c.lng],{
      radius:4, color:'#64748b', fillColor:'#64748b', fillOpacity:0.4, weight:1
    }).addTo(rentalCompsMapLayer);
  });
  rentalCompsRadiusCircle = L.circle([l.lat,l.lng],{
    radius: radius*1609.34, color:'#3b82f6', fillColor:'#3b82f6',
    fillOpacity:0.04, weight:1, dashArray:'6,4'
  });
  rentalCompsMapLayer.addTo(map);
  rentalCompsRadiusCircle.addTo(map);
  rentalCompsTableActive = true;
}

function sortRentalCompsTable(key){
  const wrap = document.getElementById('rentalCompsTableWrap');
  if(!wrap || !wrap._used) return;
  const prev = wrap.getAttribute('data-sort-key');
  const dir = prev===key && wrap.getAttribute('data-sort-dir')!=='asc' ? 'asc' : 'desc';
  wrap.setAttribute('data-sort-key', key);
  wrap.setAttribute('data-sort-dir', dir==='asc' ? 'desc' : 'asc');
  const sorter = (a,b)=>{
    let va,vb;
    if(key==='rentPsf'){
      va=(a.sqft&&a.sqft>0)?a.rent/a.sqft:0;
      vb=(b.sqft&&b.sqft>0)?b.rent/b.sqft:0;
    } else {
      va=a[key]; vb=b[key];
    }
    if(typeof va==='string') return dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);
    va=va||0;vb=vb||0;
    return dir==='asc'?va-vb:vb-va;
  };
  wrap._used.sort(sorter);
  wrap._ref.sort(sorter);
  const dividerRow = wrap._ref.length ? `<tr><td colspan="9" style="text-align:center;padding:6px;color:var(--text-dim);font-size:11px;border-top:2px solid var(--border);border-bottom:1px solid var(--border)">&mdash; Additional comps for reference (${wrap._ref.length}) &mdash;</td></tr>` : '';
  wrap.querySelector('tbody').innerHTML = wrap._used.map(c=>rentalCompRow(c)).join('') + dividerRow + wrap._ref.map(c=>rentalCompRow(c)).join('');
}

function hideRentalCompsTable(){
  document.getElementById('tableWrap').style.display='';
  document.getElementById('mobileCards').style.display='';
  const header = document.querySelector('.listings-panel-header');
  if(savedPipelineHeader) header.innerHTML = savedPipelineHeader;
  const wrap = document.getElementById('rentalCompsTableWrap');
  if(wrap) wrap.remove();
  if(rentalCompsMapLayer){ map.removeLayer(rentalCompsMapLayer); rentalCompsMapLayer=null; }
  if(rentalCompsRadiusCircle){ map.removeLayer(rentalCompsRadiusCircle); rentalCompsRadiusCircle=null; }
  rentalCompsTableActive = false;
}

// Build descriptive exit $/SF label for popup display
function exitLabel(l){
  // Prefer calibrated T1 normalized from CLUSTERS
  if(l.clusterT1psf){
    const t1n = l.clusterT1n || 0;
    const fb = l.clusterFb;
    const fbTag = fb === 0 ? 'per-cell' : fb === 1 ? 'blended' : 'median';
    const conf = (l.clusterRw >= 0.8 && t1n >= 8) ? 'high' : (l.clusterRw >= 0.5 && t1n >= 4) ? 'med' : 'low';
    const color = conf === 'high' ? '#22c55e' : conf === 'med' ? 'var(--accent)' : '#f59e0b';
    return {psf: l.clusterT1psf, label: `T1 NORM ‚Äî ${t1n} comps, ${fbTag}, ${conf} conf`, color, short: 'T1 norm'};
  }
  if(l.subdivExitPsf){
    const count = l.subdivCompCount || 0;
    const radius = l.subdivCompRadius || '';
    const appr = l.subdivAvgAppr ? ` (${l.subdivAvgAppr > 0 ? '+' : ''}${l.subdivAvgAppr.toFixed(1)}% adj)` : '';
    return {psf: l.subdivExitPsf, label: `SUBDIV COMP ‚Äî ${count} comps within ${radius}mi${appr}`, color: '#10b981', short: 'subdiv'};
  }
  const exitPsf = l.newconPpsf || l.exitPsf || 0;
  if(!exitPsf) return {psf: 0, label: 'NO COMP DATA', color: 'var(--red)', short: 'no data'};
  if(l.newconPpsf){
    const tier = l.newconTier || '';
    const count = l.newconCount || 0;
    const zm = l.newconZoneMatch !== false ? 'zone-matched' : 'cross-zone';
    const flag = l.newconFlag;
    let label = `NEW-CON ‚Äî ${count} comps, ${tier}, ${zm}`;
    let color = 'var(--accent)';
    if(flag === 'thin'){ label += ' ‚ö†Ô∏è thin'; color = '#f59e0b'; }
    else if(flag === 'cross-zone'){ color = '#f59e0b'; }
    else if(flag === 'sanity-high'){ label += ' ‚ö†Ô∏è high'; color = '#f59e0b'; }
    return {psf: exitPsf, label, color, short: 'new-con'};
  }
  // General P75 fallback
  const count = l.compCount || 0;
  const radius = l.compRadius || '';
  let reason = '';
  if(l.newconFlag === 'sanity-low') reason = ' ‚Äî newcon failed sanity check';
  else if(l.newconFlag === 'sanity-high') reason = ' ‚Äî newcon flagged high';
  const label = `ALL SALES ‚Äî ${count} comps within ${radius}mi${reason}`;
  return {psf: exitPsf, label, color: 'var(--text-dim)', short: 'all sales'};
}

function calculateProForma(l){
  const densityUnits = getMaxUnits(l);
  let maxUnits = densityUnits;
  let layoutMax = null, layoutNote = null;
  if (l.lw && l.ld) {
    // SB 1123 parcel-depth layout model
    // Driveway (20') is flush to property line ‚Äî it encroaches into the 4' side setback on that side
    // Far side: 4' setback (can't build structure, but driveway side setback is consumed by driveway)
    // Front setback: per underlying zone (R1=20', R2-R4=15')
    const driveW = 20;
    const sideSet = 4; // far-side setback only
    const frontSet = (l.zone === 'R2' || l.zone === 'R3' || l.zone === 'R4') ? 15 : 20;
    const rearSet = 4;
    const unitBuildW = l.lw - driveW - sideSet; // buildable width: lot minus driveway minus far-side setback
    if (unitBuildW >= 20) {
      // Parcel depth = 1,200 SF / full lot width (driveway is shared easement)
      const parcelDepth = 1200 / l.lw;
      const availDepth = l.ld - frontSet - rearSet;
      layoutMax = Math.min(10, Math.floor(availDepth / parcelDepth));
      if (layoutMax > 0 && layoutMax < maxUnits) {
        maxUnits = Math.max(2, layoutMax);
        layoutNote = l.lw + "'\u00d7" + l.ld + "' \u2014 " + layoutMax + " parcels at " + parcelDepth.toFixed(1) + "' depth";
      }
    } else {
      layoutMax = 0;
      layoutNote = "Lot " + l.lw + "' too narrow \u2014 need 44'+ (20' drive + 4' setback + 20' unit)";
    }
  }
  const pf = proforma;
  const valuePerSf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, pf.allInBuildPsf);

  const effective_buildable_sf = maxUnits * pf.avgUnitSf;

  const grossPerUnit = valuePerSf * pf.avgUnitSf;
  const grossRevenue = maxUnits * grossPerUnit;
  const netRevenue = grossRevenue * (1 - pf.txnCostPct / 100) - pf.fixedDispositionCosts;

  const acquisition = l.price;
  const demo = l.sqft > 0 ? pf.demoCost : 0;
  const constructionCost = maxUnits * pf.avgUnitSf * adjBuildCostPerSf;
  const totalBuildCost = constructionCost + demo;

  // Carry costs: interest on construction loan only (cash acquisition)
  const avgLoanOutstanding = totalBuildCost * 0.5;
  const carryInterest = avgLoanOutstanding * (pf.carryRatePct / 100) * (pf.holdMonths / 12);
  const carryPropTax = acquisition * 0.011 * (pf.holdMonths / 12);
  const insurance = pf.insurance || 40000;
  const originationFee = totalBuildCost * ((pf.originationPct || 1) / 100);
  const totalCarry = carryInterest + carryPropTax + insurance + originationFee;

  const totalCost = acquisition + totalBuildCost + totalCarry;
  const profit = netRevenue - totalCost;
  const margin_on_revenue = netRevenue > 0 ? ((profit / netRevenue) * 100) : 0;

  const land_basis_psf = effective_buildable_sf > 0 ? (l.price / effective_buildable_sf) : 0;

  // Max offer at 30% margin: work backwards from target margin
  const target_margin = 0.30;
  const exit_psf = valuePerSf;
  // Net revenue = gross * (1 - txn%) - fixedDisp
  // Total cost = acquisition + build + carry(build-only interest) + propTax(acq) + insurance + origination
  // For max offer, we solve: profit/netRevenue = 0.30 ‚Üí totalCost = netRevenue * 0.70
  // Simplified: max_acq = netRevenue*0.70 - build - carry_on_build - propTax_factor*max_acq - insurance - origination
  // Since propTax depends on acq, iterate or approximate
  const nr = netRevenue;  // Reuse same revenue as economics block
  const target_total_cost = nr * (1 - target_margin);
  const build_carry = avgLoanOutstanding * (pf.carryRatePct / 100) * (pf.holdMonths / 12);
  const build_plus_soft = totalBuildCost + build_carry + insurance + originationFee;
  // max_acq + max_acq * propTaxRate * holdYears = target_total_cost - build_plus_soft
  const propTaxFactor = 0.011 * (pf.holdMonths / 12);
  const max_offer = (target_total_cost - build_plus_soft) / (1 + propTaxFactor);

  const lot_efficiency = l.lotSf > 0 ? (effective_buildable_sf / l.lotSf) : 0;
  const return_on_cost = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

  return {
    maxUnits,
    densityUnits,
    layoutMax,
    layoutNote,
    grossRevenue,
    netRevenue,
    acquisition,
    demo,
    constructionCost,
    totalBuildCost,
    totalCost,
    profit,
    margin: margin_on_revenue,
    margin_on_revenue,
    return_on_cost,
    pricePerUnit: Math.round(acquisition / maxUnits),
    effective_buildable_sf: Math.round(effective_buildable_sf),
    land_basis_psf: Math.round(land_basis_psf),
    max_offer: Math.round(max_offer),
    lot_efficiency,
    adjBuildCostPerSf,
    totalCarry: Math.round(totalCarry),
    carryInterest: Math.round(carryInterest),
    carryPropTax: Math.round(carryPropTax),
    insurance: Math.round(insurance),
    originationFee: Math.round(originationFee),
  };
}

function sizeEquityAndDebt(askingPrice, units, avgUnitSF, buildCostPSF, exitPSF, monthlyRent) {
  const SOFT_PCT = 0.25;
  const DEMO = 55000;
  const SUBDIV = 100000;
  const AE = 150000;
  const TAX_RATE = 0.011;
  const INS_ANNUAL = 20000;
  const AM_MONTHLY = 3000;
  const DM_MONTHLY = 5000;
  const ACQ_FEE_PCT = 0.02;
  const ORIG_FEE_PCT = 0.02;
  const EQUITY_PCT = 0.26;
  const PRE_DEV_MO = 6;
  const CONSTR_MO = 12;
  const SALE_MO = 6;

  const buildableSF = units * avgUnitSF;
  const hardCosts = buildableSF * buildCostPSF;
  const softCosts = hardCosts * SOFT_PCT;
  const totalDev = hardCosts + softCosts + DEMO + SUBDIV + AE;

  const monthlyTax = askingPrice * TAX_RATE / 12;
  const monthlyIns = INS_ANNUAL / 12;
  const preDev = (monthlyTax + monthlyIns + AM_MONTHLY) * PRE_DEV_MO;
  const constr = (monthlyTax + monthlyIns + AM_MONTHLY + DM_MONTHLY) * CONSTR_MO;
  const sale = (monthlyTax + monthlyIns + AM_MONTHLY) * SALE_MO;
  const totalCarry = preDev + constr + sale;

  const acqFee = askingPrice * ACQ_FEE_PCT;

  const baseCosts = askingPrice + totalDev + totalCarry + acqFee;
  const totalCost = baseCosts / (1 - (1 - EQUITY_PCT) * ORIG_FEE_PCT);

  const equity = Math.ceil(totalCost * EQUITY_PCT / 10000) * 10000;
  const debt = Math.round(totalCost - equity);

  return { equity, debt, totalCost: equity + debt };
}

// ‚îÄ‚îÄ Layout Planner URL builder ‚îÄ‚îÄ
// ‚îÄ‚îÄ Lot Layout SVG for popup ‚îÄ‚îÄ
function lotLayoutSection(l, pf){
  if(!l.lw || !l.ld || !pf.maxUnits || pf.maxUnits <= 0 || pf.max_offer <= 0) return '';
  var layoutId = 'lot-layout-'+Math.random().toString(36).slice(2,8);
  return '<div class="lot-layout-toggle" onclick="var b=document.getElementById(\''+layoutId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\')"><span class="tri">&#9654;</span> Lot Layout &middot; '+pf.maxUnits+' units</div>'
    + '<div class="lot-layout-body" id="'+layoutId+'">'+buildLotLayoutSVG(l,pf)+'</div>';
}

function buildLotLayoutSVG(l, pf){
  if(!l.lw || !l.ld) return '';
  var lw = l.lw, ld = l.ld;
  var units = pf.maxUnits || 0;
  var driveW = 20, sideSet = 4, rearSet = 4;
  var frontSet = (l.zone === 'R2' || l.zone === 'R3' || l.zone === 'R4') ? 15 : 20;
  var unitBuildW = lw - driveW - sideSet;
  if(unitBuildW < 20) return '';

  var parcelDepth = 1200 / lw;
  var availDepth = ld - frontSet - rearSet;

  var remDepth = 0;
  if(l.remainderUnits > 0){
    var lotSf = l.lotSf || lw * ld;
    var remSf = lotSf - units * 1200;
    if(remSf > 400) remDepth = Math.min(Math.round(remSf / lw), ld * 0.4);
  }

  var devDepth = availDepth - remDepth;
  if(devDepth < parcelDepth) devDepth = availDepth;
  var maxFit = Math.min(10, Math.floor(devDepth / parcelDepth));
  var placed = Math.min(units, maxFit);

  // SVG viewBox padding for labels
  var padL = 16, padR = 8, padT = 14, padB = 18;
  var totalW = lw + padL + padR;
  var totalH = ld + padT + padB;
  var ox = padL, oy = padT;

  // Compact sizing: scale to fit within 260√ó180px
  var maxPxW = 260, maxPxH = 180;
  var sc = Math.min(maxPxW / totalW, maxPxH / totalH);
  var svgW = Math.round(totalW * sc), svgH = Math.round(totalH * sc);

  // Colors ‚Äî light architectural style
  var cLot = '#fafaf8', cBorder = '#1e3a5f', cSetback = '#e74c3c';
  var cDrive = '#e8e6e1', cDriveBorder = '#c8c5be';
  var cUnit = '#dbeafe', cUnitStroke = '#3b82f6';
  var cYard = '#f0fdf4', cLabel = '#888';
  var cRem = '#fef3c7', cRemStroke = '#d97706';

  var s = '<svg xmlns="http://www.w3.org/2000/svg" width="'+svgW+'" height="'+svgH+'" viewBox="0 0 '+totalW+' '+totalH+'" style="font-family:\'DM Sans\',system-ui,sans-serif">';

  // Lot boundary ‚Äî white fill, thin navy outline
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+lw+'" height="'+ld+'" fill="'+cLot+'" stroke="'+cBorder+'" stroke-width="1"/>';

  // Front setback zone (bottom = front of lot)
  s += '<rect x="'+ox+'" y="'+(oy+ld-frontSet)+'" width="'+lw+'" height="'+frontSet+'" fill="'+cYard+'" opacity="0.6"/>';
  // Rear setback zone (top = rear of lot)
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+lw+'" height="'+rearSet+'" fill="'+cYard+'" opacity="0.4"/>';
  // Far-side setback strip (right edge)
  s += '<rect x="'+(ox+lw-sideSet)+'" y="'+oy+'" width="'+sideSet+'" height="'+ld+'" fill="'+cYard+'" opacity="0.3"/>';

  // Driveway ‚Äî 20' wide, flush to left property line
  s += '<rect x="'+ox+'" y="'+oy+'" width="'+driveW+'" height="'+ld+'" fill="'+cDrive+'" stroke="'+cDriveBorder+'" stroke-width="0.5"/>';
  // 4' setback zone within driveway (subtle dashed line)
  s += '<line x1="'+(ox+sideSet)+'" y1="'+oy+'" x2="'+(ox+sideSet)+'" y2="'+(oy+ld)+'" stroke="'+cSetback+'" stroke-width="0.4" stroke-dasharray="2,3" opacity="0.35"/>';
  // Driveway label (rotated)
  var driveFS = Math.min(6, driveW * 0.25);
  s += '<text x="'+(ox+driveW/2)+'" y="'+(oy+ld/2)+'" text-anchor="middle" dominant-baseline="central" fill="#999" font-size="'+driveFS+'" transform="rotate(-90,'+(ox+driveW/2)+','+(oy+ld/2)+')">20\u2032 DRIVE</text>';

  // Setback lines ‚Äî coral dashed (front + rear)
  var frontY = oy + ld - frontSet;
  s += '<line x1="'+ox+'" y1="'+frontY+'" x2="'+(ox+lw)+'" y2="'+frontY+'" stroke="'+cSetback+'" stroke-width="0.6" stroke-dasharray="3,2" opacity="0.55"/>';
  var rearY = oy + rearSet;
  s += '<line x1="'+ox+'" y1="'+rearY+'" x2="'+(ox+lw)+'" y2="'+rearY+'" stroke="'+cSetback+'" stroke-width="0.6" stroke-dasharray="3,2" opacity="0.55"/>';
  // Far-side setback line
  s += '<line x1="'+(ox+lw-sideSet)+'" y1="'+oy+'" x2="'+(ox+lw-sideSet)+'" y2="'+(oy+ld)+'" stroke="'+cSetback+'" stroke-width="0.4" stroke-dasharray="2,3" opacity="0.35"/>';

  // Remainder parcel at front (just above front setback)
  if(remDepth > 0){
    var remY = oy + ld - frontSet - remDepth;
    s += '<rect x="'+(ox+driveW)+'" y="'+remY+'" width="'+unitBuildW+'" height="'+remDepth+'" fill="'+cRem+'" stroke="'+cRemStroke+'" stroke-width="0.5" stroke-dasharray="2,2" opacity="0.7"/>';
  }

  // Place units ‚Äî compact colored rectangles, no unit number labels
  var unitStartX = ox + driveW;
  var unitStartY = oy + rearSet;
  for(var i = 0; i < placed; i++){
    var uy = unitStartY + i * parcelDepth;
    var uh = Math.max(parcelDepth - 1, 1);
    s += '<rect x="'+unitStartX+'" y="'+uy+'" width="'+unitBuildW+'" height="'+uh+'" fill="'+cUnit+'" stroke="'+cUnitStroke+'" stroke-width="0.8" rx="1"/>';
  }

  // Open space after last unit
  var lastUnitBottom = unitStartY + placed * parcelDepth;
  var yardH = (oy + ld - frontSet - remDepth) - lastUnitBottom;
  if(yardH > 2){
    s += '<rect x="'+(ox+driveW)+'" y="'+lastUnitBottom+'" width="'+unitBuildW+'" height="'+yardH+'" fill="'+cYard+'" opacity="0.5"/>';
  }

  // Dimension labels
  s += '<text x="'+(ox+lw/2)+'" y="'+(oy-4)+'" text-anchor="middle" fill="'+cLabel+'" font-size="6">'+lw+'\u2032</text>';
  s += '<text x="'+(ox-5)+'" y="'+(oy+ld/2)+'" text-anchor="middle" fill="'+cLabel+'" font-size="6" transform="rotate(-90,'+(ox-5)+','+(oy+ld/2)+')">'+ld+'\u2032</text>';
  // Setback dimension labels
  s += '<text x="'+(ox+lw+2)+'" y="'+(oy+rearSet/2+2)+'" fill="'+cSetback+'" font-size="4" opacity="0.6">4\u2032</text>';
  s += '<text x="'+(ox+lw+2)+'" y="'+(frontY+frontSet/2+2)+'" fill="'+cSetback+'" font-size="4" opacity="0.6">'+frontSet+'\u2032</text>';

  // STREET label
  s += '<text x="'+(ox+lw/2)+'" y="'+(oy+ld+11)+'" text-anchor="middle" fill="'+cLabel+'" font-size="5" letter-spacing="2" font-weight="600">STREET</text>';

  // Scale bar ‚Äî bottom-left, 10ft reference
  var sbX = ox + 1, sbY = oy + ld + 13;
  s += '<line x1="'+sbX+'" y1="'+sbY+'" x2="'+(sbX+10)+'" y2="'+sbY+'" stroke="'+cLabel+'" stroke-width="0.7"/>';
  s += '<line x1="'+sbX+'" y1="'+(sbY-1.5)+'" x2="'+sbX+'" y2="'+(sbY+1.5)+'" stroke="'+cLabel+'" stroke-width="0.5"/>';
  s += '<line x1="'+(sbX+10)+'" y1="'+(sbY-1.5)+'" x2="'+(sbX+10)+'" y2="'+(sbY+1.5)+'" stroke="'+cLabel+'" stroke-width="0.5"/>';
  s += '<text x="'+(sbX+5)+'" y="'+(sbY-2)+'" text-anchor="middle" fill="'+cLabel+'" font-size="3.5">10\u2032</text>';

  // North arrow ‚Äî bottom-right
  var naX = ox + lw + padR - 4, naY = oy + ld + 10;
  s += '<line x1="'+naX+'" y1="'+(naY+5)+'" x2="'+naX+'" y2="'+naY+'" stroke="'+cLabel+'" stroke-width="0.7"/>';
  s += '<polygon points="'+(naX-1.5)+','+(naY+2)+' '+naX+','+naY+' '+(naX+1.5)+','+(naY+2)+'" fill="'+cLabel+'"/>';
  s += '<text x="'+naX+'" y="'+(naY-1.5)+'" text-anchor="middle" fill="'+cLabel+'" font-size="3.5" font-weight="700">N</text>';

  s += '</svg>';
  return s;
}

function lotPlannerUrl(l){
  var exitSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var p = 'width='+l.lw+'&depth='+l.ld+'&zone='+(l.zone||'R1')+'&street=S';
  p += '&address='+encodeURIComponent(l.address||'');
  p += '&asking='+(l.price||0);
  p += '&lotSF='+(l.lotSf||0);
  if(exitSF) p += '&exitSF='+exitSF;
  return 'https://mlucido.github.io/lot-planner/?'+p;
}

// Lot size display with source + mismatch warning
function lotLabel(l, effPct){
  if(!l.lotSf) return '';
  const src = l.lotSource === 'parcel' ? 'Parcel' : 'MLS';
  const srcColor = l.lotSfParcel ? 'var(--orange)' : 'var(--text-dim)';
  const mismatch = l.lotSfParcel ? ` <small style="color:var(--orange)">&#9888; Parcel: ${l.lotSfParcel.toLocaleString()}</small>` : '';
  const irregWarn = l.lotShape === 'irreg' ? ' <small style="color:var(--orange)">&#9888; irregular</small>' : '';
  const dims = l.lw && l.ld ? ` <small style="color:var(--text-dim)">${l.lw}'\u00d7${l.ld}'</small>${irregWarn}` : '';
  const eff = effPct != null ? ` <small style="color:${effPct>=85?'var(--green)':effPct>=60?'var(--yellow)':'var(--red)'}">(${effPct}% eff)</small>` : '';
  return `<div><div class="popup-label">Lot Size</div><div class="popup-value">${l.lotSf.toLocaleString()} sf <small style="color:${srcColor}">(${src})</small>${dims}${mismatch}${eff}</div></div>`;
}

// Remainder parcel analysis section for R2-R4
function remainderAnalysis(l){
  if(!l.remainderUnits || l.remainderUnits <= 0) return '';
  const viable = l.remainderViable;
  const color = viable && l.remainderUnits >= 8 ? '#22c55e' : viable && l.remainderUnits >= 4 ? '#eab308' : '#ef4444';
  const icon = viable ? '&#9989;' : '&#10060;';
  return `<div class="popup-span-2" style="font-size:10px;line-height:1.6;padding:4px 8px;border-radius:4px;background:${color}15;color:${color}">
    <b>REMAINDER PARCEL ANALYSIS</b><br>
    Total Lot: ${l.lotSf?l.lotSf.toLocaleString():'?'} SF |
    Footprint: -${(l.estFootprint||0).toLocaleString()} SF |
    Driveway: -${(l.drivewayDeduction||2000).toLocaleString()} SF<br>
    <b>Available: ${l.remainderSf.toLocaleString()} SF &#8594; ${l.remainderUnits} units ${icon}</b>
    ${viable ? ' (keep existing structure, develop remainder)' : ' (insufficient for viable development)'}
  </div>`;
}

// BTR (Build-to-Rent) Pro Forma Calculator
function getRentSourceLabel(l) {
  const m = l.rentMethod;
  if (m === 'rental-comp') return `${l.rentCompCount} rental comps within ${l.rentCompRadius} mi`;
  if (m === 'rental-comp-wide') return `${l.rentCompCount} comps within ${l.rentCompRadius} mi <small>(wide)</small>`;
  if (m === 'rental-adj') return `${l.rentCompCount} comps within ${l.rentCompRadius} mi <small>(2BR adj +20%)</small>`;
  if (m === 'zori') return `ZORI <small>ZIP ${l.zip||'\u2014'}</small>`;
  return `SAFMR <small>ZIP ${l.zip||'\u2014'}</small>`;
}

function calculateBTRProForma(l){
  // Inherit all BTS (build-to-sell) numbers for shared inputs
  const pf = calculateProForma(l);

  // BTR-specific assumptions (configurable via modal)
  const newConPremium = parseFloat((document.getElementById('btrPremium')||{}).value) || 1.25;
  const vacancyRate = parseFloat((document.getElementById('btrVacancy')||{}).value) || 0.04;
  const opexRatio = parseFloat((document.getElementById('btrOpex')||{}).value) || 0.30;
  const capRate = parseFloat((document.getElementById('btrCapRate')||{}).value) || 0.055;
  const refiLTV = parseFloat((document.getElementById('btrLTV')||{}).value) || 0.70;
  const refiRate = parseFloat((document.getElementById('btrRate')||{}).value) || 0.0625;
  const minYOC = parseFloat((document.getElementById('btrMinYOC')||{}).value) || 0.04;

  const hasEstRent = l.estRentMonth && l.estRentMonth > 0;
  const baseRent = hasEstRent ? l.estRentMonth : (l.fmr3br || 0);
  const rentRefSf = 1200; // SAFMR/ZORI benchmarks to a typical ~1,200 SF 3BR
  const sizeAdj = proforma.avgUnitSf / rentRefSf; // scale rent proportionally to actual unit size
  const rentPerUnit = Math.round((hasEstRent ? l.estRentMonth : Math.round(baseRent * newConPremium)) * sizeAdj);
  const units = pf.maxUnits;
  const totalCost = pf.totalCost;

  // Income
  const grossAnnualRent = rentPerUnit * 12 * units;
  const effectiveGrossIncome = grossAnnualRent * (1 - vacancyRate);
  const annualNOI = effectiveGrossIncome * (1 - opexRatio);

  // Returns
  const yieldOnCost = totalCost > 0 ? annualNOI / totalCost : 0;
  const stabilizedValue = capRate > 0 ? annualNOI / capRate : 0;

  // Refi
  const loanAmount = stabilizedValue * refiLTV;
  const annualDebtService = loanAmount * refiRate;
  const dscr = annualDebtService > 0 ? annualNOI / annualDebtService : 0;
  const cashOutRefi = loanAmount - totalCost;
  const equityAfterRefi = totalCost - loanAmount;
  const cashFlow = annualNOI - annualDebtService;
  const cashOnCash = equityAfterRefi > 0 ? cashFlow / equityAfterRefi : 0;

  // GRM: gross sale value / gross annual rent (how many years of rent = sale price)
  const grm = grossAnnualRent > 0 ? pf.grossRevenue / grossAnnualRent : 0;

  // Does it pencil? (DSCR shown as informational, not a gate ‚Äî it's a constant of cap/LTV/rate)
  const btrPencils = yieldOnCost >= minYOC && baseRent > 0;

  return {
    ...pf,  // inherit all BTS fields
    rentPerUnit,
    baseRent,
    hasEstRent,
    newConPremium,
    sizeAdj,
    grm,
    grossAnnualRent,
    effectiveGrossIncome,
    annualNOI,
    yieldOnCost,
    stabilizedValue,
    loanAmount,
    annualDebtService,
    dscr,
    cashOutRefi,
    cashFlow,
    cashOnCash,
    btrPencils,
    minYOC,
    vacancyRate,
    opexRatio,
    capRate,
    refiLTV,
    units,
  };
}

// Generate ZIMAS lookup URL for LA City properties
function getZimasUrl(l){
  if(l.ain) return 'https://zimas.lacity.org/displayreport.aspx?apn=' + l.ain;
  return 'https://zimas.lacity.org/';
}

// Slope score badge for due diligence sections
function slopeBadge(l){
  if(l.slopeScore == null || l.slopeScore <= 30) return '';
  const detail = 'Elev range: '+l.elevRange+'ft | Max slope: '+l.maxSlope+'% | Flat area: '+l.flatPct+'%';
  if(l.slopeScore >= 76) return ' ‚Ä¢ <span style="color:var(--red)">&#10007; SEVERE SLOPE (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
  if(l.slopeScore >= 51) return ' ‚Ä¢ <span style="color:var(--orange)">&#10007; STEEP TERRAIN (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
  return ' ‚Ä¢ <span style="color:var(--yellow)">&#9888; Moderate slope (score '+l.slopeScore+')</span><br><span style="color:var(--text-dim);font-size:9px">'+detail+'</span>';
}

// Enrich listings with computed fields
function enrichListings(){
  LISTINGS.forEach(l => {
    l.sb1123Eligible = isSB1123Eligible(l);
    const pf = calculateProForma(l);
    l.maxUnits = pf.maxUnits;
    if (pf.densityUnits > pf.maxUnits) {
      l.densityUnits = pf.densityUnits;
      l.layoutMax = pf.layoutMax;
      l.layoutNote = pf.layoutNote;
    }
    // Slope-adjusted unit warning (informational only ‚Äî does not override pro forma)
    if (l.flatPct != null && l.flatPct < 100 && l.lotSf) {
      const usableFlatSf = Math.max(0, l.lotSf * (l.flatPct / 100) - 2000);
      const slopeAdjUnits = Math.min(l.maxUnits, Math.max(1, Math.floor(usableFlatSf / 1400)));
      if (slopeAdjUnits < l.maxUnits) l.slopeAdjUnits = slopeAdjUnits;
    }
    l.pricePerUnit = pf.pricePerUnit;
    l.estProfit = pf.profit;
    l.estMargin = pf.margin;
    l.totalCost = pf.totalCost;
    l.netRevenue = pf.netRevenue;
    l.totalBuildCost = pf.totalBuildCost;
    l.salePerUnit = pf.maxUnits > 0 ? Math.round(pf.netRevenue / pf.maxUnits) : 0;
    l.buildPerUnit = pf.maxUnits > 0 ? Math.round(pf.totalBuildCost / pf.maxUnits) : 0;
    l.buildableSf = pf.buildableSf;
    l.maxOffer = pf.max_offer;
    l.landPpsf = l.lotSf ? Math.round(l.price / l.lotSf) : null;
    l.lotEfficiency = pf.lot_efficiency ? Math.round(pf.lot_efficiency * 100) : 0; // Store as percentage
    // NEW listing detection: DOM <= 3 = NEW, DOM <= 7 = new this week
    l.isNew = (l.dom !== null && l.dom !== undefined && l.dom <= 3) ? 1 : 0;
    l.isNewThisWeek = (l.dom !== null && l.dom !== undefined && l.dom <= 7) ? 1 : 0;
    // BTR viability flag for dual-deal detection
    if(l.yocBase > 0){
      l.btrViable = l.yocBase >= 0.04;
    } else if((l.estRentMonth && l.estRentMonth > 0) || (l.fmr3br && l.fmr3br > 0)){
      const btrPF = calculateBTRProForma(l);
      l.btrViable = btrPF.btrPencils;
    } else {
      l.btrViable = false;
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getFilteredComps(){
  return COMPS.filter(c =>
    zoneState[c.zone] &&
    c.price >= filters.price.min && c.price <= filters.price.max &&
    (c.ppsf || c.price/c.sqft) >= filters.psf.min &&
    (c.ppsf || c.price/c.sqft) <= filters.psf.max &&
    c.sqft >= filters.sqft.min && c.sqft <= filters.sqft.max
  );
}

function isInsideDrawPolygon(lat, lng){
  if(!drawPolygonGeoJSON) return true; // No polygon = everything passes
  return turf.booleanPointInPolygon(turf.point([lng, lat]), drawPolygonGeoJSON);
}

function getFilteredListings(){
  const favs = favoritesOnly ? loadFavorites() : null;
  return LISTINGS.filter(l => {
    if(drawPolygonGeoJSON && !isInsideDrawPolygon(l.lat, l.lng)) return false;
    if(favoritesOnly && !favs[listingKey(l)]) return false;
    if(sb1123Mode && !l.sb1123Eligible) return false;
    if(newThisWeekFilter && !l.isNewThisWeek) return false;
    if(hideBurnZones && l.burnZone) return false;
    if(hideTenantRisk && l.tenantRisk >= 3) return false;
    if(hideHighSlope && l.slopeScore != null && l.slopeScore >= 60) return false;
    if(minUnitsFilter > 1 && (l.maxUnits || 0) < minUnitsFilter) return false;
    if(hideUnviable && (l.maxOffer || 0) <= 0) {
      if(layerState.btr && l.btrViable) { /* keep ‚Äî BTR economics work */ }
      else return false;
    }
    const zoneOk = !l.zone || zoneState[l.zone];
    const priceOk = l.price >= filters.price.min && l.price <= filters.price.max;
    const isLand = l.zone === 'LAND';
    const psfOk = isLand || (l.ppsf >= filters.psf.min && l.ppsf <= filters.psf.max);
    const sqftOk = isLand || (l.sqft >= filters.sqft.min && l.sqft <= filters.sqft.max);
    const lotVal = l.lotSf || 0;
    const lotAtDefault = filters.lot.min === filters.lot.dataMin && filters.lot.max === filters.lot.dataMax;
    const lotOk = lotAtDefault ? true : (lotVal >= filters.lot.min && lotVal <= filters.lot.max);
    const lotwVal = l.lw || 0;
    const lotwAtDefault = filters.lotw.min === filters.lotw.dataMin && filters.lotw.max === filters.lotw.dataMax;
    const lotwOk = lotwAtDefault ? true : (lotwVal === 0 ? true : (lotwVal >= filters.lotw.min && lotwVal <= filters.lotw.max));
    const slopeVal = l.slope != null ? l.slope : 0;
    const slopeAtDefault = filters.slope.min === filters.slope.dataMin && filters.slope.max === filters.slope.dataMax;
    const slopeOk = slopeAtDefault ? true : (slopeVal >= filters.slope.min && slopeVal <= filters.slope.max);
    const marginVal = l.estMargin || 0;
    const marginAtDefault = filters.margin.min === filters.margin.dataMin && filters.margin.max === filters.margin.dataMax;
    const marginOk = marginAtDefault ? true : (marginVal >= filters.margin.min && marginVal <= filters.margin.max);
    return zoneOk && priceOk && psfOk && sqftOk && lotOk && lotwOk && slopeOk && marginOk;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function rebuildMarkers(){
  Object.values(markerLayers).forEach(l=>l.clearLayers());
  const filtered = getFilteredComps();
  filtered.forEach(comp => {
    const psf = comp.ppsf || Math.round(comp.price / comp.sqft);
    const cm = L.circleMarker([comp.lat,comp.lng],{
      radius:3, color:ZONE_COLORS[comp.zone], fillColor:ZONE_COLORS[comp.zone],
      fillOpacity:0.5, weight:1
    });
    cm.bindPopup(`
      <div class="popup-badge comp">Market Comp</div>
      <div class="popup-title">${comp.address || 'N/A'}</div>
      <div class="popup-grid">
        <div><div class="popup-label">Market Value</div><div class="popup-value">$${comp.price.toLocaleString()}</div></div>
        <div><div class="popup-label">$/SF</div><div class="popup-value" style="color:${ZONE_COLORS[comp.zone]}">$${psf}</div></div>
        <div><div class="popup-label">Size</div><div class="popup-value">${comp.sqft.toLocaleString()} sf</div></div>
        <div><div class="popup-label">Zone</div><div class="popup-value">${comp.zone}</div></div>
        ${comp.zip?`<div><div class="popup-label">Zip</div><div class="popup-value">${comp.zip}</div></div>`:''}
      </div>
      <div style="margin-top:6px;display:flex;gap:8px;justify-content:center">
        <a href="https://www.google.com/maps?q=${comp.lat},${comp.lng}&t=k&z=19" target="_blank" style="color:var(--accent);font-size:11px">Google Maps &#8599;</a>
      </div>
    `,{maxWidth:280});
    cm.addTo(markerLayers[comp.zone]);
  });
  document.getElementById('compCount').textContent = filtered.length.toLocaleString();
  refreshVisibility();
}

function generateDealCard(l, opts){
  opts = opts || {};
  var ctx = opts.context || 'bts';
  var pf = calculateProForma(l);
  var btr = calculateBTRProForma(l);
  var el = exitLabel(l);
  var cc = compConfidence(l);
  var margin = pf.margin;
  var marginColor = margin>=30?'#22c55e':margin>=20?'#facc15':'#9ca3af';
  var isDualViable = margin >= 20 && l.btrViable;

  // Format helpers
  function $(n){ return n>=1000000?'$'+(n/1000000).toFixed(2).replace(/0+$/,'').replace(/\.$/,'')+'M':n>=1000?'$'+Math.round(n/1000)+'k':'$'+Math.round(n); }
  function commas(n){ return n!=null?Math.round(n).toLocaleString():'‚Äî'; }

  // FAR
  var far = 0;
  if(l.lotSf && pf.maxUnits){
    if(pf.maxUnits>=8) far=1.25; else if(pf.maxUnits>=3) far=1.0; else far=0.5;
  }
  var effPct = pf.lot_efficiency ? Math.round(pf.lot_efficiency*100) : 0;
  var allInPsf = pf.effective_buildable_sf>0 ? Math.round(pf.totalCost/pf.effective_buildable_sf) : 0;
  var spread = el.psf - allInPsf;

  // ‚îÄ‚îÄ Badges ‚îÄ‚îÄ
  var badges = '';
  if(l.burnZone) badges += '<div class="popup-badge" style="background:#dc2626;color:#fff;font-weight:700;padding:2px 8px">&#128293; BURN ZONE ‚Äî '+l.burnZone+' Fire</div>';
  badges += '<div class="popup-badge" style="background:'+(ZONE_COLORS[l.zone]||'#666')+'22;color:'+(ZONE_COLORS[l.zone]||'#666')+'">'+(l.zone||'?')+' ‚Äî '+(ZONE_LABELS[l.zone]||l.zone||'Unknown')+'</div>';
  if(ctx==='btr'){
    badges += (l.estMargin||0)<=0
      ? '<div class="popup-badge" style="background:rgba(245,158,11,0.2);color:#f59e0b;font-weight:700">&#9670; BTR-ONLY OPPORTUNITY</div>'
      : '<div class="popup-badge" style="background:rgba(234,179,8,0.15);color:#eab308">&#9670; BTR PREFERRED</div>';
  } else if(isDualViable){
    badges += '<div class="popup-badge" style="background:rgba(245,158,11,0.2);color:#f59e0b;font-weight:700">&#9670; BTS + BTR</div>';
  }
  if(l.isNew) badges += '<div class="popup-badge" style="background:rgba(34,197,94,0.2);color:#22c55e">NEW LISTING</div>';
  else if(l.isNewThisWeek) badges += '<div class="popup-badge" style="background:rgba(14,165,233,0.2);color:#0ea5e9">NEW THIS WEEK</div>';
  if(l.hasStructure) badges += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">DEMO REQUIRED</div>';
  if(l.urbanArea===false) badges += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NOT URBAN AREA</div>';
  if(l.compMethod&&l.compMethod.includes('thin')) badges += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">THIN COMPS</div>';
  else if(!l.exitPsf&&!l.newconPpsf&&!l.clusterT1psf&&!l.subdivExitPsf) badges += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NO COMP DATA</div>';
  if(l.zone!=='R1'&&l.zone!=='LAND'){
    if(l.tenantRisk>=3) badges += '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">HIGH TENANT RISK</div>';
    else if(l.tenantRisk>=2) badges += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">TENANT RISK</div>';
    if(l.rsoRisk) badges += '<div class="popup-badge" style="background:rgba(220,38,38,0.15);color:#dc2626">RSO ‚Äî ELLIS ACT</div>';
  }
  if(l.remainderViable) badges += '<div class="popup-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">REMAINDER: '+commas(l.remainderSf)+' SF &#8594; '+l.remainderUnits+' units</div>';
  else if(l.remainderUnits>0) badges += '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">REMAINDER: '+commas(l.remainderSf)+' SF ('+l.remainderUnits+')</div>';

  // ‚îÄ‚îÄ Strip ‚îÄ‚îÄ
  var strip = '<div class="dp-strip" onclick="this.closest(\'.dp-card\').classList.toggle(\'expanded\');var p=this.closest(\'.leaflet-popup\');if(p){var c=p.querySelector(\'.leaflet-popup-content\');if(c)setTimeout(function(){p._leaflet_id&&map.eachLayer(function(ly){if(ly._popup&&ly._popup._container===p)ly._popup.update()})},50)}">';
  strip += '<div class="dp-addr">'+(l.address||'N/A')+'<small>'+(l.zone||'')+(l.dom!=null?' &bull; '+l.dom+'d':'')+'</small></div>';
  strip += '<div class="dp-metric"><div class="dp-val" style="color:'+marginColor+'">'+$(l.price)+'</div><div class="dp-lbl">List</div></div>';
  strip += '<div class="dp-metric"><div class="dp-val" style="color:'+el.color+'">$'+el.psf+'</div><div class="dp-lbl">'+el.short+'</div></div>';
  strip += '<div class="dp-metric"><div class="dp-val">'+(l.lotSf?commas(l.lotSf):'‚Äî')+'</div><div class="dp-lbl">Lot SF</div></div>';
  strip += '<div class="dp-metric"><div class="dp-val">'+pf.maxUnits+'</div><div class="dp-lbl">Units</div></div>';
  strip += '<div class="dp-toggle">&#9660;</div>';
  strip += '</div>';

  // ‚îÄ‚îÄ Drawer body: 3 columns ‚îÄ‚îÄ
  // Column 1: Economics
  var col1 = '<div class="dp-col"><div class="dp-col-head">Economics</div>';
  col1 += '<div class="dp-row"><span class="dp-k">Build $/SF</span><span class="dp-v"'+(pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':'')+'>$'+pf.adjBuildCostPerSf+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Construction</span><span class="dp-v">'+$(pf.constructionCost)+'</span></div>';
  var carryTotal = pf.carryInterest+pf.carryPropTax+pf.insurance+pf.originationFee+(pf.demo>0?pf.demo:0);
  col1 += '<div class="dp-row"><span class="dp-k">Soft/Carry</span><span class="dp-v">'+$(carryTotal)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Total Cost</span><span class="dp-v" style="font-weight:700">'+$(pf.totalCost)+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">All-In $/SF</span><span class="dp-v">$'+allInPsf+'</span></div>';
  col1 += '<div class="dp-row"><span class="dp-k">Spread</span><span class="dp-v" style="color:'+(spread>=100?'var(--green)':spread>=0?'var(--yellow)':'var(--red)')+'">$'+spread+'/sf</span></div>';
  col1 += '</div>';

  // Column 2: Site
  var col2 = '<div class="dp-col"><div class="dp-col-head">Site</div>';
  var lotSrc = l.lotSource==='parcel'?'Parcel':'MLS';
  var lotMismatch = l.lotSfParcel ? ' <small style="color:var(--orange)">&#9888;'+commas(l.lotSfParcel)+'</small>' : '';
  col2 += '<div class="dp-row"><span class="dp-k">Lot Size</span><span class="dp-v">'+(l.lotSf?commas(l.lotSf)+' <small style="color:var(--text-dim)">('+lotSrc+')</small>'+lotMismatch:'‚Äî')+'</span></div>';
  col2 += '<div class="dp-row"><span class="dp-k">Zone</span><span class="dp-v">'+(l.zone||'‚Äî')+(l.zimasZone?' <small style="color:var(--text-dim)">'+l.zimasZone+'</small>':'')+'</span></div>';
  if(l.lw&&l.ld) col2 += '<div class="dp-row"><span class="dp-k">Dims</span><span class="dp-v">'+l.lw+'\'&times;'+l.ld+'\''+(l.lotShape==='irreg'?' <small style="color:var(--orange)">irreg</small>':'')+'</span></div>';
  if(l.slope!=null) col2 += '<div class="dp-row"><span class="dp-k">Slope</span><span class="dp-v" style="color:'+(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)')+'">'+l.slope+'%</span></div>';
  if(l.dom!=null) col2 += '<div class="dp-row"><span class="dp-k">DOM</span><span class="dp-v" style="color:'+(l.dom>=60?'var(--green)':l.dom>=30?'var(--yellow)':'var(--text)')+'">'+l.dom+'</span></div>';
  if(l.beds) col2 += '<div class="dp-row"><span class="dp-k">Beds/Baths</span><span class="dp-v">'+l.beds+'/'+l.baths+'</span></div>';
  // Lot layout toggle
  if(l.lw&&l.ld&&pf.maxUnits>0&&pf.max_offer>0){
    var lotId = 'dp-lot-'+Math.random().toString(36).slice(2,8);
    col2 += '<div class="dp-lot-toggle" onclick="var b=document.getElementById(\''+lotId+'\');b.classList.toggle(\'open\');this.classList.toggle(\'open\');event.stopPropagation()"><span class="tri">&#9654;</span> Layout &middot; '+pf.maxUnits+'u</div>';
    col2 += '<div class="dp-lot-body" id="'+lotId+'">'+buildLotLayoutSVG(l,pf)+'</div>';
  }
  col2 += '</div>';

  // Column 3: Pro Forma
  var moColor = pf.max_offer>=l.price?'var(--green)':'var(--red)';
  var lbColor = pf.land_basis_psf<120?'var(--green)':pf.land_basis_psf<=160?'var(--yellow)':'var(--red)';
  var col3 = '<div class="dp-col"><div class="dp-col-head">Pro Forma &mdash; '+pf.maxUnits+'u';
  if(l.layoutNote) col3 += ' <small style="color:var(--orange)">(from '+l.densityUnits+')</small>';
  else if(l.slopeAdjUnits) col3 += ' <small style="color:var(--orange)">(slope~'+l.slopeAdjUnits+')</small>';
  col3 += '</div>';
  col3 += '<div class="dp-row"><span class="dp-k">Max Offer@30%</span><span class="dp-v" style="color:'+moColor+'">'+$(pf.max_offer)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Net Revenue</span><span class="dp-v">'+$(pf.netRevenue)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Profit</span><span class="dp-v" style="color:'+(pf.profit>=0?'var(--green)':'var(--red)')+'">'+$(pf.profit)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Margin</span><span class="dp-v" style="color:'+(margin>=30?'var(--green)':margin>=15?'var(--yellow)':'var(--red)')+'">'+margin.toFixed(1)+'%</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">ROC</span><span class="dp-v" style="color:'+(pf.return_on_cost>=0?'var(--green)':'var(--red)')+'">'+pf.return_on_cost.toFixed(1)+'%</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Buy/Unit</span><span class="dp-v">'+$(pf.pricePerUnit)+'</span></div>';
  col3 += '<div class="dp-row"><span class="dp-k">Land Basis</span><span class="dp-v" style="color:'+lbColor+'">$'+pf.land_basis_psf+'/sf</span></div>';
  // Comp confidence link
  col3 += '<div style="margin-top:3px;font-size:10px"><span style="color:'+cc.color+';letter-spacing:2px">'+cc.icon+'</span> <a href="#" onclick="showCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">'+cc.count+' comps'+(cc.radius?' within '+cc.radius+'mi':'')+' &#8599;</a></div>';
  col3 += '</div>';

  // Remainder analysis (spans full width below columns)
  var remainder = '';
  if(l.remainderViable || l.remainderUnits > 0){
    var rColor = l.remainderViable && l.remainderUnits>=8 ? '#22c55e' : l.remainderViable && l.remainderUnits>=4 ? '#eab308' : '#ef4444';
    var rIcon = l.remainderViable ? '&#9989;' : '&#10060;';
    remainder = '<div style="font-size:10px;line-height:1.5;padding:4px 8px;border-radius:4px;background:'+rColor+'15;color:'+rColor+';margin-top:4px">'
      +'<b>REMAINDER</b> &bull; Total: '+commas(l.lotSf)+' SF | Footprint: -'+commas(l.estFootprint||0)+' | Driveway: -'+commas(l.drivewayDeduction||2000)
      +' &rarr; <b>'+commas(l.remainderSf)+' SF = '+l.remainderUnits+' units '+rIcon+'</b></div>';
  }

  // ‚îÄ‚îÄ BTR strip ‚îÄ‚îÄ
  var btrStrip = '';
  if(btr.baseRent>0){
    btrStrip = '<div class="dp-btr">';
    btrStrip += '<div><div class="dp-lbl">Rent/Unit</div><div class="dp-val">$'+btr.rentPerUnit.toLocaleString()+'/mo</div></div>';
    btrStrip += '<div><div class="dp-lbl">YOC</div><div class="dp-val" style="color:'+(btr.yieldOnCost>=btr.minYOC?'var(--green)':btr.yieldOnCost>=btr.minYOC*0.8?'var(--yellow)':'var(--red)')+'">'+(btr.yieldOnCost*100).toFixed(1)+'%</div></div>';
    btrStrip += '<div><div class="dp-lbl">Stab Value</div><div class="dp-val" style="color:'+(btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)')+'">'+$(btr.stabilizedValue)+'</div></div>';
    btrStrip += '<div><div class="dp-lbl">DSCR</div><div class="dp-val" style="color:'+(btr.dscr>=1.25?'var(--green)':btr.dscr>=1.15?'var(--yellow)':'var(--red)')+'">'+btr.dscr.toFixed(2)+'x</div></div>';
    btrStrip += '</div>';

    // BTR scenarios table (from pipeline data)
    if(l.rentBase>0 && l.yocBase>0){
      var conf = l.confidence || 'default';
      var pf_str = l.premiumFactor ? l.premiumFactor.toFixed(2)+'x' : '';
      btrStrip += '<div class="dp-btr-scenarios">';
      btrStrip += '<table><tr style="color:var(--text-dim);font-size:10px"><td></td><td style="text-align:right">$/mo</td><td style="text-align:right">YoC</td></tr>';
      btrStrip += '<tr><td style="color:var(--text-dim)">Conservative</td><td style="text-align:right">$'+l.rentConservative.toLocaleString()+'</td>';
      btrStrip += '<td style="text-align:right;color:'+(l.yocConservative>=0.04?'var(--green)':l.yocConservative>=0.03?'var(--yellow)':'var(--red)')+'">'+(l.yocConservative*100).toFixed(1)+'%</td></tr>';
      btrStrip += '<tr style="font-weight:600"><td>Base '+btrConfidenceDot(conf)+'</td><td style="text-align:right">$'+l.rentBase.toLocaleString()+'</td>';
      btrStrip += '<td style="text-align:right;color:'+(l.yocBase>=0.04?'var(--green)':l.yocBase>=0.03?'var(--yellow)':'var(--red)')+'">'+(l.yocBase*100).toFixed(1)+'%</td></tr>';
      btrStrip += '<tr><td style="color:var(--text-dim)">Aggressive</td><td style="text-align:right">$'+l.rentAggressive.toLocaleString()+'</td>';
      btrStrip += '<td style="text-align:right;color:'+(l.yocAggressive>=0.04?'var(--green)':l.yocAggressive>=0.03?'var(--yellow)':'var(--red)')+'">'+(l.yocAggressive*100).toFixed(1)+'%</td></tr>';
      btrStrip += '</table>';
      btrStrip += '<div style="font-size:10px;color:var(--text-dim);margin-top:2px;display:flex;gap:8px;flex-wrap:wrap">';
      if(l.safmr3br) btrStrip += '<span>SAFMR: $'+l.safmr3br.toLocaleString()+'</span>';
      if(l.zoriBase) btrStrip += '<span>ZORI: $'+l.zoriBase.toLocaleString()+'</span>';
      if(pf_str) btrStrip += '<span>Premium: '+pf_str+'</span>';
      btrStrip += '<span>'+btrConfidenceDot(conf)+' '+conf+'</span>';
      btrStrip += '</div>';
      btrStrip += '</div>';
    }

    // Rent source + rental comps link
    btrStrip += '<div style="padding:2px 10px;font-size:10px;color:var(--text-dim)">'+getRentSourceLabel(l);
    if(typeof RENTAL_COMPS!=='undefined'&&RENTAL_COMPS.length>0&&l.rentMethod&&l.rentMethod.startsWith('rental-comp')){
      btrStrip += ' &bull; <a href="#" onclick="showRentalCompsTable('+l.lat+','+l.lng+');return false" style="color:var(--accent);cursor:pointer">view comps &#8599;</a>';
    }
    btrStrip += '</div>';
  }

  // ‚îÄ‚îÄ Due Diligence (condensed one-liner) ‚îÄ‚îÄ
  var ddItems = [];
  if(l.burnZone) ddItems.push('<span style="color:var(--red)">&#10007;</span> Burn zone');
  else if(l.fireZone) ddItems.push('<span style="color:var(--red)">&#10007;</span> VHFHSZ');
  if(l.rsoRisk) ddItems.push('<span style="color:var(--red)">&#10007;</span> RSO');
  var sb = slopeBadge(l);
  if(sb&&sb.includes('&#10007;')) ddItems.push(sb.replace(/^ ‚Ä¢ /,'').replace(/<br>.*/,''));
  if(ddItems.length===0) ddItems.push('<span style="color:var(--green)">&#10003;</span> All clear');
  ddItems.push('<span style="color:var(--yellow)">&#9733;</span> TPA=0 parking');
  var ddLine = '<div class="dp-dd">'+ddItems.join(' &bull; ')+'</div>';

  // ‚îÄ‚îÄ Links ‚îÄ‚îÄ
  var links = '<div class="dp-links">';
  links += '<a href="https://www.google.com/maps?q='+l.lat+','+l.lng+'&t=k&z=19" target="_blank">Maps &#8599;</a>';
  if(l.url) links += '<a href="'+l.url+'" target="_blank">Redfin &#8599;</a>';
  links += '<a href="'+getZimasUrl(l)+'" target="_blank" style="color:var(--yellow)">ZIMAS &#8599;</a>';
  if(l.lw&&l.ld) links += '<a href="'+lotPlannerUrl(l)+'" target="_blank">Planner &#8599;</a>';
  links += '</div>';

  // ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ
  var actions = '<div class="dp-actions">';
  actions += '<button onclick="exportModel('+l.lat+','+l.lng+').catch(console.error)">&#128202; XLS</button>';
  actions += '<button onclick="exportOM('+l.lat+','+l.lng+').catch(console.error)">&#128196; OM</button>';
  actions += '<button class="'+(isFavorite(l)?'active':'')+'" onclick="toggleFavorite('+l.lat+','+l.lng+');this.classList.toggle(\'active\')">&#9733; '+(isFavorite(l)?'Saved':'Save')+'</button>';
  actions += '<button onclick="sharePin('+l.lat+','+l.lng+',event)">&#128279; Share</button>';
  actions += '</div>';

  // ‚îÄ‚îÄ Assemble ‚îÄ‚îÄ
  var autoExpand = ctx==='btr' ? ' expanded' : '';
  var h = '<div class="dp-card'+autoExpand+'">';
  h += '<div class="dp-badges">'+badges+'</div>';
  h += strip;
  h += '<div class="dp-drawer"><div class="dp-drawer-inner">';
  h += '<div class="dp-body">'+col1+col2+col3+'</div>';
  h += remainder;
  h += '</div>';
  h += btrStrip;
  h += ddLine;
  h += links;
  h += actions;
  h += '</div>';  // end dp-drawer
  h += '</div>';  // end dp-card
  return h;
}

function rebuildListings(){
  listingsLayer.clearLayers();
  // Clear for-sale flags so off-market layer can exclude visible for-sale listings
  LISTINGS.forEach(l => { l._onForSaleLayer = false; });
  const filtered = getFilteredListings();

  filtered.forEach(l => {
    l._onForSaleLayer = true;
    // Color by margin
    const margin = l.estMargin || 0;
    let color;
    if(margin >= 30) color = '#22c55e';       // Green - 30%+ margin
    else if(margin >= 20) color = '#facc15';  // Yellow - 20-29% margin
    else color = '#9ca3af';                   // Gray - under 20% margin
    
    const lotSf = l.lotSf || 0;
    const isNewListing = l.isNew;
    const baseRadius = lotSf >= 15000 ? 11 : lotSf >= 10000 ? 9 : 8;
    const radius = isNewListing ? baseRadius + 3 : baseRadius;
    const markerColor = isNewListing ? '#22c55e' : '#ffffff'; // White border for heatmap contrast
    const markerWeight = isNewListing ? 4 : 2;
    const isDualViable = margin >= 20 && l.btrViable;
    const cm = L.circleMarker([l.lat,l.lng],{
      radius, color: isDualViable ? '#f59e0b' : markerColor, fillColor:color,
      fillOpacity: 0.95,
      weight: isDualViable ? 3 : markerWeight,
      pane:'listingsPane',
      className: isNewListing ? 'listing-marker-new' : '',
    });

    cm.bindPopup(generateDealCard(l),{maxWidth:520,className:'deal-popup'});
    cm.addTo(listingsLayer);
  });

  document.getElementById('listingCount').textContent = filtered.length.toLocaleString();
  rebuildTable(filtered);
}

function buildBTRLayer(){
  btrLayer.clearLayers();

  // BTR layer shows deals where:
  // 1. BTS net margin < 20% (for-sale doesn't pencil well)
  // 2. Base-case YoC >= 4% (from pipeline pre-computation)
  // 3. Has rent data
  // Deals that pencil for BOTH BTS (>=20%) and BTR get a badge on the BTS pin instead
  const minYOC = parseFloat((document.getElementById('btrMinYOC')||{}).value) || 0.04;
  const btrListings = getFilteredListings().filter(l => {
    if(!l.sb1123Eligible) return false;
    // Use pre-computed yocBase from pipeline if available, else fall back to dynamic calc
    if(l.yocBase > 0){
      const btsMargin = l.estMargin || 0;
      return btsMargin < 20 && l.yocBase >= minYOC;
    }
    if(!(l.estRentMonth > 0 || l.fmr3br > 0)) return false;
    const btrPF = calculateBTRProForma(l);
    const btsMargin = l.estMargin || 0;
    return btsMargin < 20 && btrPF.btrPencils;
  });

  btrListings.forEach(l => {
    const btrIcon = L.divIcon({
      className: '',
      html: '<div class="btr-pin"></div>',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });

    const marker = L.marker([l.lat, l.lng], { icon: btrIcon });
    marker.bindPopup(generateDealCard(l, {context:'btr'}), {maxWidth:520, className:'deal-popup'});
    marker.addTo(btrLayer);
  });

}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRIORITY 2: SPREAD HEATMAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildSpreadHeatmap(){
  if(!LISTINGS.length || typeof L.heatLayer !== 'function') return;

  const BUILD_COST_PSF = proforma.allInBuildPsf || 360;

  // Calculate spread for each eligible listing
  const heatPts = LISTINGS.filter(l => {
    if(!l.sb1123Eligible) return false;
    const exitPsf = l.clusterT1psf || l.newconPpsf || l.exitPsf || 0;
    const landBasisPsf = l.lotSf ? l.price / l.lotSf : 0;
    return exitPsf > 0 && landBasisPsf > 0;
  }).map(l => {
    const exitPsf = l.clusterT1psf || l.newconPpsf || l.exitPsf || 0;
    const landBasisPsf = l.lotSf ? l.price / l.lotSf : 0;
    const spread = exitPsf - landBasisPsf - BUILD_COST_PSF;
    
    // Normalize to 0-1 intensity: ‚â•$300=1.0, <$0=0.0
    const intensity = Math.max(0, Math.min(1, (spread + 100) / 400)); // -100 to 300 range
    return [l.lat, l.lng, intensity];
  });
  
  spreadHeatLayer = L.heatLayer(heatPts, {
    radius: 25,
    blur: 15,
    maxZoom: 17,
    max: 1.0,
    minOpacity: 0.25,
    pane: 'heatmapPane',
    gradient: {
      0.0:  '#ef4444',  // <$0 ‚Äî red (negative spread)
      0.25: '#f97316',  // $0-100 ‚Äî orange
      0.50: '#eab308',  // $100-200 ‚Äî yellow
      0.75: '#22c55e',  // $200-300 ‚Äî green
      1.0:  '#059669'   // ‚â•$300 ‚Äî deep green (maximum spread)
    }
  });
  
  document.getElementById('spreadCount').textContent = heatPts.length.toLocaleString();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRIORITY 3: NEIGHBORHOOD OPPORTUNITY SCORER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildNeighborhoodLayer(){
  neighborhoodLayer.clearLayers();

  // Grid cell size (0.01¬∞ ‚âà 1km)
  const CELL_SIZE = 0.01;

  // Group listings by neighborhood grid cell
  const cells = {};
  LISTINGS.forEach(l => {
    if(!l.sb1123Eligible) return;
    const exitPsf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    if(!exitPsf) return;
    const cellLat = Math.floor(l.lat / CELL_SIZE) * CELL_SIZE;
    const cellLng = Math.floor(l.lng / CELL_SIZE) * CELL_SIZE;
    const key = `${cellLat},${cellLng}`;
    if(!cells[key]) cells[key] = {lat:cellLat, lng:cellLng, listings:[], exitVals:[]};
    cells[key].listings.push(l);
    cells[key].exitVals.push(exitPsf);
  });

  // Calculate scores for each cell ‚Äî pure exit $/SF
  Object.values(cells).forEach(cell => {
    const vals = cell.exitVals;
    vals.sort((a,b)=>a-b);
    const median = vals.length%2 ? vals[Math.floor(vals.length/2)] : (vals[Math.floor(vals.length/2)-1]+vals[Math.floor(vals.length/2)])/2;
    const min = vals[0], max = vals[vals.length-1];

    // Color by median exit $/SF ($600-$1000 scale matching heatmap)
    let color, fillOpacity;
    if(median >= 1000)     { color = '#ef4444'; fillOpacity = 0.4; }
    else if(median >= 900) { color = '#eab308'; fillOpacity = 0.35; }
    else if(median >= 800) { color = '#22c55e'; fillOpacity = 0.35; }
    else if(median >= 700) { color = '#22d3ee'; fillOpacity = 0.3; }
    else if(median >= 600) { color = '#3b82f6'; fillOpacity = 0.3; }
    else                   { color = '#6366f1'; fillOpacity = 0.2; }

    // Create polygon for cell
    const bounds = [
      [cell.lat, cell.lng],
      [cell.lat + CELL_SIZE, cell.lng],
      [cell.lat + CELL_SIZE, cell.lng + CELL_SIZE],
      [cell.lat, cell.lng + CELL_SIZE]
    ];

    const polygon = L.polygon(bounds, {
      color: color,
      fillColor: color,
      fillOpacity: fillOpacity,
      weight: 1,
      opacity: 0.7
    });

    polygon.bindTooltip(`
      <div style="font-size:12px;font-weight:700;margin-bottom:4px;color:${color}">Exit $/SF: $${median.toFixed(0)}</div>
      <div style="font-size:10px;line-height:1.5">
        <div><strong>Range:</strong> $${min.toFixed(0)} ‚Äì $${max.toFixed(0)}/SF</div>
        <div><strong>Eligible Parcels:</strong> ${vals.length}</div>
      </div>
    `, {permanent: false, direction: 'top'});

    polygon.addTo(neighborhoodLayer);
  });

  document.getElementById('neighborhoodCount').textContent = Object.keys(cells).length.toLocaleString();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRIORITY 4: OFF-MARKET TARGETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function buildOffMarketLayer(){
  offMarketLayer.clearLayers();
  
  // In a real implementation, this would load a separate parcel dataset
  // For now, we'll simulate "off-market" by filtering existing data
  // that meets SB1123 criteria but isn't in active listings
  
  // Simulate off-market parcels (in practice, load from separate dataset)
  // For demo purposes, let's create a hypothetical off-market filter
  const offMarketListings = LISTINGS.filter(l => {
    if(!l.sb1123Eligible) return false;
    if(l._onForSaleLayer) return false;  // Already visible on For Sale layer

    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;

    // Est. Market Value = hood_psf √ó structure_sf
    const est_market_value = hood_psf * structure_sf;

    // Est. Offer = est_market_value √ó 0.95 (5% below market)
    const est_offer = est_market_value * 0.95;

    // Calculate pro forma metrics for margin calculation
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);

    // Margin at Offer - retail exit model
    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf + (l.sqft > 0 ? proforma.demoCost : 0);
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const f_insurance = proforma.insurance || 40000;
    const f_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + f_insurance + f_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;

    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;

    const lotEff = l.lotEfficiency || 0;
    const slope = l.slope || 0;

    return spread > 150 && margin_at_offer >= 0.25 && lotEff > 70 && !l.fireZone && slope < 15;
  });

  offMarketListings.forEach(l => {
    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;

    // Est. Market Value = hood_psf √ó structure_sf
    const est_market_value = hood_psf * structure_sf;

    // Est. Offer = est_market_value √ó 0.95
    const est_offer = est_market_value * 0.95;

    // Calculate pro forma metrics
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);

    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf + (l.sqft > 0 ? proforma.demoCost : 0);
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const om_insurance = proforma.insurance || 40000;
    const om_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + om_insurance + om_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;

    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    
    const target_margin = 0.30;
    const target_all_in_psf = exit_psf * (1 - target_margin);
    const target_land_basis_psf = target_all_in_psf - adjBuildCostPerSf;
    const target_max_buy = target_land_basis_psf * effective_buildable_sf;
    const headroom = target_max_buy - est_offer;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;
    
    // Color coding for margin_at_offer
    let marginColor = '#ef4444'; // red
    if(margin_at_offer >= 0.30) marginColor = '#22c55e'; // green
    else if(margin_at_offer >= 0.20) marginColor = '#facc15'; // yellow
    
    // Color coding for land_basis_psf
    let landBasisColor = '#ef4444'; // red
    if(land_basis_psf < 120) landBasisColor = '#22c55e'; // green
    else if(land_basis_psf >= 120 && land_basis_psf <= 160) landBasisColor = '#facc15'; // yellow
    
    // Color coding for headroom
    const headroomColor = headroom > 0 ? '#22c55e' : '#ef4444';
    
    // Color by spread for pin
    let pinColor = '#ef4444'; // red
    if(spread >= 300) pinColor = '#059669'; // deep green
    else if(spread >= 200) pinColor = '#22c55e'; // green
    else if(spread >= 100) pinColor = '#eab308'; // yellow
    else if(spread >= 0) pinColor = '#f97316'; // orange
    
    const offMarketIcon = L.divIcon({
      className: '',
      html: `<div style="width:10px;height:10px;border:2px solid ${pinColor};border-radius:50%;background:transparent;position:relative">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:1px;height:8px;background:${pinColor}"></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:1px;background:${pinColor}"></div>
      </div>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });
    
    const marker = L.marker([l.lat, l.lng], { icon: offMarketIcon });
    
    // Build full pro forma using est_offer as acquisition price
    const omProxy = Object.assign({}, l, {price: Math.round(est_offer)});
    const pf = calculateProForma(omProxy);
    const btr = calculateBTRProForma(omProxy);
    const omExitPsf = l.clusterT1psf || l.newconPpsf || l.exitPsf || 0;
    const omEstMvPsf = (est_market_value && l.lotSf) ? Math.round(est_market_value / l.lotSf) : null;

    marker.bindPopup(`
      ${l.burnZone ? '<div class="popup-badge" style="background:#dc2626;color:#fff;font-weight:700;padding:4px 10px">&#128293; BURN ZONE ‚Äî '+l.burnZone+' Fire (Jan 2025)</div>' : ''}
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <div class="popup-badge" style="background:#666;color:#fff">OFF-MARKET</div>
        <div class="popup-badge" style="background:${ZONE_COLORS[l.zone]||'#666'}22;color:${ZONE_COLORS[l.zone]||'#666'}">${l.zone} ‚Äî ${ZONE_LABELS[l.zone]||l.zone||'Unknown'}</div>
      </div>
      ${l.hasStructure ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">DEMO REQUIRED</div>' : ''}
      ${l.urbanArea === false ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">NOT URBAN AREA</div>' : ''}
      ${l.zone!=='R1'&&l.zone!=='LAND' ? (l.tenantRisk >= 3 ? '<div class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">HIGH TENANT RISK</div>' : l.tenantRisk >= 2 ? '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">TENANT RISK</div>' : '') : ''}
      ${l.zone!=='R1'&&l.zone!=='LAND'&&l.rsoRisk ? '<div class="popup-badge" style="background:rgba(220,38,38,0.15);color:#dc2626">RSO ‚Äî ELLIS ACT REQUIRED</div>' : ''}
      ${l.remainderViable ? '<div class="popup-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">REMAINDER PARCEL: '+l.remainderSf.toLocaleString()+' SF &#8594; '+l.remainderUnits+' units</div>' : l.remainderUnits > 0 ? '<div class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">REMAINDER: '+l.remainderSf.toLocaleString()+' SF ('+l.remainderUnits+' units)</div>' : ''}
      <div class="popup-title">${l.address || 'N/A'}</div>

      <div class="popup-grid">
        <div><div class="popup-label">Est. Market Value</div><div class="popup-value" style="color:${marginColor}">$${est_market_value > 0 ? Math.round(est_market_value).toLocaleString() : '‚Äî'}</div></div>
        <div><div class="popup-label">Exit $/SF</div><div class="popup-value">$${exitLabel(l).psf} <small style="color:${exitLabel(l).color}">(${exitLabel(l).short}${l.newconCount?', '+l.newconCount:''})</small></div></div>
        <div><div class="popup-label">All-In $/SF</div><div class="popup-value">$${pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0}/sf</div></div>
        <div><div class="popup-label">Spread</div><div class="popup-value" style="color:${(exitLabel(l).psf-(pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0))>=0?'var(--green)':'var(--red)'}">$${exitLabel(l).psf-(pf.effective_buildable_sf>0?Math.round(pf.totalCost/pf.effective_buildable_sf):0)}/sf</div></div>

        ${l.lotSf?lotLabel(l,Math.round(pf.lot_efficiency*100)):'<div></div>'}
        ${l.city?'<div><div class="popup-label">City</div><div class="popup-value">'+l.city+'</div></div>':'<div></div>'}
        <div><div class="popup-label">Zone</div><div class="popup-value">${l.zone||'‚Äî'}${l.zimasZone?' <small style="color:var(--text-dim)">'+l.zimasZone+'</small>':''}</div></div>
        ${l.slope!=null?'<div><div class="popup-label">Terrain Slope</div><div class="popup-value" style="color:'+(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)')+'">'+l.slope+'%</div></div>':'<div></div>'}

        ${proFormaBlock(l, pf, {buyLabel:'Est. Offer/Unit', buyPerUnit:Math.round(est_offer/pf.maxUnits), comparePrice:Math.round(est_offer)})}
      </div>

      <div class="popup-grid-2">
        <div class="popup-section-label">Economics (at Est. Offer $${Math.round(est_offer).toLocaleString()})</div>

        <div><div class="popup-label">Build $/SF${pf.adjBuildCostPerSf>proforma.allInBuildPsf?' <span style="color:var(--orange)">(slope adj)</span>':''}</div><div class="popup-value"${pf.adjBuildCostPerSf>proforma.allInBuildPsf?' style="color:var(--orange)"':''}>$${pf.adjBuildCostPerSf}/sf</div></div>
        <div><div class="popup-label">Construction</div><div class="popup-value">$${Math.round(pf.constructionCost).toLocaleString()}</div></div>
        ${pf.demo>0?'<div><div class="popup-label">Demo</div><div class="popup-value">$'+pf.demo.toLocaleString()+'</div></div><div></div>':''}
        <div><div class="popup-label">Insurance</div><div class="popup-value">$${pf.insurance.toLocaleString()}</div></div>
        <div><div class="popup-label">Loan Origination (${proforma.originationPct}%)</div><div class="popup-value">$${pf.originationFee.toLocaleString()}</div></div>
        <div><div class="popup-label">Carry Interest (${proforma.holdMonths}mo)</div><div class="popup-value">$${pf.carryInterest.toLocaleString()}</div></div>
        <div><div class="popup-label">Property Tax (${proforma.holdMonths}mo)</div><div class="popup-value">$${pf.carryPropTax.toLocaleString()}</div></div>

        <div class="popup-divider"></div>
        <div><div class="popup-label">Net Revenue</div><div class="popup-value">$${Math.round(pf.netRevenue).toLocaleString()}</div></div>
        <div><div class="popup-label">Est Profit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit).toLocaleString()}</div></div>

        <div><div class="popup-label">Sell / Unit</div><div class="popup-value" style="color:var(--green)">$${Math.round(pf.netRevenue/pf.maxUnits).toLocaleString()}</div></div>
        <div><div class="popup-label">Profit / Unit</div><div class="popup-value ${pf.profit>=0?'popup-profit-positive':'popup-profit-negative'}">$${Math.round(pf.profit/pf.maxUnits).toLocaleString()}</div></div>

        <div><div class="popup-label">Return on Cost</div><div class="popup-value ${pf.return_on_cost>=0?'popup-profit-positive':'popup-profit-negative'}">${pf.return_on_cost.toFixed(1)}%</div></div>
        <div><div class="popup-label">Net Margin on Sale</div><div class="popup-value ${pf.margin>=0?'popup-profit-positive':'popup-profit-negative'}">${pf.margin.toFixed(1)}%<br><small style="color:var(--text-dim);font-weight:400">(Revenue‚àíCost)/Revenue</small></div></div>

        <div class="popup-divider"></div>
        <div class="popup-section-label">BUILD-TO-RENT ANALYSIS</div>
        ${btr.btrPencils
          ? '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(34,197,94,0.1);color:var(--green);font-weight:600;font-size:11px">&#9989; BTR VIABLE ‚Äî '+(btr.yieldOnCost*100).toFixed(1)+'% YOC</div>'
          : btr.baseRent <= 0
            ? '<div class="popup-span-2" style="padding:4px 8px;border-radius:4px;background:rgba(100,116,139,0.1);color:#94a3b8;font-size:11px">&#9888;&#65039; BTR ‚Äî No rent data available</div>'
            : ''
        }
        ${btr.baseRent > 0 ? `
        <div><div class="popup-label">Rent Source</div><div class="popup-value">${getRentSourceLabel(l)}</div></div>
        ${RENTAL_COMPS.length > 0 && l.rentMethod && l.rentMethod.startsWith('rental-comp') ? `<div class="popup-span-2" style="font-size:10px;line-height:1.4"><a href="#" onclick="showRentalCompsTable(${l.lat},${l.lng});return false" style="color:var(--accent);cursor:pointer">${l.rentCompCount} rental comps within ${l.rentCompRadius}mi &#8599;</a></div>` : ''}
        ${btr.hasEstRent ? '' : `<div><div class="popup-label">Base FMR (3BR)</div><div class="popup-value">$${btr.baseRent.toLocaleString()}/mo</div></div>`}
        <div><div class="popup-label">Est. Rent/Unit</div><div class="popup-value">$${btr.rentPerUnit.toLocaleString()}/mo <small style="color:var(--text-dim)">(${proforma.avgUnitSf.toLocaleString()} SF)</small></div></div>
        <div><div class="popup-label">Gross Annual Rent</div><div class="popup-value">$${Math.round(btr.grossAnnualRent).toLocaleString()} <small style="color:var(--text-dim)">(${btr.units} units)</small></div></div>
        <div><div class="popup-label">NOI</div><div class="popup-value">$${Math.round(btr.annualNOI).toLocaleString()} <small style="color:var(--text-dim)">(${Math.round((1-btr.vacancyRate)*(1-btr.opexRatio)*100)}% of gross)</small></div></div>
        <div><div class="popup-label">OpEx</div><div class="popup-value">${Math.round(btr.opexRatio*100)}% <small style="color:var(--text-dim)">($${Math.round(btr.effectiveGrossIncome*btr.opexRatio).toLocaleString()}/yr)</small></div></div>
        <div><div class="popup-label">Yield on Cost</div><div class="popup-value" style="color:${btr.yieldOnCost>=btr.minYOC?'var(--green)':btr.yieldOnCost>=btr.minYOC*0.8?'var(--yellow)':'var(--red)'}">${(btr.yieldOnCost*100).toFixed(1)}%${btr.yieldOnCost<btr.minYOC?' <small style="color:var(--text-dim)">(min '+(btr.minYOC*100).toFixed(0)+'% target)</small>':''}</div></div>
        <div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:${btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)'}">$${(Math.round(btr.stabilizedValue/1000)/1000).toFixed(3).replace(/\.?0+$/,'')}M</div></div>
        <div><div class="popup-label">Cap Rate</div><div class="popup-value">${(btr.capRate*100).toFixed(1)}%</div></div>
        ` : `
        <div><div class="popup-label">Stabilized Value</div><div class="popup-value" style="color:var(--text-dim)">N/A</div></div>
        <div><div class="popup-label">Cap Rate</div><div class="popup-value" style="color:var(--text-dim)">N/A</div></div>
        `}
        ${btr.btrPencils ? `
        <div class="popup-span-2" style="font-size:10px;padding:3px 8px;border-radius:4px;background:${btr.stabilizedValue>=btr.totalCost?'rgba(34,197,94,0.1)':'rgba(239,68,68,0.1)'};color:${btr.stabilizedValue>=btr.totalCost?'var(--green)':'var(--red)'}">${btr.stabilizedValue>=btr.totalCost?'&#9989; Refi-able &mdash; $'+Math.round((btr.stabilizedValue-btr.totalCost)/1000).toLocaleString()+'k equity at '+(btr.capRate*100).toFixed(1)+'% cap':'&#10060; Refi gap: -$'+Math.round((btr.totalCost-btr.stabilizedValue)/1000).toLocaleString()+'k &mdash; cash trapped at '+(btr.capRate*100).toFixed(1)+'% cap'}</div>
        <div><div class="popup-label">DSCR</div><div class="popup-value" style="color:${btr.dscr>=1.25?'var(--green)':btr.dscr>=1.15?'var(--yellow)':'var(--red)'}">${btr.dscr.toFixed(2)}x</div></div>
        <div><div class="popup-label">Cash Flow</div><div class="popup-value" style="color:${btr.cashFlow>=0?'var(--green)':'var(--red)'}">$${Math.round(btr.cashFlow).toLocaleString()}/yr</div></div>
        ` : ''}

        <div class="popup-divider"></div>
        <div class="popup-section-label">ZIMAS Due Diligence</div>
        <div class="popup-span-2" style="font-size:10px;color:var(--text-dim);line-height:1.5">
          ${l.zimasZone ? (
            '<span style="color:var(--green)">‚úì</span> ' + l.zimasZone + ' zoning confirmed ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> Not Hillside Area ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> No Historic Overlay ‚Ä¢ ' +
            (l.burnZone ? '<span style="color:var(--red)">‚úó</span> &#128293; BURN ZONE ‚Äî active fire damage area. Insurance unavailable, infrastructure compromised.' : l.fireZone ? '<span style="color:var(--red)">‚úó</span> VHFHSZ fire zone (hard exclusion)' : '<span style="color:var(--green)">‚úì</span> NOT VHFHSZ (safe to build)') + ' ‚Ä¢ ' +
            '<span style="color:var(--green)">‚úì</span> No Specific Plan restrictions ‚Ä¢ ' +
            '<span style="color:var(--yellow)">&#9733;</span> Transit Priority Area = 0 parking ‚Ä¢ ' +
            (l.rsoRisk ? '<span style="color:var(--red)">&#10007;</span> RSO rent-controlled (Ellis Act)' : '<span style="color:var(--green)">&#10003;</span> No rent-control/Ellis Act') +
            slopeBadge(l)
          ) : '<span style="color:var(--yellow)">&#9888;&#65039;</span> No ZIMAS data ‚Äî zoning unverified (outside LA City)'}
        </div>
        ${l.rsoRisk&&l.zone!=='R1'&&l.zone!=='LAND' ? '<div class="popup-span-2" style="font-size:10px;color:#dc2626;line-height:1.4">&#9888; RSO: Budget ~$20K/unit relocation + 120-day Ellis Act notice</div>' : ''}
        ${remainderAnalysis(l)}
      </div>
      <div style="margin-top:6px;display:flex;gap:8px;justify-content:center;align-items:center">
        <a href="https://www.google.com/maps?q=${l.lat},${l.lng}&t=k&z=19" target="_blank" style="color:var(--accent);font-size:11px">Google Maps &#8599;</a>
        ${l.url?`<a href="${l.url}" target="_blank" style="color:var(--accent);font-size:11px">Redfin &#8599;</a>`:''}
        <a href="${getZimasUrl(l)}" target="_blank" style="color:var(--yellow);font-size:11px">ZIMAS &#8599;</a>
        ${l.lw && l.ld ? `<a href="${lotPlannerUrl(l)}" target="_blank" style="color:var(--accent);font-size:11px">Layout Planner &#8599;</a>` : ''}
        <button class="popup-fav-btn" onclick="alert('Mail campaign coming soon!')" style="background:var(--accent);color:#fff;border-color:var(--accent)">Mail ‚òÖ</button>
        <button class="popup-fav-btn" onclick="exportModel(${l.lat},${l.lng}).catch(console.error)">&#128202; XLS</button>
        <button class="popup-fav-btn" onclick="exportOM(${l.lat},${l.lng}).catch(console.error)">&#128196; OM</button>
        <button class="popup-fav-btn ${isFavorite(l)?'active':''}" onclick="toggleFavorite(${l.lat},${l.lng});this.classList.toggle('active')">&#9733; ${isFavorite(l)?'Saved':'Save'}</button>
        <button class="popup-fav-btn" onclick="sharePin(${l.lat},${l.lng},event)">&#128279; Share</button>
      </div>
      ${lotLayoutSection(l, pf)}
    `, {maxWidth: 580});

    marker.addTo(offMarketLayer);
  });
  
}

function refreshVisibility(){
  Object.entries(markerLayers).forEach(([z,l])=>{
    if(layerState.markers && zoneState[z]) l.addTo(map);
    else map.removeLayer(l);
  });
  if(compHeatLayer){
    if(layerState.compHeat) compHeatLayer.addTo(map);
    else map.removeLayer(compHeatLayer);
  }
  if(layerState.compHeat){
    compPointsLayer.addTo(map);
    compLabelsLayer.addTo(map);
    updateCompPoints();
  } else {
    map.removeLayer(compPointsLayer);
    map.removeLayer(compLabelsLayer);
  }
  // Priority 2: Spread heatmap
  if(spreadHeatLayer){
    if(layerState.spreadHeat) spreadHeatLayer.addTo(map);
    else map.removeLayer(spreadHeatLayer);
  }
  // Priority 3: Neighborhood opportunity scorer
  if(layerState.neighborhoods){
    if(neighborhoodLayer.getLayers().length === 0) buildNeighborhoodLayer();
    neighborhoodLayer.addTo(map);
  } else {
    map.removeLayer(neighborhoodLayer);
  }
  if(layerState.listings) listingsLayer.addTo(map);
  else map.removeLayer(listingsLayer);
  // Priority 4: Off-market targets
  if(layerState.offMarket){
    if(offMarketLayer.getLayers().length === 0) buildOffMarketLayer();
    offMarketLayer.addTo(map);
  } else {
    map.removeLayer(offMarketLayer);
  }
  if(layerState.btr) {
    if(btrLayer.getLayers().length === 0) buildBTRLayer();
    btrLayer.addTo(map);
  } else {
    map.removeLayer(btrLayer);
  }
  if(fireZoneLayer){
    if(layerState.fireZones) fireZoneLayer.addTo(map);
    else map.removeLayer(fireZoneLayer);
  }
  if(floodZoneLayer){
    if(layerState.floodZones) floodZoneLayer.addTo(map);
    else map.removeLayer(floodZoneLayer);
  }
  if(liquefactionLayer){
    if(layerState.liquefaction) liquefactionLayer.addTo(map);
    else map.removeLayer(liquefactionLayer);
  }
  if(parcelLayer){
    if(layerState.parcels) parcelLayer.addTo(map);
    else map.removeLayer(parcelLayer);
  }
  updatePinLegend();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIN LEGEND (dynamic, updates with layers)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updatePinLegend(){
  const legend = document.getElementById('pinLegend');
  if(!legend) return;
  
  let html = '';
  
  // Show For Sale legend if listings layer is on
  if(layerState.listings){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#22c55e"></div> 30%+ margin</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#facc15"></div> 20-29% margin</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#9ca3af"></div> Under 20% margin</div>';
  }
  
  // Show BTR legend if Build to Rent layer is on
  if(layerState.btr){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker diamond"></div> BTR-only deal</div>';
  }
  // Show dual-viable legend if both listings and BTR layers are on
  if(layerState.listings && layerState.btr){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="border:2px solid #f59e0b;background:#22c55e"></div> BTS + BTR viable</div>';
  }
  
  // Show Off-Market legend if off-market layer is on
  if(layerState.offMarket){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker circle"></div> Off-market target</div>';
  }

  // Show tier legend when comp layer is on
  if(layerState.compHeat){
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#14b8a6"></div> T1 New/Remodel</div>';
    html += '<div class="pin-legend-item"><div class="pin-legend-marker" style="background:#64748b"></div> T2 Existing</div>';
  }

  legend.innerHTML = html;
  legend.style.display = html ? 'block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEAL ASSUMPTIONS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Onboarding ‚îÄ‚îÄ
const ONBOARD_KEY = 'sb1123_onboarded';
function showOnboardingIfNeeded(){
  if(localStorage.getItem(ONBOARD_KEY)) return;
  const tip = document.getElementById('onboarding-tip');
  if(tip) tip.style.display = 'block';
}
function dismissOnboarding(){
  localStorage.setItem(ONBOARD_KEY, '1');
  const tip = document.getElementById('onboarding-tip');
  if(tip) tip.style.display = 'none';
}

function openAssumptionsModal(){
  document.getElementById('assumptionsModal').classList.add('active');
}

function closeAssumptionsModal(){
  document.getElementById('assumptionsModal').classList.remove('active');
}
function closeDataKeyModal(){
  document.getElementById('dataKeyModal').classList.remove('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HERO STAT BAR (updates with filters)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateHeroStats(){
  const filtered = getFilteredListings();
  const forSale = filtered.filter(l=>l.sb1123Eligible);
  
  // Count off-market opportunities (must match buildOffMarketLayer filter)
  const offMarket = LISTINGS.filter(l => {
    if(!l.sb1123Eligible) return false;
    if(l._onForSaleLayer) return false;  // Already visible on For Sale layer
    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);
    const est_market_value = hood_psf * structure_sf;
    const est_offer = est_market_value * 0.95;
    const exit_psf = hood_psf;
    const gross_revenue_h = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue_h * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const demo = l.sqft > 0 ? proforma.demoCost : 0;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf + demo;
    const h_carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const h_carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const h_insurance = proforma.insurance || 40000;
    const h_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = h_carry_interest + h_carry_prop_tax + h_insurance + h_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;
    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    const spread = hood_psf - land_basis_psf - adjBuildCostPerSf;
    const lotEff = l.lotEfficiency || 0;
    const slope = l.slope || 0;
    return spread > 150 && margin_at_offer >= 0.25 && lotEff > 70 && !l.fireZone && slope < 15;
  }).length;
  
  const highMargin = forSale.filter(l => l.estMargin >= 30).length;
  const positiveMargin = forSale.filter(l => l.estMargin > 0);
  const avgMargin = positiveMargin.length ? Math.round(positiveMargin.reduce((sum,l)=>sum+l.estMargin,0)/positiveMargin.length) : 0;
  
  document.getElementById('heroForSale').textContent = forSale.length.toLocaleString();
  document.getElementById('heroOffMarket').textContent = offMarket.toLocaleString();
  document.getElementById('heroHighMargin').textContent = highMargin.toLocaleString();
  document.getElementById('heroAvgMargin').textContent = avgMargin + '%';

  // BTR hero stats ‚Äî visible when BTR layer is on
  const showBtr = layerState.btr;
  ['heroBtrSep','heroBtrItem','heroBtrYocSep','heroBtrYocItem','heroBtrRentSep','heroBtrRentItem','heroBtrZoriSep','heroBtrZoriItem'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.style.display = showBtr ? '' : 'none';
  });
  if(showBtr){
    // Use pre-computed BTR fields from pipeline
    const btrDeals = LISTINGS.filter(l => {
      if(!l.sb1123Eligible) return false;
      if(!l.yocBase || l.yocBase <= 0) return false;
      const btsMargin = l.estMargin || 0;
      return btsMargin < 20 && l.yocBase >= 0.04;
    });
    const btrYocs = btrDeals.map(l => l.yocBase).filter(y => y > 0);
    const avgYoc = btrYocs.length ? (btrYocs.reduce((a,b)=>a+b,0)/btrYocs.length*100).toFixed(1) : '0.0';
    const btrRents = btrDeals.map(l => l.rentBase).filter(r => r > 0);
    const avgRent = btrRents.length ? Math.round(btrRents.reduce((a,b)=>a+b,0)/btrRents.length) : 0;
    const zoris = btrDeals.map(l => l.zoriBase).filter(z => z > 0);
    const avgZori = zoris.length ? Math.round(zoris.reduce((a,b)=>a+b,0)/zoris.length) : 0;
    document.getElementById('heroBtrDeals').textContent = btrDeals.length.toLocaleString();
    document.getElementById('heroBtrYoc').textContent = avgYoc + '%';
    document.getElementById('heroBtrRent').textContent = '$' + avgRent.toLocaleString() + '/mo';
    document.getElementById('heroBtrZori').textContent = avgZori > 0 ? '$' + avgZori.toLocaleString() + '/mo' : 'N/A';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function toggleZone(zone,enabled){
  zoneState[zone]=enabled;
  applyFilters();
}

function setHeatmapMode(mode) {
  heatmapMode = mode;
  document.getElementById('heatRaw').classList.toggle('active', mode === 'raw');
  document.getElementById('heatNorm').classList.toggle('active', mode === 'normalized');
  document.getElementById('heatmapModeLabel').textContent =
    mode === 'normalized' ? 'T1 (New/Remodel) at 1,750 SF' : 'All sales, raw $/SF';

  if (compHeatLayer) map.removeLayer(compHeatLayer);

  if (mode === 'normalized' && CLUSTERS.length > 0) {
    const HEAT_MIN = 500, HEAT_MAX = 900;
    const heatPts = CLUSTERS.filter(cl => cl.t1psf > 0).map(cl => {
      const intensity = Math.max(0, Math.min(1, (cl.t1psf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
      return [cl.lat, cl.lng, intensity];
    });
    compHeatLayer = L.heatLayer(heatPts, {
      radius: 30, blur: 20, maxZoom: 17, max: 1.0, minOpacity: 0.25,
      pane: 'heatmapPane',
      gradient: { 0.0:'#3b82f6', 0.25:'#22d3ee', 0.50:'#22c55e', 0.75:'#eab308', 1.0:'#ef4444' }
    });
  } else {
    const HEAT_MIN = 600, HEAT_MAX = 1000;
    const heatPts = COMPS.filter(c => c.ppsf > 0).map(c => {
      const intensity = Math.max(0, Math.min(1, (c.ppsf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
      return [c.lat, c.lng, intensity];
    });
    compHeatLayer = L.heatLayer(heatPts, {
      radius: 25, blur: 15, maxZoom: 17, max: 1.0, minOpacity: 0.25,
      pane: 'heatmapPane',
      gradient: { 0.0:'#3b82f6', 0.25:'#22d3ee', 0.50:'#22c55e', 0.75:'#eab308', 1.0:'#ef4444' }
    });
  }

  if (layerState.compHeat) compHeatLayer.addTo(map);
}

function toggleLayer(layer,btn){
  // Priority 2: Make compHeat and spreadHeat mutually exclusive
  if(layer === 'compHeat' && layerState.spreadHeat){
    layerState.spreadHeat = false;
    const spreadBtn = document.querySelector('[data-layer="spreadHeat"]');
    if(spreadBtn) spreadBtn.classList.remove('active');
  }
  if(layer === 'spreadHeat' && layerState.compHeat){
    layerState.compHeat = false;
    const compBtn = document.querySelector('[data-layer="compHeat"]');
    if(compBtn) compBtn.classList.remove('active');
  }
  
  layerState[layer]=!layerState[layer];
  btn.classList.toggle('active');
  // Show/hide comp sub-controls when compHeat toggles
  if(layer === 'compHeat' || layer === 'spreadHeat'){
    const show = layerState.compHeat;
    document.getElementById('heatmapModeToggle').style.display = show ? 'block' : 'none';
    document.getElementById('tierFilterSection').style.display = show ? 'block' : 'none';
  }
  refreshVisibility();
}

function toggleSection(titleEl){
  titleEl.closest('.section').classList.toggle('collapsed');
}

function toggleListingsPanel(){
  const panel = document.getElementById('listingsPanel');
  const tab = document.getElementById('listingsPanelTab');
  listingsPanelOpen = !listingsPanelOpen;
  panel.classList.toggle('open', listingsPanelOpen);
  if(tab) tab.style.display = listingsPanelOpen ? 'none' : 'flex';
  if(isMobile() && listingsPanelOpen) setSheetState('collapsed');
  setTimeout(() => map.invalidateSize(), 350);
}

// ‚îÄ‚îÄ Panel resize ‚îÄ‚îÄ
(function(){
  const panel = document.getElementById('listingsPanel');
  const handle = document.getElementById('panelResize');
  let startY, startH;
  handle.addEventListener('mousedown', function(e){
    startY = e.clientY; startH = panel.offsetHeight;
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
    e.preventDefault();
  });
  handle.addEventListener('touchstart', function(e){
    startY = e.touches[0].clientY; startH = panel.offsetHeight;
    document.addEventListener('touchmove', onTouchMove, {passive:false});
    document.addEventListener('touchend', onTouchUp);
  }, {passive:true});
  function onMove(e){
    const diff = startY - e.clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
  }
  function onTouchMove(e){
    const diff = startY - e.touches[0].clientY;
    panel.style.height = Math.max(150, Math.min(window.innerHeight*0.7, startH+diff))+'px';
    e.preventDefault();
  }
  function onUp(){
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    map.invalidateSize();
  }
  function onTouchUp(){
    document.removeEventListener('touchmove', onTouchMove);
    document.removeEventListener('touchend', onTouchUp);
    map.invalidateSize();
  }
})();

// ‚îÄ‚îÄ Presets ‚îÄ‚îÄ
function applyPreset(name,btn){
  // Clear all first
  resetFilter('all');
  sb1123Mode = true;
  newThisWeekFilter = false;

  document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');

  if(name === 'stale'){
    // Stale inventory ‚Äî negotiation leverage
    currentSort = {key:'dom', dir:'desc'};
  } else if(name === 'newThisWeek'){
    // New listings this week ‚Äî DOM <= 7
    newThisWeekFilter = true;
    currentSort = {key:'dom', dir:'asc'};
  } else if(name === 'offMarket'){
    // Toggle Off-Market layer on, zoom to show opportunities
    if(!layerState.offMarket){
      layerState.offMarket = true;
      const btn = document.querySelector('[data-layer="offMarket"]');
      if(btn) btn.classList.add('active');
      refreshVisibility();
    }
  }
  applyFilters();
}

function setFilter(key, min, max){
  const f = filters[key];
  f.min = Math.max(f.dataMin, min);
  f.max = Math.min(f.dataMax, max);
  const sMin = document.getElementById(key+'SliderMin');
  const sMax = document.getElementById(key+'SliderMax');
  const iMin = document.getElementById(key+'Min');
  const iMax = document.getElementById(key+'Max');
  if(sMin) sMin.value = f.min;
  if(sMax) sMax.value = f.max;
  if(iMin) iMin.value = f.min;
  if(iMax) iMax.value = f.max;
  updateFill(key);
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
function updateStats(){
  const filtered = getFilteredListings();

  // Listing count in layers panel
  const listingCountEl = document.getElementById('listingCount');
  if(listingCountEl) listingCountEl.textContent = filtered.length.toLocaleString();

  // Comp stats
  const compFiltered = getFilteredComps();
  const compCountEl = document.getElementById('compCount');
  if(compCountEl) compCountEl.textContent = compFiltered.length.toLocaleString();

  updatePeekStats();
  updateLayerCounts();
}

// Compute layer counts regardless of toggle state so sidebar shows what's available
function updateLayerCounts(){
  // Off-Market count ‚Äî same predicate as buildOffMarketLayer() but without _onForSaleLayer gate
  let offMarketN = 0;
  for(const l of LISTINGS){
    if(!l.sb1123Eligible) continue;
    const hood_psf = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
    const structure_sf = l.sqft || 0;
    const est_market_value = hood_psf * structure_sf;
    const est_offer = est_market_value * 0.95;
    const maxUnits = getMaxUnits(l);
    const effective_buildable_sf = maxUnits * proforma.avgUnitSf;
    const adjBuildCostPerSf = getSlopeAdjBuildCost(l.slope, proforma.allInBuildPsf);
    const exit_psf = hood_psf;
    const gross_revenue = maxUnits * exit_psf * proforma.avgUnitSf;
    const net_revenue = gross_revenue * (1 - proforma.txnCostPct / 100) - proforma.fixedDispositionCosts;
    const total_build = adjBuildCostPerSf * maxUnits * proforma.avgUnitSf + (l.sqft > 0 ? proforma.demoCost : 0);
    const carry_interest = (total_build * 0.5) * (proforma.carryRatePct / 100) * (proforma.holdMonths / 12);
    const carry_prop_tax = est_offer * 0.011 * (proforma.holdMonths / 12);
    const f_insurance = proforma.insurance || 40000;
    const f_origination = total_build * ((proforma.originationPct || 1) / 100);
    const total_carry = carry_interest + carry_prop_tax + f_insurance + f_origination;
    const total_cost = est_offer + total_build + total_carry;
    const est_profit = net_revenue - total_cost;
    const margin_at_offer = net_revenue > 0 ? (est_profit / net_revenue) : 0;
    const land_basis_psf = effective_buildable_sf > 0 ? (est_offer / effective_buildable_sf) : 0;
    const spread = exit_psf - land_basis_psf - adjBuildCostPerSf;
    const lotEff = l.lotEfficiency || 0;
    const slope = l.slope || 0;
    if(spread > 150 && margin_at_offer >= 0.25 && lotEff > 70 && !l.fireZone && slope < 15) offMarketN++;
  }
  const omEl = document.getElementById('offMarketCount');
  if(omEl) omEl.textContent = offMarketN.toLocaleString();

  // BTR count ‚Äî use pre-computed yocBase when available
  const btrMinYOC = parseFloat((document.getElementById('btrMinYOC')||{}).value) || 0.04;
  let btrN = 0;
  for(const l of LISTINGS){
    if(!l.sb1123Eligible) continue;
    const btsMargin = l.estMargin || 0;
    if(btsMargin >= 20) continue;
    if(l.yocBase > 0){
      if(l.yocBase >= btrMinYOC) btrN++;
    } else {
      if(!(l.estRentMonth > 0 || l.fmr3br > 0)) continue;
      const btrPF = calculateBTRProForma(l);
      if(btrPF.btrPencils) btrN++;
    }
  }
  const btrEl = document.getElementById('btrCount');
  if(btrEl) btrEl.textContent = btrN.toLocaleString();
}

function updateFilterCount(){
  const comps = getFilteredComps().length;
  const listings = getFilteredListings().length;
  const fc = document.getElementById('filterCount');
  if(fc) fc.textContent = `${comps.toLocaleString()} comps | ${listings.toLocaleString()} listings`;
  const lpc = document.getElementById('listingPanelCount');
  if(lpc) lpc.textContent = `${listings} deals`;
}

function rebuildZoneToggles(){
  const el=document.getElementById('zoneToggles');
  if(!el){ console.error('zoneToggles element not found!'); return; }
  el.innerHTML='';
  const filtered = getFilteredComps();
  const fListings = getFilteredListings();
  ['R1','R2','R3','R4','LAND'].forEach(zone=>{
    const zc=filtered.filter(c=>c.zone===zone);
    const zl=fListings.filter(l=>l.zone===zone);
    const psfs=zc.map(c=>c.ppsf||c.price/c.sqft);
    const avg=psfs.length?Math.round(psfs.reduce((a,b)=>a+b,0)/psfs.length):0;
    const div=document.createElement('label');
    div.className='zone-toggle';
    div.innerHTML=`
      <input type="checkbox" ${zoneState[zone]?'checked':''} onchange="toggleZone('${zone}',this.checked)">
      <span class="check-box"></span>
      <span class="zone-swatch" style="background:${ZONE_COLORS[zone]}"></span>
      <span class="zone-label">${zone} <small>${ZONE_LABELS[zone]}</small></span>
      <span class="zone-stat">${avg?'$'+avg+'/sf':'‚Äî'}<span class="data-count">${zl.length}</span></span>
    `;
    el.appendChild(div);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SORTABLE TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getSortValue(l, key){
  if(key==='fav') return isFavorite(l)?1:0;
  if(key==='isNew') return l.isNew ? 2 : l.isNewThisWeek ? 1 : 0;
  if(key==='lw') return l.lw||0;
  if(key==='maxUnits') return l.maxUnits||1;
  if(key==='pricePerUnit') return l.pricePerUnit||Infinity;
  if(key==='salePerUnit') return l.salePerUnit||0;
  if(key==='estProfit') return l.estProfit||(-Infinity);
  if(key==='estMargin') return l.estMargin||(-Infinity);
  const v=l[key]; return v===null||v===undefined ? -Infinity : v;
}

function sortTable(key){
  if(currentSort.key===key) currentSort.dir = currentSort.dir==='asc'?'desc':'asc';
  else{
    currentSort.key=key;
    currentSort.dir = (typeof getSortValue(LISTINGS[0]||{},key)==='string')?'asc':'desc';
  }
  document.querySelectorAll('.listings-table th').forEach(th=>{
    th.classList.remove('sorted');
    const arrow = th.querySelector('.sort-arrow');
    if(arrow) arrow.textContent='‚ñ≤';
  });
  const th=document.querySelector(`.listings-table th[data-sort="${key}"]`);
  if(th){
    th.classList.add('sorted');
    const arrow = th.querySelector('.sort-arrow');
    if(arrow) arrow.textContent=currentSort.dir==='asc'?'‚ñ≤':'‚ñº';
  }
  rebuildTable(getFilteredListings());
}

function rebuildTable(filtered){
  const tbody = document.getElementById('listingsTableBody');
  
  // Only sort if we have a valid sort key
  let sorted = filtered;
  if (currentSort && currentSort.key) {
    sorted = [...filtered].sort((a,b) => {
      let va=getSortValue(a,currentSort.key), vb=getSortValue(b,currentSort.key);
      if(typeof va==='string') va=va.toLowerCase();
      if(typeof vb==='string') vb=vb.toLowerCase();
      if(va<vb) return currentSort.dir==='asc'?-1:1;
      if(va>vb) return currentSort.dir==='asc'?1:-1;
      return 0;
    });
  }

  // Cap table rows for performance
  const display = sorted.slice(0, 500);

  tbody.innerHTML = display.map(l => {
    const zoneColor = ZONE_COLORS[l.zone]||'#666';
    const profitClass = (l.estProfit||0)>=0?'profit-pos':'profit-neg';
    const marginClass = (l.estMargin||0)>=0?'profit-pos':'profit-neg';
    const starred = isFavorite(l);
    const exitPpsf = l.clusterT1psf || l.newconPpsf || l.exitPsf;
    return `<tr onclick="flyToListing(${l.lat},${l.lng})" onmouseenter="highlightMarker(${l.lat},${l.lng})" onmouseleave="unhighlightMarker()">
      <td class="col-fav"><span class="fav-star ${starred?'active':''}" onclick="event.stopPropagation();toggleFavorite(${l.lat},${l.lng})">&#9733;</span></td>
      <td class="col-addr" title="${l.address}">${l.address}</td>
      <td class="col-zone"><span class="zone-pill" style="background:${zoneColor}22;color:${zoneColor}">${l.zone||'‚Äî'}</span></td>
      <td class="col-price mono">$${l.price.toLocaleString()}</td>
      <td class="col-lot mono">${l.lotSf?l.lotSf.toLocaleString():'‚Äî'}</td>
      <td class="col-lotw mono">${l.lw?l.lw+"'":'\u2014'}</td>
      <td class="col-units mono" style="color:${l.maxUnits>=8?'var(--green)':l.maxUnits>=4?'var(--yellow)':'var(--text-dim)'}">${l.maxUnits}${l.layoutNote?' <span style="font-size:9px;color:var(--orange)" title="'+l.layoutNote+'">&#9888;</span>':''}</td>
      <td class="col-hood mono">${exitPpsf?'$'+exitPpsf:'‚Äî'}</td>
      <td class="col-sale mono">${l.salePerUnit?'$'+(l.salePerUnit).toLocaleString():'‚Äî'}</td>
      <td class="col-ppu mono">$${(l.pricePerUnit||0).toLocaleString()}</td>
      <td class="col-profit mono ${profitClass}">$${Math.round(l.estProfit||0).toLocaleString()}</td>
      <td class="col-margin mono ${marginClass}">${(l.estMargin||0).toFixed(0)}%</td>
      <td class="col-slope mono" style="color:${l.slope!=null?(l.slope<5?'var(--green)':l.slope<15?'var(--yellow)':l.slope<25?'var(--orange)':'var(--red)'):'var(--text-dim)'}">${l.slope!=null?l.slope+'%':'‚Äî'}${l.slopeScore!=null?' <span style="font-size:9px;color:'+(l.slopeScore<=20?'var(--green)':l.slopeScore<=50?'var(--yellow)':l.slopeScore<=75?'var(--orange)':'var(--red)')+'">S'+l.slopeScore+'</span>':''}</td>
      <td class="col-dom mono">${l.dom!==null&&l.dom!==undefined?l.dom:'‚Äî'}</td>
      <td class="col-new">${l.isNew?'<span class="new-badge">NEW</span>':l.isNewThisWeek?'<span class="new-badge week">7d</span>':''}</td>
      <td class="col-link">${l.url?'<a class="redfin-link" href="'+l.url+'" target="_blank" onclick="event.stopPropagation()">View</a>':''}</td>
    </tr>`;
  }).join('');

  const countStr = sorted.length > 500 ? `${sorted.length} deals (showing 500)` : `${sorted.length} deals`;
  const tablePanelCount = document.getElementById('tablePanelCount');
  if(tablePanelCount) tablePanelCount.textContent = countStr;
  const tabPanelCount = document.getElementById('tabPanelCount');
  if(tabPanelCount) tabPanelCount.textContent = `${sorted.length} deals`;
  rebuildMobileCards(sorted);
}

function flyToListing(lat, lng){
  if(isMobile()){
    if(listingsPanelOpen) toggleListingsPanel();
    setSheetState('collapsed');
  }
  map.flyTo([lat, lng], 16, {duration:0.8});
  listingsLayer.eachLayer(layer => {
    if(layer.getLatLng){
      const ll = layer.getLatLng();
      if(Math.abs(ll.lat-lat)<0.0001 && Math.abs(ll.lng-lng)<0.0001) layer.openPopup();
    }
  });
}

let _highlightedPath = null;
function highlightMarker(lat, lng){
  unhighlightMarker();
  listingsLayer.eachLayer(layer => {
    if(!layer.getLatLng || !layer._path) return;
    const ll = layer.getLatLng();
    if(Math.abs(ll.lat - lat) < 0.0001 && Math.abs(ll.lng - lng) < 0.0001){
      layer._path.classList.add('marker-highlight');
      _highlightedPath = layer._path;
    }
  });
}
function unhighlightMarker(){
  if(_highlightedPath){ _highlightedPath.classList.remove('marker-highlight'); _highlightedPath = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTER MACHINERY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initRangeFilter(key, valueFn, dataSource){
  const f = filters[key];
  const source = dataSource || COMPS;
  const values = source.map(valueFn).filter(v => v > 0);
  if(!values.length) return;
  let vMin = Infinity, vMax = -Infinity;
  for(let i=0;i<values.length;i++){ if(values[i]<vMin) vMin=values[i]; if(values[i]>vMax) vMax=values[i]; }
  f.dataMin = Math.floor(vMin / f.step) * f.step;
  f.dataMax = Math.ceil(vMax / f.step) * f.step;
  if(f.cap && f.dataMax > f.cap) f.dataMax = f.cap;
  f.min = f.dataMin; f.max = f.dataMax;
  if(f.defaultMin != null && f.defaultMin >= f.dataMin) f.min = Math.min(f.defaultMin, f.dataMax);
  if(f.defaultMax != null && f.defaultMax <= f.dataMax) f.max = Math.max(f.defaultMax, f.dataMin);

  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  sMin.min=f.dataMin; sMin.max=f.dataMax; sMin.value=f.min; sMin.step=f.step;
  sMax.min=f.dataMin; sMax.max=f.dataMax; sMax.value=f.max; sMax.step=f.step;
  iMin.value=f.min; iMax.value=f.max;
  updateFill(key);

  let timer=null;
  function debounced(){ clearTimeout(timer); timer=setTimeout(applyFilters, 250); }
  sMin.addEventListener('input', function(){
    let v=parseInt(this.value); if(v>parseInt(sMax.value)-f.step) v=parseInt(sMax.value)-f.step;
    this.value=v; iMin.value=v; f.min=v; updateFill(key); debounced();
  });
  sMax.addEventListener('input', function(){
    let v=parseInt(this.value); if(v<parseInt(sMin.value)+f.step) v=parseInt(sMin.value)+f.step;
    this.value=v; iMax.value=v; f.max=v; updateFill(key); debounced();
  });
  iMin.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMin; v=Math.max(f.dataMin,Math.min(v,f.max-f.step));
    this.value=v; sMin.value=v; f.min=v; updateFill(key); applyFilters();
  });
  iMax.addEventListener('change', function(){
    let v=parseInt(this.value)||f.dataMax; v=Math.min(f.dataMax,Math.max(v,f.min+f.step));
    this.value=v; sMax.value=v; f.max=v; updateFill(key); applyFilters();
  });
}

function updateFill(key){
  const f=filters[key], fill=document.getElementById(key+'SliderFill');
  if(!fill) return;
  const range=f.dataMax-f.dataMin; if(range<=0) return;
  fill.style.left=((f.min-f.dataMin)/range)*100+'%';
  fill.style.width=((f.max-f.min)/range)*100+'%';
}

function setMarginPreset(minPct,btn){
  document.querySelectorAll('.preset-row .preset-btn').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  const f=filters.margin;
  f.min=minPct; f.max=f.dataMax;
  const sMin=document.getElementById('marginSliderMin'), sMax=document.getElementById('marginSliderMax');
  const iMin=document.getElementById('marginMin'), iMax=document.getElementById('marginMax');
  if(sMin) sMin.value=minPct;
  if(iMin) iMin.value=minPct;
  if(sMax) sMax.value=f.dataMax;
  if(iMax) iMax.value=f.dataMax;
  updateFill('margin');
  applyFilters();
}

function applyFilters(){
  rebuildMarkers();
  rebuildListings();
  if(layerState.btr) buildBTRLayer();
  if(layerState.neighborhoods) buildNeighborhoodLayer();
  if(layerState.offMarket) buildOffMarketLayer();
  rebuildZoneToggles();
  updateStats();
  updateFilterCount();
  updateHeroStats();
  refreshVisibility();
  applyPolygonOpacity();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  POLYGON DRAW-TO-FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initDrawControl(){
  const container = L.DomUtil.create('div','draw-control');
  container.innerHTML = `
    <button class="draw-btn" id="drawBtn" title="Draw area to filter">&#9998;</button>
    <button class="draw-btn" id="drawDoneBtn" title="Close polygon" style="display:none;font-size:11px;font-weight:700">Done</button>
    <button class="draw-clear-btn" id="drawClearBtn" title="Clear drawn area">&#10005;</button>
    <button class="draw-btn" id="dataKeyBtn" title="Data Key ‚Äî how metrics are calculated" style="font-size:14px;font-weight:700;margin-top:8px">?</button>
  `;
  document.getElementById('map').appendChild(container);
  L.DomEvent.disableClickPropagation(container);
  L.DomEvent.disableScrollPropagation(container);

  document.getElementById('drawBtn').addEventListener('click', toggleDrawMode);
  document.getElementById('drawDoneBtn').addEventListener('click', function(){ finishPolygon(); });
  document.getElementById('drawClearBtn').addEventListener('click', clearDrawPolygon);
  document.getElementById('dataKeyBtn').addEventListener('click', function(){
    document.getElementById('dataKeyModal').classList.add('active');
  });
}

function toggleDrawMode(){
  if(drawMode) stopDrawMode();
  else startDrawMode();
}

function startDrawMode(){
  drawMode = true;
  drawVertices = [];
  document.getElementById('drawBtn').classList.add('active');
  document.getElementById('drawDoneBtn').style.display = 'none';
  map.getContainer().classList.add('draw-mode');
  map._drawClickHandler = onDrawClick;
  map._drawMoveHandler = onDrawMouseMove;
  map._drawDblClickHandler = onDrawDoubleClick;
  map._drawKeyHandler = onDrawKeyDown;
  map.on('click', map._drawClickHandler);
  map.on('mousemove', map._drawMoveHandler);
  map.on('dblclick', map._drawDblClickHandler);
  document.addEventListener('keydown', map._drawKeyHandler);
  map.doubleClickZoom.disable();
}

function stopDrawMode(){
  drawMode = false;
  document.getElementById('drawBtn').classList.remove('active');
  document.getElementById('drawDoneBtn').style.display = 'none';
  map.getContainer().classList.remove('draw-mode');
  if(drawPreviewLine){ map.removeLayer(drawPreviewLine); drawPreviewLine = null; }
  if(map._drawClickHandler) map.off('click', map._drawClickHandler);
  if(map._drawMoveHandler) map.off('mousemove', map._drawMoveHandler);
  if(map._drawDblClickHandler) map.off('dblclick', map._drawDblClickHandler);
  if(map._drawKeyHandler) document.removeEventListener('keydown', map._drawKeyHandler);
  map.doubleClickZoom.enable();
}

function onDrawClick(e){
  if(!drawMode) return;
  // If we already have 3+ vertices, check snap-to-first (close polygon)
  if(drawVertices.length >= 3){
    const first = map.latLngToContainerPoint(L.latLng(drawVertices[0]));
    const click = map.latLngToContainerPoint(e.latlng);
    if(first.distanceTo(click) < 20){
      finishPolygon();
      return;
    }
  }
  drawVertices.push([e.latlng.lat, e.latlng.lng]);
  updateDrawPreview();
  // Show Done button once we have enough vertices
  if(drawVertices.length >= 3){
    document.getElementById('drawDoneBtn').style.display = 'flex';
  }
}

function onDrawMouseMove(e){
  if(!drawMode || drawVertices.length === 0) return;
  updateDrawPreview(e.latlng);
}

function onDrawDoubleClick(e){
  if(!drawMode) return;
  L.DomEvent.stop(e);
  // Double-click fires two click events first, adding 2 duplicate vertices.
  // Pop the extras so we keep the intended shape.
  if(drawVertices.length > 2) drawVertices.pop();
  if(drawVertices.length > 2) drawVertices.pop();
  if(drawVertices.length >= 3) finishPolygon();
}

function onDrawKeyDown(e){
  if(e.key === 'Escape') stopDrawMode();
  if(e.key === 'Enter' && drawVertices.length >= 3) finishPolygon();
}

function updateDrawPreview(mouseLatLng){
  if(drawPreviewLine){ map.removeLayer(drawPreviewLine); drawPreviewLine = null; }
  if(drawVertices.length === 0) return;
  const pts = drawVertices.map(v => L.latLng(v[0], v[1]));
  if(mouseLatLng) pts.push(mouseLatLng);
  if(pts.length >= 2) pts.push(pts[0]);
  drawPreviewLine = L.polyline(pts, {color:'#2563eb',weight:2,dashArray:'6,6',fillOpacity:0}).addTo(map);
}

function finishPolygon(){
  // Save vertices before stopping draw mode (which doesn't touch drawVertices)
  const verts = drawVertices.slice();
  stopDrawMode();
  if(verts.length < 3) return;
  // Remove old polygon + disable old edit
  disablePolygonEdit();
  if(drawPolygonLayer){ map.removeLayer(drawPolygonLayer); }
  // Create Leaflet polygon (interactive so edit handles work)
  drawPolygonLayer = L.polygon(verts, {
    color:'#2563eb', weight:2, fillColor:'#2563eb', fillOpacity:0.1
  }).addTo(map);
  syncPolygonGeoJSON();
  drawVertices = [];
  // Enable vertex editing
  enablePolygonEdit();
  // Show clear button
  document.getElementById('drawClearBtn').classList.add('visible');
  // Re-apply filters with polygon
  applyFilters();
}

function syncPolygonGeoJSON(){
  if(!drawPolygonLayer) return;
  const latlngs = drawPolygonLayer.getLatLngs()[0];
  const coords = latlngs.map(ll => [ll.lng, ll.lat]);
  coords.push(coords[0]); // Close ring
  drawPolygonGeoJSON = turf.polygon([coords]);
}

let _polyEditHandler = null;
function enablePolygonEdit(){
  if(!drawPolygonLayer) return;
  // Leaflet.draw adds editing capability to polygons
  if(drawPolygonLayer.editing){
    drawPolygonLayer.editing.enable();
    _polyEditHandler = function(){ syncPolygonGeoJSON(); applyFilters(); };
    drawPolygonLayer.on('edit', _polyEditHandler);
    // Leaflet.draw fires 'edit' on the layer when editing completes,
    // but for live drag updates we listen on the map's editvertex events
    map.on('draw:editvertex', _polyEditHandler);
  }
}

function disablePolygonEdit(){
  if(drawPolygonLayer && drawPolygonLayer.editing){
    drawPolygonLayer.editing.disable();
    if(_polyEditHandler){
      drawPolygonLayer.off('edit', _polyEditHandler);
      map.off('draw:editvertex', _polyEditHandler);
    }
  }
  _polyEditHandler = null;
}

function clearDrawPolygon(){
  disablePolygonEdit();
  if(drawPolygonLayer){ map.removeLayer(drawPolygonLayer); drawPolygonLayer = null; }
  drawPolygonGeoJSON = null;
  drawVertices = [];
  document.getElementById('drawClearBtn').classList.remove('visible');
  document.getElementById('drawBtn').classList.remove('active');
  document.getElementById('drawDoneBtn').style.display = 'none';
  applyFilters();
}

function applyPolygonOpacity(){
  if(!drawPolygonGeoJSON) return; // No polygon ‚Äî nothing to dim
  // Dim off-market markers outside polygon
  offMarketLayer.eachLayer(function(marker){
    if(marker.getLatLng){
      const ll = marker.getLatLng();
      const inside = isInsideDrawPolygon(ll.lat, ll.lng);
      marker.setStyle({opacity: inside ? 1 : 0.2, fillOpacity: inside ? 0.85 : 0.1});
    }
  });
  // Dim BTR markers outside polygon
  btrLayer.eachLayer(function(marker){
    if(marker.getLatLng){
      const ll = marker.getLatLng();
      const inside = isInsideDrawPolygon(ll.lat, ll.lng);
      marker.setStyle({opacity: inside ? 1 : 0.2, fillOpacity: inside ? 0.85 : 0.1});
    }
  });
  // Dim comp markers outside polygon
  Object.values(markerLayers).forEach(function(layer){
    layer.eachLayer(function(marker){
      if(marker.getLatLng){
        const ll = marker.getLatLng();
        const inside = isInsideDrawPolygon(ll.lat, ll.lng);
        marker.setStyle({opacity: inside ? 1 : 0.15, fillOpacity: inside ? 0.5 : 0.05});
      }
    });
  });
}

function resetFilter(key){
  if(key==='all'){
    ['margin','price','psf','sqft','lot','lotw','slope'].forEach(k=>resetFilter(k));
    newThisWeekFilter=false;
    resetMinUnits();
    document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    return;
  }
  const f=filters[key]; f.min=f.dataMin; f.max=f.dataMax;
  const sMin=document.getElementById(key+'SliderMin'), sMax=document.getElementById(key+'SliderMax');
  const iMin=document.getElementById(key+'Min'), iMax=document.getElementById(key+'Max');
  if(sMin) sMin.value=f.dataMin;
  if(sMax) sMax.value=f.dataMax;
  if(iMin) iMin.value=f.dataMin;
  if(iMax) iMax.value=f.dataMax;
  updateFill(key);
  applyFilters();
}

function onProformaChange(){
  proforma.allInBuildPsf = parseInt(document.getElementById('pfBuildCost').value)||360;
  proforma.avgUnitSf = parseInt(document.getElementById('pfUnitSize').value)||1750;
  proforma.txnCostPct = parseFloat(document.getElementById('pfTxnCost').value)||4.7;
  proforma.fixedDispositionCosts = parseInt(document.getElementById('pfFixedDisp').value)||40000;
  proforma.demoCost = parseInt(document.getElementById('pfDemoCost').value)||55000;
  proforma.holdMonths = parseInt(document.getElementById('pfHoldMonths').value)||24;
  proforma.carryRatePct = parseFloat(document.getElementById('pfCarryRate').value)||9;
  proforma.insurance = parseInt(document.getElementById('pfInsurance').value)||40000;
  proforma.originationPct = parseFloat(document.getElementById('pfOrigination').value)||1;
  enrichListings();
  updateViabilityLabel();
  // Rebuild spread heatmap since it depends on build cost
  if(spreadHeatLayer) {
    map.removeLayer(spreadHeatLayer);
    buildSpreadHeatmap();
    if(layerState.spreadHeat) spreadHeatLayer.addTo(map);
  }
  applyFilters();
}

// ‚îÄ‚îÄ Export ‚îÄ‚îÄ
function exportCSV(){
  const filtered = getFilteredListings();
  if(!filtered.length) return;
  const headers = ['Fav','Address','Zone','Price','Lot SF','Lot Width','Units','Exit $/SF','Sale/Unit','Buy/Unit','Build/Unit','Profit','Margin %','Slope %','DOM','City','AIN','Notes','URL'];
  const favs = loadFavorites();
  const rows = filtered.map(l=>[
    favs[listingKey(l)]?'*':'', l.address, l.zone, l.price,
    l.lotSf||'', l.lw||'', l.maxUnits, l.clusterT1psf||l.newconPpsf||l.exitPsf||0,
    l.salePerUnit||'', l.pricePerUnit||'', l.buildPerUnit||'',
    Math.round(l.estProfit||0), (l.estMargin||0).toFixed(1),
    l.slope!=null?l.slope:'', l.dom!==null?l.dom:'', l.city||'',
    l.ain||'', (favs[listingKey(l)]||{}).notes||'', l.url||''
  ]);
  const csv = [headers,...rows].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='sb1123_deals_export.csv'; a.click();
  URL.revokeObjectURL(url);
}

async function exportModel(lat, lng) {
  var l = LISTINGS.find(function(x){ return x.lat===lat && x.lng===lng; });
  if (!l) { alert('Listing not found'); return; }

  var pf = calculateProForma(l);
  var exitPSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var monthlyRent = l.estRentMonth || l.fmr3br || 4000;
  var avgUnitSF = proforma.avgUnitSf;
  var buildCostPSF = pf.adjBuildCostPerSf;
  var units = pf.maxUnits;

  var ed = sizeEquityAndDebt(l.price, units, avgUnitSF, buildCostPSF, exitPSF, monthlyRent);

  // Decode base64 template to ArrayBuffer
  var raw = atob(TEMPLATE_B64);
  var buf = new Uint8Array(raw.length);
  for (var i = 0; i < raw.length; i++) buf[i] = raw.charCodeAt(i);

  // Load with ExcelJS (preserves all formatting, styles, formulas)
  var wb = new ExcelJS.Workbook();
  await wb.xlsx.load(buf.buffer);
  var ws = wb.getWorksheet('Assumptions');

  var lotWidth = l.lw || Math.round(Math.sqrt((l.lotSf||10000) * 0.33));
  var lotDepth = l.ld || Math.round((l.lotSf||10000) / lotWidth);
  var slopeDecimal = (l.slope || 0) / 100;
  var bedsBaths = (l.beds||'') + ' / ' + (l.baths||'');

  // Write input cells ‚Äî .value preserves existing cell style
  ws.getCell('C5').value = l.address || '';
  ws.getCell('C6').value = (l.city||'') + (l.zip ? ', '+l.zip : '');
  ws.getCell('C7').value = (l.zone||'R1').toUpperCase();
  ws.getCell('C8').value = l.lotSf || 0;
  ws.getCell('C9').value = lotWidth;
  ws.getCell('C10').value = lotDepth;
  ws.getCell('C11').value = slopeDecimal;
  ws.getCell('C12').value = bedsBaths;
  ws.getCell('C13').value = l.dom || 0;
  ws.getCell('C16').value = l.price || 0;
  ws.getCell('C20').value = units;
  ws.getCell('C21').value = avgUnitSF;
  ws.getCell('C23').value = buildCostPSF;
  ws.getCell('C35').value = exitPSF;
  ws.getCell('C48').value = monthlyRent;
  ws.getCell('G14').value = ed.equity;
  ws.getCell('G15').value = ed.debt;

  var start = new Date();
  start.setDate(start.getDate() + 60);
  start.setDate(1);
  ws.getCell('G9').value = start;

  // ‚îÄ‚îÄ Exit Comps sheet ‚îÄ‚îÄ
  var compResult = findCompsForListing(l);
  if (compResult.used.length || compResult.ref.length) {
    var cs = wb.addWorksheet('Exit Comps');
    var el = exitLabel(l);

    // Summary header
    cs.getCell('A1').value = 'Exit Comps for ' + (l.address || '');
    cs.getCell('A1').font = {bold: true, size: 14};
    cs.mergeCells('A1:L1');
    cs.getCell('A2').value = el.label + '  ‚Äî  $' + el.psf + '/SF';
    cs.getCell('A2').font = {bold: true, size: 11};
    cs.mergeCells('A2:L2');
    // Row 3 spacer

    // Column headers
    var compHeaders = ['Status','Address','Sale Price','$/SF','SqFt','Beds','Baths','Zone','Year Built','Tier','Sale Date','Distance (mi)'];
    var headerRow = cs.getRow(4);
    compHeaders.forEach(function(h, i) {
      var cell = headerRow.getCell(i + 1);
      cell.value = h;
      cell.font = {bold: true};
      cell.fill = {type:'pattern', pattern:'solid', fgColor:{argb:'FFE0E0E0'}};
    });

    // Column widths
    cs.getColumn(1).width = 8;   // Status
    cs.getColumn(2).width = 35;  // Address
    cs.getColumn(3).width = 14;  // Sale Price
    cs.getColumn(4).width = 10;  // $/SF
    cs.getColumn(5).width = 10;  // SqFt
    cs.getColumn(6).width = 6;   // Beds
    cs.getColumn(7).width = 6;   // Baths
    cs.getColumn(8).width = 8;   // Zone
    cs.getColumn(9).width = 11;  // Year Built
    cs.getColumn(10).width = 6;  // Tier
    cs.getColumn(11).width = 12; // Sale Date
    cs.getColumn(12).width = 12; // Distance

    var greenFill = {type:'pattern', pattern:'solid', fgColor:{argb:'FFE8F5E9'}};
    var allComps = compResult.used.concat(compResult.ref);
    for (var ci = 0; ci < allComps.length; ci++) {
      var comp = allComps[ci];
      var row = cs.getRow(5 + ci);
      var isUsed = ci < compResult.used.length;

      row.getCell(1).value = isUsed ? 'Used' : 'Ref';
      row.getCell(2).value = comp.address || '';
      row.getCell(3).value = comp.price || 0;
      row.getCell(3).numFmt = '$#,##0';
      row.getCell(4).value = comp.ppsf || 0;
      row.getCell(4).numFmt = '$#,##0';
      row.getCell(5).value = comp.sqft || 0;
      row.getCell(5).numFmt = '#,##0';
      row.getCell(6).value = comp.bd || '';
      row.getCell(7).value = comp.ba || '';
      row.getCell(8).value = comp.zone || '';
      row.getCell(9).value = comp.yb || '';
      row.getCell(10).value = comp.t ? 'T' + comp.t : '';
      row.getCell(11).value = comp.date || '';
      row.getCell(12).value = comp.dist ? +comp.dist.toFixed(2) : '';
      row.getCell(12).numFmt = '0.00';

      if (isUsed) {
        for (var k = 1; k <= 12; k++) row.getCell(k).fill = greenFill;
      }
    }
  }

  // Generate and download
  var filename = (l.address||'deal').replace(/[^a-zA-Z0-9]/g,'_').replace(/_+/g,'_') + '_model.xlsx';
  var outBuf = await wb.xlsx.writeBuffer();
  var blob = new Blob([outBuf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

async function exportOM(lat, lng) {
  var OM_API = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? '' : 'https://sb1123-om-api.fly.dev';

  var l = LISTINGS.find(function(x){ return x.lat===lat && x.lng===lng; });
  if (!l) { alert('Listing not found'); return; }

  var pf = calculateProForma(l);
  var btr = calculateBTRProForma(l);
  var exitPSF = l.clusterT1psf || l.subdivExitPsf || l.newconPpsf || l.exitPsf || 0;
  var monthlyRent = l.estRentMonth || l.fmr3br || 4000;
  var avgUnitSF = proforma.avgUnitSf;
  var buildCostPSF = pf.adjBuildCostPerSf;
  var units = pf.maxUnits;

  var ed = sizeEquityAndDebt(l.price, units, avgUnitSF, buildCostPSF, exitPSF, monthlyRent);

  // ‚îÄ‚îÄ Constants (must match sizeEquityAndDebt) ‚îÄ‚îÄ
  var SOFT_PCT = 0.25;
  var DEMO = 55000;
  var SUBDIV = 100000;
  var AE = 150000;
  var TAX_RATE = 0.011;
  var INS_ANNUAL = 20000;
  var AM_MONTHLY = 3000;
  var DM_MONTHLY = 5000;
  var ACQ_FEE_PCT = 0.02;
  var DISP_FEE_PCT = 0.015;
  var ORIG_FEE_PCT = 0.02;
  var INTEREST_RATE = 0.09;
  var LP_PREF = 0.08;
  var GP_PROMOTE = 0.20;
  var GP_COINVEST = 0.05;
  var PRE_DEV_MO = 6;
  var CONSTR_MO = 12;
  var SALE_MO = 6;
  var HOLD_MO = PRE_DEV_MO + CONSTR_MO + SALE_MO;
  var TX_COST_PCT = proforma.txnCostPct / 100;
  var BTR_VACANCY = btr.vacancyRate;
  var BTR_OPEX = btr.opexRatio;
  var BTR_CAP = btr.capRate;
  var BTR_LTV = btr.refiLTV;
  var BTR_PERM_RATE = 0.0625;
  var BTR_RENT_GROWTH = 0.03;

  // ‚îÄ‚îÄ Development costs ‚îÄ‚îÄ
  var buildableSF = units * avgUnitSF;
  var hardCosts = buildableSF * buildCostPSF;
  var softCosts = hardCosts * SOFT_PCT;
  var totalDev = hardCosts + softCosts + DEMO + SUBDIV + AE;

  // ‚îÄ‚îÄ Capital structure ‚îÄ‚îÄ
  var totalProjectCost = ed.totalCost;
  var equity = ed.equity;
  var debt = totalProjectCost - equity;
  var gpCoinvestEquity = Math.round(equity * GP_COINVEST);
  var lpEquity = equity - gpCoinvestEquity;
  var origFee = debt * ORIG_FEE_PCT;

  // ‚îÄ‚îÄ Carry costs (monthly accumulation) ‚îÄ‚îÄ
  var monthlyTax = l.price * TAX_RATE / 12;
  var monthlyIns = INS_ANNUAL / 12;

  var totalPropTax = monthlyTax * HOLD_MO;
  var totalInsurance = monthlyIns * HOLD_MO;
  var totalAssetMgmt = AM_MONTHLY * HOLD_MO;
  var totalDevMgmt = DM_MONTHLY * CONSTR_MO;

  // ‚îÄ‚îÄ Interest (PIK ‚Äî accrues on drawn debt) ‚îÄ‚îÄ
  // Pre-dev: land acquisition debt drawn; Construction: progressive draws; Sale: fully drawn
  var landDebt = Math.max(0, l.price - equity);  // debt portion of land
  var constrDebt = debt - landDebt;  // remaining debt for construction
  // Simplified PIK: average outstanding √ó rate √ó time
  var preDevInterest = landDebt * INTEREST_RATE * (PRE_DEV_MO / 12);
  var constrInterest = (landDebt + constrDebt * 0.5) * INTEREST_RATE * (CONSTR_MO / 12);
  var saleInterest = debt * INTEREST_RATE * (SALE_MO / 12);
  var totalInterest = preDevInterest + constrInterest + saleInterest;

  // ‚îÄ‚îÄ Fees ‚îÄ‚îÄ
  var acqFee = l.price * ACQ_FEE_PCT;
  var dispFee = 0;  // computed on exit below
  var totalSponsorFees = acqFee + totalAssetMgmt + totalDevMgmt;  // disposition added at exit

  // ‚îÄ‚îÄ Exit ‚îÄ‚îÄ
  var grossRevenue = units * avgUnitSF * exitPSF;
  var txCosts = grossRevenue * TX_COST_PCT;
  dispFee = grossRevenue * DISP_FEE_PCT;
  totalSponsorFees += dispFee;
  var netSaleProceeds = grossRevenue - txCosts;

  // ‚îÄ‚îÄ Waterfall ‚îÄ‚îÄ
  var loanRepayment = debt + totalInterest + origFee;
  var netDistributable = netSaleProceeds - loanRepayment;
  var lpROC = lpEquity;
  var gpROC = gpCoinvestEquity;
  var profitAfterROC = netDistributable - lpROC - gpROC;

  // LP preferred return (simple, on hold period)
  var lpPrefDollars = lpEquity * LP_PREF * (HOLD_MO / 12);
  var remainingAfterPref = Math.max(0, profitAfterROC - lpPrefDollars);

  // GP promote on remaining
  var gpPromoteDollars = remainingAfterPref * GP_PROMOTE;
  var lpShareRemaining = remainingAfterPref * (1 - GP_PROMOTE);

  // LP totals
  var lpTotalDist = lpROC + lpPrefDollars + lpShareRemaining;
  var lpNetProfit = lpTotalDist - lpEquity;
  var lpMOIC = lpEquity > 0 ? lpTotalDist / lpEquity : 0;

  // LP IRR (annualized approximation from MOIC and hold)
  var holdYears = HOLD_MO / 12;
  var lpIRR = holdYears > 0 ? Math.pow(lpMOIC, 1 / holdYears) - 1 : 0;

  // Project-level metrics
  var projectMargin = netSaleProceeds > 0 ? (netSaleProceeds - totalProjectCost) / netSaleProceeds : 0;
  var projectMOIC = totalProjectCost > 0 ? netSaleProceeds / totalProjectCost : 0;
  var allInPsf = buildableSF > 0 ? totalProjectCost / buildableSF : 0;

  // GP economics
  var gpTotalIncome = gpPromoteDollars + totalSponsorFees;
  var gpFeeLoad = grossRevenue > 0 ? gpTotalIncome / grossRevenue : 0;

  // Lot dimensions
  var lotWidth = l.lw || Math.round(Math.sqrt((l.lotSf||10000) * 0.33));
  var lotDepth = l.ld || Math.round((l.lotSf||10000) / lotWidth);

  // ‚îÄ‚îÄ BTR ‚îÄ‚îÄ
  var btrGPI = btr.grossAnnualRent;
  var btrEGI = btr.effectiveGrossIncome;
  var btrNOI = btr.annualNOI;
  var btrStabilizedValue = btr.stabilizedValue;
  var btrRefiLoan = btr.loanAmount;
  var btrEffectiveLTV = btrStabilizedValue > 0 ? btrRefiLoan / btrStabilizedValue : 0;
  var btrAnnualDS = btr.annualDebtService;
  var btrDSCR = btr.dscr;
  var btrAnnualCF = btr.cashFlow;
  var btrCoC = btr.cashOnCash;
  var btrYOC = btr.yieldOnCost;

  // ‚îÄ‚îÄ Build deal dict matching read_xls() schema ‚îÄ‚îÄ
  var addrParts = (l.address || '').split(',');
  var street = addrParts[0] ? addrParts[0].trim() : (l.address || '');

  var d = {
    // Property
    address: street,
    city: l.city || '',
    zip: l.zip || '',
    state: 'CA',
    zoning: (l.zone || 'R1').toUpperCase(),
    lot_sf: l.lotSf || 0,
    lot_width: lotWidth,
    lot_depth: lotDepth,
    slope_pct: (l.slope || 0) / 100,
    beds_baths: (l.beds || '') + ' / ' + (l.baths || ''),
    dom: l.dom || 0,

    // Acquisition
    asking_price: l.price || 0,

    // Development
    units: units,
    unit_sf: avgUnitSF,
    buildable_sf: buildableSF,
    build_cost_psf: buildCostPSF,
    hard_costs: hardCosts,
    soft_cost_pct: SOFT_PCT,
    soft_costs: softCosts,
    demo_cost: DEMO,
    subdivision_cost: SUBDIV,
    ae_cost: AE,
    total_dev_costs: totalDev,

    // Exit
    exit_psf: exitPSF,
    gross_revenue: grossRevenue,
    tx_cost_pct: TX_COST_PCT,
    net_sale_proceeds: netSaleProceeds,

    // Timeline
    predev_months: PRE_DEV_MO,
    construction_months: CONSTR_MO,
    sale_months: SALE_MO,
    hold_months: HOLD_MO,

    // Capital structure
    equity_total: equity,
    debt_total: debt,
    total_project_cost: totalProjectCost,
    equity_pct: totalProjectCost > 0 ? equity / totalProjectCost : 0,
    interest_rate: INTEREST_RATE,
    orig_fee_pct: ORIG_FEE_PCT,
    orig_fee_dollars: origFee,
    interest_treatment: 'PIK',

    // Carry
    prop_tax_rate: TAX_RATE,
    monthly_tax: monthlyTax,
    insurance_annual: INS_ANNUAL,
    monthly_insurance: monthlyIns,

    // Fees
    acq_fee_pct: ACQ_FEE_PCT,
    acq_fee_dollars: acqFee,
    asset_mgmt_monthly: AM_MONTHLY,
    dev_mgmt_monthly: DM_MONTHLY,
    disposition_fee_pct: DISP_FEE_PCT,
    disposition_fee_dollars: dispFee,
    total_sponsor_fees: totalSponsorFees,

    // Waterfall
    lp_pref_rate: LP_PREF,
    gp_promote_pct: GP_PROMOTE,
    gp_coinvest_pct: GP_COINVEST,
    lp_promote_pct: 1 - GP_PROMOTE,

    // Waterfall results
    lp_moic: lpMOIC,
    lp_irr: lpIRR,
    lp_total_dist: lpTotalDist,
    lp_equity_in: lpEquity,
    lp_net_profit: lpNetProfit,
    project_margin: projectMargin,
    project_moic: projectMOIC,
    all_in_psf: allInPsf,
    gp_promote_dollars: gpPromoteDollars,
    gp_total_income: gpTotalIncome,
    gp_fee_load: gpFeeLoad,

    // Monthly CF waterfall detail
    loan_repayment: loanRepayment,
    net_distributable: netDistributable,
    lp_roc: lpROC,
    gp_roc: gpROC,
    profit_after_roc: profitAfterROC,
    lp_pref_dollars: lpPrefDollars,
    remaining_after_pref: remainingAfterPref,
    lp_share_remaining: lpShareRemaining,
    gp_coinvest_equity: gpCoinvestEquity,
    loan_draws: debt,
    total_interest: totalInterest,
    total_prop_tax: totalPropTax,
    total_insurance: totalInsurance,
    total_asset_mgmt: totalAssetMgmt,
    total_dev_mgmt: totalDevMgmt,

    // BTR
    btr_rent_monthly: btr.rentPerUnit,
    btr_vacancy: BTR_VACANCY,
    btr_opex_ratio: BTR_OPEX,
    btr_cap_rate: BTR_CAP,
    btr_refi_ltv: BTR_LTV,
    btr_perm_rate: BTR_PERM_RATE,
    btr_rent_growth: BTR_RENT_GROWTH,
    btr_gpi: btrGPI,
    btr_egi: btrEGI,
    btr_noi: btrNOI,
    btr_stabilized_value: btrStabilizedValue,
    btr_effective_ltv: btrEffectiveLTV,
    btr_refi_loan: btrRefiLoan,
    btr_annual_ds: btrAnnualDS,
    btr_dscr: btrDSCR,
    btr_annual_cf: btrAnnualCF,
    btr_coc: btrCoC,
    btr_yoc: btrYOC,

    // Derived
    break_even_psf: buildableSF > 0 ? totalProjectCost / (buildableSF * (1 - TX_COST_PCT)) : 0,
    lot_per_unit: units > 0 ? (l.lotSf || 0) / units : 0,
    fee_pct_of_cap: totalProjectCost > 0 ? totalSponsorFees / totalProjectCost : 0,
  };

  // ‚îÄ‚îÄ Attach comp sales data ‚îÄ‚îÄ
  var compResult = findCompsForListing(l);
  var el = exitLabel(l);
  d.comp_source = el.short || '';
  d.comp_label = el.label || '';
  d.comps = compResult.used.slice(0, 12).map(function(c) {
    return {
      address: c.address || '',
      price: c.price || 0,
      ppsf: Math.round(c.ppsf || 0),
      sqft: c.sqft || 0,
      beds: c.bd || '',
      baths: c.ba || '',
      zone: c.zone || '',
      year_built: c.yb || '',
      date: c.date || '',
      dist: c.dist ? +c.dist.toFixed(2) : 0,
    };
  });

  // ‚îÄ‚îÄ POST to OM API ‚îÄ‚îÄ
  try {
    var resp = await fetch(OM_API + '/api/generate-om', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(d),
    });
    if (!resp.ok) {
      var errText = await resp.text();
      alert('OM generation failed: ' + errText);
      return;
    }
    var blob = await resp.blob();
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = street.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_') + '_OM.pptx';
    a.click();
    URL.revokeObjectURL(url);
  } catch (err) {
    alert('OM export failed: ' + err.message);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.addEventListener('DOMContentLoaded', function(){
  // Market-specific UI setup
  document.getElementById('marketSubtitle').textContent = MARKET.subtitle;
  if(!MARKET.burnZones) document.getElementById('burnZoneSection').style.display='none';
  var otherSlug = MARKET.slug==='la'?'sd':'la';
  var otherCfg = MARKET_CONFIG[otherSlug];
  var switchLink = document.getElementById('marketSwitchLink');
  switchLink.href = '?market='+otherSlug;
  switchLink.textContent = otherCfg.name.split(' ').map(function(w){return w[0]}).join('')+' \u2197';
  switchLink.title = 'Switch to '+otherCfg.name;
  var analyticsLink = document.getElementById('analyticsLink');
  if(MARKET.slug!=='la') analyticsLink.href='analytics.html?market='+MARKET.slug;

  if(typeof LOADED_COMPS !== 'undefined' && LOADED_COMPS.length > 0) COMPS = LOADED_COMPS;
  if(typeof LOADED_LISTINGS !== 'undefined' && LOADED_LISTINGS.length > 0) LISTINGS = LOADED_LISTINGS;
  if(typeof LOADED_RENTAL_COMPS !== 'undefined' && LOADED_RENTAL_COMPS.length > 0){
    RENTAL_COMPS = LOADED_RENTAL_COMPS;
    rentalCompGrid = buildRentalCompGrid(RENTAL_COMPS);
    console.log('Rental comps loaded:', RENTAL_COMPS.length, 'grid cells:', Object.keys(rentalCompGrid).length);
  }

  // Stamp each listing with nearest cluster's T1 normalized exit $/SF
  if(CLUSTERS.length && LISTINGS.length){
    LISTINGS.forEach(function(l){
      var best = null, bestD = Infinity;
      for(var ci = 0; ci < CLUSTERS.length; ci++){
        var cl = CLUSTERS[ci];
        var d = Math.abs(cl.lat - l.lat) + Math.abs(cl.lng - l.lng);
        if(d < bestD){ bestD = d; best = cl; }
      }
      if(best && bestD < 0.01 && best.t1psf > 0){
        l.clusterT1psf = best.t1psf;
        l.clusterT1n = best.t1n || 0;
        l.clusterRw = best.rw || 0;
        l.clusterFb = best.t1fb;
      }
    });
  }

  if(COMPS.length > 0 || LISTINGS.length > 0){
    document.getElementById('loadingBanner').classList.add('active');
    document.getElementById('loadingBanner').textContent =
      `Loading ${COMPS.length.toLocaleString()} comps + ${LISTINGS.length.toLocaleString()} listings...`;

    setTimeout(function(){
      // Enrich listings with deal scores
      enrichListings();
      updateViabilityLabel();

      // Init filters (use comps if available, fall back to listings)
      var filterSource = COMPS.length ? COMPS : LISTINGS;
      initRangeFilter('price', c=>c.price, filterSource);
      initRangeFilter('psf', c=>c.ppsf||Math.round(c.price/c.sqft), filterSource);
      initRangeFilter('sqft', c=>c.sqft, filterSource);
      const lotsWithData = LISTINGS.filter(l=>l.lotSf&&l.lotSf>0);
      if(lotsWithData.length) initRangeFilter('lot', l=>l.lotSf||0, lotsWithData);
      const withLotW = LISTINGS.filter(l=>l.lw&&l.lw>0);
      if(withLotW.length) initRangeFilter('lotw', l=>l.lw||0, withLotW);
      const withSlope = LISTINGS.filter(l=>l.slope!=null);
      if(withSlope.length) initRangeFilter('slope', l=>l.slope!=null?l.slope:0, withSlope);
      const withMargin = LISTINGS.filter(l=>l.estMargin!=null);
      if(withMargin.length) initRangeFilter('margin', l=>l.estMargin||0, withMargin);

      // Build $/SF heatmap layer from sold comps
      if(COMPS.length && typeof L.heatLayer === 'function'){
        // **CRITICAL FIX**: Clamp heatmap to $600-$1,000 decision range
        const HEAT_MIN = 600;
        const HEAT_MAX = 1000;
        const heatPts = COMPS.filter(c=>c.ppsf>0).map(c=>{
          // Normalize $/SF to 0-1 intensity within $600-$1,000 range
          const intensity = Math.max(0, Math.min(1, (c.ppsf - HEAT_MIN) / (HEAT_MAX - HEAT_MIN)));
          return [c.lat, c.lng, intensity];
        });
        compHeatLayer = L.heatLayer(heatPts, {
          radius: 25,
          blur: 15,
          maxZoom: 17,
          max: 1.0,
          minOpacity: 0.25,
          pane:'heatmapPane',
          gradient: {
            0.0:  '#3b82f6',  // $600 ‚Äî blue (cool)
            0.25: '#22d3ee',  // $700 ‚Äî cyan
            0.50: '#22c55e',  // $800 ‚Äî green
            0.75: '#eab308',  // $900 ‚Äî yellow
            1.0:  '#ef4444'   // $1,000 ‚Äî red (hot)
          }
        });
        document.getElementById('heatCount').textContent = heatPts.length.toLocaleString();
        compCanvasRenderer = L.canvas({padding:0.5});
        compSpatialGrid = buildCompGrid(COMPS);
        map.on('moveend', updateCompPoints);
        map.on('zoomend', updateCompPoints);
      }
      
      // Priority 2: Build spread heatmap
      buildSpreadHeatmap();

      // Set sort BEFORE building table
      currentSort = { key: 'estMargin', dir: 'desc' };
      
      rebuildMarkers();
      rebuildListings();
      rebuildZoneToggles();
      refreshVisibility();
      updateStats();
      updateFilterCount();
      updateFavCount();
      updateHeroStats();
      updatePinLegend();
      initDrawControl();
      showOnboardingIfNeeded();
      
      // Ensure Saved Deals button starts in correct visual state
      document.getElementById('favToggle').classList.remove('active');

      // Fit bounds
      const allLats=[...COMPS.map(c=>c.lat),...LISTINGS.map(l=>l.lat)];
      const allLngs=[...COMPS.map(c=>c.lng),...LISTINGS.map(l=>l.lng)];
      if(allLats.length){
        let minLat=Infinity,maxLat=-Infinity,minLng=Infinity,maxLng=-Infinity;
        for(let i=0;i<allLats.length;i++){
          if(allLats[i]<minLat) minLat=allLats[i]; if(allLats[i]>maxLat) maxLat=allLats[i];
          if(allLngs[i]<minLng) minLng=allLngs[i]; if(allLngs[i]>maxLng) maxLng=allLngs[i];
        }
        map.fitBounds([[minLat,minLng],[maxLat,maxLng]],{padding:[50,50]});
      }


      // Update visual sort indicators to match current sort
      const th=document.querySelector('.listings-table th[data-sort="estMargin"]');
      if(th){
        th.classList.add('sorted');
        th.querySelector('.sort-arrow').textContent='‚ñº';
      }

      // Data freshness indicator
      if(typeof LISTINGS_META !== 'undefined' && LISTINGS_META.builtAt){
        const built = new Date(LISTINGS_META.builtAt);
        const ago = Math.floor((Date.now() - built.getTime()) / 3600000);
        const freshEl = document.getElementById('dataFreshness');
        if(ago < 24) freshEl.innerHTML = '<span style="color:var(--green)">&#9679;</span> Data updated ' + ago + 'h ago';
        else if(ago < 72) freshEl.innerHTML = '<span style="color:var(--yellow)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' day(s) old';
        else freshEl.innerHTML = '<span style="color:var(--red)">&#9679;</span> Data is ' + Math.floor(ago/24) + ' days stale ‚Äî re-run fetch';
      }

      document.getElementById('loadingBanner').classList.remove('active');
      
      // Check for shared pin URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const pinParam = urlParams.get('pin');
      if(pinParam){
        const coords = pinParam.split(',');
        if(coords.length === 2){
          const lat = parseFloat(coords[0]);
          const lng = parseFloat(coords[1]);
          if(!isNaN(lat) && !isNaN(lng)){
            // Pan to the shared pin location
            map.setView([lat, lng], 17);
            // Find and open the popup for this pin
            setTimeout(function(){
              // Check all layers for a marker at this location
              var found = false;
              const layers = [listingsLayer, btrLayer, offMarketLayer];
              layers.forEach(layer => {
                if(layer && !found){
                  layer.eachLayer(marker => {
                    if(found) return;
                    const pos = marker.getLatLng();
                    if(Math.abs(pos.lat - lat) < 0.0001 && Math.abs(pos.lng - lng) < 0.0001){
                      marker.openPopup();
                      found = true;
                    }
                  });
                }
              });
              // Fallback: listing may be filtered out ‚Äî open popup directly from LISTINGS data
              if(!found){
                var pinListing = LISTINGS.find(function(x){
                  return Math.abs(x.lat - lat) < 0.0001 && Math.abs(x.lng - lng) < 0.0001;
                });
                if(pinListing){
                  L.popup({maxWidth:520, className:'deal-popup'})
                    .setLatLng([lat, lng])
                    .setContent(generateDealCard(pinListing))
                    .openOn(map);
                }
              }
            }, 500);
          }
        }
      }
    }, 100);
  } else {
    rebuildZoneToggles();
    updateStats();
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOBILE OPTIMIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function isMobile() { return window.innerWidth <= 768; }
var sheetState = 'collapsed';

function setSheetState(state) {
  if (!isMobile()) return;
  var sidebar = document.querySelector('.sidebar');
  sheetState = state;
  sidebar.classList.remove('sheet-half', 'sheet-full');
  if (state === 'half') sidebar.classList.add('sheet-half');
  else if (state === 'full') sidebar.classList.add('sheet-full');
  if (state === 'collapsed') sidebar.scrollTop = 0;
}

function openMobileSheet() {
  setSheetState('full');
}

function updatePeekStats() {
  var el = document.getElementById('peekEligible');
  var ml = document.getElementById('peekMargin');
  if (!el || !ml) return;
  var filtered = getFilteredListings();
  var eligible = filtered.filter(function(l){ return l.sb1123Eligible; });
  var positiveMargin = eligible.filter(function(l){ return l.estMargin > 0; });
  var avgM = positiveMargin.length ? Math.round(positiveMargin.reduce(function(s,l){ return s+l.estMargin; },0)/positiveMargin.length) : 0;
  el.textContent = eligible.length;
  ml.textContent = avgM + '%';
}

function rebuildMobileCards(sorted) {
  var container = document.getElementById('mobileCards');
  if (!container) return;
  var display = sorted.slice(0, 200);
  container.innerHTML = display.map(function(l) {
    var marginClass = (l.estMargin || 0) >= 0 ? 'profit-pos' : 'profit-neg';
    var profitK = Math.round((l.estProfit || 0) / 1000);
    var profitStr = profitK >= 0 ? '+$' + profitK.toLocaleString() + 'K' : '-$' + Math.abs(profitK).toLocaleString() + 'K';
    var newBadge = l.isNew ? ' <span class="new-badge">NEW</span>' : (l.isNewThisWeek ? ' <span class="new-badge week">7d</span>' : '');
    return '<div class="mobile-card" onclick="flyToListing(' + l.lat + ',' + l.lng + ')">' +
      '<div class="card-addr">' + l.address + newBadge + '</div>' +
      '<div class="card-grid">' +
        '<div class="card-row"><span class="card-label">Zone</span><span class="card-value" style="color:' + (ZONE_COLORS[l.zone] || '#666') + '">' + (l.zone || '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Price</span><span class="card-value">$' + l.price.toLocaleString() + '</span></div>' +
        '<div class="card-row"><span class="card-label">Lot</span><span class="card-value">' + (l.lotSf ? l.lotSf.toLocaleString() + ' sf' : '\u2014') + '</span></div>' +
        '<div class="card-row"><span class="card-label">Units</span><span class="card-value">' + l.maxUnits + '</span></div>' +
      '</div>' +
      '<div class="card-margin-row">' +
        '<span class="card-profit ' + marginClass + '">' + profitStr + '</span>' +
        '<span class="card-margin ' + marginClass + '">' + (l.estMargin || 0).toFixed(0) + '%</span>' +
      '</div>' +
    '</div>';
  }).join('');
}

// Sheet touch drag
(function initSheetDrag() {
  var handle = document.getElementById('sheetHandle');
  if (!handle) return;
  var startY, startH, sidebar, isDragging;

  handle.addEventListener('touchstart', function(e) {
    if (!isMobile()) return;
    isDragging = false;
    sidebar = document.querySelector('.sidebar');
    startY = e.touches[0].clientY;
    startH = sidebar.offsetHeight;
    sidebar.style.transition = 'none';
  }, { passive: true });

  handle.addEventListener('touchmove', function(e) {
    if (!isMobile() || !sidebar) return;
    isDragging = true;
    var dy = startY - e.touches[0].clientY;
    var newH = Math.max(56, Math.min(window.innerHeight * 0.85, startH + dy));
    sidebar.style.height = newH + 'px';
    e.preventDefault();
  }, { passive: false });

  handle.addEventListener('touchend', function() {
    if (!isMobile() || !sidebar) return;
    sidebar.style.transition = '';
    if (!isDragging) {
      // Tap: toggle between collapsed and half
      if (sheetState === 'collapsed') setSheetState('half');
      else setSheetState('collapsed');
      sidebar.style.height = '';
      return;
    }
    var h = sidebar.offsetHeight;
    var vh = window.innerHeight;
    if (h < vh * 0.2) setSheetState('collapsed');
    else if (h < vh * 0.6) setSheetState('half');
    else setSheetState('full');
    sidebar.style.height = '';
  });
})();

// Tap map to collapse sheet + neighborhood pricing card
map.on('click', function(e) {
  // Mobile: collapse sheet first
  if (isMobile() && sheetState !== 'collapsed') {
    setSheetState('collapsed');
    return;
  }

  // Neighborhood pricing card at zoom >= 14
  if (map.getZoom() < 14 || !CLUSTERS.length) return;

  var lat = e.latlng.lat, lng = e.latlng.lng;
  var nearest = null, minDist = Infinity;
  CLUSTERS.forEach(function(cl) {
    var d = Math.abs(cl.lat - lat) + Math.abs(cl.lng - lng);
    if (d < minDist) { minDist = d; nearest = cl; }
  });

  if (!nearest || minDist > 0.01) return;

  var t1psf = nearest.t1psf || 0;
  var t2psf = nearest.t2psf || 0;
  var prem = nearest.prem || (t1psf - t2psf);
  var t1n = nearest.t1n || 0;
  var t2n = nearest.t2n || 0;
  var rw = nearest.rw || 0;

  // Confidence: based on recency weight AND T1 count
  var confLabel, confDots;
  if (rw >= 0.8 && t1n >= 8) { confLabel = 'High'; confDots = 4; }
  else if (rw >= 0.5 && t1n >= 4) { confLabel = 'Medium'; confDots = 3; }
  else if (t1n >= 2) { confLabel = 'Low'; confDots = 2; }
  else { confLabel = 'Low'; confDots = 1; }

  var dots = '';
  for (var di = 0; di < 4; di++) {
    dots += '<span style="display:inline-block;width:8px;height:8px;border-radius:50;margin-right:2px;background:' + (di < confDots ? '#14b8a6' : '#2e3140') + '"></span>';
  }

  // Find zip from nearest listing
  var nearestListing = null, nlDist = Infinity;
  LISTINGS.forEach(function(ll) {
    var d2 = Math.abs(ll.lat - nearest.lat) + Math.abs(ll.lng - nearest.lng);
    if (d2 < nlDist) { nlDist = d2; nearestListing = ll; }
  });
  var zipLabel = nearestListing ? (nearestListing.zip || '') : '';
  var cityLabel = nearestListing ? (nearestListing.city || '') : '';
  var locLine = (zipLabel ? zipLabel + ' ¬∑ ' : '') + cityLabel;

  // Compute T1 raw median from nearby comps for display
  var cellComps = COMPS.filter(function(c) {
    return Math.abs(c.lat - nearest.lat) < 0.004 && Math.abs(c.lng - nearest.lng) < 0.004;
  });
  var t1Raw = cellComps.filter(function(c) { return c.t === 1; }).map(function(c) { return c.ppsf; }).sort(function(a,b){return a-b;});
  var t1RawMedian = t1Raw.length ? t1Raw[Math.floor(t1Raw.length / 2)] : t1psf;

  var html = '<div style="min-width:260px;font-family:DM Sans,sans-serif">'
    // Header
    + '<div style="padding-bottom:8px;border-bottom:1px solid #2e3140;margin-bottom:10px">'
    + '  <div style="font-size:13px;font-weight:600;color:#e4e6ed">' + locLine + '</div>'
    + '  <div style="font-size:11px;color:#8b8fa3;margin-top:3px">' + dots + ' ' + confLabel + ' (' + t1n + ' T1)</div>'
    + '</div>'
    // Primary metric
    + '<div style="padding-bottom:10px;border-bottom:1px solid #2e3140;margin-bottom:10px">'
    + '  <div style="font-size:11px;color:#8b8fa3;margin-bottom:4px">T1 Exit $/SF (@ 1,750 SF)</div>'
    + '  <div style="font-family:JetBrains Mono,monospace;font-size:28px;font-weight:700;color:#14b8a6">$' + t1psf.toLocaleString() + '</div>'
    + '</div>'
    // Breakdown rows
    + '<div style="padding-bottom:10px;border-bottom:1px solid #2e3140;margin-bottom:10px;font-size:12px">'
    + '  <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:#8b8fa3">T1 Raw Median</span><span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">$' + t1RawMedian.toLocaleString() + '</span></div>'
    + '  <div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:#8b8fa3">T2 Baseline</span><span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">$' + t2psf.toLocaleString() + '</span></div>'
    + (prem > 0 ? '  <div style="display:flex;justify-content:space-between"><span style="color:#8b8fa3">Remodel Premium</span><span style="font-family:JetBrains Mono,monospace;color:#14b8a6">+$' + prem.toLocaleString() + '</span></div>' : '')
    + '</div>'
    // Footer stats
    + '<div style="display:flex;justify-content:space-between;font-size:11px">'
    + '  <div><span style="color:#8b8fa3">Recency</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + rw.toFixed(2) + '</span></div>'
    + '  <div><span style="color:#8b8fa3">T1</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + t1n + '</span></div>'
    + '  <div><span style="color:#8b8fa3">T2</span> <span style="font-family:JetBrains Mono,monospace;color:#e4e6ed">' + t2n + '</span></div>'
    + '</div></div>';

  L.popup({className:'dark-popup'}).setLatLng(e.latlng).setContent(html).openOn(map);
});
</script>
</body>
</html>
